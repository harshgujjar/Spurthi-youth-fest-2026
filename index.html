<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spurthi Youth Fest 2026</title>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    <!-- EmailJS for sending actual emails -->
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
    <script type="text/javascript">
        (function(){
            emailjs.init("iISS6N2b69VmKwx8Y"); // Your EmailJS Public Key from image
        })();
    </script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #c44569 0%, #6a1b9a 100%); min-height: 100vh; padding: 20px; }
        
        /* ========== QUIZ ANIMATIONS ========== */
        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes pulse {
            0%, 100% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.05);
            }
        }
        
        @keyframes shimmer {
            0% {
                background-position: -1000px 0;
            }
            100% {
                background-position: 1000px 0;
            }
        }
        
        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% {
                transform: translateY(0);
            }
            40% {
                transform: translateY(-20px);
            }
            60% {
                transform: translateY(-10px);
            }
        }
        
        @keyframes confetti {
            0% {
                transform: translateY(0) rotateZ(0deg);
                opacity: 1;
            }
            100% {
                transform: translateY(1000px) rotateZ(720deg);
                opacity: 0;
            }
        }
        
        @keyframes correctShake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px) rotate(-2deg); }
            75% { transform: translateX(5px) rotate(2deg); }
        }
        
        /* Quiz Status Cards with Animation */
        .quiz-status-card {
            animation: slideInUp 0.6s ease-out;
            transition: all 0.3s ease;
        }
        
        .quiz-status-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.2);
        }
        
        /* Shimmer effect for available quiz */
        .quiz-available-banner {
            background: linear-gradient(90deg, #d4edda 0%, #e8f5e9 50%, #d4edda 100%);
            background-size: 2000px 100%;
            animation: shimmer 3s linear infinite;
            border: 3px solid #28a745;
            border-radius: 15px;
            padding: 25px;
            margin: 20px 0;
            box-shadow: 0 6px 20px rgba(40, 167, 69, 0.3);
        }
        
        .quiz-available-banner h3 {
            color: #155724;
            font-size: 1.5em;
            margin-bottom: 10px;
            animation: pulse 2s ease-in-out infinite;
        }
        
        .quiz-available-banner .trophy-icon {
            font-size: 3em;
            display: inline-block;
            animation: bounce 2s ease-in-out infinite;
        }
        
        /* Question Cards */
        .quiz-question-card {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 8px 30px rgba(0,0,0,0.15);
            border-left: 6px solid #667eea;
            animation: slideInUp 0.5s ease-out;
            transition: all 0.3s ease;
        }
        
        .quiz-question-card:hover {
            transform: translateX(5px);
            box-shadow: 0 12px 40px rgba(102, 126, 234, 0.3);
        }
        
        .quiz-question-card h4 {
            color: #667eea;
            font-size: 1.3em;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .quiz-question-card .question-text {
            color: #333;
            font-size: 1.15em;
            margin-bottom: 20px;
            line-height: 1.6;
            font-weight: 500;
        }
        
        /* Option Buttons */
        .quiz-option {
            background: #f8f9fa;
            border: 3px solid #e9ecef;
            border-radius: 12px;
            padding: 18px 25px;
            margin: 12px 0;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 15px;
            font-size: 1.05em;
        }
        
        .quiz-option:hover {
            background: #e3f2fd;
            border-color: #2196F3;
            transform: translateX(10px);
            box-shadow: 0 4px 15px rgba(33, 150, 243, 0.2);
        }
        
        .quiz-option.selected {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-color: #667eea;
            color: white;
            font-weight: 600;
            transform: scale(1.02);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }
        
        .quiz-option .option-circle {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: #667eea;
            flex-shrink: 0;
        }
        
        .quiz-option.selected .option-circle {
            background: white;
            color: #667eea;
        }
        
        /* Submit Button Enhancement */
        .quiz-submit-btn {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            border: none;
            border-radius: 15px;
            padding: 20px 40px;
            font-size: 1.3em;
            font-weight: 700;
            cursor: pointer;
            width: 100%;
            margin-top: 30px;
            transition: all 0.3s ease;
            box-shadow: 0 8px 25px rgba(40, 167, 69, 0.4);
            position: relative;
            overflow: hidden;
        }
        
        .quiz-submit-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 35px rgba(40, 167, 69, 0.5);
        }
        
        .quiz-submit-btn:active {
            transform: translateY(-1px);
        }
        
        .quiz-submit-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: rgba(255,255,255,0.2);
            transition: left 0.5s ease;
        }
        
        .quiz-submit-btn:hover::before {
            left: 100%;
        }
        
        /* Timer Enhancement */
        .quiz-timer-box {
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, #ff6b6b 0%, #ff8e53 100%);
            color: white;
            padding: 15px 25px;
            border-radius: 15px;
            box-shadow: 0 6px 20px rgba(255, 107, 107, 0.4);
            z-index: 1000;
            font-weight: 700;
            font-size: 1.2em;
            animation: pulse 2s ease-in-out infinite;
        }
        
        /* Confetti */
        .confetti {
            position: fixed;
            width: 10px;
            height: 10px;
            z-index: 9999;
            animation: confetti 3s ease-out forwards;
        }
        
        /* Success Modal */
        .quiz-success-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            animation: fadeIn 0.3s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .quiz-success-content {
            background: white;
            border-radius: 25px;
            padding: 50px;
            text-align: center;
            max-width: 600px;
            animation: slideInUp 0.5s ease-out;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        
        .quiz-success-content .success-icon {
            font-size: 5em;
            margin-bottom: 20px;
            animation: bounce 1s ease-in-out;
        }
        
        .quiz-success-content h2 {
            color: #28a745;
            font-size: 2.5em;
            margin-bottom: 15px;
        }
        
        .quiz-success-content p {
            font-size: 1.2em;
            color: #666;
            margin: 10px 0;
        }
        .container { max-width: 1400px; margin: 0 auto; }
        .banner { width: 100%; max-width: 1200px; margin: 0 auto 30px; border-radius: 12px; box-shadow: 0 10px 40px rgba(0,0,0,0.3); display: block; }
        .header { text-align: center; color: white; margin-bottom: 30px; }
        .header h1 { font-size: 1.8em; }
        .admin-badge { display: inline-block; background: #FFD700; color: #333; padding: 5px 15px; border-radius: 20px; font-size: 0.9em; font-weight: bold; margin-left: 10px; }
        .super-admin-badge { display: inline-block; background: #FF6B6B; color: white; padding: 5px 15px; border-radius: 20px; font-size: 0.9em; font-weight: bold; margin-left: 10px; }
        .jury-badge { display: inline-block; background: #4ECDC4; color: white; padding: 5px 15px; border-radius: 20px; font-size: 0.9em; font-weight: bold; margin-left: 10px; }
        
        /* Class Indicator */
        .class-indicator {
            background: white;
            padding: 15px 25px;
            border-radius: 8px;
            margin: 20px auto;
            max-width: 500px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            display: none;
        }
        .class-indicator.active {
            display: block;
        }
        .class-indicator h3 {
            color: #6a1b9a;
            font-size: 1.2em;
            margin-bottom: 8px;
        }
        .class-indicator .class-name {
            color: #c44569;
            font-size: 1.5em;
            font-weight: bold;
        }
        
        /* Admin Dashboard */
        .admin-dashboard {
            background: white;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }
        .dashboard-title {
            color: #c44569;
            font-size: 1.8em;
            margin-bottom: 25px;
            text-align: center;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 6px 20px rgba(0,0,0,0.15);
            transition: transform 0.3s;
        }
        .stat-card:hover {
            transform: translateY(-5px);
        }
        .stat-number {
            font-size: 3em;
            font-weight: bold;
            margin-bottom: 10px;
        }
        .stat-label {
            font-size: 1.1em;
            opacity: 0.9;
        }
        
        .tabs { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
        .tab { padding: 12px 24px; background: white; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: 600; transition: all 0.3s; }
        .tab:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.2); }
        .tab.active { background: linear-gradient(135deg, #c44569 0%, #6a1b9a 100%); color: white; }
        .content { background: white; border-radius: 12px; padding: 30px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); }
        .form-section { display: none; }
        .form-section.active { display: block; }
        .form-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; font-weight: 600; color: #333; }
        input, select, textarea { width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 6px; font-size: 16px; transition: border-color 0.3s; }
        input:focus, select:focus, textarea:focus { outline: none; border-color: #c44569; }
        .event-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 15px; margin: 20px 0; }
        .event-card { padding: 20px; border: 3px solid #ddd; border-radius: 12px; cursor: pointer; transition: all 0.3s; background: white; position: relative; }
        .event-card:hover { border-color: #c44569; transform: translateY(-3px); box-shadow: 0 6px 20px rgba(196, 69, 105, 0.3); }
        .event-card.full { border-color: #f44336; background: #ffebee; cursor: not-allowed; opacity: 0.7; }
        .event-card.full:hover { transform: none; }
        .event-title { font-size: 1.1em; font-weight: bold; margin-bottom: 8px; }
        .event-size { font-size: 0.9em; opacity: 0.8; margin-bottom: 5px; }
        .event-status { font-size: 0.85em; padding: 5px 10px; border-radius: 15px; display: inline-block; margin-top: 5px; font-weight: bold; }
        .status-full { background: #f44336; color: white; }
        .status-available { background: #4CAF50; color: white; }
        .status-limited { background: #FF9800; color: white; }
        .team-member-box { border: 2px solid #c44569; padding: 15px; border-radius: 8px; margin-bottom: 15px; background: #f9f9f9; }
        .member-header { color: #6a1b9a; font-weight: bold; margin-bottom: 10px; font-size: 1.1em; }
        .btn { padding: 12px 30px; background: linear-gradient(135deg, #c44569 0%, #6a1b9a 100%); color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.3s; }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(0,0,0,0.2); }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }
        .btn-secondary { background: #666; }
        .btn-small { padding: 6px 12px; font-size: 14px; }
        .btn-success { background: #4CAF50; }
        .btn-danger { background: #f44336; }
        .btn-info { background: #2196F3; }
        .message { padding: 15px; border-radius: 6px; margin-bottom: 20px; display: none; }
        .message.show { display: block; }
        .message.success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .message.error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.7); overflow-y: auto; }
        .modal-content { background-color: white; margin: 50px auto; padding: 30px; border-radius: 12px; width: 90%; max-width: 600px; }
        .modal-header { font-size: 1.5em; color: #c44569; margin-bottom: 20px; text-align: center; }
        .modal-icon { font-size: 4em; margin-bottom: 20px; text-align: center; }
        .modal-buttons { margin-top: 20px; display: flex; gap: 10px; justify-content: center; flex-wrap: wrap; }
        /* Table Wrapper for Horizontal Scroll */
        .table-wrapper {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            margin-top: 20px;
        }
        table { width: 100%; border-collapse: collapse; min-width: 600px; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #ddd; white-space: nowrap; }
        th { background: linear-gradient(135deg, #c44569 0%, #6a1b9a 100%); color: white; font-weight: 600; position: sticky; top: 0; z-index: 10; }
        tr:hover { background: #f5f5f5; }
        
        /* Mobile Responsive Table */
        @media (max-width: 768px) {
            table { min-width: 800px; font-size: 14px; }
            th, td { padding: 8px 6px; }
            .btn-small { padding: 4px 8px; font-size: 12px; }
        }
        .edit-btn { background: #2196F3; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; margin-right: 5px; }
        .edit-btn:hover { background: #1976D2; }
        .delete-btn { background: #f44336; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; }
        .delete-btn:hover { background: #d32f2f; }
        .filter-section { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
        .filter-section select { flex: 1; min-width: 200px; }
        .admin-only { display: none; }
        .super-admin-only { display: none; }
        .jury-only { display: none; }
        .student-section { background: #f0f0f0; padding: 20px; border-radius: 8px; margin-bottom: 30px; }
        .cr-section { background: #e3f2fd; padding: 20px; border-radius: 8px; margin-bottom: 20px; border: 2px solid #2196F3; }
        
        /* Jury Sheet Styles */
        .criteria-input-group {
            background: #f9f9f9;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            border: 2px solid #ddd;
        }
        .criteria-input-group input {
            margin-bottom: 10px;
        }
        .remove-criteria-btn {
            background: #f44336;
            color: white;
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
        }
        .marks-table {
            overflow-x: auto;
        }
        .marks-input {
            width: 80px;
            padding: 8px;
            border: 2px solid #ddd;
            border-radius: 4px;
            text-align: center;
        }
        .marks-input:focus {
            border-color: #4CAF50;
        }
        .total-marks {
            font-weight: bold;
            color: #c44569;
            font-size: 1.2em;
        }
        .winner-badge {
            background: #FFD700;
            color: #333;
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: bold;
            display: inline-block;
            margin-left: 10px;
        }
        .runner-badge {
            background: #C0C0C0;
            color: #333;
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: bold;
            display: inline-block;
            margin-left: 10px;
        }
        .jury-password-section {
            background: #fff3cd;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 2px solid #ffc107;
        }
        .results-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        .rank-1 {
            border-left: 5px solid #FFD700;
        }
        .rank-2 {
            border-left: 5px solid #C0C0C0;
        }
        .rank-3 {
            border-left: 5px solid #CD7F32;
        }
        
        @media (max-width: 768px) { 
            .event-grid { grid-template-columns: 1fr; } 
            .filter-section { flex-direction: column; }
            .marks-input { width: 60px; }
        }
        
        /* Firebase Status Indicator */
        .firebase-status {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: white;
            padding: 12px 20px;
            border-radius: 25px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            display: flex;
            align-items: center;
            gap: 10px;
            z-index: 999;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s;
        }
        .firebase-status:hover {
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
            transform: translateY(-2px);
        }
        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }
        .status-connected {
            background: #4CAF50;
            box-shadow: 0 0 10px rgba(76, 175, 80, 0.5);
        }
        .status-disconnected {
            background: #f44336;
            box-shadow: 0 0 10px rgba(244, 67, 54, 0.5);
            animation: blink 1s infinite;
        }
        .status-checking {
            background: #FF9800;
            box-shadow: 0 0 10px rgba(255, 152, 0, 0.5);
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        @keyframes blink {
            0%, 50%, 100% { opacity: 1; }
            25%, 75% { opacity: 0.3; }
        }
        @media (max-width: 768px) {
            .firebase-status {
                bottom: 10px;
                right: 10px;
                padding: 8px 15px;
                font-size: 12px;
            }
            .status-dot {
                width: 10px;
                height: 10px;
            }
        }
        
        /* Edit Date Button Styling */
        .btn-warning { background: #FF9800; }
        .btn-edit-date {
            background: linear-gradient(135deg, #FF9800 0%, #F57C00 100%);
            margin-left: 10px;
        }
        .btn-edit-date:hover {
            box-shadow: 0 6px 20px rgba(255, 152, 0, 0.4);
        }
        
        /* Date Editor Modal */
        .date-picker-group {
            display: flex;
            gap: 15px;
            align-items: center;
            margin: 20px 0;
            flex-wrap: wrap;
        }
        .date-picker-group > div {
            flex: 1;
            min-width: 200px;
        }
        .quiz-list-item {
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .quiz-list-item:hover {
            border-color: #c44569;
            background: #f9f9f9;
        }
        .quiz-list-item.selected {
            border-color: #4CAF50;
            background: #e8f5e9;
        }
        .quiz-date-info {
            font-weight: 600;
            color: #6a1b9a;
        }
        .quiz-question-preview {
            font-size: 0.9em;
            color: #666;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- ============================================ -->
        <!-- TO CHANGE BANNER IMAGE:                      -->
        <!-- Replace "banner.gif?v=5" with your file      -->
        <!-- Supported: .gif, .png, .jpg                  -->
        <!-- ============================================ -->
        <img src="banner.gif?v=5" class="banner">
        
        <div class="header">
            <h1>üéâ SPURTHI YOUTH FEST 2026 üéâ</h1>
            <p id="userInfo"></p>
        </div>

        <!-- Login/Logout Section (Visible to all) -->
        <div class="content" id="loginSection">
            <h2 style="text-align:center;color:#c44569;margin-bottom:25px">Login</h2>
            
            <!-- Student Login at Top -->
            <div id="studentLogin">
                <div class="form-group">
                    <label>Class:</label>
                    <select id="studentClass"></select>
                </div>
                <button class="btn" onclick="studentLogin()">Login as Student</button>
            </div>
            
            <!-- Divider -->
            <div style="margin: 30px 0; border-top: 2px solid #ddd;"></div>
            
            <!-- Youthfest Registration Dropdown -->
            <div class="form-group">
                <label>Youthfest Registration</label>
                <select id="userType" onchange="handleUserTypeChange()">
                    <option value="">-- Select --</option>
                    <option value="cr">Class Representative (CR)</option>
                    <option value="admin">Admin</option>
                    <option value="superadmin">Super Admin</option>
                    <option value="jury">Jury</option>
                </select>
            </div>
            
            <!-- CR Login -->
            <div id="crLogin" style="display:none">
                <div class="form-group">
                    <label>Class:</label>
                    <select id="crClass"></select>
                </div>
                <button class="btn" onclick="crLogin()">Login as CR</button>
            </div>
            
            <!-- Admin Login -->
            <div id="adminLogin" style="display:none">
                <div class="form-group">
                    <label>Admin Password:</label>
                    <input type="password" id="adminPassword" placeholder="Enter admin password">
                </div>
                <button class="btn" onclick="adminLogin()">Login as Admin</button>
            </div>
            
            <!-- Super Admin Login -->
            <div id="superAdminLogin" style="display:none">
                <div class="form-group">
                    <label>Super Admin Password:</label>
                    <input type="password" id="superAdminPassword" placeholder="Enter super admin password">
                </div>
                <button class="btn" onclick="superAdminLogin()">Login as Super Admin</button>
            </div>
            
            <!-- Jury Login -->
            <div id="juryLogin" style="display:none">
                <div class="form-group">
                    <label>Select Event:</label>
                    <select id="juryEvent"></select>
                </div>
                <div class="form-group">
                    <label>Jury Password:</label>
                    <input type="password" id="juryPassword" placeholder="Enter jury password for this event">
                </div>
                <div class="form-group">
                    <label>Jury Number (1 or 2):</label>
                    <select id="juryNumber">
                        <option value="">-- Select --</option>
                        <option value="1">Jury 1</option>
                        <option value="2">Jury 2</option>
                    </select>
                </div>
                <button class="btn" onclick="juryLogin()">Login as Jury</button>
            </div>
            
            <!-- Divider -->
            <div style="margin: 30px 0; border-top: 2px solid #ddd;"></div>
            
            <!-- Online Competition Dropdown -->
            <div class="form-group">
                <label>Online Competition</label>
                <select id="competitionType" onchange="handleCompetitionChange()">
                    <option value="">-- Select --</option>
                    <option value="dailyquiz">Daily Quiz Competition</option>
                </select>
            </div>
            
            <!-- Daily Quiz Competition Login -->
            <div id="dailyQuizLogin" style="display:none">
                <!-- Public Quiz Status (shows before login) -->
                <div id="publicQuizStatus" style="margin-bottom:30px">
                    <h3 style="color:#c44569;margin-bottom:20px;font-size:1.8em;text-align:center">üìù Today's Daily Quiz Competition</h3>
                    <div id="publicQuizMessage" class="quiz-status-card" style="padding:25px;background:white;border-radius:15px;border-left:5px solid #667eea;box-shadow:0 6px 20px rgba(0,0,0,0.1)">
                        <p style="margin:0;color:#666;text-align:center">Checking today's quiz status...</p>
                    </div>
                </div>
                
                <hr style="margin:30px 0;border:none;border-top:2px solid #e9ecef">
                
                <h3 style="color:#6a1b9a;margin-bottom:15px">Student Registration & Login</h3>
                <div id="quizMessage" class="message"></div>
                
                <div style="background:#fff3cd;padding:15px;border-radius:8px;margin-bottom:20px;border-left:4px solid #ffc107">
                    <p style="margin:0;color:#856404"><strong>New Student?</strong> Register to get password</p>
                </div>
                
                <div class="form-group">
                    <label>Select Class:</label>
                    <select id="quizClass"></select>
                </div>
                <div class="form-group">
                    <label>Email Address:</label>
                    <input type="email" id="quizEmail" placeholder="your.email@example.com">
                </div>
                <div class="form-group">
                    <label>Phone Number:</label>
                    <input type="tel" id="quizPhone" placeholder="10-digit mobile number">
                </div>
                <div class="form-group">
                    <label>Full Name:</label>
                    <input type="text" id="quizName" placeholder="Enter your full name">
                </div>
                <button class="btn" onclick="registerQuizStudent()" style="margin-bottom:10px">üìù Register & Get Password</button>
                
                <hr style="margin:25px 0;border:none;border-top:2px solid #e9ecef">
                
                <div style="background:#d4edda;padding:15px;border-radius:8px;margin-bottom:20px;border-left:4px solid #28a745">
                    <p style="margin:0;color:#155724"><strong>Already Registered?</strong> Login with your phone number and password</p>
                </div>
                
                <div class="form-group">
                    <label>Phone Number:</label>
                    <input type="tel" id="quizLoginPhone" placeholder="Enter 10-digit phone number" maxlength="10">
                </div>
                <div class="form-group">
                    <label>Password:</label>
                    <input type="password" id="quizLoginPassword" placeholder="Enter password">
                </div>
                <button class="btn btn-success" onclick="loginQuizStudent()">üöÄ Login to Quiz</button>
            </div>
        </div>

        <!-- Student Enrollment Section -->
        <div class="student-section" id="studentSection" style="display:none">
            <button class="btn btn-secondary" onclick="logout()" style="float:right">Logout</button>
            <h2 style="color:#c44569;margin-bottom:20px">Student Enrollment</h2>
            <div id="enrollMessage" class="message"></div>
            
            <div class="class-indicator" id="classIndicator">
                <h3>You are enrolling for</h3>
                <div class="class-name" id="currentClassName"></div>
            </div>

            <!-- View Class Enrollments Section -->
            <div style="background:#e3f2fd;padding:20px;border-radius:8px;margin-bottom:20px;border:2px solid #2196F3;">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:15px;">
                    <h3 style="color:#1976D2;margin:0;">üìä Your Class Enrollments</h3>
                    <button class="btn btn-small" onclick="toggleEnrollmentView()" id="toggleEnrollmentBtn">
                        Hide Details
                    </button>
                </div>
                
                <!-- Event Filter -->
                <div class="form-group" style="margin-bottom:15px;">
                    <label>Filter by Event:</label>
                    <select id="studentEventFilter" onchange="viewStudentClassEnrollments()">
                        <option value="">All Events</option>
                    </select>
                </div>
                
                <div id="studentEnrollmentResults"></div>
            </div>

            <div class="form-group">
                <label>Select Event to Enroll:</label>
                <div class="event-grid" id="eventCardsContainer"></div>
            </div>

            <div id="enrollmentForm" style="display:none">
                <div id="enrollmentFormContent"></div>
                <button class="btn" onclick="submitEnrollment()">Submit Enrollment</button>
                <button class="btn btn-secondary" onclick="cancelEnrollment()">Cancel</button>
            </div>
        </div>

        <!-- CR Section -->
        <div class="cr-section" id="crSection" style="display:none">
            <button class="btn btn-secondary" onclick="logout()" style="float:right">Logout</button>
            <h2 style="color:#2196F3;margin-bottom:20px">Class Representative Dashboard</h2>
            <div id="crMessage" class="message"></div>
            
            <div class="class-indicator active">
                <h3>Managing Class</h3>
                <div class="class-name" id="crClassName"></div>
            </div>

            <div class="tabs">
                <button class="tab active" onclick="showCRTab('crEnroll')">Enroll Students</button>
                <button class="tab" onclick="showCRTab('crView')">View Enrollments</button>
            </div>

            <div id="crEnroll" class="form-section active">
                <h3 style="margin-bottom:20px">Enroll Students for Your Class</h3>
                <div class="form-group">
                    <label>Select Event:</label>
                    <div class="event-grid" id="crEventCardsContainer"></div>
                </div>

                <div id="crEnrollmentForm" style="display:none">
                    <div id="crEnrollmentFormContent"></div>
                    <button class="btn" onclick="submitCREnrollment()">Submit Enrollment</button>
                    <button class="btn btn-secondary" onclick="cancelCREnrollment()">Cancel</button>
                </div>
            </div>

            <div id="crView" class="form-section">
                <h3 style="margin-bottom:20px">Your Class Enrollments</h3>
                <div class="filter-section">
                    <select id="crFilterEvent" onchange="updateCRView()">
                        <option value="">All Events</option>
                    </select>
                    <button class="btn btn-small" onclick="clearCRFilters()">Clear Filters</button>
                    <button class="btn btn-small btn-success" onclick="downloadCREnrollments()">üì• Download Enrollments</button>
                </div>
                <div id="crSummary" style="margin-bottom:20px"></div>
                <div id="crEnrollmentsContainer"></div>
            </div>
        </div>

        <!-- Admin Section -->
        <div class="admin-only" id="adminSection">
            <button class="btn btn-secondary" onclick="logout()" style="float:right">Logout</button>
            
            <!-- Admin Dashboard -->
            <div class="admin-dashboard">
                <h2 class="dashboard-title">üìä Admin Dashboard</h2>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number" id="totalStudents">0</div>
                        <div class="stat-label">Total Students</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="totalEvents">0</div>
                        <div class="stat-label">Active Events</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="totalClasses">0</div>
                        <div class="stat-label">Classes</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="totalEnrollments">0</div>
                        <div class="stat-label">Total Enrollments</div>
                    </div>
                </div>
            </div>

            <div class="tabs">
                <button class="tab active" onclick="showTab('master')">Master List</button>
                <button class="tab" onclick="showTab('events')">By Events</button>
                <button class="tab super-admin-only" onclick="showTab('jurySetup')">Jury Setup</button>
                <button class="tab" onclick="showTab('results')" id="resultsTab">Results</button>
                <button class="tab super-admin-only" onclick="showTab('quizManagement')" id="quizManagementTab">üìù Quiz Management</button>
            </div>

            <div class="content">
                <!-- Master List Tab -->
                <div id="master" class="form-section active">
                    <h2 style="color:#c44569;margin-bottom:20px">Master Enrollment List</h2>
                    <div class="filter-section">
                        <select id="filterClass" onchange="updateMaster()">
                            <option value="">All Classes</option>
                        </select>
                        <select id="filterEvent" onchange="updateMaster()">
                            <option value="">All Events</option>
                        </select>
                        <button class="btn btn-small" onclick="clearFilters()">Clear Filters</button>
                        <button class="btn btn-small btn-success" onclick="downloadMaster()">üì• Download CSV</button>
                    </div>
                    <div id="summaryInfo" style="background:#e3f2fd;padding:15px;border-radius:8px;margin-bottom:20px"></div>
                    <div id="masterContainer"></div>
                </div>

                <!-- Events Tab -->
                <div id="events" class="form-section">
                    <h2 style="color:#c44569;margin-bottom:20px">Enrollments by Events</h2>
                    <button class="btn btn-small btn-success" onclick="downloadEvents()" style="margin-bottom:20px">üì• Download CSV</button>
                    <div id="eventsContainer"></div>
                </div>

                <!-- Jury Setup Tab (Super Admin Only) -->
                <div id="jurySetup" class="form-section super-admin-only">
                    <h2 style="color:#c44569;margin-bottom:20px">Jury Setup & Criteria Management</h2>
                    
                    <div class="form-group">
                        <label>Select Event:</label>
                        <select id="setupEventSelect" onchange="loadEventSetup()">
                            <option value="">-- Select Event --</option>
                        </select>
                    </div>
                    
                    <div id="eventSetupContainer" style="display:none">
                        <div class="jury-password-section">
                            <h3 style="color:#6a1b9a;margin-bottom:15px">üë• Jury Details</h3>
                            
                            <div style="background:#f0f0f0;padding:15px;border-radius:8px;margin-bottom:15px">
                                <h4 style="color:#6a1b9a;margin-bottom:10px">Jury 1</h4>
                                <div class="form-group">
                                    <label>Jury 1 Name:</label>
                                    <input type="text" id="jury1Name" placeholder="e.g., Dr. Smith, Prof. John">
                                </div>
                                <div class="form-group">
                                    <label>Jury 1 Password:</label>
                                    <input type="text" id="jury1Password" placeholder="Set password for Jury 1">
                                </div>
                            </div>
                            
                            <div style="background:#f0f0f0;padding:15px;border-radius:8px;margin-bottom:15px">
                                <h4 style="color:#6a1b9a;margin-bottom:10px">Jury 2</h4>
                                <div class="form-group">
                                    <label>Jury 2 Name:</label>
                                    <input type="text" id="jury2Name" placeholder="e.g., Dr. Jane, Prof. Mary">
                                </div>
                                <div class="form-group">
                                    <label>Jury 2 Password:</label>
                                    <input type="text" id="jury2Password" placeholder="Set password for Jury 2">
                                </div>
                            </div>
                        </div>
                        
                        <h3 style="color:#6a1b9a;margin:20px 0 15px">üìã Evaluation Criteria (5 criteria, 10 marks each)</h3>
                        <div id="criteriaContainer"></div>
                        <button class="btn btn-small btn-info" onclick="addCriterion()" style="margin-top:10px">+ Add Criterion</button>
                        
                        <div style="margin-top:30px">
                            <button class="btn btn-success" onclick="saveEventSetup()">Save Setup</button>
                        </div>
                        
                        <div id="setupMessage" class="message" style="margin-top:20px"></div>
                    </div>
                </div>

                <!-- Results Tab -->
                <div id="results" class="form-section">
                    <h2 style="color:#c44569;margin-bottom:20px">Event Results</h2>
                    
                    <div class="form-group">
                        <label>Select Event:</label>
                        <div style="display:flex;gap:10px;">
                            <select id="resultsEventSelect" onchange="loadEventResults()" style="flex:1">
                                <option value="">-- Select Event --</option>
                            </select>
                            <button class="btn btn-small" onclick="loadEventResults()" style="white-space:nowrap">üîÑ Refresh</button>
                        </div>
                    </div>
                    
                    <!-- Super Admin Only: Publish/Unpublish Results -->
                    <div class="super-admin-only" style="margin:20px 0;padding:15px;background:#fff3cd;border-radius:8px;border:2px solid #ffc107">
                        <h3 style="color:#6a1b9a;margin-bottom:10px">üì¢ Results Management</h3>
                        <p style="color:#666;margin-bottom:15px;font-size:14px">Publish or unpublish results for the selected event.</p>
                        <div style="display:flex;gap:10px;flex-wrap:wrap">
                            <button class="btn btn-danger" onclick="publishResults()">‚úÖ Publish Results to Admins</button>
                            <button class="btn btn-secondary" onclick="unpublishResults()">‚ùå Unpublish Results</button>
                        </div>
                    </div>
                    
                    <div id="resultsContainer"></div>
                </div>
                
                <!-- Quiz Management Tab -->
                <div id="quizManagement" class="form-section">
                    <h2 style="color:#c44569;margin-bottom:25px">üìù Daily Quiz Competition Management</h2>
                    
                    <!-- Date Selector for Quiz Creation -->
                    <div style="background:#fff3cd;padding:20px;border-radius:10px;margin-bottom:25px;border-left:5px solid #ffc107">
                        <div class="form-group" style="margin-bottom:0">
                            <label for="quizDateSelector" style="font-size:1.1em;color:#856404;margin-bottom:10px"><strong>üìÖ Select Date for Quiz:</strong></label>
                            <input type="date" id="quizDateSelector" style="max-width:300px;border:2px solid #ffc107" required onchange="loadQuizForSelectedDate()">
                            <p style="color:#856404;font-size:14px;margin-top:10px;margin-bottom:0">
                                <strong>Note:</strong> Select a date to create/edit quiz questions. Students will see this quiz automatically on the selected date. If no quiz is created for a date, students won't see any quiz that day.
                            </p>
                        </div>
                    </div>
                    
                    <div class="stats-grid" style="margin-bottom:30px">
                        <div class="stat-card">
                            <div class="stat-number" id="quizTotalStudents">0</div>
                            <div class="stat-label">Total Quiz Students</div>
                        </div>
                        <div class="stat-card" style="background:linear-gradient(135deg,#28a745 0%,#20c997 100%)">
                            <div class="stat-number" id="quizTodayParticipants">0</div>
                            <div class="stat-label">Today's Participants</div>
                        </div>
                        <div class="stat-card" style="background:linear-gradient(135deg,#ffc107 0%,#ff9800 100%)">
                            <div class="stat-number" id="quizQuestionsCount">0</div>
                            <div class="stat-label">Questions Today</div>
                        </div>
                    </div>
                    
                    <div id="quizAdminMessage" class="message"></div>
                    
                    <div class="tabs" style="margin-bottom:25px">
                        <button class="tab active" onclick="showQuizManagementTab('questions', event)">üìù Questions</button>
                        <button class="tab" onclick="showQuizManagementTab('allquizzes', event)">üìö All Quizzes</button>
                        <button class="tab" onclick="showQuizManagementTab('students', event)">üë• Students</button>
                        <button class="tab" onclick="showQuizManagementTab('submissions', event)">üìä Submissions</button>
                        <button class="tab" onclick="showQuizManagementTab('winners', event)">üèÜ Winners</button>
                        <button class="tab super-admin-only" onclick="showQuizManagementTab('editdates', event)" id="editDatesTab">üìÖ Edit Quiz Dates</button>
                    </div>
                    
                    <!-- Questions Sub-Tab -->
                    <div id="quizQuestionsContent" class="form-section active">
                        <h3 style="color:#6a1b9a;margin-bottom:20px" id="quizQuestionsHeading">Create Quiz (2 Questions)</h3>
                        
                        <div style="background:#d1ecf1;padding:15px;border-radius:8px;margin-bottom:25px;border-left:4px solid #17a2b8">
                            <p style="margin:0;color:#0c5460"><strong>üìß Email:</strong> <a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="70141106111e131f1c1c151715404230171d11191c5e131f1d">[email&#160;protected]</a> | <strong>Status:</strong> ‚úÖ Active</p>
                        </div>
                        
                        <div style="background:#f8f9fa;padding:20px;border-radius:10px;margin-bottom:30px">
                            <h4 style="color:#667eea;margin-bottom:15px">Question 1</h4>
                            
                            <div class="form-group">
                                <label>Question Text:</label>
                                <textarea id="quiz_q1Text" rows="3" placeholder="Enter question 1"></textarea>
                            </div>
                            
                            <!-- Image Upload -->
                            <div class="form-group">
                                <label>üì∑ Add Image (Optional):</label>
                                <input type="file" id="quiz_q1Image" accept="image/*" onchange="previewQuestionImage(this, 'quiz_q1ImagePreview')">
                                <div id="quiz_q1ImagePreview" style="margin-top:10px"></div>
                                <small style="color:#666">Upload an image to show with the question</small>
                            </div>
                            
                            <!-- Audio Upload -->
                            <div class="form-group">
                                <label>üéµ Add Audio (Optional):</label>
                                <input type="file" id="quiz_q1Audio" accept="audio/*" onchange="previewQuestionAudio(this, 'quiz_q1AudioPreview')">
                                <div id="quiz_q1AudioPreview" style="margin-top:10px"></div>
                                <small style="color:#666">Upload audio/music to play with the question</small>
                            </div>
                            
                            <div class="form-group">
                                <label>Option A:</label>
                                <input type="text" id="quiz_q1OptA" placeholder="Option A">
                            </div>
                            <div class="form-group">
                                <label>Option B:</label>
                                <input type="text" id="quiz_q1OptB" placeholder="Option B">
                            </div>
                            <div class="form-group">
                                <label>Option C:</label>
                                <input type="text" id="quiz_q1OptC" placeholder="Option C">
                            </div>
                            <div class="form-group">
                                <label>Option D:</label>
                                <input type="text" id="quiz_q1OptD" placeholder="Option D">
                            </div>
                            <div class="form-group">
                                <label>Correct Answer:</label>
                                <select id="quiz_q1Correct">
                                    <option value="">-- Select --</option>
                                    <option value="A">A</option>
                                    <option value="B">B</option>
                                    <option value="C">C</option>
                                    <option value="D">D</option>
                                </select>
                            </div>
                        </div>
                        
                        <div style="background:#f8f9fa;padding:20px;border-radius:10px;margin-bottom:30px">
                            <h4 style="color:#667eea;margin-bottom:15px">Question 2</h4>
                            
                            <div class="form-group">
                                <label>Question Text:</label>
                                <textarea id="quiz_q2Text" rows="3" placeholder="Enter question 2"></textarea>
                            </div>
                            
                            <!-- Image Upload -->
                            <div class="form-group">
                                <label>üì∑ Add Image (Optional):</label>
                                <input type="file" id="quiz_q2Image" accept="image/*" onchange="previewQuestionImage(this, 'quiz_q2ImagePreview')">
                                <div id="quiz_q2ImagePreview" style="margin-top:10px"></div>
                                <small style="color:#666">Upload an image to show with the question</small>
                            </div>
                            
                            <!-- Audio Upload -->
                            <div class="form-group">
                                <label>üéµ Add Audio (Optional):</label>
                                <input type="file" id="quiz_q2Audio" accept="audio/*" onchange="previewQuestionAudio(this, 'quiz_q2AudioPreview')">
                                <div id="quiz_q2AudioPreview" style="margin-top:10px"></div>
                                <small style="color:#666">Upload audio/music to play with the question</small>
                            </div>
                            
                            <div class="form-group">
                                <label>Option A:</label>
                                <input type="text" id="quiz_q2OptA" placeholder="Option A">
                            </div>
                            <div class="form-group">
                                <label>Option B:</label>
                                <input type="text" id="quiz_q2OptB" placeholder="Option B">
                            </div>
                            <div class="form-group">
                                <label>Option C:</label>
                                <input type="text" id="quiz_q2OptC" placeholder="Option C">
                            </div>
                            <div class="form-group">
                                <label>Option D:</label>
                                <input type="text" id="quiz_q2OptD" placeholder="Option D">
                            </div>
                            <div class="form-group">
                                <label>Correct Answer:</label>
                                <select id="quiz_q2Correct">
                                    <option value="">-- Select --</option>
                                    <option value="A">A</option>
                                    <option value="B">B</option>
                                    <option value="C">C</option>
                                    <option value="D">D</option>
                                </select>
                            </div>
                        </div>
                        
                        <button class="btn btn-success" onclick="saveQuizQuestionsFromAdmin()" style="font-size:1.1em">üíæ Save Questions</button>
                        <button class="btn btn-info btn-small" onclick="viewTodayQuestionsAdmin()" style="margin-left:10px">üëÅÔ∏è View Today's Questions</button>
                        
                        <!-- Publish/Unpublish Section for Admin Dashboard -->
                        <div id="publishControlSectionAdmin" style="display:none;margin-top:30px;background:#fff3cd;padding:25px;border-radius:12px;border-left:5px solid #ffc107">
                            <h3 style="color:#6a1b9a;margin-bottom:15px">üì¢ Quiz Publication Control</h3>
                            <div id="publishStatusDisplayAdmin" style="margin-bottom:20px"></div>
                            <div style="display:flex;gap:10px;flex-wrap:wrap">
                                <button class="btn btn-success" onclick="publishTodayQuiz()" id="btnPublishAdmin" style="display:none">‚úÖ PUBLISH Quiz (Make Live)</button>
                                <button class="btn btn-danger" onclick="unpublishTodayQuiz()" id="btnUnpublishAdmin" style="display:none">‚ùå UNPUBLISH Quiz (Hide)</button>
                            </div>
                        </div>
                        
                        <div id="todayQuestionsViewAdmin" style="display:none;margin-top:30px"></div>
                    </div>
                    
                    <!-- All Quizzes Sub-Tab -->
                    <div id="quizAllQuizzesContent" class="form-section">
                        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px">
                            <h3 style="color:#6a1b9a;margin:0">üìö All Quiz Questions (Sorted by Date)</h3>
                            <button class="btn btn-info btn-small" onclick="loadAllQuizzes()">üîÑ Refresh List</button>
                        </div>
                        <div id="allQuizzesContainer"></div>
                    </div>
                    
                    <!-- Students Sub-Tab -->
                    <div id="quizStudentsContent" class="form-section">
                        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px">
                            <h3 style="color:#6a1b9a;margin:0">Registered Quiz Students</h3>
                            <button class="btn btn-info btn-small" onclick="loadQuizStudentsAdmin()">üîÑ Refresh Students</button>
                        </div>
                        <div class="table-wrapper">
                            <table>
                                <thead>
                                    <tr>
                                        <th>#</th>
                                        <th>Name</th>
                                        <th>Email</th>
                                        <th>Phone</th>
                                        <th>Password</th>
                                        <th>Class</th>
                                        <th>Registered</th>
                                    </tr>
                                </thead>
                                <tbody id="quizStudentsTableAdmin"></tbody>
                            </table>
                        </div>
                    </div>
                    
                    <!-- Submissions Sub-Tab -->
                    <div id="quizSubmissionsContent" class="form-section">
                        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px">
                            <h3 style="color:#6a1b9a;margin:0">Today's Quiz Submissions</h3>
                            <button class="btn btn-info btn-small" onclick="loadQuizSubmissionsAdmin()">üîÑ Refresh Submissions</button>
                        </div>
                        <div class="table-wrapper">
                            <table>
                                <thead>
                                    <tr>
                                        <th>#</th>
                                        <th>Name</th>
                                        <th>Email</th>
                                        <th>Class</th>
                                        <th>Submitted</th>
                                        <th>Score</th>
                                        <th>Time</th>
                                    </tr>
                                </thead>
                                <tbody id="quizSubmissionsTableAdmin"></tbody>
                            </table>
                        </div>
                    </div>
                    
                    <!-- Winners Sub-Tab -->
                    <div id="quizWinnersContent" class="form-section">
                        <h3 style="color:#6a1b9a;margin-bottom:20px">üèÜ Declare Today's Winners</h3>
                        
                        <div style="background:#fff3cd;padding:20px;border-radius:10px;margin-bottom:25px">
                            <p style="margin:0;color:#856404"><strong>‚ÑπÔ∏è How it works:</strong> System randomly selects winner & runner-up from students who got BOTH questions correct.</p>
                        </div>
                        
                        <div style="background:#f8f9fa;padding:20px;border-radius:10px;margin:20px 0">
                            <h4 style="margin-bottom:15px">üìä Statistics</h4>
                            <p><strong>Total:</strong> <span id="resultTotalPartAdmin">0</span></p>
                            <p><strong>Both Correct:</strong> <span id="resultBothCorrectAdmin">0</span></p>
                            <p><strong>Eligible:</strong> <span id="resultEligibleAdmin">0</span></p>
                        </div>
                        
                        <button class="btn btn-warning" onclick="selectQuizWinnersFromAdmin()" style="font-size:1.1em;padding:16px">üé≤ Select Winners (Random)</button>
                        
                        <div id="winnersDisplayAdmin" style="display:none;margin-top:30px"></div>
                    </div>
                    
                    <!-- Edit Quiz Dates Sub-Tab (Super Admin Only) -->
                    <div id="quizEditDatesContent" class="form-section super-admin-only">
                        <h3 style="color:#6a1b9a;margin-bottom:20px">üìÖ Edit Quiz Dates</h3>
                        <p style="color:#666;margin-bottom:20px">Select a quiz and change its date. This will move the quiz to a different day.</p>
                        
                        <div style="background:#fff3cd;padding:15px;border-radius:8px;border-left:5px solid #ffc107;margin-bottom:20px">
                            <p style="margin:0;color:#856404;font-weight:600">‚ö†Ô∏è Warning: Changing quiz dates will affect student access and published status.</p>
                        </div>
                        
                        <!-- Quiz Selection -->
                        <div id="quizDateList" style="margin-bottom:30px">
                            <h4 style="color:#c44569;margin-bottom:15px">Select Quiz to Edit:</h4>
                            <button class="btn btn-info btn-small" onclick="loadQuizzesForDateEdit()" style="margin-bottom:15px">üîÑ Refresh Quiz List</button>
                            <div id="quizListForDateEdit"></div>
                        </div>
                        
                        <!-- Date Change Form -->
                        <div id="dateChangeForm" style="display:none">
                            <h4 style="color:#c44569;margin-bottom:15px">Change Quiz Date:</h4>
                            
                            <div style="background:#f9f9f9;padding:20px;border-radius:8px;margin-bottom:20px">
                                <p style="margin:0 0 10px 0;color:#333"><strong>Current Date:</strong> <span id="currentQuizDate" style="color:#c44569"></span></p>
                                <p style="margin:0;color:#666;font-size:0.9em" id="currentQuizPreview"></p>
                            </div>
                            
                            <div class="form-group">
                                <label for="newQuizDate">New Date *</label>
                                <input type="date" id="newQuizDate" required>
                            </div>
                            
                            <div class="form-group">
                                <label style="display:flex;align-items:center;cursor:pointer;">
                                    <input type="checkbox" id="autoPublishAfterMove" checked style="width:auto;margin-right:10px;">
                                    <span>Automatically publish quiz at new date</span>
                                </label>
                                <p style="color:#666;font-size:0.9em;margin-top:5px;">If checked, the quiz will be published and visible to students at the new date.</p>
                            </div>
                            
                            <div id="dateChangeMessage" class="message"></div>
                            
                            <div style="display:flex;gap:10px;margin-top:20px">
                                <button class="btn btn-warning" onclick="updateQuizDate()">üìÖ Change Date</button>
                                <button class="btn btn-secondary" onclick="cancelDateEdit()">‚ùå Cancel</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Jury Section -->
        <div class="jury-only" id="jurySection">
            <button class="btn btn-secondary" onclick="logout()" style="float:right">Logout</button>
            
            <div class="content">
                <h2 style="color:#c44569;margin-bottom:20px" id="juryEventTitle">Jury Evaluation Sheet</h2>
                <p style="margin-bottom:20px;color:#666" id="juryInfo"></p>
                
                <div id="juryMessage" class="message"></div>
                
                <div style="margin-bottom:20px;text-align:center">
                    <button class="btn btn-info" onclick="loadJurySheet()" style="margin-right:10px">üîÑ Reload Sheet</button>
                    <button class="btn btn-secondary" onclick="showEnrollmentDebug()">üìä Show Enrollments</button>
                </div>
                
                <div id="jurySheetContainer"></div>
                
                <div style="margin-top:30px;text-align:center">
                    <button class="btn btn-success" onclick="saveMarks()">üíæ Save Marks</button>
                    <button class="btn btn-info" onclick="markAsCompleted()" style="margin-left:10px">‚úÖ Mark as Completed</button>
                </div>
            </div>
        </div>
        
        <!-- ============================================ -->
        <!-- DAILY QUIZ COMPETITION SYSTEM                -->
        <!-- ============================================ -->
        
        <!-- Quiz Student Dashboard -->
        <div id="quizStudentDashboard" style="display:none">
            <button class="btn btn-secondary" onclick="logout()" style="float:right">Logout</button>
            <h2 style="color:#c44569;margin-bottom:20px">
                üéì Daily Quiz Competition
                <span id="quizStudentNameBadge" class="badge" style="background:#28a745;color:white;padding:8px 15px;border-radius:20px;font-size:0.8em;margin-left:10px"></span>
            </h2>
            <div id="quizStudentMessage" class="message"></div>
            
            <div class="content">
                <h3 style="color:#6a1b9a;margin-bottom:20px">Welcome, <span id="quizStudentName"></span>!</h3>
                <p style="margin-bottom:20px"><strong>Email:</strong> <span id="quizStudentEmail"></span> | <strong>Class:</strong> <span id="quizStudentClass"></span></p>
                
                <div id="quizStatusSection">
                    <div style="background:#fff3cd;padding:20px;border-radius:12px;margin-bottom:25px;border-left:5px solid #ffc107">
                        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:15px">
                            <h3 style="color:#856404;margin:0">üìÖ Today's Quiz Status</h3>
                            <button class="btn btn-info btn-small" onclick="checkQuizTodayStatus()" style="font-size:0.9em">üîÑ Refresh Status</button>
                        </div>
                        <div id="quizStatus"></div>
                    </div>
                    
                    <div id="quizStartSection" style="display:none">
                        <div style="background:linear-gradient(135deg,#ff6b6b 0%,#ee5a6f 100%);color:white;padding:20px;border-radius:10px;margin-bottom:25px">
                            <h3 style="margin-bottom:10px">‚ö†Ô∏è Anti-Cheating Rules</h3>
                            <ul style="line-height:1.8;margin-left:20px">
                                <li>Do NOT refresh the page</li>
                                <li>Do NOT press back button</li>
                                <li>Do NOT switch tabs or minimize browser</li>
                                <li>Quiz will AUTO-SUBMIT if rules violated</li>
                                <li>You get ONE attempt per day only</li>
                            </ul>
                        </div>
                        <button class="btn btn-success" onclick="startQuiz()" style="font-size:1.2em;padding:18px">üöÄ Start Today's Quiz</button>
                    </div>
                    
                    <div id="quizCompletedSection" style="display:none">
                        <div class="message success show">
                            <strong>‚úÖ Quiz Completed!</strong> You have successfully submitted today's quiz. Results will be announced soon.
                        </div>
                    </div>
                    
                    <div id="quizResultsSection" style="display:none">
                        <h3 style="color:#667eea;margin-top:20px">üìä Your Results</h3>
                        <div id="quizStudentResults"></div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Quiz Page -->
        <div id="quizPage" style="display:none">
            <div class="quiz-timer-box" id="quizTimer">
                ‚è±Ô∏è <span id="quizTimerValue">00:00</span>
            </div>
            
            <div class="content">
                <h2 style="color:#c44569;text-align:center;margin-bottom:10px;font-size:2em">üìù Daily Quiz Competition</h2>
                <p id="quizDateDisplay" style="text-align:center;color:#667eea;font-weight:600;margin-bottom:30px;font-size:1.2em"></p>
                <div id="quizPageMessage" class="message"></div>
                
                <div id="quizQuestionsContainer"></div>
                
                <button class="quiz-submit-btn" onclick="submitQuizAnswers()">
                    ‚úÖ Submit Quiz
                </button>
            </div>
        </div>
        
        <!-- Quiz Admin Dashboard -->
        <!-- Regular Quiz Admin Dashboard REMOVED - Only Super Admin Dashboard is used -->
    </div>

    <!-- Firebase Status Indicator -->
    <div class="firebase-status">
        <div class="status-dot status-disconnected" id="statusDot"></div>
        <span id="statusText">Connecting...</span>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirmModal" class="modal">
        <div class="modal-content">
            <div class="modal-icon">‚ö†Ô∏è</div>
            <div class="modal-header" id="modalMessage"></div>
            <div class="modal-buttons">
                <button class="btn btn-success" onclick="confirmAction()">Yes, Proceed</button>
                <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Edit Enrollment Modal -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">‚úèÔ∏è Edit Enrollment</div>
            <div id="editFormContainer"></div>
            <div class="modal-buttons">
                <button class="btn btn-success" onclick="saveEdit()">Save Changes</button>
                <button class="btn btn-secondary" onclick="closeEditModal()">Cancel</button>
            </div>
        </div>
    </div>
    
    <!-- Quiz Date Edit Modal -->
    <div id="quizDateEditModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">üìÖ Confirm Date Change</div>
            <p id="dateEditModalMessage" style="text-align:center;margin:20px 0"></p>
            <div class="modal-buttons">
                <button class="btn btn-warning" onclick="confirmDateChange()">‚úÖ Confirm</button>
                <button class="btn btn-secondary" onclick="closeQuizDateEditModal()">‚ùå Cancel</button>
            </div>
        </div>
    </div>

    <script data-cfasync="false" src="/cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script><script>
        // Firebase Configuration - YOUR ACTUAL CONFIG
        const firebaseConfig = {
            apiKey: "AIzaSyCkjglXJOsXEqGrlavYL4vQ635BV_dbMzY",
            authDomain: "spurthi-youthfest-2026.firebaseapp.com",
            databaseURL: "https://spurthi-youthfest-2026-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "spurthi-youthfest-2026",
            storageBucket: "spurthi-youthfest-2026.firebasestorage.app",
            messagingSenderId: "840281252513",
            appId: "1:840281252513:web:13f32d3239b5f5664ec6e0"
        };

        let db, ref;
        try {
            firebase.initializeApp(firebaseConfig);
            db = firebase.database();
            ref = db.ref('youthfest-enrollments');
        } catch (e) { console.error('Firebase error:', e); }

        // Firebase Connection Status Monitor
        let isConnected = false;
        
        function updateFirebaseStatus(connected) {
            isConnected = connected;
            const statusDot = document.getElementById('statusDot');
            const statusText = document.getElementById('statusText');
            
            statusDot.className = 'status-dot';
            if (connected) {
                statusDot.classList.add('status-connected');
                statusText.textContent = 'üü¢ Database Connected';
            } else {
                statusDot.classList.add('status-disconnected');
                statusText.textContent = 'üî¥ Database Offline';
            }
        }
        
        // Check Firebase connection
        if (ref) {
            const connectedRef = db.ref('.info/connected');
            connectedRef.on('value', function(snap) {
                if (snap.val() === true) {
                    updateFirebaseStatus(true);
                } else {
                    updateFirebaseStatus(false);
                }
            });
            
            // Initial check after 2 seconds
            setTimeout(function() {
                ref.once('value').then(function() {
                    updateFirebaseStatus(true);
                }).catch(function() {
                    updateFirebaseStatus(false);
                });
            }, 2000);
        } else {
            setTimeout(function() {
                updateFirebaseStatus(false);
            }, 1000);
        }

        // Global Variables
        const classes = ['1st B.Com','2nd B.Com','3rd B.Com','1ST BCA','2ND BCA A SEC','2ND BCA B SEC','3RD BCA A SEC','3RD BCA B SEC','3RD BCA C SEC','2ND BBA','3RD BBA','Faculty/Principal/Vice-Principal/Staff','Others'];
        const events = {
            'Pod Casting': {size:'Individual',count:1,role:false,topic:true,topicLabel:'Topic',allow:false,maxPerClass:1},
            'Mime': {size:'6 Members',count:6,role:true,topic:true,topicLabel:'Theme',allow:false,maxPerClass:1},
            'Interdisciplinary': {size:'5 Members',count:5,role:true,topic:true,topicLabel:'Topic',allow:false,maxPerClass:1},
            'Ramp Walk': {size:'10+5 Members',count:15,role:true,topic:true,topicLabel:'Theme',show:true,allow:false,maxPerClass:1},
            'Quiz': {size:'6 Members',count:6,role:true,allow:false,maxPerClass:1},
            'Vlog': {size:'3 Members',count:3,role:true,topic:true,topicLabel:'Topic',allow:true,maxPerClass:2},
            'YouTube Advertisement': {size:'8 Members',count:8,role:true,prod:true,allow:false,maxPerClass:1},
            'Mad Ads': {size:'8 Members',count:8,role:true,topic:true,topicLabel:'Topic',allow:false,maxPerClass:1},
            'Hand Writing': {size:'Individual',count:1,role:false,lang:true,allow:false,maxPerClass:1},
            'Best of Waste': {size:'2 Members',count:2,role:true,allow:true,maxPerClass:999},
            'Social Awareness Skit': {size:'8 Members',count:8,role:true,cause:true,allow:false,maxPerClass:1},
            'Solo Dance': {size:'Individual',count:1,role:false,allow:true,maxPerClass:5},
            'Group Dance': {size:'5-8 Members',count:5,role:true,allow:false,maxPerClass:1},
            'Nukkad Natak': {size:'8-10 Members',count:8,role:true,cause:true,causeLabel:'Different Cause',allow:false,maxPerClass:1},
            'Case Analysis': {size:'2 Members',count:2,role:true,allow:false,maxPerClass:1}
        };

        let all = [];
        let currentUser = null;
        let studentClass = null;
        let crClass = null;
        let isAdmin = false;
        let isSuperAdmin = false;
        let isCR = false;
        let isJury = false;
        let juryEvent = null;
        let juryNumber = null;
        let selectedEvent = null;
        let adminPassword = 'admin123';
        let superAdminPassword = 'superadmin123';
        
        // Quiz Competition Variables
        let quizCurrentUser = null;
        let quizUserRole = null;
        let quizStartTime = null;
        let quizAntiCheatActive = false;
        let quizTimerInterval = null;

        // Initialize
        window.onload = function() {
            populateClassSelects();
            populateEventSelects();
            loadData();
            
            // Firebase connection status
            const connectedRef = db.ref('.info/connected');
            connectedRef.on('value', (snap) => {
                const dot = document.getElementById('statusDot');
                const text = document.getElementById('statusText');
                if (snap.val() === true) {
                    dot.className = 'status-dot status-connected';
                    text.textContent = 'Connected';
                } else {
                    dot.className = 'status-dot status-disconnected';
                    text.textContent = 'Disconnected';
                }
            });
        };

        function populateClassSelects() {
            const selects = ['studentClass','crClass','filterClass'];
            selects.forEach(id => {
                const sel = document.getElementById(id);
                if (sel) {
                    // For student and CR dropdowns, exclude Faculty and Others
                    const classesToShow = (id === 'studentClass' || id === 'crClass') 
                        ? classes.filter(c => c !== 'Faculty/Principal/Vice-Principal/Staff' && c !== 'Others')
                        : classes;
                    
                    classesToShow.forEach(c => {
                        const opt = document.createElement('option');
                        opt.value = c;
                        opt.textContent = c;
                        sel.appendChild(opt);
                    });
                }
            });
        }

        function populateEventSelects() {
            const selects = ['filterEvent','crFilterEvent','setupEventSelect','resultsEventSelect','juryEvent'];
            selects.forEach(id => {
                const sel = document.getElementById(id);
                if (sel) {
                    Object.keys(events).forEach(e => {
                        const opt = document.createElement('option');
                        opt.value = e;
                        opt.textContent = e;
                        sel.appendChild(opt);
                    });
                }
            });
        }

        function loadData() {
            ref.on('value', snap => {
                console.log('=== FIREBASE DATA LOADED (listener) ===');
                console.log('Snapshot exists?', snap.exists());
                
                all = [];
                let childCount = 0;
                if (snap.exists()) {
                    snap.forEach(child => {
                        childCount++;
                        const data = {id: child.key, ...child.val()};
                        console.log('Child #' + childCount + ':', child.key, '‚Üí', data.classYear, '-', data.event, '-', data.name);
                        all.push(data);
                    });
                }
                
                console.log('Total children loaded:', childCount);
                console.log('All array length:', all.length);
                
                // Show class breakdown
                const classCounts = {};
                all.forEach(e => {
                    if (!classCounts[e.classYear]) classCounts[e.classYear] = 0;
                    classCounts[e.classYear]++;
                });
                console.log('Data by class:', classCounts);
                
                if (isAdmin || isSuperAdmin) {
                    updateStats();
                    updateMaster();
                    updateEvents();
                }
                if (isCR) {
                    updateCRView();
                }
                // Update student view when data changes
                if (studentClass && document.getElementById('studentSection').style.display === 'block') {
                    renderEventCards();
                }
            });
        }

        function handleUserTypeChange() {
            const type = document.getElementById('userType').value;
            document.getElementById('crLogin').style.display = type === 'cr' ? 'block' : 'none';
            document.getElementById('adminLogin').style.display = type === 'admin' ? 'block' : 'none';
            document.getElementById('superAdminLogin').style.display = type === 'superadmin' ? 'block' : 'none';
            document.getElementById('juryLogin').style.display = type === 'jury' ? 'block' : 'none';
            
            // Reset competition dropdown when user type is selected
            if (type) {
                document.getElementById('competitionType').value = '';
                document.getElementById('dailyQuizLogin').style.display = 'none';
            }
        }

        function handleCompetitionChange() {
            const type = document.getElementById('competitionType').value;
            document.getElementById('dailyQuizLogin').style.display = type === 'dailyquiz' ? 'block' : 'none';
            
            // Reset user type dropdown and hide credentials when competition is selected
            if (type) {
                document.getElementById('userType').value = '';
                document.getElementById('crLogin').style.display = 'none';
                document.getElementById('adminLogin').style.display = 'none';
                document.getElementById('superAdminLogin').style.display = 'none';
                document.getElementById('juryLogin').style.display = 'none';
            }
            
            if (type === 'dailyquiz') {
                populateQuizClasses();
                checkPublicQuizStatus();
            }
        }

        function studentLogin() {
            const cls = document.getElementById('studentClass').value;
            if (!cls) { alert('Please select your class'); return; }
            studentClass = cls;
            currentUser = 'Student';
            
            document.getElementById('userInfo').innerHTML = 'Logged in as: <span class="admin-badge">Student - '+cls+'</span>';
            document.getElementById('loginSection').style.display = 'none';
            document.getElementById('studentSection').style.display = 'block';
            document.getElementById('currentClassName').textContent = cls;
            document.getElementById('classIndicator').classList.add('active');
            
            // Force reload data from Firebase and then render
            console.log('=== STUDENT LOGIN ===');
            console.log('Selected class:', cls);
            console.log('Firebase ref path:', ref.toString());
            
            ref.once('value').then(snap => {
                console.log('Snapshot exists?', snap.exists());
                
                all = [];
                if (snap.exists()) {
                    snap.forEach(child => {
                        const data = {id: child.key, ...child.val()};
                        all.push(data);
                    });
                }
                
                console.log('Total records loaded:', all.length);
                
                // Log first few records
                if (all.length > 0) {
                    console.log('Sample records:');
                    all.slice(0, 3).forEach((rec, i) => {
                        console.log(`  [${i}] Class: "${rec.classYear}" | Event: "${rec.event}" | Name: "${rec.name}"`);
                    });
                }
                
                // Show all unique classes in database
                const uniqueClasses = [...new Set(all.map(e => e.classYear))];
                console.log('Unique classes in database:', uniqueClasses);
                
                // Filter for this class
                const classRecords = all.filter(e => e.classYear === cls);
                console.log(`Records matching "${cls}":`, classRecords.length);
                
                if (classRecords.length > 0) {
                    console.log('Matching records:', classRecords);
                }
                
                // Render cards and view enrollments
                renderEventCards();
                viewStudentClassEnrollments();
                
            }).catch(err => {
                console.error('Firebase read error:', err);
                alert('Error loading data: ' + err.message);
            });
        }

        function crLogin() {
            const cls = document.getElementById('crClass').value;
            if (!cls) { alert('Please select your class'); return; }
            
            crClass = cls;
            isCR = true;
            currentUser = 'CR';
            document.getElementById('userInfo').innerHTML = 'Logged in as: <span class="admin-badge">CR - '+cls+'</span>';
            document.getElementById('loginSection').style.display = 'none';
            document.getElementById('crSection').style.display = 'block';
            document.getElementById('crClassName').textContent = cls;
            
            // Force reload data from Firebase and then render
            console.log('=== CR LOGIN ===');
            console.log('Selected class:', cls);
            console.log('Firebase ref path:', ref.toString());
            
            ref.once('value').then(snap => {
                console.log('Snapshot exists?', snap.exists());
                
                all = [];
                if (snap.exists()) {
                    snap.forEach(child => {
                        const data = {id: child.key, ...child.val()};
                        all.push(data);
                    });
                }
                
                console.log('Total records loaded:', all.length);
                
                // Log first few records
                if (all.length > 0) {
                    console.log('Sample records:');
                    all.slice(0, 3).forEach((rec, i) => {
                        console.log(`  [${i}] Class: "${rec.classYear}" | Event: "${rec.event}" | Name: "${rec.name}"`);
                    });
                }
                
                // Show all unique classes in database
                const uniqueClasses = [...new Set(all.map(e => e.classYear))];
                console.log('Unique classes in database:', uniqueClasses);
                
                // Filter for this class
                const classRecords = all.filter(e => e.classYear === cls);
                console.log(`Records matching "${cls}":`, classRecords.length);
                
                if (classRecords.length > 0) {
                    console.log('Matching records:', classRecords);
                }
                
                renderCREventCards();
                updateCREventFilter();
                updateCRView();
                
            }).catch(err => {
                console.error('Firebase read error:', err);
                alert('Error loading data: ' + err.message);
            });
        }

        function adminLogin() {
            const pwd = document.getElementById('adminPassword').value;
            if (pwd !== adminPassword) { alert('Invalid admin password'); return; }
            
            isAdmin = true;
            currentUser = 'Admin';
            document.getElementById('userInfo').innerHTML = 'Logged in as: <span class="admin-badge">Admin</span>';
            document.getElementById('loginSection').style.display = 'none';
            document.getElementById('adminSection').style.display = 'block';
            
            // Show only basic tabs for admin
            document.querySelectorAll('.super-admin-only').forEach(el => el.style.display = 'none');
            
            // Check if any results are published and show/hide Results tab
            checkResultsPublished();
            
            // Manually trigger data load from Firebase and update displays
            ref.once('value', snap => {
                all = [];
                if (snap.exists()) {
                    snap.forEach(child => {
                        const data = {id: child.key, ...child.val()};
                        all.push(data);
                    });
                }
                updateStats();
                updateMaster();
                updateEvents();
            });
        }

        function superAdminLogin() {
            const pwd = document.getElementById('superAdminPassword').value;
            if (pwd !== superAdminPassword) { alert('Invalid super admin password'); return; }
            
            isAdmin = true;
            isSuperAdmin = true;
            currentUser = 'Super Admin';
            document.getElementById('userInfo').innerHTML = 'Logged in as: <span class="super-admin-badge">Super Admin</span>';
            document.getElementById('loginSection').style.display = 'none';
            document.getElementById('adminSection').style.display = 'block';
            
            // Show all tabs including super admin tabs
            document.querySelectorAll('.super-admin-only:not(.form-section)').forEach(el => el.style.display = 'block');
            
            // Super admin always sees Results tab
            document.getElementById('resultsTab').style.display = 'block';
            
            // Manually trigger data load from Firebase and update displays
            ref.once('value', snap => {
                all = [];
                if (snap.exists()) {
                    snap.forEach(child => {
                        const data = {id: child.key, ...child.val()};
                        all.push(data);
                    });
                }
                updateStats();
                updateMaster();
                updateEvents();
            });
        }

        function juryLogin() {
            const event = document.getElementById('juryEvent').value;
            const pwd = document.getElementById('juryPassword').value;
            const num = document.getElementById('juryNumber').value;
            
            if (!event || !pwd || !num) {
                alert('Please fill all fields');
                return;
            }
            
            // Load jury setup to get password and name
            db.ref('jurySetup/'+event).once('value').then(snap => {
                const setup = snap.val();
                if (!setup) {
                    alert('Event setup not found. Contact super admin.');
                    return;
                }
                
                const juryPassword = setup['jury'+num+'Password'];
                const juryName = setup['jury'+num+'Name'] || 'Jury ' + num;
                
                if (juryPassword === pwd) {
                    isJury = true;
                    juryEvent = event;
                    juryNumber = num;
                    currentUser = 'Jury';
                    
                    document.getElementById('userInfo').innerHTML = 'Logged in as: <span class="jury-badge">'+juryName+' - '+event+'</span>';
                    document.getElementById('loginSection').style.display = 'none';
                    document.getElementById('jurySection').style.display = 'block';
                    document.getElementById('juryEventTitle').textContent = 'Jury Evaluation - ' + event;
                    document.getElementById('juryInfo').textContent = 'You are ' + juryName + ' for ' + event;
                    
                    loadJurySheet();
                } else {
                    alert('Invalid jury password for this event');
                }
            }).catch(err => {
                alert('Error loading jury setup: ' + err.message);
            });
        }

        function reloadStudentData() {
            console.log('=== RELOADING DATA FROM FIREBASE ===');
            const statusText = document.getElementById('debugStatusText');
            if (statusText) statusText.innerHTML = 'üîÑ Reloading data from Firebase...';
            
            ref.once('value', snap => {
                console.log('Firebase snapshot exists?', snap.exists());
                console.log('Firebase snapshot:', snap.val());
                
                all = [];
                let childCount = 0;
                if (snap.exists()) {
                    snap.forEach(child => {
                        childCount++;
                        const data = {id: child.key, ...child.val()};
                        console.log('Loading child #' + childCount + ':', child.key, data);
                        all.push(data);
                    });
                }
                
                console.log('‚úÖ Data reloaded!');
                console.log('Total children processed:', childCount);
                console.log('Total records in "all" array:', all.length);
                console.log('All data:', all);
                
                // Show breakdown by class
                const classCounts = {};
                all.forEach(e => {
                    if (!classCounts[e.classYear]) classCounts[e.classYear] = 0;
                    classCounts[e.classYear]++;
                });
                console.log('Records by class:', classCounts);
                
                if (statusText) statusText.innerHTML = '‚úÖ Data reloaded! Total records: ' + all.length + ' | Classes: ' + Object.keys(classCounts).length;
                
                // Also update event cards
                renderEventCards();
                
                let msg = 'Data reloaded!\n\n';
                msg += 'Total records: ' + all.length + '\n';
                msg += 'Classes found: ' + Object.keys(classCounts).join(', ') + '\n\n';
                msg += 'Now click "View Enrollments" or "Show All DB Data"';
                alert(msg);
            }).catch(err => {
                console.error('Firebase error:', err);
                alert('Error loading data: ' + err.message);
                if (statusText) statusText.innerHTML = '‚ùå Error: ' + err.message;
            });
        }
        
        function showAllDatabaseData() {
            console.log('=== SHOWING ALL DATABASE DATA ===');
            const cont = document.getElementById('studentEnrollmentResults');
            
            if (all.length === 0) {
                cont.innerHTML = '<div style="background:#ffebee;color:#c62828;padding:15px;border-radius:6px;border:2px solid #c62828;"><strong>‚ö†Ô∏è NO DATA IN DATABASE</strong><br>The "all" array is empty. Try clicking "Reload Data" first.</div>';
                return;
            }
            
            // Group by class
            const classCounts = {};
            all.forEach(e => {
                if (!classCounts[e.classYear]) classCounts[e.classYear] = [];
                classCounts[e.classYear].push(e);
            });
            
            let html = '<div style="background:#fff;border-radius:6px;padding:15px;border:2px solid #9c27b0;">';
            html += '<h4 style="color:#9c27b0;margin-bottom:15px;">üóÑÔ∏è Complete Database View (Total: ' + all.length + ' records)</h4>';
            
            Object.keys(classCounts).sort().forEach(cls => {
                const enrollments = classCounts[cls];
                const isYourClass = cls === studentClass;
                
                html += '<div style="background:' + (isYourClass ? '#e8f5e9' : '#f5f5f5') + ';padding:12px;border-radius:6px;margin-bottom:10px;border:2px solid ' + (isYourClass ? '#4CAF50' : '#ccc') + ';">';
                html += '<h5 style="color:' + (isYourClass ? '#2e7d32' : '#333') + ';margin-bottom:8px;">';
                html += (isYourClass ? 'üëâ ' : '') + '"' + cls + '" (' + enrollments.length + ' enrollments)' + (isYourClass ? ' ‚Üê YOUR CLASS' : '');
                html += '</h5>';
                
                html += '<table style="width:100%;font-size:12px;"><thead><tr><th>Name</th><th>Phone</th><th>Event</th><th>Role</th></tr></thead><tbody>';
                enrollments.forEach(e => {
                    html += '<tr><td>' + e.name + '</td><td>' + e.phone + '</td><td>' + e.event + '</td><td>' + e.role + '</td></tr>';
                });
                html += '</tbody></table></div>';
            });
            
            html += '</div>';
            cont.innerHTML = html;
        }

        function toggleEnrollmentView() {
            const resultsDiv = document.getElementById('studentEnrollmentResults');
            const btn = document.getElementById('toggleEnrollmentBtn');
            
            if (resultsDiv.style.display === 'none') {
                resultsDiv.style.display = 'block';
                btn.textContent = 'Hide Details';
            } else {
                resultsDiv.style.display = 'none';
                btn.textContent = 'Show Details';
            }
        }

        function viewStudentClassEnrollments() {
            console.log('=== Loading class enrollments ===');
            console.log('Student Class:', studentClass);
            console.log('All enrollments count:', all.length);
            
            const cont = document.getElementById('studentEnrollmentResults');
            
            if (!studentClass) { 
                console.error('ERROR: Student class not set!');
                cont.innerHTML = '<div style="background:#ffebee;color:#c62828;padding:15px;border-radius:6px;border:2px solid #c62828;"><strong>Error:</strong> Student class not set. Please log out and log in again.</div>';
                return; 
            }
            
            console.log('Filtering enrollments for class:', studentClass);
            let classEnr = all.filter(e => e.classYear === studentClass);
            console.log('Filtered enrollments count:', classEnr.length);
            
            // Populate event filter dropdown
            const eventFilter = document.getElementById('studentEventFilter');
            const currentFilter = eventFilter.value;
            
            // Get unique events from class enrollments
            const uniqueEvents = [...new Set(classEnr.map(e => e.event))].sort();
            
            // Update dropdown options
            eventFilter.innerHTML = '<option value="">All Events</option>';
            uniqueEvents.forEach(evt => {
                const option = document.createElement('option');
                option.value = evt;
                option.textContent = evt;
                if (evt === currentFilter) option.selected = true;
                eventFilter.appendChild(option);
            });
            
            // Filter by selected event
            if (currentFilter) {
                classEnr = classEnr.filter(e => e.event === currentFilter);
            }
            
            if (classEnr.length === 0) {
                cont.innerHTML = '<div style="background:#fff3cd;color:#856404;padding:15px;border-radius:6px;border:2px solid #ffc107;text-align:center;"><h4 style="margin-bottom:10px;">No Enrollments</h4><p style="margin:0;">' + (currentFilter ? 'No enrollments found for ' + currentFilter : 'Your class has not enrolled in any events yet.') + '</p></div>';
                return; 
            }
            
            // Group by event
            const eventGroups = {};
            classEnr.forEach(e => {
                if (!eventGroups[e.event]) eventGroups[e.event] = [];
                eventGroups[e.event].push(e);
            });
            
            console.log('Event groups:', eventGroups);
            
            let h = '<div style="background:white;border-radius:6px;padding:15px;border:2px solid #4CAF50;">';
            h += '<h4 style="color:#c44569;margin-bottom:15px;">‚úÖ ' + studentClass + (currentFilter ? ' - ' + currentFilter : '') + ' - Total: ' + classEnr.length + '</h4>';
            
            // Show summary by event (only if showing all events)
            if (!currentFilter) {
                h += '<div style="margin-bottom:20px;">';
                h += '<h5 style="color:#2196F3;margin-bottom:10px;">üìä Enrolled Events:</h5>';
                h += '<div style="display:flex;flex-wrap:wrap;gap:10px;">';
                Object.keys(eventGroups).forEach(evt => {
                    h += '<span style="background:#4CAF50;color:white;padding:8px 15px;border-radius:20px;font-size:14px;font-weight:600;">' + evt + ' (' + eventGroups[evt].length + ')</span>';
                });
                h += '</div></div>';
            }
            
            // Show detailed table
            h += '<div class="table-wrapper"><table><thead><tr><th>Sl</th><th>Name</th><th>Phone</th><th>Event</th><th>Role</th><th>Details</th><th>Actions</th></tr></thead><tbody>';
            classEnr.forEach((e,i) => {
                h += '<tr><td>'+(i+1)+'</td><td>'+e.name+'</td><td>'+e.phone+'</td><td>'+e.event+'</td><td>'+e.role+'</td><td>'+getDet(e)+'</td>';
                h += '<td><button class="edit-btn" data-key="'+e.id+'" onclick="editEnrollmentByKey(this.getAttribute(\'data-key\'))">Edit</button>';
                h += '<button class="delete-btn" data-key="'+e.id+'" data-name="'+e.name+'" data-event="'+e.event+'" onclick="deleteEnrollmentByKey(this.getAttribute(\'data-key\'), this.getAttribute(\'data-name\'), this.getAttribute(\'data-event\'))">Delete</button></td></tr>';
            });
            h += '</tbody></table></div></div>';
            cont.innerHTML = h;
            
            console.log('=== Enrollment display complete ===');
        }

        function logout() {
            studentClass = null;
            crClass = null;
            isAdmin = false;
            isSuperAdmin = false;
            isCR = false;
            isJury = false;
            juryEvent = null;
            juryNumber = null;
            currentUser = null;
            
            // Quiz logout
            quizCurrentUser = null;
            quizUserRole = null;
            quizAntiCheatActive = false;
            if (quizTimerInterval) clearInterval(quizTimerInterval);
            
            document.getElementById('userInfo').innerHTML = '';
            document.getElementById('loginSection').style.display = 'block';
            document.getElementById('studentSection').style.display = 'none';
            document.getElementById('crSection').style.display = 'none';
            document.getElementById('adminSection').style.display = 'none';
            document.getElementById('jurySection').style.display = 'none';
            document.getElementById('quizStudentDashboard').style.display = 'none';
            document.getElementById('quizAdminDashboard').style.display = 'none';
            document.getElementById('quizPage').style.display = 'none';
            document.getElementById('userType').value = '';
            handleUserTypeChange();
        }

        function renderEventCards() {
            const cont = document.getElementById('eventCardsContainer');
            cont.innerHTML = '';
            Object.keys(events).forEach(ev => {
                const cfg = events[ev];
                const enrolled = all.filter(e => e.event===ev && e.classYear===studentClass).length;
                
                // Calculate enrolled teams/participants
                const enrolledCount = cfg.count === 1 ? enrolled : Math.ceil(enrolled / cfg.count);
                const remaining = cfg.maxPerClass - enrolledCount;
                const isFull = remaining <= 0;
                
                const card = document.createElement('div');
                card.className = 'event-card' + (isFull ? ' full' : '');
                card.innerHTML = '<div class="event-title">'+ev+'</div><div class="event-size">'+cfg.size+'</div><div class="event-status '+(isFull?'status-full':(remaining<=1?'status-limited':'status-available'))+'">'+enrolledCount+'/'+cfg.maxPerClass+' enrolled</div>';
                if (!isFull) card.onclick = () => startEnrollment(ev);
                cont.appendChild(card);
            });
        }

        function renderCREventCards() {
            const cont = document.getElementById('crEventCardsContainer');
            cont.innerHTML = '';
            Object.keys(events).forEach(ev => {
                const cfg = events[ev];
                const enrolled = all.filter(e => e.event===ev && e.classYear===crClass).length;
                
                // Calculate enrolled teams/participants
                const enrolledCount = cfg.count === 1 ? enrolled : Math.ceil(enrolled / cfg.count);
                const remaining = cfg.maxPerClass - enrolledCount;
                const isFull = remaining <= 0;
                
                const card = document.createElement('div');
                card.className = 'event-card' + (isFull ? ' full' : '');
                card.innerHTML = '<div class="event-title">'+ev+'</div><div class="event-size">'+cfg.size+'</div><div class="event-status '+(isFull?'status-full':(remaining<=1?'status-limited':'status-available'))+'">'+enrolledCount+'/'+cfg.maxPerClass+' enrolled</div>';
                if (!isFull) card.onclick = () => startCREnrollment(ev);
                cont.appendChild(card);
            });
        }

        function startEnrollment(ev) {
            selectedEvent = ev;
            const cfg = events[ev];
            const enrolled = all.filter(e => e.event===ev && e.classYear===studentClass).length;
            
            // Calculate how many teams/participants are already enrolled
            const enrolledCount = cfg.count === 1 ? enrolled : Math.ceil(enrolled / cfg.count);
            const remaining = cfg.maxPerClass - enrolledCount;
            
            if (remaining <= 0) { alert('Event is full for your class'); return; }
            
            let html = '<h3 style="color:#c44569;margin-bottom:20px">Enroll for: '+ev+'</h3>';
            html += '<p style="margin-bottom:20px;color:#666">'+cfg.size+' | Already Enrolled: '+enrolledCount+' / '+cfg.maxPerClass+'</p>';
            
            // Generate input fields based on team size
            for (let i = 0; i < cfg.count; i++) {
                const roleLabel = cfg.role ? (i === 0 ? 'Captain' : 'Member '+(i+1)) : 'Participant '+(i+1);
                html += '<div class="team-member-box"><div class="member-header">'+roleLabel+'</div>';
                html += '<div class="form-group"><label>Name:</label><input type="text" id="name'+i+'" placeholder="Enter full name"></div>';
                html += '<div class="form-group"><label>Phone Number:</label><input type="tel" id="phone'+i+'" placeholder="10-digit mobile number" maxlength="10"></div>';
                html += '</div>';
            }
            
            // Event-specific fields
            if (cfg.topic) {
                html += '<div class="form-group"><label>'+cfg.topicLabel+':</label><input type="text" id="topic" placeholder="Enter '+cfg.topicLabel.toLowerCase()+'"></div>';
            }
            if (cfg.prod) {
                html += '<div class="form-group"><label>Product Name:</label><input type="text" id="product" placeholder="What product will you advertise?"></div>';
            }
            if (cfg.cause) {
                html += '<div class="form-group"><label>'+(cfg.causeLabel || 'Cause')+':</label><input type="text" id="cause" placeholder="Enter cause/theme"></div>';
            }
            if (cfg.lang) {
                html += '<div class="form-group"><label>Languages:</label><div><label style="display:inline-block;margin-right:15px"><input type="checkbox" id="langEn" checked disabled> English</label><label style="display:inline-block;margin-right:15px"><input type="checkbox" id="langKn"> Kannada</label><label style="display:inline-block"><input type="checkbox" id="langHi"> Hindi</label></div></div>';
            }
            if (cfg.show) {
                html += '<div class="form-group"><label>Showstopper Name:</label><input type="text" id="showstopper" placeholder="Name of showstopper"></div>';
            }
            
            document.getElementById('enrollmentFormContent').innerHTML = html;
            document.getElementById('eventCardsContainer').style.display = 'none';
            document.getElementById('enrollmentForm').style.display = 'block';
        }

        function submitEnrollment() {
            const cfg = events[selectedEvent];
            const members = [];
            
            // Collect all team members
            for (let i = 0; i < cfg.count; i++) {
                const name = document.getElementById('name'+i).value.trim();
                const phone = document.getElementById('phone'+i).value.trim();
                
                if (!name || !phone) { 
                    alert('Please fill all team member fields'); 
                    return; 
                }
                if (!/^\d{10}$/.test(phone)) { 
                    alert('Please enter valid 10-digit phone number for '+name); 
                    return; 
                }
                
                const role = cfg.role ? (i === 0 ? 'Captain' : 'Member') : 'Participant';
                members.push({name: name, phone: phone, role: role});
            }
            
            // Base data for all members
            const baseData = {
                classYear: studentClass,
                event: selectedEvent,
                timestamp: Date.now()
            };
            
            // Add event-specific fields
            if (cfg.topic) {
                const topic = document.getElementById('topic');
                if (!topic || !topic.value.trim()) {
                    alert('Please enter '+cfg.topicLabel);
                    return;
                }
                baseData.topic = topic.value.trim();
            }
            
            if (cfg.prod) {
                const product = document.getElementById('product');
                if (!product || !product.value.trim()) {
                    alert('Please enter product name');
                    return;
                }
                baseData.product = product.value.trim();
            }
            
            if (cfg.cause) {
                const cause = document.getElementById('cause');
                if (!cause || !cause.value.trim()) {
                    alert('Please enter '+(cfg.causeLabel || 'cause'));
                    return;
                }
                baseData.cause = cause.value.trim();
            }
            
            if (cfg.lang) {
                const langs = ['English'];
                const kn = document.getElementById('langKn');
                const hi = document.getElementById('langHi');
                if (kn && kn.checked) langs.push('Kannada');
                if (hi && hi.checked) langs.push('Hindi');
                baseData.languages = langs.join(', ');
            }
            
            if (cfg.show) {
                const show = document.getElementById('showstopper');
                if (!show || !show.value.trim()) {
                    alert('Please enter showstopper name');
                    return;
                }
                baseData.showstopper = show.value.trim();
            }
            
            // Submit all members
            const promises = members.map(m => {
                const data = {...baseData, name: m.name, phone: m.phone, role: m.role};
                return ref.push(data);
            });
            
            Promise.all(promises).then(() => {
                showOk('Successfully enrolled '+members.length+' member(s) for '+selectedEvent+'!');
                cancelEnrollment();
            }).catch(err => showErr('Error: '+err.message));
        }

        function cancelEnrollment() {
            selectedEvent = null;
            document.getElementById('enrollmentForm').style.display = 'none';
            document.getElementById('eventCardsContainer').style.display = 'grid';
        }

        // CR Functions
        function startCREnrollment(ev) {
            selectedEvent = ev;
            const cfg = events[ev];
            const enrolled = all.filter(e => e.event===ev && e.classYear===crClass).length;
            
            // Calculate how many teams/participants are already enrolled
            const enrolledCount = cfg.count === 1 ? enrolled : Math.ceil(enrolled / cfg.count);
            const remaining = cfg.maxPerClass - enrolledCount;
            
            if (remaining <= 0) { alert('Event is full for your class'); return; }
            
            let html = '<h3 style="color:#c44569;margin-bottom:20px">Enroll Students for: '+ev+'</h3>';
            html += '<p style="margin-bottom:20px;color:#666">Class: '+crClass+' | '+cfg.size+' | Enrolled: '+enrolledCount+' / '+cfg.maxPerClass+'</p>';
            
            // Generate input fields based on team size
            for (let i = 0; i < cfg.count; i++) {
                const roleLabel = cfg.role ? (i === 0 ? 'Captain' : 'Member '+(i+1)) : 'Participant '+(i+1);
                html += '<div class="team-member-box"><div class="member-header">'+roleLabel+'</div>';
                html += '<div class="form-group"><label>Name:</label><input type="text" id="crName'+i+'" placeholder="Enter student full name"></div>';
                html += '<div class="form-group"><label>Phone Number:</label><input type="tel" id="crPhone'+i+'" placeholder="10-digit mobile number" maxlength="10"></div>';
                html += '</div>';
            }
            
            // Event-specific fields
            if (cfg.topic) {
                html += '<div class="form-group"><label>'+cfg.topicLabel+':</label><input type="text" id="crTopic" placeholder="Enter '+cfg.topicLabel.toLowerCase()+'"></div>';
            }
            if (cfg.prod) {
                html += '<div class="form-group"><label>Product Name:</label><input type="text" id="crProduct" placeholder="What product will they advertise?"></div>';
            }
            if (cfg.cause) {
                html += '<div class="form-group"><label>'+(cfg.causeLabel || 'Cause')+':</label><input type="text" id="crCause" placeholder="Enter cause/theme"></div>';
            }
            if (cfg.lang) {
                html += '<div class="form-group"><label>Languages:</label><div><label style="display:inline-block;margin-right:15px"><input type="checkbox" id="crLangEn" checked disabled> English</label><label style="display:inline-block;margin-right:15px"><input type="checkbox" id="crLangKn"> Kannada</label><label style="display:inline-block"><input type="checkbox" id="crLangHi"> Hindi</label></div></div>';
            }
            if (cfg.show) {
                html += '<div class="form-group"><label>Showstopper Name:</label><input type="text" id="crShowstopper" placeholder="Name of showstopper"></div>';
            }
            
            document.getElementById('crEnrollmentFormContent').innerHTML = html;
            document.getElementById('crEventCardsContainer').style.display = 'none';
            document.getElementById('crEnrollmentForm').style.display = 'block';
        }

        function submitCREnrollment() {
            const cfg = events[selectedEvent];
            const members = [];
            
            // Collect all team members
            for (let i = 0; i < cfg.count; i++) {
                const name = document.getElementById('crName'+i).value.trim();
                const phone = document.getElementById('crPhone'+i).value.trim();
                
                if (!name || !phone) { 
                    alert('Please fill all team member fields'); 
                    return; 
                }
                if (!/^\d{10}$/.test(phone)) { 
                    alert('Please enter valid 10-digit phone number for '+name); 
                    return; 
                }
                
                const role = cfg.role ? (i === 0 ? 'Captain' : 'Member') : 'Participant';
                members.push({name: name, phone: phone, role: role});
            }
            
            // Base data for all members
            const baseData = {
                classYear: crClass,
                event: selectedEvent,
                enrolledBy: 'CR',
                timestamp: Date.now()
            };
            
            // Add event-specific fields
            if (cfg.topic) {
                const topic = document.getElementById('crTopic');
                if (!topic || !topic.value.trim()) {
                    alert('Please enter '+cfg.topicLabel);
                    return;
                }
                baseData.topic = topic.value.trim();
            }
            
            if (cfg.prod) {
                const product = document.getElementById('crProduct');
                if (!product || !product.value.trim()) {
                    alert('Please enter product name');
                    return;
                }
                baseData.product = product.value.trim();
            }
            
            if (cfg.cause) {
                const cause = document.getElementById('crCause');
                if (!cause || !cause.value.trim()) {
                    alert('Please enter '+(cfg.causeLabel || 'cause'));
                    return;
                }
                baseData.cause = cause.value.trim();
            }
            
            if (cfg.lang) {
                const langs = ['English'];
                const kn = document.getElementById('crLangKn');
                const hi = document.getElementById('crLangHi');
                if (kn && kn.checked) langs.push('Kannada');
                if (hi && hi.checked) langs.push('Hindi');
                baseData.languages = langs.join(', ');
            }
            
            if (cfg.show) {
                const show = document.getElementById('crShowstopper');
                if (!show || !show.value.trim()) {
                    alert('Please enter showstopper name');
                    return;
                }
                baseData.showstopper = show.value.trim();
            }
            
            // Submit all members
            const promises = members.map(m => {
                const data = {...baseData, name: m.name, phone: m.phone, role: m.role};
                return ref.push(data);
            });
            
            Promise.all(promises).then(() => {
                showCROk('Successfully enrolled '+members.length+' student(s) for '+selectedEvent+'!');
                cancelCREnrollment();
            }).catch(err => showCRErr('Error: '+err.message));
        }

        function cancelCREnrollment() {
            selectedEvent = null;
            document.getElementById('crEnrollmentForm').style.display = 'none';
            document.getElementById('crEventCardsContainer').style.display = 'grid';
        }

        function showCRTab(tab) {
            document.querySelectorAll('#crSection .tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('#crSection .form-section').forEach(s => s.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById(tab).classList.add('active');
        }

        function updateCREventFilter() {
            const sel = document.getElementById('crFilterEvent');
            sel.innerHTML = '<option value="">All Events</option>';
            const enrolled = [...new Set(all.filter(e => e.classYear === crClass).map(e => e.event))];
            enrolled.forEach(ev => {
                const opt = document.createElement('option');
                opt.value = ev;
                opt.textContent = ev;
                sel.appendChild(opt);
            });
        }

        function updateCRView() {
            console.log('=== updateCRView called ===');
            console.log('crClass:', crClass);
            console.log('all.length:', all.length);
            
            const filterEv = document.getElementById('crFilterEvent').value;
            let filtered = all.filter(e => e.classYear === crClass);
            
            console.log('Filtered by class:', filtered.length);
            
            if (filterEv) {
                filtered = filtered.filter(e => e.event === filterEv);
                console.log('Filtered by event:', filtered.length);
            }
            
            // Summary
            let summary = '<h3 style="color:#2196F3;margin-bottom:10px">Your Class: <strong>'+crClass+'</strong></h3>';
            summary += '<p><strong>Total Students Enrolled:</strong> '+filtered.length+'</p>';
            if (filterEv) summary += '<p><strong>Event:</strong> '+filterEv+'</p>';
            document.getElementById('crSummary').innerHTML = summary;
            
            // Table
            const cont = document.getElementById('crEnrollmentsContainer');
            if (filtered.length === 0) {
                console.log('No enrollments found - showing empty message');
                cont.innerHTML = '<p style="text-align:center;padding:40px;color:#999">No enrollments yet</p>';
            } else {
                console.log('Building table with', filtered.length, 'rows');
                let html = '<div class="table-wrapper"><table><thead><tr><th>Sl</th><th>Name</th><th>Phone</th><th>Event</th><th>Role</th><th>Details</th><th>Actions</th></tr></thead><tbody>';
                filtered.forEach((e,i) => {
                    html += '<tr><td>'+(i+1)+'</td><td>'+e.name+'</td><td>'+e.phone+'</td><td>'+e.event+'</td><td>'+e.role+'</td><td>'+getDet(e)+'</td>';
                    html += '<td><button class="edit-btn" data-key="'+e.id+'" onclick="editEnrollmentByKey(this.getAttribute(\'data-key\'))">Edit</button>';
                    html += '<button class="delete-btn" data-key="'+e.id+'" data-name="'+e.name+'" data-event="'+e.event+'" onclick="deleteEnrollmentByKey(this.getAttribute(\'data-key\'), this.getAttribute(\'data-name\'), this.getAttribute(\'data-event\'))">Delete</button></td></tr>';
                });
                html += '</tbody></table></div>';
                cont.innerHTML = html;
            }
            
            // Update CR event cards to show current enrollment counts
            renderCREventCards();
        }

        function clearCRFilters() {
            document.getElementById('crFilterEvent').value = '';
            updateCRView();
        }

        function downloadCREnrollments() {
            console.log('=== DOWNLOAD CR ENROLLMENTS ===');
            console.log('CR Class:', crClass);
            console.log('Total records in all:', all.length);
            
            if (!crClass) {
                alert('Error: Class not set. Please log out and log in again.');
                return;
            }
            
            // Filter all enrollments for this CR's class
            const classEnrollments = all.filter(e => e.classYear === crClass);
            
            console.log('Filtered enrollments for', crClass, ':', classEnrollments.length);
            
            if (classEnrollments.length === 0) {
                alert('No enrollments to download for ' + crClass);
                return;
            }
            
            // Check if event filter is applied
            const filterEv = document.getElementById('crFilterEvent').value;
            let enrollmentsToDownload = classEnrollments;
            
            if (filterEv) {
                enrollmentsToDownload = classEnrollments.filter(e => e.event === filterEv);
                console.log('Filtered by event', filterEv, ':', enrollmentsToDownload.length);
            }
            
            // Create CSV content
            let csv = 'Sl,Name,Phone,Class,Event,Role,Details\n';
            enrollmentsToDownload.forEach((e, i) => {
                const details = getDet(e).replace(/<br>/g, ' | ').replace(/"/g, '""');
                csv += `${i+1},"${e.name}","${e.phone}","${e.classYear}","${e.event}","${e.role}","${details}"\n`;
            });
            
            // Generate filename
            const filename = filterEv 
                ? `${crClass}_${filterEv}_enrollments.csv`.replace(/\s+/g, '_')
                : `${crClass}_all_enrollments.csv`.replace(/\s+/g, '_');
            
            console.log('Downloading', enrollmentsToDownload.length, 'records as', filename);
            
            // Download
            download(csv, filename);
            
            showCROk(`Downloaded ${enrollmentsToDownload.length} enrollment(s) successfully!`);
        }

        function showCROk(msg) {
            const d = document.getElementById('crMessage');
            d.className = 'message success show';
            d.textContent = '‚úì '+msg;
            setTimeout(() => d.classList.remove('show'), 5000);
        }

        function showCRErr(msg) {
            const d = document.getElementById('crMessage');
            d.className = 'message error show';
            d.textContent = '‚úó '+msg;
            setTimeout(() => d.classList.remove('show'), 5000);
        }

        // Admin Functions
        function showTab(tab) {
            document.querySelectorAll('#adminSection .tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('#adminSection .form-section').forEach(s => s.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById(tab).classList.add('active');
            
            if (tab === 'results') {
                loadResultsTab();
            }
            if (tab === 'quizManagement') {
                loadQuizManagementStats();
                showQuizManagementTab('questions');
                initializeDateSelector(); // Initialize date selector with today's date
            }
        }

        function updateStats() {
            const uniqueStudents = new Set(all.map(e => e.phone)).size;
            const uniqueClasses = new Set(all.map(e => e.classYear)).size;
            const activeEvents = new Set(all.map(e => e.event)).size;
            
            document.getElementById('totalStudents').textContent = uniqueStudents;
            document.getElementById('totalEvents').textContent = activeEvents;
            document.getElementById('totalClasses').textContent = uniqueClasses;
            document.getElementById('totalEnrollments').textContent = all.length;
        }

        function updateMaster() {
            // Use setTimeout to ensure dropdown has updated
            setTimeout(() => {
                const filterCl = document.getElementById('filterClass') ? document.getElementById('filterClass').value : '';
                const filterEv = document.getElementById('filterEvent') ? document.getElementById('filterEvent').value : '';
                
                let filtered = [...all]; // Create a copy
                
                if (filterCl) {
                    filtered = filtered.filter(e => e.classYear === filterCl);
                }
                
                if (filterEv) {
                    filtered = filtered.filter(e => e.event === filterEv);
                }
                
                updateSummary(filterCl, filterEv);
                
                const cont = document.getElementById('masterContainer');
                if (!cont) {
                    return;
                }
                
                if (filtered.length === 0) {
                    cont.innerHTML = '<p style="text-align:center;padding:40px;color:#999">No data available</p>';
                    return;
                }
                
                let html = '<div class="table-wrapper"><table><thead><tr><th>Sl</th><th>Name</th><th>Phone</th><th>Class</th><th>Event</th><th>Role</th><th>Details</th><th>Actions</th></tr></thead><tbody>';
                filtered.forEach((e,i) => {
                    html += '<tr><td>'+(i+1)+'</td><td>'+e.name+'</td><td>'+e.phone+'</td><td>'+e.classYear+'</td><td>'+e.event+'</td><td>'+e.role+'</td><td>'+getDet(e)+'</td>';
                    html += '<td><button class="edit-btn" data-key="'+e.id+'" onclick="editEnrollmentByKey(this.getAttribute(\'data-key\'))">Edit</button>';
                    html += '<button class="delete-btn" data-key="'+e.id+'" data-name="'+e.name+'" data-event="'+e.event+'" onclick="deleteEnrollmentByKey(this.getAttribute(\'data-key\'), this.getAttribute(\'data-name\'), this.getAttribute(\'data-event\'))">Delete</button></td></tr>';
                });
                html += '</tbody></table></div>';
                cont.innerHTML = html;
            }, 10); // Small delay to ensure dropdown has updated
        }

        function updateSummary(selectedClass, selectedEvent) {
            const summaryContent = document.getElementById('summaryInfo');
            let html = '<h3 style="color:#2196F3;margin-bottom:15px">üìä Summary</h3>';
            html += '<p><strong>Total Enrollments:</strong> '+all.length+'</p>';
            
            // When Event is selected (no class) - show class enrollment status
            if (!selectedClass && selectedEvent) {
                const enrolledClasses = [];
                const notEnrolledClasses = [];
                
                classes.forEach(cls => {
                    const hasEnrollment = all.some(e => e.classYear === cls && e.event === selectedEvent);
                    if (hasEnrollment) {
                        const count = all.filter(e => e.classYear === cls && e.event === selectedEvent).length;
                        enrolledClasses.push({name: cls, count: count});
                    } else {
                        notEnrolledClasses.push(cls);
                    }
                });
                
                html += '<div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;">';
                
                // Classes with Enrollments
                html += '<div style="background:#d4edda;padding:15px;border-radius:6px;border:2px solid #28a745;">';
                html += '<h4 style="color:#155724;margin-bottom:10px;">‚úÖ Classes with Enrollments (' + enrolledClasses.length + ')</h4>';
                if (enrolledClasses.length > 0) {
                    html += '<div style="display:flex;flex-wrap:wrap;gap:8px;">';
                    enrolledClasses.forEach(cls => {
                        html += '<span style="background:#28a745;color:white;padding:6px 12px;border-radius:20px;font-size:14px;font-weight:600;">' + cls.name + ' (' + cls.count + ')</span>';
                    });
                    html += '</div>';
                } else {
                    html += '<p style="color:#666;font-style:italic;margin:0;">No classes enrolled yet</p>';
                }
                html += '</div>';
                
                // Classes NOT Enrolled
                html += '<div style="background:#f8d7da;padding:15px;border-radius:6px;border:2px solid #dc3545;">';
                html += '<h4 style="color:#721c24;margin-bottom:10px;">‚ùå Classes NOT Enrolled (' + notEnrolledClasses.length + ')</h4>';
                if (notEnrolledClasses.length > 0) {
                    html += '<div style="display:flex;flex-wrap:wrap;gap:8px;">';
                    notEnrolledClasses.forEach(cls => {
                        html += '<span style="background:#dc3545;color:white;padding:6px 12px;border-radius:20px;font-size:14px;font-weight:600;">' + cls + '</span>';
                    });
                    html += '</div>';
                } else {
                    html += '<p style="color:#666;font-style:italic;margin:0;">All classes have enrolled!</p>';
                }
                html += '</div>';
                html += '</div>';
            }
            
            // When Class is selected - show event enrollment status
            if (selectedClass && !selectedEvent) {
                const enrolledEvents = [];
                const pendingEvents = [];
                
                Object.keys(events).forEach(evt => {
                    const hasEnrollment = all.some(e => e.classYear === selectedClass && e.event === evt);
                    if (hasEnrollment) {
                        const count = all.filter(e => e.classYear === selectedClass && e.event === evt).length;
                        enrolledEvents.push({name: evt, count: count});
                    } else {
                        pendingEvents.push(evt);
                    }
                });
                
                html += '<h3 style="color:#2196F3;margin-bottom:15px;">üìä Summary for Class: <strong>' + selectedClass + '</strong></h3>';
                html += '<div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;">';
                
                // Enrolled Events
                html += '<div style="background:white;padding:15px;border-radius:6px;">';
                html += '<h4 style="color:#4CAF50;margin-bottom:10px;">‚úÖ Enrolled Events (' + enrolledEvents.length + ')</h4>';
                if (enrolledEvents.length > 0) {
                    html += '<ul style="list-style:none;padding:0;margin:0;">';
                    enrolledEvents.forEach(evt => {
                        html += '<li style="padding:5px 0;border-bottom:1px solid #eee;">‚Ä¢ ' + evt.name + ' <span style="color:#666;">(' + evt.count + ' students)</span></li>';
                    });
                    html += '</ul>';
                } else {
                    html += '<p style="color:#999;font-style:italic;">No events enrolled yet</p>';
                }
                html += '</div>';
                
                // Pending Events
                html += '<div style="background:white;padding:15px;border-radius:6px;">';
                html += '<h4 style="color:#FF9800;margin-bottom:10px;">‚è≥ Pending Events (' + pendingEvents.length + ')</h4>';
                if (pendingEvents.length > 0) {
                    html += '<ul style="list-style:none;padding:0;margin:0;">';
                    pendingEvents.forEach(evt => {
                        html += '<li style="padding:5px 0;border-bottom:1px solid #eee;">‚Ä¢ ' + evt + '</li>';
                    });
                    html += '</ul>';
                } else {
                    html += '<p style="color:#999;font-style:italic;">All events completed!</p>';
                }
                html += '</div>';
                html += '</div>';
            }
            
            // When both Class and Event are selected
            if (selectedClass && selectedEvent) {
                const count = all.filter(e => e.classYear === selectedClass && e.event === selectedEvent).length;
                html += '<h3 style="color:#2196F3;margin-bottom:10px;">üìä Filtered View</h3>';
                html += '<p style="margin:0;"><strong>Class:</strong> ' + selectedClass + ' | <strong>Event:</strong> ' + selectedEvent + ' | <strong>Total Students:</strong> ' + count + '</p>';
            }
            
            summaryContent.innerHTML = html;
        }

        function updateEvents() {
            const cont = document.getElementById('eventsContainer');
            if (all.length===0) { cont.innerHTML = '<p style="text-align:center;padding:40px">No data</p>'; return; }
            let h = '';
            Object.keys(events).forEach(ev => {
                const evEnr = all.filter(e => e.event===ev);
                if (evEnr.length===0) return;
                h += '<div style="background:#f9f9f9;padding:20px;border-radius:8px;margin-bottom:20px"><h3 style="color:#c44569;margin-bottom:15px">'+ev+' ('+evEnr.length+')</h3>';
                classes.forEach(cl => {
                    const clEnr = evEnr.filter(e => e.classYear===cl);
                    if (clEnr.length===0) return;
                    h += '<div style="background:white;padding:15px;border-radius:6px;margin-bottom:15px"><h4 style="color:#6a1b9a;margin-bottom:10px">'+cl+' ('+clEnr.length+')</h4><div class="table-wrapper"><table><thead><tr><th>Sl</th><th>Name</th><th>Phone</th><th>Role</th><th>Details</th></tr></thead><tbody>';
                    clEnr.forEach((e,i) => h += '<tr><td>'+(i+1)+'</td><td>'+e.name+'</td><td>'+e.phone+'</td><td>'+e.role+'</td><td>'+getDet(e)+'</td></tr>');
                    h += '</tbody></table></div></div>';
                });
                h += '</div>';
            });
            cont.innerHTML = h;
        }

        function clearFilters() {
            document.getElementById('filterClass').value = '';
            document.getElementById('filterEvent').value = '';
            updateMaster();
        }

        function getDet(e) {
            const d = [];
            if (e.topic) d.push('Topic: '+e.topic);
            if (e.product) d.push('Product: '+e.product);
            if (e.cause) d.push('Cause: '+e.cause);
            if (e.languages) d.push('Languages: '+e.languages);
            if (e.showstopper) d.push('Showstopper: '+e.showstopper);
            return d.length>0 ? d.join('<br>') : '-';
        }

        function downloadMaster() {
            if (all.length===0) { alert('No data'); return; }
            let csv = 'Sl,Name,Phone,Class,Event,Role,Details\n';
            all.forEach((e,i) => csv += (i+1)+',"'+e.name+'","'+e.phone+'","'+e.classYear+'","'+e.event+'","'+e.role+'","'+getDet(e).replace(/<br>/g,' | ')+'"\n');
            download(csv,'youthfest_master.csv');
        }

        function downloadEvents() {
            if (all.length===0) { alert('No data'); return; }
            let csv = '';
            Object.keys(events).forEach(ev => {
                const evEnr = all.filter(e => e.event===ev);
                if (evEnr.length===0) return;
                csv += '\n'+ev+'\n';
                csv += 'Sl,Name,Phone,Class,Role,Details\n';
                let sl = 1;
                evEnr.forEach(e => { csv += sl+',"'+e.name+'","'+e.phone+'","'+e.classYear+'","'+e.role+'","'+getDet(e).replace(/<br>/g,' | ')+'"\n'; sl++; });
            });
            download(csv,'youthfest_events.csv');
        }

        function download(content,filename) {
            const blob = new Blob([content],{type:'text/csv'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            URL.revokeObjectURL(url);
        }

        // Jury Setup Functions (Super Admin Only)
        function loadEventSetup() {
            const event = document.getElementById('setupEventSelect').value;
            if (!event) {
                document.getElementById('eventSetupContainer').style.display = 'none';
                return;
            }
            
            document.getElementById('eventSetupContainer').style.display = 'block';
            
            // Load existing setup
            db.ref('jurySetup/'+event).once('value').then(snap => {
                const data = snap.val() || {};
                
                // Load jury names
                document.getElementById('jury1Name').value = data.jury1Name || '';
                document.getElementById('jury2Name').value = data.jury2Name || '';
                
                // Load jury passwords
                document.getElementById('jury1Password').value = data.jury1Password || '';
                document.getElementById('jury2Password').value = data.jury2Password || '';
                
                // Load criteria
                const criteria = data.criteria || [];
                renderCriteriaInputs(criteria);
            });
        }

        function renderCriteriaInputs(criteria) {
            const container = document.getElementById('criteriaContainer');
            container.innerHTML = '';
            
            if (criteria.length === 0) {
                criteria = ['', '', '', '', ''];  // Default 5 empty criteria
            }
            
            criteria.forEach((crit, index) => {
                const div = document.createElement('div');
                div.className = 'criteria-input-group';
                div.innerHTML = `
                    <label>Criterion ${index + 1}:</label>
                    <input type="text" class="criterion-input" data-index="${index}" value="${crit}" placeholder="e.g., Stage Presence, Creativity, Coordination">
                    ${criteria.length > 5 ? '<button class="remove-criteria-btn" onclick="removeCriterion('+index+')">Remove</button>' : ''}
                `;
                container.appendChild(div);
            });
        }

        function addCriterion() {
            const inputs = document.querySelectorAll('.criterion-input');
            const criteria = Array.from(inputs).map(inp => inp.value.trim());
            criteria.push('');
            renderCriteriaInputs(criteria);
        }

        function removeCriterion(index) {
            const inputs = document.querySelectorAll('.criterion-input');
            const criteria = Array.from(inputs).map(inp => inp.value.trim());
            if (criteria.length <= 5) {
                alert('Minimum 5 criteria required');
                return;
            }
            criteria.splice(index, 1);
            renderCriteriaInputs(criteria);
        }

        function saveEventSetup() {
            const event = document.getElementById('setupEventSelect').value;
            if (!event) return;
            
            const jury1Name = document.getElementById('jury1Name').value.trim();
            const jury2Name = document.getElementById('jury2Name').value.trim();
            const jury1Pwd = document.getElementById('jury1Password').value.trim();
            const jury2Pwd = document.getElementById('jury2Password').value.trim();
            
            if (!jury1Pwd || !jury2Pwd) {
                alert('Please set both jury passwords');
                return;
            }
            
            const inputs = document.querySelectorAll('.criterion-input');
            const criteria = Array.from(inputs).map(inp => inp.value.trim()).filter(c => c);
            
            if (criteria.length < 5) {
                alert('Please add at least 5 criteria');
                return;
            }
            
            const setupData = {
                jury1Name: jury1Name || 'Jury 1',
                jury2Name: jury2Name || 'Jury 2',
                jury1Password: jury1Pwd,
                jury2Password: jury2Pwd,
                criteria: criteria,
                resultsPublished: false
            };
            
            db.ref('jurySetup/'+event).set(setupData).then(() => {
                showSetupMessage('Setup saved successfully!', 'success');
            }).catch(err => {
                showSetupMessage('Error: '+err.message, 'error');
            });
        }

        function publishResults() {
            const event = document.getElementById('resultsEventSelect').value;
            if (!event) {
                alert('Please select an event first');
                return;
            }
            
            if (confirm('Publish results to all admins for '+event+'?')) {
                db.ref('jurySetup/'+event+'/resultsPublished').set(true).then(() => {
                    alert('‚úÖ Results published to admins for ' + event + '!');
                    // Show Results tab for all admins
                    updateResultsTabVisibility();
                });
            }
        }

        function unpublishResults() {
            const event = document.getElementById('resultsEventSelect').value;
            if (!event) {
                alert('Please select an event first');
                return;
            }
            
            if (confirm('Unpublish results for '+event+'?')) {
                db.ref('jurySetup/'+event+'/resultsPublished').set(false).then(() => {
                    alert('Results unpublished for ' + event);
                    // Check if any other results are published, hide tab if none
                    updateResultsTabVisibility();
                });
            }
        }

        function checkResultsPublished() {
            // For super admin, always show Results tab
            if (isSuperAdmin) {
                document.getElementById('resultsTab').style.display = 'block';
                return;
            }
            
            // For regular admin, check if any event has published results
            db.ref('jurySetup').once('value').then(snap => {
                let hasPublished = false;
                if (snap.exists()) {
                    snap.forEach(eventSnap => {
                        if (eventSnap.val().resultsPublished === true) {
                            hasPublished = true;
                        }
                    });
                }
                
                const resultsTab = document.getElementById('resultsTab');
                if (resultsTab) {
                    resultsTab.style.display = hasPublished ? 'block' : 'none';
                }
            });
        }
        
        function updateResultsTabVisibility() {
            // This is called after publish/unpublish to update tab visibility
            checkResultsPublished();
        }

        function showSetupMessage(msg, type) {
            const d = document.getElementById('setupMessage');
            d.className = 'message '+type+' show';
            d.textContent = (type === 'success' ? '‚úì ' : '‚úó ') + msg;
            setTimeout(() => d.classList.remove('show'), 5000);
        }

        // Jury Functions
        function loadJurySheet() {
            console.log('=== LOADING JURY SHEET ===');
            console.log('juryEvent:', juryEvent);
            console.log('Current all array length:', all.length);
            console.log('Firebase ref path:', ref.toString());
            
            // Show loading message
            document.getElementById('jurySheetContainer').innerHTML = '<p style="text-align:center;padding:40px;color:#666;">Loading enrollments...</p>';
            
            // First ensure we have the latest enrollment data
            console.log('Fetching from Firebase...');
            ref.once('value').then(snap => {
                console.log('Firebase snapshot received');
                console.log('Snapshot exists:', snap.exists());
                console.log('Snapshot numChildren:', snap.numChildren());
                
                all = [];
                if (snap.exists()) {
                    let count = 0;
                    snap.forEach(child => {
                        count++;
                        const enrollment = {id: child.key, ...child.val()};
                        all.push(enrollment);
                        if (count <= 5) {
                            console.log('Enrollment ' + count + ':', enrollment);
                        }
                    });
                    console.log('Total enrollments loaded:', count);
                } else {
                    console.log('No enrollments found in Firebase!');
                }
                
                console.log('Loaded enrollments, all array length:', all.length);
                console.log('First 3 enrollments:', all.slice(0, 3));
                
                // Filter for current event
                const eventEnrollments = all.filter(e => {
                    console.log('Checking enrollment:', e.event, '===', juryEvent, '?', e.event === juryEvent);
                    return e.event === juryEvent;
                });
                console.log('Enrollments for event "' + juryEvent + '":', eventEnrollments.length);
                console.log('Event enrollments:', eventEnrollments);
                
                // Now get jury setup
                return db.ref('jurySetup/'+juryEvent).once('value');
            }).then(snap => {
                const setup = snap.val();
                console.log('Jury setup:', setup);
                
                if (!setup || !setup.criteria) {
                    document.getElementById('jurySheetContainer').innerHTML = '<p style="text-align:center;padding:40px;color:#999">Event setup not complete. Contact super admin.</p>';
                    return;
                }
                
                // Get enrolled classes for this event
                const enrolledClasses = [...new Set(all.filter(e => e.event === juryEvent).map(e => e.classYear))];
                
                console.log('Enrolled classes for', juryEvent, ':', enrolledClasses);
                console.log('Total classes found:', enrolledClasses.length);
                
                if (enrolledClasses.length === 0) {
                    let debugInfo = '<p style="text-align:center;padding:40px;">';
                    debugInfo += '<strong style="color:#f44336;">No classes enrolled for this event yet.</strong><br><br>';
                    debugInfo += '<span style="color:#666;">Event: ' + juryEvent + '<br>';
                    debugInfo += 'Total enrollments in database: ' + all.length + '<br>';
                    debugInfo += 'Enrollments for this event: ' + all.filter(e => e.event === juryEvent).length + '</span><br><br>';
                    debugInfo += '<button class="btn btn-info" onclick="showEnrollmentDebug()">üîç Debug Enrollments</button>';
                    debugInfo += '</p>';
                    document.getElementById('jurySheetContainer').innerHTML = debugInfo;
                    return;
                }
                
                renderJurySheet(enrolledClasses, setup.criteria);
                loadExistingMarks();
            }).catch(err => {
                console.error('Error loading jury sheet:', err);
                document.getElementById('jurySheetContainer').innerHTML = '<p style="text-align:center;padding:40px;color:red;">Error loading jury sheet: ' + err.message + '</p>';
            });
        }

        function renderJurySheet(enrolledClasses, criteria) {
            let html = '<div class="table-wrapper"><div class="marks-table"><table><thead><tr>';
            html += '<th>Class</th><th>Theme/Topic</th>';
            criteria.forEach((crit, i) => {
                html += '<th>'+crit+'<br><small>(10 marks)</small></th>';
            });
            html += '<th>Total</th></tr></thead><tbody>';
            
            enrolledClasses.forEach(cls => {
                const classEnrollments = all.filter(e => e.event === juryEvent && e.classYear === cls);
                const theme = classEnrollments.length > 0 ? getDet(classEnrollments[0]) : '-';
                
                html += '<tr><td><strong>'+cls+'</strong></td><td>'+theme+'</td>';
                criteria.forEach((crit, i) => {
                    html += '<td><input type="number" class="marks-input" data-class="'+cls+'" data-criterion="'+i+'" min="0" max="10" step="0.5" placeholder="0-10"></td>';
                });
                html += '<td class="total-marks" id="total-'+cls.replace(/\s+/g, '-')+'">0</td></tr>';
            });
            
            html += '</tbody></table></div></div>';
            
            document.getElementById('jurySheetContainer').innerHTML = html;
            
            // Add event listeners for auto-calculation
            document.querySelectorAll('.marks-input').forEach(inp => {
                inp.addEventListener('input', function() {
                    const cls = this.dataset.class;
                    calculateTotal(cls);
                });
            });
        }

        function loadExistingMarks() {
            const dbPath = 'juryMarks/' + juryEvent + '/jury' + juryNumber;
            console.log('=== LOADING EXISTING MARKS ===');
            console.log('Loading marks from:', dbPath);
            console.log('juryEvent:', juryEvent);
            console.log('juryNumber:', juryNumber);
            
            db.ref(dbPath).once('value').then(snap => {
                const marks = snap.val();
                console.log('Loaded marks data:', JSON.stringify(marks, null, 2));
                
                if (!marks) {
                    console.log('No existing marks found');
                    return;
                }
                
                // Check if this is test data (has 'test' property instead of class data)
                if (marks.test !== undefined) {
                    console.warn('‚ö†Ô∏è TEST DATA DETECTED in database!');
                    console.warn('Path contains test data instead of actual marks');
                    console.warn('You should clear this test data from Firebase Console');
                    showJuryMessage('Warning: Test data found in database. Clear it before saving real marks.', 'error');
                    return;
                }
                
                // Check what's in the database
                console.log('Database keys:', Object.keys(marks));
                
                // Check what inputs are available
                const allInputs = document.querySelectorAll('.marks-input');
                console.log('Total inputs found:', allInputs.length);
                allInputs.forEach(inp => {
                    console.log('Input found - class:', inp.dataset.class, 'criterion:', inp.dataset.criterion);
                });
                
                let marksLoaded = 0;
                
                Object.keys(marks).forEach(sanitizedCls => {
                    console.log('Processing class from database:', sanitizedCls);
                    
                    if (marks[sanitizedCls] && marks[sanitizedCls].marks && Array.isArray(marks[sanitizedCls].marks)) {
                        console.log('Marks array for', sanitizedCls, ':', marks[sanitizedCls].marks);
                        
                        // Get the original class name if available, otherwise use the sanitized one
                        const originalCls = marks[sanitizedCls].originalClassName || sanitizedCls;
                        console.log('Original class name:', originalCls);
                        
                        marks[sanitizedCls].marks.forEach((mark, i) => {
                            // Try to find input using original class name first
                            let selector = '.marks-input[data-class="'+originalCls+'"][data-criterion="'+i+'"]';
                            let inp = document.querySelector(selector);
                            
                            // If not found, try sanitized class name
                            if (!inp) {
                                selector = '.marks-input[data-class="'+sanitizedCls+'"][data-criterion="'+i+'"]';
                                inp = document.querySelector(selector);
                            }
                            
                            console.log('Looking for input with selector:', selector);
                            
                            if (inp) {
                                inp.value = mark;
                                marksLoaded++;
                                console.log('‚úì Set mark for', originalCls, 'criterion', i, ':', mark);
                            } else {
                                console.warn('‚úó Input NOT found for class:', originalCls, '(sanitized:', sanitizedCls, ') criterion:', i);
                            }
                        });
                        calculateTotal(originalCls);
                    } else {
                        console.warn('Invalid marks structure for class:', sanitizedCls, marks[sanitizedCls]);
                    }
                });
                
                if (marksLoaded > 0) {
                    showJuryMessage('Previous marks loaded successfully ('+marksLoaded+' marks)', 'success');
                } else {
                    showJuryMessage('No previous marks found to load', 'error');
                }
            }).catch(err => {
                console.error('Error loading marks:', err);
                showJuryMessage('Error loading marks: ' + err.message, 'error');
            });
        }

        function calculateTotal(cls) {
            const inputs = document.querySelectorAll('.marks-input[data-class="'+cls+'"]');
            let total = 0;
            inputs.forEach(inp => {
                const val = parseFloat(inp.value) || 0;
                total += val;
            });
            const totalCell = document.getElementById('total-'+cls.replace(/\s+/g, '-'));
            if (totalCell) totalCell.textContent = total.toFixed(1);
        }

        function sanitizeKey(key) {
            // Replace characters that Firebase doesn't allow in keys
            // . $ # [ ] / and control characters
            return key.replace(/[.#$\[\]\/]/g, '_');
        }

        function saveMarks() {
            console.log('=== SAVE MARKS STARTED ===');
            console.log('juryEvent:', juryEvent);
            console.log('juryNumber:', juryNumber);
            console.log('Database connected:', isConnected);
            
            if (!juryEvent || !juryNumber) {
                alert('Error: Jury session not initialized. Please log in again.');
                return;
            }
            
            if (!isConnected) {
                alert('Error: Not connected to Firebase database. Please check your internet connection.');
                return;
            }
            
            const marksData = {};
            let inputCount = 0;
            
            // First, organize marks by class
            document.querySelectorAll('.marks-input').forEach(inp => {
                inputCount++;
                const cls = inp.dataset.class;
                const sanitizedCls = sanitizeKey(cls); // Sanitize class name for Firebase
                const critIndex = parseInt(inp.dataset.criterion);
                const val = parseFloat(inp.value) || 0;
                
                if (!marksData[sanitizedCls]) {
                    marksData[sanitizedCls] = { 
                        marks: {}, 
                        completed: false,
                        originalClassName: cls // Store original name
                    };
                }
                marksData[sanitizedCls].marks[critIndex] = val;
            });
            
            // Convert marks object to array to ensure proper structure
            Object.keys(marksData).forEach(cls => {
                const marksObj = marksData[cls].marks;
                const marksArray = [];
                const maxIndex = Math.max(...Object.keys(marksObj).map(k => parseInt(k)));
                
                // Fill array with all marks
                for (let i = 0; i <= maxIndex; i++) {
                    marksArray[i] = marksObj[i] !== undefined ? marksObj[i] : 0;
                }
                
                marksData[cls].marks = marksArray;
            });
            
            console.log('Marks inputs found:', inputCount);
            console.log('Marks data to save:', JSON.stringify(marksData, null, 2));
            
            if (inputCount === 0) {
                alert('No marks data found. Please refresh the page and try again.');
                return;
            }
            
            // Show saving indicator
            showJuryMessage('Saving marks...', 'success');
            
            // Use raw event name (do not encode)
            const dbPath = 'juryMarks/' + juryEvent + '/jury' + juryNumber;
            console.log('Event name:', juryEvent);
            console.log('Saving to Firebase path:', dbPath);
            console.log('Full database URL:', db.ref(dbPath).toString());
            
            // CRITICAL FIX: First check if there's test data and clear it
            db.ref(dbPath).once('value').then(snap => {
                const existingData = snap.val();
                
                // Check if test data exists
                if (existingData && existingData.test !== undefined) {
                    console.warn('‚ö†Ô∏è Test data detected! Clearing before save...');
                    showJuryMessage('Clearing test data...', 'success');
                    // First delete the entire node to clear test data
                    return db.ref(dbPath).remove();
                }
                
                return Promise.resolve();
            }).then(() => {
                console.log('Now saving actual marks data...');
                // Now save the actual marks data
                return db.ref(dbPath).set(marksData);
            }).then(() => {
                console.log('‚úì Firebase .set() resolved successfully');
                
                // Immediately verify the save
                return db.ref(dbPath).once('value');
            }).then(snap => {
                const savedData = snap.val();
                console.log('‚úì Verification read successful');
                console.log('Data in database:', JSON.stringify(savedData, null, 2));
                
                if (savedData && savedData.test === undefined) {
                    // Check that we have actual class data, not test data
                    const hasRealData = Object.keys(savedData).some(key => 
                        savedData[key] && savedData[key].marks && Array.isArray(savedData[key].marks)
                    );
                    
                    if (hasRealData) {
                        showJuryMessage('Marks saved successfully!', 'success');
                        alert('‚úÖ SUCCESS!\n\nMarks saved and verified in database.\n\n' + 
                              'Classes saved: ' + Object.keys(savedData).length + '\n\n' +
                              'Path: juryMarks/' + juryEvent + '/jury' + juryNumber);
                    } else {
                        console.error('‚úó VERIFICATION FAILED: Data saved but structure is wrong');
                        showJuryMessage('Warning: Data saved but structure may be incorrect', 'error');
                    }
                } else if (savedData && savedData.test !== undefined) {
                    console.error('‚úó TEST DATA STILL EXISTS after save attempt');
                    showJuryMessage('Error: Test data blocking saves. Please clear manually.', 'error');
                    alert('‚ö†Ô∏è TEST DATA PROBLEM!\n\nTest data is still in the database.\n\n' +
                          'Please manually delete from Firebase Console:\n' +
                          'juryMarks > Solo Dance > jury1 > test');
                } else {
                    console.error('‚úó VERIFICATION FAILED: Data is null after save');
                    showJuryMessage('Warning: Save completed but verification failed', 'error');
                    alert('‚ö†Ô∏è WARNING!\n\nSave appeared successful but data could not be verified.\n\n' +
                          'Possible issue: Firebase security rules may be blocking reads.\n\n' +
                          'Please check Firebase Console > Realtime Database > Rules');
                }
            }).catch(err => {
                console.error('‚úó FIREBASE ERROR:', err);
                console.error('Error code:', err.code);
                console.error('Error message:', err.message);
                
                let errorMsg = '‚ùå SAVE FAILED!\n\n';
                
                if (err.code === 'PERMISSION_DENIED' || err.message.includes('permission')) {
                    errorMsg += 'ERROR: Permission Denied\n\n';
                    errorMsg += 'Firebase security rules are blocking the save.\n\n';
                    errorMsg += 'SOLUTION:\n';
                    errorMsg += '1. Go to Firebase Console\n';
                    errorMsg += '2. Realtime Database > Rules\n';
                    errorMsg += '3. Set rules to allow writes\n\n';
                    errorMsg += 'See browser console for details.';
                    
                    console.log('%c FIREBASE RULES FIX NEEDED ', 'background: red; color: white; font-size: 16px; font-weight: bold;');
                    console.log('Your current Firebase rules are blocking writes to: ' + dbPath);
                    console.log('\nTo fix this, update your Firebase Realtime Database Rules to:');
                    console.log('{\n  "rules": {\n    ".read": true,\n    ".write": true\n  }\n}');
                    console.log('\nOR for better security:');
                    console.log('{\n  "rules": {\n    "juryMarks": {\n      ".read": true,\n      ".write": true\n    },\n    "jurySetup": {\n      ".read": true,\n      ".write": true\n    },\n    "youthfest-enrollments": {\n      ".read": true,\n      ".write": true\n    }\n  }\n}');
                } else {
                    errorMsg += 'Error: ' + err.message + '\n\n';
                        errorMsg += 'Code: ' + err.code + '\n\n';
                        errorMsg += 'Check browser console for details.';
                    }
                    
                    showJuryMessage('Error: ' + err.message, 'error');
                    alert(errorMsg);
                });
        }

        function markAsCompleted() {
            if (!confirm('Mark evaluation as completed? You can still edit marks later.')) return;
            
            const marksData = {};
            
            // First, organize marks by class
            document.querySelectorAll('.marks-input').forEach(inp => {
                const cls = inp.dataset.class;
                const sanitizedCls = sanitizeKey(cls); // Sanitize class name
                const critIndex = parseInt(inp.dataset.criterion);
                const val = parseFloat(inp.value) || 0;
                
                if (!marksData[sanitizedCls]) {
                    marksData[sanitizedCls] = { 
                        marks: {}, 
                        completed: true,
                        originalClassName: cls
                    };
                }
                marksData[sanitizedCls].marks[critIndex] = val;
            });
            
            // Convert marks object to array to ensure proper structure
            Object.keys(marksData).forEach(cls => {
                const marksObj = marksData[cls].marks;
                const marksArray = [];
                const maxIndex = Math.max(...Object.keys(marksObj).map(k => parseInt(k)));
                
                // Fill array with all marks
                for (let i = 0; i <= maxIndex; i++) {
                    marksArray[i] = marksObj[i] !== undefined ? marksObj[i] : 0;
                }
                
                marksData[cls].marks = marksArray;
            });
            
            const dbPath = 'juryMarks/' + juryEvent + '/jury' + juryNumber;
            
            db.ref(dbPath).set(marksData).then(() => {
                showJuryMessage('Evaluation marked as completed!', 'success');
                alert('‚úÖ Evaluation marked as completed!\n\nYour marks are now final.');
            }).catch(err => {
                showJuryMessage('Error: '+err.message, 'error');
                alert('‚ùå Error: '+err.message);
            });
        }

        function showJuryMessage(msg, type) {
            const d = document.getElementById('juryMessage');
            d.className = 'message '+type+' show';
            d.textContent = (type === 'success' ? '‚úì ' : '‚úó ') + msg;
            setTimeout(() => d.classList.remove('show'), 5000);
            scroll(0,0);
        }

        // Results Functions
        function loadResultsTab() {
            // Populate event select for results
            const sel = document.getElementById('resultsEventSelect');
            sel.innerHTML = '<option value="">-- Select Event --</option>';
            
            db.ref('jurySetup').once('value').then(snap => {
                if (!snap.exists()) return;
                
                snap.forEach(child => {
                    const event = child.key;
                    const setup = child.val();
                    
                    // For super admin, show all events
                    // For admin, show only published events
                    if (isSuperAdmin || setup.resultsPublished) {
                        const opt = document.createElement('option');
                        opt.value = event;
                        opt.textContent = event + (setup.resultsPublished ? ' ‚úì' : '');
                        sel.appendChild(opt);
                    }
                });
            });
        }

        function loadEventResults() {
            const event = document.getElementById('resultsEventSelect').value;
            console.log('Loading results for event:', event);
            
            if (!event) {
                document.getElementById('resultsContainer').innerHTML = '';
                return;
            }
            
            // Load jury setup to get names and publication status
            db.ref('jurySetup/'+event).once('value').then(setupSnap => {
                const setup = setupSnap.val() || {};
                console.log('Results published status:', setup.resultsPublished);
                
                if (!isSuperAdmin && !setup.resultsPublished) {
                    document.getElementById('resultsContainer').innerHTML = '<p style="text-align:center;padding:40px;color:#999">Results not yet published by super admin.</p>';
                    return;
                }
                
                const jury1Name = setup.jury1Name || 'Jury 1';
                const jury2Name = setup.jury2Name || 'Jury 2';
                
                // Load marks from both juries using raw event name
                console.log('Loading marks from both juries...');
                Promise.all([
                    db.ref('juryMarks/'+event+'/jury1').once('value'),
                    db.ref('juryMarks/'+event+'/jury2').once('value')
                ]).then(([jury1Snap, jury2Snap]) => {
                    const jury1Marks = jury1Snap.val() || {};
                    const jury2Marks = jury2Snap.val() || {};
                    
                    console.log('Jury 1 Marks:', jury1Marks);
                    console.log('Jury 2 Marks:', jury2Marks);
                    
                    displayResults(event, jury1Marks, jury2Marks, jury1Name, jury2Name);
                });
            });
        }

        function displayResults(event, jury1Marks, jury2Marks, jury1Name, jury2Name) {
            // Default names if not provided
            jury1Name = jury1Name || 'Jury 1';
            jury2Name = jury2Name || 'Jury 2';
            
            console.log('=== DISPLAY RESULTS DEBUG ===');
            console.log('Jury 1 Marks:', jury1Marks);
            console.log('Jury 2 Marks:', jury2Marks);
            
            const allClasses = new Set([...Object.keys(jury1Marks), ...Object.keys(jury2Marks)]);
            
            if (allClasses.size === 0) {
                document.getElementById('resultsContainer').innerHTML = '<p style="text-align:center;padding:40px;color:#999">No marks submitted yet.</p>';
                return;
            }
            
            // Calculate totals and averages
            const results = [];
            allClasses.forEach(sanitizedCls => {
                const j1 = jury1Marks[sanitizedCls];
                const j2 = jury2Marks[sanitizedCls];
                
                console.log('Class:', sanitizedCls);
                console.log('  Jury1 data:', j1);
                console.log('  Jury1 completed?:', j1 && j1.completed);
                console.log('  Jury2 data:', j2);
                console.log('  Jury2 completed?:', j2 && j2.completed);
                
                // Get original class name if available
                const displayCls = (j1 && j1.originalClassName) || 
                                  (j2 && j2.originalClassName) || 
                                  sanitizedCls;
                
                let j1Total = 0;
                let j2Total = 0;
                
                if (j1 && j1.marks) {
                    j1Total = j1.marks.reduce((sum, m) => sum + (m || 0), 0);
                }
                if (j2 && j2.marks) {
                    j2Total = j2.marks.reduce((sum, m) => sum + (m || 0), 0);
                }
                
                const avgTotal = (j1Total + j2Total) / 2;
                
                results.push({
                    class: displayCls,  // Use original name for display
                    jury1Total: j1Total,
                    jury2Total: j2Total,
                    average: avgTotal,
                    jury1Completed: j1 && j1.completed,
                    jury2Completed: j2 && j2.completed
                });
            });
            
            // Sort by average (descending)
            results.sort((a, b) => b.average - a.average);
            
            // Display results
            let html = '<h3 style="color:#c44569;margin-bottom:20px">Results for '+event+'</h3>';
            
            // Show marks detail only for super admin and jury
            if (isSuperAdmin || isJury) {
                html += '<div class="table-wrapper"><table><thead><tr><th>Rank</th><th>Class</th><th>'+jury1Name+' Total</th><th>'+jury2Name+' Total</th><th>Average</th><th>Status</th></tr></thead><tbody>';
                
                results.forEach((r, i) => {
                    const rank = i + 1;
                    const badge = rank === 1 ? '<span class="winner-badge">üèÜ Winner</span>' : 
                                 rank === 2 ? '<span class="runner-badge">ü•à Runner Up</span>' : '';
                    
                    html += '<tr class="rank-'+(rank <= 3 ? rank : '')+'">';
                    html += '<td><strong>'+rank+'</strong></td>';
                    html += '<td><strong>'+r.class+'</strong> '+badge+'</td>';
                    html += '<td>'+r.jury1Total.toFixed(1)+(r.jury1Completed ? ' ‚úì' : '')+'</td>';
                    html += '<td>'+r.jury2Total.toFixed(1)+(r.jury2Completed ? ' ‚úì' : '')+'</td>';
                    html += '<td><strong>'+r.average.toFixed(1)+'</strong></td>';
                    html += '<td>'+(r.jury1Completed && r.jury2Completed ? '‚úÖ Complete' : '‚è≥ In Progress')+'</td>';
                    html += '</tr>';
                });
                
                html += '</tbody></table></div>';
            } else {
                // For regular admins, show only final results (no marks)
                results.forEach((r, i) => {
                    const rank = i + 1;
                    html += '<div class="results-card rank-'+rank+'">';
                    html += '<h3 style="color:#c44569;">Rank '+rank+': '+r.class;
                    if (rank === 1) html += ' <span class="winner-badge">üèÜ Winner</span>';
                    if (rank === 2) html += ' <span class="runner-badge">ü•à Runner Up</span>';
                    html += '</h3>';
                    html += '<p style="color:#666;margin-top:10px">Final Score: <strong>'+r.average.toFixed(1)+'</strong></p>';
                    html += '</div>';
                });
            }
            
            document.getElementById('resultsContainer').innerHTML = html;
        }

        function clearTestData() {
            if (!confirm('Clear test data from Firebase?\n\nThis will ONLY delete:\n- juryMarks/TEST/*\n\nYour actual marks will NOT be affected.')) {
                return;
            }
            
            console.log('=== CLEARING TEST DATA ===');
            
            // Only clear the TEST node - DO NOT touch the actual jury path
            db.ref('juryMarks/TEST').remove()
            .then(() => {
                console.log('‚úì Test data cleared');
                showJuryMessage('Test data cleared successfully! Your actual marks are safe.', 'success');
                alert('‚úÖ Test data cleared!\n\nYour actual marks are safe and untouched.');
            }).catch(err => {
                console.error('Error clearing test data:', err);
                showJuryMessage('Error clearing test data: ' + err.message, 'error');
            });
        }

        function debugLoadMarks() {
            console.log('=== DEBUG LOAD MARKS ===');
            console.log('juryEvent:', juryEvent);
            console.log('juryNumber:', juryNumber);
            
            const dbPath = 'juryMarks/' + juryEvent + '/jury' + juryNumber;
            console.log('Database path:', dbPath);
            
            // First check what's in the database
            db.ref(dbPath).once('value').then(snap => {
                const data = snap.val();
                console.log('Raw database data:', data);
                console.log('Data as JSON:', JSON.stringify(data, null, 2));
                
                // Check all inputs on the page
                const inputs = document.querySelectorAll('.marks-input');
                console.log('Total inputs on page:', inputs.length);
                
                const inputDetails = [];
                inputs.forEach((inp, idx) => {
                    inputDetails.push({
                        index: idx,
                        class: inp.dataset.class,
                        criterion: inp.dataset.criterion,
                        value: inp.value
                    });
                });
                console.table(inputDetails);
                
                // Show a detailed report
                let report = '=== DEBUG REPORT ===\n\n';
                report += 'Database Path: ' + dbPath + '\n\n';
                report += 'Database Content:\n' + JSON.stringify(data, null, 2) + '\n\n';
                report += 'Total Inputs Found: ' + inputs.length + '\n\n';
                report += 'Input Details:\n';
                inputDetails.forEach(inp => {
                    report += `  [${inp.index}] Class: "${inp.class}", Criterion: ${inp.criterion}, Value: ${inp.value}\n`;
                });
                
                console.log(report);
                alert(report);
                
            }).catch(err => {
                console.error('Debug load error:', err);
                alert('Debug load failed: ' + err.message);
            });
        }

        function showEnrollmentDebug() {
            console.log('=== ENROLLMENT DEBUG ===');
            console.log('Current juryEvent:', juryEvent);
            console.log('All array length:', all.length);
            console.log('All enrollments:', all);
            
            // Filter for current event
            const eventEnrollments = all.filter(e => e.event === juryEvent);
            console.log('Enrollments for', juryEvent, ':', eventEnrollments);
            
            // Get unique classes
            const classes = [...new Set(eventEnrollments.map(e => e.classYear))];
            console.log('Unique classes:', classes);
            
            // Build report
            let report = '=== ENROLLMENT DEBUG REPORT ===\n\n';
            report += 'Event: ' + juryEvent + '\n';
            report += 'Total enrollments in database: ' + all.length + '\n';
            report += 'Enrollments for this event: ' + eventEnrollments.length + '\n';
            report += 'Unique classes: ' + classes.join(', ') + '\n\n';
            
            report += 'Detailed Enrollments:\n';
            eventEnrollments.forEach((e, i) => {
                report += `${i+1}. Class: ${e.classYear}, Name: ${e.name}, Phone: ${e.phone}\n`;
            });
            
            if (eventEnrollments.length === 0) {
                report += '\n‚ö†Ô∏è NO ENROLLMENTS FOUND!\n';
                report += 'This means either:\n';
                report += '1. No one has enrolled for this event yet\n';
                report += '2. The enrollments are not being loaded from Firebase\n';
                report += '3. The event name doesn\'t match\n';
            }
            
            console.log(report);
            alert(report);
        }

        function testFirebaseWrite() {
            console.log('=== TESTING FIREBASE WRITE ===');
            console.log('Testing write to: juryMarks/TEST/test');
            
            const testData = {
                timestamp: new Date().toISOString(),
                message: 'This is a test write',
                juryEvent: juryEvent,
                juryNumber: juryNumber
            };
            
            console.log('Test data:', testData);
            
            // Test 1: Try writing to test path
            db.ref('juryMarks/TEST/test').set(testData)
                .then(() => {
                    console.log('‚úì TEST WRITE SUCCESSFUL');
                    
                    // Verify by reading back
                    return db.ref('juryMarks/TEST/test').once('value');
                })
                .then(snap => {
                    const readData = snap.val();
                    console.log('‚úì TEST READ SUCCESSFUL');
                    console.log('Data read back:', readData);
                    
                    if (readData) {
                        alert('‚úÖ FIREBASE TEST PASSED!\n\n' +
                              'Firebase is working correctly.\n' +
                              'Write: SUCCESS\n' +
                              'Read: SUCCESS\n\n' +
                              'Check Firebase Console - you should see:\n' +
                              'juryMarks > TEST > test\n\n' +
                              'The issue must be in the saveMarks function.');
                              
                        // Now test the actual save path
                        console.log('Now testing actual save path...');
                        const actualPath = 'juryMarks/' + juryEvent + '/jury' + juryNumber;
                        console.log('Actual path:', actualPath);
                        
                        return db.ref(actualPath).set({test: 'actual path test'});
                    } else {
                        throw new Error('Read returned null');
                    }
                })
                .then(() => {
                    console.log('‚úì ACTUAL PATH WRITE SUCCESSFUL');
                    alert('‚úÖ Both tests passed! Check the console and Firebase database.');
                })
                .catch(err => {
                    console.error('‚úó TEST FAILED:', err);
                    console.error('Error code:', err.code);
                    console.error('Error message:', err.message);
                    
                    alert('‚ùå FIREBASE TEST FAILED!\n\n' +
                          'Error: ' + err.message + '\n' +
                          'Code: ' + err.code + '\n\n' +
                          'This means Firebase rules may still be blocking writes.\n' +
                          'Check browser console for details.');
                });
        }

        // Edit and Delete Functions
        let editingKey = null;
        let editingData = null;

        // Wrapper functions to handle calls from data attributes
        function editEnrollmentByKey(key) {
            editEnrollment(key);
        }

        function deleteEnrollmentByKey(key, name, event) {
            deleteEnrollment(key, name, event);
        }

        function editEnrollment(key) {
            console.log('Editing enrollment:', key);
            console.log('All enrollments:', all);
            console.log('Looking for key:', key);
            
            editingKey = key;
            
            // Find the enrollment data - search by id field
            const enrollment = all.find(e => e.id === key);
            
            if (!enrollment) {
                console.error('Enrollment not found!');
                console.log('Available IDs:', all.map(e => e.id));
                alert('Error: Enrollment not found. Please refresh the page and try again.');
                return;
            }
            
            editingData = enrollment;
            console.log('Enrollment data:', enrollment);
            
            // Build edit form based on event type
            const eventConfig = events[enrollment.event];
            const isTeamEvent = eventConfig && eventConfig.count > 1;
            
            let formHtml = '<div class="form-group">';
            formHtml += '<label>Name:</label>';
            formHtml += '<input type="text" id="editName" value="' + enrollment.name + '" required>';
            formHtml += '</div>';
            
            formHtml += '<div class="form-group">';
            formHtml += '<label>Phone:</label>';
            formHtml += '<input type="tel" id="editPhone" value="' + enrollment.phone + '" required>';
            formHtml += '</div>';
            
            formHtml += '<div class="form-group">';
            formHtml += '<label>Class Year:</label>';
            formHtml += '<input type="text" id="editClass" value="' + enrollment.classYear + '" readonly>';
            formHtml += '</div>';
            
            formHtml += '<div class="form-group">';
            formHtml += '<label>Event:</label>';
            formHtml += '<input type="text" value="' + enrollment.event + '" readonly>';
            formHtml += '</div>';
            
            formHtml += '<div class="form-group">';
            formHtml += '<label>Role:</label>';
            formHtml += '<input type="text" value="' + enrollment.role + '" readonly>';
            formHtml += '</div>';
            
            // Add team members if it's a team event
            if (isTeamEvent && enrollment.teamMembers) {
                for (let i = 0; i < enrollment.teamMembers.length; i++) {
                    const member = enrollment.teamMembers[i];
                    formHtml += '<div class="team-member-box">';
                    formHtml += '<div class="member-header">Team Member ' + (i + 1) + '</div>';
                    formHtml += '<div class="form-group">';
                    formHtml += '<label>Name:</label>';
                    formHtml += '<input type="text" id="editTeamName' + i + '" value="' + member.name + '" required>';
                    formHtml += '</div>';
                    formHtml += '<div class="form-group">';
                    formHtml += '<label>Phone:</label>';
                    formHtml += '<input type="tel" id="editTeamPhone' + i + '" value="' + member.phone + '" required>';
                    formHtml += '</div>';
                    formHtml += '</div>';
                }
            }
            
            document.getElementById('editFormContainer').innerHTML = formHtml;
            document.getElementById('editModal').style.display = 'block';
        }

        function closeEditModal() {
            document.getElementById('editModal').style.display = 'none';
            editingKey = null;
            editingData = null;
        }

        function saveEdit() {
            if (!editingKey || !editingData) {
                alert('Error: No enrollment selected');
                return;
            }
            
            // Get updated values
            const updatedName = document.getElementById('editName').value.trim();
            const updatedPhone = document.getElementById('editPhone').value.trim();
            
            if (!updatedName || !updatedPhone) {
                alert('Please fill in all required fields');
                return;
            }
            
            // Validate phone
            if (!/^\d{10}$/.test(updatedPhone)) {
                alert('Please enter a valid 10-digit phone number');
                return;
            }
            
            // Build updated enrollment object
            const updatedEnrollment = {
                ...editingData,
                name: updatedName,
                phone: updatedPhone
            };
            
            // Update team members if applicable
            const eventConfig = events[editingData.event];
            if (eventConfig && eventConfig.count > 1 && editingData.teamMembers) {
                updatedEnrollment.teamMembers = [];
                for (let i = 0; i < editingData.teamMembers.length; i++) {
                    const memberName = document.getElementById('editTeamName' + i).value.trim();
                    const memberPhone = document.getElementById('editTeamPhone' + i).value.trim();
                    
                    if (!memberName || !memberPhone) {
                        alert('Please fill in all team member details');
                        return;
                    }
                    
                    if (!/^\d{10}$/.test(memberPhone)) {
                        alert('Please enter valid 10-digit phone numbers for all team members');
                        return;
                    }
                    
                    updatedEnrollment.teamMembers.push({
                        name: memberName,
                        phone: memberPhone
                    });
                }
            }
            
            // Save to Firebase
            ref.child(editingKey).set(updatedEnrollment)
                .then(() => {
                    showOk('Enrollment updated successfully!');
                    closeEditModal();
                    loadData(); // Reload data
                    
                    // Refresh the appropriate view
                    if (studentClass) {
                        viewStudentClassEnrollments();
                    }
                    if (isCR) {
                        updateCRView();
                    }
                })
                .catch(err => {
                    console.error('Error updating enrollment:', err);
                    showErr('Failed to update enrollment: ' + err.message);
                });
        }

        function deleteEnrollment(key, name, event) {
            // Find the enrollment data - search by id field
            const enrollment = all.find(e => e.id === key);
            if (!enrollment) {
                alert('Error: Enrollment not found');
                return;
            }
            
            if (!confirm('Are you sure you want to delete the enrollment for ' + name + ' in ' + event + '?')) {
                return;
            }
            
            ref.child(key).remove()
                .then(() => {
                    showOk('Enrollment deleted successfully!');
                    loadData(); // Reload data
                    
                    // Refresh the appropriate view
                    if (studentClass) {
                        viewStudentClassEnrollments();
                    }
                    if (isCR) {
                        updateCRView();
                    }
                })
                .catch(err => {
                    console.error('Error deleting enrollment:', err);
                    showErr('Failed to delete enrollment: ' + err.message);
                });
        }

        function showOk(msg) {
            const d = document.getElementById('enrollMessage');
            d.className = 'message success show';
            d.textContent = '‚úì '+msg;
            setTimeout(() => d.classList.remove('show'), 5000);
            scroll(0,0);
        }

        function showErr(msg) {
            const d = document.getElementById('enrollMessage');
            d.className = 'message error show';
            d.textContent = '‚úó '+msg;
            setTimeout(() => d.classList.remove('show'), 5000);
            scroll(0,0);
        }

        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) event.target.style.display = 'none';
        }
        
        // ==================== QUIZ COMPETITION FUNCTIONS ====================
        
        // Quiz Utility Functions
        function getQuizToday() {
            // Get local date in YYYY-MM-DD format (not UTC)
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }
        
        // Check public quiz status (before login)
        async function checkPublicQuizStatus() {
            const today = getQuizToday();
            const messageDiv = document.getElementById('publicQuizMessage');
            
            console.log('=== checkPublicQuizStatus START ===');
            console.log('Today:', today);
            
            try {
                const qRef = db.ref(`quizQuestions/${today}`);
                const qSnap = await qRef.once('value');
                
                console.log('Questions exist for public view?', qSnap.exists());
                
                if (!qSnap.exists()) {
                    messageDiv.innerHTML = '<p style="margin:0;color:#856404">‚è≥ <strong>No quiz available today.</strong></p>';
                    return;
                }
                
                // Check if published (for showing answers)
                const pSnap = await db.ref(`quizPublished/${today}`).once('value');
                const publishData = pSnap.val();
                const isPublished = publishData && publishData.published === true;
                
                console.log('Is quiz published for public Q&A view?', isPublished);
                
                if (!isPublished) {
                    // Quiz exists but not published - students can login and take it
                    messageDiv.innerHTML = '<div class="quiz-available-banner"><div class="trophy-icon">üèÜ</div><h3>‚úÖ Today\'s Quiz is Available!</h3><p style="margin:0;color:#155724;font-size:1.15em">Login below to participate and win exciting prizes!</p><p style="margin-top:10px;color:#28a745;font-weight:600">‚ö° Be the fastest to answer correctly!</p></div>';
                    return;
                }
                
                // Quiz is published - show questions with correct answers for review
                const questions = qSnap.val();
                const publishedDate = new Date(publishData.publishedAt).toLocaleDateString('en-IN', {
                    weekday: 'long',
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
                const publishedTime = new Date(publishData.publishedAt).toLocaleTimeString('en-IN', {
                    hour: '2-digit',
                    minute: '2-digit'
                });
                
                let html = '<div style="background:#e8f5e9;padding:20px;border-radius:10px;border:3px solid #4CAF50">';
                html += '<h4 style="color:#2e7d32;margin-top:0">üìÖ Today\'s Quiz - Questions & Answers</h4>';
                html += '<p style="color:#2e7d32;margin-bottom:15px;font-size:0.9em">Published: ' + publishedDate + ' at ' + publishedTime + '</p>';
                
                // Question 1
                html += '<div style="background:white;padding:20px;border-radius:8px;margin-bottom:15px;border-left:5px solid #667eea">';
                html += '<p style="margin:0 0 10px 0;color:#667eea;font-weight:bold;font-size:1.1em">Question 1:</p>';
                html += '<p style="margin:0 0 15px 0;color:#333;font-size:1.05em">' + questions.q1.text + '</p>';
                html += '<div style="background:#4CAF50;color:white;padding:12px;border-radius:6px;font-weight:bold">';
                html += '‚úÖ Correct Answer: ' + questions.q1.options[questions.q1.correct];
                html += '</div>';
                html += '</div>';
                
                // Question 2
                html += '<div style="background:white;padding:20px;border-radius:8px;border-left:5px solid #667eea">';
                html += '<p style="margin:0 0 10px 0;color:#667eea;font-weight:bold;font-size:1.1em">Question 2:</p>';
                html += '<p style="margin:0 0 15px 0;color:#333;font-size:1.05em">' + questions.q2.text + '</p>';
                html += '<div style="background:#4CAF50;color:white;padding:12px;border-radius:6px;font-weight:bold">';
                html += '‚úÖ Correct Answer: ' + questions.q2.options[questions.q2.correct];
                html += '</div>';
                html += '</div>';
                
                html += '<p style="color:#2e7d32;margin:15px 0 0 0;font-size:0.9em;text-align:center"><em>Review the questions and answers from today\'s quiz</em></p>';
                html += '</div>';
                
                messageDiv.innerHTML = html;
                
                console.log('=== checkPublicQuizStatus END ===');
            } catch (err) {
                console.error('Public quiz status check error:', err);
                messageDiv.innerHTML = '<p style="margin:0;color:#721c24">‚ùå Error loading quiz status</p>';
            }
        }
        
        function generateQuizPassword() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789@#$';
            let pwd = '';
            for (let i = 0; i < 10; i++) {
                pwd += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return pwd;
        }
        
        function showQuizMsg(id, msg, type) {
            const el = document.getElementById(id);
            if (!el) return;
            el.className = `message ${type} show`;
            el.textContent = msg;
            setTimeout(() => el.classList.remove('show'), 5000);
        }
        
        function populateQuizClasses() {
            const sel = document.getElementById('quizClass');
            if (!sel) return;
            sel.innerHTML = '<option value="">-- Select Class --</option>';
            classes.forEach(c => {
                const opt = document.createElement('option');
                opt.value = c;
                opt.textContent = c;
                sel.appendChild(opt);
            });
        }
        
        function showQuizTab(tab) {
            if (tab === 'student') {
                document.getElementById('quizStudentSection').style.display = 'block';
                document.getElementById('quizAdminSection').style.display = 'none';
                document.getElementById('quizStudentTab').classList.add('active');
                document.getElementById('quizAdminTab').classList.remove('active');
                document.getElementById('quizStudentTab').style.background = 'linear-gradient(135deg,#c44569 0%,#6a1b9a 100%)';
                document.getElementById('quizStudentTab').style.color = 'white';
                document.getElementById('quizAdminTab').style.background = 'white';
                document.getElementById('quizAdminTab').style.color = '#333';
            } else {
                document.getElementById('quizAdminSection').style.display = 'block';
                document.getElementById('quizStudentSection').style.display = 'none';
                document.getElementById('quizAdminTab').classList.add('active');
                document.getElementById('quizStudentTab').classList.remove('active');
                document.getElementById('quizAdminTab').style.background = 'linear-gradient(135deg,#c44569 0%,#6a1b9a 100%)';
                document.getElementById('quizAdminTab').style.color = 'white';
                document.getElementById('quizStudentTab').style.background = 'white';
                document.getElementById('quizStudentTab').style.color = '#333';
            }
        }
        
        // Send Email Function - Using EmailJS + Firebase Log
        async function sendQuizEmail(to, subject, body) {
            const debugId = Date.now();
            try {
                console.log('========================================');
                console.log(`üìß EMAIL DEBUG #${debugId} START`);
                console.log('========================================');
                console.log(`Timestamp: ${new Date().toISOString()}`);
                console.log(`Recipient: ${to}`);
                console.log(`Subject: ${subject}`);
                console.log('Body preview:', body.substring(0, 150) + '...');
                
                let emailSent = false;
                let emailError = null;
                let emailJSResponse = null;
                
                // Step 1: Check EmailJS library
                console.log('\n--- STEP 1: Checking EmailJS library ---');
                if (typeof emailjs === 'undefined') {
                    console.error('‚ùå EmailJS library NOT LOADED!');
                    console.error('Check if script tag is present');
                    emailError = 'EmailJS library not loaded';
                } else {
                    console.log('‚úÖ EmailJS library is available');
                }
                
                // Step 2: Send email
                if (typeof emailjs !== 'undefined') {
                    console.log('\n--- STEP 2: Checking EmailJS initialization ---');
                    console.log('Public Key: iISS6N2b69VmKwx8Y');
                    
                    console.log('\n--- STEP 3: Preparing template parameters ---');
                    const templateParams = {
                        to_email: to,
                        subject: subject,
                        message: body,
                        reply_to: 'davancollege02@gmail.com'
                    };
                    
                    console.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');
                    console.log('üìß EMAIL PARAMETERS BEING SENT:');
                    console.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');
                    console.log('Template Parameters:', templateParams);
                    console.log('');
                    console.log('üéØ RECIPIENT (to_email):', templateParams.to_email);
                    console.log('üì¨ REPLY TO (reply_to):', templateParams.reply_to);
                    console.log('üìù Subject:', templateParams.subject);
                    console.log('üìÑ Message preview:', templateParams.message.substring(0, 100) + '...');
                    console.log('');
                    console.log('‚öôÔ∏è Service ID: service_zhy3bnp');
                    console.log('üìã Template ID: template_o2i00b5');
                    console.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');
                    console.log('');
                    console.log('‚ö†Ô∏è IMPORTANT: Check your EmailJS template!');
                    console.log('   The template should use: {{to_email}} for recipient');
                    console.log('   NOT: {{reply_to}} (that\'s for reply address)');
                    console.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');
                    
                    try {
                        console.log('\n--- STEP 4: Sending email via EmailJS ---');
                        console.log('‚è≥ Please wait...');
                        
                        const startTime = Date.now();
                        emailJSResponse = await emailjs.send(
                            'service_zhy3bnp',
                            'template_o2i00b5',
                            templateParams
                        );
                        const endTime = Date.now();
                        
                        emailSent = true;
                        console.log(`\n‚úÖ‚úÖ‚úÖ EMAIL SENT SUCCESSFULLY! (${endTime - startTime}ms) ‚úÖ‚úÖ‚úÖ`);
                        console.log('EmailJS Response:', emailJSResponse);
                        console.log(`‚úÖ Email delivered to: ${to}`);
                        console.log('‚úÖ Check inbox in 1-2 minutes (or spam folder)');
                        
                    } catch (emailErr) {
                        emailSent = false;
                        emailError = emailErr.message || emailErr.toString();
                        
                        console.error('\n‚ùå‚ùå‚ùå EMAIL SEND FAILED! ‚ùå‚ùå‚ùå');
                        console.error('Error Type:', emailErr.name);
                        console.error('Error Message:', emailErr.message);
                        console.error('Full Error:', emailErr);
                        
                        // Specific error analysis
                        if (emailErr.message && emailErr.message.includes('User ID')) {
                            console.error('\nüîë ISSUE: Invalid Public Key');
                            console.error('Current Key: iISS6N2b69VmKwx8Y');
                            console.error('‚Üí Verify this key in EmailJS Dashboard > Account > API Keys');
                        } else if (emailErr.message && emailErr.message.includes('Service ID')) {
                            console.error('\n‚öôÔ∏è ISSUE: Invalid Service ID');
                            console.error('Current Service ID: service_zhy3bnp');
                            console.error('‚Üí Verify in EmailJS Dashboard > Email Services');
                        } else if (emailErr.message && emailErr.message.includes('Template')) {
                            console.error('\nüìù ISSUE: Invalid Template ID');
                            console.error('Current Template ID: template_o2i00b5');
                            console.error('‚Üí Verify in EmailJS Dashboard > Email Templates');
                        } else if (emailErr.message && emailErr.message.includes('quota')) {
                            console.error('\nüìä ISSUE: Daily Quota Exceeded');
                            console.error('‚Üí Check your EmailJS dashboard for quota limits');
                            console.error('‚Üí Free plan: 200 emails/month');
                        } else if (emailErr.message && (emailErr.message.includes('network') || emailErr.message.includes('Failed to fetch'))) {
                            console.error('\nüåê ISSUE: Network Error');
                            console.error('‚Üí Check internet connection');
                            console.error('‚Üí Check if EmailJS servers are accessible');
                        } else {
                            console.error('\n‚ùì UNKNOWN ERROR');
                            console.error('‚Üí See error details above');
                        }
                    }
                }
                
                // Step 5: Log to Firebase
                console.log('\n--- STEP 5: Logging to Firebase ---');
                const emailLog = {
                    debugId: debugId,
                    to: to,
                    subject: subject,
                    body: body,
                    sentAt: new Date().toISOString(),
                    from: 'davancollege02@gmail.com',
                    status: emailSent ? 'sent' : 'failed',
                    emailjsStatus: emailSent ? 'success' : (emailError || 'unknown'),
                    emailjsResponse: emailJSResponse ? JSON.stringify(emailJSResponse) : null,
                    password: body.match(/Password: (.+)/)?.[1] || 'N/A'
                };
                
                await db.ref('quizEmailLogs').push(emailLog);
                console.log('‚úÖ Email details logged to Firebase');
                
                console.log('\n========================================');
                console.log(`üìß EMAIL DEBUG #${debugId} END`);
                console.log(`FINAL STATUS: ${emailSent ? '‚úÖ SUCCESS' : '‚ùå FAILED'}`);
                console.log('========================================');
                
                if (emailSent) {
                    console.log('\nüìß What to do now:');
                    console.log('1. Check your email inbox (may take 1-2 minutes)');
                    console.log('2. Check SPAM/JUNK folder if not in inbox');
                    console.log('3. Whitelist davancollege02@gmail.com in your email');
                } else {
                    console.log('\nüìß Troubleshooting steps:');
                    console.log('1. Review error details above');
                    console.log('2. Check Firebase > quizEmailLogs for detailed log');
                    console.log('3. Verify EmailJS credentials in dashboard');
                    console.log('4. Check EmailJS service connection status');
                }
                
                return emailSent;
            } catch (err) {
                console.error(`\n‚ùå EMAIL FUNCTION CRASHED! #${debugId}`);
                console.error('Fatal Error:', err);
                console.error('Error Message:', err.message);
                return false;
            }
        }
        
        // Register Student
        async function registerQuizStudent() {
            console.log('üîµ Registration started...');
            const cls = document.getElementById('quizClass').value;
            const email = document.getElementById('quizEmail').value.trim();
            const phone = document.getElementById('quizPhone').value.trim();
            const name = document.getElementById('quizName').value.trim();
            
            console.log('Form values:', {cls, email, phone, name});
            
            if (!cls || !email || !phone || !name) {
                showQuizMsg('quizMessage', 'Please fill all fields!', 'error');
                return;
            }
            
            if (!email.includes('@')) {
                showQuizMsg('quizMessage', 'Invalid email address!', 'error');
                return;
            }
            
            if (phone.length < 10) {
                showQuizMsg('quizMessage', 'Please enter valid 10-digit phone!', 'error');
                return;
            }
            
            console.log('‚úÖ Validation passed');
            
            try {
                console.log('Checking Firebase connection...');
                if (!db) {
                    throw new Error('Firebase database not initialized!');
                }
                
                console.log('Checking for existing email...');
                const studRef = db.ref('quizStudents');
                const emailSnap = await studRef.orderByChild('email').equalTo(email).once('value');
                
                if (emailSnap.exists()) {
                    alert('‚ùå Email Already Registered!\n\nThis email address is already registered.\n\nPlease use the login form below with your existing password.');
                    showQuizMsg('quizMessage', '‚ùå Email already registered! Please login with your existing password.', 'error');
                    return;
                }
                
                console.log('Checking for existing phone number...');
                const phoneSnap = await studRef.orderByChild('phone').equalTo(phone).once('value');
                
                if (phoneSnap.exists()) {
                    alert('‚ùå Phone Number Already Registered!\n\nThis phone number is already registered.\n\nPlease use the login form below with your existing password.');
                    showQuizMsg('quizMessage', '‚ùå Phone number already registered! Please login with your existing password.', 'error');
                    return;
                }
                
                console.log('‚úÖ Email and phone not registered, generating password...');
                const password = generateQuizPassword();
                console.log('Password generated');
                
                console.log('Saving to Firebase...');
                await studRef.push({
                    email, phone, name, class: cls, password,
                    registeredAt: new Date().toISOString(),
                    status: 'active'
                });
                console.log('‚úÖ Saved to Firebase successfully!');
                
                const emailBody = `Hello ${name},

Welcome to Daily Quiz Competition at Davan Institute!

Your Login Credentials:
Phone Number: ${phone}
Password: ${password}
Class: ${cls}

Please keep this password secure. Login and participate in daily quizzes!

Good luck!
Davan Institute Team`;
                
                console.log('Attempting to send email...');
                // Try to send email but don't let it block registration
                try {
                    await sendQuizEmail(email, 'Daily Quiz - Your Password', emailBody);
                    console.log('‚úÖ Email sent successfully');
                } catch (emailErr) {
                    console.warn('‚ö†Ô∏è Email send failed but registration successful:', emailErr);
                }
                
                console.log('Showing success alert...');
                
                // Clear any previous messages first
                document.getElementById('quizMessage').innerHTML = '';
                
                // Also show in alert for immediate visibility with password segment
                alert(`‚úÖ Registration Successful!\n\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\nYour Login Credentials:\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\nPhone Number: ${phone}\n\nüîë PASSWORD: ${password}\n\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\nIMPORTANT:\n‚úÖ Password is shown in YELLOW BOX below\n‚úÖ Password is auto-filled in login form\n‚úÖ You can copy it from either place\n\nNote: Email sent to ${email}\n(Check inbox or spam folder in 1-2 minutes)`);
                
                // Show password in a dedicated, copyable box
                const passwordBoxHTML = `
                    <div style="background:#d4edda;border:3px solid #28a745;border-radius:12px;padding:25px;margin-bottom:20px;">
                        <h3 style="color:#155724;margin-bottom:15px;text-align:center">‚úÖ Registration Successful!</h3>
                        <div style="background:white;padding:20px;border-radius:8px;margin-bottom:15px;">
                            <p style="margin-bottom:10px"><strong>Phone Number (Login ID):</strong> ${phone}</p>
                            <p style="margin-bottom:10px"><strong>Class:</strong> ${cls}</p>
                        </div>
                        <div style="background:#fff3cd;border:2px solid #ffc107;border-radius:8px;padding:20px;text-align:center;">
                            <p style="margin-bottom:10px;font-weight:bold;color:#856404">üîë YOUR PASSWORD (Click to select and copy):</p>
                            <div onclick="this.querySelector('span').select(); document.execCommand('copy');" style="cursor:pointer;background:#ffeb3b;padding:15px 25px;border-radius:8px;border:2px dashed #ffc107;display:inline-block;">
                                <span style="font-size:2em;font-weight:bold;color:#000;user-select:all;font-family:monospace;letter-spacing:2px;">${password}</span>
                            </div>
                            <p style="margin-top:15px;font-size:0.9em;color:#856404">üëÜ Click on the password above to copy it</p>
                        </div>
                        <p style="margin-top:15px;text-align:center;color:#155724">
                            ‚úÖ Password has been auto-filled in the login form below<br>
                            ‚úÖ Email sent to: ${email} (check spam if not in inbox)
                        </p>
                    </div>
                `;
                
                document.getElementById('quizMessage').innerHTML = passwordBoxHTML;
                document.getElementById('quizMessage').style.display = 'block';
                document.getElementById('quizMessage').classList.add('show');
                
                // Scroll to the password box
                document.getElementById('quizMessage').scrollIntoView({ behavior: 'smooth', block: 'center' });
                
                console.log('Clearing form...');
                document.getElementById('quizClass').value = '';
                document.getElementById('quizEmail').value = '';
                document.getElementById('quizPhone').value = '';
                document.getElementById('quizName').value = '';
                
                // Auto-fill login form with phone number
                document.getElementById('quizLoginPhone').value = phone;
                document.getElementById('quizLoginPassword').value = password;
                
                console.log('‚úÖ Registration completed successfully!');
                console.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');
                console.log(`üìß EMAIL DEBUG INFO:`);
                console.log(`   Intended recipient: ${email}`);
                console.log(`   Check if email arrived at: ${email}`);
                console.log(`   If not, check Firebase > quizEmailLogs`);
                console.log(`   Look for "to" field to verify correct email`);
                console.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');
            } catch (err) {
                console.error('‚ùå Registration error:', err);
                console.error('Error details:', err.message, err.stack);
                
                let errorMsg = 'Registration failed. ';
                
                // Check for specific error types
                if (err.message && err.message.includes('permission')) {
                    errorMsg = 'üîí FIREBASE PERMISSION DENIED!\n\n';
                    errorMsg += 'Your Firebase Database Rules are blocking writes.\n\n';
                    errorMsg += 'FIX THIS NOW:\n';
                    errorMsg += '1. Go to Firebase Console\n';
                    errorMsg += '2. Open Realtime Database > Rules\n';
                    errorMsg += '3. Set rules to allow writes\n';
                    errorMsg += '4. Click Publish\n\n';
                    errorMsg += 'Check console for database URL.';
                    
                    alert(errorMsg);
                    console.error('üî• FIREBASE RULES ERROR - Update your rules to:');
                    console.error(JSON.stringify({rules: {".read": true, ".write": true}}, null, 2));
                } else if (err.message && err.message.includes('network')) {
                    errorMsg = 'üåê NETWORK ERROR!\n\nCheck your internet connection.';
                    alert(errorMsg);
                } else if (!db) {
                    errorMsg = '‚ö†Ô∏è FIREBASE NOT CONNECTED!\n\nDatabase initialization failed.';
                    alert(errorMsg);
                } else {
                    errorMsg = `‚ùå Registration Error:\n\n${err.message}\n\nCheck browser console for details.`;
                    alert(errorMsg);
                }
                
                showQuizMsg('quizMessage', errorMsg.replace(/\n/g, ' '), 'error');
            }
        }
        
        // Student Login
        async function loginQuizStudent() {
            const phone = document.getElementById('quizLoginPhone').value.trim();
            const password = document.getElementById('quizLoginPassword').value.trim();
            
            console.log('=== STUDENT LOGIN START ===');
            console.log('Phone:', phone);
            console.log('Password length:', password.length);
            
            if (!phone || !password) {
                showQuizMsg('quizMessage', 'Please enter phone number and password!', 'error');
                return;
            }
            
            if (phone.length !== 10) {
                showQuizMsg('quizMessage', 'Please enter valid 10-digit phone number!', 'error');
                return;
            }
            
            try {
                const studRef = db.ref('quizStudents');
                const snap = await studRef.orderByChild('phone').equalTo(phone).once('value');
                
                console.log('Student lookup result:', snap.exists());
                
                if (!snap.exists()) {
                    showQuizMsg('quizMessage', 'Phone number not registered!', 'error');
                    return;
                }
                
                let studentData = null;
                let studentKey = null;
                snap.forEach(child => {
                    studentData = child.val();
                    studentKey = child.key;
                });
                
                console.log('Student data found:', {
                    key: studentKey,
                    name: studentData.name,
                    email: studentData.email,
                    class: studentData.class
                });
                
                if (studentData.password !== password) {
                    console.log('Password mismatch');
                    showQuizMsg('quizMessage', 'Incorrect password!', 'error');
                    return;
                }
                
                console.log('Password correct - logging in');
                
                quizCurrentUser = {key: studentKey, ...studentData};
                quizUserRole = 'student';
                
                console.log('quizCurrentUser set:', quizCurrentUser);
                console.log('quizUserRole set:', quizUserRole);
                
                // Hide login section
                console.log('Hiding login section');
                const loginSection = document.getElementById('loginSection');
                loginSection.style.display = 'none';
                console.log('loginSection display after hiding:', loginSection.style.display);
                
                // Show student dashboard
                console.log('Showing student dashboard');
                const dashboard = document.getElementById('quizStudentDashboard');
                dashboard.style.display = 'block';
                console.log('quizStudentDashboard display after showing:', dashboard.style.display);
                console.log('quizStudentDashboard computed style:', window.getComputedStyle(dashboard).display);
                console.log('Is dashboard visible?', dashboard.offsetParent !== null);
                
                // Set student info
                console.log('Setting student info in UI');
                document.getElementById('quizStudentName').textContent = studentData.name;
                document.getElementById('quizStudentNameBadge').textContent = studentData.name;
                document.getElementById('quizStudentEmail').textContent = studentData.email;
                document.getElementById('quizStudentClass').textContent = studentData.class;
                
                console.log('Calling checkQuizTodayStatus()');
                await checkQuizTodayStatus();
                
                console.log('=== STUDENT LOGIN END ===');
            } catch (err) {
                console.error('Login error:', err);
                console.error('Error stack:', err.stack);
                showQuizMsg('quizMessage', 'Login failed. Try again.', 'error');
            }
        }
        
        // Regular Quiz Admin login removed - Only Super Admin Dashboard is used
        
        // Check Quiz Status
        async function checkQuizTodayStatus() {
            const today = getQuizToday();
            console.log('‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó');
            console.log('‚ïë          INTENSIVE DEBUG: checkQuizTodayStatus            ‚ïë');
            console.log('‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù');
            console.log('üìÖ Today (calculated):', today);
            console.log('üìÖ Format check: Should be YYYY-MM-DD like 2026-02-17');
            console.log('üïê Current system time:', new Date().toISOString());
            console.log('üïê Current local time:', new Date().toString());
            
            // Reset all sections first
            document.getElementById('quizStartSection').style.display = 'none';
            document.getElementById('quizCompletedSection').style.display = 'none';
            document.getElementById('quizResultsSection').style.display = 'none';
            
            try {
                // INTENSIVE CHECK: What dates exist in Firebase
                console.log('');
                console.log('üîç STEP 1: Checking ALL quiz dates in Firebase...');
                const allQuestionsSnap = await db.ref('quizQuestions').once('value');
                if (allQuestionsSnap.exists()) {
                    const allData = allQuestionsSnap.val();
                    const dates = Object.keys(allData);
                    console.log('‚úÖ Found quiz dates in Firebase:', dates);
                    console.log('üìä Total quiz dates found:', dates.length);
                    
                    // Check each date and its structure
                    dates.forEach(date => {
                        const data = allData[date];
                        console.log(`   üìÖ Date: ${date}`);
                        console.log(`      - Has q1: ${!!data.q1}`);
                        console.log(`      - Has q2: ${!!data.q2}`);
                        if (data.q1) console.log(`      - Q1 text: "${data.q1.text.substring(0, 40)}..."`);
                        if (data.q2) console.log(`      - Q2 text: "${data.q2.text.substring(0, 40)}..."`);
                    });
                    
                    // Check if today's date exists in the list
                    if (dates.includes(today)) {
                        console.log(`‚úÖ TODAY'S DATE (${today}) EXISTS IN FIREBASE!`);
                    } else {
                        console.log(`‚ùå TODAY'S DATE (${today}) NOT FOUND IN FIREBASE!`);
                        console.log(`   Available dates: ${dates.join(', ')}`);
                    }
                } else {
                    console.log('‚ùå NO quiz questions found in Firebase at all!');
                    console.log('   Database path checked: quizQuestions/');
                }
                
                console.log('');
                console.log(`üîç STEP 2: Checking specifically for today (${today})...`);
                const qRef = db.ref(`quizQuestions/${today}`);
                console.log('   Firebase path:', `quizQuestions/${today}`);
                const qSnap = await qRef.once('value');
                
                console.log('   Query result - exists():', qSnap.exists());
                
                if (qSnap.exists()) {
                    const questionData = qSnap.val();
                    console.log('‚úÖ QUESTIONS FOUND FOR TODAY!');
                    console.log('   Full data structure:', JSON.stringify(questionData, null, 2));
                    console.log('   Has q1:', !!questionData.q1);
                    console.log('   Has q2:', !!questionData.q2);
                    if (questionData.q1) {
                        console.log('   Q1 text:', questionData.q1.text);
                        console.log('   Q1 options:', questionData.q1.options);
                        console.log('   Q1 correct answer:', questionData.q1.correct);
                    }
                    if (questionData.q2) {
                        console.log('   Q2 text:', questionData.q2.text);
                        console.log('   Q2 options:', questionData.q2.options);
                        console.log('   Q2 correct answer:', questionData.q2.correct);
                    }
                } else {
                    console.log('‚ùå NO QUESTIONS FOUND FOR TODAY');
                }
                
                if (!qSnap.exists()) {
                    console.log('');
                    console.log('‚ö†Ô∏è  FINAL DECISION: Showing "not available" message');
                    console.log('   Reason: No questions exist for today\'s date');
                    document.getElementById('quizStatus').innerHTML = '<div style="background:#fff3cd;padding:15px;border-radius:8px"><p style="margin:0;color:#856404">‚è≥ Today\'s quiz not yet available. Check back later!</p></div>';
                    console.log('‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó');
                    console.log('‚ïë                    DEBUG END (EARLY EXIT)                 ‚ïë');
                    console.log('‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù');
                    return;
                }
                
                // Quiz questions exist - students can take the quiz!
                console.log('');
                console.log('üîç STEP 3: Quiz questions exist! Checking submission status...');
                console.log('   Current user:', quizCurrentUser);
                console.log('   User email:', quizCurrentUser ? quizCurrentUser.email : 'NULL/UNDEFINED');
                console.log('   User name:', quizCurrentUser ? quizCurrentUser.name : 'NULL/UNDEFINED');
                
                if (!quizCurrentUser || !quizCurrentUser.email) {
                    console.log('‚ùå ERROR: User object or email is missing!');
                    console.log('   This should not happen - user must be logged in to reach here');
                }
                
                const subRef = db.ref(`quizSubmissions/${today}`);
                console.log('   Checking submissions at path:', `quizSubmissions/${today}`);
                console.log('   Querying by studentEmail:', quizCurrentUser.email);
                
                const subSnap = await subRef.orderByChild('studentEmail').equalTo(quizCurrentUser.email).once('value');
                
                console.log('   Submission exists:', subSnap.exists());
                
                if (subSnap.exists()) {
                    console.log('‚úÖ Student HAS submitted - showing completed section');
                    let submission = null;
                    subSnap.forEach(child => {
                        submission = child.val();
                        console.log('   Submission data:', JSON.stringify(submission, null, 2));
                    });
                    
                    document.getElementById('quizCompletedSection').style.display = 'block';
                    document.getElementById('quizStatus').innerHTML = '<div style="background:#d1ecf1;padding:15px;border-radius:8px"><p style="margin:0;color:#0c5460">‚úÖ You have completed today\'s quiz!</p></div>';
                    
                    const resRef = db.ref(`quizResults/${today}`);
                    const resSnap = await resRef.once('value');
                    
                    if (resSnap.exists()) {
                        const results = resSnap.val();
                        console.log('   Results data:', JSON.stringify(results, null, 2));
                        
                        let html = '<div style="background:#f8f9fa;padding:20px;border-radius:10px">';
                        html += `<p><strong>Your Score:</strong> ${submission.score}/2</p>`;
                        html += `<p><strong>Submitted:</strong> ${new Date(submission.submittedAt).toLocaleString()}</p>`;
                        
                        if (results.winner && results.winner.email === quizCurrentUser.email) {
                            html += '<div style="background:#d4edda;color:#155724;padding:15px;border-radius:8px;margin-top:15px"><strong>üèÜ CONGRATULATIONS! You are the WINNER!</strong></div>';
                        } else if (results.runnerUp && results.runnerUp.email === quizCurrentUser.email) {
                            html += '<div style="background:#d1ecf1;color:#0c5460;padding:15px;border-radius:8px;margin-top:15px"><strong>ü•à CONGRATULATIONS! You are the RUNNER-UP!</strong></div>';
                        } else if (submission.score === 2) {
                            html += '<div style="background:#d1ecf1;color:#0c5460;padding:15px;border-radius:8px;margin-top:15px"><strong>‚úÖ Great job! Both answers correct!</strong></div>';
                        }
                        
                        html += '</div>';
                        document.getElementById('quizStudentResults').innerHTML = html;
                        document.getElementById('quizResultsSection').style.display = 'block';
                    } else {
                        console.log('   No results published yet');
                    }
                } else {
                    console.log('‚úÖ Student has NOT submitted yet - SHOWING QUIZ!');
                    console.log('');
                    console.log('üéØ FINAL DECISION: Making quiz available');
                    console.log('   Setting quizStatus to "Ready" message...');
                    document.getElementById('quizStatus').innerHTML = '<div style="background:#d4edda;padding:15px;border-radius:8px"><p style="margin:0;color:#155724"><strong>‚úÖ Ready!</strong> Today\'s quiz is available. Click below to start.</p></div>';
                    console.log('   ‚úÖ quizStatus updated');
                    
                    console.log('   Setting quizStartSection display to "block"...');
                    document.getElementById('quizStartSection').style.display = 'block';
                    console.log('   ‚úÖ quizStartSection display is now:', document.getElementById('quizStartSection').style.display);
                    
                    console.log('');
                    console.log('‚úÖ QUIZ SHOULD NOW BE VISIBLE TO USER!');
                }
                
                console.log('');
                console.log('‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó');
                console.log('‚ïë                    DEBUG END (SUCCESS)                    ‚ïë');
                console.log('‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù');
            } catch (err) {
                console.log('');
                console.log('‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó');
                console.log('‚ïë                   ERROR OCCURRED!!!                       ‚ïë');
                console.log('‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù');
                console.error('‚ùå Status check error:', err);
                console.error('‚ùå Error message:', err.message);
                console.error('‚ùå Error stack:', err.stack);
                console.error('‚ùå Error name:', err.name);
                document.getElementById('quizStatus').innerHTML = '<div style="background:#f8d7da;padding:15px;border-radius:8px"><p style="margin:0;color:#721c24">‚ùå Error checking quiz status. Please refresh the page.</p></div>';
                console.log('‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó');
                console.log('‚ïë                    DEBUG END (ERROR)                      ‚ïë');
                console.log('‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù');
            }
        }
        
        // Start Quiz
        async function startQuiz() {
            const today = getQuizToday();
            
            try {
                const qRef = db.ref(`quizQuestions/${today}`);
                const snap = await qRef.once('value');
                const questions = snap.val();
                
                if (!questions || !questions.q1 || !questions.q2) {
                    showQuizMsg('quizStudentMessage', 'Quiz not available!', 'error');
                    return;
                }
                
                // Set the date display
                const dateObj = new Date(today);
                const dateStr = dateObj.toLocaleDateString('en-IN', {
                    weekday: 'long',
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
                document.getElementById('quizDateDisplay').textContent = 'üìÖ ' + dateStr;
                
                document.getElementById('quizStudentDashboard').style.display = 'none';
                document.getElementById('quizPage').style.display = 'block';
                
                enableQuizAntiCheat();
                loadQuizQuestions(questions);
                quizStartTime = Date.now();
                startQuizTimer();
            } catch (err) {
                console.error('Start quiz error:', err);
            }
        }
        
        // Load Questions
        function loadQuizQuestions(questions) {
            const cont = document.getElementById('quizQuestionsContainer');
            
            let html = '';
            
            // Question 1
            html += '<div class="quiz-question-card" style="animation-delay: 0.1s">';
            html += '<h4><span style="background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:white;padding:5px 15px;border-radius:20px;font-size:0.9em">Question 1 of 2</span></h4>';
            
            // Add image if present
            if (questions.q1.image) {
                html += `<div style="text-align:center;margin:15px 0">
                    <img src="${questions.q1.image}" style="max-width:100%;max-height:300px;border-radius:12px;box-shadow:0 4px 15px rgba(0,0,0,0.2)">
                </div>`;
            }
            
            // Add audio player if present
            if (questions.q1.audio) {
                html += `<div style="text-align:center;margin:15px 0;background:#f0f0f0;padding:15px;border-radius:10px">
                    <p style="margin:0 0 10px 0;font-weight:600;color:#667eea">üéµ Listen to the audio</p>
                    <audio controls id="q1Audio" style="width:100%;max-width:400px">
                        <source src="${questions.q1.audio}">
                    </audio>
                </div>`;
            }
            
            html += `<div class="question-text">${questions.q1.text}</div>`;
            html += '<div style="display:grid;gap:15px">';
            ['A','B','C','D'].forEach(opt => {
                html += `<div class="quiz-option" data-question="qq1" data-value="${opt}">
                    <div class="option-circle">${opt}</div>
                    <span style="flex:1">${questions.q1.options[opt]}</span>
                    <input type="radio" name="qq1" value="${opt}" style="display:none">
                </div>`;
            });
            html += '</div></div>';
            
            // Question 2
            html += '<div class="quiz-question-card" style="animation-delay: 0.2s">';
            html += '<h4><span style="background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:white;padding:5px 15px;border-radius:20px;font-size:0.9em">Question 2 of 2</span></h4>';
            
            // Add image if present
            if (questions.q2.image) {
                html += `<div style="text-align:center;margin:15px 0">
                    <img src="${questions.q2.image}" style="max-width:100%;max-height:300px;border-radius:12px;box-shadow:0 4px 15px rgba(0,0,0,0.2)">
                </div>`;
            }
            
            // Add audio player if present
            if (questions.q2.audio) {
                html += `<div style="text-align:center;margin:15px 0;background:#f0f0f0;padding:15px;border-radius:10px">
                    <p style="margin:0 0 10px 0;font-weight:600;color:#667eea">üéµ Listen to the audio</p>
                    <audio controls id="q2Audio" style="width:100%;max-width:400px">
                        <source src="${questions.q2.audio}">
                    </audio>
                </div>`;
            }
            
            html += `<div class="question-text">${questions.q2.text}</div>`;
            html += '<div style="display:grid;gap:15px">';
            ['A','B','C','D'].forEach(opt => {
                html += `<div class="quiz-option" data-question="qq2" data-value="${opt}">
                    <div class="option-circle">${opt}</div>
                    <span style="flex:1">${questions.q2.options[opt]}</span>
                    <input type="radio" name="qq2" value="${opt}" style="display:none">
                </div>`;
            });
            html += '</div></div>';
            
            cont.innerHTML = html;
            
            // Add click handlers for new styled options
            document.querySelectorAll('.quiz-option').forEach(opt => {
                opt.onclick = function() {
                    const question = this.getAttribute('data-question');
                    const value = this.getAttribute('data-value');
                    
                    // Remove selected class from all options in this question
                    document.querySelectorAll(`.quiz-option[data-question="${question}"]`).forEach(o => {
                        o.classList.remove('selected');
                    });
                    
                    // Add selected class to clicked option
                    this.classList.add('selected');
                    
                    // Update hidden radio button
                    const radio = this.querySelector('input[type="radio"]');
                    radio.checked = true;
                };
            });
        }
        
        // Quiz Timer
        function startQuizTimer() {
            updateQuizTimer();
            quizTimerInterval = setInterval(updateQuizTimer, 1000);
        }
        
        function updateQuizTimer() {
            const elapsed = Math.floor((Date.now() - quizStartTime) / 1000);
            const mins = Math.floor(elapsed / 60);
            const secs = elapsed % 60;
            document.getElementById('quizTimerValue').textContent = `${mins.toString().padStart(2,'0')}:${secs.toString().padStart(2,'0')}`;
            
            if (elapsed > 600) {
                document.getElementById('quizTimer').style.background = '#ff6b6b';
                document.getElementById('quizTimer').style.color = 'white';
            }
        }
        
        // Submit Quiz
        async function submitQuizAnswers() {
            const q1 = document.querySelector('input[name="qq1"]:checked');
            const q2 = document.querySelector('input[name="qq2"]:checked');
            
            if (!q1 || !q2) {
                showQuizMsg('quizPageMessage', '‚ö†Ô∏è Please answer all questions!', 'error');
                return;
            }
            
            const today = getQuizToday();
            
            try {
                const qRef = db.ref(`quizQuestions/${today}`);
                const snap = await qRef.once('value');
                const questions = snap.val();
                
                let score = 0;
                if (q1.value === questions.q1.correct) score++;
                if (q2.value === questions.q2.correct) score++;
                
                await db.ref(`quizSubmissions/${today}`).push({
                    studentKey: quizCurrentUser.key,
                    studentName: quizCurrentUser.name,
                    studentEmail: quizCurrentUser.email,
                    studentClass: quizCurrentUser.class,
                    answers: {q1: q1.value, q2: q2.value},
                    score,
                    submittedAt: new Date().toISOString(),
                    timeTaken: Math.floor((Date.now() - quizStartTime) / 1000)
                });
                
                disableQuizAntiCheat();
                if (quizTimerInterval) clearInterval(quizTimerInterval);
                
                // Show success modal with confetti
                showQuizSuccessModal(score);
                
                setTimeout(() => {
                    document.getElementById('quizPage').style.display = 'none';
                    document.getElementById('quizStudentDashboard').style.display = 'block';
                    checkQuizTodayStatus();
                }, 4000);
            } catch (err) {
                console.error('Submit error:', err);
                showQuizMsg('quizPageMessage', 'Error submitting. Try again.', 'error');
            }
        }
        
        // Show Success Modal with Confetti
        function showQuizSuccessModal(score) {
            const modal = document.createElement('div');
            modal.className = 'quiz-success-modal';
            modal.innerHTML = `
                <div class="quiz-success-content">
                    <div class="success-icon">üéâ</div>
                    <h2>Quiz Submitted!</h2>
                    <p style="font-size:1.5em;color:#28a745;font-weight:bold">Your Score: ${score}/2</p>
                    <p style="margin-top:15px">Results will be announced soon!</p>
                    <p style="color:#999;font-size:0.9em;margin-top:10px">Good luck! üçÄ</p>
                </div>
            `;
            document.body.appendChild(modal);
            
            // Create confetti
            createConfetti();
            
            // Remove modal after 3.5 seconds
            setTimeout(() => {
                modal.style.opacity = '0';
                setTimeout(() => modal.remove(), 300);
            }, 3500);
        }
        
        // Create Confetti Animation
        function createConfetti() {
            const colors = ['#ff6b6b', '#4ecdc4', '#45b7d1', '#f7b731', '#5f27cd', '#00d2d3', '#ff9ff3', '#54a0ff'];
            const confettiCount = 50;
            
            for (let i = 0; i < confettiCount; i++) {
                const confetti = document.createElement('div');
                confetti.className = 'confetti';
                confetti.style.left = Math.random() * 100 + '%';
                confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                confetti.style.animationDelay = Math.random() * 0.5 + 's';
                confetti.style.animationDuration = (Math.random() * 2 + 2) + 's';
                document.body.appendChild(confetti);
                
                setTimeout(() => confetti.remove(), 3000);
            }
        }
        
        // Anti-Cheat
        function enableQuizAntiCheat() {
            quizAntiCheatActive = true;
            window.onbeforeunload = () => quizAntiCheatActive ? "Quiz in progress!" : null;
            document.addEventListener('visibilitychange', handleQuizVisibility);
        }
        
        function handleQuizVisibility() {
            if (quizAntiCheatActive && document.hidden) {
                alert('‚ö†Ô∏è TAB SWITCH! Auto-submitting quiz.');
                autoSubmitQuiz();
            }
        }
        
        async function autoSubmitQuiz() {
            if (!quizAntiCheatActive) return;
            const today = getQuizToday();
            try {
                await db.ref(`quizSubmissions/${today}`).push({
                    studentKey: quizCurrentUser.key,
                    studentName: quizCurrentUser.name,
                    studentEmail: quizCurrentUser.email,
                    studentClass: quizCurrentUser.class,
                    answers: {q1: 'X', q2: 'X'},
                    score: 0,
                    submittedAt: new Date().toISOString(),
                    timeTaken: 0,
                    status: 'auto-submitted'
                });
                disableQuizAntiCheat();
                if (quizTimerInterval) clearInterval(quizTimerInterval);
                document.getElementById('quizPage').style.display = 'none';
                document.getElementById('quizStudentDashboard').style.display = 'block';
                checkQuizTodayStatus();
            } catch (err) {
                console.error('Auto-submit error:', err);
            }
        }
        
        function disableQuizAntiCheat() {
            quizAntiCheatActive = false;
            window.onbeforeunload = null;
            document.removeEventListener('visibilitychange', handleQuizVisibility);
        }
        
        // Admin Functions
        async function loadQuizAdminStats() {
            try {
                const studSnap = await db.ref('quizStudents').once('value');
                document.getElementById('quizTotalStudents').textContent = studSnap.numChildren();
                
                const today = getQuizToday();
                const subSnap = await db.ref(`quizSubmissions/${today}`).once('value');
                document.getElementById('quizTodayParticipants').textContent = subSnap.numChildren();
                
                const qSnap = await db.ref(`quizQuestions/${today}`).once('value');
                document.getElementById('quizQuestionsCount').textContent = qSnap.exists() ? 2 : 0;
            } catch (err) {
                console.error('Stats error:', err);
            }
        }
        
        function showQuizAdminTab(tab) {
            document.querySelectorAll('#quizAdminDashboard .tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('#quizAdminDashboard .form-section').forEach(s => s.classList.remove('active'));
            
            const tabs = ['questions','students','submissions','results'];
            const idx = tabs.indexOf(tab);
            document.querySelectorAll('#quizAdminDashboard .tab')[idx].classList.add('active');
            document.getElementById(`quiz${tab.charAt(0).toUpperCase()+tab.slice(1)}TabContent`).classList.add('active');
            
            if (tab === 'students') loadQuizStudents();
            if (tab === 'submissions') loadQuizSubmissions();
            if (tab === 'results') loadQuizResults();
        }
        
        // Preview Image for Question
        function previewQuestionImage(input, previewId) {
            const preview = document.getElementById(previewId);
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    preview.innerHTML = `
                        <div style="position:relative;display:inline-block">
                            <img src="${e.target.result}" style="max-width:300px;max-height:200px;border-radius:8px;box-shadow:0 4px 10px rgba(0,0,0,0.1)">
                            <button onclick="clearMedia('${input.id}', '${previewId}')" style="position:absolute;top:5px;right:5px;background:red;color:white;border:none;border-radius:50%;width:25px;height:25px;cursor:pointer">√ó</button>
                        </div>
                    `;
                };
                reader.readAsDataURL(input.files[0]);
            }
        }
        
        // Preview Audio for Question
        function previewQuestionAudio(input, previewId) {
            const preview = document.getElementById(previewId);
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    preview.innerHTML = `
                        <div style="background:#f0f0f0;padding:15px;border-radius:8px;display:inline-block">
                            <audio controls style="max-width:300px">
                                <source src="${e.target.result}">
                            </audio>
                            <button onclick="clearMedia('${input.id}', '${previewId}')" style="margin-left:10px;background:red;color:white;border:none;border-radius:5px;padding:5px 10px;cursor:pointer">Remove</button>
                        </div>
                    `;
                };
                reader.readAsDataURL(input.files[0]);
            }
        }
        
        // Clear Media
        function clearMedia(inputId, previewId) {
            document.getElementById(inputId).value = '';
            document.getElementById(previewId).innerHTML = '';
        }
        
        async function saveQuizQuestions() {
            const q1Text = document.getElementById('q1Text').value.trim();
            const q1OptA = document.getElementById('q1OptA').value.trim();
            const q1OptB = document.getElementById('q1OptB').value.trim();
            const q1OptC = document.getElementById('q1OptC').value.trim();
            const q1OptD = document.getElementById('q1OptD').value.trim();
            const q1Correct = document.getElementById('q1Correct').value;
            
            const q2Text = document.getElementById('q2Text').value.trim();
            const q2OptA = document.getElementById('q2OptA').value.trim();
            const q2OptB = document.getElementById('q2OptB').value.trim();
            const q2OptC = document.getElementById('q2OptC').value.trim();
            const q2OptD = document.getElementById('q2OptD').value.trim();
            const q2Correct = document.getElementById('q2Correct').value;
            
            if (!q1Text || !q1OptA || !q1OptB || !q1OptC || !q1OptD || !q1Correct) {
                showQuizMsg('quizAdminDashMessage', '‚ö†Ô∏è Fill all Question 1 fields!', 'error');
                return;
            }
            
            if (!q2Text || !q2OptA || !q2OptB || !q2OptC || !q2OptD || !q2Correct) {
                showQuizMsg('quizAdminDashMessage', '‚ö†Ô∏è Fill all Question 2 fields!', 'error');
                return;
            }
            
            // Get image and audio files
            const q1ImageFile = document.getElementById('q1Image').files[0];
            const q1AudioFile = document.getElementById('q1Audio').files[0];
            const q2ImageFile = document.getElementById('q2Image').files[0];
            const q2AudioFile = document.getElementById('q2Audio').files[0];
            
            const today = getQuizToday();
            const data = {
                q1: {
                    text: q1Text, 
                    options: {A:q1OptA, B:q1OptB, C:q1OptC, D:q1OptD}, 
                    correct: q1Correct
                },
                q2: {
                    text: q2Text, 
                    options: {A:q2OptA, B:q2OptB, C:q2OptC, D:q2OptD}, 
                    correct: q2Correct
                },
                createdAt: new Date().toISOString(),
                createdBy: quizCurrentUser.email
            };
            
            // Convert images and audio to base64 if present
            try {
                if (q1ImageFile) {
                    data.q1.image = await fileToBase64(q1ImageFile);
                }
                if (q1AudioFile) {
                    data.q1.audio = await fileToBase64(q1AudioFile);
                }
                if (q2ImageFile) {
                    data.q2.image = await fileToBase64(q2ImageFile);
                }
                if (q2AudioFile) {
                    data.q2.audio = await fileToBase64(q2AudioFile);
                }
                
                await db.ref(`quizQuestions/${today}`).set(data);
                showQuizMsg('quizAdminDashMessage', '‚úÖ Questions saved successfully with media!', 'success');
                
                // Clear form
                ['q1Text','q1OptA','q1OptB','q1OptC','q1OptD','q1Correct','q2Text','q2OptA','q2OptB','q2OptC','q2OptD','q2Correct'].forEach(id => {
                    document.getElementById(id).value = '';
                });
                ['q1Image','q1Audio','q2Image','q2Audio'].forEach(id => {
                    document.getElementById(id).value = '';
                });
                ['q1ImagePreview','q1AudioPreview','q2ImagePreview','q2AudioPreview'].forEach(id => {
                    document.getElementById(id).innerHTML = '';
                });
                
                await loadQuizAdminStats();
            } catch (err) {
                console.error('Save error:', err);
                showQuizMsg('quizAdminDashMessage', 'Error saving questions.', 'error');
            }
        }
        
        // Convert file to base64
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }
        
        async function viewTodayQuestions() {
            const today = getQuizToday();
            try {
                const snap = await db.ref(`quizQuestions/${today}`).once('value');
                const q = snap.val();
                const view = document.getElementById('todayQuestionsView');
                
                if (!q) {
                    view.innerHTML = '<div style="background:#fff3cd;padding:15px;border-radius:8px;margin-top:20px"><p style="margin:0;color:#856404">No questions for today yet.</p></div>';
                    view.style.display = 'block';
                    return;
                }
                
                let html = '<div style="background:#f8f9fa;padding:20px;border-radius:10px">';
                html += '<h4 style="color:#667eea;margin-bottom:15px">Today\'s Questions Preview</h4>';
                html += `<p><strong>Q1:</strong> ${q.q1.text}</p>`;
                html += `<p style="margin-left:20px">A) ${q.q1.options.A}</p>`;
                html += `<p style="margin-left:20px">B) ${q.q1.options.B}</p>`;
                html += `<p style="margin-left:20px">C) ${q.q1.options.C}</p>`;
                html += `<p style="margin-left:20px">D) ${q.q1.options.D}</p>`;
                html += `<p style="color:green;font-weight:bold;margin-left:20px">Correct: ${q.q1.correct}</p><br>`;
                html += `<p><strong>Q2:</strong> ${q.q2.text}</p>`;
                html += `<p style="margin-left:20px">A) ${q.q2.options.A}</p>`;
                html += `<p style="margin-left:20px">B) ${q.q2.options.B}</p>`;
                html += `<p style="margin-left:20px">C) ${q.q2.options.C}</p>`;
                html += `<p style="margin-left:20px">D) ${q.q2.options.D}</p>`;
                html += `<p style="color:green;font-weight:bold;margin-left:20px">Correct: ${q.q2.correct}</p>`;
                html += '</div>';
                
                view.innerHTML = html;
                view.style.display = 'block';
                
                // Check publish status
                await checkPublishStatusForToday();
            } catch (err) {
                console.error('View error:', err);
            }
        }
        
        async function loadQuizStudents() {
            try {
                const snap = await db.ref('quizStudents').once('value');
                const tbody = document.getElementById('quizStudentsTable');
                tbody.innerHTML = '';
                
                if (!snap.exists()) {
                    tbody.innerHTML = '<tr><td colspan="6" style="text-align:center">No students yet.</td></tr>';
                    return;
                }
                
                let idx = 1;
                snap.forEach(child => {
                    const s = child.val();
                    const row = tbody.insertRow();
                    row.innerHTML = `<td>${idx++}</td><td>${s.name}</td><td>${s.email}</td><td>${s.phone}</td><td>${s.class}</td><td>${new Date(s.registeredAt).toLocaleDateString()}</td>`;
                });
            } catch (err) {
                console.error('Load students error:', err);
            }
        }
        
        async function loadQuizSubmissions() {
            const today = getQuizToday();
            try {
                const snap = await db.ref(`quizSubmissions/${today}`).once('value');
                const tbody = document.getElementById('quizSubmissionsTable');
                tbody.innerHTML = '';
                
                if (!snap.exists()) {
                    tbody.innerHTML = '<tr><td colspan="7" style="text-align:center">No submissions yet today.</td></tr>';
                    return;
                }
                
                let idx = 1;
                snap.forEach(child => {
                    const s = child.val();
                    const row = tbody.insertRow();
                    const timeMins = Math.floor(s.timeTaken / 60);
                    const timeSecs = s.timeTaken % 60;
                    row.innerHTML = `<td>${idx++}</td><td>${s.studentName}</td><td>${s.studentEmail}</td><td>${s.studentClass}</td><td>${new Date(s.submittedAt).toLocaleString()}</td><td><strong>${s.score}/2</strong></td><td>${timeMins}m ${timeSecs}s</td>`;
                });
            } catch (err) {
                console.error('Load submissions error:', err);
            }
        }
        
        async function loadQuizResults() {
            const today = getQuizToday();
            try {
                const snap = await db.ref(`quizSubmissions/${today}`).once('value');
                
                if (!snap.exists()) {
                    document.getElementById('resultTotalPart').textContent = '0';
                    document.getElementById('resultBothCorrect').textContent = '0';
                    document.getElementById('resultEligible').textContent = '0';
                    return;
                }
                
                let total = 0, correct = 0;
                snap.forEach(child => {
                    total++;
                    if (child.val().score === 2) correct++;
                });
                
                document.getElementById('resultTotalPart').textContent = total;
                document.getElementById('resultBothCorrect').textContent = correct;
                document.getElementById('resultEligible').textContent = correct;
                
                const resSnap = await db.ref(`quizResults/${today}`).once('value');
                if (resSnap.exists()) {
                    displayQuizWinners(resSnap.val());
                }
            } catch (err) {
                console.error('Load results error:', err);
            }
        }
        
        async function selectQuizWinners() {
            const today = getQuizToday();
            try {
                const snap = await db.ref(`quizSubmissions/${today}`).once('value');
                const eligible = [];
                snap.forEach(child => {
                    if (child.val().score === 2) eligible.push(child.val());
                });
                
                if (eligible.length === 0) {
                    showQuizMsg('quizAdminDashMessage', '‚ö†Ô∏è No correct answers yet!', 'warning');
                    return;
                }
                
                if (eligible.length === 1) {
                    showQuizMsg('quizAdminDashMessage', '‚ö†Ô∏è Only one correct. Need 2 for winner & runner-up.', 'warning');
                    return;
                }
                
                const shuffled = eligible.sort(() => 0.5 - Math.random());
                const winner = shuffled[0];
                const runnerUp = shuffled[1];
                
                const data = {
                    winner: {name: winner.studentName, email: winner.studentEmail, class: winner.studentClass, score: winner.score},
                    runnerUp: {name: runnerUp.studentName, email: runnerUp.studentEmail, class: runnerUp.studentClass, score: runnerUp.score},
                    declaredAt: new Date().toISOString(),
                    declaredBy: quizCurrentUser.email,
                    totalEligible: eligible.length
                };
                
                await db.ref(`quizResults/${today}`).set(data);
                
                // Try to send emails but don't block winner declaration
                try {
                    await sendQuizEmail(winner.studentEmail, 'üèÜ You Won Quiz!', `Dear ${winner.studentName},\n\nCongratulations! You are the WINNER!\n\nScore: ${winner.score}/2\nClass: ${winner.studentClass}\n\nDavan Institute`);
                } catch (e) { console.log('Winner email failed:', e); }
                
                try {
                    await sendQuizEmail(runnerUp.studentEmail, 'ü•à Runner-Up!', `Dear ${runnerUp.studentName},\n\nCongratulations! You are RUNNER-UP!\n\nScore: ${runnerUp.score}/2\nClass: ${runnerUp.studentClass}\n\nDavan Institute`);
                } catch (e) { console.log('Runner-up email failed:', e); }
                
                showQuizMsg('quizAdminDashMessage', '‚úÖ Winners selected & emails sent!', 'success');
                displayQuizWinners(data);
            } catch (err) {
                console.error('Select winners error:', err);
                showQuizMsg('quizAdminDashMessage', 'Error selecting winners.', 'error');
            }
        }
        
        function displayQuizWinners(data) {
            const div = document.getElementById('winnersDisplaySection');
            let html = '<div style="background:#f8f9fa;padding:25px;border-radius:12px">';
            html += '<h3 style="color:#667eea;margin-bottom:20px;text-align:center">üéâ Today\'s Winners</h3>';
            html += '<div style="background:linear-gradient(135deg,#ffd700 0%,#ffed4e 100%);padding:20px;border-radius:10px;margin-bottom:15px;color:#333">';
            html += '<h4 style="margin-bottom:10px">üèÜ WINNER</h4>';
            html += `<p><strong>Name:</strong> ${data.winner.name}</p>`;
            html += `<p><strong>Email:</strong> ${data.winner.email}</p>`;
            html += `<p><strong>Class:</strong> ${data.winner.class}</p>`;
            html += `<p><strong>Score:</strong> ${data.winner.score}/2</p></div>`;
            html += '<div style="background:linear-gradient(135deg,#c0c0c0 0%,#e8e8e8 100%);padding:20px;border-radius:10px;color:#333">';
            html += '<h4 style="margin-bottom:10px">ü•à RUNNER-UP</h4>';
            html += `<p><strong>Name:</strong> ${data.runnerUp.name}</p>`;
            html += `<p><strong>Email:</strong> ${data.runnerUp.email}</p>`;
            html += `<p><strong>Class:</strong> ${data.runnerUp.class}</p>`;
            html += `<p><strong>Score:</strong> ${data.runnerUp.score}/2</p></div>`;
            html += `<p style="text-align:center;margin-top:20px;color:#666"><small>Declared: ${new Date(data.declaredAt).toLocaleString()}</small></p></div>`;
            div.innerHTML = html;
            div.style.display = 'block';
        }
        
        // ========== INTEGRATED QUIZ MANAGEMENT FUNCTIONS ==========
        
        function showQuizManagementTab(tab, event) {
            document.querySelectorAll('#quizManagement .tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('#quizManagement .form-section').forEach(s => s.classList.remove('active'));
            
            // Only try to add active class to event target if event exists
            if (event && event.target) {
                event.target.classList.add('active');
            } else {
                // Programmatic call - find and activate the correct tab button
                const tabButtons = {
                    'questions': 0,
                    'allquizzes': 1,
                    'students': 2,
                    'submissions': 3,
                    'winners': 4,
                    'editdates': 5
                };
                const tabIndex = tabButtons[tab];
                if (tabIndex !== undefined) {
                    const tabs = document.querySelectorAll('#quizManagement .tab');
                    if (tabs[tabIndex]) {
                        tabs[tabIndex].classList.add('active');
                    }
                }
            }
            
            if (tab === 'questions') {
                document.getElementById('quizQuestionsContent').classList.add('active');
            } else if (tab === 'allquizzes') {
                document.getElementById('quizAllQuizzesContent').classList.add('active');
                loadAllQuizzes();
            } else if (tab === 'students') {
                document.getElementById('quizStudentsContent').classList.add('active');
                loadQuizStudentsAdmin();
            } else if (tab === 'submissions') {
                document.getElementById('quizSubmissionsContent').classList.add('active');
                loadQuizSubmissionsAdmin();
            } else if (tab === 'winners') {
                document.getElementById('quizWinnersContent').classList.add('active');
                loadQuizResultsAdmin();
            } else if (tab === 'editdates') {
                document.getElementById('quizEditDatesContent').classList.add('active');
                loadQuizzesForDateEdit();
            }
        }
        
        // Function to load quiz questions for the selected date
        async function loadQuizForSelectedDate() {
            const selectedDate = document.getElementById('quizDateSelector').value;
            if (!selectedDate) {
                return;
            }
            
            console.log('Loading quiz for date:', selectedDate);
            
            // Update heading
            const dateObj = new Date(selectedDate + 'T00:00:00');
            const dateStr = dateObj.toLocaleDateString('en-IN', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
            document.getElementById('quizQuestionsHeading').textContent = `Create Quiz for ${dateStr} (2 Questions)`;
            
            try {
                const snapshot = await db.ref(`quizQuestions/${selectedDate}`).once('value');
                
                if (snapshot.exists()) {
                    const data = snapshot.val();
                    console.log('Found existing quiz:', data);
                    
                    // Populate form with existing data
                    document.getElementById('quiz_q1Text').value = data.q1.text || '';
                    document.getElementById('quiz_q1OptA').value = data.q1.options.A || '';
                    document.getElementById('quiz_q1OptB').value = data.q1.options.B || '';
                    document.getElementById('quiz_q1OptC').value = data.q1.options.C || '';
                    document.getElementById('quiz_q1OptD').value = data.q1.options.D || '';
                    document.getElementById('quiz_q1Correct').value = data.q1.correct || '';
                    
                    document.getElementById('quiz_q2Text').value = data.q2.text || '';
                    document.getElementById('quiz_q2OptA').value = data.q2.options.A || '';
                    document.getElementById('quiz_q2OptB').value = data.q2.options.B || '';
                    document.getElementById('quiz_q2OptC').value = data.q2.options.C || '';
                    document.getElementById('quiz_q2OptD').value = data.q2.options.D || '';
                    document.getElementById('quiz_q2Correct').value = data.q2.correct || '';
                    
                    showQuizMsg('quizAdminMessage', `‚úèÔ∏è Editing existing quiz for ${selectedDate}. Modify and save to update.`, 'success');
                    displaySavedQuestionsPreview(data);
                } else {
                    console.log('No quiz found for this date, clearing form');
                    
                    // Clear form for new quiz
                    ['quiz_q1Text','quiz_q1OptA','quiz_q1OptB','quiz_q1OptC','quiz_q1OptD','quiz_q1Correct','quiz_q2Text','quiz_q2OptA','quiz_q2OptB','quiz_q2OptC','quiz_q2OptD','quiz_q2Correct'].forEach(id => {
                        const el = document.getElementById(id);
                        if (el) el.value = '';
                    });
                    
                    document.getElementById('todayQuestionsViewAdmin').innerHTML = '';
                    document.getElementById('todayQuestionsViewAdmin').style.display = 'none';
                    
                    showQuizMsg('quizAdminMessage', `üìù No quiz exists for ${selectedDate}. Create a new one below.`, 'error');
                }
            } catch (err) {
                console.error('Error loading quiz:', err);
                showQuizMsg('quizAdminMessage', 'Error loading quiz: ' + err.message, 'error');
            }
        }
        
        // Initialize date selector with today's date when page loads
        function initializeDateSelector() {
            const dateInput = document.getElementById('quizDateSelector');
            if (dateInput) {
                const today = getQuizToday();
                dateInput.value = today;
                loadQuizForSelectedDate();
            }
        }
        
        async function loadQuizManagementStats() {
            try {
                const studSnap = await db.ref('quizStudents').once('value');
                document.getElementById('quizTotalStudents').textContent = studSnap.numChildren();
                
                const today = getQuizToday();
                const subSnap = await db.ref(`quizSubmissions/${today}`).once('value');
                document.getElementById('quizTodayParticipants').textContent = subSnap.numChildren();
                
                const qSnap = await db.ref(`quizQuestions/${today}`).once('value');
                document.getElementById('quizQuestionsCount').textContent = qSnap.exists() ? 2 : 0;
            } catch (err) {
                console.error('Load quiz stats error:', err);
            }
        }
        
        async function loadAllQuizzes() {
            const container = document.getElementById('allQuizzesContainer');
            container.innerHTML = '<p style="text-align:center;color:#666">Loading all quizzes...</p>';
            
            try {
                const quizzesSnap = await db.ref('quizQuestions').once('value');
                
                if (!quizzesSnap.exists()) {
                    container.innerHTML = '<div style="background:#fff3cd;padding:20px;border-radius:8px;text-align:center"><p style="margin:0;color:#856404">No quizzes found in database.</p></div>';
                    return;
                }
                
                // Get all quiz dates and sort them (newest first)
                const quizzes = [];
                quizzesSnap.forEach(child => {
                    quizzes.push({
                        date: child.key,
                        data: child.val()
                    });
                });
                
                quizzes.sort((a, b) => new Date(b.date) - new Date(a.date));
                
                // Get publish statuses
                const publishedSnap = await db.ref('quizPublished').once('value');
                const publishedData = publishedSnap.val() || {};
                
                let html = '';
                
                for (const quiz of quizzes) {
                    const dateObj = new Date(quiz.date);
                    const dateStr = dateObj.toLocaleDateString('en-IN', {
                        weekday: 'long',
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric'
                    });
                    
                    const isPublished = publishedData[quiz.date] && publishedData[quiz.date].published === true;
                    const publishInfo = publishedData[quiz.date];
                    
                    html += '<div style="background:white;padding:20px;border-radius:10px;margin-bottom:20px;border-left:5px solid ' + (isPublished ? '#4CAF50' : '#667eea') + '">';
                    html += '<div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:15px">';
                    html += '<div>';
                    html += '<h4 style="color:#667eea;margin:0 0 5px 0">üìÖ ' + dateStr + '</h4>';
                    html += '<p style="margin:0;font-size:0.9em;color:#666">Date: ' + quiz.date + '</p>';
                    if (publishInfo) {
                        if (isPublished) {
                            html += '<p style="margin:5px 0 0 0;font-size:0.85em;color:#4CAF50;font-weight:600">‚úÖ PUBLISHED on ' + new Date(publishInfo.publishedAt).toLocaleString() + '</p>';
                        } else {
                            html += '<p style="margin:5px 0 0 0;font-size:0.85em;color:#ff9800;font-weight:600">‚ö†Ô∏è UNPUBLISHED</p>';
                        }
                    } else {
                        html += '<p style="margin:5px 0 0 0;font-size:0.85em;color:#999">Not yet published</p>';
                    }
                    html += '</div>';
                    html += '<div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">';
                    html += '<button class="btn btn-info btn-small" onclick="editQuizByDate(\'' + quiz.date + '\')" style="background:#2196F3;font-weight:600">‚úèÔ∏è Edit</button>';
                    html += '<button class="btn btn-danger btn-small" onclick="deleteQuizByDate(\'' + quiz.date + '\')" style="font-weight:600">üóëÔ∏è Delete</button>';
                    if (isPublished) {
                        html += '<button class="btn btn-small" onclick="unpublishQuizByDate(\'' + quiz.date + '\')" style="background:#ff9800;color:white;font-weight:600">‚ùå Unpublish</button>';
                    } else {
                        html += '<button class="btn btn-success btn-small" onclick="publishQuizByDate(\'' + quiz.date + '\')" style="font-weight:600">‚úÖ Publish</button>';
                    }
                    html += '</div>';
                    html += '</div>';
                    
                    html += '<div style="background:#f8f9fa;padding:15px;border-radius:8px">';
                    html += '<p style="margin:0 0 10px 0;font-weight:600">Question 1:</p>';
                    
                    // Show image if present
                    if (quiz.data.q1.image) {
                        html += '<div style="text-align:center;margin:10px 0"><img src="' + quiz.data.q1.image + '" style="max-width:100%;max-height:200px;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,0.1)"></div>';
                    }
                    
                    // Show audio if present
                    if (quiz.data.q1.audio) {
                        html += '<div style="margin:10px 0;background:#e8f5e9;padding:10px;border-radius:6px"><p style="margin:0 0 5px 0;font-size:0.9em;color:#2e7d32">üéµ Audio attached</p><audio controls style="width:100%;max-width:300px"><source src="' + quiz.data.q1.audio + '"></audio></div>';
                    }
                    
                    html += '<p style="margin:0 0 10px 0">' + quiz.data.q1.text + '</p>';
                    html += '<p style="margin:0;color:#4CAF50;font-weight:600">‚úÖ Correct: ' + quiz.data.q1.options[quiz.data.q1.correct] + '</p>';
                    html += '</div>';
                    
                    html += '<div style="background:#f8f9fa;padding:15px;border-radius:8px;margin-top:10px">';
                    html += '<p style="margin:0 0 10px 0;font-weight:600">Question 2:</p>';
                    
                    // Show image if present
                    if (quiz.data.q2.image) {
                        html += '<div style="text-align:center;margin:10px 0"><img src="' + quiz.data.q2.image + '" style="max-width:100%;max-height:200px;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,0.1)"></div>';
                    }
                    
                    // Show audio if present
                    if (quiz.data.q2.audio) {
                        html += '<div style="margin:10px 0;background:#e8f5e9;padding:10px;border-radius:6px"><p style="margin:0 0 5px 0;font-size:0.9em;color:#2e7d32">üéµ Audio attached</p><audio controls style="width:100%;max-width:300px"><source src="' + quiz.data.q2.audio + '"></audio></div>';
                    }
                    
                    html += '<p style="margin:0 0 10px 0">' + quiz.data.q2.text + '</p>';
                    html += '<p style="margin:0;color:#4CAF50;font-weight:600">‚úÖ Correct: ' + quiz.data.q2.options[quiz.data.q2.correct] + '</p>';
                    html += '</div>';
                    
                    html += '</div>';
                }
                
                container.innerHTML = html;
                
            } catch (err) {
                console.error('Load all quizzes error:', err);
                container.innerHTML = '<div style="background:#f8d7da;padding:20px;border-radius:8px;text-align:center"><p style="margin:0;color:#721c24">Error loading quizzes: ' + err.message + '</p></div>';
            }
        }
        
        async function publishQuizByDate(date) {
            if (!confirm(`Publish quiz for ${date}?\n\nThis will show the questions and answers publicly for educational review.`)) return;
            
            try {
                await db.ref(`quizPublished/${date}`).set({
                    published: true,
                    publishedAt: new Date().toISOString(),
                    publishedBy: 'Super Admin'
                });
                
                alert('‚úÖ Quiz published successfully!');
                loadAllQuizzes();
            } catch (err) {
                console.error('Publish error:', err);
                alert('‚ùå Error publishing quiz: ' + err.message);
            }
        }
        
        async function unpublishQuizByDate(date) {
            if (!confirm(`Unpublish quiz for ${date}?\n\nThis will hide the answers from public view.`)) return;
            
            try {
                await db.ref(`quizPublished/${date}`).set({
                    published: false,
                    unpublishedAt: new Date().toISOString(),
                    unpublishedBy: 'Super Admin'
                });
                
                alert('‚úÖ Quiz unpublished successfully!');
                loadAllQuizzes();
            } catch (err) {
                console.error('Unpublish error:', err);
                alert('‚ùå Error unpublishing quiz: ' + err.message);
            }
        }
        
        function removeExistingMedia(question, type) {
            const previewId = `quiz_${question}${type === 'image' ? 'Image' : 'Audio'}Preview`;
            const confirmMsg = `Remove this ${type} from Question ${question === 'q1' ? '1' : '2'}?`;
            
            if (confirm(confirmMsg)) {
                // Mark for deletion
                if (question === 'q1' && type === 'image') {
                    window.editingQuizData.deleteQ1Image = true;
                } else if (question === 'q1' && type === 'audio') {
                    window.editingQuizData.deleteQ1Audio = true;
                } else if (question === 'q2' && type === 'image') {
                    window.editingQuizData.deleteQ2Image = true;
                } else if (question === 'q2' && type === 'audio') {
                    window.editingQuizData.deleteQ2Audio = true;
                }
                
                // Clear the preview
                document.getElementById(previewId).innerHTML = `<p style="color:#28a745;font-weight:600">‚úì ${type.charAt(0).toUpperCase() + type.slice(1)} will be removed when you save</p>`;
            }
        }
        
        async function editQuizByDate(date) {
            try {
                // Load the quiz data
                const snap = await db.ref(`quizQuestions/${date}`).once('value');
                const quizData = snap.val();
                
                if (!quizData) {
                    alert('‚ùå Quiz not found!');
                    return;
                }
                
                // Switch to Questions tab
                showQuizManagementTab('questions');
                
                // Set the date selector
                document.getElementById('quizDateSelector').value = date;
                
                // Populate the form with existing data
                document.getElementById('quiz_q1Text').value = (quizData.q1 && quizData.q1.text) || '';
                document.getElementById('quiz_q1OptA').value = (quizData.q1 && quizData.q1.options && quizData.q1.options.A) || '';
                document.getElementById('quiz_q1OptB').value = (quizData.q1 && quizData.q1.options && quizData.q1.options.B) || '';
                document.getElementById('quiz_q1OptC').value = (quizData.q1 && quizData.q1.options && quizData.q1.options.C) || '';
                document.getElementById('quiz_q1OptD').value = (quizData.q1 && quizData.q1.options && quizData.q1.options.D) || '';
                document.getElementById('quiz_q1Correct').value = (quizData.q1 && quizData.q1.correct) || '';
                
                document.getElementById('quiz_q2Text').value = (quizData.q2 && quizData.q2.text) || '';
                document.getElementById('quiz_q2OptA').value = (quizData.q2 && quizData.q2.options && quizData.q2.options.A) || '';
                document.getElementById('quiz_q2OptB').value = (quizData.q2 && quizData.q2.options && quizData.q2.options.B) || '';
                document.getElementById('quiz_q2OptC').value = (quizData.q2 && quizData.q2.options && quizData.q2.options.C) || '';
                document.getElementById('quiz_q2OptD').value = (quizData.q2 && quizData.q2.options && quizData.q2.options.D) || '';
                document.getElementById('quiz_q2Correct').value = (quizData.q2 && quizData.q2.correct) || '';
                
                // Clear previous previews
                document.getElementById('quiz_q1ImagePreview').innerHTML = '';
                document.getElementById('quiz_q1AudioPreview').innerHTML = '';
                document.getElementById('quiz_q2ImagePreview').innerHTML = '';
                document.getElementById('quiz_q2AudioPreview').innerHTML = '';
                
                // Store existing media in global variables for deletion tracking
                window.editingQuizData = {
                    q1Image: (quizData.q1 && quizData.q1.image) || null,
                    q1Audio: (quizData.q1 && quizData.q1.audio) || null,
                    q2Image: (quizData.q2 && quizData.q2.image) || null,
                    q2Audio: (quizData.q2 && quizData.q2.audio) || null,
                    deleteQ1Image: false,
                    deleteQ1Audio: false,
                    deleteQ2Image: false,
                    deleteQ2Audio: false
                };
                
                // Show image previews if images exist
                if (quizData.q1 && quizData.q1.image) {
                    document.getElementById('quiz_q1ImagePreview').innerHTML = `
                        <div style="position:relative;display:inline-block">
                            <img src="${quizData.q1.image}" style="max-width:300px;max-height:200px;border-radius:8px;box-shadow:0 4px 10px rgba(0,0,0,0.1)">
                            <p style="margin-top:5px;color:#666;font-size:0.9em">Current image</p>
                            <button type="button" class="btn btn-danger btn-small" onclick="removeExistingMedia('q1', 'image')" style="margin-top:5px">üóëÔ∏è Remove Image</button>
                            <p style="margin-top:5px;color:#999;font-size:0.85em">Or upload a new one below to replace it</p>
                        </div>
                    `;
                }
                
                if (quizData.q2 && quizData.q2.image) {
                    document.getElementById('quiz_q2ImagePreview').innerHTML = `
                        <div style="position:relative;display:inline-block">
                            <img src="${quizData.q2.image}" style="max-width:300px;max-height:200px;border-radius:8px;box-shadow:0 4px 10px rgba(0,0,0,0.1)">
                            <p style="margin-top:5px;color:#666;font-size:0.9em">Current image</p>
                            <button type="button" class="btn btn-danger btn-small" onclick="removeExistingMedia('q2', 'image')" style="margin-top:5px">üóëÔ∏è Remove Image</button>
                            <p style="margin-top:5px;color:#999;font-size:0.85em">Or upload a new one below to replace it</p>
                        </div>
                    `;
                }
                
                // Show audio previews if audio exists
                if (quizData.q1 && quizData.q1.audio) {
                    document.getElementById('quiz_q1AudioPreview').innerHTML = `
                        <div style="background:#f0f0f0;padding:15px;border-radius:8px;display:inline-block">
                            <p style="margin:0 0 5px 0;color:#666;font-size:0.9em">Current audio</p>
                            <audio controls style="max-width:300px">
                                <source src="${quizData.q1.audio}">
                            </audio>
                            <div style="margin-top:10px">
                                <button type="button" class="btn btn-danger btn-small" onclick="removeExistingMedia('q1', 'audio')">üóëÔ∏è Remove Audio</button>
                            </div>
                            <p style="margin-top:5px;color:#999;font-size:0.85em">Or upload a new one below to replace it</p>
                        </div>
                    `;
                }
                
                if (quizData.q2 && quizData.q2.audio) {
                    document.getElementById('quiz_q2AudioPreview').innerHTML = `
                        <div style="background:#f0f0f0;padding:15px;border-radius:8px;display:inline-block">
                            <p style="margin:0 0 5px 0;color:#666;font-size:0.9em">Current audio</p>
                            <audio controls style="max-width:300px">
                                <source src="${quizData.q2.audio}">
                            </audio>
                            <div style="margin-top:10px">
                                <button type="button" class="btn btn-danger btn-small" onclick="removeExistingMedia('q2', 'audio')">üóëÔ∏è Remove Audio</button>
                            </div>
                            <p style="margin-top:5px;color:#999;font-size:0.85em">Or upload a new one below to replace it</p>
                        </div>
                    `;
                }
                
                // Update the heading
                const dateObj = new Date(date);
                const dateStr = dateObj.toLocaleDateString('en-IN', {
                    weekday: 'long',
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
                document.getElementById('quizQuestionsHeading').textContent = `Edit Quiz for ${dateStr} (2 Questions)`;
                
                // Show success message
                showQuizMsg('quizAdminMessage', `‚úèÔ∏è Editing quiz for ${date}. Make your changes and click Save.`, 'success');
                
                // Scroll to top
                window.scrollTo({ top: 0, behavior: 'smooth' });
                
            } catch (err) {
                console.error('Edit quiz error:', err);
                alert('‚ùå Error loading quiz for editing: ' + err.message);
            }
        }
        
        async function deleteQuizByDate(date) {
            if (!confirm(`‚ö†Ô∏è DELETE QUIZ FOR ${date}?\n\nThis will permanently delete:\n- Questions\n- All submissions\n- Results\n- Publish status\n\nThis action CANNOT be undone!\n\nAre you sure?`)) return;
            
            // Double confirmation for safety
            if (!confirm(`FINAL CONFIRMATION\n\nYou are about to permanently delete the quiz for ${date}.\n\nType YES in the next prompt to confirm.`)) return;
            
            const confirmation = prompt('Type YES (in capital letters) to confirm deletion:');
            if (confirmation !== 'YES') {
                alert('Deletion cancelled.');
                return;
            }
            
            try {
                // Delete all related data
                await Promise.all([
                    db.ref(`quizQuestions/${date}`).remove(),
                    db.ref(`quizSubmissions/${date}`).remove(),
                    db.ref(`quizResults/${date}`).remove(),
                    db.ref(`quizPublished/${date}`).remove()
                ]);
                
                alert('‚úÖ Quiz deleted successfully!');
                loadAllQuizzes();
            } catch (err) {
                console.error('Delete error:', err);
                alert('‚ùå Error deleting quiz: ' + err.message);
            }
        }
        
        async function saveQuizQuestionsFromAdmin() {
            // Get selected date
            const selectedDate = document.getElementById('quizDateSelector').value;
            if (!selectedDate) {
                alert('‚ö†Ô∏è Please select a date first!');
                showQuizMsg('quizAdminMessage', '‚ö†Ô∏è Please select a date first!', 'error');
                return;
            }
            
            const q1Text = document.getElementById('quiz_q1Text').value.trim();
            const q1OptA = document.getElementById('quiz_q1OptA').value.trim();
            const q1OptB = document.getElementById('quiz_q1OptB').value.trim();
            const q1OptC = document.getElementById('quiz_q1OptC').value.trim();
            const q1OptD = document.getElementById('quiz_q1OptD').value.trim();
            const q1Correct = document.getElementById('quiz_q1Correct').value;
            
            const q2Text = document.getElementById('quiz_q2Text').value.trim();
            const q2OptA = document.getElementById('quiz_q2OptA').value.trim();
            const q2OptB = document.getElementById('quiz_q2OptB').value.trim();
            const q2OptC = document.getElementById('quiz_q2OptC').value.trim();
            const q2OptD = document.getElementById('quiz_q2OptD').value.trim();
            const q2Correct = document.getElementById('quiz_q2Correct').value;
            
            console.log('Saving questions for date:', selectedDate, {q1Text, q1Correct, q2Text, q2Correct});
            
            if (!q1Text || !q1OptA || !q1OptB || !q1OptC || !q1OptD || !q1Correct) {
                alert('‚ö†Ô∏è Please fill all Question 1 fields!');
                showQuizMsg('quizAdminMessage', '‚ö†Ô∏è Fill all Question 1 fields!', 'error');
                return;
            }
            
            if (!q2Text || !q2OptA || !q2OptB || !q2OptC || !q2OptD || !q2Correct) {
                alert('‚ö†Ô∏è Please fill all Question 2 fields!');
                showQuizMsg('quizAdminMessage', '‚ö†Ô∏è Fill all Question 2 fields!', 'error');
                return;
            }
            
            // Get image and audio files
            const q1ImageFile = document.getElementById('quiz_q1Image').files[0];
            const q1AudioFile = document.getElementById('quiz_q1Audio').files[0];
            const q2ImageFile = document.getElementById('quiz_q2Image').files[0];
            const q2AudioFile = document.getElementById('quiz_q2Audio').files[0];
            
            const data = {
                q1: {
                    text: q1Text, 
                    options: {A:q1OptA, B:q1OptB, C:q1OptC, D:q1OptD}, 
                    correct: q1Correct
                },
                q2: {
                    text: q2Text, 
                    options: {A:q2OptA, B:q2OptB, C:q2OptC, D:q2OptD}, 
                    correct: q2Correct
                },
                createdAt: new Date().toISOString(),
                createdBy: 'Super Admin',
                quizDate: selectedDate
            };
            
            try {
                // Check if editing existing quiz (to preserve media if not replaced)
                const existingSnap = await db.ref(`quizQuestions/${selectedDate}`).once('value');
                const existingData = existingSnap.val();
                
                // Check if we're in edit mode with deletion tracking
                const editData = window.editingQuizData || {};
                
                // Convert images and audio to base64 if present, otherwise preserve existing (unless marked for deletion)
                if (q1ImageFile) {
                    data.q1.image = await fileToBase64(q1ImageFile);
                } else if (existingData && existingData.q1 && existingData.q1.image && !editData.deleteQ1Image) {
                    data.q1.image = existingData.q1.image; // Preserve existing image
                }
                // If deleteQ1Image is true, we simply don't add the image property
                
                if (q1AudioFile) {
                    data.q1.audio = await fileToBase64(q1AudioFile);
                } else if (existingData && existingData.q1 && existingData.q1.audio && !editData.deleteQ1Audio) {
                    data.q1.audio = existingData.q1.audio; // Preserve existing audio
                }
                
                if (q2ImageFile) {
                    data.q2.image = await fileToBase64(q2ImageFile);
                } else if (existingData && existingData.q2 && existingData.q2.image && !editData.deleteQ2Image) {
                    data.q2.image = existingData.q2.image; // Preserve existing image
                }
                
                if (q2AudioFile) {
                    data.q2.audio = await fileToBase64(q2AudioFile);
                } else if (existingData && existingData.q2 && existingData.q2.audio && !editData.deleteQ2Audio) {
                    data.q2.audio = existingData.q2.audio; // Preserve existing audio
                }
                
                // Clear editing data after save
                window.editingQuizData = null;
                
                console.log('Attempting to save to Firebase...', data);
                await db.ref(`quizQuestions/${selectedDate}`).set(data);
                
                // SUCCESS POPUP!
                alert(`‚úÖ Questions Saved Successfully for ${selectedDate}!\n\nThe quiz will be automatically available to students on this date.\n\nQuestions preview will be shown below.`);
                
                showQuizMsg('quizAdminMessage', `‚úÖ Questions saved successfully for ${selectedDate} with media! Preview shown below.`, 'success');
                
                // Automatically show the questions preview
                displaySavedQuestionsPreview(data);
                
                // Clear form
                ['quiz_q1Text','quiz_q1OptA','quiz_q1OptB','quiz_q1OptC','quiz_q1OptD','quiz_q1Correct','quiz_q2Text','quiz_q2OptA','quiz_q2OptB','quiz_q2OptC','quiz_q2OptD','quiz_q2Correct'].forEach(id => {
                    const el = document.getElementById(id);
                    if (el) el.value = '';
                });
                ['quiz_q1Image','quiz_q1Audio','quiz_q2Image','quiz_q2Audio'].forEach(id => {
                    const el = document.getElementById(id);
                    if (el) el.value = '';
                });
                ['quiz_q1ImagePreview','quiz_q1AudioPreview','quiz_q2ImagePreview','quiz_q2AudioPreview'].forEach(id => {
                    const el = document.getElementById(id);
                    if (el) el.innerHTML = '';
                });
                
                await loadQuizManagementStats();
                console.log('Questions saved successfully for date:', selectedDate);
            } catch (err) {
                console.error('Save error:', err);
                alert('‚ùå Error saving questions: ' + err.message);
                showQuizMsg('quizAdminMessage', 'Error saving questions: ' + err.message, 'error');
            }
        }
        
        function displaySavedQuestionsPreview(data) {
            const view = document.getElementById('todayQuestionsViewAdmin');
            
            const createdDate = new Date(data.createdAt);
            const dateStr = createdDate.toLocaleDateString('en-IN', { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
            const timeStr = createdDate.toLocaleTimeString('en-IN', { 
                hour: '2-digit', 
                minute: '2-digit',
                second: '2-digit'
            });
            
            let html = '<div style="background:#f8f9fa;padding:25px;border-radius:10px;margin-top:20px;border:3px solid #28a745">';
            html += '<h3 style="color:#28a745;margin-bottom:10px;text-align:center">‚úÖ Questions Saved Successfully - Preview</h3>';
            html += `<p style="text-align:center;color:#666;font-size:0.95em;margin-bottom:20px">üìÖ ${dateStr} | ‚è∞ ${timeStr}</p>`;
            
            // Question 1
            html += '<div style="background:white;padding:20px;border-radius:8px;margin-bottom:20px;border-left:5px solid #667eea">';
            html += '<h4 style="color:#667eea;margin-bottom:15px">üìù Question 1</h4>';
            
            // Show image if present
            if (data.q1.image) {
                html += '<div style="text-align:center;margin:15px 0"><img src="' + data.q1.image + '" style="max-width:100%;max-height:250px;border-radius:8px;box-shadow:0 4px 12px rgba(0,0,0,0.15)"></div>';
            }
            
            // Show audio if present
            if (data.q1.audio) {
                html += '<div style="margin:15px 0;background:#e8f5e9;padding:15px;border-radius:8px"><p style="margin:0 0 8px 0;font-weight:600;color:#2e7d32">üéµ Audio Question</p><audio controls style="width:100%;max-width:400px"><source src="' + data.q1.audio + '"></audio></div>';
            }
            
            html += `<p style="font-size:1.1em;font-weight:600;margin-bottom:15px">${data.q1.text}</p>`;
            html += `<p style="margin-left:20px;padding:8px;background:${data.q1.correct === 'A' ? '#d4edda' : '#f8f9fa'};border-radius:4px">A) ${data.q1.options.A} ${data.q1.correct === 'A' ? '‚úÖ' : ''}</p>`;
            html += `<p style="margin-left:20px;padding:8px;background:${data.q1.correct === 'B' ? '#d4edda' : '#f8f9fa'};border-radius:4px">B) ${data.q1.options.B} ${data.q1.correct === 'B' ? '‚úÖ' : ''}</p>`;
            html += `<p style="margin-left:20px;padding:8px;background:${data.q1.correct === 'C' ? '#d4edda' : '#f8f9fa'};border-radius:4px">C) ${data.q1.options.C} ${data.q1.correct === 'C' ? '‚úÖ' : ''}</p>`;
            html += `<p style="margin-left:20px;padding:8px;background:${data.q1.correct === 'D' ? '#d4edda' : '#f8f9fa'};border-radius:4px">D) ${data.q1.options.D} ${data.q1.correct === 'D' ? '‚úÖ' : ''}</p>`;
            html += `<p style="color:#28a745;font-weight:bold;margin-top:15px;font-size:1.1em">‚úì Correct Answer: ${data.q1.correct}</p>`;
            html += '</div>';
            
            // Question 2
            html += '<div style="background:white;padding:20px;border-radius:8px;border-left:5px solid #667eea">';
            html += '<h4 style="color:#667eea;margin-bottom:15px">üìù Question 2</h4>';
            
            // Show image if present
            if (data.q2.image) {
                html += '<div style="text-align:center;margin:15px 0"><img src="' + data.q2.image + '" style="max-width:100%;max-height:250px;border-radius:8px;box-shadow:0 4px 12px rgba(0,0,0,0.15)"></div>';
            }
            
            // Show audio if present
            if (data.q2.audio) {
                html += '<div style="margin:15px 0;background:#e8f5e9;padding:15px;border-radius:8px"><p style="margin:0 0 8px 0;font-weight:600;color:#2e7d32">üéµ Audio Question</p><audio controls style="width:100%;max-width:400px"><source src="' + data.q2.audio + '"></audio></div>';
            }
            
            html += `<p style="font-size:1.1em;font-weight:600;margin-bottom:15px">${data.q2.text}</p>`;
            html += `<p style="margin-left:20px;padding:8px;background:${data.q2.correct === 'A' ? '#d4edda' : '#f8f9fa'};border-radius:4px">A) ${data.q2.options.A} ${data.q2.correct === 'A' ? '‚úÖ' : ''}</p>`;
            html += `<p style="margin-left:20px;padding:8px;background:${data.q2.correct === 'B' ? '#d4edda' : '#f8f9fa'};border-radius:4px">B) ${data.q2.options.B} ${data.q2.correct === 'B' ? '‚úÖ' : ''}</p>`;
            html += `<p style="margin-left:20px;padding:8px;background:${data.q2.correct === 'C' ? '#d4edda' : '#f8f9fa'};border-radius:4px">C) ${data.q2.options.C} ${data.q2.correct === 'C' ? '‚úÖ' : ''}</p>`;
            html += `<p style="margin-left:20px;padding:8px;background:${data.q2.correct === 'D' ? '#d4edda' : '#f8f9fa'};border-radius:4px">D) ${data.q2.options.D} ${data.q2.correct === 'D' ? '‚úÖ' : ''}</p>`;
            html += `<p style="color:#28a745;font-weight:bold;margin-top:15px;font-size:1.1em">‚úì Correct Answer: ${data.q2.correct}</p>`;
            html += '</div>';
            
            html += `<p style="text-align:center;margin-top:20px;color:#666"><small>Created by: ${data.createdBy || 'Super Admin'}</small></p>`;
            html += '</div>';
            
            view.innerHTML = html;
            view.style.display = 'block';
            
            // Scroll to preview
            view.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }
        
        async function viewTodayQuestionsAdmin() {
            const today = getQuizToday();
            try {
                const snap = await db.ref(`quizQuestions/${today}`).once('value');
                const q = snap.val();
                const view = document.getElementById('todayQuestionsViewAdmin');
                
                if (!q) {
                    view.innerHTML = '<div style="background:#fff3cd;padding:15px;border-radius:8px"><p style="margin:0;color:#856404">No questions for today yet.</p></div>';
                    view.style.display = 'block';
                    return;
                }
                
                const createdDate = new Date(q.createdAt);
                const dateStr = createdDate.toLocaleDateString('en-IN', { 
                    weekday: 'long', 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric' 
                });
                const timeStr = createdDate.toLocaleTimeString('en-IN', { 
                    hour: '2-digit', 
                    minute: '2-digit',
                    second: '2-digit'
                });
                
                let html = '<div style="background:#f8f9fa;padding:20px;border-radius:10px">';
                html += '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:15px">';
                html += '<h4 style="color:#667eea;margin:0">Today\'s Questions</h4>';
                html += '<button class="btn btn-small" onclick="editTodayQuestions()" style="background:#ff9800;color:white">‚úèÔ∏è Edit Questions</button>';
                html += '</div>';
                html += `<p style="color:#666;font-size:0.95em;margin-bottom:15px">üìÖ ${dateStr} | ‚è∞ ${timeStr}</p>`;
                html += `<p><strong>Q1:</strong> ${q.q1.text}</p>`;
                html += `<p style="margin-left:20px">A) ${q.q1.options.A}</p>`;
                html += `<p style="margin-left:20px">B) ${q.q1.options.B}</p>`;
                html += `<p style="margin-left:20px">C) ${q.q1.options.C}</p>`;
                html += `<p style="margin-left:20px">D) ${q.q1.options.D}</p>`;
                html += `<p style="color:green;font-weight:bold;margin-left:20px">‚úì Correct: ${q.q1.correct}</p><br>`;
                html += `<p><strong>Q2:</strong> ${q.q2.text}</p>`;
                html += `<p style="margin-left:20px">A) ${q.q2.options.A}</p>`;
                html += `<p style="margin-left:20px">B) ${q.q2.options.B}</p>`;
                html += `<p style="margin-left:20px">C) ${q.q2.options.C}</p>`;
                html += `<p style="margin-left:20px">D) ${q.q2.options.D}</p>`;
                html += `<p style="color:green;font-weight:bold;margin-left:20px">‚úì Correct: ${q.q2.correct}</p>`;
                html += `<p style="text-align:center;margin-top:15px;color:#666"><small>Created by: ${q.createdBy || 'Super Admin'}</small></p>`;
                html += '</div>';
                
                view.innerHTML = html;
                view.style.display = 'block';
                
                // Check and show publish status
                await checkPublishStatusForAdmin();
            } catch (err) {
                console.error('View error:', err);
            }
        }
        
        async function editTodayQuestions() {
            const today = getQuizToday();
            try {
                const snap = await db.ref(`quizQuestions/${today}`).once('value');
                const q = snap.val();
                
                if (!q) {
                    alert('No questions found to edit!');
                    return;
                }
                
                // Populate the form with existing data
                document.getElementById('quiz_q1Text').value = q.q1.text;
                document.getElementById('quiz_q1OptA').value = q.q1.options.A;
                document.getElementById('quiz_q1OptB').value = q.q1.options.B;
                document.getElementById('quiz_q1OptC').value = q.q1.options.C;
                document.getElementById('quiz_q1OptD').value = q.q1.options.D;
                document.getElementById('quiz_q1Correct').value = q.q1.correct;
                
                document.getElementById('quiz_q2Text').value = q.q2.text;
                document.getElementById('quiz_q2OptA').value = q.q2.options.A;
                document.getElementById('quiz_q2OptB').value = q.q2.options.B;
                document.getElementById('quiz_q2OptC').value = q.q2.options.C;
                document.getElementById('quiz_q2OptD').value = q.q2.options.D;
                document.getElementById('quiz_q2Correct').value = q.q2.correct;
                
                // Scroll to the form
                document.getElementById('quiz_q1Text').scrollIntoView({ behavior: 'smooth', block: 'center' });
                
                // Show message
                showQuizMsg('quizAdminMessage', '‚úèÔ∏è Questions loaded for editing. Make changes and click Save.', 'success');
                
            } catch (err) {
                console.error('Edit error:', err);
                alert('Error loading questions for editing: ' + err.message);
            }
        }
        
        async function loadQuizStudentsAdmin() {
            try {
                const snap = await db.ref('quizStudents').once('value');
                const tbody = document.getElementById('quizStudentsTableAdmin');
                tbody.innerHTML = '';
                
                if (!snap.exists()) {
                    tbody.innerHTML = '<tr><td colspan="7" style="text-align:center">No students registered yet.</td></tr>';
                    return;
                }
                
                let idx = 1;
                snap.forEach(child => {
                    const s = child.val();
                    const row = tbody.insertRow();
                    row.innerHTML = `<td>${idx++}</td><td>${s.name}</td><td>${s.email}</td><td>${s.phone}</td><td style="background:#fff3cd;font-family:monospace;font-weight:bold">${s.password}</td><td>${s.class}</td><td>${new Date(s.registeredAt).toLocaleDateString()}</td>`;
                });
            } catch (err) {
                console.error('Load students error:', err);
            }
        }
        
        async function loadQuizSubmissionsAdmin() {
            const today = getQuizToday();
            try {
                const snap = await db.ref(`quizSubmissions/${today}`).once('value');
                const tbody = document.getElementById('quizSubmissionsTableAdmin');
                tbody.innerHTML = '';
                
                if (!snap.exists()) {
                    tbody.innerHTML = '<tr><td colspan="7" style="text-align:center">No submissions yet today.</td></tr>';
                    return;
                }
                
                let idx = 1;
                snap.forEach(child => {
                    const s = child.val();
                    const row = tbody.insertRow();
                    const mins = Math.floor(s.timeTaken / 60);
                    const secs = s.timeTaken % 60;
                    row.innerHTML = `<td>${idx++}</td><td>${s.studentName}</td><td>${s.studentEmail}</td><td>${s.studentClass}</td><td>${new Date(s.submittedAt).toLocaleString()}</td><td><strong>${s.score}/2</strong></td><td>${mins}m ${secs}s</td>`;
                });
            } catch (err) {
                console.error('Load submissions error:', err);
            }
        }
        
        async function loadQuizResultsAdmin() {
            const today = getQuizToday();
            try {
                const snap = await db.ref(`quizSubmissions/${today}`).once('value');
                
                if (!snap.exists()) {
                    document.getElementById('resultTotalPartAdmin').textContent = '0';
                    document.getElementById('resultBothCorrectAdmin').textContent = '0';
                    document.getElementById('resultEligibleAdmin').textContent = '0';
                    return;
                }
                
                let total = 0, correct = 0;
                snap.forEach(child => {
                    total++;
                    if (child.val().score === 2) correct++;
                });
                
                document.getElementById('resultTotalPartAdmin').textContent = total;
                document.getElementById('resultBothCorrectAdmin').textContent = correct;
                document.getElementById('resultEligibleAdmin').textContent = correct;
                
                const resSnap = await db.ref(`quizResults/${today}`).once('value');
                if (resSnap.exists()) {
                    displayQuizWinnersAdmin(resSnap.val());
                }
            } catch (err) {
                console.error('Load results error:', err);
            }
        }
        
        async function selectQuizWinnersFromAdmin() {
            const today = getQuizToday();
            try {
                const snap = await db.ref(`quizSubmissions/${today}`).once('value');
                const eligible = [];
                snap.forEach(child => {
                    if (child.val().score === 2) eligible.push(child.val());
                });
                
                if (eligible.length === 0) {
                    showQuizMsg('quizAdminMessage', '‚ö†Ô∏è No correct answers yet!', 'warning');
                    return;
                }
                
                if (eligible.length === 1) {
                    showQuizMsg('quizAdminMessage', '‚ö†Ô∏è Only one correct. Need 2 for winner & runner-up.', 'warning');
                    return;
                }
                
                const shuffled = eligible.sort(() => 0.5 - Math.random());
                const winner = shuffled[0];
                const runnerUp = shuffled[1];
                
                const data = {
                    winner: {name: winner.studentName, email: winner.studentEmail, class: winner.studentClass, score: winner.score},
                    runnerUp: {name: runnerUp.studentName, email: runnerUp.studentEmail, class: runnerUp.studentClass, score: runnerUp.score},
                    declaredAt: new Date().toISOString(),
                    declaredBy: 'Super Admin',
                    totalEligible: eligible.length
                };
                
                await db.ref(`quizResults/${today}`).set(data);
                
                // Try to send emails but don't block winner declaration
                try {
                    await sendQuizEmail(winner.studentEmail, 'üèÜ You Won Quiz!', `Dear ${winner.studentName},\n\nCongratulations! You are the WINNER of today's Daily Quiz Competition!\n\nScore: ${winner.score}/2\nClass: ${winner.studentClass}\n\nWell done!\n\nDavan Institute`);
                } catch (e) { console.log('Winner email failed:', e); }
                
                try {
                    await sendQuizEmail(runnerUp.studentEmail, 'ü•à Runner-Up!', `Dear ${runnerUp.studentName},\n\nCongratulations! You are the RUNNER-UP!\n\nScore: ${runnerUp.score}/2\nClass: ${runnerUp.studentClass}\n\nGreat job!\n\nDavan Institute`);
                } catch (e) { console.log('Runner-up email failed:', e); }
                
                showQuizMsg('quizAdminMessage', '‚úÖ Winners selected! Check Firebase for email logs.', 'success');
                displayQuizWinnersAdmin(data);
            } catch (err) {
                console.error('Select winners error:', err);
                showQuizMsg('quizAdminMessage', 'Error selecting winners.', 'error');
            }
        }
        
        function displayQuizWinnersAdmin(data) {
            const div = document.getElementById('winnersDisplayAdmin');
            let html = '<div style="background:#f8f9fa;padding:25px;border-radius:12px">';
            html += '<h3 style="color:#667eea;margin-bottom:20px;text-align:center">üéâ Today\'s Winners</h3>';
            html += '<div style="background:linear-gradient(135deg,#ffd700 0%,#ffed4e 100%);padding:20px;border-radius:10px;margin-bottom:15px;color:#333">';
            html += '<h4>üèÜ WINNER</h4>';
            html += `<p><strong>Name:</strong> ${data.winner.name}</p>`;
            html += `<p><strong>Email:</strong> ${data.winner.email}</p>`;
            html += `<p><strong>Class:</strong> ${data.winner.class}</p>`;
            html += `<p><strong>Score:</strong> ${data.winner.score}/2</p></div>`;
            html += '<div style="background:linear-gradient(135deg,#c0c0c0 0%,#e8e8e8 100%);padding:20px;border-radius:10px;color:#333">';
            html += '<h4>ü•à RUNNER-UP</h4>';
            html += `<p><strong>Name:</strong> ${data.runnerUp.name}</p>`;
            html += `<p><strong>Email:</strong> ${data.runnerUp.email}</p>`;
            html += `<p><strong>Class:</strong> ${data.runnerUp.class}</p>`;
            html += `<p><strong>Score:</strong> ${data.runnerUp.score}/2</p></div>`;
            html += `<p style="text-align:center;margin-top:20px;color:#666"><small>Declared: ${new Date(data.declaredAt).toLocaleString()}</small></p></div>`;
            div.innerHTML = html;
            div.style.display = 'block';
        }
        
        // ============================================
        // NEW PUBLISH/UNPUBLISH FUNCTIONS
        // ============================================
        
        async function checkPublishStatusForToday() {
            const today = getQuizToday();
            console.log('checkPublishStatusForToday called for:', today);
            try {
                const qSnap = await db.ref(`quizQuestions/${today}`).once('value');
                if (!qSnap.exists()) {
                    console.log('No questions exist for today');
                    document.getElementById('publishControlSection').style.display = 'none';
                    return;
                }
                
                const pSnap = await db.ref(`quizPublished/${today}`).once('value');
                const publishData = pSnap.val();
                const isPublished = publishData && publishData.published === true;
                
                console.log('Publish data (Today):', JSON.stringify(publishData));
                console.log('Is published (Today):', isPublished);
                
                const publishControlSection = document.getElementById('publishControlSection');
                const statusDiv = document.getElementById('publishStatusDisplay');
                const btnPub = document.getElementById('btnPublish');
                const btnUnpub = document.getElementById('btnUnpublish');
                
                if (!publishControlSection || !statusDiv || !btnPub || !btnUnpub) {
                    console.error('Could not find required elements (Today tab)');
                    return;
                }
                
                publishControlSection.style.display = 'block';
                
                if (isPublished) {
                    console.log('Showing UNPUBLISH button (Today tab)');
                    statusDiv.innerHTML = '<div style="background:#d4edda;padding:15px;border-radius:8px;border:2px solid #28a745"><p style="margin:0;color:#155724;font-weight:bold">‚úÖ Quiz is PUBLISHED - Students can see it</p><p style="margin:5px 0 0 0;color:#155724;font-size:13px">Published: ' + new Date(publishData.publishedAt).toLocaleString() + '</p></div>';
                    btnPub.style.display = 'none';
                    btnUnpub.style.display = 'inline-block';
                } else {
                    console.log('Showing PUBLISH button (Today tab)');
                    statusDiv.innerHTML = '<div style="background:#fff3cd;padding:15px;border-radius:8px;border:2px solid #ffc107"><p style="margin:0;color:#856404;font-weight:bold">‚ö†Ô∏è Quiz is DRAFT - Not visible to students</p><p style="margin:5px 0 0 0;color:#856404;font-size:13px">Click PUBLISH to make it visible</p></div>';
                    btnPub.style.display = 'inline-block';
                    btnUnpub.style.display = 'none';
                }
            } catch (err) {
                console.error('Check publish error (Today):', err);
            }
        }
        
        async function publishTodayQuiz() {
            const today = getQuizToday();
            if (!confirm('Publish today\'s quiz? Students will be able to see and attempt it.')) return;
            
            console.log('=== PUBLISH STARTED ===');
            console.log('Today:', today);
            console.log('Current user:', quizCurrentUser);
            
            try {
                const qSnap = await db.ref(`quizQuestions/${today}`).once('value');
                if (!qSnap.exists()) {
                    showQuizMsg('quizAdminDashMessage', '‚ö†Ô∏è No questions saved for today!', 'error');
                    return;
                }
                
                // Get the email safely
                const userEmail = quizCurrentUser ? quizCurrentUser.email : 'admin@system';
                console.log('Using email:', userEmail);
                
                // Write to database and wait for completion
                await db.ref(`quizPublished/${today}`).set({
                    published: true,
                    publishedAt: new Date().toISOString(),
                    publishedBy: userEmail
                });
                
                console.log('Firebase write completed');
                
                // Verify the write
                const verifySnap = await db.ref(`quizPublished/${today}`).once('value');
                const publishData = verifySnap.val();
                console.log('Verification read:', JSON.stringify(publishData));
                
                showQuizMsg('quizAdminDashMessage', '‚úÖ Quiz published successfully!', 'success');
                
                // Direct DOM manipulation - force the UI to update immediately
                const statusDivAdmin = document.getElementById('publishStatusDisplayAdmin');
                const btnPubAdmin = document.getElementById('btnPublishAdmin');
                const btnUnpubAdmin = document.getElementById('btnUnpublishAdmin');
                
                const statusDiv = document.getElementById('publishStatusDisplay');
                const btnPub = document.getElementById('btnPublish');
                const btnUnpub = document.getElementById('btnUnpublish');
                
                console.log('Found elements:');
                console.log('  statusDivAdmin:', !!statusDivAdmin);
                console.log('  btnPubAdmin:', !!btnPubAdmin);
                console.log('  btnUnpubAdmin:', !!btnUnpubAdmin);
                console.log('  statusDiv:', !!statusDiv);
                console.log('  btnPub:', !!btnPub);
                console.log('  btnUnpub:', !!btnUnpub);
                
                // Update Admin Dashboard
                if (statusDivAdmin && btnPubAdmin && btnUnpubAdmin) {
                    console.log('Updating Admin Dashboard UI directly');
                    statusDivAdmin.innerHTML = '<div style="background:#d4edda;padding:15px;border-radius:8px;border:2px solid #28a745"><p style="margin:0;color:#155724;font-weight:bold">‚úÖ Quiz is PUBLISHED - Students can see it</p><p style="margin:5px 0 0 0;color:#155724;font-size:13px">Published: ' + new Date(publishData.publishedAt).toLocaleString() + '</p></div>';
                    btnPubAdmin.style.display = 'none';
                    btnUnpubAdmin.style.display = 'inline-block';
                    console.log('Admin buttons updated - Publish:', btnPubAdmin.style.display, 'Unpublish:', btnUnpubAdmin.style.display);
                } else {
                    console.log('Could not update Admin Dashboard - elements missing');
                }
                
                // Update Quiz Management Tab
                if (statusDiv && btnPub && btnUnpub) {
                    console.log('Updating Quiz Management Tab UI directly');
                    statusDiv.innerHTML = '<div style="background:#d4edda;padding:15px;border-radius:8px;border:2px solid #28a745"><p style="margin:0;color:#155724;font-weight:bold">‚úÖ Quiz is PUBLISHED - Students can see it</p><p style="margin:5px 0 0 0;color:#155724;font-size:13px">Published: ' + new Date(publishData.publishedAt).toLocaleString() + '</p></div>';
                    btnPub.style.display = 'none';
                    btnUnpub.style.display = 'inline-block';
                    console.log('Quiz tab buttons updated - Publish:', btnPub.style.display, 'Unpublish:', btnUnpub.style.display);
                } else {
                    console.log('Could not update Quiz Management Tab - elements missing');
                }
                
                console.log('=== PUBLISH COMPLETED ===');
            } catch (err) {
                console.error('Publish error:', err);
                console.error('Error stack:', err.stack);
                showQuizMsg('quizAdminDashMessage', '‚ùå Error publishing: ' + err.message, 'error');
            }
        }
        
        async function unpublishTodayQuiz() {
            const today = getQuizToday();
            if (!confirm('Unpublish today\'s quiz? Students will no longer see it.')) return;
            
            console.log('=== UNPUBLISH STARTED ===');
            console.log('Today:', today);
            console.log('Current user:', quizCurrentUser);
            
            try {
                // Get the email safely
                const userEmail = quizCurrentUser ? quizCurrentUser.email : 'admin@system';
                console.log('Using email:', userEmail);
                
                // Write to database and wait for completion
                await db.ref(`quizPublished/${today}`).set({
                    published: false,
                    unpublishedAt: new Date().toISOString(),
                    unpublishedBy: userEmail
                });
                
                console.log('Firebase write completed');
                
                // Verify the write
                const verifySnap = await db.ref(`quizPublished/${today}`).once('value');
                console.log('Verification read:', JSON.stringify(verifySnap.val()));
                
                showQuizMsg('quizAdminDashMessage', '‚úÖ Quiz unpublished successfully!', 'success');
                
                // Direct DOM manipulation - force the UI to update immediately
                const statusDivAdmin = document.getElementById('publishStatusDisplayAdmin');
                const btnPubAdmin = document.getElementById('btnPublishAdmin');
                const btnUnpubAdmin = document.getElementById('btnUnpublishAdmin');
                
                const statusDiv = document.getElementById('publishStatusDisplay');
                const btnPub = document.getElementById('btnPublish');
                const btnUnpub = document.getElementById('btnUnpublish');
                
                console.log('Found elements:');
                console.log('  statusDivAdmin:', !!statusDivAdmin);
                console.log('  btnPubAdmin:', !!btnPubAdmin);
                console.log('  btnUnpubAdmin:', !!btnUnpubAdmin);
                console.log('  statusDiv:', !!statusDiv);
                console.log('  btnPub:', !!btnPub);
                console.log('  btnUnpub:', !!btnUnpub);
                
                // Update Admin Dashboard
                if (statusDivAdmin && btnPubAdmin && btnUnpubAdmin) {
                    console.log('Updating Admin Dashboard UI directly');
                    statusDivAdmin.innerHTML = '<div style="background:#fff3cd;padding:15px;border-radius:8px;border:2px solid #ffc107"><p style="margin:0;color:#856404;font-weight:bold">‚ö†Ô∏è Quiz is DRAFT - Not visible to students</p><p style="margin:5px 0 0 0;color:#856404;font-size:13px">Click PUBLISH to make it visible</p></div>';
                    btnPubAdmin.style.display = 'inline-block';
                    btnUnpubAdmin.style.display = 'none';
                    console.log('Admin buttons updated - Publish:', btnPubAdmin.style.display, 'Unpublish:', btnUnpubAdmin.style.display);
                } else {
                    console.log('Could not update Admin Dashboard - elements missing');
                }
                
                // Update Quiz Management Tab
                if (statusDiv && btnPub && btnUnpub) {
                    console.log('Updating Quiz Management Tab UI directly');
                    statusDiv.innerHTML = '<div style="background:#fff3cd;padding:15px;border-radius:8px;border:2px solid #ffc107"><p style="margin:0;color:#856404;font-weight:bold">‚ö†Ô∏è Quiz is DRAFT - Not visible to students</p><p style="margin:5px 0 0 0;color:#856404;font-size:13px">Click PUBLISH to make it visible</p></div>';
                    btnPub.style.display = 'inline-block';
                    btnUnpub.style.display = 'none';
                    console.log('Quiz tab buttons updated - Publish:', btnPub.style.display, 'Unpublish:', btnUnpub.style.display);
                } else {
                    console.log('Could not update Quiz Management Tab - elements missing');
                }
                
                console.log('=== UNPUBLISH COMPLETED ===');
            } catch (err) {
                console.error('Unpublish error:', err);
                console.error('Error stack:', err.stack);
                showQuizMsg('quizAdminDashMessage', '‚ùå Error unpublishing: ' + err.message, 'error');
            }
        }
        
        async function showTodayAnswers() {
            const today = getQuizToday();
            try {
                const snap = await db.ref(`quizQuestions/${today}`).once('value');
                const q = snap.val();
                
                // Determine which section we're in
                const isAdmin = document.getElementById('publishControlSectionAdmin') && 
                               document.getElementById('publishControlSectionAdmin').style.display !== 'none';
                const divId = isAdmin ? 'answersDisplaySectionAdmin' : 'answersDisplaySection';
                const div = document.getElementById(divId);
                
                if (!div) {
                    console.error('Answers display div not found');
                    alert('Error: Unable to display answers. Please contact support.');
                    return;
                }
                
                if (!q || !q.q1 || !q.q2) {
                    div.innerHTML = '<div style="background:#f8d7da;padding:15px;border-radius:8px"><p style="margin:0;color:#721c24">‚ùå No questions found for today</p></div>';
                    div.style.display = 'block';
                    return;
                }
                
                let html = '<div style="background:#e8f5e9;padding:25px;border-radius:12px;border:3px solid #4CAF50">';
                html += '<h3 style="color:#2e7d32;margin-bottom:20px;text-align:center">üîç Correct Answers</h3>';
                
                html += '<div style="background:white;padding:20px;border-radius:10px;margin-bottom:15px;border-left:5px solid #4CAF50">';
                html += '<h4 style="color:#667eea;margin-bottom:15px">Question 1</h4>';
                html += `<p style="font-weight:600;margin-bottom:10px">${q.q1.text || 'N/A'}</p>`;
                html += `<p style="margin-left:20px;color:#666">A) ${q.q1.options.A || 'N/A'}</p>`;
                html += `<p style="margin-left:20px;color:#666">B) ${q.q1.options.B || 'N/A'}</p>`;
                html += `<p style="margin-left:20px;color:#666">C) ${q.q1.options.C || 'N/A'}</p>`;
                html += `<p style="margin-left:20px;color:#666">D) ${q.q1.options.D || 'N/A'}</p>`;
                html += `<div style="background:#4CAF50;color:white;padding:12px;border-radius:8px;margin-top:15px;font-weight:bold">‚úÖ Correct Answer: ${q.q1.correct}) ${q.q1.options[q.q1.correct] || 'N/A'}</div></div>`;
                
                html += '<div style="background:white;padding:20px;border-radius:10px;border-left:5px solid #4CAF50">';
                html += '<h4 style="color:#667eea;margin-bottom:15px">Question 2</h4>';
                html += `<p style="font-weight:600;margin-bottom:10px">${q.q2.text || 'N/A'}</p>`;
                html += `<p style="margin-left:20px;color:#666">A) ${q.q2.options.A || 'N/A'}</p>`;
                html += `<p style="margin-left:20px;color:#666">B) ${q.q2.options.B || 'N/A'}</p>`;
                html += `<p style="margin-left:20px;color:#666">C) ${q.q2.options.C || 'N/A'}</p>`;
                html += `<p style="margin-left:20px;color:#666">D) ${q.q2.options.D || 'N/A'}</p>`;
                html += `<div style="background:#4CAF50;color:white;padding:12px;border-radius:8px;margin-top:15px;font-weight:bold">‚úÖ Correct Answer: ${q.q2.correct}) ${q.q2.options[q.q2.correct] || 'N/A'}</div></div>`;
                
                html += '<p style="text-align:center;margin-top:20px;color:#666;font-size:14px"><em>Visible to Admin Only</em></p></div>';
                
                div.innerHTML = html;
                div.style.display = 'block';
                
                // Scroll to the answers with a small delay to ensure rendering
                setTimeout(() => {
                    div.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                }, 100);
            } catch (err) {
                console.error('Show answers error:', err);
                const div = document.getElementById('answersDisplaySectionAdmin') || document.getElementById('answersDisplaySection');
                if (div) {
                    div.innerHTML = '<div style="background:#f8d7da;padding:15px;border-radius:8px"><p style="margin:0;color:#721c24">‚ùå Error loading answers: ' + err.message + '</p></div>';
                    div.style.display = 'block';
                }
                alert('Error displaying answers. Please check the console for details.');
            }
        }
        
        // Admin Dashboard specific publish check
        async function checkPublishStatusForAdmin() {
            const today = getQuizToday();
            console.log('=== checkPublishStatusForAdmin START ===');
            console.log('Date:', today);
            
            try {
                const qSnap = await db.ref(`quizQuestions/${today}`).once('value');
                if (!qSnap.exists()) {
                    console.log('No questions exist for today');
                    document.getElementById('publishControlSectionAdmin').style.display = 'none';
                    return;
                }
                
                const pSnap = await db.ref(`quizPublished/${today}`).once('value');
                const publishData = pSnap.val();
                const isPublished = publishData && publishData.published === true;
                
                console.log('Publish data:', publishData);
                console.log('Is published:', isPublished);
                
                const publishControlSection = document.getElementById('publishControlSectionAdmin');
                const statusDiv = document.getElementById('publishStatusDisplayAdmin');
                
                if (!publishControlSection || !statusDiv) {
                    console.error('Could not find required elements');
                    return;
                }
                
                publishControlSection.style.display = 'block';
                
                // Recreate buttons HTML to force update
                const buttonsContainer = publishControlSection.querySelector('div[style*="display:flex"]');
                if (buttonsContainer) {
                    if (isPublished) {
                        console.log('Setting UP: UNPUBLISH button visible');
                        statusDiv.innerHTML = '<div style="background:#d4edda;padding:15px;border-radius:8px;border:2px solid #28a745"><p style="margin:0;color:#155724;font-weight:bold">‚úÖ Quiz is PUBLISHED - Students can see it</p><p style="margin:5px 0 0 0;color:#155724;font-size:13px">Published: ' + new Date(publishData.publishedAt).toLocaleString() + '</p></div>';
                        
                        buttonsContainer.innerHTML = `
                            <button class="btn btn-success" onclick="publishTodayQuiz()" id="btnPublishAdmin" style="display:none">‚úÖ PUBLISH Quiz (Make Live)</button>
                            <button class="btn btn-danger" onclick="unpublishTodayQuiz()" id="btnUnpublishAdmin" style="display:inline-block">‚ùå UNPUBLISH Quiz (Hide)</button>
                        `;
                    } else {
                        console.log('Setting UP: PUBLISH button visible');
                        statusDiv.innerHTML = '<div style="background:#fff3cd;padding:15px;border-radius:8px;border:2px solid #ffc107"><p style="margin:0;color:#856404;font-weight:bold">‚ö†Ô∏è Quiz is DRAFT - Not visible to students</p><p style="margin:5px 0 0 0;color:#856404;font-size:13px">Click PUBLISH to make it visible</p></div>';
                        
                        buttonsContainer.innerHTML = `
                            <button class="btn btn-success" onclick="publishTodayQuiz()" id="btnPublishAdmin" style="display:inline-block">‚úÖ PUBLISH Quiz (Make Live)</button>
                            <button class="btn btn-danger" onclick="unpublishTodayQuiz()" id="btnUnpublishAdmin" style="display:none">‚ùå UNPUBLISH Quiz (Hide)</button>
                        `;
                    }
                    console.log('Buttons HTML updated successfully');
                }
                
                console.log('=== checkPublishStatusForAdmin END ===');
            } catch (err) {
                console.error('Check publish error:', err);
            }
        }
        
        // ============================================
        // QUIZ DATE EDIT FUNCTIONS (Super Admin Only)
        // ============================================
        
        let selectedQuizForDateEdit = null;
        
        async function loadQuizzesForDateEdit() {
            try {
                const snapshot = await db.ref('quizQuestions').once('value');
                const quizzes = snapshot.val() || {};
                const quizListContainer = document.getElementById('quizListForDateEdit');
                
                if (Object.keys(quizzes).length === 0) {
                    quizListContainer.innerHTML = '<p style="text-align:center;color:#666;">No quizzes available to edit.</p>';
                    return;
                }
                
                let html = '';
                // Sort by date descending
                Object.entries(quizzes).sort((a, b) => b[0].localeCompare(a[0])).forEach(([date, quiz]) => {
                    const question1Preview = quiz.q1 ? quiz.q1.text.substring(0, 60) : (quiz.question1 ? quiz.question1.text.substring(0, 60) : '');
                    html += `
                        <div class="quiz-list-item" onclick="selectQuizForDateEdit('${date}')" id="quiz-item-${date}">
                            <div>
                                <div class="quiz-date-info">üìÖ ${date}</div>
                                <div class="quiz-question-preview">${question1Preview}${question1Preview.length >= 60 ? '...' : ''}</div>
                            </div>
                            <div>
                                <button class="btn btn-small btn-edit-date" onclick="event.stopPropagation(); selectQuizForDateEdit('${date}')">üìÖ Edit Date</button>
                            </div>
                        </div>
                    `;
                });
                
                quizListContainer.innerHTML = html;
            } catch (error) {
                console.error('Error loading quizzes for date edit:', error);
                showQuizMsg('dateChangeMessage', 'Error loading quizzes.', 'error');
            }
        }
        
        async function selectQuizForDateEdit(date) {
            try {
                const snapshot = await db.ref('quizQuestions/' + date).once('value');
                const quiz = snapshot.val();
                if (!quiz) return;
                
                selectedQuizForDateEdit = { date, ...quiz };
                
                // Highlight selected quiz
                document.querySelectorAll('.quiz-list-item').forEach(item => {
                    item.classList.remove('selected');
                });
                const selectedItem = document.getElementById('quiz-item-' + date);
                if (selectedItem) {
                    selectedItem.classList.add('selected');
                }
                
                // Show date change form
                document.getElementById('currentQuizDate').textContent = date;
                const questionPreview = quiz.q1 ? quiz.q1.text : (quiz.question1 ? quiz.question1.text : 'No question text');
                document.getElementById('currentQuizPreview').textContent = questionPreview;
                document.getElementById('newQuizDate').value = '';
                document.getElementById('dateChangeForm').style.display = 'block';
            } catch (error) {
                console.error('Error selecting quiz:', error);
                showQuizMsg('dateChangeMessage', 'Error selecting quiz.', 'error');
            }
        }
        
        function cancelDateEdit() {
            selectedQuizForDateEdit = null;
            document.getElementById('dateChangeForm').style.display = 'none';
            document.querySelectorAll('.quiz-list-item').forEach(item => {
                item.classList.remove('selected');
            });
            document.getElementById('dateChangeMessage').classList.remove('show');
        }
        
        async function updateQuizDate() {
            if (!selectedQuizForDateEdit) {
                showQuizMsg('dateChangeMessage', 'Please select a quiz first.', 'error');
                return;
            }
            
            const newDate = document.getElementById('newQuizDate').value;
            if (!newDate) {
                showQuizMsg('dateChangeMessage', 'Please select a new date.', 'error');
                return;
            }
            
            if (newDate === selectedQuizForDateEdit.date) {
                showQuizMsg('dateChangeMessage', 'New date must be different from current date.', 'error');
                return;
            }
            
            // Check if new date already has a quiz
            try {
                const snapshot = await db.ref('quizQuestions/' + newDate).once('value');
                if (snapshot.exists()) {
                    const confirmOverwrite = confirm(`A quiz already exists for ${newDate}. Do you want to overwrite it?`);
                    if (!confirmOverwrite) return;
                }
                
                // Show confirmation modal
                document.getElementById('dateEditModalMessage').innerHTML = `
                    <p>Are you sure you want to change the quiz date?</p>
                    <p style="margin-top:10px;"><strong>From:</strong> <span style="color:#c44569;">${selectedQuizForDateEdit.date}</span></p>
                    <p><strong>To:</strong> <span style="color:#4CAF50;">${newDate}</span></p>
                    <p style="margin-top:15px;font-size:0.9em;color:#666;">This will move the quiz and its publish status to the new date.</p>
                `;
                document.getElementById('quizDateEditModal').style.display = 'block';
            } catch (error) {
                console.error('Error checking new date:', error);
                showQuizMsg('dateChangeMessage', 'Error checking new date.', 'error');
            }
        }
        
        async function confirmDateChange() {
            const oldDate = selectedQuizForDateEdit.date;
            const newDate = document.getElementById('newQuizDate').value;
            const autoPublish = document.getElementById('autoPublishAfterMove').checked;
            
            try {
                // Get all related data
                const quizSnapshot = await db.ref('quizQuestions/' + oldDate).once('value');
                const publishSnapshot = await db.ref('quizPublished/' + oldDate).once('value');
                const submissionsSnapshot = await db.ref('quizSubmissions/' + oldDate).once('value');
                const resultsSnapshot = await db.ref('quizResults/' + oldDate).once('value');
                
                const quizData = quizSnapshot.val();
                const publishData = publishSnapshot.val();
                const submissionsData = submissionsSnapshot.val();
                const resultsData = resultsSnapshot.val();
                
                if (!quizData) {
                    throw new Error('No quiz found at old date');
                }
                
                // Create array of all write operations
                const writeOperations = [];
                
                // Write quiz to new date
                writeOperations.push(db.ref('quizQuestions/' + newDate).set(quizData));
                
                // Handle publish status
                if (autoPublish) {
                    // Auto-publish at new date
                    writeOperations.push(db.ref('quizPublished/' + newDate).set({
                        published: true,
                        publishedAt: Date.now(),
                        publishedBy: 'Super Admin (via date change)'
                    }));
                } else if (publishData) {
                    // Keep existing publish status
                    writeOperations.push(db.ref('quizPublished/' + newDate).set(publishData));
                }
                
                // Move submissions if exist
                if (submissionsData) {
                    writeOperations.push(db.ref('quizSubmissions/' + newDate).set(submissionsData));
                }
                
                // Move results if exist
                if (resultsData) {
                    writeOperations.push(db.ref('quizResults/' + newDate).set(resultsData));
                }
                
                // Wait for ALL writes to complete
                await Promise.all(writeOperations);
                
                // Now delete old entries - create array of delete operations
                const deleteOperations = [];
                deleteOperations.push(db.ref('quizQuestions/' + oldDate).remove());
                
                if (publishData) {
                    deleteOperations.push(db.ref('quizPublished/' + oldDate).remove());
                }
                
                if (submissionsData) {
                    deleteOperations.push(db.ref('quizSubmissions/' + oldDate).remove());
                }
                
                if (resultsData) {
                    deleteOperations.push(db.ref('quizResults/' + oldDate).remove());
                }
                
                // Wait for ALL deletes to complete
                await Promise.all(deleteOperations);
                
                // Show success message
                closeQuizDateEditModal();
                const publishMsg = autoPublish ? ' and published' : '';
                showQuizMsg('dateChangeMessage', `Quiz date successfully changed from ${oldDate} to ${newDate}${publishMsg}!`, 'success');
                
                // Reload quiz list
                setTimeout(() => {
                    cancelDateEdit();
                    loadQuizzesForDateEdit();
                }, 2000);
                
            } catch (error) {
                console.error('Date change error:', error);
                closeQuizDateEditModal();
                showQuizMsg('dateChangeMessage', 'Failed to change quiz date. Please try again.', 'error');
            }
        }
        
        function closeQuizDateEditModal() {
            document.getElementById('quizDateEditModal').style.display = 'none';
        }
        
        function showQuizMsg(elementId, text, type) {
            const message = document.getElementById(elementId);
            if (message) {
                message.textContent = text;
                message.className = `message ${type} show`;
                setTimeout(() => {
                    message.classList.remove('show');
                }, 5000);
            }
        }
    </script>
    
    <!-- ============================================ -->
    <!-- RULES AND REGULATIONS SECTION                -->
    <!-- TO EDIT: Just change the text below          -->
    <!-- TO ADD PDF: Replace "rules.pdf" with your    -->
    <!-- PDF file name and upload it to same folder   -->
    <!-- ============================================ -->
    <div class="content" style="margin-bottom:30px;margin-top:40px;padding:40px 30px;">
        <div style="text-align:center;margin-bottom:30px;">
            <h2 style="color:#c44569;margin-bottom:20px;">üìã General Rules and Regulations</h2>
            
            <!-- ============================================ -->
            <!-- TO ADD/REMOVE PDF LINK:                      -->
            <!-- Delete the entire line below to remove link  -->
            <!-- Or change "rules.pdf" to your PDF filename   -->
            <!-- ============================================ -->
            <a href="rules.pdf" target="_blank" style="display:inline-block;background:linear-gradient(135deg, #c44569 0%, #6a1b9a 100%);color:white;padding:12px 30px;border-radius:8px;text-decoration:none;font-weight:600;margin-bottom:20px;">
                üìÑ Download Complete Rules & Regulations PDF (Coming Soon)
            </a>
        </div>

        <!-- ============================================ -->
        <!-- TO EDIT COORDINATOR NAMES:                   -->
        <!-- Change the names below                       -->
        <!-- ============================================ -->
        <div style="background:#fff3cd;padding:20px;border-radius:8px;border-left:5px solid #ffc107;margin-bottom:20px;">
            <p style="margin:0;color:#856404;font-weight:600;">Event Coordinators: Lalitha S K & Priyanka V</p>
        </div>

        <!-- ============================================ -->
        <!-- TO EDIT RULES: Change the text below         -->
        <!-- Keep the HTML tags as they are               -->
        <!-- ============================================ -->
        <div style="background:white;padding:25px;border-radius:8px;border:2px solid #e0e0e0;">
            <ol style="line-height:1.8;color:#333;">
                <!-- Rule 1 -->
                <li style="margin-bottom:15px;">
                    <strong>Last date for registration</strong> with one time Refundable amount 
                    <span style="color:#c44569;font-weight:bold;">‚Çπ1,500/-</span> 
                    on or before 
                    <span style="color:#c44569;font-weight:bold;">23rd February, Monday within 3:30 PM</span>.
                </li>
                
                <!-- Rule 2 -->
                <li style="margin-bottom:15px;">
                    <strong>Last date for submission of Music and Work Organising batch</strong> 
                    on or before 
                    <span style="color:#c44569;font-weight:bold;">7th March, Saturday</span>.
                </li>
                
                <!-- Rule 3 -->
                <li style="margin-bottom:15px;">
                    Students arriving late (Event and for the Class registration on the date of event) 
                    or absent for the event will be fined 
                    <span style="color:#c44569;font-weight:bold;">‚Çπ500/- per day</span>.
                </li>
                
                <!-- Rule 4 -->
                <li style="margin-bottom:15px;">
                    Teams not submitting Music, or any other assignments with respect to the event, 
                    on date and time, will lead into 
                    <span style="color:#c44569;font-weight:bold;">non-refund of deposit ‚Çπ1,500/-</span>.
                </li>
            </ol>
        </div>
    </div>
    <!-- ============================================ -->
    <!-- END OF RULES SECTION                         -->
    <!-- ============================================ -->
    
    <!-- Footer -->
    <footer style="background: white; border-radius: 12px; padding: 25px; margin-top: 30px; box-shadow: 0 4px 20px rgba(0,0,0,0.1);">
        <div style="text-align: center;">
            
            <!-- ================================================== -->
            <!-- CIRCULAR LOGO (Top)                                -->
            <!-- Replace "davan_logo_2026.gif" with your image file -->
            <!-- ================================================== -->
            <div style="margin-bottom: 0px;">
                <img src="davan_logo_2026.gif" alt="Spurthi Davan Logo" style="height: 200px; width: auto; display: inline-block;">
            </div>
            
            <p style="color: #6a1b9a; font-size: 0.9em; margin-bottom: 8px;">
                ¬© 2026 Davan Institute of Advanced Management Studies
            </p>
            
            <!-- ============================================ -->
            <!-- SUPER ADMIN: UPDATE VERSION AND DATE HERE    -->
            <!-- ============================================ -->
            <p style="color: #666; font-size: 0.85em; margin-bottom: 8px;">
                <strong>Version:</strong> 2.0 (quiz) | <strong>Last Updated:</strong> February 17, 2026
            </p>
            <!-- ============================================ -->
            
            <p style="color: #c44569; font-size: 0.85em; font-weight: 600; margin-bottom: 8px;">
                Built by Harsha Gujjar, Director - Davan College
            </p>
            
            <!-- ================================================== -->
            <!-- TEXT LOGO (Below "Built by" line)                  -->
            <!-- Replace 