<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spurthi Youth Fest 2026 - Daily Quiz Competition</title>
    
    <!-- Favicon -->
    <link rel="icon" type="image/png" href="davan_degree1.png">
    <link rel="apple-touch-icon" href="davan_degree1.png">
    
    <!-- Open Graph / WhatsApp / Facebook Meta Tags -->
    <meta property="og:title" content="Spurthi Youth Fest 2026 - Daily Quiz Competition">
    <meta property="og:description" content="üéì Join our exciting Daily Quiz Competition! Answer 2 questions daily and win prizes. Register now for ‚Çπ1,500 (Refundable)">
    <meta property="og:image" content="https://harshgujjar.github.io/Spurthi-youth-fest-2026/og_image.png">
    <meta property="og:image:secure_url" content="https://harshgujjar.github.io/Spurthi-youth-fest-2026/og_image.png">
    <meta property="og:image:type" content="image/png">
    <meta property="og:image:width" content="1200">
    <meta property="og:image:height" content="630">
    <meta property="og:image:alt" content="Spurthi Youth Fest 2026 - Daily Quiz Competition by Davan Institute">
    <meta property="og:url" content="https://harshgujjar.github.io/Spurthi-youth-fest-2026/">
    <meta property="og:type" content="website">
    <meta property="og:site_name" content="Spurthi Youth Fest 2026">
    <meta property="og:locale" content="en_IN">
    
    <!-- Twitter Card Meta Tags -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="Spurthi Youth Fest 2026 - Daily Quiz Competition">
    <meta name="twitter:description" content="üéì Join our Daily Quiz Competition! Answer 2 questions daily and win prizes. Register now for ‚Çπ1,500 (Refundable)">
    <meta name="twitter:image" content="https://harshgujjar.github.io/Spurthi-youth-fest-2026/og_image.png">
    <meta name="twitter:image:alt" content="Spurthi Youth Fest 2026 - Daily Quiz Competition by Davan Institute">
    
    <!-- Additional Meta Tags -->
    <meta name="description" content="Spurthi Youth Fest 2026 Daily Quiz Competition - Test your knowledge, win prizes! By Davan Institute of Advanced Management Studies">
    <meta name="keywords" content="Spurthi, Youth Fest, Quiz, Competition, Davan Institute, College Fest, Student Competition">
    <meta name="author" content="Davan Institute of Advanced Management Studies">
    
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    <!-- EmailJS for sending actual emails -->
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
    <script type="text/javascript">
        (function(){
            emailjs.init("iISS6N2b69VmKwx8Y"); // Your EmailJS Public Key from image
        })();
    </script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #c44569 0%, #6a1b9a 100%); min-height: 100vh; padding: 20px; }
        
        /* ========== QUIZ ANIMATIONS ========== */
        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes pulse {
            0%, 100% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.05);
            }
        }
        
        @keyframes shimmer {
            0% {
                background-position: -1000px 0;
            }
            100% {
                background-position: 1000px 0;
            }
        }
        
        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% {
                transform: translateY(0);
            }
            40% {
                transform: translateY(-20px);
            }
            60% {
                transform: translateY(-10px);
            }
        }
        
        @keyframes confetti {
            0% {
                transform: translateY(0) rotateZ(0deg);
                opacity: 1;
            }
            100% {
                transform: translateY(1000px) rotateZ(720deg);
                opacity: 0;
            }
        }
        
        @keyframes correctShake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px) rotate(-2deg); }
            75% { transform: translateX(5px) rotate(2deg); }
        }
        
        /* Quiz Status Cards with Animation */
        .quiz-status-card {
            animation: slideInUp 0.6s ease-out;
            transition: all 0.3s ease;
        }
        
        .quiz-status-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.2);
        }
        
        /* Shimmer effect for available quiz */
        .quiz-available-banner {
            background: linear-gradient(90deg, #d4edda 0%, #e8f5e9 50%, #d4edda 100%);
            background-size: 2000px 100%;
            animation: shimmer 3s linear infinite;
            border: 3px solid #28a745;
            border-radius: 15px;
            padding: 25px;
            margin: 20px 0;
            box-shadow: 0 6px 20px rgba(40, 167, 69, 0.3);
        }
        
        .quiz-available-banner h3 {
            color: #155724;
            font-size: 1.5em;
            margin-bottom: 10px;
            animation: pulse 2s ease-in-out infinite;
        }
        
        .quiz-available-banner .trophy-icon {
            font-size: 3em;
            display: inline-block;
            animation: bounce 2s ease-in-out infinite;
        }
        
        /* Question Cards */
        .quiz-question-card {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 8px 30px rgba(0,0,0,0.15);
            border-left: 6px solid #667eea;
            animation: slideInUp 0.5s ease-out;
            transition: all 0.3s ease;
        }
        
        .quiz-question-card:hover {
            transform: translateX(5px);
            box-shadow: 0 12px 40px rgba(102, 126, 234, 0.3);
        }
        
        .quiz-question-card h4 {
            color: #667eea;
            font-size: 1.3em;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .quiz-question-card .question-text {
            color: #333;
            font-size: 1.15em;
            margin-bottom: 20px;
            line-height: 1.6;
            font-weight: 500;
        }
        
        /* Option Buttons */
        .quiz-option {
            background: #f8f9fa;
            border: 3px solid #e9ecef;
            border-radius: 12px;
            padding: 18px 25px;
            margin: 12px 0;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 15px;
            font-size: 1.05em;
        }
        
        .quiz-option:hover {
            background: #e3f2fd;
            border-color: #2196F3;
            transform: translateX(10px);
            box-shadow: 0 4px 15px rgba(33, 150, 243, 0.2);
        }
        
        .quiz-option.selected {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-color: #667eea;
            color: white;
            font-weight: 600;
            transform: scale(1.02);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }
        
        .quiz-option .option-circle {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: #667eea;
            flex-shrink: 0;
        }
        
        .quiz-option.selected .option-circle {
            background: white;
            color: #667eea;
        }
        
        /* Submit Button Enhancement */
        .quiz-submit-btn {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            border: none;
            border-radius: 15px;
            padding: 20px 40px;
            font-size: 1.3em;
            font-weight: 700;
            cursor: pointer;
            width: 100%;
            margin-top: 30px;
            transition: all 0.3s ease;
            box-shadow: 0 8px 25px rgba(40, 167, 69, 0.4);
            position: relative;
            overflow: hidden;
        }
        
        .quiz-submit-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 35px rgba(40, 167, 69, 0.5);
        }
        
        .quiz-submit-btn:active {
            transform: translateY(-1px);
        }
        
        .quiz-submit-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: rgba(255,255,255,0.2);
            transition: left 0.5s ease;
        }
        
        .quiz-submit-btn:hover::before {
            left: 100%;
        }
        
        /* Timer Enhancement */
        .quiz-timer-box {
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, #ff6b6b 0%, #ff8e53 100%);
            color: white;
            padding: 15px 25px;
            border-radius: 15px;
            box-shadow: 0 6px 20px rgba(255, 107, 107, 0.4);
            z-index: 1000;
            font-weight: 700;
            font-size: 1.2em;
            animation: pulse 2s ease-in-out infinite;
        }
        
        /* Confetti */
        .confetti {
            position: fixed;
            width: 10px;
            height: 10px;
            z-index: 9999;
            animation: confetti 3s ease-out forwards;
        }
        
        /* Success Modal */
        .quiz-success-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            animation: fadeIn 0.3s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .quiz-success-content {
            background: white;
            border-radius: 25px;
            padding: 50px;
            text-align: center;
            max-width: 600px;
            animation: slideInUp 0.5s ease-out;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        
        .quiz-success-content .success-icon {
            font-size: 5em;
            margin-bottom: 20px;
            animation: bounce 1s ease-in-out;
        }
        
        .quiz-success-content h2 {
            color: #28a745;
            font-size: 2.5em;
            margin-bottom: 15px;
        }
        
        .quiz-success-content p {
            font-size: 1.2em;
            color: #666;
            margin: 10px 0;
        }
        .container { max-width: 1400px; margin: 0 auto; }
        .banner { width: 100%; max-width: 1200px; margin: 0 auto 30px; border-radius: 12px; box-shadow: 0 10px 40px rgba(0,0,0,0.3); display: block; }
        .header { text-align: center; color: white; margin-bottom: 30px; }
        .header h1 { font-size: 1.8em; }
        .admin-badge { display: inline-block; background: #FFD700; color: #333; padding: 5px 15px; border-radius: 20px; font-size: 0.9em; font-weight: bold; margin-left: 10px; }
        .super-admin-badge { display: inline-block; background: #FF6B6B; color: white; padding: 5px 15px; border-radius: 20px; font-size: 0.9em; font-weight: bold; margin-left: 10px; }
        .jury-badge { display: inline-block; background: #4ECDC4; color: white; padding: 5px 15px; border-radius: 20px; font-size: 0.9em; font-weight: bold; margin-left: 10px; }
        
        /* Class Indicator */
        .class-indicator {
            background: white;
            padding: 15px 25px;
            border-radius: 8px;
            margin: 20px auto;
            max-width: 500px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            display: none;
        }
        .class-indicator.active {
            display: block;
        }
        .class-indicator h3 {
            color: #6a1b9a;
            font-size: 1.2em;
            margin-bottom: 8px;
        }
        .class-indicator .class-name {
            color: #c44569;
            font-size: 1.5em;
            font-weight: bold;
        }
        
        /* Admin Dashboard */
        .admin-dashboard {
            background: white;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }
        .dashboard-title {
            color: #c44569;
            font-size: 1.8em;
            margin-bottom: 25px;
            text-align: center;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 6px 20px rgba(0,0,0,0.15);
            transition: transform 0.3s;
        }
        .stat-card:hover {
            transform: translateY(-5px);
        }
        .stat-number {
            font-size: 3em;
            font-weight: bold;
            margin-bottom: 10px;
        }
        .stat-label {
            font-size: 1.1em;
            opacity: 0.9;
        }
        
        .tabs { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
        .tab { padding: 12px 24px; background: white; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: 600; transition: all 0.3s; }
        .tab:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.2); }
        .tab.active { background: linear-gradient(135deg, #c44569 0%, #6a1b9a 100%); color: white; }
        .content { background: white; border-radius: 12px; padding: 30px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); }
        #adminContentBox.lb-active { background: transparent; box-shadow: none; padding: 0; }
        .form-section { display: none; }
        .form-section.active { display: block; }
        .form-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; font-weight: 600; color: #333; }
        input, select, textarea { width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 6px; font-size: 16px; transition: border-color 0.3s; }
        input:focus, select:focus, textarea:focus { outline: none; border-color: #c44569; }
        .event-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 15px; margin: 20px 0; }
        .event-card { padding: 20px; border: 3px solid #ddd; border-radius: 12px; cursor: pointer; transition: all 0.3s; background: white; position: relative; }
        .event-card:hover { border-color: #c44569; transform: translateY(-3px); box-shadow: 0 6px 20px rgba(196, 69, 105, 0.3); }
        .event-card.full { border-color: #f44336; background: #ffebee; cursor: not-allowed; opacity: 0.7; }
        .event-card.full:hover { transform: none; }
        .event-title { font-size: 1.1em; font-weight: bold; margin-bottom: 8px; }
        .event-size { font-size: 0.9em; opacity: 0.8; margin-bottom: 5px; }
        .event-status { font-size: 0.85em; padding: 5px 10px; border-radius: 15px; display: inline-block; margin-top: 5px; font-weight: bold; }
        .status-full { background: #f44336; color: white; }
        .status-available { background: #4CAF50; color: white; }
        .status-limited { background: #FF9800; color: white; }
        .team-member-box { border: 2px solid #c44569; padding: 15px; border-radius: 8px; margin-bottom: 15px; background: #f9f9f9; }
        .member-header { color: #6a1b9a; font-weight: bold; margin-bottom: 10px; font-size: 1.1em; }
        .btn { padding: 12px 30px; background: linear-gradient(135deg, #c44569 0%, #6a1b9a 100%); color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.3s; }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(0,0,0,0.2); }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }
        .btn-secondary { background: #666; }
        .btn-small { padding: 6px 12px; font-size: 14px; }
        .btn-success { background: #4CAF50; }
        .btn-danger { background: #f44336; }
        .btn-info { background: #2196F3; }
        .message { padding: 15px; border-radius: 6px; margin-bottom: 20px; display: none; }
        .message.show { display: block; }
        .message.success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .message.error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.7); overflow-y: auto; }
        .modal-content { background-color: white; margin: 50px auto; padding: 30px; border-radius: 12px; width: 90%; max-width: 600px; }
        .modal-header { font-size: 1.5em; color: #c44569; margin-bottom: 20px; text-align: center; }
        .modal-icon { font-size: 4em; margin-bottom: 20px; text-align: center; }
        .modal-buttons { margin-top: 20px; display: flex; gap: 10px; justify-content: center; flex-wrap: wrap; }
        /* Table Wrapper for Horizontal Scroll */
        .table-wrapper {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            margin-top: 20px;
        }
        table { width: 100%; border-collapse: collapse; min-width: 600px; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #ddd; white-space: nowrap; }
        th { background: linear-gradient(135deg, #c44569 0%, #6a1b9a 100%); color: white; font-weight: 600; position: sticky; top: 0; z-index: 10; }
        tr:hover { background: #f5f5f5; }
        
        /* Mobile Responsive Table */
        @media (max-width: 768px) {
            table { min-width: 800px; font-size: 14px; }
            th, td { padding: 8px 6px; }
            .btn-small { padding: 4px 8px; font-size: 12px; }
        }
        .edit-btn { background: #2196F3; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; margin-right: 5px; }
        .edit-btn:hover { background: #1976D2; }
        .delete-btn { background: #f44336; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; }
        .delete-btn:hover { background: #d32f2f; }
        .filter-section { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
        .filter-section select { flex: 1; min-width: 200px; }
        .admin-only { display: none; }
        .super-admin-only { display: none; }
        .jury-only { display: none; }
        .student-section { background: #f0f0f0; padding: 20px; border-radius: 8px; margin-bottom: 30px; }
        .cr-section { background: #e3f2fd; padding: 20px; border-radius: 8px; margin-bottom: 20px; border: 2px solid #2196F3; }
        
        /* Jury Sheet Styles */
        .criteria-input-group {
            background: #f9f9f9;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            border: 2px solid #ddd;
        }
        .criteria-input-group input {
            margin-bottom: 10px;
        }
        .remove-criteria-btn {
            background: #f44336;
            color: white;
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
        }
        .marks-table {
            overflow-x: auto;
        }
        .marks-input {
            width: 80px;
            padding: 8px;
            border: 2px solid #ddd;
            border-radius: 4px;
            text-align: center;
        }
        .marks-input:focus {
            border-color: #4CAF50;
        }
        .total-marks {
            font-weight: bold;
            color: #c44569;
            font-size: 1.2em;
        }
        .winner-badge {
            background: #FFD700;
            color: #333;
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: bold;
            display: inline-block;
            margin-left: 10px;
        }
        .runner-badge {
            background: #C0C0C0;
            color: #333;
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: bold;
            display: inline-block;
            margin-left: 10px;
        }
        .jury-password-section {
            background: #fff3cd;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 2px solid #ffc107;
        }
        .results-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        .rank-1 {
            border-left: 5px solid #FFD700;
        }
        .rank-2 {
            border-left: 5px solid #C0C0C0;
        }
        .rank-3 {
            border-left: 5px solid #CD7F32;
        }
        
        @media (max-width: 768px) { 
            .event-grid { grid-template-columns: 1fr; } 
            .filter-section { flex-direction: column; }
            .marks-input { width: 60px; }
        }
        
        /* Firebase Status Indicator */
        .firebase-status {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: white;
            padding: 12px 20px;
            border-radius: 25px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            display: flex;
            align-items: center;
            gap: 10px;
            z-index: 999;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s;
        }
        .firebase-status:hover {
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
            transform: translateY(-2px);
        }
        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }
        .status-connected {
            background: #4CAF50;
            box-shadow: 0 0 10px rgba(76, 175, 80, 0.5);
        }
        .status-disconnected {
            background: #f44336;
            box-shadow: 0 0 10px rgba(244, 67, 54, 0.5);
            animation: blink 1s infinite;
        }
        .status-checking {
            background: #FF9800;
            box-shadow: 0 0 10px rgba(255, 152, 0, 0.5);
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        @keyframes blink {
            0%, 50%, 100% { opacity: 1; }
            25%, 75% { opacity: 0.3; }
        }
        @media (max-width: 768px) {
            .firebase-status {
                bottom: 10px;
                right: 10px;
                padding: 8px 15px;
                font-size: 12px;
            }
            .status-dot {
                width: 10px;
                height: 10px;
            }
        }
        
        /* Edit Date Button Styling */
        .btn-warning { background: #FF9800; }
        .btn-edit-date {
            background: linear-gradient(135deg, #FF9800 0%, #F57C00 100%);
            margin-left: 10px;
        }
        .btn-edit-date:hover {
            box-shadow: 0 6px 20px rgba(255, 152, 0, 0.4);
        }
        
        /* Date Editor Modal */
        .date-picker-group {
            display: flex;
            gap: 15px;
            align-items: center;
            margin: 20px 0;
            flex-wrap: wrap;
        }
        .date-picker-group > div {
            flex: 1;
            min-width: 200px;
        }
        .quiz-list-item {
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .quiz-list-item:hover {
            border-color: #c44569;
            background: #f9f9f9;
        }
        .quiz-list-item.selected {
            border-color: #4CAF50;
            background: #e8f5e9;
        }
        .quiz-date-info {
            font-weight: 600;
            color: #6a1b9a;
        }
        .quiz-question-preview {
            font-size: 0.9em;
            color: #666;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- ============================================ -->
        <!-- TO CHANGE BANNER IMAGE:                      -->
        <!-- Replace "banner.gif?v=5" with your file      -->
        <!-- Supported: .gif, .png, .jpg                  -->
        <!-- ============================================ -->
        <img src="banner.gif?v=5" class="banner">
        
        <div class="header">
            <h1>üéâ SPURTHI YOUTH FEST 2026 üéâ</h1>
            <p id="userInfo"></p>
        </div>

        <!-- ============================================ -->
        <!-- NEW EVENT BANNER                             -->
        <!-- TO EDIT: Change the text inside the span    -->
        <!-- tag below to update the banner message      -->
        <!-- ============================================ -->
        <div style="background: linear-gradient(90deg, #ff6b35, #f7c59f, #ff6b35); background-size: 200% 100%; animation: shimmer 3s linear infinite; border-radius: 12px; padding: 14px 24px; margin: 10px 0 5px 0; text-align: center; box-shadow: 0 4px 15px rgba(255, 107, 53, 0.4); border: 2px solid #ff6b35;">
            <!-- EDIT BANNER TEXT BELOW -->
            <span style="font-size: 1.15em; font-weight: 700; color: #fff; text-shadow: 1px 1px 3px rgba(0,0,0,0.3); letter-spacing: 0.5px;">üéØ New Scavenger Hunt Event Coming Soon Today! üéØ</span>
        </div>

        <!-- Login/Logout Section (Visible to all) -->
        <div class="content" id="loginSection">
            <h2 style="text-align:center;color:#c44569;margin-bottom:25px">Login</h2>
            
            <!-- Student Login at Top -->
            <div id="studentLogin">
                <div class="form-group">
                    <label>Class:</label>
                    <select id="studentClass"></select>
                </div>
                <button class="btn" onclick="studentLogin()">Login as Student</button>
            </div>
            
            <!-- Divider -->
            <div style="margin: 30px 0; border-top: 2px solid #ddd;"></div>
            
            <!-- Youthfest Registration Dropdown -->
            <div class="form-group">
                <label>Youthfest Registration</label>
                <select id="userType" onchange="handleUserTypeChange()">
                    <option value="">-- Select --</option>
                    <option value="cr">Class Representative (CR)</option>
                    <option value="admin">Admin</option>
                    <option value="superadmin">Super Admin</option>
                    <option value="jury">Jury</option>
                </select>
            </div>
            
            <!-- CR Login -->
            <div id="crLogin" style="display:none">
                <div class="form-group">
                    <label>Class:</label>
                    <select id="crClass"></select>
                </div>
                <button class="btn" onclick="crLogin()">Login as CR</button>
            </div>
            
            <!-- Admin Login -->
            <div id="adminLogin" style="display:none">
                <div class="form-group">
                    <label>Admin Password:</label>
                    <input type="password" id="adminPassword" placeholder="Enter admin password" onkeydown="if(event.key==='Enter') adminLogin()">
                </div>
                <button class="btn" onclick="adminLogin()">Login as Admin</button>
            </div>
            
            <!-- Super Admin Login -->
            <div id="superAdminLogin" style="display:none">
                <div class="form-group">
                    <label>Super Admin Password:</label>
                    <input type="password" id="superAdminPassword" placeholder="Enter super admin password" onkeydown="if(event.key==='Enter') superAdminLogin()">
                </div>
                <button class="btn" onclick="superAdminLogin()">Login as Super Admin</button>
            </div>
            
            <!-- Jury Login -->
            <div id="juryLogin" style="display:none">
                <div class="form-group">
                    <label>Select Event:</label>
                    <select id="juryEvent"></select>
                </div>
                <div class="form-group">
                    <label>Jury Password:</label>
                    <input type="password" id="juryPassword" placeholder="Enter jury password for this event" onkeydown="if(event.key==='Enter') juryLogin()">
                </div>
                <div class="form-group">
                    <label>Jury Number (1 or 2):</label>
                    <select id="juryNumber">
                        <option value="">-- Select --</option>
                        <option value="1">Jury 1</option>
                        <option value="2">Jury 2</option>
                    </select>
                </div>
                <button class="btn" onclick="juryLogin()">Login as Jury</button>
            </div>
            
            <!-- Divider -->
            <div style="margin: 30px 0; border-top: 2px solid #ddd;"></div>
            
            <!-- Online Competition Dropdown -->
            <div class="form-group">
                <label>Online Competition</label>
                <select id="competitionType" onchange="handleCompetitionChange()">
                    <option value="">-- Select --</option>
                    <option value="dailyquiz">Daily Quiz Competition</option>
                </select>
            </div>
            
            <!-- Daily Quiz Competition Login -->
            <div id="dailyQuizLogin" style="display:none">
                <!-- Public Quiz Status (shows before login) -->
                <div id="publicQuizStatus" style="margin-bottom:30px">
                    <h3 style="color:#c44569;margin-bottom:20px;font-size:1.8em;text-align:center">üìù Today's Daily Quiz Competition</h3>
                    <div id="publicQuizMessage" class="quiz-status-card" style="padding:25px;background:white;border-radius:15px;border-left:5px solid #667eea;box-shadow:0 6px 20px rgba(0,0,0,0.1)">
                        <p style="margin:0;color:#666;text-align:center">Checking today's quiz status...</p>
                    </div>
                </div>
                
                <hr style="margin:30px 0;border:none;border-top:2px solid #e9ecef">
                
                <h3 style="color:#6a1b9a;margin-bottom:15px">Student Registration & Login</h3>
                <div id="quizMessage" class="message"></div>
                
                <div style="background:#fff3cd;padding:15px;border-radius:8px;margin-bottom:20px;border-left:4px solid #ffc107">
                    <p style="margin:0;color:#856404"><strong>New Student?</strong> Register to get password</p>
                </div>
                
                <div class="form-group">
                    <label>Select Class:</label>
                    <select id="quizClass"></select>
                </div>
                <div class="form-group">
                    <label>Email Address:</label>
                    <input type="email" id="quizEmail" placeholder="your.email@example.com">
                </div>
                <div class="form-group">
                    <label>Phone Number:</label>
                    <input type="tel" id="quizPhone" placeholder="10-digit mobile number">
                </div>
                <div class="form-group">
                    <label>Full Name:</label>
                    <input type="text" id="quizName" placeholder="Enter your full name">
                </div>
                <button class="btn" onclick="registerQuizStudent()" style="margin-bottom:10px">üìù Register & Get Password</button>
                
                <hr style="margin:25px 0;border:none;border-top:2px solid #e9ecef">
                
                <div style="background:#d4edda;padding:15px;border-radius:8px;margin-bottom:20px;border-left:4px solid #28a745">
                    <p style="margin:0;color:#155724"><strong>Already Registered?</strong> Login with your phone number and password</p>
                </div>
                
                <div class="form-group">
                    <label>Phone Number:</label>
                    <input type="tel" id="quizLoginPhone" placeholder="Enter 10-digit phone number" maxlength="10" inputmode="numeric" pattern="[0-9]*" autocomplete="tel" onkeydown="if(event.key==='Enter') loginQuizStudent()">
                </div>
                <div class="form-group">
                    <label>Password:</label>
                    <input type="password" id="quizLoginPassword" placeholder="Enter password" onkeydown="if(event.key==='Enter') loginQuizStudent()">
                </div>
                <button class="btn btn-success" onclick="loginQuizStudent()">üöÄ Login to Quiz</button>
            </div>
        </div>

        <!-- Student Enrollment Section -->
        <div class="student-section" id="studentSection" style="display:none">
            <button class="btn btn-secondary" onclick="logout()" style="float:right">Logout</button>
            <h2 style="color:#c44569;margin-bottom:20px">Student Enrollment</h2>
            <div id="enrollMessage" class="message"></div>
            
            <div class="class-indicator" id="classIndicator">
                <h3>You are enrolling for</h3>
                <div class="class-name" id="currentClassName"></div>
            </div>

            <!-- View Class Enrollments Section -->
            <div style="background:#e3f2fd;padding:20px;border-radius:8px;margin-bottom:20px;border:2px solid #2196F3;">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:15px;">
                    <h3 style="color:#1976D2;margin:0;">üìä Your Class Enrollments</h3>
                    <button class="btn btn-small" onclick="toggleEnrollmentView()" id="toggleEnrollmentBtn">
                        Hide Details
                    </button>
                </div>
                
                <!-- Event Filter -->
                <div class="form-group" style="margin-bottom:15px;">
                    <label>Filter by Event:</label>
                    <select id="studentEventFilter" onchange="viewStudentClassEnrollments()">
                        <option value="">All Events</option>
                    </select>
                </div>
                
                <div id="studentEnrollmentResults"></div>
            </div>

            <div class="form-group">
                <label>Select Event to Enroll:</label>
                <div class="event-grid" id="eventCardsContainer"></div>
            </div>

            <div id="enrollmentForm" style="display:none">
                <div id="enrollmentFormContent"></div>
                <div id="enrollBtnsNormal">
                    <button class="btn" onclick="submitEnrollment(false)">Submit Enrollment</button>
                    <button class="btn btn-secondary" onclick="cancelEnrollment()">Cancel</button>
                </div>
                <div id="enrollBtnsOneAtATime" style="display:none">
                    <button class="btn btn-success" onclick="submitEnrollment(true)" style="margin-right:10px">‚úÖ Submit & Add Another</button>
                    <button class="btn" onclick="submitEnrollment(false)">‚úî Submit & Finish</button>
                    <button class="btn btn-secondary" onclick="cancelEnrollment()">Cancel</button>
                </div>
            </div>
        </div>

        <!-- CR Section -->
        <div class="cr-section" id="crSection" style="display:none">
            <button class="btn btn-secondary" onclick="logout()" style="float:right">Logout</button>
            <h2 style="color:#2196F3;margin-bottom:20px">Class Representative Dashboard</h2>
            <div id="crMessage" class="message"></div>
            
            <div class="class-indicator active">
                <h3>Managing Class</h3>
                <div class="class-name" id="crClassName"></div>
            </div>

            <div class="tabs">
                <button class="tab active" onclick="showCRTab('crEnroll')">Enroll Students</button>
                <button class="tab" onclick="showCRTab('crView')">View Enrollments</button>
                <button class="tab" onclick="showCRTab('crQuizStats');loadCRQuizStats()">üß† Quiz Stats</button>
            </div>

            <div id="crEnroll" class="form-section active">
                <h3 style="margin-bottom:20px">Enroll Students for Your Class</h3>
                <div class="form-group">
                    <label>Select Event:</label>
                    <div class="event-grid" id="crEventCardsContainer"></div>
                </div>

                <div id="crEnrollmentForm" style="display:none">
                    <div id="crEnrollmentFormContent"></div>
                    <div id="crEnrollBtnsNormal">
                        <button class="btn" onclick="submitCREnrollment(false)">Submit Enrollment</button>
                        <button class="btn btn-secondary" onclick="cancelCREnrollment()">Cancel</button>
                    </div>
                    <div id="crEnrollBtnsOneAtATime" style="display:none">
                        <button class="btn btn-success" onclick="submitCREnrollment(true)" style="margin-right:10px">‚úÖ Submit & Add Another</button>
                        <button class="btn" onclick="submitCREnrollment(false)">‚úî Submit & Finish</button>
                        <button class="btn btn-secondary" onclick="cancelCREnrollment()">Cancel</button>
                    </div>
                </div>
            </div>

            <div id="crView" class="form-section">
                <h3 style="margin-bottom:20px">Your Class Enrollments</h3>
                <div class="filter-section">
                    <select id="crFilterEvent" onchange="updateCRView()">
                        <option value="">All Events</option>
                    </select>
                    <button class="btn btn-small" onclick="clearCRFilters()">Clear Filters</button>
                    <button class="btn btn-small btn-success" onclick="downloadCREnrollments()">üì• Download Enrollments</button>
                </div>
                <div id="crSummary" style="margin-bottom:20px"></div>
                <div id="crEnrollmentsContainer"></div>
            </div>

            <!-- ‚îÄ‚îÄ CR QUIZ STATS TAB ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
            <div id="crQuizStats" class="form-section">
                <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:10px;margin-bottom:18px">
                    <h3 style="color:#6a1b9a;margin:0">üß† Online Quiz ‚Äî Your Class Stats</h3>
                    <div style="display:flex;gap:8px;align-items:center">
                        <select id="crQsDateFilter" onchange="loadCRQuizStats()" style="padding:7px 12px;border:2px solid #6a1b9a;border-radius:8px;color:#3d0060;font-weight:600;background:white;outline:none">
                            <option value="">‚Äî Select Date ‚Äî</option>
                        </select>
                        <button class="btn btn-small btn-info" onclick="loadCRQuizStats()">üîÑ Refresh</button>
                    </div>
                </div>

                <!-- Info notice box ‚Äî visible to CR -->
                <div id="crQsInfoBox" style="background:#fffde7;border-radius:10px;padding:16px 18px;margin-bottom:16px;border-left:4px solid #ffc107">
                    <h4 style="color:#856404;margin:0 0 5px;font-size:0.9em">üìã Quiz Participation Summary ‚Äî <span id="crQsInfoDate">select a date</span></h4>
                    <div id="crQsInfoText" style="color:#555;font-size:13px;line-height:1.75">Select a date above to see your class's quiz participation details.</div>
                </div>

                <!-- Stats cards for CR's class -->
                <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:12px;margin-bottom:18px" id="crQsCards">
                    <div style="background:linear-gradient(135deg,#667eea,#764ba2);border-radius:10px;padding:16px;text-align:center">
                        <div style="font-size:1.8em;font-weight:800;color:white" id="crQsTotal">‚Äî</div>
                        <div style="color:rgba(255,255,255,0.8);font-size:12px;margin-top:4px">Participated</div>
                    </div>
                    <div style="background:linear-gradient(135deg,#28a745,#20c997);border-radius:10px;padding:16px;text-align:center">
                        <div style="font-size:1.8em;font-weight:800;color:white" id="crQsCorrect">‚Äî</div>
                        <div style="color:rgba(255,255,255,0.8);font-size:12px;margin-top:4px">Both Correct</div>
                    </div>
                    <div style="background:linear-gradient(135deg,#ffc107,#ff9800);border-radius:10px;padding:16px;text-align:center">
                        <div style="font-size:1.8em;font-weight:800;color:white" id="crQsPartial">‚Äî</div>
                        <div style="color:rgba(255,255,255,0.8);font-size:12px;margin-top:4px">Partial (1/2)</div>
                    </div>
                    <div style="background:linear-gradient(135deg,#c44569,#e91e63);border-radius:10px;padding:16px;text-align:center">
                        <div style="font-size:1.8em;font-weight:800;color:white" id="crQsRate">‚Äî</div>
                        <div style="color:rgba(255,255,255,0.8);font-size:12px;margin-top:4px">Accuracy Rate</div>
                    </div>
                </div>

                <!-- Student list for CR's class on selected date -->
                <div style="background:white;border-radius:10px;border:2px solid #e0c8f5;overflow:hidden">
                    <div style="background:linear-gradient(135deg,#6a1b9a,#c44569);padding:12px 16px">
                        <h4 style="color:white;margin:0;font-size:0.95em">Your Class Students ‚Äî Quiz Submissions</h4>
                    </div>
                    <div class="table-wrapper" style="margin:0">
                        <table>
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>Student Name</th>
                                    <th>Score</th>
                                    <th>Time Taken</th>
                                    <th>Submitted At</th>
                                </tr>
                            </thead>
                            <tbody id="crQsTable"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Admin Section -->
        <div class="admin-only" id="adminSection">
            <button class="btn btn-secondary" onclick="logout()" style="float:right">Logout</button>
            
            <!-- Admin Dashboard -->
            <div class="admin-dashboard">
                <h2 class="dashboard-title">üìä Admin Dashboard</h2>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number" id="totalStudents">0</div>
                        <div class="stat-label">Total Students</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="totalEvents">0</div>
                        <div class="stat-label">Active Events</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="totalClasses">0</div>
                        <div class="stat-label">Classes</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="totalEnrollments">0</div>
                        <div class="stat-label">Total Enrollments</div>
                    </div>
                </div>
            </div>

            <div class="tabs">
                <button class="tab active" onclick="showTab('master')">Master List</button>
                <button class="tab" onclick="showTab('events')">By Events</button>
                <button class="tab super-admin-only" onclick="showTab('jurySetup')">Jury Setup</button>
                <button class="tab" onclick="showTab('results')" id="resultsTab">Results</button>
                <button class="tab super-admin-only" onclick="showTab('quizManagement')" id="quizManagementTab">üìù Quiz Management</button>
                <button class="tab super-admin-only" onclick="showTab('leaderboardAdmin')" id="leaderboardAdminTab">üèÜ Leaderboard</button>
            </div>

            <div class="content" id="adminContentBox">
                <!-- Master List Tab -->
                <div id="master" class="form-section active">
                    <h2 style="color:#c44569;margin-bottom:20px">Master Enrollment List</h2>
                    <div class="filter-section">
                        <select id="filterClass" onchange="updateMaster()">
                            <option value="">All Classes</option>
                        </select>
                        <select id="filterEvent" onchange="updateMaster()">
                            <option value="">All Events</option>
                        </select>
                        <button class="btn btn-small" onclick="clearFilters()">Clear Filters</button>
                        <button class="btn btn-small btn-success" onclick="downloadMaster()">üì• Download CSV</button>
                    </div>
                    <div id="summaryInfo" style="background:#e3f2fd;padding:15px;border-radius:8px;margin-bottom:20px"></div>
                    <div id="masterContainer"></div>
                </div>

                <!-- Events Tab -->
                <div id="events" class="form-section">
                    <h2 style="color:#c44569;margin-bottom:20px">Enrollments by Events</h2>
                    <button class="btn btn-small btn-success" onclick="downloadEvents()" style="margin-bottom:20px">üì• Download CSV</button>
                    <div id="eventsContainer"></div>
                </div>

                <!-- Jury Setup Tab (Super Admin Only) -->
                <div id="jurySetup" class="form-section super-admin-only">
                    <h2 style="color:#c44569;margin-bottom:20px">Jury Setup & Criteria Management</h2>
                    
                    <div class="form-group">
                        <label>Select Event:</label>
                        <select id="setupEventSelect" onchange="loadEventSetup()">
                            <option value="">-- Select Event --</option>
                        </select>
                    </div>
                    
                    <div id="eventSetupContainer" style="display:none">
                        <div class="jury-password-section">
                            <h3 style="color:#6a1b9a;margin-bottom:15px">üë• Jury Details</h3>
                            
                            <div style="background:#f0f0f0;padding:15px;border-radius:8px;margin-bottom:15px">
                                <h4 style="color:#6a1b9a;margin-bottom:10px">Jury 1</h4>
                                <div class="form-group">
                                    <label>Jury 1 Name:</label>
                                    <input type="text" id="jury1Name" placeholder="e.g., Dr. Smith, Prof. John">
                                </div>
                                <div class="form-group">
                                    <label>Jury 1 Password:</label>
                                    <input type="text" id="jury1Password" placeholder="Set password for Jury 1">
                                </div>
                            </div>
                            
                            <div style="background:#f0f0f0;padding:15px;border-radius:8px;margin-bottom:15px">
                                <h4 style="color:#6a1b9a;margin-bottom:10px">Jury 2</h4>
                                <div class="form-group">
                                    <label>Jury 2 Name:</label>
                                    <input type="text" id="jury2Name" placeholder="e.g., Dr. Jane, Prof. Mary">
                                </div>
                                <div class="form-group">
                                    <label>Jury 2 Password:</label>
                                    <input type="text" id="jury2Password" placeholder="Set password for Jury 2">
                                </div>
                            </div>
                        </div>
                        
                        <h3 style="color:#6a1b9a;margin:20px 0 15px">üìã Evaluation Criteria (5 criteria, 10 marks each)</h3>
                        <div id="criteriaContainer"></div>
                        <button class="btn btn-small btn-info" onclick="addCriterion()" style="margin-top:10px">+ Add Criterion</button>
                        
                        <div style="margin-top:30px">
                            <button class="btn btn-success" onclick="saveEventSetup()">Save Setup</button>
                        </div>
                        
                        <div id="setupMessage" class="message" style="margin-top:20px"></div>
                    </div>
                </div>

                <!-- Results Tab -->
                <div id="results" class="form-section">
                    <h2 style="color:#c44569;margin-bottom:20px">Event Results</h2>
                    
                    <div class="form-group">
                        <label>Select Event:</label>
                        <div style="display:flex;gap:10px;">
                            <select id="resultsEventSelect" onchange="loadEventResults()" style="flex:1">
                                <option value="">-- Select Event --</option>
                            </select>
                            <button class="btn btn-small" onclick="loadEventResults()" style="white-space:nowrap">üîÑ Refresh</button>
                        </div>
                    </div>
                    
                    <!-- Super Admin Only: Publish/Unpublish Results -->
                    <div class="super-admin-only" style="margin:20px 0;padding:15px;background:#fff3cd;border-radius:8px;border:2px solid #ffc107">
                        <h3 style="color:#6a1b9a;margin-bottom:10px">üì¢ Results Management</h3>
                        <p style="color:#666;margin-bottom:15px;font-size:14px">Publish or unpublish results for the selected event.</p>
                        <div style="display:flex;gap:10px;flex-wrap:wrap">
                            <button class="btn btn-danger" onclick="publishResults()">‚úÖ Publish Results to Admins</button>
                            <button class="btn btn-secondary" onclick="unpublishResults()">‚ùå Unpublish Results</button>
                        </div>
                    </div>
                    
                    <div id="resultsContainer"></div>
                </div>
                
                <!-- Quiz Management Tab -->
                <div id="quizManagement" class="form-section">
                    <h2 style="color:#c44569;margin-bottom:25px">üìù Daily Quiz Competition Management</h2>
                    
                    <div class="stats-grid" style="margin-bottom:30px">
                        <div class="stat-card">
                            <div class="stat-number" id="quizTotalStudents">0</div>
                            <div class="stat-label">Total Quiz Students</div>
                        </div>
                        <div class="stat-card" style="background:linear-gradient(135deg,#28a745 0%,#20c997 100%)">
                            <div class="stat-number" id="quizTodayParticipants">0</div>
                            <div class="stat-label">Today's Participants</div>
                        </div>
                        <div class="stat-card" style="background:linear-gradient(135deg,#ffc107 0%,#ff9800 100%)">
                            <div class="stat-number" id="quizQuestionsCount">0</div>
                            <div class="stat-label">Questions Today</div>
                        </div>
                    </div>
                    
                    <div id="quizAdminMessage" class="message"></div>
                    
                    <div class="tabs" style="margin-bottom:25px">
                        <button class="tab active" onclick="showQuizManagementTab('questions', event)">üìù Questions</button>
                        <button class="tab" onclick="showQuizManagementTab('allquizzes', event)">üìö All Quizzes</button>
                        <button class="tab" onclick="showQuizManagementTab('students', event)">üë• Students</button>
                        <button class="tab" onclick="showQuizManagementTab('submissions', event)">üìä Submissions</button>
                        <button class="tab" onclick="showQuizManagementTab('winners', event)">üèÜ Winners</button>
                        <button class="tab super-admin-only" onclick="showQuizManagementTab('editdates', event)" id="editDatesTab">üìÖ Edit Quiz Dates</button>
                    </div>
                    
                    <!-- Questions Sub-Tab -->
                    <div id="quizQuestionsContent" class="form-section active">
                        <!-- Date Selector moved here for easier access -->
                        <div style="background:#fff3cd;padding:18px 20px;border-radius:10px;margin-bottom:22px;border-left:5px solid #ffc107;display:flex;align-items:center;gap:16px;flex-wrap:wrap">
                            <label for="quizDateSelector" style="font-size:1em;color:#856404;font-weight:700;margin:0;white-space:nowrap">üìÖ Select Date for Quiz:</label>
                            <input type="date" id="quizDateSelector" style="border:2px solid #ffc107;border-radius:8px;padding:8px 12px;font-size:1em;color:#333;background:white;flex-shrink:0" required onchange="loadQuizForSelectedDate()">
                            <p style="color:#856404;font-size:13px;margin:0;flex:1;min-width:200px"><strong>Note:</strong> Select a date to create/edit quiz questions. Students will see this quiz automatically on the selected date.</p>
                        </div>
                        <h3 style="color:#6a1b9a;margin-bottom:20px" id="quizQuestionsHeading">Create Quiz (2 Questions)</h3>
                        
                        
                        <div style="background:#f8f9fa;padding:20px;border-radius:10px;margin-bottom:30px">
                            <h4 style="color:#667eea;margin-bottom:15px">Question 1</h4>
                            
                            <div class="form-group">
                                <label>Question Text:</label>
                                <textarea id="quiz_q1Text" rows="3" placeholder="Enter question 1"></textarea>
                            </div>
                            
                            <!-- Image Upload -->
                            <div class="form-group">
                                <label>üì∑ Add Image (Optional):</label>
                                <input type="file" id="quiz_q1Image" accept="image/*" onchange="previewQuestionImage(this, 'quiz_q1ImagePreview')">
                                <div id="quiz_q1ImagePreview" style="margin-top:10px"></div>
                                <small style="color:#666">Upload an image to show with the question</small>
                            </div>
                            
                            <!-- Audio Upload -->
                            <div class="form-group">
                                <label>üéµ Add Audio (Optional):</label>
                                <input type="file" id="quiz_q1Audio" accept="audio/*" onchange="previewQuestionAudio(this, 'quiz_q1AudioPreview')">
                                <div id="quiz_q1AudioPreview" style="margin-top:10px"></div>
                                <small style="color:#666">Upload audio/music to play with the question</small>
                            </div>
                            
                            <div class="form-group">
                                <label>Option A:</label>
                                <input type="text" id="quiz_q1OptA" placeholder="Option A">
                            </div>
                            <div class="form-group">
                                <label>Option B:</label>
                                <input type="text" id="quiz_q1OptB" placeholder="Option B">
                            </div>
                            <div class="form-group">
                                <label>Option C:</label>
                                <input type="text" id="quiz_q1OptC" placeholder="Option C">
                            </div>
                            <div class="form-group">
                                <label>Option D:</label>
                                <input type="text" id="quiz_q1OptD" placeholder="Option D">
                            </div>
                            <div class="form-group">
                                <label>Correct Answer:</label>
                                <select id="quiz_q1Correct">
                                    <option value="">-- Select --</option>
                                    <option value="A">A</option>
                                    <option value="B">B</option>
                                    <option value="C">C</option>
                                    <option value="D">D</option>
                                </select>
                            </div>
                        </div>
                        
                        <div style="background:#f8f9fa;padding:20px;border-radius:10px;margin-bottom:30px">
                            <h4 style="color:#667eea;margin-bottom:15px">Question 2</h4>
                            
                            <div class="form-group">
                                <label>Question Text:</label>
                                <textarea id="quiz_q2Text" rows="3" placeholder="Enter question 2"></textarea>
                            </div>
                            
                            <!-- Image Upload -->
                            <div class="form-group">
                                <label>üì∑ Add Image (Optional):</label>
                                <input type="file" id="quiz_q2Image" accept="image/*" onchange="previewQuestionImage(this, 'quiz_q2ImagePreview')">
                                <div id="quiz_q2ImagePreview" style="margin-top:10px"></div>
                                <small style="color:#666">Upload an image to show with the question</small>
                            </div>
                            
                            <!-- Audio Upload -->
                            <div class="form-group">
                                <label>üéµ Add Audio (Optional):</label>
                                <input type="file" id="quiz_q2Audio" accept="audio/*" onchange="previewQuestionAudio(this, 'quiz_q2AudioPreview')">
                                <div id="quiz_q2AudioPreview" style="margin-top:10px"></div>
                                <small style="color:#666">Upload audio/music to play with the question</small>
                            </div>
                            
                            <div class="form-group">
                                <label>Option A:</label>
                                <input type="text" id="quiz_q2OptA" placeholder="Option A">
                            </div>
                            <div class="form-group">
                                <label>Option B:</label>
                                <input type="text" id="quiz_q2OptB" placeholder="Option B">
                            </div>
                            <div class="form-group">
                                <label>Option C:</label>
                                <input type="text" id="quiz_q2OptC" placeholder="Option C">
                            </div>
                            <div class="form-group">
                                <label>Option D:</label>
                                <input type="text" id="quiz_q2OptD" placeholder="Option D">
                            </div>
                            <div class="form-group">
                                <label>Correct Answer:</label>
                                <select id="quiz_q2Correct">
                                    <option value="">-- Select --</option>
                                    <option value="A">A</option>
                                    <option value="B">B</option>
                                    <option value="C">C</option>
                                    <option value="D">D</option>
                                </select>
                            </div>
                        </div>
                        
                        <button class="btn btn-success" onclick="saveQuizQuestionsFromAdmin()" style="font-size:1.1em">üíæ Save Questions</button>
                        <button class="btn btn-info btn-small" onclick="viewTodayQuestionsAdmin()" style="margin-left:10px">üëÅÔ∏è View Today's Questions</button>
                        
                        <!-- Publish/Unpublish Section for Admin Dashboard -->
                        <div id="publishControlSectionAdmin" style="display:none;margin-top:30px;background:#fff3cd;padding:25px;border-radius:12px;border-left:5px solid #ffc107">
                            <h3 style="color:#6a1b9a;margin-bottom:15px">üì¢ Quiz Publication Control</h3>
                            <div id="publishStatusDisplayAdmin" style="margin-bottom:20px"></div>
                            <div style="display:flex;gap:10px;flex-wrap:wrap">
                                <button class="btn btn-success" onclick="publishTodayQuiz()" id="btnPublishAdmin" style="display:none">‚úÖ PUBLISH Quiz (Make Live)</button>
                                <button class="btn btn-danger" onclick="unpublishTodayQuiz()" id="btnUnpublishAdmin" style="display:none">‚ùå UNPUBLISH Quiz (Hide)</button>
                            </div>
                        </div>
                        
                        <div id="todayQuestionsViewAdmin" style="display:none;margin-top:30px"></div>
                    </div>
                    
                    <!-- All Quizzes Sub-Tab -->
                    <div id="quizAllQuizzesContent" class="form-section">
                        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px">
                            <h3 style="color:#6a1b9a;margin:0">üìö All Quiz Questions (Sorted by Date)</h3>
                            <button class="btn btn-info btn-small" onclick="loadAllQuizzes()">üîÑ Refresh List</button>
                        </div>
                        <div id="allQuizzesContainer"></div>
                    </div>
                    
                    <!-- Students Sub-Tab -->
                    <div id="quizStudentsContent" class="form-section">
                        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px">
                            <h3 style="color:#6a1b9a;margin:0">Registered Quiz Students</h3>
                            <button class="btn btn-info btn-small" onclick="loadQuizStudentsAdmin()">üîÑ Refresh Students</button>
                        </div>
                        <div class="table-wrapper">
                            <table>
                                <thead>
                                    <tr>
                                        <th>#</th>
                                        <th>Name</th>
                                        <th>Email</th>
                                        <th>Phone</th>
                                        <th>Password</th>
                                        <th>Class</th>
                                        <th>Registered</th>
                                    </tr>
                                </thead>
                                <tbody id="quizStudentsTableAdmin"></tbody>
                            </table>
                        </div>
                    </div>
                    
                    <!-- Submissions Sub-Tab -->
                    <div id="quizSubmissionsContent" class="form-section">

                        <!-- ‚îÄ‚îÄ DATE SELECTOR + CLASS BREAKDOWN ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
                        <div style="background:linear-gradient(135deg,#f3e5ff,#fce4ec);border-radius:14px;padding:20px 22px;margin-bottom:20px;border:2px solid #e0c8f5">
                            <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:12px;margin-bottom:16px">
                                <h3 style="color:#3d0060;margin:0;font-size:1.05em">üìÖ Class-wise Participation by Date</h3>
                                <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
                                    <select id="qsDateFilter" onchange="loadClassStats()" style="padding:7px 12px;border:2px solid #6a1b9a;border-radius:8px;color:#3d0060;font-weight:600;background:white;outline:none">
                                        <option value="">‚Äî Select Date ‚Äî</option>
                                    </select>
                                    <button class="btn btn-small btn-info" onclick="loadClassStats()">üîÑ Refresh</button>
                                </div>
                            </div>

                            <!-- Summary pills -->
                            <div id="qsSummaryPills" style="display:flex;gap:10px;flex-wrap:wrap;margin-bottom:14px">
                                <span style="background:rgba(106,27,154,0.12);color:#4a148c;padding:5px 14px;border-radius:20px;font-size:12.5px;font-weight:600" id="qsPillTotal">Total: ‚Äî</span>
                                <span style="background:rgba(40,167,69,0.12);color:#155724;padding:5px 14px;border-radius:20px;font-size:12.5px;font-weight:600" id="qsPillCorrect">Both Correct: ‚Äî</span>
                                <span style="background:rgba(196,69,105,0.12);color:#7b1040;padding:5px 14px;border-radius:20px;font-size:12.5px;font-weight:600" id="qsPillClasses">Classes Participated: ‚Äî</span>
                            </div>

                            <!-- Class breakdown table -->
                            <div id="qsClassBreakdown">
                                <p style="color:#999;font-size:13px;text-align:center;padding:12px">Select a date above to see class-wise breakdown</p>
                            </div>
                        </div>

                        <!-- ‚îÄ‚îÄ QUIZ INFO NOTICE BOX ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
                        <div id="qsInfoBox" style="background:#fffde7;border-radius:10px;padding:16px 20px;margin-bottom:18px;border-left:4px solid #ffc107;display:none">
                            <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:10px">
                                <div style="flex:1">
                                    <h4 style="color:#856404;margin:0 0 6px;font-size:0.95em">üìã Quiz Summary ‚Äî <span id="qsInfoDate"></span></h4>
                                    <div id="qsInfoText" style="color:#555;font-size:13px;line-height:1.7"></div>
                                </div>
                                <button onclick="copyQsInfo()" style="background:#ffc107;color:#1a0030;border:none;padding:5px 12px;border-radius:6px;cursor:pointer;font-size:12px;font-weight:700;white-space:nowrap">üìã Copy</button>
                            </div>
                        </div>

                        <!-- ‚îÄ‚îÄ TODAY'S FULL SUBMISSIONS TABLE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
                        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:14px;flex-wrap:wrap;gap:8px">
                            <h3 style="color:#6a1b9a;margin:0">Today's Quiz Submissions</h3>
                            <div style="display:flex;gap:8px;align-items:center">
                                <select id="qsClassFilter" onchange="filterSubmissionsTable()" style="padding:6px 10px;border:1px solid #6a1b9a;border-radius:6px;font-size:13px;outline:none">
                                    <option value="">All Classes</option>
                                </select>
                                <select id="qsScoreFilter" onchange="filterSubmissionsTable()" style="padding:6px 10px;border:1px solid #6a1b9a;border-radius:6px;font-size:13px;outline:none">
                                    <option value="">All Scores</option>
                                    <option value="2">Both Correct (2/2)</option>
                                    <option value="1">One Correct (1/2)</option>
                                    <option value="0">None Correct (0/2)</option>
                                </select>
                                <button class="btn btn-info btn-small" onclick="loadQuizSubmissionsAdmin()">üîÑ Refresh</button>
                            </div>
                        </div>
                        <div class="table-wrapper">
                            <table>
                                <thead>
                                    <tr>
                                        <th>#</th>
                                        <th>Name</th>
                                        <th>Email</th>
                                        <th>Class</th>
                                        <th>Submitted</th>
                                        <th>Score</th>
                                        <th>Time</th>
                                    </tr>
                                </thead>
                                <tbody id="quizSubmissionsTableAdmin"></tbody>
                            </table>
                        </div>
                    </div>
                    
                    <!-- Winners Sub-Tab -->
                    <div id="quizWinnersContent" class="form-section">
                        <h3 style="color:#6a1b9a;margin-bottom:20px">üèÜ Declare Today's Winners</h3>

                        <!-- ‚îÄ‚îÄ AUTO-DECLARATION PANEL ‚îÄ‚îÄ -->
                        <div style="background:linear-gradient(135deg,#1a0030 0%,#3d0060 100%);border-radius:14px;padding:20px 22px;margin-bottom:22px;border:2px solid rgba(255,215,0,0.3)">
                            <div style="display:flex;align-items:center;gap:12px;margin-bottom:14px;flex-wrap:wrap">
                                <span style="font-size:1.7em">‚è∞</span>
                                <div style="flex:1">
                                    <h4 style="color:#ffd700;margin:0;font-size:1em">Auto-Declaration at 11:30 PM</h4>
                                    <p style="color:rgba(255,255,255,0.65);font-size:12px;margin:3px 0 0">If no manual declaration is done, winners are auto-selected at 11:30 PM daily.</p>
                                </div>
                                <label style="display:flex;align-items:center;gap:8px;cursor:pointer;margin:0">
                                    <div style="position:relative;width:48px;height:26px">
                                        <input type="checkbox" id="autoDeclarToggle" onchange="saveAutoDeclarSetting()" style="opacity:0;width:0;height:0;position:absolute">
                                        <span id="autoDeclarSlider" style="position:absolute;inset:0;background:#555;border-radius:26px;transition:0.3s;cursor:pointer"></span>
                                        <span id="autoDeclarThumb" style="position:absolute;left:3px;top:3px;width:20px;height:20px;background:white;border-radius:50%;transition:0.3s;pointer-events:none"></span>
                                    </div>
                                    <span id="autoDeclarLabel" style="color:#ffd700;font-weight:700;font-size:13px;white-space:nowrap">OFF</span>
                                </label>
                            </div>
                            <div id="autoDeclarStatus" style="background:rgba(255,255,255,0.07);border-radius:8px;padding:10px 14px;font-size:12.5px;color:rgba(255,255,255,0.75)">
                                üî¥ Auto-declaration is <strong style="color:#ff6b6b">disabled</strong>. Toggle ON to enable.
                            </div>
                            <div id="autoDeclarCountdown" style="display:none;margin-top:10px;background:rgba(255,215,0,0.1);border-radius:8px;padding:10px 14px;font-size:13px;color:#ffd700;font-weight:600;text-align:center"></div>
                        </div>

                        <!-- ‚îÄ‚îÄ HOW IT WORKS ‚îÄ‚îÄ -->
                        <div style="background:#fff3cd;padding:15px 20px;border-radius:10px;margin-bottom:22px">
                            <p style="margin:0;color:#856404"><strong>‚ÑπÔ∏è How it works:</strong> System randomly selects winner &amp; runner-up from students who got BOTH questions correct.</p>
                        </div>
                        
                        <div style="background:#f8f9fa;padding:20px;border-radius:10px;margin:0 0 20px">
                            <h4 style="margin-bottom:15px">üìä Statistics</h4>
                            <p><strong>Total:</strong> <span id="resultTotalPartAdmin">0</span></p>
                            <p><strong>Both Correct:</strong> <span id="resultBothCorrectAdmin">0</span></p>
                            <p><strong>Eligible:</strong> <span id="resultEligibleAdmin">0</span></p>
                        </div>
                        
                        <!-- Eligible Students List -->
                        <div id="eligibleStudentsListAdmin"></div>

                        <!-- ‚îÄ‚îÄ ACTION BUTTONS ‚îÄ‚îÄ -->
                        <div style="display:flex;gap:12px;flex-wrap:wrap;margin-top:20px;margin-bottom:10px">
                            <button class="btn btn-warning" onclick="selectQuizWinnersFromAdmin()" style="font-size:1em;padding:14px 22px">üé≤ Select Winners (Random)</button>
                            <button class="btn btn-info" onclick="toggleManualWinnerUI()" style="font-size:1em;padding:14px 22px" id="manualSelectToggleBtn">‚úã Manual Select</button>
                        </div>

                        <!-- ‚îÄ‚îÄ MANUAL SELECTION PANEL ‚îÄ‚îÄ -->
                        <div id="manualWinnerPanel" style="display:none;background:#f0f4ff;border:2px solid #667eea;border-radius:12px;padding:22px;margin-top:10px">
                            <h4 style="color:#667eea;margin-bottom:16px">‚úã Manual Winner Selection</h4>
                            <p style="color:#555;font-size:13px;margin-bottom:18px">Choose winner and runner-up from eligible students (both questions correct).</p>
                            <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:18px">
                                <div class="form-group" style="margin:0">
                                    <label style="color:#667eea;font-weight:700">üèÜ Winner</label>
                                    <select id="manualWinnerSelect" style="border:2px solid #ffd700;border-radius:8px;padding:10px;margin-top:6px">
                                        <option value="">-- Select Winner --</option>
                                    </select>
                                </div>
                                <div class="form-group" style="margin:0">
                                    <label style="color:#667eea;font-weight:700">ü•à Runner-Up</label>
                                    <select id="manualRunnerSelect" style="border:2px solid #aaa;border-radius:8px;padding:10px;margin-top:6px">
                                        <option value="">-- Select Runner-Up --</option>
                                    </select>
                                </div>
                            </div>
                            <div style="display:flex;gap:10px;flex-wrap:wrap">
                                <button class="btn btn-success" onclick="declareManualWinners()" style="padding:12px 24px">‚úÖ Declare These Winners</button>
                                <button class="btn btn-secondary" onclick="toggleManualWinnerUI()" style="padding:12px 20px">‚úñ Cancel</button>
                            </div>
                        </div>
                        
                        <div id="winnersDisplayAdmin" style="display:none;margin-top:25px"></div>
                    </div>
                    
                    <!-- Edit Quiz Dates Sub-Tab (Super Admin Only) -->
                    <div id="quizEditDatesContent" class="form-section super-admin-only">
                        <h3 style="color:#6a1b9a;margin-bottom:20px">üìÖ Edit Quiz Dates</h3>
                        <p style="color:#666;margin-bottom:20px">Select a quiz and change its date. This will move the quiz to a different day.</p>
                        
                        <div style="background:#fff3cd;padding:15px;border-radius:8px;border-left:5px solid #ffc107;margin-bottom:20px">
                            <p style="margin:0;color:#856404;font-weight:600">‚ö†Ô∏è Warning: Changing quiz dates will affect student access and published status.</p>
                        </div>
                        
                        <!-- Quiz Selection -->
                        <div id="quizDateList" style="margin-bottom:30px">
                            <h4 style="color:#c44569;margin-bottom:15px">Select Quiz to Edit:</h4>
                            <button class="btn btn-info btn-small" onclick="loadQuizzesForDateEdit()" style="margin-bottom:15px">üîÑ Refresh Quiz List</button>
                            <div id="quizListForDateEdit"></div>
                        </div>
                        
                        <!-- Date Change Form -->
                        <div id="dateChangeForm" style="display:none">
                            <h4 style="color:#c44569;margin-bottom:15px">Change Quiz Date:</h4>
                            
                            <div style="background:#f9f9f9;padding:20px;border-radius:8px;margin-bottom:20px">
                                <p style="margin:0 0 10px 0;color:#333"><strong>Current Date:</strong> <span id="currentQuizDate" style="color:#c44569"></span></p>
                                <p style="margin:0;color:#666;font-size:0.9em" id="currentQuizPreview"></p>
                            </div>
                            
                            <div class="form-group">
                                <label for="newQuizDate">New Date *</label>
                                <input type="date" id="newQuizDate" required>
                            </div>
                            
                            <div class="form-group">
                                <label style="display:flex;align-items:center;cursor:pointer;">
                                    <input type="checkbox" id="autoPublishAfterMove" checked style="width:auto;margin-right:10px;">
                                    <span>Automatically publish quiz at new date</span>
                                </label>
                                <p style="color:#666;font-size:0.9em;margin-top:5px;">If checked, the quiz will be published and visible to students at the new date.</p>
                            </div>
                            
                            <div id="dateChangeMessage" class="message"></div>
                            
                            <div style="display:flex;gap:10px;margin-top:20px">
                                <button class="btn btn-warning" onclick="updateQuizDate()">üìÖ Change Date</button>
                                <button class="btn btn-secondary" onclick="cancelDateEdit()">‚ùå Cancel</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ================================================ -->
            <!-- LEADERBOARD ADMIN PANEL (Super Admin only)       -->
            <!-- Accessed via the "üèÜ Leaderboard" tab above      -->
            <!-- ================================================ -->
            <div id="leaderboardAdmin" class="form-section super-admin-only" style="margin-top:20px">
                <h2 style="color:#ffd700;margin-bottom:12px;text-shadow:0 2px 8px rgba(0,0,0,0.4)">üèÜ Leaderboard Management</h2>

                <!-- ‚îÄ‚îÄ WHO / WHAT detail banner ‚îÄ‚îÄ -->
                <div style="background:linear-gradient(135deg,#1a0030 0%,#3d0060 50%,#6a1b9a 100%);border-radius:14px;padding:22px 24px;margin-bottom:18px;border:2px solid rgba(255,215,0,0.35);box-shadow:0 6px 24px rgba(106,27,154,0.35)">
                    <div style="display:flex;align-items:center;gap:12px;margin-bottom:14px">
                        <span style="font-size:2em">üèÖ</span>
                        <div>
                            <h3 style="color:#ffd700;margin:0;font-size:1.15em;letter-spacing:0.5px">Spurthi Youth Fest 2026 ‚Äî Class of the Year</h3>
                            <p style="color:rgba(255,255,255,0.7);margin:3px 0 0;font-size:12px">Davan Institute of Advanced Management Studies, Davangere</p>
                        </div>
                    </div>
                    <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:10px;margin-bottom:14px">
                        <div style="background:rgba(255,255,255,0.08);border-radius:8px;padding:10px 14px;border-left:3px solid #ffd700">
                            <p style="color:#ffd700;font-size:11px;font-weight:700;margin:0 0 3px;text-transform:uppercase;letter-spacing:1px">Competition</p>
                            <p style="color:#fff;font-size:13px;margin:0">11 Teams competing across 16 Events</p>
                        </div>
                        <div style="background:rgba(255,255,255,0.08);border-radius:8px;padding:10px 14px;border-left:3px solid #c44569">
                            <p style="color:#ff8ab0;font-size:11px;font-weight:700;margin:0 0 3px;text-transform:uppercase;letter-spacing:1px">Event Period</p>
                            <p style="color:#fff;font-size:13px;margin:0">1st to 18th March 2026</p>
                        </div>
                        <div style="background:rgba(255,255,255,0.08);border-radius:8px;padding:10px 14px;border-left:3px solid #4caf50">
                            <p style="color:#a5d6a7;font-size:11px;font-weight:700;margin:0 0 3px;text-transform:uppercase;letter-spacing:1px">Points Sources</p>
                            <p style="color:#fff;font-size:13px;margin:0">YF Reg ¬∑ Quiz ¬∑ Event Results ¬∑ Custom</p>
                        </div>
                        <div style="background:rgba(255,255,255,0.08);border-radius:8px;padding:10px 14px;border-left:3px solid #2196f3">
                            <p style="color:#90caf9;font-size:11px;font-weight:700;margin:0 0 3px;text-transform:uppercase;letter-spacing:1px">Declared By</p>
                            <p style="color:#fff;font-size:13px;margin:0">Super Admin ¬∑ Spurthi Youth Fest Committee</p>
                        </div>
                    </div>
                    <p style="color:rgba(255,255,255,0.6);font-size:12px;margin:0;border-top:1px solid rgba(255,255,255,0.12);padding-top:10px">
                        ‚ö†Ô∏è The leaderboard is <strong style="color:#ffd700">hidden from students</strong> until you publish it. Use the visibility toggle below to go live when results are final.
                    </p>
                </div>

                <p style="color:#555;margin-bottom:15px;font-size:13px;background:#fff3cd;padding:10px 16px;border-radius:8px;border-left:4px solid #ffc107">
                    ‚öôÔ∏è Control what counts toward <strong style="color:#c44569">Class of the Year 2026</strong>. 
                    Event results are pulled automatically when published. You can also add custom criteria and assign points manually.
                </p>

                <!-- ‚îÄ‚îÄ PUBLISH TOGGLE ‚îÄ‚îÄ -->
                <div style="background:linear-gradient(135deg,#1a0030 0%,#6a1b9a 100%);padding:20px;border-radius:12px;margin-bottom:25px;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:15px">
                    <div>
                        <h3 style="color:#fff;margin:0 0 5px">üëÅ Leaderboard Visibility</h3>
                        <p style="color:rgba(255,255,255,0.75);margin:0;font-size:13px">When hidden, students cannot see the leaderboard at all. Publish only when you are ready.</p>
                    </div>
                    <div style="display:flex;gap:10px;align-items:center">
                        <span id="lbVisibilityStatus" style="color:#ffd700;font-weight:700;font-size:1em">‚è≥ Checking‚Ä¶</span>
                        <button id="lbPublishBtn" class="btn btn-success" onclick="toggleLeaderboardPublish()" style="min-width:160px">üì¢ Publish Leaderboard</button>
                    </div>
                </div>

                <div id="lbAdminMessage" class="message"></div>

                <!-- ‚îÄ‚îÄ SECTION 1: Scoring Config ‚îÄ‚îÄ -->
                <div style="background:#f9f5ff;padding:20px;border-radius:12px;margin-bottom:25px;border:2px solid #e0d0ff">
                    <h3 style="color:#6a1b9a;margin-bottom:15px">‚öôÔ∏è Base Scoring Configuration</h3>
                    <p style="color:#666;font-size:13px;margin-bottom:15px">These values control how automatic points are calculated. Changes save instantly and affect the public leaderboard.</p>
                    <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:15px">
                        <div class="form-group" style="margin:0">
                            <label>üé§ Youthfest Reg: pts per event enrolled</label>
                            <input type="number" id="lbCfgYfPts" value="10" min="0" max="1000" style="border:2px solid #c44569">
                        </div>
                        <div class="form-group" style="margin:0">
                            <label>üèÜ Youthfest Winner: pts per event win</label>
                            <input type="number" id="lbCfgWinPts" value="50" min="0" max="1000" style="border:2px solid #ffc107">
                        </div>
                        <div class="form-group" style="margin:0">
                            <label>ü•à Youthfest Runner-Up: pts per event</label>
                            <input type="number" id="lbCfgRunPts" value="30" min="0" max="1000" style="border:2px solid #6c757d">
                        </div>
                    </div>

                    <!-- Quiz-specific scoring (new) -->
                    <div style="margin-top:18px;padding:15px;background:#e8f5e9;border-radius:10px;border:2px solid #a5d6a7">
                        <h4 style="color:#1b5e20;margin-bottom:12px">üß† Quiz Competition ‚Äî Points per Daily Quiz Day</h4>
                        <p style="color:#333;font-size:12px;margin-bottom:14px">
                            Quiz points are awarded <strong>per published quiz day only</strong> (Super Admin must publish winner).<br>
                            Three criteria combine for each class on each published day:
                        </p>
                        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px">
                            <div class="form-group" style="margin:0">
                                <label style="color:#1b5e20">ü•á Quiz Daily Winner class gets (pts)</label>
                                <input type="number" id="lbCfgQuizWinPts" value="20" min="0" max="500" style="border:2px solid #4caf50">
                                <small style="color:#333">Flat bonus to the class of the declared daily winner</small>
                            </div>
                            <div class="form-group" style="margin:0">
                                <label style="color:#1b5e20">ü•à Quiz Daily Runner-Up class gets (pts)</label>
                                <input type="number" id="lbCfgQuizRunPts" value="10" min="0" max="500" style="border:2px solid #81c784">
                                <small style="color:#333">Flat bonus to the class of the declared runner-up</small>
                            </div>
                            <div class="form-group" style="margin:0">
                                <label style="color:#1b5e20">üìä Participation Rate bonus: max pts for 100% rate</label>
                                <input type="number" id="lbCfgQuizMaxPts" value="10" min="0" max="100" style="border:2px solid #66bb6a">
                                <small style="color:#333">Fair across class sizes ‚Äî based on % of class that got max score</small>
                            </div>
                        </div>

                        <!-- Class strength setup -->
                        <div style="margin-top:14px;background:white;padding:14px;border-radius:8px;border:1px solid #a5d6a7">
                            <h5 style="color:#1b5e20;margin:0 0 10px">üè´ Set Class Strength (for fair participation rate)</h5>
                            <p style="color:#333;font-size:12px;margin-bottom:12px">
                                Enter the total number of students in each class. The participation rate bonus is calculated as:<br>
                                <strong style="color:#1b5e20">(Number of students who got max score in class √∑ Class Strength) √ó Max Pts</strong><br>
                                This means a class of 35 and a class of 60 are judged equally fairly.
                            </p>
                            <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:8px" id="lbClassStrengthGrid">
                                <p style="color:#aaa;font-size:12px">Loading‚Ä¶</p>
                            </div>
                            <div style="display:flex;align-items:center;gap:12px;flex-wrap:wrap;margin-top:10px">
                                <button class="btn btn-small btn-info" onclick="saveLbClassStrengths()">üíæ Save Class Strengths</button>
                                <span id="lbStrSaveMsg" style="display:none;background:#d4edda;color:#155724;border:1px solid #c3e6cb;padding:7px 14px;border-radius:6px;font-size:13px;font-weight:600">‚úÖ Class strengths saved!</span>
                                <span id="lbStrErrMsg"  style="display:none;background:#f8d7da;color:#721c24;border:1px solid #f5c6cb;padding:7px 14px;border-radius:6px;font-size:13px;font-weight:600"></span>
                            </div>
                        </div>

                        <div style="margin-top:12px;background:#f1f8e9;padding:10px;border-radius:8px;border:1px solid #c5e1a5">
                            <p style="margin:0;color:#33691e;font-size:12px">
                                <strong>Example:</strong> Class "2ND BBA" has strength 35. On a quiz day, 7 students score max (2/2).<br>
                                Participation rate = 7/35 = 20%. Bonus = 20% √ó 10 = <strong>2 pts</strong>.<br>
                                Class "1ST BCA" has strength 60. 12 students score max = 12/60 = 20% ‚Üí same 2 pts. ‚úÖ Fair!
                            </p>
                        </div>
                    </div>
                    <div style="display:flex;align-items:center;gap:12px;flex-wrap:wrap;margin-top:15px">
                        <button class="btn btn-success" onclick="saveLbConfig()">üíæ Save Config</button>
                        <span id="lbCfgSaveMsg" style="display:none;background:#d4edda;color:#155724;border:1px solid #c3e6cb;padding:7px 14px;border-radius:6px;font-size:13px;font-weight:600">‚úÖ Config saved! Leaderboard updates in ‚â§60s</span>
                        <span id="lbCfgErrMsg"  style="display:none;background:#f8d7da;color:#721c24;border:1px solid #f5c6cb;padding:7px 14px;border-radius:6px;font-size:13px;font-weight:600"></span>
                    </div>
                </div>

                <!-- ‚îÄ‚îÄ SECTION 2: Published Results Impact ‚îÄ‚îÄ -->
                <div style="background:#f0fff4;padding:20px;border-radius:12px;margin-bottom:25px;border:2px solid #b2dfdb">
                    <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:10px;margin-bottom:15px">
                        <h3 style="color:#155724;margin:0">üì¢ Published Event Results ‚Üí Points</h3>
                        <button class="btn btn-small btn-info" onclick="loadLbPublishedResults()">üîÑ Refresh</button>
                    </div>
                    <p style="color:#555;font-size:13px;margin-bottom:15px">
                        When you publish results for a Youthfest event, the winning class gets <strong id="lbWinPtsDisplay">50</strong> pts 
                        and runner-up gets <strong id="lbRunPtsDisplay">30</strong> pts automatically on the leaderboard.<br>
                        For the <strong>Quiz Competition</strong>, quiz points (winner class, runner-up class, max-correct bonus) are added 
                        automatically each day you publish a quiz winner.
                    </p>
                    <div id="lbPublishedResultsList">
                        <p style="color:#aaa;font-size:13px">Click Refresh to load published results‚Ä¶</p>
                    </div>
                </div>

                <!-- ‚îÄ‚îÄ SECTION 3: Custom Criteria ‚îÄ‚îÄ -->
                <div style="background:#fff8e1;padding:20px;border-radius:12px;margin-bottom:25px;border:2px solid #ffe082">
                    <h3 style="color:#e65100;margin-bottom:8px">‚ú® Custom Criteria (Manual Points)</h3>
                    <p style="color:#666;font-size:13px;margin-bottom:15px">
                        Add any extra scoring category (e.g., "Best Dressed Class", "Punctuality", "Attendance") and assign points per class manually.
                    </p>

                    <!-- Add new criterion -->
                    <div style="background:white;padding:15px;border-radius:8px;margin-bottom:15px;border:1px solid #ffe082">
                        <h4 style="color:#856404;margin-bottom:12px">‚ûï Add New Criterion</h4>
                        <div style="display:grid;grid-template-columns:1fr auto;gap:10px;align-items:end">
                            <div class="form-group" style="margin:0">
                                <label>Criterion Name:</label>
                                <input type="text" id="lbNewCriterionName" placeholder="e.g., Best Decorated Class, Punctuality‚Ä¶">
                            </div>
                            <button class="btn btn-small" onclick="addLbCriterion()" style="height:46px;white-space:nowrap">+ Add</button>
                        </div>
                    </div>

                    <!-- Existing criteria list -->
                    <div id="lbCriteriaList">
                        <p style="color:#aaa;font-size:13px;text-align:center;padding:20px">Loading custom criteria‚Ä¶</p>
                    </div>
                </div>

                <!-- ‚îÄ‚îÄ SECTION 4: Full Points Preview ‚îÄ‚îÄ -->
                <div style="background:linear-gradient(135deg,#1a0030 0%,#3d0060 100%);padding:20px;border-radius:12px;border:2px solid rgba(255,215,0,0.3)">
                    <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:10px;margin-bottom:8px">
                        <h3 style="color:#ffd700;margin:0">üëÅ Live Points Preview (All Sources)</h3>
                        <div style="display:flex;gap:8px;align-items:center">
                            <span id="lbPreviewUpdated" style="color:rgba(255,255,255,0.5);font-size:11px"></span>
                            <button class="btn btn-small btn-info" onclick="loadLbAdminPreview()">üîÑ Refresh</button>
                        </div>
                    </div>
                    <p style="color:rgba(255,255,255,0.6);font-size:12px;margin-bottom:15px">‚ö†Ô∏è This is exactly what the public leaderboard will show. Verify before publishing.</p>
                    <div id="lbAdminPreview">
                        <p style="color:rgba(255,255,255,0.4);text-align:center;padding:20px">Loading preview‚Ä¶</p>
                    </div>
                </div>
            </div>
        </div>
        <!-- ‚îÄ‚îÄ End Leaderboard Admin Panel ‚îÄ‚îÄ -->

        <!-- Jury Section -->
        <div class="jury-only" id="jurySection">
            <button class="btn btn-secondary" onclick="logout()" style="float:right">Logout</button>
            
            <div class="content">
                <h2 style="color:#c44569;margin-bottom:20px" id="juryEventTitle">Jury Evaluation Sheet</h2>
                <p style="margin-bottom:20px;color:#666" id="juryInfo"></p>
                
                <div id="juryMessage" class="message"></div>
                
                <div style="margin-bottom:20px;text-align:center">
                    <button class="btn btn-info" onclick="loadJurySheet()" style="margin-right:10px">üîÑ Reload Sheet</button>
                    <button class="btn btn-secondary" onclick="showEnrollmentDebug()">üìä Show Enrollments</button>
                </div>
                
                <div id="jurySheetContainer"></div>
                
                <div style="margin-top:30px;text-align:center">
                    <button class="btn btn-success" onclick="saveMarks()">üíæ Save Marks</button>
                    <button class="btn btn-info" onclick="markAsCompleted()" style="margin-left:10px">‚úÖ Mark as Completed</button>
                </div>
            </div>
        </div>
        
        <!-- ============================================ -->
        <!-- DAILY QUIZ COMPETITION SYSTEM                -->
        <!-- ============================================ -->
        
        <!-- Quiz Student Dashboard -->
        <div id="quizStudentDashboard" style="display:none">
            <!-- Fixed header bar -->
            <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:10px;margin-bottom:20px">
                <h2 style="color:#fff;margin:0;font-size:clamp(1em,3vw,1.4em);display:flex;align-items:center;gap:10px;text-shadow:1px 1px 3px rgba(0,0,0,0.5)">
                    üéì <span>Daily Quiz Competition</span>
                    <span id="quizStudentNameBadge" class="badge" style="background:#28a745;color:white;padding:6px 14px;border-radius:20px;font-size:0.75em;white-space:nowrap"></span>
                </h2>
                <button class="btn btn-secondary" onclick="logout()" style="white-space:nowrap;flex-shrink:0">Logout</button>
            </div>
            <div id="quizStudentMessage" class="message"></div>
            
            <div class="content">
                <h3 style="color:#6a1b9a;margin-bottom:8px">Welcome, <span id="quizStudentName"></span>!</h3>
                <p style="margin-bottom:16px"><strong>Email:</strong> <span id="quizStudentEmail"></span> | <strong>Class:</strong> <span id="quizStudentClass"></span></p>

                <!-- Live Date & Time Banner -->
                <div style="background:linear-gradient(135deg,#6a1b9a 0%,#c44569 100%);border-radius:12px;padding:16px 20px;margin-bottom:22px;display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:12px;box-shadow:0 4px 15px rgba(106,27,154,0.3)">
                    <div style="display:flex;align-items:center;gap:12px;flex-wrap:wrap">
                        <div style="text-align:center;background:rgba(255,255,255,0.15);border-radius:10px;padding:10px 16px;min-width:80px">
                            <div style="color:rgba(255,255,255,0.75);font-size:10px;text-transform:uppercase;letter-spacing:1px;margin-bottom:3px">Day</div>
                            <div id="quizLiveDay" style="color:#fff;font-size:1.2em;font-weight:700"></div>
                        </div>
                        <div style="text-align:center;background:rgba(255,255,255,0.15);border-radius:10px;padding:10px 16px;min-width:110px">
                            <div style="color:rgba(255,255,255,0.75);font-size:10px;text-transform:uppercase;letter-spacing:1px;margin-bottom:3px">Date</div>
                            <div id="quizLiveDate" style="color:#ffd700;font-size:1.05em;font-weight:700"></div>
                        </div>
                        <div style="text-align:center;background:rgba(255,255,255,0.15);border-radius:10px;padding:10px 16px;min-width:95px">
                            <div style="color:rgba(255,255,255,0.75);font-size:10px;text-transform:uppercase;letter-spacing:1px;margin-bottom:3px">Time</div>
                            <div id="quizLiveTime" style="color:#a5ffb8;font-size:1.2em;font-weight:700;letter-spacing:1px"></div>
                        </div>
                    </div>
                    <div id="quizLiveAmPm" style="color:rgba(255,255,255,0.85);font-size:0.85em;font-weight:600;text-align:right;line-height:1.6"></div>
                </div>

                <div id="quizStatusSection">
                    <div style="background:#fff3cd;padding:20px;border-radius:12px;margin-bottom:25px;border-left:5px solid #ffc107">
                        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:15px">
                            <h3 style="color:#856404;margin:0">üìÖ Today's Quiz Status</h3>
                            <button class="btn btn-info btn-small" onclick="checkQuizTodayStatus()" style="font-size:0.9em">üîÑ Refresh Status</button>
                        </div>
                        <div id="quizStatus"></div>
                    </div>
                    
                    <div id="quizStartSection" style="display:none">
                        <div style="background:linear-gradient(135deg,#ff6b6b 0%,#ee5a6f 100%);color:white;padding:20px;border-radius:10px;margin-bottom:25px">
                            <h3 style="margin-bottom:10px">‚ö†Ô∏è Anti-Cheating Rules</h3>
                            <ul style="line-height:1.8;margin-left:20px">
                                <li>Do NOT refresh the page</li>
                                <li>Do NOT press back button</li>
                                <li>Do NOT switch tabs or minimize browser</li>
                                <li>Quiz will AUTO-SUBMIT if rules violated</li>
                                <li>You get ONE attempt per day only</li>
                            </ul>
                        </div>
                        <button class="btn btn-success" onclick="startQuiz()" style="font-size:1.2em;padding:18px">üöÄ Start Today's Quiz</button>
                    </div>
                    
                    <div id="quizCompletedSection" style="display:none">
                        <div class="message success show">
                            <strong>‚úÖ Quiz Completed!</strong> You have successfully submitted today's quiz. Results will be announced soon.
                        </div>
                        <div style="background:#f3e5f5;border:2px solid #9c27b0;border-radius:12px;padding:18px 22px;margin-top:16px">
                            <h4 style="color:#6a1b9a;margin:0 0 12px 0;font-size:1.05em">&#128197; Next Quiz Schedule</h4>
                            <div style="display:flex;flex-wrap:wrap;gap:12px">
                                <div style="background:white;border-radius:8px;padding:10px 18px;flex:1;min-width:150px;border-left:4px solid #4caf50;text-align:center">
                                    <div style="color:#666;font-size:0.78em;text-transform:uppercase;letter-spacing:1px;margin-bottom:4px">Next Quiz Starts At</div>
                                    <div style="color:#2e7d32;font-weight:800;font-size:1.1em" id="nextQuizStartTime">Loading...</div>
                                </div>
                                <div style="background:white;border-radius:8px;padding:10px 18px;flex:1;min-width:150px;border-left:4px solid #f44336;text-align:center">
                                    <div style="color:#666;font-size:0.78em;text-transform:uppercase;letter-spacing:1px;margin-bottom:4px">Next Quiz Ends At</div>
                                    <div style="color:#c62828;font-weight:800;font-size:1.1em" id="nextQuizEndTime">Loading...</div>
                                </div>
                                <div style="background:white;border-radius:8px;padding:10px 18px;flex:1;min-width:150px;border-left:4px solid #9c27b0;text-align:center">
                                    <div style="color:#666;font-size:0.78em;text-transform:uppercase;letter-spacing:1px;margin-bottom:4px">Starts In</div>
                                    <div style="color:#6a1b9a;font-weight:800;font-size:1.1em" id="nextQuizCountdown">--:--:--</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div id="quizResultsSection" style="display:none">
                        <h3 style="color:#667eea;margin-top:20px">üìä Your Results</h3>
                        <div id="quizStudentResults"></div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Quiz Page -->
        <div id="quizPage" style="display:none">
            <div class="quiz-timer-box" id="quizTimer">
                ‚è±Ô∏è <span id="quizTimerValue">00:00</span>
            </div>
            
            <div class="content">
                <h2 style="color:#c44569;text-align:center;margin-bottom:10px;font-size:2em">üìù Daily Quiz Competition</h2>
                <p id="quizDateDisplay" style="text-align:center;color:#667eea;font-weight:600;margin-bottom:30px;font-size:1.2em"></p>
                <div id="quizPageMessage" class="message"></div>
                
                <div id="quizQuestionsContainer"></div>
                
                <button class="quiz-submit-btn" onclick="submitQuizAnswers()">
                    ‚úÖ Submit Quiz
                </button>
            </div>
        </div>
        
        <!-- Quiz Admin Dashboard -->
        <!-- Regular Quiz Admin Dashboard REMOVED - Only Super Admin Dashboard is used -->
    </div>

    <!-- Firebase Status Indicator -->
    <div class="firebase-status">
        <div class="status-dot status-disconnected" id="statusDot"></div>
        <span id="statusText">Connecting...</span>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirmModal" class="modal">
        <div class="modal-content">
            <div class="modal-icon">‚ö†Ô∏è</div>
            <div class="modal-header" id="modalMessage"></div>
            <div class="modal-buttons">
                <button class="btn btn-success" onclick="confirmAction()">Yes, Proceed</button>
                <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Edit Enrollment Modal -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">‚úèÔ∏è Edit Enrollment</div>
            <div id="editFormContainer"></div>
            <div class="modal-buttons">
                <button class="btn btn-success" onclick="saveEdit()">Save Changes</button>
                <button class="btn btn-secondary" onclick="closeEditModal()">Cancel</button>
            </div>
        </div>
    </div>
    
    <!-- Quiz Date Edit Modal -->
    <div id="quizDateEditModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">üìÖ Confirm Date Change</div>
            <p id="dateEditModalMessage" style="text-align:center;margin:20px 0"></p>
            <div class="modal-buttons">
                <button class="btn btn-warning" onclick="confirmDateChange()">‚úÖ Confirm</button>
                <button class="btn btn-secondary" onclick="closeQuizDateEditModal()">‚ùå Cancel</button>
            </div>
        </div>
    </div>

    <script data-cfasync="false" src="/cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script><script>
        // Firebase Configuration - YOUR ACTUAL CONFIG
        const firebaseConfig = {
            apiKey: "AIzaSyCkjglXJOsXEqGrlavYL4vQ635BV_dbMzY",
            authDomain: "spurthi-youthfest-2026.firebaseapp.com",
            databaseURL: "https://spurthi-youthfest-2026-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "spurthi-youthfest-2026",
            storageBucket: "spurthi-youthfest-2026.firebasestorage.app",
            messagingSenderId: "840281252513",
            appId: "1:840281252513:web:13f32d3239b5f5664ec6e0"
        };

        let db, ref;
        try {
            firebase.initializeApp(firebaseConfig);
            db = firebase.database();
            window.db = db;  // expose globally so leaderboard script block can use it
            ref = db.ref('youthfest-enrollments');
        } catch (e) { console.error('Firebase error:', e); }

        // Firebase Connection Status Monitor
        let isConnected = false;
        
        function updateFirebaseStatus(connected) {
            isConnected = connected;
            const statusDot = document.getElementById('statusDot');
            const statusText = document.getElementById('statusText');
            
            statusDot.className = 'status-dot';
            if (connected) {
                statusDot.classList.add('status-connected');
                statusText.textContent = 'üü¢ Database Connected';
            } else {
                statusDot.classList.add('status-disconnected');
                statusText.textContent = 'üî¥ Database Offline';
            }
        }
        
        // Check Firebase connection
        if (ref) {
            const connectedRef = db.ref('.info/connected');
            connectedRef.on('value', function(snap) {
                if (snap.val() === true) {
                    updateFirebaseStatus(true);
                } else {
                    updateFirebaseStatus(false);
                }
            });
            
            // Initial check after 2 seconds
            setTimeout(function() {
                ref.once('value').then(function() {
                    updateFirebaseStatus(true);
                }).catch(function() {
                    updateFirebaseStatus(false);
                });
            }, 2000);
        } else {
            setTimeout(function() {
                updateFirebaseStatus(false);
            }, 1000);
        }

        // Global Variables
        const classes = ['1st B.Com','2nd B.Com','3rd B.Com','1ST BCA','2ND BCA A SEC','2ND BCA B SEC','3RD BCA A SEC','3RD BCA B SEC','3RD BCA C SEC','2ND BBA','3RD BBA','Faculty/Principal/Vice-Principal/Staff','Others'];
        const events = {
            'Pod Casting': {size:'Individual',count:1,role:false,topic:true,topicLabel:'Topic',allow:false,maxPerClass:3},
            'Mime': {size:'6 Members',count:6,role:true,topic:true,topicLabel:'Theme',allow:false,maxPerClass:1},
            'Interdisciplinary': {size:'5 Members',count:5,role:true,topic:true,topicLabel:'Topic',allow:false,maxPerClass:1},
            'Ramp Walk': {size:'Individual members',count:0,role:true,topic:true,topicLabel:'Theme',show:true,allow:false,maxPerClass:999,pctMax:30,dynamicCount:true},
            'Quiz': {size:'6 Members',count:6,role:true,allow:false,maxPerClass:1},
            'Vlog': {size:'3 Members',count:3,role:true,topic:true,topicLabel:'Topic',allow:true,maxPerClass:3,vlogTopics:['Travel Vlog','Educational Vlog','Event Vlog','Shops Vlog'],multiTeam:true},
            'YouTube Advertisement': {size:'8 Members',count:8,role:true,prod:true,allow:false,maxPerClass:1},
            'Mad Ads': {size:'8 Members',count:8,role:true,topic:true,topicLabel:'Topic',allow:false,maxPerClass:1},
            'Hand Writing': {size:'Individual',count:1,role:false,lang:true,allow:false,maxPerClass:999,pctMax:15,oneAtATime:true},
            'Best out of Waste': {size:'2 Members (or Individual)',count:2,role:true,allow:true,maxPerClass:999,pctMax:10,allowIndividual:true},
            'Social Awareness Skit': {size:'8 Members',count:8,role:true,cause:true,allow:false,maxPerClass:1},
            'Talent Hunt': {size:'Individual',count:1,role:false,talent:true,allow:true,maxPerClass:6,oneAtATime:true},
            'Group Dance': {size:'5-8 Members',count:5,role:true,allow:false,maxPerClass:1,minCount:5,maxCount:8},
            'Nukkad Natak': {size:'8 to 30% of class',count:8,role:true,cause:true,causeLabel:'Different Cause',allow:false,maxPerClass:1,pctMax:30,dynamicCount:true,minCount:8,camera:true},
            'Case Analysis': {size:'2 Members',count:2,role:true,allow:false,maxPerClass:1}
        };

        let all = [];
        let currentUser = null;
        let studentClass = null;
        let crClass = null;
        let isAdmin = false;
        let isSuperAdmin = false;
        let isCR = false;
        let isJury = false;
        let juryEvent = null;
        let juryNumber = null;
        let selectedEvent = null;
        let adminPassword = 'admin123';
        let superAdminPassword = 'superadmin123';
        
        // Quiz Competition Variables
        let quizCurrentUser = null;
        let quizUserRole = null;
        let quizStartTime = null;
        let quizAntiCheatActive = false;
        let quizTimerInterval = null;

        // Initialize
        window.onload = function() {
            populateClassSelects();
            populateEventSelects();
            loadData();
            
            // Firebase connection status
            const connectedRef = db.ref('.info/connected');
            connectedRef.on('value', (snap) => {
                const dot = document.getElementById('statusDot');
                const text = document.getElementById('statusText');
                if (snap.val() === true) {
                    dot.className = 'status-dot status-connected';
                    text.textContent = 'Connected';
                } else {
                    dot.className = 'status-dot status-disconnected';
                    text.textContent = 'Disconnected';
                }
            });
        };

        function populateClassSelects() {
            const selects = ['studentClass','crClass','filterClass'];
            selects.forEach(id => {
                const sel = document.getElementById(id);
                if (sel) {
                    // For student and CR dropdowns, exclude Faculty and Others
                    const classesToShow = (id === 'studentClass' || id === 'crClass') 
                        ? classes.filter(c => c !== 'Faculty/Principal/Vice-Principal/Staff' && c !== 'Others')
                        : classes;
                    
                    classesToShow.forEach(c => {
                        const opt = document.createElement('option');
                        opt.value = c;
                        opt.textContent = c;
                        sel.appendChild(opt);
                    });
                }
            });
        }

        function populateEventSelects() {
            const selects = ['filterEvent','crFilterEvent','setupEventSelect','resultsEventSelect','juryEvent'];
            selects.forEach(id => {
                const sel = document.getElementById(id);
                if (sel) {
                    Object.keys(events).forEach(e => {
                        const opt = document.createElement('option');
                        opt.value = e;
                        opt.textContent = e;
                        sel.appendChild(opt);
                    });
                }
            });
        }

        function loadData() {
            ref.on('value', snap => {
                console.log('=== FIREBASE DATA LOADED (listener) ===');
                console.log('Snapshot exists?', snap.exists());
                
                all = [];
                let childCount = 0;
                if (snap.exists()) {
                    snap.forEach(child => {
                        childCount++;
                        const data = {id: child.key, ...child.val()};
                        console.log('Child #' + childCount + ':', child.key, '‚Üí', data.classYear, '-', data.event, '-', data.name);
                        all.push(data);
                    });
                }
                
                console.log('Total children loaded:', childCount);
                console.log('All array length:', all.length);
                
                // Show class breakdown
                const classCounts = {};
                all.forEach(e => {
                    if (!classCounts[e.classYear]) classCounts[e.classYear] = 0;
                    classCounts[e.classYear]++;
                });
                console.log('Data by class:', classCounts);
                
                if (isAdmin || isSuperAdmin) {
                    updateStats();
                    updateMaster();
                    updateEvents();
                }
                if (isCR) {
                    updateCRView();
                }
                // Update student view when data changes
                if (studentClass && document.getElementById('studentSection').style.display === 'block') {
                    if (!window._classStrengths) {
                        db.ref('leaderboardConfig/classStrengths').once('value').then(s => {
                            window._classStrengths = s.val() || {};
                            renderEventCards();
                        }).catch(() => renderEventCards());
                    } else {
                        renderEventCards();
                    }
                }
            });
        }

        function handleUserTypeChange() {
            const type = document.getElementById('userType').value;
            document.getElementById('crLogin').style.display = type === 'cr' ? 'block' : 'none';
            document.getElementById('adminLogin').style.display = type === 'admin' ? 'block' : 'none';
            document.getElementById('superAdminLogin').style.display = type === 'superadmin' ? 'block' : 'none';
            document.getElementById('juryLogin').style.display = type === 'jury' ? 'block' : 'none';
            
            // Reset competition dropdown when user type is selected
            if (type) {
                document.getElementById('competitionType').value = '';
                document.getElementById('dailyQuizLogin').style.display = 'none';
            }
        }

        function handleCompetitionChange() {
            const type = document.getElementById('competitionType').value;
            document.getElementById('dailyQuizLogin').style.display = type === 'dailyquiz' ? 'block' : 'none';
            
            // Reset user type dropdown and hide credentials when competition is selected
            if (type) {
                document.getElementById('userType').value = '';
                document.getElementById('crLogin').style.display = 'none';
                document.getElementById('adminLogin').style.display = 'none';
                document.getElementById('superAdminLogin').style.display = 'none';
                document.getElementById('juryLogin').style.display = 'none';
            }
            
            if (type === 'dailyquiz') {
                fetchServerTimeOffset(); // pre-fetch server time offset early
                populateQuizClasses();
                checkPublicQuizStatus();
            }
        }

        function studentLogin() {
            const cls = document.getElementById('studentClass').value;
            if (!cls) { alert('Please select your class'); return; }
            studentClass = cls;
            currentUser = 'Student';
            
            document.getElementById('userInfo').innerHTML = 'Logged in as: <span class="admin-badge">Student - '+cls+'</span>';
            document.getElementById('loginSection').style.display = 'none';
            document.getElementById('studentSection').style.display = 'block';
            document.getElementById('currentClassName').textContent = cls;
            document.getElementById('classIndicator').classList.add('active');
            
            // Force reload data from Firebase and then render
            console.log('=== STUDENT LOGIN ===');
            console.log('Selected class:', cls);
            console.log('Firebase ref path:', ref.toString());
            
            ref.once('value').then(snap => {
                console.log('Snapshot exists?', snap.exists());
                
                all = [];
                if (snap.exists()) {
                    snap.forEach(child => {
                        const data = {id: child.key, ...child.val()};
                        all.push(data);
                    });
                }
                
                console.log('Total records loaded:', all.length);
                
                // Log first few records
                if (all.length > 0) {
                    console.log('Sample records:');
                    all.slice(0, 3).forEach((rec, i) => {
                        console.log(`  [${i}] Class: "${rec.classYear}" | Event: "${rec.event}" | Name: "${rec.name}"`);
                    });
                }
                
                // Show all unique classes in database
                const uniqueClasses = [...new Set(all.map(e => e.classYear))];
                console.log('Unique classes in database:', uniqueClasses);
                
                // Filter for this class
                const classRecords = all.filter(e => e.classYear === cls);
                console.log(`Records matching "${cls}":`, classRecords.length);
                
                if (classRecords.length > 0) {
                    console.log('Matching records:', classRecords);
                }
                
                // Render cards and view enrollments (load class strengths for pctMax events first)
                if (!window._classStrengths) {
                    db.ref('leaderboardConfig/classStrengths').once('value').then(s => {
                        window._classStrengths = s.val() || {};
                        renderEventCards();
                    }).catch(() => renderEventCards());
                } else {
                    renderEventCards();
                }
                viewStudentClassEnrollments();
                
            }).catch(err => {
                console.error('Firebase read error:', err);
                alert('Error loading data: ' + err.message);
            });
        }

        function crLogin() {
            const cls = document.getElementById('crClass').value;
            if (!cls) { alert('Please select your class'); return; }
            
            crClass = cls;
            window.currentCRClass = cls;  // expose globally for loadCRQuizStats
            isCR = true;
            currentUser = 'CR';
            document.getElementById('userInfo').innerHTML = 'Logged in as: <span class="admin-badge">CR - '+cls+'</span>';
            document.getElementById('loginSection').style.display = 'none';
            document.getElementById('crSection').style.display = 'block';
            document.getElementById('crClassName').textContent = cls;
            
            // Pre-populate quiz date filter for CR
            populateQsDateFilter().then(() => {
                const d = document.getElementById('crQsDateFilter');
                if (d && !d.value) d.value = getQuizToday();
            });
            
            // Force reload data from Firebase and then render
            console.log('=== CR LOGIN ===');
            console.log('Selected class:', cls);
            console.log('Firebase ref path:', ref.toString());
            
            ref.once('value').then(snap => {
                console.log('Snapshot exists?', snap.exists());
                
                all = [];
                if (snap.exists()) {
                    snap.forEach(child => {
                        const data = {id: child.key, ...child.val()};
                        all.push(data);
                    });
                }
                
                console.log('Total records loaded:', all.length);
                
                // Log first few records
                if (all.length > 0) {
                    console.log('Sample records:');
                    all.slice(0, 3).forEach((rec, i) => {
                        console.log(`  [${i}] Class: "${rec.classYear}" | Event: "${rec.event}" | Name: "${rec.name}"`);
                    });
                }
                
                // Show all unique classes in database
                const uniqueClasses = [...new Set(all.map(e => e.classYear))];
                console.log('Unique classes in database:', uniqueClasses);
                
                // Filter for this class
                const classRecords = all.filter(e => e.classYear === cls);
                console.log(`Records matching "${cls}":`, classRecords.length);
                
                if (classRecords.length > 0) {
                    console.log('Matching records:', classRecords);
                }
                
                if (!window._classStrengths) {
                    db.ref('leaderboardConfig/classStrengths').once('value').then(s => {
                        window._classStrengths = s.val() || {};
                        renderCREventCards();
                    }).catch(() => renderCREventCards());
                } else {
                    renderCREventCards();
                }
                updateCREventFilter();
                updateCRView();
                
            }).catch(err => {
                console.error('Firebase read error:', err);
                alert('Error loading data: ' + err.message);
            });
        }

        function adminLogin() {
            const pwd = document.getElementById('adminPassword').value;
            if (pwd !== adminPassword) { alert('Invalid admin password'); return; }
            
            isAdmin = true;
            currentUser = 'Admin';
            document.getElementById('userInfo').innerHTML = 'Logged in as: <span class="admin-badge">Admin</span>';
            document.getElementById('loginSection').style.display = 'none';
            document.getElementById('adminSection').style.display = 'block';
            
            // Show only basic tabs for admin
            document.querySelectorAll('.super-admin-only').forEach(el => el.style.display = 'none');
            
            // Check if any results are published and show/hide Results tab
            checkResultsPublished();
            
            // Manually trigger data load from Firebase and update displays
            ref.once('value', snap => {
                all = [];
                if (snap.exists()) {
                    snap.forEach(child => {
                        const data = {id: child.key, ...child.val()};
                        all.push(data);
                    });
                }
                updateStats();
                updateMaster();
                updateEvents();
            });
        }

        function superAdminLogin() {
            const pwd = document.getElementById('superAdminPassword').value;
            if (pwd !== superAdminPassword) { alert('Invalid super admin password'); return; }
            
            isAdmin = true;
            isSuperAdmin = true;
            currentUser = 'Super Admin';
            document.getElementById('userInfo').innerHTML = 'Logged in as: <span class="super-admin-badge">Super Admin</span>';
            document.getElementById('loginSection').style.display = 'none';
            document.getElementById('adminSection').style.display = 'block';
            
            // Show all tabs including super admin tabs
            document.querySelectorAll('.super-admin-only:not(.form-section)').forEach(el => el.style.display = 'block');
            
            // Show HWP edit controls for Super Admin
            if (typeof hwpShowAdminControls === 'function') hwpShowAdminControls();
            
            // Super admin always sees Results tab
            document.getElementById('resultsTab').style.display = 'block';
            
            // Manually trigger data load from Firebase and update displays
            ref.once('value', snap => {
                all = [];
                if (snap.exists()) {
                    snap.forEach(child => {
                        const data = {id: child.key, ...child.val()};
                        all.push(data);
                    });
                }
                updateStats();
                updateMaster();
                updateEvents();
            });
        }

        function juryLogin() {
            const event = document.getElementById('juryEvent').value;
            const pwd = document.getElementById('juryPassword').value;
            const num = document.getElementById('juryNumber').value;
            
            if (!event || !pwd || !num) {
                alert('Please fill all fields');
                return;
            }
            
            // Load jury setup to get password and name
            db.ref('jurySetup/'+event).once('value').then(snap => {
                const setup = snap.val();
                if (!setup) {
                    alert('Event setup not found. Contact super admin.');
                    return;
                }
                
                const juryPassword = setup['jury'+num+'Password'];
                const juryName = setup['jury'+num+'Name'] || 'Jury ' + num;
                
                if (juryPassword === pwd) {
                    isJury = true;
                    juryEvent = event;
                    juryNumber = num;
                    currentUser = 'Jury';
                    
                    document.getElementById('userInfo').innerHTML = 'Logged in as: <span class="jury-badge">'+juryName+' - '+event+'</span>';
                    document.getElementById('loginSection').style.display = 'none';
                    document.getElementById('jurySection').style.display = 'block';
                    document.getElementById('juryEventTitle').textContent = 'Jury Evaluation - ' + event;
                    document.getElementById('juryInfo').textContent = 'You are ' + juryName + ' for ' + event;
                    
                    loadJurySheet();
                } else {
                    alert('Invalid jury password for this event');
                }
            }).catch(err => {
                alert('Error loading jury setup: ' + err.message);
            });
        }

        function reloadStudentData() {
            console.log('=== RELOADING DATA FROM FIREBASE ===');
            const statusText = document.getElementById('debugStatusText');
            if (statusText) statusText.innerHTML = 'üîÑ Reloading data from Firebase...';
            
            ref.once('value', snap => {
                console.log('Firebase snapshot exists?', snap.exists());
                console.log('Firebase snapshot:', snap.val());
                
                all = [];
                let childCount = 0;
                if (snap.exists()) {
                    snap.forEach(child => {
                        childCount++;
                        const data = {id: child.key, ...child.val()};
                        console.log('Loading child #' + childCount + ':', child.key, data);
                        all.push(data);
                    });
                }
                
                console.log('‚úÖ Data reloaded!');
                console.log('Total children processed:', childCount);
                console.log('Total records in "all" array:', all.length);
                console.log('All data:', all);
                
                // Show breakdown by class
                const classCounts = {};
                all.forEach(e => {
                    if (!classCounts[e.classYear]) classCounts[e.classYear] = 0;
                    classCounts[e.classYear]++;
                });
                console.log('Records by class:', classCounts);
                
                if (statusText) statusText.innerHTML = '‚úÖ Data reloaded! Total records: ' + all.length + ' | Classes: ' + Object.keys(classCounts).length;
                
                // Also update event cards
                renderEventCards();
                
                let msg = 'Data reloaded!\n\n';
                msg += 'Total records: ' + all.length + '\n';
                msg += 'Classes found: ' + Object.keys(classCounts).join(', ') + '\n\n';
                msg += 'Now click "View Enrollments" or "Show All DB Data"';
                alert(msg);
            }).catch(err => {
                console.error('Firebase error:', err);
                alert('Error loading data: ' + err.message);
                if (statusText) statusText.innerHTML = '‚ùå Error: ' + err.message;
            });
        }
        
        function showAllDatabaseData() {
            console.log('=== SHOWING ALL DATABASE DATA ===');
            const cont = document.getElementById('studentEnrollmentResults');
            
            if (all.length === 0) {
                cont.innerHTML = '<div style="background:#ffebee;color:#c62828;padding:15px;border-radius:6px;border:2px solid #c62828;"><strong>‚ö†Ô∏è NO DATA IN DATABASE</strong><br>The "all" array is empty. Try clicking "Reload Data" first.</div>';
                return;
            }
            
            // Group by class
            const classCounts = {};
            all.forEach(e => {
                if (!classCounts[e.classYear]) classCounts[e.classYear] = [];
                classCounts[e.classYear].push(e);
            });
            
            let html = '<div style="background:#fff;border-radius:6px;padding:15px;border:2px solid #9c27b0;">';
            html += '<h4 style="color:#9c27b0;margin-bottom:15px;">üóÑÔ∏è Complete Database View (Total: ' + all.length + ' records)</h4>';
            
            Object.keys(classCounts).sort().forEach(cls => {
                const enrollments = classCounts[cls];
                const isYourClass = cls === studentClass;
                
                html += '<div style="background:' + (isYourClass ? '#e8f5e9' : '#f5f5f5') + ';padding:12px;border-radius:6px;margin-bottom:10px;border:2px solid ' + (isYourClass ? '#4CAF50' : '#ccc') + ';">';
                html += '<h5 style="color:' + (isYourClass ? '#2e7d32' : '#333') + ';margin-bottom:8px;">';
                html += (isYourClass ? 'üëâ ' : '') + '"' + cls + '" (' + enrollments.length + ' enrollments)' + (isYourClass ? ' ‚Üê YOUR CLASS' : '');
                html += '</h5>';
                
                html += '<table style="width:100%;font-size:12px;"><thead><tr><th>Name</th><th>Phone</th><th>Event</th><th>Role</th></tr></thead><tbody>';
                enrollments.forEach(e => {
                    html += '<tr><td>' + e.name + '</td><td>' + e.phone + '</td><td>' + e.event + '</td><td>' + e.role + '</td></tr>';
                });
                html += '</tbody></table></div>';
            });
            
            html += '</div>';
            cont.innerHTML = html;
        }

        function toggleEnrollmentView() {
            const resultsDiv = document.getElementById('studentEnrollmentResults');
            const btn = document.getElementById('toggleEnrollmentBtn');
            
            if (resultsDiv.style.display === 'none') {
                resultsDiv.style.display = 'block';
                btn.textContent = 'Hide Details';
            } else {
                resultsDiv.style.display = 'none';
                btn.textContent = 'Show Details';
            }
        }

        function viewStudentClassEnrollments() {
            console.log('=== Loading class enrollments ===');
            console.log('Student Class:', studentClass);
            console.log('All enrollments count:', all.length);
            
            const cont = document.getElementById('studentEnrollmentResults');
            
            if (!studentClass) { 
                console.error('ERROR: Student class not set!');
                cont.innerHTML = '<div style="background:#ffebee;color:#c62828;padding:15px;border-radius:6px;border:2px solid #c62828;"><strong>Error:</strong> Student class not set. Please log out and log in again.</div>';
                return; 
            }
            
            console.log('Filtering enrollments for class:', studentClass);
            let classEnr = all.filter(e => e.classYear === studentClass);
            console.log('Filtered enrollments count:', classEnr.length);
            
            // Populate event filter dropdown
            const eventFilter = document.getElementById('studentEventFilter');
            const currentFilter = eventFilter.value;
            
            // Get unique events from class enrollments
            const uniqueEvents = [...new Set(classEnr.map(e => e.event))].sort();
            
            // Update dropdown options
            eventFilter.innerHTML = '<option value="">All Events</option>';
            uniqueEvents.forEach(evt => {
                const option = document.createElement('option');
                option.value = evt;
                option.textContent = evt;
                if (evt === currentFilter) option.selected = true;
                eventFilter.appendChild(option);
            });
            
            // Filter by selected event
            if (currentFilter) {
                classEnr = classEnr.filter(e => e.event === currentFilter);
            }
            
            if (classEnr.length === 0) {
                cont.innerHTML = '<div style="background:#fff3cd;color:#856404;padding:15px;border-radius:6px;border:2px solid #ffc107;text-align:center;"><h4 style="margin-bottom:10px;">No Enrollments</h4><p style="margin:0;">' + (currentFilter ? 'No enrollments found for ' + currentFilter : 'Your class has not enrolled in any events yet.') + '</p></div>';
                return; 
            }
            
            // Group by event
            const eventGroups = {};
            classEnr.forEach(e => {
                if (!eventGroups[e.event]) eventGroups[e.event] = [];
                eventGroups[e.event].push(e);
            });
            
            console.log('Event groups:', eventGroups);
            
            let h = '<div style="background:white;border-radius:6px;padding:15px;border:2px solid #4CAF50;">';
            h += '<h4 style="color:#c44569;margin-bottom:15px;">‚úÖ ' + studentClass + (currentFilter ? ' - ' + currentFilter : '') + ' - Total: ' + classEnr.length + '</h4>';
            
            // Show summary by event (only if showing all events)
            if (!currentFilter) {
                h += '<div style="margin-bottom:20px;">';
                h += '<h5 style="color:#2196F3;margin-bottom:10px;">üìä Enrolled Events:</h5>';
                h += '<div style="display:flex;flex-wrap:wrap;gap:10px;">';
                Object.keys(eventGroups).forEach(evt => {
                    h += '<span style="background:#4CAF50;color:white;padding:8px 15px;border-radius:20px;font-size:14px;font-weight:600;">' + evt + ' (' + eventGroups[evt].length + ')</span>';
                });
                h += '</div></div>';
            }
            
            // Show detailed table
            h += '<div class="table-wrapper"><table><thead><tr><th>Sl</th><th>Name</th><th>Phone</th><th>Event</th><th>Role</th><th>Details</th><th>Actions</th></tr></thead><tbody>';
            classEnr.forEach((e,i) => {
                h += '<tr><td>'+(i+1)+'</td><td>'+e.name+'</td><td>'+e.phone+'</td><td>'+e.event+'</td><td>'+e.role+'</td><td>'+getDet(e)+'</td>';
                h += '<td><button class="edit-btn" data-key="'+e.id+'" onclick="editEnrollmentByKey(this.getAttribute(\'data-key\'))">Edit</button>';
                h += '<button class="delete-btn" data-key="'+e.id+'" data-name="'+e.name+'" data-event="'+e.event+'" onclick="deleteEnrollmentByKey(this.getAttribute(\'data-key\'), this.getAttribute(\'data-name\'), this.getAttribute(\'data-event\'))">Delete</button></td></tr>';
            });
            h += '</tbody></table></div></div>';
            cont.innerHTML = h;
            
            console.log('=== Enrollment display complete ===');
        }

        function logout() {
            studentClass = null;
            crClass = null;
            isAdmin = false;
            isSuperAdmin = false;
            isCR = false;
            isJury = false;
            juryEvent = null;
            juryNumber = null;
            currentUser = null;
            
            // Quiz logout
            quizCurrentUser = null;
            quizUserRole = null;
            quizAntiCheatActive = false;
            if (quizTimerInterval) clearInterval(quizTimerInterval);
            stopQuizLiveClock();
            
            document.getElementById('userInfo').innerHTML = '';
            document.getElementById('loginSection').style.display = 'block';
            document.getElementById('studentSection').style.display = 'none';
            document.getElementById('crSection').style.display = 'none';
            document.getElementById('adminSection').style.display = 'none';
            document.getElementById('jurySection').style.display = 'none';
            document.getElementById('quizStudentDashboard').style.display = 'none';
            document.getElementById('quizAdminDashboard').style.display = 'none';
            document.getElementById('quizPage').style.display = 'none';
            document.getElementById('userType').value = '';
            handleUserTypeChange();
        }


        // Returns the effective maxPerClass for an event, factoring in pctMax + class strengths
        // classStr = { 'className': strength } from leaderboardConfig/classStrengths (Firebase)
        // We cache it in window._classStrengths
        function getEffectiveMax(cfg, cls) {
            if (!cfg.pctMax) return cfg.maxPerClass;
            const strengths = window._classStrengths || {};
            // Firebase sanitises class name keys (dots/slashes ‚Üí _)
            const key = cls ? cls.replace(/[.\[\]#$\/]/g, '_') : '';
            const strength = strengths[key] || strengths[cls] || 0;
            if (!strength) return cfg.maxPerClass; // fallback if not set
            const pctVal = Math.floor(strength * cfg.pctMax / 100);
            return Math.max(cfg.minCount || 1, pctVal);
        }

        // Load class strengths once and cache; call renderEventCards after
        function effMaxForSubmit(cfg) {
            // Used during submit when _currentEnrollCount might be stale
            const strengths = window._classStrengths || {};
            if (!cfg.pctMax) return cfg.maxPerClass;
            // Try to find strength from current context
            const cls = window.currentCRClass || studentClass || '';
            const key = cls.replace(/[.[\]#$\/]/g, '_');
            const strength = strengths[key] || strengths[cls] || 0;
            return strength ? Math.max(1, Math.floor(strength * cfg.pctMax / 100)) : 1;
        }

        async function loadClassStrengthsAndRender(renderFn) {
            try {
                const snap = await db.ref('leaderboardConfig/classStrengths').once('value');
                window._classStrengths = snap.val() || {};
            } catch(e) {
                window._classStrengths = {};
            }
            renderFn();
        }

        function renderEventCards() {
            const cont = document.getElementById('eventCardsContainer');
            cont.innerHTML = '';
            Object.keys(events).forEach(ev => {
                const cfg = events[ev];
                const enrolled = all.filter(e => e.event===ev && e.classYear===studentClass).length;
                const effMax = getEffectiveMax(cfg, studentClass);
                const enrolledCount = cfg.allowIndividual ? enrolled : (cfg.count === 1 ? enrolled : Math.ceil(enrolled / cfg.count));
                const remaining = effMax - enrolledCount;
                const isFull = remaining <= 0;
                const card = document.createElement('div');
                card.className = 'event-card' + (isFull ? ' full' : '');
                const label = cfg.pctMax ? `${enrolledCount}/${effMax} enrolled <span style="font-size:11px;opacity:0.8">(${cfg.pctMax}% of class)</span>` : `${enrolledCount}/${effMax} enrolled`;
                card.innerHTML = '<div class="event-title">'+ev+'</div><div class="event-size">'+cfg.size+'</div><div class="event-status '+(isFull?'status-full':(remaining<=1?'status-limited':'status-available'))+'">'+label+'</div>';
                if (!isFull) card.onclick = () => startEnrollment(ev);
                cont.appendChild(card);
            });
        }

        function renderCREventCards() {
            const cont = document.getElementById('crEventCardsContainer');
            cont.innerHTML = '';
            Object.keys(events).forEach(ev => {
                const cfg = events[ev];
                const enrolled = all.filter(e => e.event===ev && e.classYear===crClass).length;
                const effMax = getEffectiveMax(cfg, crClass);
                const enrolledCount = cfg.allowIndividual ? enrolled : (cfg.count === 1 ? enrolled : Math.ceil(enrolled / cfg.count));
                const remaining = effMax - enrolledCount;
                const isFull = remaining <= 0;
                const card = document.createElement('div');
                card.className = 'event-card' + (isFull ? ' full' : '');
                const label = cfg.pctMax ? `${enrolledCount}/${effMax} enrolled <span style="font-size:11px;opacity:0.8">(${cfg.pctMax}% of class)</span>` : `${enrolledCount}/${effMax} enrolled`;
                card.innerHTML = '<div class="event-title">'+ev+'</div><div class="event-size">'+cfg.size+'</div><div class="event-status '+(isFull?'status-full':(remaining<=1?'status-limited':'status-available'))+'">'+label+'</div>';
                if (!isFull) card.onclick = () => startCREnrollment(ev);
                cont.appendChild(card);
            });
        }

        async function startEnrollment(ev) {
            selectedEvent = ev;
            const cfg = events[ev];
            const enrolled = all.filter(e => e.event===ev && e.classYear===studentClass).length;
            
            // Calculate how many teams/participants are already enrolled
            const effMax = getEffectiveMax(cfg, studentClass);
            const enrolledCount = cfg.allowIndividual ? enrolled : (cfg.count === 1 ? enrolled : Math.ceil(enrolled / cfg.count));
            const remaining = effMax - enrolledCount;
            
            if (remaining <= 0) { alert('Event is full for your class'); return; }
            
            const maxLabel = cfg.pctMax ? `${effMax} (${cfg.pctMax}% of class strength)` : effMax;
            let html = '<button class="btn btn-secondary" onclick="cancelEnrollment()" style="margin-bottom:18px;padding:8px 20px">‚Üê Back to Events</button>';
            html += '<h3 style="color:#c44569;margin-bottom:12px">Enroll for: '+ev+'</h3>';
            html += '<p style="margin-bottom:20px;color:#666">'+cfg.size+' | Already Enrolled: '+enrolledCount+' / '+maxLabel+'</p>';
            if (cfg.minCount && cfg.pctMax && cfg.dynamicCount) {
                html += '<div style="background:#e3f2fd;border:1px solid #1565c0;border-radius:8px;padding:12px 16px;margin-bottom:16px;color:#0d47a1"><strong>üìã Team Size Rules:</strong> Minimum <strong>'+cfg.minCount+' members</strong> required. Maximum is <strong>'+cfg.pctMax+'% of your class strength</strong> ('+effMax+' members).</div>';
            }
            
            // For dynamicCount events (like Ramp Walk), use effMax as member count
            const actualCount = cfg.dynamicCount ? effMax : cfg.count;
            window._currentEnrollCount = actualCount; // store for submitEnrollment

            // Generate input fields based on team size
            for (let i = 0; i < actualCount; i++) {
                const roleLabel = cfg.role ? (i === 0 ? 'Captain' : 'Member '+(i+1)) : 'Participant '+(i+1);
                html += '<div class="team-member-box"><div class="member-header">'+roleLabel+'</div>';
                html += '<div class="form-group"><label>Name:</label><input type="text" id="name'+i+'" placeholder="Enter full name"></div>';
                html += '<div class="form-group"><label>Phone Number:</label><input type="tel" id="phone'+i+'" placeholder="10-digit mobile number" maxlength="10"></div>';
                html += '</div>';
            }
            // Dynamic add-member button (e.g. Group Dance: min 5, max 8)
            if (cfg.maxCount && actualCount < cfg.maxCount) {
                window._dynMemberCount = actualCount;
                window._dynMemberMax = cfg.maxCount;
                window._dynMemberRole = cfg.role;
                html += '<div id="dynMemberContainer"></div>';
                html += '<button type="button" id="dynAddMemberBtn" class="btn btn-secondary" style="margin-bottom:18px" onclick="dynAddMember()">‚ûï Add Member (' + actualCount + '/' + cfg.maxCount + ' max)</button>';
            }
            
            // Event-specific fields
            if (cfg.topic) {
                if (cfg.vlogTopics) {
                    // Fetch already-taken topics from Firebase for this class & event
                    const takenTopics = new Set();
                    try {
                        const snapT = await db.ref('youthfest-enrollments').orderByChild('event').equalTo(ev).once('value');
                        snapT.forEach(c => { const d = c.val(); if (d.classYear === studentClass && d.topic) takenTopics.add(d.topic); });
                    } catch(e) {}
                    let opts = '<option value="">-- Select Topic --</option>';
                    cfg.vlogTopics.forEach(t => {
                        const taken = takenTopics.has(t);
                        opts += `<option value="${t}" ${taken ? 'disabled style="color:#aaa"' : ''}>${t}${taken ? ' (already taken)' : ''}</option>`;
                    });
                    html += '<div class="form-group"><label>üé¨ Vlog Topic: <span style="color:red">*</span></label><select id="topic">'+opts+'</select><p style="font-size:12px;color:#856404;margin-top:6px">‚ö†Ô∏è Each team must choose a different topic. Greyed-out topics are already taken by your class.</p></div>';
                } else {
                    html += '<div class="form-group"><label>'+cfg.topicLabel+':</label><input type="text" id="topic" placeholder="Enter '+cfg.topicLabel.toLowerCase()+'"></div>';
                }
            }
            if (cfg.prod) {
                html += '<div class="form-group"><label>Product Name:</label><input type="text" id="product" placeholder="What product will you advertise?"></div>';
            }
            if (cfg.cause) {
                html += '<div class="form-group"><label>'+(cfg.causeLabel || 'Cause')+':</label><input type="text" id="cause" placeholder="Enter cause/theme"></div>';
            }
            if (cfg.camera) {
                html += '<div class="team-member-box" style="border-left:4px solid #e67e22;background:#fff8f0"><div class="member-header" style="background:linear-gradient(135deg,#e67e22,#f39c12)">üìπ Camera Person</div>';
                html += '<div class="form-group"><label>Name: <span style="color:red">*</span></label><input type="text" id="cameraName" placeholder="Enter camera person full name"></div>';
                html += '<div class="form-group"><label>Phone Number: <span style="color:red">*</span></label><input type="tel" id="cameraPhone" placeholder="10-digit mobile number" maxlength="10"></div>';
                html += '<p style="font-size:12px;color:#856404;margin-top:6px;padding:6px;background:#fff3cd;border-radius:4px">‚ö†Ô∏è Camera person is not a performer ‚Äî not counted in the team size.</p>';
                html += '</div>';
            }
            if (cfg.lang) {
                html += '<div class="form-group"><label>Languages:</label><div><label style="display:inline-block;margin-right:15px"><input type="checkbox" id="langEn" checked disabled> English</label><label style="display:inline-block;margin-right:15px"><input type="checkbox" id="langKn"> Kannada</label><label style="display:inline-block"><input type="checkbox" id="langHi"> Hindi</label></div></div>';
            }
            if (cfg.show) {
                html += '<div class="form-group"><label>Showstopper Name:</label><input type="text" id="showstopper" placeholder="Name of showstopper"></div>';
            }
            if (cfg.talent) {
                html += '<div class="form-group"><label>üé≠ Talent Type: <span style="color:red">*</span></label><select id="talentType"><option value="">-- Select Talent --</option><option>Classical Dance</option><option>Folk Dance</option><option>Western Dance</option><option>Freestyle Dance</option><option>Singing</option><option>Instrumental Music</option><option>Mimicry</option><option>Standup Comedy</option><option>Magic</option><option>Acrobatics / Gymnastics</option><option>Mono Act</option><option>Beatboxing</option><option>Other</option></select></div><div class="form-group" id="talentOtherDiv" style="display:none"><label>Specify Talent:</label><input type="text" id="talentOther" placeholder="Describe your talent"></div>';
            }
            
            // Best out of Waste: individual/team toggle
            if (cfg.allowIndividual) {
                const pctLabel = cfg.pctMax ? ` (${cfg.pctMax}% of class = ${effMax} participants)` : '';
                const toggleHtml = `<div class="form-group" style="background:#f0f4ff;border:2px solid #667eea;border-radius:10px;padding:15px;margin-bottom:18px">
                    <label style="font-weight:700;color:#667eea;font-size:1.05em">‚ôªÔ∏è Participation Type${pctLabel}:</label>
                    <div style="margin-top:10px;display:flex;gap:15px;flex-wrap:wrap">
                        <label style="display:flex;align-items:center;gap:8px;cursor:pointer;background:white;padding:10px 18px;border-radius:8px;border:2px solid #667eea;font-weight:600">
                            <input type="radio" name="bowType" value="team" id="bowTeam" checked onchange="bowToggleMember(2)"> üë• Team (2 Members)
                        </label>
                        <label style="display:flex;align-items:center;gap:8px;cursor:pointer;background:white;padding:10px 18px;border-radius:8px;border:2px solid #c44569;font-weight:600">
                            <input type="radio" name="bowType" value="individual" id="bowIndividual" onchange="bowToggleMember(1)"> üßë Individual
                        </label>
                    </div>
                    <p style="margin-top:8px;font-size:12px;color:#856404;background:#fff3cd;padding:8px;border-radius:6px">‚ö†Ô∏è 10% of your class can participate. Each person (team or individual) counts against this limit.</p>
                </div>`;
                html = html.replace('<div class="team-member-box">', toggleHtml + '<div class="team-member-box" id="bowMember0">');
                let second = false;
                html = html.replace(/<div class="team-member-box">/g, (m) => {
                    if (!second) { second = true; return m; }
                    return '<div class="team-member-box" id="bowMember1">';
                });
            }

            // For oneAtATime, show correct sequential participant number
            if (cfg.oneAtATime) {
                const participantNum = enrolledCount + 1;
                html = html.replace('Participant 1', 'Participant ' + participantNum);
                document.getElementById('enrollBtnsNormal').style.display = 'none';
                document.getElementById('enrollBtnsOneAtATime').style.display = 'block';
            } else if (cfg.multiTeam && remaining > 1) {
                document.getElementById('enrollBtnsNormal').style.display = 'none';
                document.getElementById('enrollBtnsOneAtATime').style.display = 'block';
                const addBtn = document.querySelector('#enrollBtnsOneAtATime button:first-child');
                const finBtn = document.querySelector('#enrollBtnsOneAtATime button:nth-child(2)');
                if (addBtn) addBtn.textContent = '‚úÖ Submit Team & Add Next Team';
                if (finBtn) finBtn.textContent = '‚úî Submit Team & Finish';
                const teamNum = enrolledCount + 1;
                html = '<div style="background:#e8f5e9;border:2px solid #4caf50;border-radius:10px;padding:12px 18px;margin-bottom:18px;text-align:center"><strong style="color:#1b5e20">üìã Adding Team ' + teamNum + ' of ' + effMax + ' (max for your class)</strong></div>' + html;
            } else {
                document.getElementById('enrollBtnsNormal').style.display = 'block';
                document.getElementById('enrollBtnsOneAtATime').style.display = 'none';
                const addBtn = document.querySelector('#enrollBtnsOneAtATime button:first-child');
                const finBtn = document.querySelector('#enrollBtnsOneAtATime button:nth-child(2)');
                if (addBtn) addBtn.textContent = '‚úÖ Submit & Add Another';
                if (finBtn) finBtn.textContent = '‚úî Submit & Finish';
            }

            document.getElementById('enrollmentFormContent').innerHTML = html;
            if (cfg.talent) {
                const ts = document.getElementById('talentType');
                if (ts) ts.addEventListener('change', function(){ document.getElementById('talentOtherDiv').style.display = this.value === 'Other' ? 'block' : 'none'; });
            }
            document.getElementById('eventCardsContainer').style.display = 'none';
            document.getElementById('enrollmentForm').style.display = 'block';
        }

        function bowToggleMember(count) {
            const m1 = document.getElementById('bowMember1');
            if (m1) m1.style.display = count === 2 ? 'block' : 'none';
        }

        function submitEnrollment(addAnother) {
            const cfg = events[selectedEvent];
            const members = [];
            
            // Collect all team members (use dynamic count for Ramp Walk)
            let submitCount = cfg.dynamicCount ? (window._currentEnrollCount || effMaxForSubmit(cfg)) : (cfg.maxCount ? (window._dynMemberCount || cfg.count) : cfg.count);
            if (cfg.allowIndividual) {
                const bowRadio = document.querySelector('input[name="bowType"]:checked');
                submitCount = (bowRadio && bowRadio.value === 'individual') ? 1 : 2;
            }
            for (let i = 0; i < submitCount; i++) {
                const name = document.getElementById('name'+i).value.trim();
                const phone = document.getElementById('phone'+i).value.trim();
                
                if (!name || !phone) { 
                    alert('Please fill all team member fields'); 
                    return; 
                }
                if (!/^\d{10}$/.test(phone)) { 
                    alert('Please enter valid 10-digit phone number for '+name); 
                    return; 
                }
                
                const role = cfg.role ? (i === 0 ? 'Captain' : 'Member') : 'Participant';
                members.push({name: name, phone: phone, role: role});
            }
            
            // Base data for all members
            const baseData = {
                classYear: studentClass,
                event: selectedEvent,
                timestamp: Date.now()
            };
            
            // Add event-specific fields
            if (cfg.topic) {
                const topic = document.getElementById('topic');
                const topicVal = topic ? topic.value.trim() : '';
                if (!topicVal) {
                    alert(cfg.vlogTopics ? 'Please select a Vlog topic' : 'Please enter '+cfg.topicLabel);
                    return;
                }
                // Double-check vlog topic isn't taken (race condition guard)
                if (cfg.vlogTopics) {
                    const alreadyTaken = all.filter(e => e.event === selectedEvent && e.classYear === studentClass && e.topic === topicVal).length > 0;
                    if (alreadyTaken) { alert('‚ö†Ô∏è This topic was just taken by another team! Please go back and select a different topic.'); return; }
                }
                baseData.topic = topicVal;
            }
            
            if (cfg.prod) {
                const product = document.getElementById('product');
                if (!product || !product.value.trim()) {
                    alert('Please enter product name');
                    return;
                }
                baseData.product = product.value.trim();
            }
            
            if (cfg.cause) {
                const cause = document.getElementById('cause');
                if (!cause || !cause.value.trim()) {
                    alert('Please enter '+(cfg.causeLabel || 'cause'));
                    return;
                }
                baseData.cause = cause.value.trim();
            }
            if (cfg.camera) {
                const camName = document.getElementById('cameraName');
                const camPhone = document.getElementById('cameraPhone');
                if (!camName || !camName.value.trim()) { alert('Please enter the camera person name'); return; }
                if (!camPhone || !/^\d{10}$/.test(camPhone.value.trim())) { alert('Please enter a valid 10-digit phone number for the camera person'); return; }
                baseData.cameraName = camName.value.trim();
                baseData.cameraPhone = camPhone.value.trim();
            }
            if (cfg.minCount && !cfg.maxCount && members.length < cfg.minCount) {
                alert('Minimum ' + cfg.minCount + ' members required for ' + selectedEvent);
                return;
            }
            
            if (cfg.lang) {
                const langs = ['English'];
                const kn = document.getElementById('langKn');
                const hi = document.getElementById('langHi');
                if (kn && kn.checked) langs.push('Kannada');
                if (hi && hi.checked) langs.push('Hindi');
                baseData.languages = langs.join(', ');
            }
            if (cfg.talent) {
                const talentSel = document.getElementById('talentType');
                const talentVal = talentSel ? talentSel.value.trim() : '';
                if (!talentVal) { alert('Please select a talent type'); return; }
                if (talentVal === 'Other') {
                    const otherVal = document.getElementById('talentOther') ? document.getElementById('talentOther').value.trim() : '';
                    if (!otherVal) { alert('Please specify your talent'); return; }
                    baseData.talentType = otherVal;
                } else {
                    baseData.talentType = talentVal;
                }
            }
            
            if (cfg.show) {
                const show = document.getElementById('showstopper');
                if (!show || !show.value.trim()) {
                    alert('Please enter showstopper name');
                    return;
                }
                baseData.showstopper = show.value.trim();
            }
            
            // Submit all members
            const promises = members.map(m => {
                const data = {...baseData, name: m.name, phone: m.phone, role: m.role};
                return ref.push(data);
            });
            
            // Validate minCount before submitting
            if (cfg.minCount && members.length < cfg.minCount) {
                alert('Minimum ' + cfg.minCount + ' members required for ' + selectedEvent + '. Please add at least ' + cfg.minCount + ' members.');
                return;
            }

            Promise.all(promises).then(() => {
                const eventName = selectedEvent;
                if (addAnother) {
                    showOk('‚úÖ Participant enrolled! Form ready for next participant.');
                    // Re-open form for same event ‚Äî data reloads from Firebase
                    setTimeout(() => startEnrollment(eventName), 400);
                } else {
                    showOk('Successfully enrolled '+members.length+' member(s) for '+eventName+'!');
                    cancelEnrollment();
                }
            }).catch(err => showErr('Error: '+err.message));
        }

        // Dynamic add-member for variable-size teams (e.g. Group Dance 5-8)
        function dynAddMember() {
            const current = window._dynMemberCount || 0;
            const max = window._dynMemberMax || current;
            if (current >= max) return;
            const idx = current;
            const roleLabel = window._dynMemberRole ? 'Member ' + (idx + 1) : 'Participant ' + (idx + 1);
            const box = document.createElement('div');
            box.className = 'team-member-box';
            box.id = 'dynBox' + idx;
            box.innerHTML = '<div class="member-header">' + roleLabel + '</div>' +
                '<div class="form-group"><label>Name:</label><input type="text" id="name' + idx + '" placeholder="Enter full name"></div>' +
                '<div class="form-group"><label>Phone Number:</label><input type="tel" id="phone' + idx + '" placeholder="10-digit mobile number" maxlength="10"></div>';
            document.getElementById('dynMemberContainer').appendChild(box);
            window._dynMemberCount = idx + 1;
            const btn = document.getElementById('dynAddMemberBtn');
            if (btn) {
                if (window._dynMemberCount >= max) {
                    btn.style.display = 'none';
                } else {
                    btn.textContent = '‚ûï Add Member (' + window._dynMemberCount + '/' + max + ' max)';
                }
            }
        }

        function crDynAddMember() {
            const current = window._crDynMemberCount || 0;
            const max = window._crDynMemberMax || current;
            if (current >= max) return;
            const idx = current;
            const roleLabel = window._crDynMemberRole ? 'Member ' + (idx + 1) : 'Participant ' + (idx + 1);
            const box = document.createElement('div');
            box.className = 'team-member-box';
            box.id = 'crDynBox' + idx;
            box.innerHTML = '<div class="member-header">' + roleLabel + '</div>' +
                '<div class="form-group"><label>Name:</label><input type="text" id="crName' + idx + '" placeholder="Enter student full name"></div>' +
                '<div class="form-group"><label>Phone Number:</label><input type="tel" id="crPhone' + idx + '" placeholder="10-digit mobile number" maxlength="10"></div>';
            document.getElementById('crDynMemberContainer').appendChild(box);
            window._crDynMemberCount = idx + 1;
            const btn = document.getElementById('crDynAddMemberBtn');
            if (btn) {
                if (window._crDynMemberCount >= max) {
                    btn.style.display = 'none';
                } else {
                    btn.textContent = '‚ûï Add Member (' + window._crDynMemberCount + '/' + max + ' max)';
                }
            }
        }

        function cancelEnrollment() {
            selectedEvent = null;
            document.getElementById('enrollmentForm').style.display = 'none';
            document.getElementById('eventCardsContainer').style.display = 'grid';
            document.getElementById('eventCardsContainer').scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        // CR Functions
        async function startCREnrollment(ev) {
            selectedEvent = ev;
            const cfg = events[ev];
            const enrolled = all.filter(e => e.event===ev && e.classYear===crClass).length;
            
            const effMax = getEffectiveMax(cfg, crClass);
            const enrolledCount = cfg.count === 1 ? enrolled : Math.ceil(enrolled / cfg.count);
            const remaining = effMax - enrolledCount;
            
            if (remaining <= 0) { alert('Event is full for your class'); return; }
            
            const maxLabel = cfg.pctMax ? `${effMax} (${cfg.pctMax}% of class strength)` : effMax;
            let html = '<button class="btn btn-secondary" onclick="cancelCREnrollment()" style="margin-bottom:18px;padding:8px 20px">‚Üê Back to Events</button>';
            html += '<h3 style="color:#c44569;margin-bottom:12px">Enroll Students for: '+ev+'</h3>';
            html += '<p style="margin-bottom:20px;color:#666">Class: '+crClass+' | '+cfg.size+' | Enrolled: '+enrolledCount+' / '+maxLabel+'</p>';
            if (cfg.minCount && cfg.pctMax && cfg.dynamicCount) {
                html += '<div style="background:#e3f2fd;border:1px solid #1565c0;border-radius:8px;padding:12px 16px;margin-bottom:16px;color:#0d47a1"><strong>üìã Team Size Rules:</strong> Minimum <strong>'+cfg.minCount+' members</strong> required. Maximum is <strong>'+cfg.pctMax+'% of your class strength</strong> ('+effMax+' members).</div>';
            }
            
            // Generate input fields based on team size
            const crActualCount = cfg.dynamicCount ? effMax : cfg.count;
            window._currentCREnrollCount = crActualCount;
            for (let i = 0; i < crActualCount; i++) {
                const roleLabel = cfg.role ? (i === 0 ? 'Captain' : 'Member '+(i+1)) : 'Participant '+(i+1);
                html += '<div class="team-member-box"><div class="member-header">'+roleLabel+'</div>';
                html += '<div class="form-group"><label>Name:</label><input type="text" id="crName'+i+'" placeholder="Enter student full name"></div>';
                html += '<div class="form-group"><label>Phone Number:</label><input type="tel" id="crPhone'+i+'" placeholder="10-digit mobile number" maxlength="10"></div>';
                html += '</div>';
            }
            // Dynamic add-member button for CR (e.g. Group Dance: min 5, max 8)
            if (cfg.maxCount && crActualCount < cfg.maxCount) {
                window._crDynMemberCount = crActualCount;
                window._crDynMemberMax = cfg.maxCount;
                window._crDynMemberRole = cfg.role;
                html += '<div id="crDynMemberContainer"></div>';
                html += '<button type="button" id="crDynAddMemberBtn" class="btn btn-secondary" style="margin-bottom:18px" onclick="crDynAddMember()">‚ûï Add Member (' + crActualCount + '/' + cfg.maxCount + ' max)</button>';
            }
            
            // Event-specific fields
            if (cfg.topic) {
                if (cfg.vlogTopics) {
                    const takenTopics = new Set();
                    try {
                        const snapT = await db.ref('youthfest-enrollments').orderByChild('event').equalTo(ev).once('value');
                        snapT.forEach(c => { const d = c.val(); if (d.classYear === crClass && d.topic) takenTopics.add(d.topic); });
                    } catch(e) {}
                    let opts = '<option value="">-- Select Topic --</option>';
                    cfg.vlogTopics.forEach(t => {
                        const taken = takenTopics.has(t);
                        opts += `<option value="${t}" ${taken ? 'disabled style="color:#aaa"' : ''}>${t}${taken ? ' (already taken)' : ''}</option>`;
                    });
                    html += '<div class="form-group"><label>üé¨ Vlog Topic: <span style="color:red">*</span></label><select id="crTopic">'+opts+'</select><p style="font-size:12px;color:#856404;margin-top:6px">‚ö†Ô∏è Each team must choose a different topic. Greyed-out topics are already taken by your class.</p></div>';
                } else {
                    html += '<div class="form-group"><label>'+cfg.topicLabel+':</label><input type="text" id="crTopic" placeholder="Enter '+cfg.topicLabel.toLowerCase()+'"></div>';
                }
            }
            if (cfg.prod) {
                html += '<div class="form-group"><label>Product Name:</label><input type="text" id="crProduct" placeholder="What product will they advertise?"></div>';
            }
            if (cfg.cause) {
                html += '<div class="form-group"><label>'+(cfg.causeLabel || 'Cause')+':</label><input type="text" id="crCause" placeholder="Enter cause/theme"></div>';
            }
            if (cfg.camera) {
                html += '<div class="team-member-box" style="border-left:4px solid #e67e22;background:#fff8f0"><div class="member-header" style="background:linear-gradient(135deg,#e67e22,#f39c12)">üìπ Camera Person</div>';
                html += '<div class="form-group"><label>Name: <span style="color:red">*</span></label><input type="text" id="crCameraName" placeholder="Enter camera person full name"></div>';
                html += '<div class="form-group"><label>Phone Number: <span style="color:red">*</span></label><input type="tel" id="crCameraPhone" placeholder="10-digit mobile number" maxlength="10"></div>';
                html += '<p style="font-size:12px;color:#856404;margin-top:6px;padding:6px;background:#fff3cd;border-radius:4px">‚ö†Ô∏è Camera person is not a performer ‚Äî not counted in the team size.</p>';
                html += '</div>';
            }
            if (cfg.lang) {
                html += '<div class="form-group"><label>Languages:</label><div><label style="display:inline-block;margin-right:15px"><input type="checkbox" id="crLangEn" checked disabled> English</label><label style="display:inline-block;margin-right:15px"><input type="checkbox" id="crLangKn"> Kannada</label><label style="display:inline-block"><input type="checkbox" id="crLangHi"> Hindi</label></div></div>';
            }
            if (cfg.show) {
                html += '<div class="form-group"><label>Showstopper Name:</label><input type="text" id="crShowstopper" placeholder="Name of showstopper"></div>';
            }
            if (cfg.talent) {
                html += '<div class="form-group"><label>üé≠ Talent Type: <span style="color:red">*</span></label><select id="crTalentType"><option value="">-- Select Talent --</option><option>Classical Dance</option><option>Folk Dance</option><option>Western Dance</option><option>Freestyle Dance</option><option>Singing</option><option>Instrumental Music</option><option>Mimicry</option><option>Standup Comedy</option><option>Magic</option><option>Acrobatics / Gymnastics</option><option>Mono Act</option><option>Beatboxing</option><option>Other</option></select></div><div class="form-group" id="crTalentOtherDiv" style="display:none"><label>Specify Talent:</label><input type="text" id="crTalentOther" placeholder="Describe your talent"></div>';
            }
            
            if (cfg.allowIndividual) {
                const pctLabel = cfg.pctMax ? ` (${cfg.pctMax}% of class = ${effMax} participants)` : '';
                const toggleHtml = `<div class="form-group" style="background:#f0f4ff;border:2px solid #667eea;border-radius:10px;padding:15px;margin-bottom:18px">
                    <label style="font-weight:700;color:#667eea;font-size:1.05em">‚ôªÔ∏è Participation Type${pctLabel}:</label>
                    <div style="margin-top:10px;display:flex;gap:15px;flex-wrap:wrap">
                        <label style="display:flex;align-items:center;gap:8px;cursor:pointer;background:white;padding:10px 18px;border-radius:8px;border:2px solid #667eea;font-weight:600">
                            <input type="radio" name="crBowType" value="team" id="crBowTeam" checked onchange="crBowToggleMember(2)"> üë• Team (2 Members)
                        </label>
                        <label style="display:flex;align-items:center;gap:8px;cursor:pointer;background:white;padding:10px 18px;border-radius:8px;border:2px solid #c44569;font-weight:600">
                            <input type="radio" name="crBowType" value="individual" id="crBowIndividual" onchange="crBowToggleMember(1)"> üßë Individual
                        </label>
                    </div>
                    <p style="margin-top:8px;font-size:12px;color:#856404;background:#fff3cd;padding:8px;border-radius:6px">‚ö†Ô∏è 10% of your class can participate. Each person counts against this limit.</p>
                </div>`;
                html = html.replace('<div class="team-member-box">', toggleHtml + '<div class="team-member-box" id="crBowMember0">');
                let second = false;
                html = html.replace(/<div class="team-member-box">/g, (m) => {
                    if (!second) { second = true; return m; }
                    return '<div class="team-member-box" id="crBowMember1">';
                });
            }

            if (cfg.oneAtATime) {
                const participantNum = enrolledCount + 1;
                html = html.replace('Participant 1', 'Participant ' + participantNum);
                document.getElementById('crEnrollBtnsNormal').style.display = 'none';
                document.getElementById('crEnrollBtnsOneAtATime').style.display = 'block';
            } else if (cfg.multiTeam && remaining > 1) {
                document.getElementById('crEnrollBtnsNormal').style.display = 'none';
                document.getElementById('crEnrollBtnsOneAtATime').style.display = 'block';
                const addBtn = document.querySelector('#crEnrollBtnsOneAtATime button:first-child');
                const finBtn = document.querySelector('#crEnrollBtnsOneAtATime button:nth-child(2)');
                if (addBtn) addBtn.textContent = '‚úÖ Submit Team & Add Next Team';
                if (finBtn) finBtn.textContent = '‚úî Submit Team & Finish';
                const teamNum = enrolledCount + 1;
                html = '<div style="background:#e8f5e9;border:2px solid #4caf50;border-radius:10px;padding:12px 18px;margin-bottom:18px;text-align:center"><strong style="color:#1b5e20">üìã Adding Team ' + teamNum + ' of ' + effMax + ' (max for your class)</strong></div>' + html;
            } else {
                document.getElementById('crEnrollBtnsNormal').style.display = 'block';
                document.getElementById('crEnrollBtnsOneAtATime').style.display = 'none';
                const addBtn = document.querySelector('#crEnrollBtnsOneAtATime button:first-child');
                const finBtn = document.querySelector('#crEnrollBtnsOneAtATime button:nth-child(2)');
                if (addBtn) addBtn.textContent = '‚úÖ Submit & Add Another';
                if (finBtn) finBtn.textContent = '‚úî Submit & Finish';
            }

            document.getElementById('crEnrollmentFormContent').innerHTML = html;
            if (cfg.talent) {
                const ts = document.getElementById('crTalentType');
                if (ts) ts.addEventListener('change', function(){ document.getElementById('crTalentOtherDiv').style.display = this.value === 'Other' ? 'block' : 'none'; });
            }
            document.getElementById('crEventCardsContainer').style.display = 'none';
            document.getElementById('crEnrollmentForm').style.display = 'block';
        }

        function crBowToggleMember(count) {
            const m1 = document.getElementById('crBowMember1');
            if (m1) m1.style.display = count === 2 ? 'block' : 'none';
        }

        function submitCREnrollment(addAnother) {
            const cfg = events[selectedEvent];
            const members = [];
            
            // Collect all team members (use dynamic count for Ramp Walk)
            let crSubmitCount = cfg.dynamicCount ? (window._currentCREnrollCount || 1) : (cfg.maxCount ? (window._crDynMemberCount || cfg.count) : cfg.count);
            if (cfg.allowIndividual) {
                const crBowRadio = document.querySelector('input[name="crBowType"]:checked');
                crSubmitCount = (crBowRadio && crBowRadio.value === 'individual') ? 1 : 2;
            }
            for (let i = 0; i < crSubmitCount; i++) {
                const name = document.getElementById('crName'+i).value.trim();
                const phone = document.getElementById('crPhone'+i).value.trim();
                
                if (!name || !phone) { 
                    alert('Please fill all team member fields'); 
                    return; 
                }
                if (!/^\d{10}$/.test(phone)) { 
                    alert('Please enter valid 10-digit phone number for '+name); 
                    return; 
                }
                
                const role = cfg.role ? (i === 0 ? 'Captain' : 'Member') : 'Participant';
                members.push({name: name, phone: phone, role: role});
            }
            
            // Base data for all members
            const baseData = {
                classYear: crClass,
                event: selectedEvent,
                enrolledBy: 'CR',
                timestamp: Date.now()
            };
            
            // Add event-specific fields
            if (cfg.topic) {
                const topic = document.getElementById('crTopic');
                const topicVal = topic ? topic.value.trim() : '';
                if (!topicVal) {
                    alert(cfg.vlogTopics ? 'Please select a Vlog topic' : 'Please enter '+cfg.topicLabel);
                    return;
                }
                if (cfg.vlogTopics) {
                    const alreadyTaken = all.filter(e => e.event === selectedEvent && e.classYear === crClass && e.topic === topicVal).length > 0;
                    if (alreadyTaken) { alert('‚ö†Ô∏è This topic was just taken by another team! Please go back and select a different topic.'); return; }
                }
                baseData.topic = topicVal;
            }
            
            if (cfg.prod) {
                const product = document.getElementById('crProduct');
                if (!product || !product.value.trim()) {
                    alert('Please enter product name');
                    return;
                }
                baseData.product = product.value.trim();
            }
            
            if (cfg.cause) {
                const cause = document.getElementById('crCause');
                if (!cause || !cause.value.trim()) {
                    alert('Please enter '+(cfg.causeLabel || 'cause'));
                    return;
                }
                baseData.cause = cause.value.trim();
            }
            if (cfg.camera) {
                const camName = document.getElementById('crCameraName');
                const camPhone = document.getElementById('crCameraPhone');
                if (!camName || !camName.value.trim()) { alert('Please enter the camera person name'); return; }
                if (!camPhone || !/^\d{10}$/.test(camPhone.value.trim())) { alert('Please enter a valid 10-digit phone number for the camera person'); return; }
                baseData.cameraName = camName.value.trim();
                baseData.cameraPhone = camPhone.value.trim();
            }
            if (cfg.minCount && !cfg.maxCount && members.length < cfg.minCount) {
                alert('Minimum ' + cfg.minCount + ' members required for ' + selectedEvent);
                return;
            }
            
            if (cfg.lang) {
                const langs = ['English'];
                const kn = document.getElementById('crLangKn');
                const hi = document.getElementById('crLangHi');
                if (kn && kn.checked) langs.push('Kannada');
                if (hi && hi.checked) langs.push('Hindi');
                baseData.languages = langs.join(', ');
            }
            if (cfg.talent) {
                const talentSel = document.getElementById('crTalentType');
                const talentVal = talentSel ? talentSel.value.trim() : '';
                if (!talentVal) { alert('Please select a talent type'); return; }
                if (talentVal === 'Other') {
                    const otherVal = document.getElementById('crTalentOther') ? document.getElementById('crTalentOther').value.trim() : '';
                    if (!otherVal) { alert('Please specify your talent'); return; }
                    baseData.talentType = otherVal;
                } else {
                    baseData.talentType = talentVal;
                }
            }
            
            if (cfg.show) {
                const show = document.getElementById('crShowstopper');
                if (!show || !show.value.trim()) {
                    alert('Please enter showstopper name');
                    return;
                }
                baseData.showstopper = show.value.trim();
            }
            
            // Submit all members
            const promises = members.map(m => {
                const data = {...baseData, name: m.name, phone: m.phone, role: m.role};
                return ref.push(data);
            });
            
            // Validate minCount before submitting
            if (cfg.minCount && members.length < cfg.minCount) {
                alert('Minimum ' + cfg.minCount + ' members required for ' + selectedEvent + '. Please add at least ' + cfg.minCount + ' members.');
                return;
            }

            Promise.all(promises).then(() => {
                const eventName = selectedEvent;
                if (addAnother) {
                    showCROk('‚úÖ Participant enrolled! Form ready for next participant.');
                    setTimeout(() => startCREnrollment(eventName), 400);
                } else {
                    showCROk('Successfully enrolled '+members.length+' student(s) for '+eventName+'!');
                    cancelCREnrollment();
                }
            }).catch(err => showCRErr('Error: '+err.message));
        }

        function cancelCREnrollment() {
            selectedEvent = null;
            document.getElementById('crEnrollmentForm').style.display = 'none';
            document.getElementById('crEventCardsContainer').style.display = 'grid';
            document.getElementById('crEventCardsContainer').scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        function showCRTab(tab) {
            document.querySelectorAll('#crSection .tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('#crSection .form-section').forEach(s => s.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById(tab).classList.add('active');
        }

        function updateCREventFilter() {
            const sel = document.getElementById('crFilterEvent');
            sel.innerHTML = '<option value="">All Events</option>';
            const enrolled = [...new Set(all.filter(e => e.classYear === crClass).map(e => e.event))];
            enrolled.forEach(ev => {
                const opt = document.createElement('option');
                opt.value = ev;
                opt.textContent = ev;
                sel.appendChild(opt);
            });
        }

        function updateCRView() {
            console.log('=== updateCRView called ===');
            console.log('crClass:', crClass);
            console.log('all.length:', all.length);
            
            const filterEv = document.getElementById('crFilterEvent').value;
            let filtered = all.filter(e => e.classYear === crClass);
            
            console.log('Filtered by class:', filtered.length);
            
            if (filterEv) {
                filtered = filtered.filter(e => e.event === filterEv);
                console.log('Filtered by event:', filtered.length);
            }
            
            // Summary
            let summary = '<h3 style="color:#2196F3;margin-bottom:10px">Your Class: <strong>'+crClass+'</strong></h3>';
            summary += '<p><strong>Total Students Enrolled:</strong> '+filtered.length+'</p>';
            if (filterEv) summary += '<p><strong>Event:</strong> '+filterEv+'</p>';
            document.getElementById('crSummary').innerHTML = summary;
            
            // Table
            const cont = document.getElementById('crEnrollmentsContainer');
            if (filtered.length === 0) {
                console.log('No enrollments found - showing empty message');
                cont.innerHTML = '<p style="text-align:center;padding:40px;color:#999">No enrollments yet</p>';
            } else {
                console.log('Building table with', filtered.length, 'rows');
                let html = '<div class="table-wrapper"><table><thead><tr><th>Sl</th><th>Name</th><th>Phone</th><th>Event</th><th>Role</th><th>Details</th><th>Actions</th></tr></thead><tbody>';
                filtered.forEach((e,i) => {
                    html += '<tr><td>'+(i+1)+'</td><td>'+e.name+'</td><td>'+e.phone+'</td><td>'+e.event+'</td><td>'+e.role+'</td><td>'+getDet(e)+'</td>';
                    html += '<td><button class="edit-btn" data-key="'+e.id+'" onclick="editEnrollmentByKey(this.getAttribute(\'data-key\'))">Edit</button>';
                    html += '<button class="delete-btn" data-key="'+e.id+'" data-name="'+e.name+'" data-event="'+e.event+'" onclick="deleteEnrollmentByKey(this.getAttribute(\'data-key\'), this.getAttribute(\'data-name\'), this.getAttribute(\'data-event\'))">Delete</button></td></tr>';
                });
                html += '</tbody></table></div>';
                cont.innerHTML = html;
            }
            
            // Update CR event cards to show current enrollment counts
            renderCREventCards();
        }

        function clearCRFilters() {
            document.getElementById('crFilterEvent').value = '';
            updateCRView();
        }

        function downloadCREnrollments() {
            console.log('=== DOWNLOAD CR ENROLLMENTS ===');
            console.log('CR Class:', crClass);
            console.log('Total records in all:', all.length);
            
            if (!crClass) {
                alert('Error: Class not set. Please log out and log in again.');
                return;
            }
            
            // Filter all enrollments for this CR's class
            const classEnrollments = all.filter(e => e.classYear === crClass);
            
            console.log('Filtered enrollments for', crClass, ':', classEnrollments.length);
            
            if (classEnrollments.length === 0) {
                alert('No enrollments to download for ' + crClass);
                return;
            }
            
            // Check if event filter is applied
            const filterEv = document.getElementById('crFilterEvent').value;
            let enrollmentsToDownload = classEnrollments;
            
            if (filterEv) {
                enrollmentsToDownload = classEnrollments.filter(e => e.event === filterEv);
                console.log('Filtered by event', filterEv, ':', enrollmentsToDownload.length);
            }
            
            // Create CSV content
            let csv = 'Sl,Name,Phone,Class,Event,Role,Details\n';
            enrollmentsToDownload.forEach((e, i) => {
                const details = getDet(e).replace(/<br>/g, ' | ').replace(/"/g, '""');
                csv += `${i+1},"${e.name}","${e.phone}","${e.classYear}","${e.event}","${e.role}","${details}"\n`;
            });
            
            // Generate filename
            const filename = filterEv 
                ? `${crClass}_${filterEv}_enrollments.csv`.replace(/\s+/g, '_')
                : `${crClass}_all_enrollments.csv`.replace(/\s+/g, '_');
            
            console.log('Downloading', enrollmentsToDownload.length, 'records as', filename);
            
            // Download
            download(csv, filename);
            
            showCROk(`Downloaded ${enrollmentsToDownload.length} enrollment(s) successfully!`);
        }

        function showCROk(msg) {
            const d = document.getElementById('crMessage');
            d.className = 'message success show';
            d.textContent = '‚úì '+msg;
            setTimeout(() => d.classList.remove('show'), 5000);
        }

        function showCRErr(msg) {
            const d = document.getElementById('crMessage');
            d.className = 'message error show';
            d.textContent = '‚úó '+msg;
            setTimeout(() => d.classList.remove('show'), 5000);
        }

        // Admin Functions
        function showTab(tab) {
            document.querySelectorAll('#adminSection .tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('#adminSection .form-section').forEach(s => s.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById(tab).classList.add('active');

            // Toggle white box away for leaderboard tab
            const adminBox = document.getElementById('adminContentBox');
            if (adminBox) {
                if (tab === 'leaderboardAdmin') {
                    adminBox.classList.add('lb-active');
                } else {
                    adminBox.classList.remove('lb-active');
                }
            }

            if (tab === 'results') {
                loadResultsTab();
            }
            if (tab === 'quizManagement') {
                loadQuizManagementStats();
                showQuizManagementTab('questions');
                initializeDateSelector();
            }
            if (tab === 'leaderboardAdmin') {
                if (typeof loadLbConfigIntoForm   === 'function') loadLbConfigIntoForm();
                if (typeof loadLbCriteriaList     === 'function') loadLbCriteriaList();
                if (typeof loadLbPublishedResults === 'function') loadLbPublishedResults();
                if (typeof loadLbAdminPreview     === 'function') loadLbAdminPreview();
            }
        }

        function updateStats() {
            const uniqueStudents = new Set(all.map(e => e.phone)).size;
            const uniqueClasses = new Set(all.map(e => e.classYear)).size;
            const activeEvents = new Set(all.map(e => e.event)).size;
            
            document.getElementById('totalStudents').textContent = uniqueStudents;
            document.getElementById('totalEvents').textContent = activeEvents;
            document.getElementById('totalClasses').textContent = uniqueClasses;
            document.getElementById('totalEnrollments').textContent = all.length;
        }

        function updateMaster() {
            // Use setTimeout to ensure dropdown has updated
            setTimeout(() => {
                const filterCl = document.getElementById('filterClass') ? document.getElementById('filterClass').value : '';
                const filterEv = document.getElementById('filterEvent') ? document.getElementById('filterEvent').value : '';
                
                let filtered = [...all]; // Create a copy
                
                if (filterCl) {
                    filtered = filtered.filter(e => e.classYear === filterCl);
                }
                
                if (filterEv) {
                    filtered = filtered.filter(e => e.event === filterEv);
                }
                
                updateSummary(filterCl, filterEv);
                
                const cont = document.getElementById('masterContainer');
                if (!cont) {
                    return;
                }
                
                if (filtered.length === 0) {
                    cont.innerHTML = '<p style="text-align:center;padding:40px;color:#999">No data available</p>';
                    return;
                }
                
                let html = '<div class="table-wrapper"><table><thead><tr><th>Sl</th><th>Name</th><th>Phone</th><th>Class</th><th>Event</th><th>Role</th><th>Details</th><th>Actions</th></tr></thead><tbody>';
                filtered.forEach((e,i) => {
                    html += '<tr><td>'+(i+1)+'</td><td>'+e.name+'</td><td>'+e.phone+'</td><td>'+e.classYear+'</td><td>'+e.event+'</td><td>'+e.role+'</td><td>'+getDet(e)+'</td>';
                    html += '<td><button class="edit-btn" data-key="'+e.id+'" onclick="editEnrollmentByKey(this.getAttribute(\'data-key\'))">Edit</button>';
                    html += '<button class="delete-btn" data-key="'+e.id+'" data-name="'+e.name+'" data-event="'+e.event+'" onclick="deleteEnrollmentByKey(this.getAttribute(\'data-key\'), this.getAttribute(\'data-name\'), this.getAttribute(\'data-event\'))">Delete</button></td></tr>';
                });
                html += '</tbody></table></div>';
                cont.innerHTML = html;
            }, 10); // Small delay to ensure dropdown has updated
        }

        function updateSummary(selectedClass, selectedEvent) {
            const summaryContent = document.getElementById('summaryInfo');
            let html = '<h3 style="color:#2196F3;margin-bottom:15px">üìä Summary</h3>';
            html += '<p><strong>Total Enrollments:</strong> '+all.length+'</p>';
            
            // When Event is selected (no class) - show class enrollment status
            if (!selectedClass && selectedEvent) {
                const enrolledClasses = [];
                const notEnrolledClasses = [];
                
                classes.forEach(cls => {
                    const hasEnrollment = all.some(e => e.classYear === cls && e.event === selectedEvent);
                    if (hasEnrollment) {
                        const count = all.filter(e => e.classYear === cls && e.event === selectedEvent).length;
                        enrolledClasses.push({name: cls, count: count});
                    } else {
                        notEnrolledClasses.push(cls);
                    }
                });
                
                html += '<div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;">';
                
                // Classes with Enrollments
                html += '<div style="background:#d4edda;padding:15px;border-radius:6px;border:2px solid #28a745;">';
                html += '<h4 style="color:#155724;margin-bottom:10px;">‚úÖ Classes with Enrollments (' + enrolledClasses.length + ')</h4>';
                if (enrolledClasses.length > 0) {
                    html += '<div style="display:flex;flex-wrap:wrap;gap:8px;">';
                    enrolledClasses.forEach(cls => {
                        html += '<span style="background:#28a745;color:white;padding:6px 12px;border-radius:20px;font-size:14px;font-weight:600;">' + cls.name + ' (' + cls.count + ')</span>';
                    });
                    html += '</div>';
                } else {
                    html += '<p style="color:#666;font-style:italic;margin:0;">No classes enrolled yet</p>';
                }
                html += '</div>';
                
                // Classes NOT Enrolled
                html += '<div style="background:#f8d7da;padding:15px;border-radius:6px;border:2px solid #dc3545;">';
                html += '<h4 style="color:#721c24;margin-bottom:10px;">‚ùå Classes NOT Enrolled (' + notEnrolledClasses.length + ')</h4>';
                if (notEnrolledClasses.length > 0) {
                    html += '<div style="display:flex;flex-wrap:wrap;gap:8px;">';
                    notEnrolledClasses.forEach(cls => {
                        html += '<span style="background:#dc3545;color:white;padding:6px 12px;border-radius:20px;font-size:14px;font-weight:600;">' + cls + '</span>';
                    });
                    html += '</div>';
                } else {
                    html += '<p style="color:#666;font-style:italic;margin:0;">All classes have enrolled!</p>';
                }
                html += '</div>';
                html += '</div>';
            }
            
            // When Class is selected - show event enrollment status
            if (selectedClass && !selectedEvent) {
                const enrolledEvents = [];
                const pendingEvents = [];
                
                Object.keys(events).forEach(evt => {
                    const hasEnrollment = all.some(e => e.classYear === selectedClass && e.event === evt);
                    if (hasEnrollment) {
                        const count = all.filter(e => e.classYear === selectedClass && e.event === evt).length;
                        enrolledEvents.push({name: evt, count: count});
                    } else {
                        pendingEvents.push(evt);
                    }
                });
                
                html += '<h3 style="color:#2196F3;margin-bottom:15px;">üìä Summary for Class: <strong>' + selectedClass + '</strong></h3>';
                html += '<div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;">';
                
                // Enrolled Events
                html += '<div style="background:white;padding:15px;border-radius:6px;">';
                html += '<h4 style="color:#4CAF50;margin-bottom:10px;">‚úÖ Enrolled Events (' + enrolledEvents.length + ')</h4>';
                if (enrolledEvents.length > 0) {
                    html += '<ul style="list-style:none;padding:0;margin:0;">';
                    enrolledEvents.forEach(evt => {
                        html += '<li style="padding:5px 0;border-bottom:1px solid #eee;">‚Ä¢ ' + evt.name + ' <span style="color:#666;">(' + evt.count + ' students)</span></li>';
                    });
                    html += '</ul>';
                } else {
                    html += '<p style="color:#999;font-style:italic;">No events enrolled yet</p>';
                }
                html += '</div>';
                
                // Pending Events
                html += '<div style="background:white;padding:15px;border-radius:6px;">';
                html += '<h4 style="color:#FF9800;margin-bottom:10px;">‚è≥ Pending Events (' + pendingEvents.length + ')</h4>';
                if (pendingEvents.length > 0) {
                    html += '<ul style="list-style:none;padding:0;margin:0;">';
                    pendingEvents.forEach(evt => {
                        html += '<li style="padding:5px 0;border-bottom:1px solid #eee;">‚Ä¢ ' + evt + '</li>';
                    });
                    html += '</ul>';
                } else {
                    html += '<p style="color:#999;font-style:italic;">All events completed!</p>';
                }
                html += '</div>';
                html += '</div>';
            }
            
            // When both Class and Event are selected
            if (selectedClass && selectedEvent) {
                const count = all.filter(e => e.classYear === selectedClass && e.event === selectedEvent).length;
                html += '<h3 style="color:#2196F3;margin-bottom:10px;">üìä Filtered View</h3>';
                html += '<p style="margin:0;"><strong>Class:</strong> ' + selectedClass + ' | <strong>Event:</strong> ' + selectedEvent + ' | <strong>Total Students:</strong> ' + count + '</p>';
            }
            
            summaryContent.innerHTML = html;
        }

        function updateEvents() {
            const cont = document.getElementById('eventsContainer');
            if (all.length===0) { cont.innerHTML = '<p style="text-align:center;padding:40px">No data</p>'; return; }
            let h = '';
            Object.keys(events).forEach(ev => {
                const evEnr = all.filter(e => e.event===ev);
                if (evEnr.length===0) return;
                h += '<div style="background:#f9f9f9;padding:20px;border-radius:8px;margin-bottom:20px"><h3 style="color:#c44569;margin-bottom:15px">'+ev+' ('+evEnr.length+')</h3>';
                classes.forEach(cl => {
                    const clEnr = evEnr.filter(e => e.classYear===cl);
                    if (clEnr.length===0) return;
                    h += '<div style="background:white;padding:15px;border-radius:6px;margin-bottom:15px"><h4 style="color:#6a1b9a;margin-bottom:10px">'+cl+' ('+clEnr.length+')</h4><div class="table-wrapper"><table><thead><tr><th>Sl</th><th>Name</th><th>Phone</th><th>Role</th><th>Details</th></tr></thead><tbody>';
                    clEnr.forEach((e,i) => h += '<tr><td>'+(i+1)+'</td><td>'+e.name+'</td><td>'+e.phone+'</td><td>'+e.role+'</td><td>'+getDet(e)+'</td></tr>');
                    h += '</tbody></table></div></div>';
                });
                h += '</div>';
            });
            cont.innerHTML = h;
        }

        function clearFilters() {
            document.getElementById('filterClass').value = '';
            document.getElementById('filterEvent').value = '';
            updateMaster();
        }

        function getDet(e) {
            const d = [];
            if (e.topic) d.push('Topic: '+e.topic);
            if (e.product) d.push('Product: '+e.product);
            if (e.cause) d.push('Cause: '+e.cause);
            if (e.languages) d.push('Languages: '+e.languages);
            if (e.showstopper) d.push('Showstopper: '+e.showstopper);
            if (e.talentType) d.push('Talent: '+e.talentType);
            if (e.cameraName) d.push('üìπ Camera: '+e.cameraName+(e.cameraPhone ? ' ('+e.cameraPhone+')' : ''));
            return d.length>0 ? d.join('<br>') : '-';
        }

        function downloadMaster() {
            if (all.length===0) { alert('No data'); return; }
            let csv = 'Sl,Name,Phone,Class,Event,Role,Details\n';
            all.forEach((e,i) => csv += (i+1)+',"'+e.name+'","'+e.phone+'","'+e.classYear+'","'+e.event+'","'+e.role+'","'+getDet(e).replace(/<br>/g,' | ')+'"\n');
            download(csv,'youthfest_master.csv');
        }

        function downloadEvents() {
            if (all.length===0) { alert('No data'); return; }
            let csv = '';
            Object.keys(events).forEach(ev => {
                const evEnr = all.filter(e => e.event===ev);
                if (evEnr.length===0) return;
                csv += '\n'+ev+'\n';
                csv += 'Sl,Name,Phone,Class,Role,Details\n';
                let sl = 1;
                evEnr.forEach(e => { csv += sl+',"'+e.name+'","'+e.phone+'","'+e.classYear+'","'+e.role+'","'+getDet(e).replace(/<br>/g,' | ')+'"\n'; sl++; });
            });
            download(csv,'youthfest_events.csv');
        }

        function download(content,filename) {
            const blob = new Blob([content],{type:'text/csv'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            URL.revokeObjectURL(url);
        }

        // Jury Setup Functions (Super Admin Only)
        function loadEventSetup() {
            const event = document.getElementById('setupEventSelect').value;
            if (!event) {
                document.getElementById('eventSetupContainer').style.display = 'none';
                return;
            }
            
            document.getElementById('eventSetupContainer').style.display = 'block';
            
            // Load existing setup
            db.ref('jurySetup/'+event).once('value').then(snap => {
                const data = snap.val() || {};
                
                // Load jury names
                document.getElementById('jury1Name').value = data.jury1Name || '';
                document.getElementById('jury2Name').value = data.jury2Name || '';
                
                // Load jury passwords
                document.getElementById('jury1Password').value = data.jury1Password || '';
                document.getElementById('jury2Password').value = data.jury2Password || '';
                
                // Load criteria
                const criteria = data.criteria || [];
                renderCriteriaInputs(criteria);
            });
        }

        function renderCriteriaInputs(criteria) {
            const container = document.getElementById('criteriaContainer');
            container.innerHTML = '';
            
            if (criteria.length === 0) {
                criteria = ['', '', '', '', ''];  // Default 5 empty criteria
            }
            
            criteria.forEach((crit, index) => {
                const div = document.createElement('div');
                div.className = 'criteria-input-group';
                div.innerHTML = `
                    <label>Criterion ${index + 1}:</label>
                    <input type="text" class="criterion-input" data-index="${index}" value="${crit}" placeholder="e.g., Stage Presence, Creativity, Coordination">
                    ${criteria.length > 5 ? '<button class="remove-criteria-btn" onclick="removeCriterion('+index+')">Remove</button>' : ''}
                `;
                container.appendChild(div);
            });
        }

        function addCriterion() {
            const inputs = document.querySelectorAll('.criterion-input');
            const criteria = Array.from(inputs).map(inp => inp.value.trim());
            criteria.push('');
            renderCriteriaInputs(criteria);
        }

        function removeCriterion(index) {
            const inputs = document.querySelectorAll('.criterion-input');
            const criteria = Array.from(inputs).map(inp => inp.value.trim());
            if (criteria.length <= 5) {
                alert('Minimum 5 criteria required');
                return;
            }
            criteria.splice(index, 1);
            renderCriteriaInputs(criteria);
        }

        function saveEventSetup() {
            const event = document.getElementById('setupEventSelect').value;
            if (!event) return;
            
            const jury1Name = document.getElementById('jury1Name').value.trim();
            const jury2Name = document.getElementById('jury2Name').value.trim();
            const jury1Pwd = document.getElementById('jury1Password').value.trim();
            const jury2Pwd = document.getElementById('jury2Password').value.trim();
            
            if (!jury1Pwd || !jury2Pwd) {
                alert('Please set both jury passwords');
                return;
            }
            
            const inputs = document.querySelectorAll('.criterion-input');
            const criteria = Array.from(inputs).map(inp => inp.value.trim()).filter(c => c);
            
            if (criteria.length < 5) {
                alert('Please add at least 5 criteria');
                return;
            }
            
            const setupData = {
                jury1Name: jury1Name || 'Jury 1',
                jury2Name: jury2Name || 'Jury 2',
                jury1Password: jury1Pwd,
                jury2Password: jury2Pwd,
                criteria: criteria,
                resultsPublished: false
            };
            
            db.ref('jurySetup/'+event).set(setupData).then(() => {
                showSetupMessage('Setup saved successfully!', 'success');
            }).catch(err => {
                showSetupMessage('Error: '+err.message, 'error');
            });
        }

        function publishResults() {
            const event = document.getElementById('resultsEventSelect').value;
            if (!event) {
                alert('Please select an event first');
                return;
            }
            
            if (confirm('Publish results to all admins for '+event+'?')) {
                db.ref('jurySetup/'+event+'/resultsPublished').set(true).then(() => {
                    alert('‚úÖ Results published to admins for ' + event + '!');
                    // Show Results tab for all admins
                    updateResultsTabVisibility();
                });
            }
        }

        function unpublishResults() {
            const event = document.getElementById('resultsEventSelect').value;
            if (!event) {
                alert('Please select an event first');
                return;
            }
            
            if (confirm('Unpublish results for '+event+'?')) {
                db.ref('jurySetup/'+event+'/resultsPublished').set(false).then(() => {
                    alert('Results unpublished for ' + event);
                    // Check if any other results are published, hide tab if none
                    updateResultsTabVisibility();
                });
            }
        }

        function checkResultsPublished() {
            // For super admin, always show Results tab
            if (isSuperAdmin) {
                document.getElementById('resultsTab').style.display = 'block';
                return;
            }
            
            // For regular admin, check if any event has published results
            db.ref('jurySetup').once('value').then(snap => {
                let hasPublished = false;
                if (snap.exists()) {
                    snap.forEach(eventSnap => {
                        if (eventSnap.val().resultsPublished === true) {
                            hasPublished = true;
                        }
                    });
                }
                
                const resultsTab = document.getElementById('resultsTab');
                if (resultsTab) {
                    resultsTab.style.display = hasPublished ? 'block' : 'none';
                }
            });
        }
        
        function updateResultsTabVisibility() {
            // This is called after publish/unpublish to update tab visibility
            checkResultsPublished();
        }

        function showSetupMessage(msg, type) {
            const d = document.getElementById('setupMessage');
            d.className = 'message '+type+' show';
            d.textContent = (type === 'success' ? '‚úì ' : '‚úó ') + msg;
            setTimeout(() => d.classList.remove('show'), 5000);
        }

        // Jury Functions
        function loadJurySheet() {
            console.log('=== LOADING JURY SHEET ===');
            console.log('juryEvent:', juryEvent);
            console.log('Current all array length:', all.length);
            console.log('Firebase ref path:', ref.toString());
            
            // Show loading message
            document.getElementById('jurySheetContainer').innerHTML = '<p style="text-align:center;padding:40px;color:#666;">Loading enrollments...</p>';
            
            // First ensure we have the latest enrollment data
            console.log('Fetching from Firebase...');
            ref.once('value').then(snap => {
                console.log('Firebase snapshot received');
                console.log('Snapshot exists:', snap.exists());
                console.log('Snapshot numChildren:', snap.numChildren());
                
                all = [];
                if (snap.exists()) {
                    let count = 0;
                    snap.forEach(child => {
                        count++;
                        const enrollment = {id: child.key, ...child.val()};
                        all.push(enrollment);
                        if (count <= 5) {
                            console.log('Enrollment ' + count + ':', enrollment);
                        }
                    });
                    console.log('Total enrollments loaded:', count);
                } else {
                    console.log('No enrollments found in Firebase!');
                }
                
                console.log('Loaded enrollments, all array length:', all.length);
                console.log('First 3 enrollments:', all.slice(0, 3));
                
                // Filter for current event
                const eventEnrollments = all.filter(e => {
                    console.log('Checking enrollment:', e.event, '===', juryEvent, '?', e.event === juryEvent);
                    return e.event === juryEvent;
                });
                console.log('Enrollments for event "' + juryEvent + '":', eventEnrollments.length);
                console.log('Event enrollments:', eventEnrollments);
                
                // Now get jury setup
                return db.ref('jurySetup/'+juryEvent).once('value');
            }).then(snap => {
                const setup = snap.val();
                console.log('Jury setup:', setup);
                
                if (!setup || !setup.criteria) {
                    document.getElementById('jurySheetContainer').innerHTML = '<p style="text-align:center;padding:40px;color:#999">Event setup not complete. Contact super admin.</p>';
                    return;
                }
                
                // Get enrolled classes for this event
                const enrolledClasses = [...new Set(all.filter(e => e.event === juryEvent).map(e => e.classYear))];
                
                console.log('Enrolled classes for', juryEvent, ':', enrolledClasses);
                console.log('Total classes found:', enrolledClasses.length);
                
                if (enrolledClasses.length === 0) {
                    let debugInfo = '<p style="text-align:center;padding:40px;">';
                    debugInfo += '<strong style="color:#f44336;">No classes enrolled for this event yet.</strong><br><br>';
                    debugInfo += '<span style="color:#666;">Event: ' + juryEvent + '<br>';
                    debugInfo += 'Total enrollments in database: ' + all.length + '<br>';
                    debugInfo += 'Enrollments for this event: ' + all.filter(e => e.event === juryEvent).length + '</span><br><br>';
                    debugInfo += '<button class="btn btn-info" onclick="showEnrollmentDebug()">üîç Debug Enrollments</button>';
                    debugInfo += '</p>';
                    document.getElementById('jurySheetContainer').innerHTML = debugInfo;
                    return;
                }
                
                renderJurySheet(enrolledClasses, setup.criteria);
                loadExistingMarks();
            }).catch(err => {
                console.error('Error loading jury sheet:', err);
                document.getElementById('jurySheetContainer').innerHTML = '<p style="text-align:center;padding:40px;color:red;">Error loading jury sheet: ' + err.message + '</p>';
            });
        }

        function renderJurySheet(enrolledClasses, criteria) {
            let html = '<div class="table-wrapper"><div class="marks-table"><table><thead><tr>';
            html += '<th>Class</th><th>Theme/Topic</th>';
            criteria.forEach((crit, i) => {
                html += '<th>'+crit+'<br><small>(10 marks)</small></th>';
            });
            html += '<th>Total</th></tr></thead><tbody>';
            
            enrolledClasses.forEach(cls => {
                const classEnrollments = all.filter(e => e.event === juryEvent && e.classYear === cls);
                const theme = classEnrollments.length > 0 ? getDet(classEnrollments[0]) : '-';
                
                html += '<tr><td><strong>'+cls+'</strong></td><td>'+theme+'</td>';
                criteria.forEach((crit, i) => {
                    html += '<td><input type="number" class="marks-input" data-class="'+cls+'" data-criterion="'+i+'" min="0" max="10" step="0.5" placeholder="0-10"></td>';
                });
                html += '<td class="total-marks" id="total-'+cls.replace(/\s+/g, '-')+'">0</td></tr>';
            });
            
            html += '</tbody></table></div></div>';
            
            document.getElementById('jurySheetContainer').innerHTML = html;
            
            // Add event listeners for auto-calculation
            document.querySelectorAll('.marks-input').forEach(inp => {
                inp.addEventListener('input', function() {
                    const cls = this.dataset.class;
                    calculateTotal(cls);
                });
            });
        }

        function loadExistingMarks() {
            const dbPath = 'juryMarks/' + juryEvent + '/jury' + juryNumber;
            console.log('=== LOADING EXISTING MARKS ===');
            console.log('Loading marks from:', dbPath);
            console.log('juryEvent:', juryEvent);
            console.log('juryNumber:', juryNumber);
            
            db.ref(dbPath).once('value').then(snap => {
                const marks = snap.val();
                console.log('Loaded marks data:', JSON.stringify(marks, null, 2));
                
                if (!marks) {
                    console.log('No existing marks found');
                    return;
                }
                
                // Check if this is test data (has 'test' property instead of class data)
                if (marks.test !== undefined) {
                    console.warn('‚ö†Ô∏è TEST DATA DETECTED in database!');
                    console.warn('Path contains test data instead of actual marks');
                    console.warn('You should clear this test data from Firebase Console');
                    showJuryMessage('Warning: Test data found in database. Clear it before saving real marks.', 'error');
                    return;
                }
                
                // Check what's in the database
                console.log('Database keys:', Object.keys(marks));
                
                // Check what inputs are available
                const allInputs = document.querySelectorAll('.marks-input');
                console.log('Total inputs found:', allInputs.length);
                allInputs.forEach(inp => {
                    console.log('Input found - class:', inp.dataset.class, 'criterion:', inp.dataset.criterion);
                });
                
                let marksLoaded = 0;
                
                Object.keys(marks).forEach(sanitizedCls => {
                    console.log('Processing class from database:', sanitizedCls);
                    
                    if (marks[sanitizedCls] && marks[sanitizedCls].marks && Array.isArray(marks[sanitizedCls].marks)) {
                        console.log('Marks array for', sanitizedCls, ':', marks[sanitizedCls].marks);
                        
                        // Get the original class name if available, otherwise use the sanitized one
                        const originalCls = marks[sanitizedCls].originalClassName || sanitizedCls;
                        console.log('Original class name:', originalCls);
                        
                        marks[sanitizedCls].marks.forEach((mark, i) => {
                            // Try to find input using original class name first
                            let selector = '.marks-input[data-class="'+originalCls+'"][data-criterion="'+i+'"]';
                            let inp = document.querySelector(selector);
                            
                            // If not found, try sanitized class name
                            if (!inp) {
                                selector = '.marks-input[data-class="'+sanitizedCls+'"][data-criterion="'+i+'"]';
                                inp = document.querySelector(selector);
                            }
                            
                            console.log('Looking for input with selector:', selector);
                            
                            if (inp) {
                                inp.value = mark;
                                marksLoaded++;
                                console.log('‚úì Set mark for', originalCls, 'criterion', i, ':', mark);
                            } else {
                                console.warn('‚úó Input NOT found for class:', originalCls, '(sanitized:', sanitizedCls, ') criterion:', i);
                            }
                        });
                        calculateTotal(originalCls);
                    } else {
                        console.warn('Invalid marks structure for class:', sanitizedCls, marks[sanitizedCls]);
                    }
                });
                
                if (marksLoaded > 0) {
                    showJuryMessage('Previous marks loaded successfully ('+marksLoaded+' marks)', 'success');
                } else {
                    showJuryMessage('No previous marks found to load', 'error');
                }
            }).catch(err => {
                console.error('Error loading marks:', err);
                showJuryMessage('Error loading marks: ' + err.message, 'error');
            });
        }

        function calculateTotal(cls) {
            const inputs = document.querySelectorAll('.marks-input[data-class="'+cls+'"]');
            let total = 0;
            inputs.forEach(inp => {
                const val = parseFloat(inp.value) || 0;
                total += val;
            });
            const totalCell = document.getElementById('total-'+cls.replace(/\s+/g, '-'));
            if (totalCell) totalCell.textContent = total.toFixed(1);
        }

        function sanitizeKey(key) {
            // Replace characters that Firebase doesn't allow in keys
            // . $ # [ ] / and control characters
            return key.replace(/[.#$\[\]\/]/g, '_');
        }

        function saveMarks() {
            console.log('=== SAVE MARKS STARTED ===');
            console.log('juryEvent:', juryEvent);
            console.log('juryNumber:', juryNumber);
            console.log('Database connected:', isConnected);
            
            if (!juryEvent || !juryNumber) {
                alert('Error: Jury session not initialized. Please log in again.');
                return;
            }
            
            if (!isConnected) {
                alert('Error: Not connected to Firebase database. Please check your internet connection.');
                return;
            }
            
            const marksData = {};
            let inputCount = 0;
            
            // First, organize marks by class
            document.querySelectorAll('.marks-input').forEach(inp => {
                inputCount++;
                const cls = inp.dataset.class;
                const sanitizedCls = sanitizeKey(cls); // Sanitize class name for Firebase
                const critIndex = parseInt(inp.dataset.criterion);
                const val = parseFloat(inp.value) || 0;
                
                if (!marksData[sanitizedCls]) {
                    marksData[sanitizedCls] = { 
                        marks: {}, 
                        completed: false,
                        originalClassName: cls // Store original name
                    };
                }
                marksData[sanitizedCls].marks[critIndex] = val;
            });
            
            // Convert marks object to array to ensure proper structure
            Object.keys(marksData).forEach(cls => {
                const marksObj = marksData[cls].marks;
                const marksArray = [];
                const maxIndex = Math.max(...Object.keys(marksObj).map(k => parseInt(k)));
                
                // Fill array with all marks
                for (let i = 0; i <= maxIndex; i++) {
                    marksArray[i] = marksObj[i] !== undefined ? marksObj[i] : 0;
                }
                
                marksData[cls].marks = marksArray;
            });
            
            console.log('Marks inputs found:', inputCount);
            console.log('Marks data to save:', JSON.stringify(marksData, null, 2));
            
            if (inputCount === 0) {
                alert('No marks data found. Please refresh the page and try again.');
                return;
            }
            
            // Show saving indicator
            showJuryMessage('Saving marks...', 'success');
            
            // Use raw event name (do not encode)
            const dbPath = 'juryMarks/' + juryEvent + '/jury' + juryNumber;
            console.log('Event name:', juryEvent);
            console.log('Saving to Firebase path:', dbPath);
            console.log('Full database URL:', db.ref(dbPath).toString());
            
            // CRITICAL FIX: First check if there's test data and clear it
            db.ref(dbPath).once('value').then(snap => {
                const existingData = snap.val();
                
                // Check if test data exists
                if (existingData && existingData.test !== undefined) {
                    console.warn('‚ö†Ô∏è Test data detected! Clearing before save...');
                    showJuryMessage('Clearing test data...', 'success');
                    // First delete the entire node to clear test data
                    return db.ref(dbPath).remove();
                }
                
                return Promise.resolve();
            }).then(() => {
                console.log('Now saving actual marks data...');
                // Now save the actual marks data
                return db.ref(dbPath).set(marksData);
            }).then(() => {
                console.log('‚úì Firebase .set() resolved successfully');
                
                // Immediately verify the save
                return db.ref(dbPath).once('value');
            }).then(snap => {
                const savedData = snap.val();
                console.log('‚úì Verification read successful');
                console.log('Data in database:', JSON.stringify(savedData, null, 2));
                
                if (savedData && savedData.test === undefined) {
                    // Check that we have actual class data, not test data
                    const hasRealData = Object.keys(savedData).some(key => 
                        savedData[key] && savedData[key].marks && Array.isArray(savedData[key].marks)
                    );
                    
                    if (hasRealData) {
                        showJuryMessage('Marks saved successfully!', 'success');
                        alert('‚úÖ SUCCESS!\n\nMarks saved and verified in database.\n\n' + 
                              'Classes saved: ' + Object.keys(savedData).length + '\n\n' +
                              'Path: juryMarks/' + juryEvent + '/jury' + juryNumber);
                    } else {
                        console.error('‚úó VERIFICATION FAILED: Data saved but structure is wrong');
                        showJuryMessage('Warning: Data saved but structure may be incorrect', 'error');
                    }
                } else if (savedData && savedData.test !== undefined) {
                    console.error('‚úó TEST DATA STILL EXISTS after save attempt');
                    showJuryMessage('Error: Test data blocking saves. Please clear manually.', 'error');
                    alert('‚ö†Ô∏è TEST DATA PROBLEM!\n\nTest data is still in the database.\n\n' +
                          'Please manually delete from Firebase Console:\n' +
                          'juryMarks > Solo Dance > jury1 > test');
                } else {
                    console.error('‚úó VERIFICATION FAILED: Data is null after save');
                    showJuryMessage('Warning: Save completed but verification failed', 'error');
                    alert('‚ö†Ô∏è WARNING!\n\nSave appeared successful but data could not be verified.\n\n' +
                          'Possible issue: Firebase security rules may be blocking reads.\n\n' +
                          'Please check Firebase Console > Realtime Database > Rules');
                }
            }).catch(err => {
                console.error('‚úó FIREBASE ERROR:', err);
                console.error('Error code:', err.code);
                console.error('Error message:', err.message);
                
                let errorMsg = '‚ùå SAVE FAILED!\n\n';
                
                if (err.code === 'PERMISSION_DENIED' || err.message.includes('permission')) {
                    errorMsg += 'ERROR: Permission Denied\n\n';
                    errorMsg += 'Firebase security rules are blocking the save.\n\n';
                    errorMsg += 'SOLUTION:\n';
                    errorMsg += '1. Go to Firebase Console\n';
                    errorMsg += '2. Realtime Database > Rules\n';
                    errorMsg += '3. Set rules to allow writes\n\n';
                    errorMsg += 'See browser console for details.';
                    
                    console.log('%c FIREBASE RULES FIX NEEDED ', 'background: red; color: white; font-size: 16px; font-weight: bold;');
                    console.log('Your current Firebase rules are blocking writes to: ' + dbPath);
                    console.log('\nTo fix this, update your Firebase Realtime Database Rules to:');
                    console.log('{\n  "rules": {\n    ".read": true,\n    ".write": true\n  }\n}');
                    console.log('\nOR for better security:');
                    console.log('{\n  "rules": {\n    "juryMarks": {\n      ".read": true,\n      ".write": true\n    },\n    "jurySetup": {\n      ".read": true,\n      ".write": true\n    },\n    "youthfest-enrollments": {\n      ".read": true,\n      ".write": true\n    }\n  }\n}');
                } else {
                    errorMsg += 'Error: ' + err.message + '\n\n';
                        errorMsg += 'Code: ' + err.code + '\n\n';
                        errorMsg += 'Check browser console for details.';
                    }
                    
                    showJuryMessage('Error: ' + err.message, 'error');
                    alert(errorMsg);
                });
        }

        function markAsCompleted() {
            if (!confirm('Mark evaluation as completed? You can still edit marks later.')) return;
            
            const marksData = {};
            
            // First, organize marks by class
            document.querySelectorAll('.marks-input').forEach(inp => {
                const cls = inp.dataset.class;
                const sanitizedCls = sanitizeKey(cls); // Sanitize class name
                const critIndex = parseInt(inp.dataset.criterion);
                const val = parseFloat(inp.value) || 0;
                
                if (!marksData[sanitizedCls]) {
                    marksData[sanitizedCls] = { 
                        marks: {}, 
                        completed: true,
                        originalClassName: cls
                    };
                }
                marksData[sanitizedCls].marks[critIndex] = val;
            });
            
            // Convert marks object to array to ensure proper structure
            Object.keys(marksData).forEach(cls => {
                const marksObj = marksData[cls].marks;
                const marksArray = [];
                const maxIndex = Math.max(...Object.keys(marksObj).map(k => parseInt(k)));
                
                // Fill array with all marks
                for (let i = 0; i <= maxIndex; i++) {
                    marksArray[i] = marksObj[i] !== undefined ? marksObj[i] : 0;
                }
                
                marksData[cls].marks = marksArray;
            });
            
            const dbPath = 'juryMarks/' + juryEvent + '/jury' + juryNumber;
            
            db.ref(dbPath).set(marksData).then(() => {
                showJuryMessage('Evaluation marked as completed!', 'success');
                alert('‚úÖ Evaluation marked as completed!\n\nYour marks are now final.');
            }).catch(err => {
                showJuryMessage('Error: '+err.message, 'error');
                alert('‚ùå Error: '+err.message);
            });
        }

        function showJuryMessage(msg, type) {
            const d = document.getElementById('juryMessage');
            d.className = 'message '+type+' show';
            d.textContent = (type === 'success' ? '‚úì ' : '‚úó ') + msg;
            setTimeout(() => d.classList.remove('show'), 5000);
            scroll(0,0);
        }

        // Results Functions
        function loadResultsTab() {
            // Populate event select for results
            const sel = document.getElementById('resultsEventSelect');
            sel.innerHTML = '<option value="">-- Select Event --</option>';
            
            db.ref('jurySetup').once('value').then(snap => {
                if (!snap.exists()) return;
                
                snap.forEach(child => {
                    const event = child.key;
                    const setup = child.val();
                    
                    // For super admin, show all events
                    // For admin, show only published events
                    if (isSuperAdmin || setup.resultsPublished) {
                        const opt = document.createElement('option');
                        opt.value = event;
                        opt.textContent = event + (setup.resultsPublished ? ' ‚úì' : '');
                        sel.appendChild(opt);
                    }
                });
            });
        }

        function loadEventResults() {
            const event = document.getElementById('resultsEventSelect').value;
            console.log('Loading results for event:', event);
            
            if (!event) {
                document.getElementById('resultsContainer').innerHTML = '';
                return;
            }
            
            // Load jury setup to get names and publication status
            db.ref('jurySetup/'+event).once('value').then(setupSnap => {
                const setup = setupSnap.val() || {};
                console.log('Results published status:', setup.resultsPublished);
                
                if (!isSuperAdmin && !setup.resultsPublished) {
                    document.getElementById('resultsContainer').innerHTML = '<p style="text-align:center;padding:40px;color:#999">Results not yet published by super admin.</p>';
                    return;
                }
                
                const jury1Name = setup.jury1Name || 'Jury 1';
                const jury2Name = setup.jury2Name || 'Jury 2';
                
                // Load marks from both juries using raw event name
                console.log('Loading marks from both juries...');
                Promise.all([
                    db.ref('juryMarks/'+event+'/jury1').once('value'),
                    db.ref('juryMarks/'+event+'/jury2').once('value')
                ]).then(([jury1Snap, jury2Snap]) => {
                    const jury1Marks = jury1Snap.val() || {};
                    const jury2Marks = jury2Snap.val() || {};
                    
                    console.log('Jury 1 Marks:', jury1Marks);
                    console.log('Jury 2 Marks:', jury2Marks);
                    
                    displayResults(event, jury1Marks, jury2Marks, jury1Name, jury2Name);
                });
            });
        }

        function displayResults(event, jury1Marks, jury2Marks, jury1Name, jury2Name) {
            // Default names if not provided
            jury1Name = jury1Name || 'Jury 1';
            jury2Name = jury2Name || 'Jury 2';
            
            console.log('=== DISPLAY RESULTS DEBUG ===');
            console.log('Jury 1 Marks:', jury1Marks);
            console.log('Jury 2 Marks:', jury2Marks);
            
            const allClasses = new Set([...Object.keys(jury1Marks), ...Object.keys(jury2Marks)]);
            
            if (allClasses.size === 0) {
                document.getElementById('resultsContainer').innerHTML = '<p style="text-align:center;padding:40px;color:#999">No marks submitted yet.</p>';
                return;
            }
            
            // Calculate totals and averages
            const results = [];
            allClasses.forEach(sanitizedCls => {
                const j1 = jury1Marks[sanitizedCls];
                const j2 = jury2Marks[sanitizedCls];
                
                console.log('Class:', sanitizedCls);
                console.log('  Jury1 data:', j1);
                console.log('  Jury1 completed?:', j1 && j1.completed);
                console.log('  Jury2 data:', j2);
                console.log('  Jury2 completed?:', j2 && j2.completed);
                
                // Get original class name if available
                const displayCls = (j1 && j1.originalClassName) || 
                                  (j2 && j2.originalClassName) || 
                                  sanitizedCls;
                
                let j1Total = 0;
                let j2Total = 0;
                
                if (j1 && j1.marks) {
                    j1Total = j1.marks.reduce((sum, m) => sum + (m || 0), 0);
                }
                if (j2 && j2.marks) {
                    j2Total = j2.marks.reduce((sum, m) => sum + (m || 0), 0);
                }
                
                const avgTotal = (j1Total + j2Total) / 2;
                
                results.push({
                    class: displayCls,  // Use original name for display
                    jury1Total: j1Total,
                    jury2Total: j2Total,
                    average: avgTotal,
                    jury1Completed: j1 && j1.completed,
                    jury2Completed: j2 && j2.completed
                });
            });
            
            // Sort by average (descending)
            results.sort((a, b) => b.average - a.average);
            
            // Display results
            let html = '<h3 style="color:#c44569;margin-bottom:20px">Results for '+event+'</h3>';
            
            // Show marks detail only for super admin and jury
            if (isSuperAdmin || isJury) {
                html += '<div class="table-wrapper"><table><thead><tr><th>Rank</th><th>Class</th><th>'+jury1Name+' Total</th><th>'+jury2Name+' Total</th><th>Average</th><th>Status</th></tr></thead><tbody>';
                
                results.forEach((r, i) => {
                    const rank = i + 1;
                    const badge = rank === 1 ? '<span class="winner-badge">üèÜ Winner</span>' : 
                                 rank === 2 ? '<span class="runner-badge">ü•à Runner Up</span>' : '';
                    
                    html += '<tr class="rank-'+(rank <= 3 ? rank : '')+'">';
                    html += '<td><strong>'+rank+'</strong></td>';
                    html += '<td><strong>'+r.class+'</strong> '+badge+'</td>';
                    html += '<td>'+r.jury1Total.toFixed(1)+(r.jury1Completed ? ' ‚úì' : '')+'</td>';
                    html += '<td>'+r.jury2Total.toFixed(1)+(r.jury2Completed ? ' ‚úì' : '')+'</td>';
                    html += '<td><strong>'+r.average.toFixed(1)+'</strong></td>';
                    html += '<td>'+(r.jury1Completed && r.jury2Completed ? '‚úÖ Complete' : '‚è≥ In Progress')+'</td>';
                    html += '</tr>';
                });
                
                html += '</tbody></table></div>';
            } else {
                // For regular admins, show only final results (no marks)
                results.forEach((r, i) => {
                    const rank = i + 1;
                    html += '<div class="results-card rank-'+rank+'">';
                    html += '<h3 style="color:#c44569;">Rank '+rank+': '+r.class;
                    if (rank === 1) html += ' <span class="winner-badge">üèÜ Winner</span>';
                    if (rank === 2) html += ' <span class="runner-badge">ü•à Runner Up</span>';
                    html += '</h3>';
                    html += '<p style="color:#666;margin-top:10px">Final Score: <strong>'+r.average.toFixed(1)+'</strong></p>';
                    html += '</div>';
                });
            }
            
            document.getElementById('resultsContainer').innerHTML = html;
        }

        function clearTestData() {
            if (!confirm('Clear test data from Firebase?\n\nThis will ONLY delete:\n- juryMarks/TEST/*\n\nYour actual marks will NOT be affected.')) {
                return;
            }
            
            console.log('=== CLEARING TEST DATA ===');
            
            // Only clear the TEST node - DO NOT touch the actual jury path
            db.ref('juryMarks/TEST').remove()
            .then(() => {
                console.log('‚úì Test data cleared');
                showJuryMessage('Test data cleared successfully! Your actual marks are safe.', 'success');
                alert('‚úÖ Test data cleared!\n\nYour actual marks are safe and untouched.');
            }).catch(err => {
                console.error('Error clearing test data:', err);
                showJuryMessage('Error clearing test data: ' + err.message, 'error');
            });
        }

        function debugLoadMarks() {
            console.log('=== DEBUG LOAD MARKS ===');
            console.log('juryEvent:', juryEvent);
            console.log('juryNumber:', juryNumber);
            
            const dbPath = 'juryMarks/' + juryEvent + '/jury' + juryNumber;
            console.log('Database path:', dbPath);
            
            // First check what's in the database
            db.ref(dbPath).once('value').then(snap => {
                const data = snap.val();
                console.log('Raw database data:', data);
                console.log('Data as JSON:', JSON.stringify(data, null, 2));
                
                // Check all inputs on the page
                const inputs = document.querySelectorAll('.marks-input');
                console.log('Total inputs on page:', inputs.length);
                
                const inputDetails = [];
                inputs.forEach((inp, idx) => {
                    inputDetails.push({
                        index: idx,
                        class: inp.dataset.class,
                        criterion: inp.dataset.criterion,
                        value: inp.value
                    });
                });
                console.table(inputDetails);
                
                // Show a detailed report
                let report = '=== DEBUG REPORT ===\n\n';
                report += 'Database Path: ' + dbPath + '\n\n';
                report += 'Database Content:\n' + JSON.stringify(data, null, 2) + '\n\n';
                report += 'Total Inputs Found: ' + inputs.length + '\n\n';
                report += 'Input Details:\n';
                inputDetails.forEach(inp => {
                    report += `  [${inp.index}] Class: "${inp.class}", Criterion: ${inp.criterion}, Value: ${inp.value}\n`;
                });
                
                console.log(report);
                alert(report);
                
            }).catch(err => {
                console.error('Debug load error:', err);
                alert('Debug load failed: ' + err.message);
            });
        }

        function showEnrollmentDebug() {
            console.log('=== ENROLLMENT DEBUG ===');
            console.log('Current juryEvent:', juryEvent);
            console.log('All array length:', all.length);
            console.log('All enrollments:', all);
            
            // Filter for current event
            const eventEnrollments = all.filter(e => e.event === juryEvent);
            console.log('Enrollments for', juryEvent, ':', eventEnrollments);
            
            // Get unique classes
            const classes = [...new Set(eventEnrollments.map(e => e.classYear))];
            console.log('Unique classes:', classes);
            
            // Build report
            let report = '=== ENROLLMENT DEBUG REPORT ===\n\n';
            report += 'Event: ' + juryEvent + '\n';
            report += 'Total enrollments in database: ' + all.length + '\n';
            report += 'Enrollments for this event: ' + eventEnrollments.length + '\n';
            report += 'Unique classes: ' + classes.join(', ') + '\n\n';
            
            report += 'Detailed Enrollments:\n';
            eventEnrollments.forEach((e, i) => {
                report += `${i+1}. Class: ${e.classYear}, Name: ${e.name}, Phone: ${e.phone}\n`;
            });
            
            if (eventEnrollments.length === 0) {
                report += '\n‚ö†Ô∏è NO ENROLLMENTS FOUND!\n';
                report += 'This means either:\n';
                report += '1. No one has enrolled for this event yet\n';
                report += '2. The enrollments are not being loaded from Firebase\n';
                report += '3. The event name doesn\'t match\n';
            }
            
            console.log(report);
            alert(report);
        }

        function testFirebaseWrite() {
            console.log('=== TESTING FIREBASE WRITE ===');
            console.log('Testing write to: juryMarks/TEST/test');
            
            const testData = {
                timestamp: new Date().toISOString(),
                message: 'This is a test write',
                juryEvent: juryEvent,
                juryNumber: juryNumber
            };
            
            console.log('Test data:', testData);
            
            // Test 1: Try writing to test path
            db.ref('juryMarks/TEST/test').set(testData)
                .then(() => {
                    console.log('‚úì TEST WRITE SUCCESSFUL');
                    
                    // Verify by reading back
                    return db.ref('juryMarks/TEST/test').once('value');
                })
                .then(snap => {
                    const readData = snap.val();
                    console.log('‚úì TEST READ SUCCESSFUL');
                    console.log('Data read back:', readData);
                    
                    if (readData) {
                        alert('‚úÖ FIREBASE TEST PASSED!\n\n' +
                              'Firebase is working correctly.\n' +
                              'Write: SUCCESS\n' +
                              'Read: SUCCESS\n\n' +
                              'Check Firebase Console - you should see:\n' +
                              'juryMarks > TEST > test\n\n' +
                              'The issue must be in the saveMarks function.');
                              
                        // Now test the actual save path
                        console.log('Now testing actual save path...');
                        const actualPath = 'juryMarks/' + juryEvent + '/jury' + juryNumber;
                        console.log('Actual path:', actualPath);
                        
                        return db.ref(actualPath).set({test: 'actual path test'});
                    } else {
                        throw new Error('Read returned null');
                    }
                })
                .then(() => {
                    console.log('‚úì ACTUAL PATH WRITE SUCCESSFUL');
                    alert('‚úÖ Both tests passed! Check the console and Firebase database.');
                })
                .catch(err => {
                    console.error('‚úó TEST FAILED:', err);
                    console.error('Error code:', err.code);
                    console.error('Error message:', err.message);
                    
                    alert('‚ùå FIREBASE TEST FAILED!\n\n' +
                          'Error: ' + err.message + '\n' +
                          'Code: ' + err.code + '\n\n' +
                          'This means Firebase rules may still be blocking writes.\n' +
                          'Check browser console for details.');
                });
        }

        // Edit and Delete Functions
        let editingKey = null;
        let editingData = null;

        // Wrapper functions to handle calls from data attributes
        function editEnrollmentByKey(key) {
            editEnrollment(key);
        }

        function deleteEnrollmentByKey(key, name, event) {
            deleteEnrollment(key, name, event);
        }

        function editEnrollment(key) {
            console.log('Editing enrollment:', key);
            console.log('All enrollments:', all);
            console.log('Looking for key:', key);
            
            editingKey = key;
            
            // Find the enrollment data - search by id field
            const enrollment = all.find(e => e.id === key);
            
            if (!enrollment) {
                console.error('Enrollment not found!');
                console.log('Available IDs:', all.map(e => e.id));
                alert('Error: Enrollment not found. Please refresh the page and try again.');
                return;
            }
            
            editingData = enrollment;
            console.log('Enrollment data:', enrollment);
            
            // Build edit form based on event type
            const eventConfig = events[enrollment.event];
            const isTeamEvent = eventConfig && eventConfig.count > 1;
            
            let formHtml = '<div class="form-group">';
            formHtml += '<label>Name:</label>';
            formHtml += '<input type="text" id="editName" value="' + enrollment.name + '" required>';
            formHtml += '</div>';
            
            formHtml += '<div class="form-group">';
            formHtml += '<label>Phone:</label>';
            formHtml += '<input type="tel" id="editPhone" value="' + enrollment.phone + '" required>';
            formHtml += '</div>';
            
            formHtml += '<div class="form-group">';
            formHtml += '<label>Class Year:</label>';
            formHtml += '<input type="text" id="editClass" value="' + enrollment.classYear + '" readonly>';
            formHtml += '</div>';
            
            formHtml += '<div class="form-group">';
            formHtml += '<label>Event:</label>';
            formHtml += '<input type="text" value="' + enrollment.event + '" readonly>';
            formHtml += '</div>';
            
            formHtml += '<div class="form-group">';
            formHtml += '<label>Role:</label>';
            formHtml += '<input type="text" value="' + enrollment.role + '" readonly>';
            formHtml += '</div>';
            
            // Add team members if it's a team event
            if (isTeamEvent && enrollment.teamMembers) {
                for (let i = 0; i < enrollment.teamMembers.length; i++) {
                    const member = enrollment.teamMembers[i];
                    formHtml += '<div class="team-member-box">';
                    formHtml += '<div class="member-header">Team Member ' + (i + 1) + '</div>';
                    formHtml += '<div class="form-group">';
                    formHtml += '<label>Name:</label>';
                    formHtml += '<input type="text" id="editTeamName' + i + '" value="' + member.name + '" required>';
                    formHtml += '</div>';
                    formHtml += '<div class="form-group">';
                    formHtml += '<label>Phone:</label>';
                    formHtml += '<input type="tel" id="editTeamPhone' + i + '" value="' + member.phone + '" required>';
                    formHtml += '</div>';
                    formHtml += '</div>';
                }
            }
            
            document.getElementById('editFormContainer').innerHTML = formHtml;
            document.getElementById('editModal').style.display = 'block';
        }

        function closeEditModal() {
            document.getElementById('editModal').style.display = 'none';
            editingKey = null;
            editingData = null;
        }

        function saveEdit() {
            if (!editingKey || !editingData) {
                alert('Error: No enrollment selected');
                return;
            }
            
            // Get updated values
            const updatedName = document.getElementById('editName').value.trim();
            const updatedPhone = document.getElementById('editPhone').value.trim();
            
            if (!updatedName || !updatedPhone) {
                alert('Please fill in all required fields');
                return;
            }
            
            // Validate phone
            if (!/^\d{10}$/.test(updatedPhone)) {
                alert('Please enter a valid 10-digit phone number');
                return;
            }
            
            // Build updated enrollment object
            const updatedEnrollment = {
                ...editingData,
                name: updatedName,
                phone: updatedPhone
            };
            
            // Update team members if applicable
            const eventConfig = events[editingData.event];
            if (eventConfig && eventConfig.count > 1 && editingData.teamMembers) {
                updatedEnrollment.teamMembers = [];
                for (let i = 0; i < editingData.teamMembers.length; i++) {
                    const memberName = document.getElementById('editTeamName' + i).value.trim();
                    const memberPhone = document.getElementById('editTeamPhone' + i).value.trim();
                    
                    if (!memberName || !memberPhone) {
                        alert('Please fill in all team member details');
                        return;
                    }
                    
                    if (!/^\d{10}$/.test(memberPhone)) {
                        alert('Please enter valid 10-digit phone numbers for all team members');
                        return;
                    }
                    
                    updatedEnrollment.teamMembers.push({
                        name: memberName,
                        phone: memberPhone
                    });
                }
            }
            
            // Save to Firebase
            ref.child(editingKey).set(updatedEnrollment)
                .then(() => {
                    showOk('Enrollment updated successfully!');
                    closeEditModal();
                    loadData(); // Reload data
                    
                    // Refresh the appropriate view
                    if (studentClass) {
                        viewStudentClassEnrollments();
                    }
                    if (isCR) {
                        updateCRView();
                    }
                })
                .catch(err => {
                    console.error('Error updating enrollment:', err);
                    showErr('Failed to update enrollment: ' + err.message);
                });
        }

        function deleteEnrollment(key, name, event) {
            // Find the enrollment data - search by id field
            const enrollment = all.find(e => e.id === key);
            if (!enrollment) {
                alert('Error: Enrollment not found');
                return;
            }
            
            if (!confirm('Are you sure you want to delete the enrollment for ' + name + ' in ' + event + '?')) {
                return;
            }
            
            ref.child(key).remove()
                .then(() => {
                    showOk('Enrollment deleted successfully!');
                    loadData(); // Reload data
                    
                    // Refresh the appropriate view
                    if (studentClass) {
                        viewStudentClassEnrollments();
                    }
                    if (isCR) {
                        updateCRView();
                    }
                })
                .catch(err => {
                    console.error('Error deleting enrollment:', err);
                    showErr('Failed to delete enrollment: ' + err.message);
                });
        }

        function showOk(msg) {
            const d = document.getElementById('enrollMessage');
            d.className = 'message success show';
            d.textContent = '‚úì '+msg;
            setTimeout(() => d.classList.remove('show'), 5000);
            scroll(0,0);
        }

        function showErr(msg) {
            const d = document.getElementById('enrollMessage');
            d.className = 'message error show';
            d.textContent = '‚úó '+msg;
            setTimeout(() => d.classList.remove('show'), 5000);
            scroll(0,0);
        }

        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) event.target.style.display = 'none';
        }
        
        // ==================== QUIZ COMPETITION FUNCTIONS ====================
        
        // Quiz Utility Functions
        // ‚îÄ‚îÄ SERVER-TIME OFFSET (fetched once, reused everywhere) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        let _serverTimeOffsetMs = 0;
        let _serverOffsetFetched = false;

        async function fetchServerTimeOffset() {
            if (_serverOffsetFetched) return;
            try {
                const snap = await db.ref('.info/serverTimeOffset').once('value');
                _serverTimeOffsetMs = snap.val() || 0;
                _serverOffsetFetched = true;
                console.log('[ServerTime] Offset:', _serverTimeOffsetMs, 'ms');
            } catch (e) {
                console.warn('[ServerTime] Could not fetch offset:', e);
                _serverTimeOffsetMs = 0;
                _serverOffsetFetched = true;
            }
        }

        function getServerNow() {
            return new Date(Date.now() + _serverTimeOffsetMs);
        }

        function getQuizToday() {
            const now = getServerNow();
            const year  = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day   = String(now.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        async function getQuizTodayServer() {
            await fetchServerTimeOffset();
            return getQuizToday();
        }
        
        // Check public quiz status (before login)
        async function checkPublicQuizStatus() {
            const today = await getQuizTodayServer();
            const messageDiv = document.getElementById('publicQuizMessage');
            
            console.log('=== checkPublicQuizStatus START ===');
            console.log('Today:', today);
            
            try {
                const qRef = db.ref(`quizQuestions/${today}`);
                const qSnap = await qRef.once('value');
                
                console.log('Questions exist for public view?', qSnap.exists());
                
                if (!qSnap.exists()) {
                    messageDiv.innerHTML = '<p style="margin:0;color:#856404">‚è≥ <strong>No quiz available today.</strong></p>';
                    return;
                }
                
                // Check if published (for showing answers)
                const pSnap = await db.ref(`quizPublished/${today}`).once('value');
                const publishData = pSnap.val();
                const isPublished = publishData && publishData.published === true;
                
                console.log('Is quiz published for public Q&A view?', isPublished);
                
                if (!isPublished) {
                    // Quiz exists but not published - students can login and take it
                    messageDiv.innerHTML = '<div class="quiz-available-banner"><div class="trophy-icon">üèÜ</div><h3>‚úÖ Today\'s Quiz is Available!</h3><p style="margin:0;color:#155724;font-size:1.15em">Login below to participate and win exciting prizes!</p><p style="margin-top:10px;color:#28a745;font-weight:600">‚ö° Be the fastest to answer correctly!</p><div style="margin-top:14px;background:rgba(255,255,255,0.7);border-radius:10px;padding:10px 15px;display:inline-block;border:2px solid #28a745"><span style="color:#856404;font-weight:700;font-size:0.95em">‚è≥ Quiz ends in: </span><span id="publicQuizCountdown" style="color:#c0392b;font-weight:800;font-size:1.15em;letter-spacing:1px">--:--:--</span><span style="color:#666;font-size:0.82em;margin-left:6px">(closes at 11:59 PM today)</span></div></div>';
                    // Start countdown to 11:59 PM today
                    (function startPublicCountdown() {
                        function updatePublicCountdown() {
                            const el = document.getElementById('publicQuizCountdown');
                            if (!el) return;
                            const now = new Date();
                            const end = new Date();
                            end.setHours(23, 59, 59, 0);
                            const diff = end - now;
                            if (diff <= 0) { el.textContent = 'CLOSED'; el.style.color = '#c0392b'; return; }
                            const h = Math.floor(diff / 3600000);
                            const m = Math.floor((diff % 3600000) / 60000);
                            const s = Math.floor((diff % 60000) / 1000);
                            el.textContent = String(h).padStart(2,'0') + ':' + String(m).padStart(2,'0') + ':' + String(s).padStart(2,'0');
                            setTimeout(updatePublicCountdown, 1000);
                        }
                        updatePublicCountdown();
                    })();
                    return;
                }
                
                // Quiz is published - show questions with correct answers for review
                const questions = qSnap.val();
                const publishedDate = new Date(publishData.publishedAt).toLocaleDateString('en-IN', {
                    weekday: 'long',
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
                const publishedTime = new Date(publishData.publishedAt).toLocaleTimeString('en-IN', {
                    hour: '2-digit',
                    minute: '2-digit'
                });
                
                let html = '<div style="background:#e8f5e9;padding:20px;border-radius:10px;border:3px solid #4CAF50">';
                html += '<h4 style="color:#2e7d32;margin-top:0">üìÖ Today\'s Quiz - Questions & Answers</h4>';
                html += '<p style="color:#2e7d32;margin-bottom:15px;font-size:0.9em">Published: ' + publishedDate + ' at ' + publishedTime + '</p>';
                
                // Question 1
                html += '<div style="background:white;padding:20px;border-radius:8px;margin-bottom:15px;border-left:5px solid #667eea">';
                html += '<p style="margin:0 0 10px 0;color:#667eea;font-weight:bold;font-size:1.1em">Question 1:</p>';
                html += '<p style="margin:0 0 15px 0;color:#333;font-size:1.05em">' + questions.q1.text + '</p>';
                html += '<div style="background:#4CAF50;color:white;padding:12px;border-radius:6px;font-weight:bold">';
                html += '‚úÖ Correct Answer: ' + questions.q1.options[questions.q1.correct];
                html += '</div>';
                html += '</div>';
                
                // Question 2
                html += '<div style="background:white;padding:20px;border-radius:8px;border-left:5px solid #667eea">';
                html += '<p style="margin:0 0 10px 0;color:#667eea;font-weight:bold;font-size:1.1em">Question 2:</p>';
                html += '<p style="margin:0 0 15px 0;color:#333;font-size:1.05em">' + questions.q2.text + '</p>';
                html += '<div style="background:#4CAF50;color:white;padding:12px;border-radius:6px;font-weight:bold">';
                html += '‚úÖ Correct Answer: ' + questions.q2.options[questions.q2.correct];
                html += '</div>';
                html += '</div>';
                
                html += '<p style="color:#2e7d32;margin:15px 0 0 0;font-size:0.9em;text-align:center"><em>Review the questions and answers from today\'s quiz</em></p>';
                html += '</div>';
                
                messageDiv.innerHTML = html;
                
                console.log('=== checkPublicQuizStatus END ===');
            } catch (err) {
                console.error('Public quiz status check error:', err);
                messageDiv.innerHTML = '<p style="margin:0;color:#721c24">‚ùå Error loading quiz status</p>';
            }
        }
        
        function generateQuizPassword() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789@#$';
            let pwd = '';
            for (let i = 0; i < 10; i++) {
                pwd += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return pwd;
        }
        
        function showQuizMsg(id, msg, type) {
            const el = document.getElementById(id);
            if (!el) return;
            el.className = `message ${type} show`;
            el.textContent = msg;
            // Errors stay visible for 10s on mobile; success fades after 5s
            const delay = type === 'error' ? 10000 : 5000;
            setTimeout(() => el.classList.remove('show'), delay);
        }
        
        function populateQuizClasses() {
            const sel = document.getElementById('quizClass');
            if (!sel) return;
            sel.innerHTML = '<option value="">-- Select Class --</option>';
            classes.forEach(c => {
                const opt = document.createElement('option');
                opt.value = c;
                opt.textContent = c;
                sel.appendChild(opt);
            });
        }
        
        function showQuizTab(tab) {
            if (tab === 'student') {
                document.getElementById('quizStudentSection').style.display = 'block';
                document.getElementById('quizAdminSection').style.display = 'none';
                document.getElementById('quizStudentTab').classList.add('active');
                document.getElementById('quizAdminTab').classList.remove('active');
                document.getElementById('quizStudentTab').style.background = 'linear-gradient(135deg,#c44569 0%,#6a1b9a 100%)';
                document.getElementById('quizStudentTab').style.color = 'white';
                document.getElementById('quizAdminTab').style.background = 'white';
                document.getElementById('quizAdminTab').style.color = '#333';
            } else {
                document.getElementById('quizAdminSection').style.display = 'block';
                document.getElementById('quizStudentSection').style.display = 'none';
                document.getElementById('quizAdminTab').classList.add('active');
                document.getElementById('quizStudentTab').classList.remove('active');
                document.getElementById('quizAdminTab').style.background = 'linear-gradient(135deg,#c44569 0%,#6a1b9a 100%)';
                document.getElementById('quizAdminTab').style.color = 'white';
                document.getElementById('quizStudentTab').style.background = 'white';
                document.getElementById('quizStudentTab').style.color = '#333';
            }
        }
        
        // Send Email Function - Using EmailJS + Firebase Log
        async function sendQuizEmail(to, subject, body) {
            const debugId = Date.now();
            try {
                console.log('========================================');
                console.log(`üìß EMAIL DEBUG #${debugId} START`);
                console.log('========================================');
                console.log(`Timestamp: ${new Date().toISOString()}`);
                console.log(`Recipient: ${to}`);
                console.log(`Subject: ${subject}`);
                console.log('Body preview:', body.substring(0, 150) + '...');
                
                let emailSent = false;
                let emailError = null;
                let emailJSResponse = null;
                
                // Step 1: Check EmailJS library
                console.log('\n--- STEP 1: Checking EmailJS library ---');
                if (typeof emailjs === 'undefined') {
                    console.error('‚ùå EmailJS library NOT LOADED!');
                    console.error('Check if script tag is present');
                    emailError = 'EmailJS library not loaded';
                } else {
                    console.log('‚úÖ EmailJS library is available');
                }
                
                // Step 2: Send email
                if (typeof emailjs !== 'undefined') {
                    console.log('\n--- STEP 2: Checking EmailJS initialization ---');
                    console.log('Public Key: iISS6N2b69VmKwx8Y');
                    
                    console.log('\n--- STEP 3: Preparing template parameters ---');
                    const templateParams = {
                        to_email: to,
                        subject: subject,
                        message: body,
                        reply_to: 'davancollege02@gmail.com'
                    };
                    
                    console.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');
                    console.log('üìß EMAIL PARAMETERS BEING SENT:');
                    console.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');
                    console.log('Template Parameters:', templateParams);
                    console.log('');
                    console.log('üéØ RECIPIENT (to_email):', templateParams.to_email);
                    console.log('üì¨ REPLY TO (reply_to):', templateParams.reply_to);
                    console.log('üìù Subject:', templateParams.subject);
                    console.log('üìÑ Message preview:', templateParams.message.substring(0, 100) + '...');
                    console.log('');
                    console.log('‚öôÔ∏è Service ID: service_zhy3bnp');
                    console.log('üìã Template ID: template_o2i00b5');
                    console.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');
                    console.log('');
                    console.log('‚ö†Ô∏è IMPORTANT: Check your EmailJS template!');
                    console.log('   The template should use: {{to_email}} for recipient');
                    console.log('   NOT: {{reply_to}} (that\'s for reply address)');
                    console.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');
                    
                    try {
                        console.log('\n--- STEP 4: Sending email via EmailJS ---');
                        console.log('‚è≥ Please wait...');
                        
                        const startTime = Date.now();
                        emailJSResponse = await emailjs.send(
                            'service_zhy3bnp',
                            'template_o2i00b5',
                            templateParams
                        );
                        const endTime = Date.now();
                        
                        emailSent = true;
                        console.log(`\n‚úÖ‚úÖ‚úÖ EMAIL SENT SUCCESSFULLY! (${endTime - startTime}ms) ‚úÖ‚úÖ‚úÖ`);
                        console.log('EmailJS Response:', emailJSResponse);
                        console.log(`‚úÖ Email delivered to: ${to}`);
                        console.log('‚úÖ Check inbox in 1-2 minutes (or spam folder)');
                        
                    } catch (emailErr) {
                        emailSent = false;
                        emailError = emailErr.message || emailErr.toString();
                        
                        console.error('\n‚ùå‚ùå‚ùå EMAIL SEND FAILED! ‚ùå‚ùå‚ùå');
                        console.error('Error Type:', emailErr.name);
                        console.error('Error Message:', emailErr.message);
                        console.error('Full Error:', emailErr);
                        
                        // Specific error analysis
                        if (emailErr.message && emailErr.message.includes('User ID')) {
                            console.error('\nüîë ISSUE: Invalid Public Key');
                            console.error('Current Key: iISS6N2b69VmKwx8Y');
                            console.error('‚Üí Verify this key in EmailJS Dashboard > Account > API Keys');
                        } else if (emailErr.message && emailErr.message.includes('Service ID')) {
                            console.error('\n‚öôÔ∏è ISSUE: Invalid Service ID');
                            console.error('Current Service ID: service_zhy3bnp');
                            console.error('‚Üí Verify in EmailJS Dashboard > Email Services');
                        } else if (emailErr.message && emailErr.message.includes('Template')) {
                            console.error('\nüìù ISSUE: Invalid Template ID');
                            console.error('Current Template ID: template_o2i00b5');
                            console.error('‚Üí Verify in EmailJS Dashboard > Email Templates');
                        } else if (emailErr.message && emailErr.message.includes('quota')) {
                            console.error('\nüìä ISSUE: Daily Quota Exceeded');
                            console.error('‚Üí Check your EmailJS dashboard for quota limits');
                            console.error('‚Üí Free plan: 200 emails/month');
                        } else if (emailErr.message && (emailErr.message.includes('network') || emailErr.message.includes('Failed to fetch'))) {
                            console.error('\nüåê ISSUE: Network Error');
                            console.error('‚Üí Check internet connection');
                            console.error('‚Üí Check if EmailJS servers are accessible');
                        } else {
                            console.error('\n‚ùì UNKNOWN ERROR');
                            console.error('‚Üí See error details above');
                        }
                    }
                }
                
                
                console.log('\n========================================');
                console.log(`üìß EMAIL DEBUG #${debugId} END`);
                console.log(`FINAL STATUS: ${emailSent ? '‚úÖ SUCCESS' : '‚ùå FAILED'}`);
                console.log('========================================');
                
                if (emailSent) {
                    console.log('\nüìß What to do now:');
                    console.log('1. Check your email inbox (may take 1-2 minutes)');
                    console.log('2. Check SPAM/JUNK folder if not in inbox');
                    console.log('3. Whitelist davancollege02@gmail.com in your email');
                } else {
                    console.log('\nüìß Troubleshooting steps:');
                    console.log('1. Review error details above');
                    console.log('3. Verify EmailJS credentials in dashboard');
                    console.log('4. Check EmailJS service connection status');
                }
                
                return emailSent;
            } catch (err) {
                console.error(`\n‚ùå EMAIL FUNCTION CRASHED! #${debugId}`);
                console.error('Fatal Error:', err);
                console.error('Error Message:', err.message);
                return false;
            }
        }
        
        // Register Student
        async function registerQuizStudent() {
            console.log('üîµ Registration started...');
            const cls = document.getElementById('quizClass').value;
            const email = document.getElementById('quizEmail').value.trim();
            const phone = document.getElementById('quizPhone').value.trim();
            const name = document.getElementById('quizName').value.trim();
            
            console.log('Form values:', {cls, email, phone, name});
            
            if (!cls || !email || !phone || !name) {
                showQuizMsg('quizMessage', 'Please fill all fields!', 'error');
                return;
            }
            
            if (!email.includes('@')) {
                showQuizMsg('quizMessage', 'Invalid email address!', 'error');
                return;
            }
            
            if (phone.length < 10) {
                showQuizMsg('quizMessage', 'Please enter valid 10-digit phone!', 'error');
                return;
            }
            
            console.log('‚úÖ Validation passed');
            
            try {
                console.log('Checking Firebase connection...');
                if (!db) {
                    throw new Error('Firebase database not initialized!');
                }
                
                console.log('Checking for existing email...');
                const studRef = db.ref('quizStudents');
                const emailSnap = await studRef.orderByChild('email').equalTo(email).once('value');
                
                if (emailSnap.exists()) {
                    alert('‚ùå Email Already Registered!\n\nThis email address is already registered.\n\nPlease use the login form below with your existing password.');
                    showQuizMsg('quizMessage', '‚ùå Email already registered! Please login with your existing password.', 'error');
                    return;
                }
                
                console.log('Checking for existing phone number...');
                const phoneSnap = await studRef.orderByChild('phone').equalTo(phone).once('value');
                
                if (phoneSnap.exists()) {
                    alert('‚ùå Phone Number Already Registered!\n\nThis phone number is already registered.\n\nPlease use the login form below with your existing password.');
                    showQuizMsg('quizMessage', '‚ùå Phone number already registered! Please login with your existing password.', 'error');
                    return;
                }
                
                console.log('‚úÖ Email and phone not registered, generating password...');
                const password = generateQuizPassword();
                console.log('Password generated');
                
                console.log('Saving to Firebase...');
                await studRef.push({
                    email, phone, name, class: cls, password,
                    registeredAt: new Date().toISOString(),
                    status: 'active'
                });
                console.log('‚úÖ Saved to Firebase successfully!');
                
                const emailBody = `Hello ${name},

Welcome to Daily Quiz Competition at Davan Institute!

Your Login Credentials:
Phone Number: ${phone}
Password: ${password}
Class: ${cls}

Please keep this password secure. Login and participate in daily quizzes!

Good luck!
Davan Institute Team`;
                
                console.log('Attempting to send email...');
                // Try to send email but don't let it block registration
                try {
                    await sendQuizEmail(email, 'Daily Quiz - Your Password', emailBody);
                    console.log('‚úÖ Email sent successfully');
                } catch (emailErr) {
                    console.warn('‚ö†Ô∏è Email send failed but registration successful:', emailErr);
                }
                
                console.log('Showing success alert...');
                
                // Clear any previous messages first
                document.getElementById('quizMessage').innerHTML = '';
                
                // Also show in alert for immediate visibility with password segment
                alert(`‚úÖ Registration Successful!\n\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\nYour Login Credentials:\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\nPhone Number: ${phone}\n\nüîë PASSWORD: ${password}\n\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\nIMPORTANT:\n‚úÖ Password is shown in YELLOW BOX below\n‚úÖ Password is auto-filled in login form\n‚úÖ You can copy it from either place\n\nNote: Email sent to ${email}\n(Check inbox or spam folder in 1-2 minutes)`);
                
                // Show password in a dedicated, copyable box
                const passwordBoxHTML = `
                    <div style="background:#d4edda;border:3px solid #28a745;border-radius:12px;padding:25px;margin-bottom:20px;">
                        <h3 style="color:#155724;margin-bottom:15px;text-align:center">‚úÖ Registration Successful!</h3>
                        <div style="background:white;padding:20px;border-radius:8px;margin-bottom:15px;">
                            <p style="margin-bottom:10px"><strong>Phone Number (Login ID):</strong> ${phone}</p>
                            <p style="margin-bottom:10px"><strong>Class:</strong> ${cls}</p>
                        </div>
                        <div style="background:#fff3cd;border:2px solid #ffc107;border-radius:8px;padding:20px;text-align:center;">
                            <p style="margin-bottom:10px;font-weight:bold;color:#856404">üîë YOUR PASSWORD (Click to select and copy):</p>
                            <div onclick="this.querySelector('span').select(); document.execCommand('copy');" style="cursor:pointer;background:#ffeb3b;padding:15px 25px;border-radius:8px;border:2px dashed #ffc107;display:inline-block;">
                                <span style="font-size:2em;font-weight:bold;color:#000;user-select:all;font-family:monospace;letter-spacing:2px;">${password}</span>
                            </div>
                            <p style="margin-top:15px;font-size:0.9em;color:#856404">üëÜ Click on the password above to copy it</p>
                        </div>
                        <p style="margin-top:15px;text-align:center;color:#155724">
                            ‚úÖ Password has been auto-filled in the login form below<br>
                            ‚úÖ Email sent to: ${email} (check spam if not in inbox)
                        </p>
                    </div>
                `;
                
                document.getElementById('quizMessage').innerHTML = passwordBoxHTML;
                document.getElementById('quizMessage').style.display = 'block';
                document.getElementById('quizMessage').classList.add('show');
                
                // Scroll to the password box
                document.getElementById('quizMessage').scrollIntoView({ behavior: 'smooth', block: 'center' });
                
                console.log('Clearing form...');
                document.getElementById('quizClass').value = '';
                document.getElementById('quizEmail').value = '';
                document.getElementById('quizPhone').value = '';
                document.getElementById('quizName').value = '';
                
                // Auto-fill login form with phone number
                document.getElementById('quizLoginPhone').value = phone;
                document.getElementById('quizLoginPassword').value = password;
                
                console.log('‚úÖ Registration completed successfully!');
                console.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');
                console.log(`üìß EMAIL DEBUG INFO:`);
                console.log(`   Intended recipient: ${email}`);
                console.log(`   Check if email arrived at: ${email}`);
                console.log(`   Look for "to" field to verify correct email`);
                console.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');
            } catch (err) {
                console.error('‚ùå Registration error:', err);
                console.error('Error details:', err.message, err.stack);
                
                let errorMsg = 'Registration failed. ';
                
                // Check for specific error types
                if (err.message && err.message.includes('permission')) {
                    errorMsg = 'üîí FIREBASE PERMISSION DENIED!\n\n';
                    errorMsg += 'Your Firebase Database Rules are blocking writes.\n\n';
                    errorMsg += 'FIX THIS NOW:\n';
                    errorMsg += '1. Go to Firebase Console\n';
                    errorMsg += '2. Open Realtime Database > Rules\n';
                    errorMsg += '3. Set rules to allow writes\n';
                    errorMsg += '4. Click Publish\n\n';
                    errorMsg += 'Check console for database URL.';
                    
                    alert(errorMsg);
                    console.error('üî• FIREBASE RULES ERROR - Update your rules to:');
                    console.error(JSON.stringify({rules: {".read": true, ".write": true}}, null, 2));
                } else if (err.message && err.message.includes('network')) {
                    errorMsg = 'üåê NETWORK ERROR!\n\nCheck your internet connection.';
                    alert(errorMsg);
                } else if (!db) {
                    errorMsg = '‚ö†Ô∏è FIREBASE NOT CONNECTED!\n\nDatabase initialization failed.';
                    alert(errorMsg);
                } else {
                    errorMsg = `‚ùå Registration Error:\n\n${err.message}\n\nCheck browser console for details.`;
                    alert(errorMsg);
                }
                
                showQuizMsg('quizMessage', errorMsg.replace(/\n/g, ' '), 'error');
            }
        }
        
        // Student Login
        async function loginQuizStudent() {
            // Sanitize: strip spaces, dashes, +91 prefix, any non-digit chars
            let rawPhone = document.getElementById('quizLoginPhone').value.trim();
            rawPhone = rawPhone.replace(/[\s\-\(\)]/g, '');        // remove spaces/dashes/brackets
            if (rawPhone.startsWith('+91')) rawPhone = rawPhone.slice(3);
            if (rawPhone.startsWith('91') && rawPhone.length === 12) rawPhone = rawPhone.slice(2);
            const phone = rawPhone.replace(/\D/g, '');              // keep only digits

            const password = document.getElementById('quizLoginPassword').value.trim();
            
            console.log('=== STUDENT LOGIN START ===');
            console.log('Phone (sanitized):', phone);
            console.log('Password length:', password.length);
            
            if (!phone || !password) {
                showQuizMsg('quizMessage', 'Please enter phone number and password!', 'error');
                document.getElementById('quizMessage').scrollIntoView({ behavior: 'smooth', block: 'center' });
                return;
            }
            
            if (phone.length !== 10) {
                showQuizMsg('quizMessage', `Invalid phone number (got ${phone.length} digits, need 10). Please check and try again.`, 'error');
                document.getElementById('quizMessage').scrollIntoView({ behavior: 'smooth', block: 'center' });
                return;
            }
            
            try {
                // Show loading state on button
                const loginBtn = document.querySelector('#dailyQuizLogin .btn-success');
                if (loginBtn) { loginBtn.disabled = true; loginBtn.textContent = '‚è≥ Logging in...'; }

                const studRef = db.ref('quizStudents');
                const snap = await studRef.orderByChild('phone').equalTo(phone).once('value');
                
                console.log('Student lookup result:', snap.exists());
                
                if (!snap.exists()) {
                    showQuizMsg('quizMessage', '‚ùå Phone number not registered! Please register first.', 'error');
                    document.getElementById('quizMessage').scrollIntoView({ behavior: 'smooth', block: 'center' });
                    if (loginBtn) { loginBtn.disabled = false; loginBtn.innerHTML = 'üöÄ Login to Quiz'; }
                    return;
                }
                
                let studentData = null;
                let studentKey = null;
                snap.forEach(child => {
                    studentData = child.val();
                    studentKey = child.key;
                });
                
                console.log('Student data found:', {
                    key: studentKey,
                    name: studentData.name,
                    email: studentData.email,
                    class: studentData.class
                });
                
                if (studentData.password !== password) {
                    console.log('Password mismatch');
                    showQuizMsg('quizMessage', '‚ùå Incorrect password! Check your password and try again.', 'error');
                    document.getElementById('quizMessage').scrollIntoView({ behavior: 'smooth', block: 'center' });
                    if (loginBtn) { loginBtn.disabled = false; loginBtn.innerHTML = 'üöÄ Login to Quiz'; }
                    return;
                }
                
                console.log('Password correct - logging in');
                
                quizCurrentUser = {key: studentKey, ...studentData};
                quizUserRole = 'student';
                
                console.log('quizCurrentUser set:', quizCurrentUser);
                console.log('quizUserRole set:', quizUserRole);
                
                // Hide login section
                console.log('Hiding login section');
                const loginSection = document.getElementById('loginSection');
                loginSection.style.display = 'none';
                
                // Show student dashboard
                const dashboard = document.getElementById('quizStudentDashboard');
                dashboard.style.display = 'block';
                
                // Start live date/time clock
                startQuizLiveClock();
                
                // Scroll to top immediately on login
                window.scrollTo({ top: 0, behavior: 'instant' });
                
                // Set student info
                document.getElementById('quizStudentName').textContent = studentData.name;
                document.getElementById('quizStudentNameBadge').textContent = studentData.name;
                document.getElementById('quizStudentEmail').textContent = studentData.email;
                document.getElementById('quizStudentClass').textContent = studentData.class;
                
                console.log('Calling checkQuizTodayStatus()');
                await checkQuizTodayStatus();
                
                console.log('=== STUDENT LOGIN END ===');
            } catch (err) {
                console.error('Login error:', err);
                console.error('Error stack:', err.stack);
                showQuizMsg('quizMessage', '‚ùå Login failed. Please check your connection and try again.', 'error');
                document.getElementById('quizMessage').scrollIntoView({ behavior: 'smooth', block: 'center' });
                const loginBtn = document.querySelector('#dailyQuizLogin .btn-success');
                if (loginBtn) { loginBtn.disabled = false; loginBtn.innerHTML = 'üöÄ Login to Quiz'; }
            }
        }
        
        // ============================================
        // LIVE DATE / TIME CLOCK FOR STUDENT DASHBOARD
        // ============================================
        let _quizClockInterval = null;

        function startQuizLiveClock() {
            stopQuizLiveClock();
            function tick() {
                const now = new Date();
                const days = ['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'];
                const months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];

                const dayName  = days[now.getDay()];
                const day      = now.getDate();
                const month    = months[now.getMonth()];
                const year     = now.getFullYear();

                let hours   = now.getHours();
                const mins  = String(now.getMinutes()).padStart(2, '0');
                const secs  = String(now.getSeconds()).padStart(2, '0');
                const ampm  = hours >= 12 ? 'PM' : 'AM';
                hours = hours % 12 || 12;
                const hStr  = String(hours).padStart(2, '0');

                const dayEl  = document.getElementById('quizLiveDay');
                const dateEl = document.getElementById('quizLiveDate');
                const timeEl = document.getElementById('quizLiveTime');
                const amEl   = document.getElementById('quizLiveAmPm');

                if (dayEl)  dayEl.textContent  = dayName;
                if (dateEl) dateEl.textContent  = `${day} ${month} ${year}`;
                if (timeEl) timeEl.textContent  = `${hStr}:${mins}:${secs}`;
                if (amEl)   amEl.innerHTML      = `${ampm}<br><span style="font-size:10px;opacity:0.7">IST</span>`;
            }
            tick();
            _quizClockInterval = setInterval(tick, 1000);
        }

        function stopQuizLiveClock() {
            if (_quizClockInterval) { clearInterval(_quizClockInterval); _quizClockInterval = null; }
        }

        // Regular Quiz Admin login removed - Only Super Admin Dashboard is used
        
        // Check Quiz Status
        async function checkQuizTodayStatus() {
            const today = await getQuizTodayServer();
            console.log('‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó');
            console.log('‚ïë          INTENSIVE DEBUG: checkQuizTodayStatus            ‚ïë');
            console.log('‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù');
            console.log('üìÖ Today (calculated):', today);
            console.log('üìÖ Format check: Should be YYYY-MM-DD like 2026-02-17');
            console.log('üïê Current system time:', new Date().toISOString());
            console.log('üïê Current local time:', new Date().toString());
            
            // Reset all sections first
            document.getElementById('quizStartSection').style.display = 'none';
            document.getElementById('quizCompletedSection').style.display = 'none';
            document.getElementById('quizResultsSection').style.display = 'none';
            
            try {
                // INTENSIVE CHECK: What dates exist in Firebase
                console.log('');
                console.log('üîç STEP 1: Checking ALL quiz dates in Firebase...');
                const allQuestionsSnap = await db.ref('quizQuestions').once('value');
                if (allQuestionsSnap.exists()) {
                    const allData = allQuestionsSnap.val();
                    const dates = Object.keys(allData);
                    console.log('‚úÖ Found quiz dates in Firebase:', dates);
                    console.log('üìä Total quiz dates found:', dates.length);
                    
                    // Check each date and its structure
                    dates.forEach(date => {
                        const data = allData[date];
                        console.log(`   üìÖ Date: ${date}`);
                        console.log(`      - Has q1: ${!!data.q1}`);
                        console.log(`      - Has q2: ${!!data.q2}`);
                        if (data.q1) console.log(`      - Q1 text: "${data.q1.text.substring(0, 40)}..."`);
                        if (data.q2) console.log(`      - Q2 text: "${data.q2.text.substring(0, 40)}..."`);
                    });
                    
                    // Check if today's date exists in the list
                    if (dates.includes(today)) {
                        console.log(`‚úÖ TODAY'S DATE (${today}) EXISTS IN FIREBASE!`);
                    } else {
                        console.log(`‚ùå TODAY'S DATE (${today}) NOT FOUND IN FIREBASE!`);
                        console.log(`   Available dates: ${dates.join(', ')}`);
                    }
                } else {
                    console.log('‚ùå NO quiz questions found in Firebase at all!');
                    console.log('   Database path checked: quizQuestions/');
                }
                
                console.log('');
                console.log(`üîç STEP 2: Checking specifically for today (${today})...`);
                const qRef = db.ref(`quizQuestions/${today}`);
                console.log('   Firebase path:', `quizQuestions/${today}`);
                const qSnap = await qRef.once('value');
                
                console.log('   Query result - exists():', qSnap.exists());
                
                if (qSnap.exists()) {
                    const questionData = qSnap.val();
                    console.log('‚úÖ QUESTIONS FOUND FOR TODAY!');
                    console.log('   Full data structure:', JSON.stringify(questionData, null, 2));
                    console.log('   Has q1:', !!questionData.q1);
                    console.log('   Has q2:', !!questionData.q2);
                    if (questionData.q1) {
                        console.log('   Q1 text:', questionData.q1.text);
                        console.log('   Q1 options:', questionData.q1.options);
                        console.log('   Q1 correct answer:', questionData.q1.correct);
                    }
                    if (questionData.q2) {
                        console.log('   Q2 text:', questionData.q2.text);
                        console.log('   Q2 options:', questionData.q2.options);
                        console.log('   Q2 correct answer:', questionData.q2.correct);
                    }
                } else {
                    console.log('‚ùå NO QUESTIONS FOUND FOR TODAY');
                }
                
                if (!qSnap.exists()) {
                    console.log('');
                    console.log('‚ö†Ô∏è  FINAL DECISION: Showing "not available" message');
                    console.log('   Reason: No questions exist for today\'s date');
                    document.getElementById('quizStatus').innerHTML = '<div style="background:#fff3cd;padding:15px;border-radius:8px"><p style="margin:0;color:#856404">‚è≥ Today\'s quiz not yet available. Check back later!</p></div>';
                    console.log('‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó');
                    console.log('‚ïë                    DEBUG END (EARLY EXIT)                 ‚ïë');
                    console.log('‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù');
                    return;
                }
                
                // Quiz questions exist - students can take the quiz!
                console.log('');
                console.log('üîç STEP 3: Quiz questions exist! Checking submission status...');
                console.log('   Current user:', quizCurrentUser);
                console.log('   User email:', quizCurrentUser ? quizCurrentUser.email : 'NULL/UNDEFINED');
                console.log('   User name:', quizCurrentUser ? quizCurrentUser.name : 'NULL/UNDEFINED');
                
                if (!quizCurrentUser || !quizCurrentUser.email) {
                    console.log('‚ùå ERROR: User object or email is missing!');
                    console.log('   This should not happen - user must be logged in to reach here');
                }
                
                const subRef = db.ref(`quizSubmissions/${today}`);
                console.log('   Checking submissions at path:', `quizSubmissions/${today}`);
                console.log('   Querying by studentEmail:', quizCurrentUser.email);
                
                const subSnap = await subRef.orderByChild('studentEmail').equalTo(quizCurrentUser.email).once('value');
                
                console.log('   Submission exists:', subSnap.exists());
                
                let studentAlreadySubmitted = false;
                let studentSubmission = null;
                
                if (subSnap.exists()) {
                    subSnap.forEach(child => {
                        if (child.val().studentKey === quizCurrentUser.key) {
                            studentAlreadySubmitted = true;
                            studentSubmission = child.val();
                        }
                    });
                }
                
                if (studentAlreadySubmitted) {
                    console.log('‚úÖ Student HAS submitted - showing completed section');
                    console.log('   Submission data:', JSON.stringify(studentSubmission, null, 2));
                    
                    document.getElementById('quizCompletedSection').style.display = 'block';
                    document.getElementById('quizStatus').innerHTML = '<div style="background:#d1ecf1;padding:15px;border-radius:8px"><p style="margin:0;color:#0c5460">‚úÖ You have completed today\'s quiz!</p></div>';
                    
                    // Start next-quiz countdown when quiz is completed
                    (function startNextQuizCountdown() {
                        if (window._nextQuizCdInterval) clearInterval(window._nextQuizCdInterval);
                        function updateNextQuiz() {
                            const now = new Date();
                            const tomorrow = new Date(now);
                            tomorrow.setDate(tomorrow.getDate() + 1);
                            const dayStr = tomorrow.toLocaleDateString('en-IN', {weekday:'short', day:'numeric', month:'short'});
                            const s = document.getElementById('nextQuizStartTime');
                            const e = document.getElementById('nextQuizEndTime');
                            const c = document.getElementById('nextQuizCountdown');
                            if (s) s.textContent = dayStr + ' ¬∑ 12:00 AM';
                            if (e) e.textContent = dayStr + ' ¬∑ 11:59 PM';
                            const midnight = new Date(now); midnight.setHours(24,0,0,0);
                            const diff = midnight - now;
                            if (diff > 0) {
                                const h = Math.floor(diff/3600000), m = Math.floor((diff%3600000)/60000), sec = Math.floor((diff%60000)/1000);
                                if (c) c.textContent = String(h).padStart(2,'0')+':'+String(m).padStart(2,'0')+':'+String(sec).padStart(2,'0');
                            } else { if (c) c.textContent = 'Now!'; }
                        }
                        updateNextQuiz();
                        window._nextQuizCdInterval = setInterval(updateNextQuiz, 1000);
                    })();
                    const resRef = db.ref(`quizResults/${today}`);
                    const resSnap = await resRef.once('value');
                    
                    if (resSnap.exists()) {
                        const results = resSnap.val();
                        console.log('   Results data:', JSON.stringify(results, null, 2));
                        
                        let html = '<div style="background:#f8f9fa;padding:20px;border-radius:10px">';
                        html += `<p><strong>Your Score:</strong> ${studentSubmission.score}/2</p>`;
                        html += `<p><strong>Submitted:</strong> ${new Date(studentSubmission.submittedAt).toLocaleString()}</p>`;
                        
                        if (results.winner && results.winner.email === quizCurrentUser.email) {
                            html += '<div style="background:#d4edda;color:#155724;padding:15px;border-radius:8px;margin-top:15px"><strong>üèÜ CONGRATULATIONS! You are the WINNER!</strong></div>';
                        } else if (results.runnerUp && results.runnerUp.email === quizCurrentUser.email) {
                            html += '<div style="background:#d1ecf1;color:#0c5460;padding:15px;border-radius:8px;margin-top:15px"><strong>ü•à CONGRATULATIONS! You are the RUNNER-UP!</strong></div>';
                        } else if (studentSubmission.score === 2) {
                            html += '<div style="background:#d1ecf1;color:#0c5460;padding:15px;border-radius:8px;margin-top:15px"><strong>‚úÖ Great job! Both answers correct!</strong></div>';
                        }
                        
                        html += '</div>';
                        document.getElementById('quizStudentResults').innerHTML = html;
                        document.getElementById('quizResultsSection').style.display = 'block';
                    } else {
                        console.log('   No results published yet');
                    }
                } else {
                    console.log('‚úÖ Student has NOT submitted yet - SHOWING QUIZ!');
                    document.getElementById('quizStatus').innerHTML = '<div style="background:#d4edda;padding:15px;border-radius:8px"><p style="margin:0;color:#155724"><strong>‚úÖ Ready!</strong> Today\'s quiz is available. Click below to start.</p></div>';
                    document.getElementById('quizStartSection').style.display = 'block';
                    console.log('‚úÖ QUIZ SHOULD NOW BE VISIBLE TO USER!');
                }
                
                console.log('');
                console.log('‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó');
                console.log('‚ïë                    DEBUG END (SUCCESS)                    ‚ïë');
                console.log('‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù');
            } catch (err) {
                console.log('');
                console.log('‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó');
                console.log('‚ïë                   ERROR OCCURRED!!!                       ‚ïë');
                console.log('‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù');
                console.error('‚ùå Status check error:', err);
                console.error('‚ùå Error message:', err.message);
                console.error('‚ùå Error stack:', err.stack);
                console.error('‚ùå Error name:', err.name);
                document.getElementById('quizStatus').innerHTML = '<div style="background:#f8d7da;padding:15px;border-radius:8px"><p style="margin:0;color:#721c24">‚ùå Error checking quiz status. Please refresh the page.</p></div>';
                console.log('‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó');
                console.log('‚ïë                    DEBUG END (ERROR)                      ‚ïë');
                console.log('‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù');
            }
        }
        
        // Start Quiz
        async function startQuiz() {
            const today = await getQuizTodayServer();
            
            try {
                const qRef = db.ref(`quizQuestions/${today}`);
                const snap = await qRef.once('value');
                const questions = snap.val();
                
                if (!questions || !questions.q1 || !questions.q2) {
                    showQuizMsg('quizStudentMessage', 'Quiz not available!', 'error');
                    return;
                }
                
                // Set the date display
                const dateObj = new Date(today);
                const dateStr = dateObj.toLocaleDateString('en-IN', {
                    weekday: 'long',
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
                document.getElementById('quizDateDisplay').textContent = 'üìÖ ' + dateStr;
                
                document.getElementById('quizStudentDashboard').style.display = 'none';
                document.getElementById('quizPage').style.display = 'block';
                
                enableQuizAntiCheat();
                loadQuizQuestions(questions);
                quizStartTime = Date.now();
                startQuizTimer();
            } catch (err) {
                console.error('Start quiz error:', err);
            }
        }
        
        // Load Questions
        function loadQuizQuestions(questions) {
            const cont = document.getElementById('quizQuestionsContainer');
            
            let html = '';
            
            // Question 1
            html += '<div class="quiz-question-card" style="animation-delay: 0.1s">';
            html += '<h4><span style="background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:white;padding:5px 15px;border-radius:20px;font-size:0.9em">Question 1 of 2</span></h4>';
            
            // Add image if present
            if (questions.q1.image) {
                html += `<div style="text-align:center;margin:15px 0">
                    <img src="${questions.q1.image}" style="max-width:100%;max-height:300px;border-radius:12px;box-shadow:0 4px 15px rgba(0,0,0,0.2)">
                </div>`;
            }
            
            // Add audio player if present
            if (questions.q1.audio) {
                html += `<div style="text-align:center;margin:15px 0;background:#f0f0f0;padding:15px;border-radius:10px">
                    <p style="margin:0 0 10px 0;font-weight:600;color:#667eea">üéµ Listen to the audio</p>
                    <audio controls id="q1Audio" style="width:100%;max-width:400px">
                        <source src="${questions.q1.audio}">
                    </audio>
                </div>`;
            }
            
            html += `<div class="question-text">${questions.q1.text}</div>`;
            html += '<div style="display:grid;gap:15px">';
            ['A','B','C','D'].forEach(opt => {
                html += `<div class="quiz-option" data-question="qq1" data-value="${opt}">
                    <div class="option-circle">${opt}</div>
                    <span style="flex:1">${questions.q1.options[opt]}</span>
                    <input type="radio" name="qq1" value="${opt}" style="display:none">
                </div>`;
            });
            html += '</div></div>';
            
            // Question 2
            html += '<div class="quiz-question-card" style="animation-delay: 0.2s">';
            html += '<h4><span style="background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:white;padding:5px 15px;border-radius:20px;font-size:0.9em">Question 2 of 2</span></h4>';
            
            // Add image if present
            if (questions.q2.image) {
                html += `<div style="text-align:center;margin:15px 0">
                    <img src="${questions.q2.image}" style="max-width:100%;max-height:300px;border-radius:12px;box-shadow:0 4px 15px rgba(0,0,0,0.2)">
                </div>`;
            }
            
            // Add audio player if present
            if (questions.q2.audio) {
                html += `<div style="text-align:center;margin:15px 0;background:#f0f0f0;padding:15px;border-radius:10px">
                    <p style="margin:0 0 10px 0;font-weight:600;color:#667eea">üéµ Listen to the audio</p>
                    <audio controls id="q2Audio" style="width:100%;max-width:400px">
                        <source src="${questions.q2.audio}">
                    </audio>
                </div>`;
            }
            
            html += `<div class="question-text">${questions.q2.text}</div>`;
            html += '<div style="display:grid;gap:15px">';
            ['A','B','C','D'].forEach(opt => {
                html += `<div class="quiz-option" data-question="qq2" data-value="${opt}">
                    <div class="option-circle">${opt}</div>
                    <span style="flex:1">${questions.q2.options[opt]}</span>
                    <input type="radio" name="qq2" value="${opt}" style="display:none">
                </div>`;
            });
            html += '</div></div>';
            
            cont.innerHTML = html;
            
            // Add click handlers for new styled options
            document.querySelectorAll('.quiz-option').forEach(opt => {
                opt.onclick = function() {
                    const question = this.getAttribute('data-question');
                    const value = this.getAttribute('data-value');
                    
                    // Remove selected class from all options in this question
                    document.querySelectorAll(`.quiz-option[data-question="${question}"]`).forEach(o => {
                        o.classList.remove('selected');
                    });
                    
                    // Add selected class to clicked option
                    this.classList.add('selected');
                    
                    // Update hidden radio button
                    const radio = this.querySelector('input[type="radio"]');
                    radio.checked = true;
                };
            });
        }
        
        // Quiz Timer
        function startQuizTimer() {
            updateQuizTimer();
            quizTimerInterval = setInterval(updateQuizTimer, 1000);
        }
        
        function updateQuizTimer() {
            const elapsed = Math.floor((Date.now() - quizStartTime) / 1000);
            const mins = Math.floor(elapsed / 60);
            const secs = elapsed % 60;
            document.getElementById('quizTimerValue').textContent = `${mins.toString().padStart(2,'0')}:${secs.toString().padStart(2,'0')}`;
            
            if (elapsed > 600) {
                document.getElementById('quizTimer').style.background = '#ff6b6b';
                document.getElementById('quizTimer').style.color = 'white';
            }
        }
        
        // Submit Quiz
        let quizSubmitting = false; // Flag to prevent double submission

        async function submitQuizAnswers() {
            // BLOCK: Prevent double submission
            if (quizSubmitting) {
                return;
            }
            
            const q1 = document.querySelector('input[name="qq1"]:checked');
            const q2 = document.querySelector('input[name="qq2"]:checked');
            
            if (!q1 || !q2) {
                showQuizMsg('quizPageMessage', '‚ö†Ô∏è Please answer all questions!', 'error');
                return;
            }
            
            // Immediately disable submit button and set flag
            quizSubmitting = true;
            const submitBtn = document.querySelector('.quiz-submit-btn');
            if (submitBtn) {
                submitBtn.disabled = true;
                submitBtn.textContent = '‚è≥ Submitting...';
                submitBtn.style.opacity = '0.6';
                submitBtn.style.cursor = 'not-allowed';
            }
            
            const today = await getQuizTodayServer();
            
            try {
                // BLOCK: Check Firebase if student already submitted today
                const existingSnap = await db.ref(`quizSubmissions/${today}`).once('value');
                if (existingSnap.exists()) {
                    let alreadySubmitted = false;
                    existingSnap.forEach(child => {
                        if (child.val().studentKey === quizCurrentUser.key) {
                            alreadySubmitted = true;
                        }
                    });
                    if (alreadySubmitted) {
                        showQuizMsg('quizPageMessage', '‚ö†Ô∏è You have already submitted today\'s quiz!', 'error');
                        quizSubmitting = false;
                        if (submitBtn) {
                            submitBtn.disabled = true;
                            submitBtn.textContent = '‚úÖ Already Submitted';
                        }
                        setTimeout(() => {
                            document.getElementById('quizPage').style.display = 'none';
                            document.getElementById('quizStudentDashboard').style.display = 'block';
                            checkQuizTodayStatus();
                        }, 2000);
                        return;
                    }
                }
                
                const qRef = db.ref(`quizQuestions/${today}`);
                const snap = await qRef.once('value');
                const questions = snap.val();
                
                let score = 0;
                if (q1.value === questions.q1.correct) score++;
                if (q2.value === questions.q2.correct) score++;
                
                await db.ref(`quizSubmissions/${today}`).push({
                    studentKey: quizCurrentUser.key,
                    studentName: quizCurrentUser.name,
                    studentEmail: quizCurrentUser.email,
                    studentClass: quizCurrentUser.class,
                    answers: {q1: q1.value, q2: q2.value},
                    score,
                    submittedAt: new Date().toISOString(),
                    timeTaken: Math.floor((Date.now() - quizStartTime) / 1000)
                });
                
                disableQuizAntiCheat();
                if (quizTimerInterval) clearInterval(quizTimerInterval);
                
                // Show success modal with confetti
                showQuizSuccessModal(score);
                
                setTimeout(() => {
                    quizSubmitting = false;
                    document.getElementById('quizPage').style.display = 'none';
                    document.getElementById('quizStudentDashboard').style.display = 'block';
                    // Scroll to top so student sees the status
                    window.scrollTo({ top: 0, behavior: 'instant' });
                    checkQuizTodayStatus();
                }, 4000);
            } catch (err) {
                console.error('Submit error:', err);
                quizSubmitting = false;
                if (submitBtn) {
                    submitBtn.disabled = false;
                    submitBtn.textContent = '‚úÖ Submit Quiz';
                    submitBtn.style.opacity = '1';
                    submitBtn.style.cursor = 'pointer';
                }
                showQuizMsg('quizPageMessage', 'Error submitting. Try again.', 'error');
            }
        }
        
        // Show Success Modal with Confetti
        function showQuizSuccessModal(score) {
            const modal = document.createElement('div');
            modal.className = 'quiz-success-modal';
            modal.innerHTML = `
                <div class="quiz-success-content">
                    <div class="success-icon">üéâ</div>
                    <h2>Quiz Submitted!</h2>
                    <p style="font-size:1.5em;color:#28a745;font-weight:bold">Your Score: ${score}/2</p>
                    <p style="margin-top:15px">Results will be announced soon!</p>
                    <p style="color:#999;font-size:0.9em;margin-top:10px">Good luck! üçÄ</p>
                </div>
            `;
            document.body.appendChild(modal);
            
            // Create confetti
            createConfetti();
            
            // Remove modal after 3.5 seconds
            setTimeout(() => {
                modal.style.opacity = '0';
                setTimeout(() => modal.remove(), 300);
            }, 3500);
        }
        
        // Create Confetti Animation
        function createConfetti() {
            const colors = ['#ff6b6b', '#4ecdc4', '#45b7d1', '#f7b731', '#5f27cd', '#00d2d3', '#ff9ff3', '#54a0ff'];
            const confettiCount = 50;
            
            for (let i = 0; i < confettiCount; i++) {
                const confetti = document.createElement('div');
                confetti.className = 'confetti';
                confetti.style.left = Math.random() * 100 + '%';
                confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                confetti.style.animationDelay = Math.random() * 0.5 + 's';
                confetti.style.animationDuration = (Math.random() * 2 + 2) + 's';
                document.body.appendChild(confetti);
                
                setTimeout(() => confetti.remove(), 3000);
            }
        }
        
        // Anti-Cheat
        function enableQuizAntiCheat() {
            quizAntiCheatActive = true;
            window.onbeforeunload = () => quizAntiCheatActive ? "Quiz in progress!" : null;
            document.addEventListener('visibilitychange', handleQuizVisibility);
        }
        
        function handleQuizVisibility() {
            if (quizAntiCheatActive && document.hidden) {
                alert('‚ö†Ô∏è TAB SWITCH! Auto-submitting quiz.');
                autoSubmitQuiz();
            }
        }
        
        async function autoSubmitQuiz() {
            if (!quizAntiCheatActive) return;
            const today = getQuizToday();
            try {
                await db.ref(`quizSubmissions/${today}`).push({
                    studentKey: quizCurrentUser.key,
                    studentName: quizCurrentUser.name,
                    studentEmail: quizCurrentUser.email,
                    studentClass: quizCurrentUser.class,
                    answers: {q1: 'X', q2: 'X'},
                    score: 0,
                    submittedAt: new Date().toISOString(),
                    timeTaken: 0,
                    status: 'auto-submitted'
                });
                disableQuizAntiCheat();
                if (quizTimerInterval) clearInterval(quizTimerInterval);
                document.getElementById('quizPage').style.display = 'none';
                document.getElementById('quizStudentDashboard').style.display = 'block';
                checkQuizTodayStatus();
            } catch (err) {
                console.error('Auto-submit error:', err);
            }
        }
        
        function disableQuizAntiCheat() {
            quizAntiCheatActive = false;
            window.onbeforeunload = null;
            document.removeEventListener('visibilitychange', handleQuizVisibility);
        }
        
        // Admin Functions
        async function loadQuizAdminStats() {
            try {
                const studSnap = await db.ref('quizStudents').once('value');
                document.getElementById('quizTotalStudents').textContent = studSnap.numChildren();
                
                const today = getQuizToday();
                const subSnap = await db.ref(`quizSubmissions/${today}`).once('value');
                document.getElementById('quizTodayParticipants').textContent = subSnap.numChildren();
                
                const qSnap = await db.ref(`quizQuestions/${today}`).once('value');
                document.getElementById('quizQuestionsCount').textContent = qSnap.exists() ? 2 : 0;
            } catch (err) {
                console.error('Stats error:', err);
            }
        }
        
        function showQuizAdminTab(tab) {
            document.querySelectorAll('#quizAdminDashboard .tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('#quizAdminDashboard .form-section').forEach(s => s.classList.remove('active'));
            
            const tabs = ['questions','students','submissions','results'];
            const idx = tabs.indexOf(tab);
            document.querySelectorAll('#quizAdminDashboard .tab')[idx].classList.add('active');
            document.getElementById(`quiz${tab.charAt(0).toUpperCase()+tab.slice(1)}TabContent`).classList.add('active');
            
            if (tab === 'students') loadQuizStudents();
            if (tab === 'submissions') loadQuizSubmissions();
            if (tab === 'results') loadQuizResults();
        }
        
        // Preview Image for Question
        function previewQuestionImage(input, previewId) {
            const preview = document.getElementById(previewId);
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    preview.innerHTML = `
                        <div style="position:relative;display:inline-block">
                            <img src="${e.target.result}" style="max-width:300px;max-height:200px;border-radius:8px;box-shadow:0 4px 10px rgba(0,0,0,0.1)">
                            <button onclick="clearMedia('${input.id}', '${previewId}')" style="position:absolute;top:5px;right:5px;background:red;color:white;border:none;border-radius:50%;width:25px;height:25px;cursor:pointer">√ó</button>
                        </div>
                    `;
                };
                reader.readAsDataURL(input.files[0]);
            }
        }
        
        // Preview Audio for Question
        function previewQuestionAudio(input, previewId) {
            const preview = document.getElementById(previewId);
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    preview.innerHTML = `
                        <div style="background:#f0f0f0;padding:15px;border-radius:8px;display:inline-block">
                            <audio controls style="max-width:300px">
                                <source src="${e.target.result}">
                            </audio>
                            <button onclick="clearMedia('${input.id}', '${previewId}')" style="margin-left:10px;background:red;color:white;border:none;border-radius:5px;padding:5px 10px;cursor:pointer">Remove</button>
                        </div>
                    `;
                };
                reader.readAsDataURL(input.files[0]);
            }
        }
        
        // Clear Media
        function clearMedia(inputId, previewId) {
            document.getElementById(inputId).value = '';
            document.getElementById(previewId).innerHTML = '';
        }
        
        async function saveQuizQuestions() {
            const q1Text = document.getElementById('q1Text').value.trim();
            const q1OptA = document.getElementById('q1OptA').value.trim();
            const q1OptB = document.getElementById('q1OptB').value.trim();
            const q1OptC = document.getElementById('q1OptC').value.trim();
            const q1OptD = document.getElementById('q1OptD').value.trim();
            const q1Correct = document.getElementById('q1Correct').value;
            
            const q2Text = document.getElementById('q2Text').value.trim();
            const q2OptA = document.getElementById('q2OptA').value.trim();
            const q2OptB = document.getElementById('q2OptB').value.trim();
            const q2OptC = document.getElementById('q2OptC').value.trim();
            const q2OptD = document.getElementById('q2OptD').value.trim();
            const q2Correct = document.getElementById('q2Correct').value;
            
            if (!q1Text || !q1OptA || !q1OptB || !q1OptC || !q1OptD || !q1Correct) {
                showQuizMsg('quizAdminDashMessage', '‚ö†Ô∏è Fill all Question 1 fields!', 'error');
                return;
            }
            
            if (!q2Text || !q2OptA || !q2OptB || !q2OptC || !q2OptD || !q2Correct) {
                showQuizMsg('quizAdminDashMessage', '‚ö†Ô∏è Fill all Question 2 fields!', 'error');
                return;
            }
            
            // Get image and audio files
            const q1ImageFile = document.getElementById('q1Image').files[0];
            const q1AudioFile = document.getElementById('q1Audio').files[0];
            const q2ImageFile = document.getElementById('q2Image').files[0];
            const q2AudioFile = document.getElementById('q2Audio').files[0];
            
            const today = getQuizToday();
            const data = {
                q1: {
                    text: q1Text, 
                    options: {A:q1OptA, B:q1OptB, C:q1OptC, D:q1OptD}, 
                    correct: q1Correct
                },
                q2: {
                    text: q2Text, 
                    options: {A:q2OptA, B:q2OptB, C:q2OptC, D:q2OptD}, 
                    correct: q2Correct
                },
                createdAt: new Date().toISOString(),
                createdBy: quizCurrentUser.email
            };
            
            // Convert images and audio to base64 if present
            try {
                if (q1ImageFile) {
                    data.q1.image = await fileToBase64(q1ImageFile);
                }
                if (q1AudioFile) {
                    data.q1.audio = await fileToBase64(q1AudioFile);
                }
                if (q2ImageFile) {
                    data.q2.image = await fileToBase64(q2ImageFile);
                }
                if (q2AudioFile) {
                    data.q2.audio = await fileToBase64(q2AudioFile);
                }
                
                await db.ref(`quizQuestions/${today}`).set(data);
                showQuizMsg('quizAdminDashMessage', '‚úÖ Questions saved successfully with media!', 'success');
                
                // Clear form
                ['q1Text','q1OptA','q1OptB','q1OptC','q1OptD','q1Correct','q2Text','q2OptA','q2OptB','q2OptC','q2OptD','q2Correct'].forEach(id => {
                    document.getElementById(id).value = '';
                });
                ['q1Image','q1Audio','q2Image','q2Audio'].forEach(id => {
                    document.getElementById(id).value = '';
                });
                ['q1ImagePreview','q1AudioPreview','q2ImagePreview','q2AudioPreview'].forEach(id => {
                    document.getElementById(id).innerHTML = '';
                });
                
                await loadQuizAdminStats();
            } catch (err) {
                console.error('Save error:', err);
                showQuizMsg('quizAdminDashMessage', 'Error saving questions.', 'error');
            }
        }
        
        // Convert file to base64
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }
        
        async function viewTodayQuestions() {
            const today = getQuizToday();
            try {
                const snap = await db.ref(`quizQuestions/${today}`).once('value');
                const q = snap.val();
                const view = document.getElementById('todayQuestionsView');
                
                if (!q) {
                    view.innerHTML = '<div style="background:#fff3cd;padding:15px;border-radius:8px;margin-top:20px"><p style="margin:0;color:#856404">No questions for today yet.</p></div>';
                    view.style.display = 'block';
                    return;
                }
                
                let html = '<div style="background:#f8f9fa;padding:20px;border-radius:10px">';
                html += '<h4 style="color:#667eea;margin-bottom:15px">Today\'s Questions Preview</h4>';
                html += `<p><strong>Q1:</strong> ${q.q1.text}</p>`;
                html += `<p style="margin-left:20px">A) ${q.q1.options.A}</p>`;
                html += `<p style="margin-left:20px">B) ${q.q1.options.B}</p>`;
                html += `<p style="margin-left:20px">C) ${q.q1.options.C}</p>`;
                html += `<p style="margin-left:20px">D) ${q.q1.options.D}</p>`;
                html += `<p style="color:green;font-weight:bold;margin-left:20px">Correct: ${q.q1.correct}</p><br>`;
                html += `<p><strong>Q2:</strong> ${q.q2.text}</p>`;
                html += `<p style="margin-left:20px">A) ${q.q2.options.A}</p>`;
                html += `<p style="margin-left:20px">B) ${q.q2.options.B}</p>`;
                html += `<p style="margin-left:20px">C) ${q.q2.options.C}</p>`;
                html += `<p style="margin-left:20px">D) ${q.q2.options.D}</p>`;
                html += `<p style="color:green;font-weight:bold;margin-left:20px">Correct: ${q.q2.correct}</p>`;
                html += '</div>';
                
                view.innerHTML = html;
                view.style.display = 'block';
                
                // Check publish status
                await checkPublishStatusForToday();
            } catch (err) {
                console.error('View error:', err);
            }
        }
        
        async function loadQuizStudents() {
            try {
                const snap = await db.ref('quizStudents').once('value');
                const tbody = document.getElementById('quizStudentsTable');
                tbody.innerHTML = '';
                
                if (!snap.exists()) {
                    tbody.innerHTML = '<tr><td colspan="6" style="text-align:center">No students yet.</td></tr>';
                    return;
                }
                
                let idx = 1;
                snap.forEach(child => {
                    const s = child.val();
                    const row = tbody.insertRow();
                    row.innerHTML = `<td>${idx++}</td><td>${s.name}</td><td>${s.email}</td><td>${s.phone}</td><td>${s.class}</td><td>${new Date(s.registeredAt).toLocaleDateString()}</td>`;
                });
            } catch (err) {
                console.error('Load students error:', err);
            }
        }
        
        async function loadQuizSubmissions() {
            const today = getQuizToday();
            try {
                const snap = await db.ref(`quizSubmissions/${today}`).once('value');
                const tbody = document.getElementById('quizSubmissionsTable');
                tbody.innerHTML = '';
                
                if (!snap.exists()) {
                    tbody.innerHTML = '<tr><td colspan="7" style="text-align:center">No submissions yet today.</td></tr>';
                    return;
                }
                
                let idx = 1;
                snap.forEach(child => {
                    const s = child.val();
                    const row = tbody.insertRow();
                    const timeMins = Math.floor(s.timeTaken / 60);
                    const timeSecs = s.timeTaken % 60;
                    row.innerHTML = `<td>${idx++}</td><td>${s.studentName}</td><td>${s.studentEmail}</td><td>${s.studentClass}</td><td>${new Date(s.submittedAt).toLocaleString()}</td><td><strong>${s.score}/2</strong></td><td>${timeMins}m ${timeSecs}s</td>`;
                });
            } catch (err) {
                console.error('Load submissions error:', err);
            }
        }
        
        async function loadQuizResults() {
            const today = getQuizToday();
            try {
                const snap = await db.ref(`quizSubmissions/${today}`).once('value');
                
                if (!snap.exists()) {
                    document.getElementById('resultTotalPart').textContent = '0';
                    document.getElementById('resultBothCorrect').textContent = '0';
                    document.getElementById('resultEligible').textContent = '0';
                    return;
                }
                
                let total = 0, correct = 0;
                snap.forEach(child => {
                    total++;
                    if (child.val().score === 2) correct++;
                });
                
                document.getElementById('resultTotalPart').textContent = total;
                document.getElementById('resultBothCorrect').textContent = correct;
                document.getElementById('resultEligible').textContent = correct;
                
                const resSnap = await db.ref(`quizResults/${today}`).once('value');
                if (resSnap.exists()) {
                    displayQuizWinners(resSnap.val());
                }
            } catch (err) {
                console.error('Load results error:', err);
            }
        }
        
        async function selectQuizWinners() {
            const today = getQuizToday();
            try {
                const snap = await db.ref(`quizSubmissions/${today}`).once('value');
                const eligible = [];
                snap.forEach(child => {
                    if (child.val().score === 2) eligible.push(child.val());
                });
                
                if (eligible.length === 0) {
                    showQuizMsg('quizAdminDashMessage', '‚ö†Ô∏è No correct answers yet!', 'warning');
                    return;
                }
                
                if (eligible.length === 1) {
                    showQuizMsg('quizAdminDashMessage', '‚ö†Ô∏è Only one correct. Need 2 for winner & runner-up.', 'warning');
                    return;
                }
                
                const shuffled = eligible.sort(() => 0.5 - Math.random());
                const winner = shuffled[0];
                const runnerUp = shuffled[1];
                
                const data = {
                    winner: {name: winner.studentName, email: winner.studentEmail, class: winner.studentClass, score: winner.score},
                    runnerUp: {name: runnerUp.studentName, email: runnerUp.studentEmail, class: runnerUp.studentClass, score: runnerUp.score},
                    declaredAt: new Date().toISOString(),
                    declaredBy: quizCurrentUser.email,
                    totalEligible: eligible.length
                };
                
                await db.ref(`quizResults/${today}`).set(data);
                
                // Try to send emails but don't block winner declaration
                try {
                    await sendQuizEmail(winner.studentEmail, 'üèÜ You Won Quiz!', `Dear ${winner.studentName},\n\nCongratulations! You are the WINNER!\n\nScore: ${winner.score}/2\nClass: ${winner.studentClass}\n\nDavan Institute`);
                } catch (e) { console.log('Winner email failed:', e); }
                
                try {
                    await sendQuizEmail(runnerUp.studentEmail, 'ü•à Runner-Up!', `Dear ${runnerUp.studentName},\n\nCongratulations! You are RUNNER-UP!\n\nScore: ${runnerUp.score}/2\nClass: ${runnerUp.studentClass}\n\nDavan Institute`);
                } catch (e) { console.log('Runner-up email failed:', e); }
                
                showQuizMsg('quizAdminDashMessage', '‚úÖ Winners selected & emails sent!', 'success');
                displayQuizWinners(data);
            } catch (err) {
                console.error('Select winners error:', err);
                showQuizMsg('quizAdminDashMessage', 'Error selecting winners.', 'error');
            }
        }
        
        function displayQuizWinners(data) {
            const div = document.getElementById('winnersDisplaySection');
            let html = '<div style="background:#f8f9fa;padding:25px;border-radius:12px">';
            html += '<h3 style="color:#667eea;margin-bottom:20px;text-align:center">üéâ Today\'s Winners</h3>';
            html += '<div style="background:linear-gradient(135deg,#ffd700 0%,#ffed4e 100%);padding:20px;border-radius:10px;margin-bottom:15px;color:#333">';
            html += '<h4 style="margin-bottom:10px">üèÜ WINNER</h4>';
            html += `<p><strong>Name:</strong> ${data.winner.name}</p>`;
            html += `<p><strong>Email:</strong> ${data.winner.email}</p>`;
            html += `<p><strong>Class:</strong> ${data.winner.class}</p>`;
            html += `<p><strong>Score:</strong> ${data.winner.score}/2</p></div>`;
            html += '<div style="background:linear-gradient(135deg,#c0c0c0 0%,#e8e8e8 100%);padding:20px;border-radius:10px;color:#333">';
            html += '<h4 style="margin-bottom:10px">ü•à RUNNER-UP</h4>';
            html += `<p><strong>Name:</strong> ${data.runnerUp.name}</p>`;
            html += `<p><strong>Email:</strong> ${data.runnerUp.email}</p>`;
            html += `<p><strong>Class:</strong> ${data.runnerUp.class}</p>`;
            html += `<p><strong>Score:</strong> ${data.runnerUp.score}/2</p></div>`;
            html += `<p style="text-align:center;margin-top:20px;color:#666"><small>Declared: ${new Date(data.declaredAt).toLocaleString()}</small></p></div>`;
            div.innerHTML = html;
            div.style.display = 'block';
        }
        
        // ========== INTEGRATED QUIZ MANAGEMENT FUNCTIONS ==========
        
        function showQuizManagementTab(tab, event) {
            document.querySelectorAll('#quizManagement .tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('#quizManagement .form-section').forEach(s => s.classList.remove('active'));
            
            // Only try to add active class to event target if event exists
            if (event && event.target) {
                event.target.classList.add('active');
            } else {
                // Programmatic call - find and activate the correct tab button
                const tabButtons = {
                    'questions': 0,
                    'allquizzes': 1,
                    'students': 2,
                    'submissions': 3,
                    'winners': 4,
                    'editdates': 5
                };
                const tabIndex = tabButtons[tab];
                if (tabIndex !== undefined) {
                    const tabs = document.querySelectorAll('#quizManagement .tab');
                    if (tabs[tabIndex]) {
                        tabs[tabIndex].classList.add('active');
                    }
                }
            }
            
            if (tab === 'questions') {
                document.getElementById('quizQuestionsContent').classList.add('active');
            } else if (tab === 'allquizzes') {
                document.getElementById('quizAllQuizzesContent').classList.add('active');
                loadAllQuizzes();
            } else if (tab === 'students') {
                document.getElementById('quizStudentsContent').classList.add('active');
                loadQuizStudentsAdmin();
            } else if (tab === 'submissions') {
                document.getElementById('quizSubmissionsContent').classList.add('active');
                loadQuizSubmissionsAdmin();
            } else if (tab === 'winners') {
                document.getElementById('quizWinnersContent').classList.add('active');
                loadQuizResultsAdmin();
                // Init auto-declaration toggle state
                if (typeof initAutoDeclarScheduler === 'function') initAutoDeclarScheduler();
            } else if (tab === 'editdates') {
                document.getElementById('quizEditDatesContent').classList.add('active');
                loadQuizzesForDateEdit();
            }
        }
        
        // Function to load quiz questions for the selected date
        async function loadQuizForSelectedDate() {
            const selectedDate = document.getElementById('quizDateSelector').value;
            if (!selectedDate) {
                return;
            }
            
            console.log('Loading quiz for date:', selectedDate);
            
            // Update heading
            const dateObj = new Date(selectedDate + 'T00:00:00');
            const dateStr = dateObj.toLocaleDateString('en-IN', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
            document.getElementById('quizQuestionsHeading').textContent = `Create Quiz for ${dateStr} (2 Questions)`;
            
            try {
                const snapshot = await db.ref(`quizQuestions/${selectedDate}`).once('value');
                
                if (snapshot.exists()) {
                    const data = snapshot.val();
                    console.log('Found existing quiz:', data);
                    
                    // Populate form with existing data
                    document.getElementById('quiz_q1Text').value = data.q1.text || '';
                    document.getElementById('quiz_q1OptA').value = data.q1.options.A || '';
                    document.getElementById('quiz_q1OptB').value = data.q1.options.B || '';
                    document.getElementById('quiz_q1OptC').value = data.q1.options.C || '';
                    document.getElementById('quiz_q1OptD').value = data.q1.options.D || '';
                    document.getElementById('quiz_q1Correct').value = data.q1.correct || '';
                    
                    document.getElementById('quiz_q2Text').value = data.q2.text || '';
                    document.getElementById('quiz_q2OptA').value = data.q2.options.A || '';
                    document.getElementById('quiz_q2OptB').value = data.q2.options.B || '';
                    document.getElementById('quiz_q2OptC').value = data.q2.options.C || '';
                    document.getElementById('quiz_q2OptD').value = data.q2.options.D || '';
                    document.getElementById('quiz_q2Correct').value = data.q2.correct || '';
                    
                    showQuizMsg('quizAdminMessage', `‚úèÔ∏è Editing existing quiz for ${selectedDate}. Modify and save to update.`, 'success');
                    // Don't show preview on initial load - only after save
                    // displaySavedQuestionsPreview(data);
                } else {
                    console.log('No quiz found for this date, clearing form');
                    
                    // Clear form for new quiz
                    ['quiz_q1Text','quiz_q1OptA','quiz_q1OptB','quiz_q1OptC','quiz_q1OptD','quiz_q1Correct','quiz_q2Text','quiz_q2OptA','quiz_q2OptB','quiz_q2OptC','quiz_q2OptD','quiz_q2Correct'].forEach(id => {
                        const el = document.getElementById(id);
                        if (el) el.value = '';
                    });
                    
                    document.getElementById('todayQuestionsViewAdmin').innerHTML = '';
                    document.getElementById('todayQuestionsViewAdmin').style.display = 'none';
                    
                    showQuizMsg('quizAdminMessage', `üìù No quiz exists for ${selectedDate}. Create a new one below.`, 'error');
                }
            } catch (err) {
                console.error('Error loading quiz:', err);
                showQuizMsg('quizAdminMessage', 'Error loading quiz: ' + err.message, 'error');
            }
        }
        
        // Initialize date selector with today's date when page loads
        function initializeDateSelector() {
            const dateInput = document.getElementById('quizDateSelector');
            if (dateInput) {
                const today = getQuizToday();
                dateInput.value = today;
                loadQuizForSelectedDate();
            }
        }
        
        async function loadQuizManagementStats() {
            try {
                const studSnap = await db.ref('quizStudents').once('value');
                document.getElementById('quizTotalStudents').textContent = studSnap.numChildren();
                
                const today = getQuizToday();
                const subSnap = await db.ref(`quizSubmissions/${today}`).once('value');
                document.getElementById('quizTodayParticipants').textContent = subSnap.numChildren();
                
                const qSnap = await db.ref(`quizQuestions/${today}`).once('value');
                document.getElementById('quizQuestionsCount').textContent = qSnap.exists() ? 2 : 0;
            } catch (err) {
                console.error('Load quiz stats error:', err);
            }
        }
        
        async function loadAllQuizzes() {
            const container = document.getElementById('allQuizzesContainer');
            container.innerHTML = '<p style="text-align:center;color:#666">Loading all quizzes...</p>';
            
            try {
                const quizzesSnap = await db.ref('quizQuestions').once('value');
                
                if (!quizzesSnap.exists()) {
                    container.innerHTML = '<div style="background:#fff3cd;padding:20px;border-radius:8px;text-align:center"><p style="margin:0;color:#856404">No quizzes found in database.</p></div>';
                    return;
                }
                
                // Get all quiz dates and sort them (newest first)
                const quizzes = [];
                quizzesSnap.forEach(child => {
                    quizzes.push({
                        date: child.key,
                        data: child.val()
                    });
                });
                
                quizzes.sort((a, b) => new Date(b.date) - new Date(a.date));
                
                // Get publish statuses
                const publishedSnap = await db.ref('quizPublished').once('value');
                const publishedData = publishedSnap.val() || {};
                
                let html = '';
                
                for (const quiz of quizzes) {
                    const dateObj = new Date(quiz.date);
                    const dateStr = dateObj.toLocaleDateString('en-IN', {
                        weekday: 'long',
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric'
                    });
                    
                    const isPublished = publishedData[quiz.date] && publishedData[quiz.date].published === true;
                    const publishInfo = publishedData[quiz.date];
                    
                    html += '<div style="background:white;padding:20px;border-radius:10px;margin-bottom:20px;border-left:5px solid ' + (isPublished ? '#4CAF50' : '#667eea') + '">';
                    html += '<div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:15px">';
                    html += '<div>';
                    html += '<h4 style="color:#667eea;margin:0 0 5px 0">üìÖ ' + dateStr + '</h4>';
                    html += '<p style="margin:0;font-size:0.9em;color:#666">Date: ' + quiz.date + '</p>';
                    if (publishInfo) {
                        if (isPublished) {
                            html += '<p style="margin:5px 0 0 0;font-size:0.85em;color:#4CAF50;font-weight:600">‚úÖ PUBLISHED on ' + new Date(publishInfo.publishedAt).toLocaleString() + '</p>';
                        } else {
                            html += '<p style="margin:5px 0 0 0;font-size:0.85em;color:#ff9800;font-weight:600">‚ö†Ô∏è UNPUBLISHED</p>';
                        }
                    } else {
                        html += '<p style="margin:5px 0 0 0;font-size:0.85em;color:#999">Not yet published</p>';
                    }
                    html += '</div>';
                    html += '<div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">';
                    html += '<button class="btn btn-info btn-small" onclick="editQuizByDate(\'' + quiz.date + '\')" style="background:#2196F3;font-weight:600">‚úèÔ∏è Edit</button>';
                    html += '<button class="btn btn-danger btn-small" onclick="deleteQuizByDate(\'' + quiz.date + '\')" style="font-weight:600">üóëÔ∏è Delete</button>';
                    if (isPublished) {
                        html += '<button class="btn btn-small" onclick="unpublishQuizByDate(\'' + quiz.date + '\')" style="background:#ff9800;color:white;font-weight:600">‚ùå Unpublish</button>';
                    } else {
                        html += '<button class="btn btn-success btn-small" onclick="publishQuizByDate(\'' + quiz.date + '\')" style="font-weight:600">‚úÖ Publish</button>';
                    }
                    html += '</div>';
                    html += '</div>';
                    
                    html += '<div style="background:#f8f9fa;padding:15px;border-radius:8px">';
                    html += '<p style="margin:0 0 10px 0;font-weight:600">Question 1:</p>';
                    
                    // Show image if present
                    if (quiz.data.q1.image) {
                        html += '<div style="text-align:center;margin:10px 0"><img src="' + quiz.data.q1.image + '" style="max-width:100%;max-height:200px;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,0.1)"></div>';
                    }
                    
                    // Show audio if present
                    if (quiz.data.q1.audio) {
                        html += '<div style="margin:10px 0;background:#e8f5e9;padding:10px;border-radius:6px"><p style="margin:0 0 5px 0;font-size:0.9em;color:#2e7d32">üéµ Audio attached</p><audio controls style="width:100%;max-width:300px"><source src="' + quiz.data.q1.audio + '"></audio></div>';
                    }
                    
                    html += '<p style="margin:0 0 10px 0">' + quiz.data.q1.text + '</p>';
                    html += '<p style="margin:0;color:#4CAF50;font-weight:600">‚úÖ Correct: ' + quiz.data.q1.options[quiz.data.q1.correct] + '</p>';
                    html += '</div>';
                    
                    html += '<div style="background:#f8f9fa;padding:15px;border-radius:8px;margin-top:10px">';
                    html += '<p style="margin:0 0 10px 0;font-weight:600">Question 2:</p>';
                    
                    // Show image if present
                    if (quiz.data.q2.image) {
                        html += '<div style="text-align:center;margin:10px 0"><img src="' + quiz.data.q2.image + '" style="max-width:100%;max-height:200px;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,0.1)"></div>';
                    }
                    
                    // Show audio if present
                    if (quiz.data.q2.audio) {
                        html += '<div style="margin:10px 0;background:#e8f5e9;padding:10px;border-radius:6px"><p style="margin:0 0 5px 0;font-size:0.9em;color:#2e7d32">üéµ Audio attached</p><audio controls style="width:100%;max-width:300px"><source src="' + quiz.data.q2.audio + '"></audio></div>';
                    }
                    
                    html += '<p style="margin:0 0 10px 0">' + quiz.data.q2.text + '</p>';
                    html += '<p style="margin:0;color:#4CAF50;font-weight:600">‚úÖ Correct: ' + quiz.data.q2.options[quiz.data.q2.correct] + '</p>';
                    html += '</div>';
                    
                    html += '</div>';
                }
                
                container.innerHTML = html;
                
            } catch (err) {
                console.error('Load all quizzes error:', err);
                container.innerHTML = '<div style="background:#f8d7da;padding:20px;border-radius:8px;text-align:center"><p style="margin:0;color:#721c24">Error loading quizzes: ' + err.message + '</p></div>';
            }
        }
        
        async function publishQuizByDate(date) {
            if (!confirm(`Publish quiz for ${date}?\n\nThis will show the questions and answers publicly for educational review.`)) return;
            
            try {
                await db.ref(`quizPublished/${date}`).set({
                    published: true,
                    publishedAt: new Date().toISOString(),
                    publishedBy: 'Super Admin'
                });
                
                alert('‚úÖ Quiz published successfully!');
                loadAllQuizzes();
            } catch (err) {
                console.error('Publish error:', err);
                alert('‚ùå Error publishing quiz: ' + err.message);
            }
        }
        
        async function unpublishQuizByDate(date) {
            if (!confirm(`Unpublish quiz for ${date}?\n\nThis will hide the answers from public view.`)) return;
            
            try {
                await db.ref(`quizPublished/${date}`).set({
                    published: false,
                    unpublishedAt: new Date().toISOString(),
                    unpublishedBy: 'Super Admin'
                });
                
                alert('‚úÖ Quiz unpublished successfully!');
                loadAllQuizzes();
            } catch (err) {
                console.error('Unpublish error:', err);
                alert('‚ùå Error unpublishing quiz: ' + err.message);
            }
        }
        
        function removeExistingMedia(question, type) {
            const previewId = `quiz_${question}${type === 'image' ? 'Image' : 'Audio'}Preview`;
            const confirmMsg = `Remove this ${type} from Question ${question === 'q1' ? '1' : '2'}?`;
            
            if (confirm(confirmMsg)) {
                // Mark for deletion
                if (question === 'q1' && type === 'image') {
                    window.editingQuizData.deleteQ1Image = true;
                } else if (question === 'q1' && type === 'audio') {
                    window.editingQuizData.deleteQ1Audio = true;
                } else if (question === 'q2' && type === 'image') {
                    window.editingQuizData.deleteQ2Image = true;
                } else if (question === 'q2' && type === 'audio') {
                    window.editingQuizData.deleteQ2Audio = true;
                }
                
                // Clear the preview
                document.getElementById(previewId).innerHTML = `<p style="color:#28a745;font-weight:600">‚úì ${type.charAt(0).toUpperCase() + type.slice(1)} will be removed when you save</p>`;
            }
        }
        
        async function editQuizByDate(date) {
            try {
                // Load the quiz data
                const snap = await db.ref(`quizQuestions/${date}`).once('value');
                const quizData = snap.val();
                
                if (!quizData) {
                    alert('‚ùå Quiz not found!');
                    return;
                }
                
                // Switch to Questions tab
                showQuizManagementTab('questions');
                
                // Set the date selector
                document.getElementById('quizDateSelector').value = date;
                
                // Populate the form with existing data
                document.getElementById('quiz_q1Text').value = (quizData.q1 && quizData.q1.text) || '';
                document.getElementById('quiz_q1OptA').value = (quizData.q1 && quizData.q1.options && quizData.q1.options.A) || '';
                document.getElementById('quiz_q1OptB').value = (quizData.q1 && quizData.q1.options && quizData.q1.options.B) || '';
                document.getElementById('quiz_q1OptC').value = (quizData.q1 && quizData.q1.options && quizData.q1.options.C) || '';
                document.getElementById('quiz_q1OptD').value = (quizData.q1 && quizData.q1.options && quizData.q1.options.D) || '';
                document.getElementById('quiz_q1Correct').value = (quizData.q1 && quizData.q1.correct) || '';
                
                document.getElementById('quiz_q2Text').value = (quizData.q2 && quizData.q2.text) || '';
                document.getElementById('quiz_q2OptA').value = (quizData.q2 && quizData.q2.options && quizData.q2.options.A) || '';
                document.getElementById('quiz_q2OptB').value = (quizData.q2 && quizData.q2.options && quizData.q2.options.B) || '';
                document.getElementById('quiz_q2OptC').value = (quizData.q2 && quizData.q2.options && quizData.q2.options.C) || '';
                document.getElementById('quiz_q2OptD').value = (quizData.q2 && quizData.q2.options && quizData.q2.options.D) || '';
                document.getElementById('quiz_q2Correct').value = (quizData.q2 && quizData.q2.correct) || '';
                
                // Clear previous previews
                document.getElementById('quiz_q1ImagePreview').innerHTML = '';
                document.getElementById('quiz_q1AudioPreview').innerHTML = '';
                document.getElementById('quiz_q2ImagePreview').innerHTML = '';
                document.getElementById('quiz_q2AudioPreview').innerHTML = '';
                
                // Store existing media in global variables for deletion tracking
                window.editingQuizData = {
                    q1Image: (quizData.q1 && quizData.q1.image) || null,
                    q1Audio: (quizData.q1 && quizData.q1.audio) || null,
                    q2Image: (quizData.q2 && quizData.q2.image) || null,
                    q2Audio: (quizData.q2 && quizData.q2.audio) || null,
                    deleteQ1Image: false,
                    deleteQ1Audio: false,
                    deleteQ2Image: false,
                    deleteQ2Audio: false
                };
                
                // Show image previews if images exist
                if (quizData.q1 && quizData.q1.image) {
                    document.getElementById('quiz_q1ImagePreview').innerHTML = `
                        <div style="position:relative;display:inline-block">
                            <img src="${quizData.q1.image}" style="max-width:300px;max-height:200px;border-radius:8px;box-shadow:0 4px 10px rgba(0,0,0,0.1)">
                            <p style="margin-top:5px;color:#666;font-size:0.9em">Current image</p>
                            <button type="button" class="btn btn-danger btn-small" onclick="removeExistingMedia('q1', 'image')" style="margin-top:5px">üóëÔ∏è Remove Image</button>
                            <p style="margin-top:5px;color:#999;font-size:0.85em">Or upload a new one below to replace it</p>
                        </div>
                    `;
                }
                
                if (quizData.q2 && quizData.q2.image) {
                    document.getElementById('quiz_q2ImagePreview').innerHTML = `
                        <div style="position:relative;display:inline-block">
                            <img src="${quizData.q2.image}" style="max-width:300px;max-height:200px;border-radius:8px;box-shadow:0 4px 10px rgba(0,0,0,0.1)">
                            <p style="margin-top:5px;color:#666;font-size:0.9em">Current image</p>
                            <button type="button" class="btn btn-danger btn-small" onclick="removeExistingMedia('q2', 'image')" style="margin-top:5px">üóëÔ∏è Remove Image</button>
                            <p style="margin-top:5px;color:#999;font-size:0.85em">Or upload a new one below to replace it</p>
                        </div>
                    `;
                }
                
                // Show audio previews if audio exists
                if (quizData.q1 && quizData.q1.audio) {
                    document.getElementById('quiz_q1AudioPreview').innerHTML = `
                        <div style="background:#f0f0f0;padding:15px;border-radius:8px;display:inline-block">
                            <p style="margin:0 0 5px 0;color:#666;font-size:0.9em">Current audio</p>
                            <audio controls style="max-width:300px">
                                <source src="${quizData.q1.audio}">
                            </audio>
                            <div style="margin-top:10px">
                                <button type="button" class="btn btn-danger btn-small" onclick="removeExistingMedia('q1', 'audio')">üóëÔ∏è Remove Audio</button>
                            </div>
                            <p style="margin-top:5px;color:#999;font-size:0.85em">Or upload a new one below to replace it</p>
                        </div>
                    `;
                }
                
                if (quizData.q2 && quizData.q2.audio) {
                    document.getElementById('quiz_q2AudioPreview').innerHTML = `
                        <div style="background:#f0f0f0;padding:15px;border-radius:8px;display:inline-block">
                            <p style="margin:0 0 5px 0;color:#666;font-size:0.9em">Current audio</p>
                            <audio controls style="max-width:300px">
                                <source src="${quizData.q2.audio}">
                            </audio>
                            <div style="margin-top:10px">
                                <button type="button" class="btn btn-danger btn-small" onclick="removeExistingMedia('q2', 'audio')">üóëÔ∏è Remove Audio</button>
                            </div>
                            <p style="margin-top:5px;color:#999;font-size:0.85em">Or upload a new one below to replace it</p>
                        </div>
                    `;
                }
                
                // Update the heading
                const dateObj = new Date(date);
                const dateStr = dateObj.toLocaleDateString('en-IN', {
                    weekday: 'long',
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
                document.getElementById('quizQuestionsHeading').textContent = `Edit Quiz for ${dateStr} (2 Questions)`;
                
                // Show success message
                showQuizMsg('quizAdminMessage', `‚úèÔ∏è Editing quiz for ${date}. Make your changes and click Save.`, 'success');
                
                // Scroll to top
                window.scrollTo({ top: 0, behavior: 'smooth' });
                
            } catch (err) {
                console.error('Edit quiz error:', err);
                alert('‚ùå Error loading quiz for editing: ' + err.message);
            }
        }
        
        async function deleteQuizByDate(date) {
            if (!confirm(`‚ö†Ô∏è DELETE QUIZ FOR ${date}?\n\nThis will permanently delete:\n- Questions\n- All submissions\n- Results\n- Publish status\n\nThis action CANNOT be undone!\n\nAre you sure?`)) return;
            
            // Double confirmation for safety
            if (!confirm(`FINAL CONFIRMATION\n\nYou are about to permanently delete the quiz for ${date}.\n\nType YES in the next prompt to confirm.`)) return;
            
            const confirmation = prompt('Type YES (in capital letters) to confirm deletion:');
            if (confirmation !== 'YES') {
                alert('Deletion cancelled.');
                return;
            }
            
            try {
                // Delete all related data
                await Promise.all([
                    db.ref(`quizQuestions/${date}`).remove(),
                    db.ref(`quizSubmissions/${date}`).remove(),
                    db.ref(`quizResults/${date}`).remove(),
                    db.ref(`quizPublished/${date}`).remove()
                ]);
                
                alert('‚úÖ Quiz deleted successfully!');
                loadAllQuizzes();
            } catch (err) {
                console.error('Delete error:', err);
                alert('‚ùå Error deleting quiz: ' + err.message);
            }
        }
        
        async function saveQuizQuestionsFromAdmin() {
            // Get selected date
            const selectedDate = document.getElementById('quizDateSelector').value;
            if (!selectedDate) {
                alert('‚ö†Ô∏è Please select a date first!');
                showQuizMsg('quizAdminMessage', '‚ö†Ô∏è Please select a date first!', 'error');
                return;
            }
            
            const q1Text = document.getElementById('quiz_q1Text').value.trim();
            const q1OptA = document.getElementById('quiz_q1OptA').value.trim();
            const q1OptB = document.getElementById('quiz_q1OptB').value.trim();
            const q1OptC = document.getElementById('quiz_q1OptC').value.trim();
            const q1OptD = document.getElementById('quiz_q1OptD').value.trim();
            const q1Correct = document.getElementById('quiz_q1Correct').value;
            
            const q2Text = document.getElementById('quiz_q2Text').value.trim();
            const q2OptA = document.getElementById('quiz_q2OptA').value.trim();
            const q2OptB = document.getElementById('quiz_q2OptB').value.trim();
            const q2OptC = document.getElementById('quiz_q2OptC').value.trim();
            const q2OptD = document.getElementById('quiz_q2OptD').value.trim();
            const q2Correct = document.getElementById('quiz_q2Correct').value;
            
            console.log('Saving questions for date:', selectedDate, {q1Text, q1Correct, q2Text, q2Correct});
            
            if (!q1Text || !q1OptA || !q1OptB || !q1OptC || !q1OptD || !q1Correct) {
                alert('‚ö†Ô∏è Please fill all Question 1 fields!');
                showQuizMsg('quizAdminMessage', '‚ö†Ô∏è Fill all Question 1 fields!', 'error');
                return;
            }
            
            if (!q2Text || !q2OptA || !q2OptB || !q2OptC || !q2OptD || !q2Correct) {
                alert('‚ö†Ô∏è Please fill all Question 2 fields!');
                showQuizMsg('quizAdminMessage', '‚ö†Ô∏è Fill all Question 2 fields!', 'error');
                return;
            }
            
            // Get image and audio files
            const q1ImageFile = document.getElementById('quiz_q1Image').files[0];
            const q1AudioFile = document.getElementById('quiz_q1Audio').files[0];
            const q2ImageFile = document.getElementById('quiz_q2Image').files[0];
            const q2AudioFile = document.getElementById('quiz_q2Audio').files[0];
            
            const data = {
                q1: {
                    text: q1Text, 
                    options: {A:q1OptA, B:q1OptB, C:q1OptC, D:q1OptD}, 
                    correct: q1Correct
                },
                q2: {
                    text: q2Text, 
                    options: {A:q2OptA, B:q2OptB, C:q2OptC, D:q2OptD}, 
                    correct: q2Correct
                },
                createdAt: new Date().toISOString(),
                createdBy: 'Super Admin',
                quizDate: selectedDate
            };
            
            try {
                // Check if editing existing quiz (to preserve media if not replaced)
                const existingSnap = await db.ref(`quizQuestions/${selectedDate}`).once('value');
                const existingData = existingSnap.val();
                
                // Check if we're in edit mode with deletion tracking
                const editData = window.editingQuizData || {};
                
                // Convert images and audio to base64 if present, otherwise preserve existing (unless marked for deletion)
                if (q1ImageFile) {
                    data.q1.image = await fileToBase64(q1ImageFile);
                } else if (existingData && existingData.q1 && existingData.q1.image && !editData.deleteQ1Image) {
                    data.q1.image = existingData.q1.image; // Preserve existing image
                }
                // If deleteQ1Image is true, we simply don't add the image property
                
                if (q1AudioFile) {
                    data.q1.audio = await fileToBase64(q1AudioFile);
                } else if (existingData && existingData.q1 && existingData.q1.audio && !editData.deleteQ1Audio) {
                    data.q1.audio = existingData.q1.audio; // Preserve existing audio
                }
                
                if (q2ImageFile) {
                    data.q2.image = await fileToBase64(q2ImageFile);
                } else if (existingData && existingData.q2 && existingData.q2.image && !editData.deleteQ2Image) {
                    data.q2.image = existingData.q2.image; // Preserve existing image
                }
                
                if (q2AudioFile) {
                    data.q2.audio = await fileToBase64(q2AudioFile);
                } else if (existingData && existingData.q2 && existingData.q2.audio && !editData.deleteQ2Audio) {
                    data.q2.audio = existingData.q2.audio; // Preserve existing audio
                }
                
                // Clear editing data after save
                window.editingQuizData = null;
                
                console.log('Attempting to save to Firebase...', data);
                await db.ref(`quizQuestions/${selectedDate}`).set(data);
                
                // SUCCESS POPUP!
                alert(`‚úÖ Questions Saved Successfully for ${selectedDate}!\n\nThe quiz will be automatically available to students on this date.\n\nQuestions preview will be shown below.`);
                
                showQuizMsg('quizAdminMessage', `‚úÖ Questions saved successfully for ${selectedDate} with media! Preview shown below.`, 'success');
                
                // Automatically show the questions preview
                displaySavedQuestionsPreview(data);
                
                // Clear form
                ['quiz_q1Text','quiz_q1OptA','quiz_q1OptB','quiz_q1OptC','quiz_q1OptD','quiz_q1Correct','quiz_q2Text','quiz_q2OptA','quiz_q2OptB','quiz_q2OptC','quiz_q2OptD','quiz_q2Correct'].forEach(id => {
                    const el = document.getElementById(id);
                    if (el) el.value = '';
                });
                ['quiz_q1Image','quiz_q1Audio','quiz_q2Image','quiz_q2Audio'].forEach(id => {
                    const el = document.getElementById(id);
                    if (el) el.value = '';
                });
                ['quiz_q1ImagePreview','quiz_q1AudioPreview','quiz_q2ImagePreview','quiz_q2AudioPreview'].forEach(id => {
                    const el = document.getElementById(id);
                    if (el) el.innerHTML = '';
                });
                
                await loadQuizManagementStats();
                console.log('Questions saved successfully for date:', selectedDate);
            } catch (err) {
                console.error('Save error:', err);
                alert('‚ùå Error saving questions: ' + err.message);
                showQuizMsg('quizAdminMessage', 'Error saving questions: ' + err.message, 'error');
            }
        }
        
        function displaySavedQuestionsPreview(data) {
            const view = document.getElementById('todayQuestionsViewAdmin');
            
            const createdDate = new Date(data.createdAt);
            const dateStr = createdDate.toLocaleDateString('en-IN', { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
            const timeStr = createdDate.toLocaleTimeString('en-IN', { 
                hour: '2-digit', 
                minute: '2-digit',
                second: '2-digit'
            });
            
            let html = '<div style="background:#f8f9fa;padding:25px;border-radius:10px;margin-top:20px;border:3px solid #28a745">';
            html += '<h3 style="color:#28a745;margin-bottom:10px;text-align:center">‚úÖ Questions Saved Successfully - Preview</h3>';
            html += `<p style="text-align:center;color:#666;font-size:0.95em;margin-bottom:20px">üìÖ ${dateStr} | ‚è∞ ${timeStr}</p>`;
            
            // Question 1
            html += '<div style="background:white;padding:20px;border-radius:8px;margin-bottom:20px;border-left:5px solid #667eea">';
            html += '<h4 style="color:#667eea;margin-bottom:15px">üìù Question 1</h4>';
            
            // Show image if present
            if (data.q1.image) {
                html += '<div style="text-align:center;margin:15px 0"><img src="' + data.q1.image + '" style="max-width:100%;max-height:250px;border-radius:8px;box-shadow:0 4px 12px rgba(0,0,0,0.15)"></div>';
            }
            
            // Show audio if present
            if (data.q1.audio) {
                html += '<div style="margin:15px 0;background:#e8f5e9;padding:15px;border-radius:8px"><p style="margin:0 0 8px 0;font-weight:600;color:#2e7d32">üéµ Audio Question</p><audio controls style="width:100%;max-width:400px"><source src="' + data.q1.audio + '"></audio></div>';
            }
            
            html += `<p style="font-size:1.1em;font-weight:600;margin-bottom:15px">${data.q1.text}</p>`;
            html += `<p style="margin-left:20px;padding:8px;background:${data.q1.correct === 'A' ? '#d4edda' : '#f8f9fa'};border-radius:4px">A) ${data.q1.options.A} ${data.q1.correct === 'A' ? '‚úÖ' : ''}</p>`;
            html += `<p style="margin-left:20px;padding:8px;background:${data.q1.correct === 'B' ? '#d4edda' : '#f8f9fa'};border-radius:4px">B) ${data.q1.options.B} ${data.q1.correct === 'B' ? '‚úÖ' : ''}</p>`;
            html += `<p style="margin-left:20px;padding:8px;background:${data.q1.correct === 'C' ? '#d4edda' : '#f8f9fa'};border-radius:4px">C) ${data.q1.options.C} ${data.q1.correct === 'C' ? '‚úÖ' : ''}</p>`;
            html += `<p style="margin-left:20px;padding:8px;background:${data.q1.correct === 'D' ? '#d4edda' : '#f8f9fa'};border-radius:4px">D) ${data.q1.options.D} ${data.q1.correct === 'D' ? '‚úÖ' : ''}</p>`;
            html += `<p style="color:#28a745;font-weight:bold;margin-top:15px;font-size:1.1em">‚úì Correct Answer: ${data.q1.correct}</p>`;
            html += '</div>';
            
            // Question 2
            html += '<div style="background:white;padding:20px;border-radius:8px;border-left:5px solid #667eea">';
            html += '<h4 style="color:#667eea;margin-bottom:15px">üìù Question 2</h4>';
            
            // Show image if present
            if (data.q2.image) {
                html += '<div style="text-align:center;margin:15px 0"><img src="' + data.q2.image + '" style="max-width:100%;max-height:250px;border-radius:8px;box-shadow:0 4px 12px rgba(0,0,0,0.15)"></div>';
            }
            
            // Show audio if present
            if (data.q2.audio) {
                html += '<div style="margin:15px 0;background:#e8f5e9;padding:15px;border-radius:8px"><p style="margin:0 0 8px 0;font-weight:600;color:#2e7d32">üéµ Audio Question</p><audio controls style="width:100%;max-width:400px"><source src="' + data.q2.audio + '"></audio></div>';
            }
            
            html += `<p style="font-size:1.1em;font-weight:600;margin-bottom:15px">${data.q2.text}</p>`;
            html += `<p style="margin-left:20px;padding:8px;background:${data.q2.correct === 'A' ? '#d4edda' : '#f8f9fa'};border-radius:4px">A) ${data.q2.options.A} ${data.q2.correct === 'A' ? '‚úÖ' : ''}</p>`;
            html += `<p style="margin-left:20px;padding:8px;background:${data.q2.correct === 'B' ? '#d4edda' : '#f8f9fa'};border-radius:4px">B) ${data.q2.options.B} ${data.q2.correct === 'B' ? '‚úÖ' : ''}</p>`;
            html += `<p style="margin-left:20px;padding:8px;background:${data.q2.correct === 'C' ? '#d4edda' : '#f8f9fa'};border-radius:4px">C) ${data.q2.options.C} ${data.q2.correct === 'C' ? '‚úÖ' : ''}</p>`;
            html += `<p style="margin-left:20px;padding:8px;background:${data.q2.correct === 'D' ? '#d4edda' : '#f8f9fa'};border-radius:4px">D) ${data.q2.options.D} ${data.q2.correct === 'D' ? '‚úÖ' : ''}</p>`;
            html += `<p style="color:#28a745;font-weight:bold;margin-top:15px;font-size:1.1em">‚úì Correct Answer: ${data.q2.correct}</p>`;
            html += '</div>';
            
            html += `<p style="text-align:center;margin-top:20px;color:#666"><small>Created by: ${data.createdBy || 'Super Admin'}</small></p>`;
            html += '</div>';
            
            view.innerHTML = html;
            view.style.display = 'block';
            
            // Removed scroll - no automatic scrolling to preview
        }
        
        async function viewTodayQuestionsAdmin() {
            const today = getQuizToday();
            try {
                const snap = await db.ref(`quizQuestions/${today}`).once('value');
                const q = snap.val();
                const view = document.getElementById('todayQuestionsViewAdmin');
                
                if (!q) {
                    view.innerHTML = '<div style="background:#fff3cd;padding:15px;border-radius:8px"><p style="margin:0;color:#856404">No questions for today yet.</p></div>';
                    view.style.display = 'block';
                    return;
                }
                
                const createdDate = new Date(q.createdAt);
                const dateStr = createdDate.toLocaleDateString('en-IN', { 
                    weekday: 'long', 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric' 
                });
                const timeStr = createdDate.toLocaleTimeString('en-IN', { 
                    hour: '2-digit', 
                    minute: '2-digit',
                    second: '2-digit'
                });
                
                let html = '<div style="background:#f8f9fa;padding:20px;border-radius:10px">';
                html += '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:15px">';
                html += '<h4 style="color:#667eea;margin:0">Today\'s Questions</h4>';
                html += '<button class="btn btn-small" onclick="editTodayQuestions()" style="background:#ff9800;color:white">‚úèÔ∏è Edit Questions</button>';
                html += '</div>';
                html += `<p style="color:#666;font-size:0.95em;margin-bottom:15px">üìÖ ${dateStr} | ‚è∞ ${timeStr}</p>`;
                html += `<p><strong>Q1:</strong> ${q.q1.text}</p>`;
                html += `<p style="margin-left:20px">A) ${q.q1.options.A}</p>`;
                html += `<p style="margin-left:20px">B) ${q.q1.options.B}</p>`;
                html += `<p style="margin-left:20px">C) ${q.q1.options.C}</p>`;
                html += `<p style="margin-left:20px">D) ${q.q1.options.D}</p>`;
                html += `<p style="color:green;font-weight:bold;margin-left:20px">‚úì Correct: ${q.q1.correct}</p><br>`;
                html += `<p><strong>Q2:</strong> ${q.q2.text}</p>`;
                html += `<p style="margin-left:20px">A) ${q.q2.options.A}</p>`;
                html += `<p style="margin-left:20px">B) ${q.q2.options.B}</p>`;
                html += `<p style="margin-left:20px">C) ${q.q2.options.C}</p>`;
                html += `<p style="margin-left:20px">D) ${q.q2.options.D}</p>`;
                html += `<p style="color:green;font-weight:bold;margin-left:20px">‚úì Correct: ${q.q2.correct}</p>`;
                html += `<p style="text-align:center;margin-top:15px;color:#666"><small>Created by: ${q.createdBy || 'Super Admin'}</small></p>`;
                html += '</div>';
                
                view.innerHTML = html;
                view.style.display = 'block';
                
                // Check and show publish status
                await checkPublishStatusForAdmin();
            } catch (err) {
                console.error('View error:', err);
            }
        }
        
        async function editTodayQuestions() {
            const today = getQuizToday();
            try {
                const snap = await db.ref(`quizQuestions/${today}`).once('value');
                const q = snap.val();
                
                if (!q) {
                    alert('No questions found to edit!');
                    return;
                }
                
                // Populate the form with existing data
                document.getElementById('quiz_q1Text').value = q.q1.text;
                document.getElementById('quiz_q1OptA').value = q.q1.options.A;
                document.getElementById('quiz_q1OptB').value = q.q1.options.B;
                document.getElementById('quiz_q1OptC').value = q.q1.options.C;
                document.getElementById('quiz_q1OptD').value = q.q1.options.D;
                document.getElementById('quiz_q1Correct').value = q.q1.correct;
                
                document.getElementById('quiz_q2Text').value = q.q2.text;
                document.getElementById('quiz_q2OptA').value = q.q2.options.A;
                document.getElementById('quiz_q2OptB').value = q.q2.options.B;
                document.getElementById('quiz_q2OptC').value = q.q2.options.C;
                document.getElementById('quiz_q2OptD').value = q.q2.options.D;
                document.getElementById('quiz_q2Correct').value = q.q2.correct;
                
                // Scroll to top instead of form center
                window.scrollTo({ top: 0, behavior: 'smooth' });
                
                // Show message
                showQuizMsg('quizAdminMessage', '‚úèÔ∏è Questions loaded for editing. Make changes and click Save.', 'success');
                
            } catch (err) {
                console.error('Edit error:', err);
                alert('Error loading questions for editing: ' + err.message);
            }
        }
        
        async function loadQuizStudentsAdmin() {
            try {
                const snap = await db.ref('quizStudents').once('value');
                const tbody = document.getElementById('quizStudentsTableAdmin');
                tbody.innerHTML = '';
                
                if (!snap.exists()) {
                    tbody.innerHTML = '<tr><td colspan="7" style="text-align:center">No students registered yet.</td></tr>';
                    return;
                }
                
                let idx = 1;
                snap.forEach(child => {
                    const s = child.val();
                    const row = tbody.insertRow();
                    row.innerHTML = `<td>${idx++}</td><td>${s.name}</td><td>${s.email}</td><td>${s.phone}</td><td style="background:#fff3cd;font-family:monospace;font-weight:bold">${s.password}</td><td>${s.class}</td><td>${new Date(s.registeredAt).toLocaleDateString()}</td>`;
                });
            } catch (err) {
                console.error('Load students error:', err);
            }
        }
        
        async function loadQuizSubmissionsAdmin() {
            const today = getQuizToday();
            try {
                const snap = await db.ref(`quizSubmissions/${today}`).once('value');
                const tbody = document.getElementById('quizSubmissionsTableAdmin');
                tbody.innerHTML = '';

                // Populate class filter dropdown
                const classSet = new Set();
                const allRows = [];
                if (snap.exists()) {
                    snap.forEach(child => {
                        const s = child.val();
                        allRows.push(s);
                        if (s.studentClass) classSet.add(s.studentClass);
                    });
                }
                const classFilter = document.getElementById('qsClassFilter');
                if (classFilter) {
                    const prev = classFilter.value;
                    classFilter.innerHTML = '<option value="">All Classes</option>';
                    [...classSet].sort().forEach(c => {
                        const o = document.createElement('option');
                        o.value = c; o.textContent = c;
                        if (c === prev) o.selected = true;
                        classFilter.appendChild(o);
                    });
                }

                // Store rows globally for client-side filter
                window._qsAllRows = allRows;
                filterSubmissionsTable();

                // Populate date dropdown and auto-load stats for today
                await populateQsDateFilter();
                const dateSel = document.getElementById('qsDateFilter');
                if (dateSel && !dateSel.value) {
                    dateSel.value = today;
                }
                loadClassStats();

            } catch (err) {
                console.error('Load submissions error:', err);
            }
        }

        function filterSubmissionsTable() {
            const tbody = document.getElementById('quizSubmissionsTableAdmin');
            if (!tbody) return;
            const rows = window._qsAllRows || [];
            const classF = (document.getElementById('qsClassFilter') || {}).value || '';
            const scoreF = (document.getElementById('qsScoreFilter') || {}).value;
            tbody.innerHTML = '';

            if (rows.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;color:#999">No submissions yet today.</td></tr>';
                return;
            }
            let idx = 1;
            rows.filter(s => {
                if (classF && s.studentClass !== classF) return false;
                if (scoreF !== '' && scoreF !== undefined && String(s.score) !== scoreF) return false;
                return true;
            }).forEach(s => {
                const row = tbody.insertRow();
                const mins = Math.floor(s.timeTaken / 60);
                const secs = s.timeTaken % 60;
                const scoreBg = s.score === 2 ? '#d4edda' : s.score === 1 ? '#fff3cd' : '#f8d7da';
                const scoreCol = s.score === 2 ? '#155724' : s.score === 1 ? '#856404' : '#721c24';
                row.innerHTML = `<td>${idx++}</td><td>${s.studentName||''}</td><td>${s.studentEmail||''}</td>
                    <td><span style="background:#f3e5ff;color:#4a148c;padding:2px 8px;border-radius:10px;font-size:12px">${s.studentClass||''}</span></td>
                    <td style="font-size:12px">${new Date(s.submittedAt).toLocaleString('en-IN')}</td>
                    <td><span style="background:${scoreBg};color:${scoreCol};padding:3px 10px;border-radius:10px;font-weight:700">${s.score}/2</span></td>
                    <td style="font-size:12px">${mins}m ${secs}s</td>`;
            });
            if (idx === 1) tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;color:#999">No matching submissions.</td></tr>';
        }

        async function populateQsDateFilter() {
            try {
                const snap = await db.ref('quizSubmissions').once('value');
                const sel  = document.getElementById('qsDateFilter');
                if (!sel || !snap.exists()) return;
                const cur = sel.value;
                const dates = [];
                snap.forEach(d => dates.push(d.key));
                dates.sort((a,b) => b.localeCompare(a));
                sel.innerHTML = '<option value="">‚Äî Select Date ‚Äî</option>';
                dates.forEach(d => {
                    const o = document.createElement('option');
                    o.value = d;
                    o.textContent = new Date(d).toLocaleDateString('en-IN',{weekday:'short',day:'numeric',month:'short',year:'numeric'});
                    if (d === cur || (!cur && d === getQuizToday())) o.selected = true;
                    sel.appendChild(o);
                });
                // Also populate CR date filter
                const crSel = document.getElementById('crQsDateFilter');
                if (crSel) {
                    const crCur = crSel.value;
                    crSel.innerHTML = '<option value="">‚Äî Select Date ‚Äî</option>';
                    dates.forEach(d => {
                        const o = document.createElement('option');
                        o.value = d;
                        o.textContent = new Date(d).toLocaleDateString('en-IN',{weekday:'short',day:'numeric',month:'short',year:'numeric'});
                        if (d === crCur || (!crCur && d === getQuizToday())) o.selected = true;
                        crSel.appendChild(o);
                    });
                }
            } catch(e) { console.warn('populateQsDateFilter:', e); }
        }

        async function loadClassStats() {
            const sel  = document.getElementById('qsDateFilter');
            const date = sel ? sel.value : getQuizToday();
            const container = document.getElementById('qsClassBreakdown');
            const infoBox   = document.getElementById('qsInfoBox');
            const pillTotal  = document.getElementById('qsPillTotal');
            const pillCorrect= document.getElementById('qsPillCorrect');
            const pillClass  = document.getElementById('qsPillClasses');
            if (!date) {
                if (container) container.innerHTML = '<p style="color:#999;font-size:13px;text-align:center;padding:12px">Select a date above</p>';
                return;
            }
            if (container) container.innerHTML = '<p style="color:#aaa;font-size:13px;text-align:center;padding:12px">‚è≥ Loading‚Ä¶</p>';
            try {
                const snap = await db.ref(`quizSubmissions/${date}`).once('value');
                const dateStr = new Date(date).toLocaleDateString('en-IN',{weekday:'long',day:'numeric',month:'long',year:'numeric'});

                if (!snap.exists()) {
                    if (container) container.innerHTML = `<p style="color:#999;font-size:13px;text-align:center;padding:12px">No submissions found for ${dateStr}</p>`;
                    if (pillTotal) pillTotal.textContent = 'Total: 0';
                    if (pillCorrect) pillCorrect.textContent = 'Both Correct: 0';
                    if (pillClass) pillClass.textContent = 'Classes: 0';
                    if (infoBox) infoBox.style.display = 'none';
                    return;
                }

                // Aggregate by class
                const classMap = {}; // class ‚Üí {total, correct, partial, none, students[]}
                let grandTotal = 0, grandCorrect = 0;
                snap.forEach(child => {
                    const s = child.val();
                    const cls = s.studentClass || 'Unknown';
                    if (!classMap[cls]) classMap[cls] = {total:0, correct:0, partial:0, none:0};
                    classMap[cls].total++;
                    grandTotal++;
                    if (s.score === 2) { classMap[cls].correct++; grandCorrect++; }
                    else if (s.score === 1) classMap[cls].partial++;
                    else classMap[cls].none++;
                });

                const classCount = Object.keys(classMap).length;
                if (pillTotal)   pillTotal.textContent   = `Total: ${grandTotal}`;
                if (pillCorrect) pillCorrect.textContent = `Both Correct: ${grandCorrect}`;
                if (pillClass)   pillClass.textContent   = `Classes: ${classCount}`;

                // Build class breakdown table
                const sorted = Object.entries(classMap).sort((a,b) => b[1].total - a[1].total);
                let html = `<div class="table-wrapper" style="margin:0"><table style="font-size:13px">
                    <thead><tr>
                        <th style="background:#3d0060;color:#ffd700">Class</th>
                        <th style="background:#3d0060;color:white">Participated</th>
                        <th style="background:#3d0060;color:#a5d6a7">Both Correct ‚úÖ</th>
                        <th style="background:#3d0060;color:#fff3cd">Partial (1/2) ‚ö†Ô∏è</th>
                        <th style="background:#3d0060;color:#f5c6cb">None (0/2) ‚ùå</th>
                        <th style="background:#3d0060;color:#80deea">Accuracy</th>
                    </tr></thead><tbody>`;
                sorted.forEach(([cls, d]) => {
                    const acc = d.total > 0 ? Math.round((d.correct/d.total)*100) : 0;
                    const barColor = acc >= 70 ? '#28a745' : acc >= 40 ? '#ffc107' : '#dc3545';
                    html += `<tr>
                        <td><strong>${cls}</strong></td>
                        <td style="text-align:center;font-weight:700">${d.total}</td>
                        <td style="text-align:center;color:#155724;font-weight:600">${d.correct}</td>
                        <td style="text-align:center;color:#856404">${d.partial}</td>
                        <td style="text-align:center;color:#721c24">${d.none}</td>
                        <td style="min-width:90px">
                            <div style="display:flex;align-items:center;gap:6px">
                                <div style="flex:1;background:#eee;border-radius:4px;height:8px;overflow:hidden">
                                    <div style="width:${acc}%;background:${barColor};height:100%;border-radius:4px;transition:width 0.4s"></div>
                                </div>
                                <span style="font-size:11px;font-weight:700;color:${barColor};min-width:30px">${acc}%</span>
                            </div>
                        </td>
                    </tr>`;
                });
                html += '</tbody></table></div>';
                if (container) container.innerHTML = html;

                // Build info text box
                const infoDateEl = document.getElementById('qsInfoDate');
                const infoTextEl = document.getElementById('qsInfoText');
                if (infoDateEl) infoDateEl.textContent = dateStr;
                if (infoTextEl) {
                    let infoLines = `<strong>${grandTotal}</strong> students participated across <strong>${classCount}</strong> classes.<br>`;
                    infoLines += `<strong>${grandCorrect}</strong> got both questions correct (${grandTotal>0?Math.round((grandCorrect/grandTotal)*100):0}% accuracy).<br><br>`;
                    infoLines += '<strong>Class-wise breakdown:</strong><br>';
                    sorted.forEach(([cls,d]) => {
                        const acc = d.total>0?Math.round((d.correct/d.total)*100):0;
                        infoLines += `‚Ä¢ ${cls}: ${d.total} participated, ${d.correct} correct (${acc}%)<br>`;
                    });
                    infoTextEl.innerHTML = infoLines;
                }
                if (infoBox) infoBox.style.display = 'block';
                // Save for copy
                window._qsLastInfoText = `Quiz Summary ‚Äî ${dateStr}\n\n${grandTotal} students participated across ${classCount} classes.\n${grandCorrect} got both questions correct (${grandTotal>0?Math.round((grandCorrect/grandTotal)*100):0}% accuracy).\n\nClass-wise:\n` +
                    sorted.map(([cls,d])=>`‚Ä¢ ${cls}: ${d.total} participated, ${d.correct} correct (${d.total>0?Math.round((d.correct/d.total)*100):0}%)`).join('\n');

            } catch(e) {
                if (container) container.innerHTML = `<p style="color:red;font-size:13px;padding:12px">Error: ${e.message}</p>`;
            }
        }

        function copyQsInfo() {
            const txt = window._qsLastInfoText || '';
            if (!txt) return;
            navigator.clipboard.writeText(txt).then(()=>{
                const btn = document.querySelector('[onclick="copyQsInfo()"]');
                if (btn) { const orig=btn.textContent; btn.textContent='‚úÖ Copied!'; setTimeout(()=>btn.textContent=orig,2000); }
            }).catch(()=>{ /* fallback */ });
        }

        async function loadCRQuizStats() {
            const crClass  = typeof currentCRClass !== 'undefined' ? currentCRClass : (document.getElementById('crClassName')||{}).textContent || '';
            const dateSel  = document.getElementById('crQsDateFilter');
            // Populate dates first
            await populateQsDateFilter();
            const date = dateSel ? dateSel.value || getQuizToday() : getQuizToday();
            if (dateSel && !dateSel.value) dateSel.value = date;

            const dateStr  = new Date(date).toLocaleDateString('en-IN',{weekday:'long',day:'numeric',month:'long',year:'numeric'});
            const infoDate = document.getElementById('crQsInfoDate');
            const infoText = document.getElementById('crQsInfoText');
            const tbody    = document.getElementById('crQsTable');
            const totEl    = document.getElementById('crQsTotal');
            const corrEl   = document.getElementById('crQsCorrect');
            const partEl   = document.getElementById('crQsPartial');
            const rateEl   = document.getElementById('crQsRate');
            if (infoDate) infoDate.textContent = dateStr;
            if (tbody) tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;color:#aaa">‚è≥ Loading‚Ä¶</td></tr>';
            if (infoText) infoText.textContent = '‚è≥ Loading‚Ä¶';
            try {
                const snap = await db.ref(`quizSubmissions/${date}`).once('value');
                if (!snap.exists()) {
                    if (totEl) totEl.textContent = '0';
                    if (corrEl) corrEl.textContent = '0';
                    if (partEl) partEl.textContent = '0';
                    if (rateEl) rateEl.textContent = '0%';
                    if (tbody) tbody.innerHTML = `<tr><td colspan="5" style="text-align:center;color:#999">No quiz submissions on ${dateStr}</td></tr>`;
                    if (infoText) infoText.textContent = `No quiz submissions found for your class on ${dateStr}.`;
                    return;
                }
                // Filter to CR's class
                const classStudents = [];
                let total=0,correct=0,partial=0;
                snap.forEach(child => {
                    const s = child.val();
                    if (!crClass || s.studentClass === crClass) {
                        classStudents.push(s);
                        total++;
                        if (s.score===2) correct++;
                        else if(s.score===1) partial++;
                    }
                });
                const rate = total>0?Math.round((correct/total)*100):0;
                if (totEl)  totEl.textContent  = total;
                if (corrEl) corrEl.textContent = correct;
                if (partEl) partEl.textContent = partial;
                if (rateEl) rateEl.textContent = rate+'%';

                // Info text
                if (infoText) {
                    if (total === 0) {
                        infoText.innerHTML = `<strong>No students</strong> from <strong>${crClass}</strong> participated in the quiz on ${dateStr}.`;
                    } else {
                        infoText.innerHTML = `On <strong>${dateStr}</strong>, <strong>${total}</strong> student(s) from <strong>${crClass}</strong> participated in the online quiz.<br>
                            <strong>${correct}</strong> got both questions correct (${rate}% accuracy).<br>
                            <strong>${partial}</strong> got one correct. <strong>${total-correct-partial}</strong> got none correct.<br>
                            ${correct>=2 ? '‚úÖ Your class has eligible students for winner selection.' : correct===1 ? '‚ö†Ô∏è Only 1 correct answer ‚Äî need 2+ for winner &amp; runner-up.' : '‚ùå No correct answers from your class today.'}`;
                    }
                }

                // Student table
                if (tbody) {
                    if (classStudents.length === 0) {
                        tbody.innerHTML = `<tr><td colspan="5" style="text-align:center;color:#999">No submissions from ${crClass} on this date.</td></tr>`;
                    } else {
                        classStudents.sort((a,b)=>b.score-a.score||(a.timeTaken-b.timeTaken));
                        tbody.innerHTML = '';
                        classStudents.forEach((s,i) => {
                            const row = tbody.insertRow();
                            const mins = Math.floor(s.timeTaken/60), secs = s.timeTaken%60;
                            const scoreBg = s.score===2?'#d4edda':s.score===1?'#fff3cd':'#f8d7da';
                            const scoreCol= s.score===2?'#155724':s.score===1?'#856404':'#721c24';
                            row.innerHTML = `<td>${i+1}</td>
                                <td><strong>${s.studentName||''}</strong></td>
                                <td><span style="background:${scoreBg};color:${scoreCol};padding:3px 10px;border-radius:10px;font-weight:700">${s.score}/2</span></td>
                                <td>${mins}m ${secs}s</td>
                                <td style="font-size:12px">${new Date(s.submittedAt).toLocaleString('en-IN')}</td>`;
                        });
                    }
                }
            } catch(e) {
                if (infoText) infoText.textContent = 'Error loading data: ' + e.message;
                if (tbody) tbody.innerHTML = `<tr><td colspan="5" style="color:red;text-align:center">Error: ${e.message}</td></tr>`;
            }
        }
        
        async function loadQuizResultsAdmin() {
            const today = getQuizToday();
            try {
                const snap = await db.ref(`quizSubmissions/${today}`).once('value');
                
                if (!snap.exists()) {
                    document.getElementById('resultTotalPartAdmin').textContent = '0';
                    document.getElementById('resultBothCorrectAdmin').textContent = '0';
                    document.getElementById('resultEligibleAdmin').textContent = '0';
                    return;
                }
                
                let total = 0, correct = 0;
                const eligibleStudents = [];
                
                snap.forEach(child => {
                    total++;
                    const data = child.val();
                    if (data.score === 2) {
                        correct++;
                        eligibleStudents.push({
                            name: data.studentName,
                            class: data.studentClass,
                            email: data.studentEmail,
                            time: data.timeTaken,
                            submittedAt: data.submittedAt
                        });
                    }
                });
                
                document.getElementById('resultTotalPartAdmin').textContent = total;
                document.getElementById('resultBothCorrectAdmin').textContent = correct;
                document.getElementById('resultEligibleAdmin').textContent = correct;
                
                // Display detailed list of eligible students
                displayEligibleStudentsList(eligibleStudents);
                
                const resSnap = await db.ref(`quizResults/${today}`).once('value');
                if (resSnap.exists()) {
                    displayQuizWinnersAdmin(resSnap.val());
                }
            } catch (err) {
                console.error('Load results error:', err);
            }
        }
        
        function displayEligibleStudentsList(students) {
            const container = document.getElementById('eligibleStudentsListAdmin');
            if (!container) return;
            // Cache for manual select dropdowns
            _eligibleCache = students;
            if (_manualPanelOpen) populateManualSelects();
            
            if (students.length === 0) {
                container.innerHTML = '<p style="color:#999;font-style:italic;text-align:center;padding:20px">No students with both correct answers yet</p>';
                return;
            }
            
            // Sort by submission time (fastest first)
            students.sort((a, b) => new Date(a.submittedAt) - new Date(b.submittedAt));
            
            let html = '<div style="margin-top:20px">';
            html += '<h4 style="color:#28a745;margin-bottom:15px">‚úÖ Eligible Students (Both Questions Correct)</h4>';
            html += '<div style="background:white;border-radius:10px;overflow:hidden;box-shadow:0 2px 8px rgba(0,0,0,0.1)">';
            html += '<div style="overflow-x:auto;-webkit-overflow-scrolling:touch;">';
            html += '<table style="width:100%;border-collapse:collapse;min-width:400px">';
            html += '<thead><tr style="background:#28a745;color:white">';
            html += '<th style="padding:10px 8px;text-align:left;white-space:nowrap">#</th>';
            html += '<th style="padding:10px 8px;text-align:left;white-space:nowrap">Name</th>';
            html += '<th style="padding:10px 8px;text-align:left;white-space:nowrap">Class</th>';
            html += '<th style="padding:10px 8px;text-align:left;white-space:nowrap">Time Taken</th>';
            html += '<th style="padding:10px 8px;text-align:left;white-space:nowrap">Submitted At</th>';
            html += '</tr></thead><tbody>';
            
            students.forEach((student, index) => {
                const bgColor = index % 2 === 0 ? '#f8f9fa' : 'white';
                const submittedTime = new Date(student.submittedAt).toLocaleTimeString('en-IN', {
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                });
                const timeTaken = Math.floor(student.time / 60) + 'm ' + (student.time % 60) + 's';
                
                html += `<tr style="background:${bgColor}">`;
                html += `<td style="padding:10px 8px;border-bottom:1px solid #e9ecef;white-space:nowrap">${index + 1}</td>`;
                html += `<td style="padding:10px 8px;border-bottom:1px solid #e9ecef;font-weight:600;word-break:break-word;max-width:140px">${student.name}</td>`;
                html += `<td style="padding:10px 8px;border-bottom:1px solid #e9ecef;white-space:nowrap">${student.class}</td>`;
                html += `<td style="padding:10px 8px;border-bottom:1px solid #e9ecef;white-space:nowrap">${timeTaken}</td>`;
                html += `<td style="padding:10px 8px;border-bottom:1px solid #e9ecef;white-space:nowrap">${submittedTime}</td>`;
                html += '</tr>';
            });
            
            html += '</tbody></table></div></div></div>';
            container.innerHTML = html;
        }
        
        async function selectQuizWinnersFromAdmin() {
            const today = getQuizToday();
            try {
                const snap = await db.ref(`quizSubmissions/${today}`).once('value');
                const eligible = [];
                snap.forEach(child => {
                    if (child.val().score === 2) eligible.push(child.val());
                });
                
                if (eligible.length === 0) {
                    showQuizMsg('quizAdminMessage', '‚ö†Ô∏è No correct answers yet!', 'warning');
                    return;
                }
                
                if (eligible.length === 1) {
                    showQuizMsg('quizAdminMessage', '‚ö†Ô∏è Only one correct. Need 2 for winner & runner-up.', 'warning');
                    return;
                }
                
                const shuffled = eligible.sort(() => 0.5 - Math.random());
                const winner = shuffled[0];
                const runnerUp = shuffled[1];
                
                const data = {
                    winner: {name: winner.studentName, email: winner.studentEmail, class: winner.studentClass, score: winner.score},
                    runnerUp: {name: runnerUp.studentName, email: runnerUp.studentEmail, class: runnerUp.studentClass, score: runnerUp.score},
                    declaredAt: new Date().toISOString(),
                    declaredBy: 'Super Admin',
                    totalEligible: eligible.length
                };
                
                await db.ref(`quizResults/${today}`).set(data);
                
                // Try to send emails but don't block winner declaration
                try {
                    await sendQuizEmail(winner.studentEmail, 'üèÜ You Won Quiz!', `Dear ${winner.studentName},\n\nCongratulations! You are the WINNER of today's Daily Quiz Competition!\n\nScore: ${winner.score}/2\nClass: ${winner.studentClass}\n\nWell done!\n\nDavan Institute`);
                } catch (e) { console.log('Winner email failed:', e); }
                
                try {
                    await sendQuizEmail(runnerUp.studentEmail, 'ü•à Runner-Up!', `Dear ${runnerUp.studentName},\n\nCongratulations! You are the RUNNER-UP!\n\nScore: ${runnerUp.score}/2\nClass: ${runnerUp.studentClass}\n\nGreat job!\n\nDavan Institute`);
                } catch (e) { console.log('Runner-up email failed:', e); }
                
                showQuizMsg('quizAdminMessage', '‚úÖ Winners selected! Check Firebase for email logs.', 'success');
                displayQuizWinnersAdmin(data);
            } catch (err) {
                console.error('Select winners error:', err);
                showQuizMsg('quizAdminMessage', 'Error selecting winners.', 'error');
            }
        }
        
        function displayQuizWinnersAdmin(data) {
            const div = document.getElementById('winnersDisplayAdmin');
            let html = '<div style="background:#f8f9fa;padding:25px;border-radius:12px">';
            html += '<h3 style="color:#667eea;margin-bottom:20px;text-align:center">üéâ Today\'s Winners</h3>';
            html += '<div style="background:linear-gradient(135deg,#ffd700 0%,#ffed4e 100%);padding:20px;border-radius:10px;margin-bottom:15px;color:#333">';
            html += '<h4>üèÜ WINNER</h4>';
            html += `<p><strong>Name:</strong> ${data.winner.name}</p>`;
            html += `<p><strong>Email:</strong> ${data.winner.email}</p>`;
            html += `<p><strong>Class:</strong> ${data.winner.class}</p>`;
            html += `<p><strong>Score:</strong> ${data.winner.score}/2</p></div>`;
            html += '<div style="background:linear-gradient(135deg,#c0c0c0 0%,#e8e8e8 100%);padding:20px;border-radius:10px;color:#333">';
            html += '<h4>ü•à RUNNER-UP</h4>';
            html += `<p><strong>Name:</strong> ${data.runnerUp.name}</p>`;
            html += `<p><strong>Email:</strong> ${data.runnerUp.email}</p>`;
            html += `<p><strong>Class:</strong> ${data.runnerUp.class}</p>`;
            html += `<p><strong>Score:</strong> ${data.runnerUp.score}/2</p></div>`;
            const declaredBy = data.declaredBy || 'Admin';
            const modeTag = data.autoSelected
                ? '<span style="background:#6a1b9a;color:#ffd700;padding:2px 10px;border-radius:12px;font-size:12px;margin-left:6px">‚è∞ Auto-declared</span>'
                : (data.manualSelected
                    ? '<span style="background:#2196F3;color:white;padding:2px 10px;border-radius:12px;font-size:12px;margin-left:6px">‚úã Manual</span>'
                    : '<span style="background:#28a745;color:white;padding:2px 10px;border-radius:12px;font-size:12px;margin-left:6px">üé≤ Random</span>');
            html += `<p style="text-align:center;margin-top:20px;color:#666"><small>Declared: ${new Date(data.declaredAt).toLocaleString()} by ${declaredBy}</small>${modeTag}</p></div>`;
            div.innerHTML = html;
            div.style.display = 'block';
        }

        // ============================================
        // AUTO-DECLARATION SCHEDULER (11:30 PM daily)
        // ============================================
        let _autoDeclarInterval = null;
        let _eligibleCache = []; // populated when winners tab loads

        function saveAutoDeclarSetting() {
            const enabled = document.getElementById('autoDeclarToggle').checked;
            try { localStorage.setItem('quizAutoDeclar', enabled ? '1' : '0'); } catch(e){}
            applyAutoDeclarUI(enabled);
            if (enabled) {
                startAutoDeclarScheduler();
            } else {
                stopAutoDeclarScheduler();
            }
        }

        function applyAutoDeclarUI(enabled) {
            const slider = document.getElementById('autoDeclarSlider');
            const thumb  = document.getElementById('autoDeclarThumb');
            const label  = document.getElementById('autoDeclarLabel');
            const status = document.getElementById('autoDeclarStatus');
            const countdown = document.getElementById('autoDeclarCountdown');
            if (!slider) return;
            if (enabled) {
                slider.style.background = '#28a745';
                thumb.style.left = '25px';
                label.textContent = 'ON';
                status.innerHTML = 'üü¢ Auto-declaration is <strong style="color:#a5ffb8">enabled</strong>. Winners will be auto-selected at <strong style="color:#ffd700">11:30 PM</strong> if not declared manually.';
                countdown.style.display = 'block';
                updateAutoDeclarCountdown();
            } else {
                slider.style.background = '#555';
                thumb.style.left = '3px';
                label.textContent = 'OFF';
                status.innerHTML = 'üî¥ Auto-declaration is <strong style="color:#ff6b6b">disabled</strong>. Toggle ON to enable.';
                countdown.style.display = 'none';
            }
        }

        function updateAutoDeclarCountdown() {
            const el = document.getElementById('autoDeclarCountdown');
            if (!el || !document.getElementById('autoDeclarToggle').checked) return;
            const now = new Date();
            const target = new Date();
            target.setHours(23, 30, 0, 0);
            if (now >= target) {
                el.textContent = '‚è∞ 11:30 PM has passed for today. Auto-declaration ran (or no eligible students).';
                return;
            }
            const diff = Math.floor((target - now) / 1000);
            const h = Math.floor(diff / 3600);
            const m = Math.floor((diff % 3600) / 60);
            const s = diff % 60;
            el.textContent = `‚è≥ Auto-declaration in: ${String(h).padStart(2,'0')}h ${String(m).padStart(2,'0')}m ${String(s).padStart(2,'0')}s`;
        }

        function startAutoDeclarScheduler() {
            stopAutoDeclarScheduler();
            _autoDeclarInterval = setInterval(async () => {
                if (!document.getElementById('autoDeclarToggle') || !document.getElementById('autoDeclarToggle').checked) return;
                updateAutoDeclarCountdown();
                const now = new Date();
                // Trigger between 23:30:00 and 23:30:59
                if (now.getHours() === 23 && now.getMinutes() === 30) {
                    await runAutoDeclaration();
                }
            }, 1000);
        }

        function stopAutoDeclarScheduler() {
            if (_autoDeclarInterval) { clearInterval(_autoDeclarInterval); _autoDeclarInterval = null; }
        }

        async function runAutoDeclaration() {
            const today = getQuizToday();
            // Check if results already declared for today
            try {
                const existing = await db.ref(`quizResults/${today}`).once('value');
                if (existing.exists()) {
                    console.log('[AutoDeclar] Results already declared for', today, '‚Äî skipping.');
                    return;
                }
                const snap = await db.ref(`quizSubmissions/${today}`).once('value');
                const eligible = [];
                snap.forEach(child => {
                    if (child.val().score === 2) eligible.push(child.val());
                });
                if (eligible.length < 2) {
                    console.log('[AutoDeclar] Not enough eligible students (' + eligible.length + ').');
                    const statusEl = document.getElementById('autoDeclarStatus');
                    if (statusEl) statusEl.innerHTML = '‚ö†Ô∏è Auto-declaration ran at 11:30 PM but <strong>not enough eligible students</strong> (need at least 2).';
                    return;
                }
                const shuffled = eligible.sort(() => 0.5 - Math.random());
                const winner   = shuffled[0];
                const runnerUp = shuffled[1];
                const data = {
                    winner:       { name: winner.studentName,   email: winner.studentEmail,   class: winner.studentClass,   score: winner.score },
                    runnerUp:     { name: runnerUp.studentName, email: runnerUp.studentEmail, class: runnerUp.studentClass, score: runnerUp.score },
                    declaredAt:   new Date().toISOString(),
                    declaredBy:   'System (Auto 11:30 PM)',
                    totalEligible: eligible.length,
                    autoSelected: true
                };
                await db.ref(`quizResults/${today}`).set(data);
                console.log('[AutoDeclar] Winners saved for', today);
                // Send emails silently
                try { await sendQuizEmail(winner.studentEmail,   'üèÜ You Won Quiz!', `Dear ${winner.studentName},\n\nCongratulations! You are the WINNER of today's Quiz!\n\nDavan Institute`); } catch(e){}
                try { await sendQuizEmail(runnerUp.studentEmail, 'ü•à Runner-Up!',    `Dear ${runnerUp.studentName},\n\nCongratulations! You are today's RUNNER-UP!\n\nDavan Institute`); } catch(e){}
                // Update UI if winners tab is visible
                displayQuizWinnersAdmin(data);
                const statusEl = document.getElementById('autoDeclarStatus');
                if (statusEl) statusEl.innerHTML = `‚úÖ Auto-declared at 11:30 PM ‚Äî <strong style="color:#a5ffb8">${winner.studentName}</strong> (Winner) &amp; <strong style="color:#ffd700">${runnerUp.studentName}</strong> (Runner-Up).`;
            } catch(e) {
                console.error('[AutoDeclar] Error:', e);
            }
        }

        function initAutoDeclarScheduler() {
            let enabled = false;
            try { enabled = localStorage.getItem('quizAutoDeclar') === '1'; } catch(e){}
            const toggle = document.getElementById('autoDeclarToggle');
            if (toggle) {
                toggle.checked = enabled;
                applyAutoDeclarUI(enabled);
                if (enabled) startAutoDeclarScheduler();
            }
        }

        // ============================================
        // MANUAL WINNER SELECTION
        // ============================================
        let _manualPanelOpen = false;

        function toggleManualWinnerUI() {
            _manualPanelOpen = !_manualPanelOpen;
            const panel = document.getElementById('manualWinnerPanel');
            const btn   = document.getElementById('manualSelectToggleBtn');
            if (!panel) return;
            if (_manualPanelOpen) {
                panel.style.display = 'block';
                btn.textContent = '‚úñ Close Manual Select';
                populateManualSelects();
            } else {
                panel.style.display = 'none';
                btn.textContent = '‚úã Manual Select';
            }
        }

        function populateManualSelects() {
            const winSel = document.getElementById('manualWinnerSelect');
            const runSel = document.getElementById('manualRunnerSelect');
            if (!winSel || !runSel) return;
            // Use _eligibleCache built when winners tab loads
            winSel.innerHTML = '<option value="">-- Select Winner --</option>';
            runSel.innerHTML = '<option value="">-- Select Runner-Up --</option>';
            _eligibleCache.forEach((s, i) => {
                const label = `${s.name} (${s.class})`;
                winSel.innerHTML += `<option value="${i}">${label}</option>`;
                runSel.innerHTML += `<option value="${i}">${label}</option>`;
            });
        }

        async function declareManualWinners() {
            const winIdx = parseInt(document.getElementById('manualWinnerSelect').value);
            const runIdx = parseInt(document.getElementById('manualRunnerSelect').value);
            if (isNaN(winIdx) || isNaN(runIdx)) {
                alert('‚ö†Ô∏è Please select both winner and runner-up.');
                return;
            }
            if (winIdx === runIdx) {
                alert('‚ö†Ô∏è Winner and runner-up must be different students.');
                return;
            }
            const winner   = _eligibleCache[winIdx];
            const runnerUp = _eligibleCache[runIdx];
            if (!winner || !runnerUp) { alert('‚ö†Ô∏è Invalid selection.'); return; }
            if (!confirm(`Declare:\nüèÜ Winner: ${winner.name}\nü•à Runner-Up: ${runnerUp.name}\n\nProceed?`)) return;
            const today = getQuizToday();
            const data = {
                winner:       { name: winner.name,   email: winner.email,   class: winner.class,   score: 2 },
                runnerUp:     { name: runnerUp.name, email: runnerUp.email, class: runnerUp.class, score: 2 },
                declaredAt:   new Date().toISOString(),
                declaredBy:   'Super Admin (Manual)',
                totalEligible: _eligibleCache.length,
                manualSelected: true
            };
            try {
                await db.ref(`quizResults/${today}`).set(data);
                try { await sendQuizEmail(winner.email,   'üèÜ You Won Quiz!', `Dear ${winner.name},\n\nCongratulations! You are the WINNER!\n\nDavan Institute`); } catch(e){}
                try { await sendQuizEmail(runnerUp.email, 'ü•à Runner-Up!',    `Dear ${runnerUp.name},\n\nCongratulations! You are the RUNNER-UP!\n\nDavan Institute`); } catch(e){}
                showQuizMsg('quizAdminMessage', '‚úÖ Manual winners declared!', 'success');
                displayQuizWinnersAdmin(data);
                toggleManualWinnerUI(); // close panel
            } catch(e) {
                alert('‚ùå Error saving: ' + e.message);
            }
        }
        
        // ============================================
        // NEW PUBLISH/UNPUBLISH FUNCTIONS
        // ============================================
        
        async function checkPublishStatusForToday() {
            const today = getQuizToday();
            console.log('checkPublishStatusForToday called for:', today);
            try {
                const qSnap = await db.ref(`quizQuestions/${today}`).once('value');
                if (!qSnap.exists()) {
                    console.log('No questions exist for today');
                    document.getElementById('publishControlSection').style.display = 'none';
                    return;
                }
                
                const pSnap = await db.ref(`quizPublished/${today}`).once('value');
                const publishData = pSnap.val();
                const isPublished = publishData && publishData.published === true;
                
                console.log('Publish data (Today):', JSON.stringify(publishData));
                console.log('Is published (Today):', isPublished);
                
                const publishControlSection = document.getElementById('publishControlSection');
                const statusDiv = document.getElementById('publishStatusDisplay');
                const btnPub = document.getElementById('btnPublish');
                const btnUnpub = document.getElementById('btnUnpublish');
                
                if (!publishControlSection || !statusDiv || !btnPub || !btnUnpub) {
                    console.error('Could not find required elements (Today tab)');
                    return;
                }
                
                publishControlSection.style.display = 'block';
                
                if (isPublished) {
                    console.log('Showing UNPUBLISH button (Today tab)');
                    statusDiv.innerHTML = '<div style="background:#d4edda;padding:15px;border-radius:8px;border:2px solid #28a745"><p style="margin:0;color:#155724;font-weight:bold">‚úÖ Quiz is PUBLISHED - Students can see it</p><p style="margin:5px 0 0 0;color:#155724;font-size:13px">Published: ' + new Date(publishData.publishedAt).toLocaleString() + '</p></div>';
                    btnPub.style.display = 'none';
                    btnUnpub.style.display = 'inline-block';
                } else {
                    console.log('Showing PUBLISH button (Today tab)');
                    statusDiv.innerHTML = '<div style="background:#fff3cd;padding:15px;border-radius:8px;border:2px solid #ffc107"><p style="margin:0;color:#856404;font-weight:bold">‚ö†Ô∏è Quiz is DRAFT - Not visible to students</p><p style="margin:5px 0 0 0;color:#856404;font-size:13px">Click PUBLISH to make it visible</p></div>';
                    btnPub.style.display = 'inline-block';
                    btnUnpub.style.display = 'none';
                }
            } catch (err) {
                console.error('Check publish error (Today):', err);
            }
        }
        
        async function publishTodayQuiz() {
            const today = getQuizToday();
            if (!confirm('Publish today\'s quiz? Students will be able to see and attempt it.')) return;
            
            console.log('=== PUBLISH STARTED ===');
            console.log('Today:', today);
            console.log('Current user:', quizCurrentUser);
            
            try {
                const qSnap = await db.ref(`quizQuestions/${today}`).once('value');
                if (!qSnap.exists()) {
                    showQuizMsg('quizAdminDashMessage', '‚ö†Ô∏è No questions saved for today!', 'error');
                    return;
                }
                
                // Get the email safely
                const userEmail = quizCurrentUser ? quizCurrentUser.email : 'admin@system';
                console.log('Using email:', userEmail);
                
                // Write to database and wait for completion
                await db.ref(`quizPublished/${today}`).set({
                    published: true,
                    publishedAt: new Date().toISOString(),
                    publishedBy: userEmail
                });
                
                console.log('Firebase write completed');
                
                // Verify the write
                const verifySnap = await db.ref(`quizPublished/${today}`).once('value');
                const publishData = verifySnap.val();
                console.log('Verification read:', JSON.stringify(publishData));
                
                showQuizMsg('quizAdminDashMessage', '‚úÖ Quiz published successfully!', 'success');
                
                // Direct DOM manipulation - force the UI to update immediately
                const statusDivAdmin = document.getElementById('publishStatusDisplayAdmin');
                const btnPubAdmin = document.getElementById('btnPublishAdmin');
                const btnUnpubAdmin = document.getElementById('btnUnpublishAdmin');
                
                const statusDiv = document.getElementById('publishStatusDisplay');
                const btnPub = document.getElementById('btnPublish');
                const btnUnpub = document.getElementById('btnUnpublish');
                
                console.log('Found elements:');
                console.log('  statusDivAdmin:', !!statusDivAdmin);
                console.log('  btnPubAdmin:', !!btnPubAdmin);
                console.log('  btnUnpubAdmin:', !!btnUnpubAdmin);
                console.log('  statusDiv:', !!statusDiv);
                console.log('  btnPub:', !!btnPub);
                console.log('  btnUnpub:', !!btnUnpub);
                
                // Update Admin Dashboard
                if (statusDivAdmin && btnPubAdmin && btnUnpubAdmin) {
                    console.log('Updating Admin Dashboard UI directly');
                    statusDivAdmin.innerHTML = '<div style="background:#d4edda;padding:15px;border-radius:8px;border:2px solid #28a745"><p style="margin:0;color:#155724;font-weight:bold">‚úÖ Quiz is PUBLISHED - Students can see it</p><p style="margin:5px 0 0 0;color:#155724;font-size:13px">Published: ' + new Date(publishData.publishedAt).toLocaleString() + '</p></div>';
                    btnPubAdmin.style.display = 'none';
                    btnUnpubAdmin.style.display = 'inline-block';
                    console.log('Admin buttons updated - Publish:', btnPubAdmin.style.display, 'Unpublish:', btnUnpubAdmin.style.display);
                } else {
                    console.log('Could not update Admin Dashboard - elements missing');
                }
                
                // Update Quiz Management Tab
                if (statusDiv && btnPub && btnUnpub) {
                    console.log('Updating Quiz Management Tab UI directly');
                    statusDiv.innerHTML = '<div style="background:#d4edda;padding:15px;border-radius:8px;border:2px solid #28a745"><p style="margin:0;color:#155724;font-weight:bold">‚úÖ Quiz is PUBLISHED - Students can see it</p><p style="margin:5px 0 0 0;color:#155724;font-size:13px">Published: ' + new Date(publishData.publishedAt).toLocaleString() + '</p></div>';
                    btnPub.style.display = 'none';
                    btnUnpub.style.display = 'inline-block';
                    console.log('Quiz tab buttons updated - Publish:', btnPub.style.display, 'Unpublish:', btnUnpub.style.display);
                } else {
                    console.log('Could not update Quiz Management Tab - elements missing');
                }
                
                console.log('=== PUBLISH COMPLETED ===');
            } catch (err) {
                console.error('Publish error:', err);
                console.error('Error stack:', err.stack);
                showQuizMsg('quizAdminDashMessage', '‚ùå Error publishing: ' + err.message, 'error');
            }
        }
        
        async function unpublishTodayQuiz() {
            const today = getQuizToday();
            if (!confirm('Unpublish today\'s quiz? Students will no longer see it.')) return;
            
            console.log('=== UNPUBLISH STARTED ===');
            console.log('Today:', today);
            console.log('Current user:', quizCurrentUser);
            
            try {
                // Get the email safely
                const userEmail = quizCurrentUser ? quizCurrentUser.email : 'admin@system';
                console.log('Using email:', userEmail);
                
                // Write to database and wait for completion
                await db.ref(`quizPublished/${today}`).set({
                    published: false,
                    unpublishedAt: new Date().toISOString(),
                    unpublishedBy: userEmail
                });
                
                console.log('Firebase write completed');
                
                // Verify the write
                const verifySnap = await db.ref(`quizPublished/${today}`).once('value');
                console.log('Verification read:', JSON.stringify(verifySnap.val()));
                
                showQuizMsg('quizAdminDashMessage', '‚úÖ Quiz unpublished successfully!', 'success');
                
                // Direct DOM manipulation - force the UI to update immediately
                const statusDivAdmin = document.getElementById('publishStatusDisplayAdmin');
                const btnPubAdmin = document.getElementById('btnPublishAdmin');
                const btnUnpubAdmin = document.getElementById('btnUnpublishAdmin');
                
                const statusDiv = document.getElementById('publishStatusDisplay');
                const btnPub = document.getElementById('btnPublish');
                const btnUnpub = document.getElementById('btnUnpublish');
                
                console.log('Found elements:');
                console.log('  statusDivAdmin:', !!statusDivAdmin);
                console.log('  btnPubAdmin:', !!btnPubAdmin);
                console.log('  btnUnpubAdmin:', !!btnUnpubAdmin);
                console.log('  statusDiv:', !!statusDiv);
                console.log('  btnPub:', !!btnPub);
                console.log('  btnUnpub:', !!btnUnpub);
                
                // Update Admin Dashboard
                if (statusDivAdmin && btnPubAdmin && btnUnpubAdmin) {
                    console.log('Updating Admin Dashboard UI directly');
                    statusDivAdmin.innerHTML = '<div style="background:#fff3cd;padding:15px;border-radius:8px;border:2px solid #ffc107"><p style="margin:0;color:#856404;font-weight:bold">‚ö†Ô∏è Quiz is DRAFT - Not visible to students</p><p style="margin:5px 0 0 0;color:#856404;font-size:13px">Click PUBLISH to make it visible</p></div>';
                    btnPubAdmin.style.display = 'inline-block';
                    btnUnpubAdmin.style.display = 'none';
                    console.log('Admin buttons updated - Publish:', btnPubAdmin.style.display, 'Unpublish:', btnUnpubAdmin.style.display);
                } else {
                    console.log('Could not update Admin Dashboard - elements missing');
                }
                
                // Update Quiz Management Tab
                if (statusDiv && btnPub && btnUnpub) {
                    console.log('Updating Quiz Management Tab UI directly');
                    statusDiv.innerHTML = '<div style="background:#fff3cd;padding:15px;border-radius:8px;border:2px solid #ffc107"><p style="margin:0;color:#856404;font-weight:bold">‚ö†Ô∏è Quiz is DRAFT - Not visible to students</p><p style="margin:5px 0 0 0;color:#856404;font-size:13px">Click PUBLISH to make it visible</p></div>';
                    btnPub.style.display = 'inline-block';
                    btnUnpub.style.display = 'none';
                    console.log('Quiz tab buttons updated - Publish:', btnPub.style.display, 'Unpublish:', btnUnpub.style.display);
                } else {
                    console.log('Could not update Quiz Management Tab - elements missing');
                }
                
                console.log('=== UNPUBLISH COMPLETED ===');
            } catch (err) {
                console.error('Unpublish error:', err);
                console.error('Error stack:', err.stack);
                showQuizMsg('quizAdminDashMessage', '‚ùå Error unpublishing: ' + err.message, 'error');
            }
        }
        
        async function showTodayAnswers() {
            const today = getQuizToday();
            try {
                const snap = await db.ref(`quizQuestions/${today}`).once('value');
                const q = snap.val();
                
                // Determine which section we're in
                const isAdmin = document.getElementById('publishControlSectionAdmin') && 
                               document.getElementById('publishControlSectionAdmin').style.display !== 'none';
                const divId = isAdmin ? 'answersDisplaySectionAdmin' : 'answersDisplaySection';
                const div = document.getElementById(divId);
                
                if (!div) {
                    console.error('Answers display div not found');
                    alert('Error: Unable to display answers. Please contact support.');
                    return;
                }
                
                if (!q || !q.q1 || !q.q2) {
                    div.innerHTML = '<div style="background:#f8d7da;padding:15px;border-radius:8px"><p style="margin:0;color:#721c24">‚ùå No questions found for today</p></div>';
                    div.style.display = 'block';
                    return;
                }
                
                let html = '<div style="background:#e8f5e9;padding:25px;border-radius:12px;border:3px solid #4CAF50">';
                html += '<h3 style="color:#2e7d32;margin-bottom:20px;text-align:center">üîç Correct Answers</h3>';
                
                html += '<div style="background:white;padding:20px;border-radius:10px;margin-bottom:15px;border-left:5px solid #4CAF50">';
                html += '<h4 style="color:#667eea;margin-bottom:15px">Question 1</h4>';
                html += `<p style="font-weight:600;margin-bottom:10px">${q.q1.text || 'N/A'}</p>`;
                html += `<p style="margin-left:20px;color:#666">A) ${q.q1.options.A || 'N/A'}</p>`;
                html += `<p style="margin-left:20px;color:#666">B) ${q.q1.options.B || 'N/A'}</p>`;
                html += `<p style="margin-left:20px;color:#666">C) ${q.q1.options.C || 'N/A'}</p>`;
                html += `<p style="margin-left:20px;color:#666">D) ${q.q1.options.D || 'N/A'}</p>`;
                html += `<div style="background:#4CAF50;color:white;padding:12px;border-radius:8px;margin-top:15px;font-weight:bold">‚úÖ Correct Answer: ${q.q1.correct}) ${q.q1.options[q.q1.correct] || 'N/A'}</div></div>`;
                
                html += '<div style="background:white;padding:20px;border-radius:10px;border-left:5px solid #4CAF50">';
                html += '<h4 style="color:#667eea;margin-bottom:15px">Question 2</h4>';
                html += `<p style="font-weight:600;margin-bottom:10px">${q.q2.text || 'N/A'}</p>`;
                html += `<p style="margin-left:20px;color:#666">A) ${q.q2.options.A || 'N/A'}</p>`;
                html += `<p style="margin-left:20px;color:#666">B) ${q.q2.options.B || 'N/A'}</p>`;
                html += `<p style="margin-left:20px;color:#666">C) ${q.q2.options.C || 'N/A'}</p>`;
                html += `<p style="margin-left:20px;color:#666">D) ${q.q2.options.D || 'N/A'}</p>`;
                html += `<div style="background:#4CAF50;color:white;padding:12px;border-radius:8px;margin-top:15px;font-weight:bold">‚úÖ Correct Answer: ${q.q2.correct}) ${q.q2.options[q.q2.correct] || 'N/A'}</div></div>`;
                
                html += '<p style="text-align:center;margin-top:20px;color:#666;font-size:14px"><em>Visible to Admin Only</em></p></div>';
                
                div.innerHTML = html;
                div.style.display = 'block';
                
                // Scroll to the answers with a small delay to ensure rendering
                setTimeout(() => {
                    div.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                }, 100);
            } catch (err) {
                console.error('Show answers error:', err);
                const div = document.getElementById('answersDisplaySectionAdmin') || document.getElementById('answersDisplaySection');
                if (div) {
                    div.innerHTML = '<div style="background:#f8d7da;padding:15px;border-radius:8px"><p style="margin:0;color:#721c24">‚ùå Error loading answers: ' + err.message + '</p></div>';
                    div.style.display = 'block';
                }
                alert('Error displaying answers. Please check the console for details.');
            }
        }
        
        // Admin Dashboard specific publish check
        async function checkPublishStatusForAdmin() {
            const today = getQuizToday();
            console.log('=== checkPublishStatusForAdmin START ===');
            console.log('Date:', today);
            
            try {
                const qSnap = await db.ref(`quizQuestions/${today}`).once('value');
                if (!qSnap.exists()) {
                    console.log('No questions exist for today');
                    document.getElementById('publishControlSectionAdmin').style.display = 'none';
                    return;
                }
                
                const pSnap = await db.ref(`quizPublished/${today}`).once('value');
                const publishData = pSnap.val();
                const isPublished = publishData && publishData.published === true;
                
                console.log('Publish data:', publishData);
                console.log('Is published:', isPublished);
                
                const publishControlSection = document.getElementById('publishControlSectionAdmin');
                const statusDiv = document.getElementById('publishStatusDisplayAdmin');
                
                if (!publishControlSection || !statusDiv) {
                    console.error('Could not find required elements');
                    return;
                }
                
                publishControlSection.style.display = 'block';
                
                // Recreate buttons HTML to force update
                const buttonsContainer = publishControlSection.querySelector('div[style*="display:flex"]');
                if (buttonsContainer) {
                    if (isPublished) {
                        console.log('Setting UP: UNPUBLISH button visible');
                        statusDiv.innerHTML = '<div style="background:#d4edda;padding:15px;border-radius:8px;border:2px solid #28a745"><p style="margin:0;color:#155724;font-weight:bold">‚úÖ Quiz is PUBLISHED - Students can see it</p><p style="margin:5px 0 0 0;color:#155724;font-size:13px">Published: ' + new Date(publishData.publishedAt).toLocaleString() + '</p></div>';
                        
                        buttonsContainer.innerHTML = `
                            <button class="btn btn-success" onclick="publishTodayQuiz()" id="btnPublishAdmin" style="display:none">‚úÖ PUBLISH Quiz (Make Live)</button>
                            <button class="btn btn-danger" onclick="unpublishTodayQuiz()" id="btnUnpublishAdmin" style="display:inline-block">‚ùå UNPUBLISH Quiz (Hide)</button>
                        `;
                    } else {
                        console.log('Setting UP: PUBLISH button visible');
                        statusDiv.innerHTML = '<div style="background:#fff3cd;padding:15px;border-radius:8px;border:2px solid #ffc107"><p style="margin:0;color:#856404;font-weight:bold">‚ö†Ô∏è Quiz is DRAFT - Not visible to students</p><p style="margin:5px 0 0 0;color:#856404;font-size:13px">Click PUBLISH to make it visible</p></div>';
                        
                        buttonsContainer.innerHTML = `
                            <button class="btn btn-success" onclick="publishTodayQuiz()" id="btnPublishAdmin" style="display:inline-block">‚úÖ PUBLISH Quiz (Make Live)</button>
                            <button class="btn btn-danger" onclick="unpublishTodayQuiz()" id="btnUnpublishAdmin" style="display:none">‚ùå UNPUBLISH Quiz (Hide)</button>
                        `;
                    }
                    console.log('Buttons HTML updated successfully');
                }
                
                console.log('=== checkPublishStatusForAdmin END ===');
            } catch (err) {
                console.error('Check publish error:', err);
            }
        }
        
        // ============================================
        // QUIZ DATE EDIT FUNCTIONS (Super Admin Only)
        // ============================================
        
        let selectedQuizForDateEdit = null;
        
        async function loadQuizzesForDateEdit() {
            try {
                const snapshot = await db.ref('quizQuestions').once('value');
                const quizzes = snapshot.val() || {};
                const quizListContainer = document.getElementById('quizListForDateEdit');
                
                if (Object.keys(quizzes).length === 0) {
                    quizListContainer.innerHTML = '<p style="text-align:center;color:#666;">No quizzes available to edit.</p>';
                    return;
                }
                
                let html = '';
                // Sort by date descending
                Object.entries(quizzes).sort((a, b) => b[0].localeCompare(a[0])).forEach(([date, quiz]) => {
                    const question1Preview = quiz.q1 ? quiz.q1.text.substring(0, 60) : (quiz.question1 ? quiz.question1.text.substring(0, 60) : '');
                    html += `
                        <div class="quiz-list-item" onclick="selectQuizForDateEdit('${date}')" id="quiz-item-${date}">
                            <div>
                                <div class="quiz-date-info">üìÖ ${date}</div>
                                <div class="quiz-question-preview">${question1Preview}${question1Preview.length >= 60 ? '...' : ''}</div>
                            </div>
                            <div>
                                <button class="btn btn-small btn-edit-date" onclick="event.stopPropagation(); selectQuizForDateEdit('${date}')">üìÖ Edit Date</button>
                            </div>
                        </div>
                    `;
                });
                
                quizListContainer.innerHTML = html;
            } catch (error) {
                console.error('Error loading quizzes for date edit:', error);
                showQuizMsg('dateChangeMessage', 'Error loading quizzes.', 'error');
            }
        }
        
        async function selectQuizForDateEdit(date) {
            try {
                const snapshot = await db.ref('quizQuestions/' + date).once('value');
                const quiz = snapshot.val();
                if (!quiz) return;
                
                selectedQuizForDateEdit = { date, ...quiz };
                
                // Highlight selected quiz
                document.querySelectorAll('.quiz-list-item').forEach(item => {
                    item.classList.remove('selected');
                });
                const selectedItem = document.getElementById('quiz-item-' + date);
                if (selectedItem) {
                    selectedItem.classList.add('selected');
                }
                
                // Show date change form
                document.getElementById('currentQuizDate').textContent = date;
                const questionPreview = quiz.q1 ? quiz.q1.text : (quiz.question1 ? quiz.question1.text : 'No question text');
                document.getElementById('currentQuizPreview').textContent = questionPreview;
                document.getElementById('newQuizDate').value = '';
                document.getElementById('dateChangeForm').style.display = 'block';
            } catch (error) {
                console.error('Error selecting quiz:', error);
                showQuizMsg('dateChangeMessage', 'Error selecting quiz.', 'error');
            }
        }
        
        function cancelDateEdit() {
            selectedQuizForDateEdit = null;
            document.getElementById('dateChangeForm').style.display = 'none';
            document.querySelectorAll('.quiz-list-item').forEach(item => {
                item.classList.remove('selected');
            });
            document.getElementById('dateChangeMessage').classList.remove('show');
        }
        
        async function updateQuizDate() {
            if (!selectedQuizForDateEdit) {
                showQuizMsg('dateChangeMessage', 'Please select a quiz first.', 'error');
                return;
            }
            
            const newDate = document.getElementById('newQuizDate').value;
            if (!newDate) {
                showQuizMsg('dateChangeMessage', 'Please select a new date.', 'error');
                return;
            }
            
            if (newDate === selectedQuizForDateEdit.date) {
                showQuizMsg('dateChangeMessage', 'New date must be different from current date.', 'error');
                return;
            }
            
            // Check if new date already has a quiz
            try {
                const snapshot = await db.ref('quizQuestions/' + newDate).once('value');
                if (snapshot.exists()) {
                    const confirmOverwrite = confirm(`A quiz already exists for ${newDate}. Do you want to overwrite it?`);
                    if (!confirmOverwrite) return;
                }
                
                // Show confirmation modal
                document.getElementById('dateEditModalMessage').innerHTML = `
                    <p>Are you sure you want to change the quiz date?</p>
                    <p style="margin-top:10px;"><strong>From:</strong> <span style="color:#c44569;">${selectedQuizForDateEdit.date}</span></p>
                    <p><strong>To:</strong> <span style="color:#4CAF50;">${newDate}</span></p>
                    <p style="margin-top:15px;font-size:0.9em;color:#666;">This will move the quiz and its publish status to the new date.</p>
                `;
                document.getElementById('quizDateEditModal').style.display = 'block';
            } catch (error) {
                console.error('Error checking new date:', error);
                showQuizMsg('dateChangeMessage', 'Error checking new date.', 'error');
            }
        }
        
        async function confirmDateChange() {
            const oldDate = selectedQuizForDateEdit.date;
            const newDate = document.getElementById('newQuizDate').value;
            const autoPublish = document.getElementById('autoPublishAfterMove').checked;
            
            try {
                // Get all related data
                const quizSnapshot = await db.ref('quizQuestions/' + oldDate).once('value');
                const publishSnapshot = await db.ref('quizPublished/' + oldDate).once('value');
                const submissionsSnapshot = await db.ref('quizSubmissions/' + oldDate).once('value');
                const resultsSnapshot = await db.ref('quizResults/' + oldDate).once('value');
                
                const quizData = quizSnapshot.val();
                const publishData = publishSnapshot.val();
                const submissionsData = submissionsSnapshot.val();
                const resultsData = resultsSnapshot.val();
                
                if (!quizData) {
                    throw new Error('No quiz found at old date');
                }
                
                // Create array of all write operations
                const writeOperations = [];
                
                // Write quiz to new date
                writeOperations.push(db.ref('quizQuestions/' + newDate).set(quizData));
                
                // Handle publish status
                if (autoPublish) {
                    // Auto-publish at new date
                    writeOperations.push(db.ref('quizPublished/' + newDate).set({
                        published: true,
                        publishedAt: Date.now(),
                        publishedBy: 'Super Admin (via date change)'
                    }));
                } else if (publishData) {
                    // Keep existing publish status
                    writeOperations.push(db.ref('quizPublished/' + newDate).set(publishData));
                }
                
                // Move submissions if exist
                if (submissionsData) {
                    writeOperations.push(db.ref('quizSubmissions/' + newDate).set(submissionsData));
                }
                
                // Move results if exist
                if (resultsData) {
                    writeOperations.push(db.ref('quizResults/' + newDate).set(resultsData));
                }
                
                // Wait for ALL writes to complete
                await Promise.all(writeOperations);
                
                // Now delete old entries - create array of delete operations
                const deleteOperations = [];
                deleteOperations.push(db.ref('quizQuestions/' + oldDate).remove());
                
                if (publishData) {
                    deleteOperations.push(db.ref('quizPublished/' + oldDate).remove());
                }
                
                if (submissionsData) {
                    deleteOperations.push(db.ref('quizSubmissions/' + oldDate).remove());
                }
                
                if (resultsData) {
                    deleteOperations.push(db.ref('quizResults/' + oldDate).remove());
                }
                
                // Wait for ALL deletes to complete
                await Promise.all(deleteOperations);
                
                // Show success message
                closeQuizDateEditModal();
                const publishMsg = autoPublish ? ' and published' : '';
                showQuizMsg('dateChangeMessage', `Quiz date successfully changed from ${oldDate} to ${newDate}${publishMsg}!`, 'success');
                
                // Reload quiz list
                setTimeout(() => {
                    cancelDateEdit();
                    loadQuizzesForDateEdit();
                }, 2000);
                
            } catch (error) {
                console.error('Date change error:', error);
                closeQuizDateEditModal();
                showQuizMsg('dateChangeMessage', 'Failed to change quiz date. Please try again.', 'error');
            }
        }
        
        function closeQuizDateEditModal() {
            document.getElementById('quizDateEditModal').style.display = 'none';
        }
        
        function showQuizMsg(elementId, text, type) {
            const message = document.getElementById(elementId);
            if (message) {
                message.textContent = text;
                message.className = `message ${type} show`;
                setTimeout(() => {
                    message.classList.remove('show');
                }, 5000);
            }
        }
    </script>
    
    <!-- ============================================ -->
    <!-- CLASS OF THE YEAR 2026 LEADERBOARD           -->
    <!-- Pulls live data from Firebase automatically  -->
    <!-- ============================================ -->
    <style>
        /* ===== LEADERBOARD STYLES ===== */
        @import url('https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700;900&family=DM+Sans:wght@400;500;600&display=swap');

        @keyframes lbFadeUp {
            from { opacity:0; transform:translateY(40px); }
            to   { opacity:1; transform:translateY(0); }
        }
        @keyframes lbShine {
            0%   { background-position: -200% center; }
            100% { background-position: 200% center; }
        }
        @keyframes lbGlow {
            0%,100% { box-shadow: 0 0 20px rgba(196,69,105,0.3); }
            50%      { box-shadow: 0 0 40px rgba(196,69,105,0.6), 0 0 60px rgba(106,27,154,0.3); }
        }
        @keyframes lbPodiumRise {
            from { transform: scaleY(0); transform-origin: bottom; }
            to   { transform: scaleY(1); transform-origin: bottom; }
        }
        @keyframes lbSparkle {
            0%,100% { transform: scale(1) rotate(0deg); opacity:1; }
            50%      { transform: scale(1.3) rotate(180deg); opacity:0.8; }
        }
        @keyframes lbRowSlide {
            from { opacity:0; transform:translateX(-30px); }
            to   { opacity:1; transform:translateX(0); }
        }
        @keyframes lbCountUp {
            from { opacity:0; transform:scale(0.5); }
            to   { opacity:1; transform:scale(1); }
        }
        @keyframes lbCrownFloat {
            0%,100% { transform: translateY(0px) rotate(-5deg); }
            50%      { transform: translateY(-8px) rotate(5deg); }
        }
        @keyframes lbPulseRing {
            0%   { transform: scale(1); opacity:0.8; }
            100% { transform: scale(1.5); opacity:0; }
        }

        .lb-section {
            margin: 40px 0 30px;
            animation: lbFadeUp 0.8s ease-out;
        }

        /* --- Header --- */
        .lb-header {
            text-align: center;
            padding: 50px 30px 40px;
            background: linear-gradient(135deg, #1a0030 0%, #3d0060 40%, #6a1b9a 70%, #c44569 100%);
            border-radius: 24px 24px 0 0;
            position: relative;
            overflow: hidden;
        }
        .lb-header::before {
            content: '';
            position: absolute; inset: 0;
            background: repeating-linear-gradient(
                45deg,
                transparent, transparent 20px,
                rgba(255,255,255,0.03) 20px, rgba(255,255,255,0.03) 40px
            );
        }
        .lb-header-stars {
            position: absolute; inset: 0; pointer-events: none;
        }
        .lb-star {
            position: absolute;
            color: rgba(255,255,255,0.15);
            font-size: 1.2em;
            animation: lbSparkle 3s ease-in-out infinite;
        }
        .lb-crown {
            font-size: 4em;
            display: block;
            margin-bottom: 10px;
            animation: lbCrownFloat 3s ease-in-out infinite;
            position: relative; z-index:1;
        }
        .lb-title {
            font-family: 'Playfair Display', Georgia, serif;
            font-size: clamp(1.8em, 4vw, 3em);
            font-weight: 900;
            color: #fff;
            letter-spacing: 2px;
            margin-bottom: 6px;
            background: linear-gradient(90deg, #fff 0%, #ffd700 50%, #fff 100%);
            background-size: 200% auto;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            animation: lbShine 3s linear infinite;
            position: relative; z-index:1;
        }
        .lb-subtitle {
            font-family: 'DM Sans', sans-serif;
            color: rgba(255,255,255,0.75);
            font-size: 1em;
            letter-spacing: 4px;
            text-transform: uppercase;
            position: relative; z-index:1;
        }
        .lb-events-pills {
            display: flex;
            justify-content: center;
            gap: 12px;
            margin-top: 20px;
            flex-wrap: wrap;
            position: relative; z-index:1;
        }
        .lb-pill {
            background: rgba(255,255,255,0.12);
            border: 1px solid rgba(255,255,255,0.25);
            color: white;
            padding: 6px 18px;
            border-radius: 30px;
            font-size: 0.85em;
            font-family: 'DM Sans', sans-serif;
            backdrop-filter: blur(8px);
        }

        /* --- Body card --- */
        .lb-body {
            background: white;
            border-radius: 0 0 24px 24px;
            box-shadow: 0 20px 60px rgba(106,27,154,0.15);
            overflow: hidden;
        }

        /* --- Scoring legend --- */
        .lb-legend {
            display: flex;
            gap: 10px;
            padding: 20px 30px;
            background: #faf5ff;
            border-bottom: 2px solid #f0e6ff;
            flex-wrap: wrap;
            align-items: center;
        }
        .lb-legend-title {
            font-family: 'DM Sans', sans-serif;
            font-weight: 600;
            color: #6a1b9a;
            font-size: 0.9em;
            margin-right: 6px;
        }
        .lb-legend-item {
            display: flex;
            align-items: center;
            gap: 6px;
            background: white;
            border: 1px solid #e0d0f0;
            border-radius: 20px;
            padding: 5px 14px;
            font-size: 0.82em;
            font-family: 'DM Sans', sans-serif;
            color: #444;
        }
        .lb-legend-dot {
            width: 10px; height: 10px;
            border-radius: 50%;
        }

        /* --- Top 3 Podium --- */
        .lb-podium-section {
            padding: 40px 30px 20px;
            background: linear-gradient(180deg, #fdf6ff 0%, #ffffff 100%);
        }
        .lb-podium-title {
            text-align: center;
            font-family: 'Playfair Display', serif;
            color: #6a1b9a;
            font-size: 1.4em;
            margin-bottom: 30px;
            font-weight: 700;
        }
        .lb-podium {
            display: flex;
            align-items: flex-end;
            justify-content: center;
            gap: 16px;
            max-width: 600px;
            margin: 0 auto;
        }
        .lb-podium-slot {
            flex: 1;
            text-align: center;
            max-width: 180px;
        }
        .lb-podium-name {
            font-family: 'DM Sans', sans-serif;
            font-weight: 600;
            font-size: 0.85em;
            color: #333;
            margin-bottom: 8px;
            line-height: 1.3;
            word-break: break-word;
        }
        .lb-podium-score {
            font-family: 'Playfair Display', serif;
            font-weight: 700;
            font-size: 1.1em;
            color: #6a1b9a;
            margin-bottom: 8px;
        }
        .lb-podium-block {
            border-radius: 12px 12px 0 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.5em;
            position: relative;
            overflow: hidden;
            animation: lbPodiumRise 0.8s ease-out;
        }
        .lb-podium-block::after {
            content: '';
            position: absolute; inset: 0;
            background: linear-gradient(180deg, rgba(255,255,255,0.2) 0%, transparent 100%);
        }
        .lb-pos-1 .lb-podium-block {
            height: 130px;
            background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
            box-shadow: 0 8px 25px rgba(255,165,0,0.4);
        }
        .lb-pos-2 .lb-podium-block {
            height: 100px;
            background: linear-gradient(135deg, #C0C0C0 0%, #A8A8A8 100%);
            box-shadow: 0 6px 20px rgba(150,150,150,0.3);
        }
        .lb-pos-3 .lb-podium-block {
            height: 75px;
            background: linear-gradient(135deg, #CD7F32 0%, #A0522D 100%);
            box-shadow: 0 5px 15px rgba(160,82,45,0.3);
        }
        .lb-pos-1 .lb-podium-name {
            font-size: 1em;
            color: #4a0080;
        }
        .lb-pos-1 .lb-podium-score {
            font-size: 1.3em;
            color: #c44569;
        }
        .lb-pos-1-ring {
            position: relative;
        }
        .lb-pos-1-ring::before {
            content: '';
            position: absolute;
            inset: -4px;
            border-radius: 50%;
            background: conic-gradient(#FFD700, #FF6B6B, #6A1B9A, #FFD700);
            z-index: -1;
            animation: lbPulseRing 2s ease-out infinite;
            opacity: 0;
        }

        /* --- Full Rankings Table --- */
        .lb-table-section {
            padding: 10px 30px 40px;
        }
        .lb-table-header {
            font-family: 'Playfair Display', serif;
            color: #6a1b9a;
            font-size: 1.2em;
            margin: 24px 0 16px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .lb-table-wrap {
            overflow-x: auto;
            border-radius: 16px;
            border: 2px solid #f0e6ff;
        }
        .lb-table {
            width: 100%;
            border-collapse: collapse;
            min-width: 560px;
            font-family: 'DM Sans', sans-serif;
        }
        .lb-table thead tr {
            background: linear-gradient(135deg, #c44569 0%, #6a1b9a 100%);
        }
        .lb-table thead th {
            color: white;
            padding: 14px 18px;
            font-size: 0.85em;
            font-weight: 600;
            letter-spacing: 0.5px;
            text-align: left;
            white-space: nowrap;
        }
        .lb-table tbody tr {
            border-bottom: 1px solid #f5eeff;
            transition: all 0.25s;
            animation: lbRowSlide 0.4s ease-out both;
        }
        .lb-table tbody tr:hover {
            background: #fdf5ff;
            transform: translateX(4px);
        }
        .lb-table tbody tr:last-child {
            border-bottom: none;
        }
        .lb-table tbody td {
            padding: 14px 18px;
            font-size: 0.92em;
            color: #333;
            white-space: nowrap;
        }
        .lb-rank-badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 34px; height: 34px;
            border-radius: 50%;
            font-weight: 700;
            font-size: 0.95em;
        }
        .lb-rank-1 { background: linear-gradient(135deg,#FFD700,#FFA500); color:#333; box-shadow:0 3px 10px rgba(255,165,0,0.4); }
        .lb-rank-2 { background: linear-gradient(135deg,#C0C0C0,#A8A8A8); color:#333; box-shadow:0 3px 10px rgba(150,150,150,0.3); }
        .lb-rank-3 { background: linear-gradient(135deg,#CD7F32,#A0522D); color:#fff; box-shadow:0 3px 10px rgba(160,82,45,0.3); }
        .lb-rank-other { background: #f0e6ff; color:#6a1b9a; }
        .lb-class-chip {
            background: linear-gradient(135deg, #f3e5ff 0%, #e8d5ff 100%);
            color: #6a1b9a;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.82em;
            font-weight: 600;
            display: inline-block;
        }
        .lb-pts-total {
            font-weight: 700;
            color: #c44569;
            font-size: 1.05em;
        }
        .lb-pts-event {
            font-size: 0.82em;
            color: #888;
        }
        .lb-bar-wrap {
            background: #f5eeff;
            border-radius: 10px;
            height: 8px;
            min-width: 80px;
            overflow: hidden;
        }
        .lb-bar-fill {
            height: 100%;
            border-radius: 10px;
            background: linear-gradient(90deg, #c44569, #6a1b9a);
            transition: width 1.2s ease;
        }
        .lb-loading {
            text-align: center;
            padding: 60px 20px;
            color: #aaa;
            font-family: 'DM Sans', sans-serif;
        }
        .lb-loading-spinner {
            width: 40px; height: 40px;
            border: 4px solid #f0e6ff;
            border-top-color: #c44569;
            border-radius: 50%;
            margin: 0 auto 16px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { to { transform:rotate(360deg); } }

        .lb-empty {
            text-align: center;
            padding: 50px 20px;
            color: #bbb;
            font-family: 'DM Sans', sans-serif;
            font-size: 1.1em;
        }
        .lb-last-updated {
            text-align: center;
            font-family: 'DM Sans', sans-serif;
            font-size: 0.8em;
            color: #bbb;
            padding: 15px;
            border-top: 1px solid #f5eeff;
        }
        .lb-refresh-btn {
            background: linear-gradient(135deg, #c44569 0%, #6a1b9a 100%);
            color: white;
            border: none;
            padding: 8px 20px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.85em;
            font-family: 'DM Sans', sans-serif;
            font-weight: 600;
            margin-left: 10px;
            transition: all 0.3s;
        }
        .lb-refresh-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(196,69,105,0.35);
        }

        /* Scoring breakdown popover */
        .lb-breakdown {
            display: inline-flex;
            gap: 6px;
            flex-wrap: wrap;
        }
        .lb-score-tag {
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.75em;
            font-weight: 600;
        }
        .lb-score-yf   { background:#fff3cd; color:#856404; border:1px solid #ffc107; }
        .lb-score-quiz { background:#d4edda; color:#155724; border:1px solid #28a745; }

        @media (max-width: 600px) {
            .lb-podium { gap: 8px; }
            .lb-table-section, .lb-legend { padding-left: 15px; padding-right: 15px; }
            .lb-pos-1 .lb-podium-block { height: 100px; }
            .lb-pos-2 .lb-podium-block { height: 75px; }
            .lb-pos-3 .lb-podium-block { height: 55px; }
        }
    </style>

    <div class="lb-section" id="leaderboardSection">

        <!-- Header -->
        <div class="lb-header">
            <div class="lb-header-stars" id="lbStars"></div>
            <span class="lb-crown">üëë</span>
            <div class="lb-title">Class of the Year 2026</div>
            <div class="lb-subtitle">Spurthi Youth Fest ¬∑ Overall Rankings</div>
            <div class="lb-events-pills">
                <span class="lb-pill">üé§ Youthfest Registration</span>
                <span class="lb-pill">üß† Online Quiz Competition</span>
            </div>
        </div>

        <!-- Body -->
        <!-- Hidden-by-default gate; shown only when leaderboard is published -->
        <div id="lbHiddenMsg" style="display:none;border-radius:0 0 24px 24px;overflow:hidden">

            <!-- ‚îÄ‚îÄ COMING SOON BANNER (always shown when hidden) ‚îÄ‚îÄ -->
            <div style="text-align:center;padding:50px 30px 40px;background:linear-gradient(135deg,#1a0030 0%,#3d0060 40%,#6a1b9a 70%,#c44569 100%);position:relative">
                <div style="position:absolute;inset:0;background:repeating-linear-gradient(45deg,transparent,transparent 20px,rgba(255,255,255,0.02) 20px,rgba(255,255,255,0.02) 40px)"></div>
                <div style="position:relative;z-index:1">
                    <div style="font-size:3em;margin-bottom:14px">üîí</div>
                    <!-- Editable heading -->
                    <div id="hwpHeadingView">
                        <h2 id="hwpHeadingText" style="color:#ffd700;margin-bottom:10px;font-size:1.8em;letter-spacing:1px;text-shadow:0 0 20px rgba(255,215,0,0.4)">Leaderboard Coming Soon!</h2>
                    </div>
                    <div id="hwpHeadingEdit" style="display:none;margin-bottom:10px">
                        <input id="hwpHeadingInput" type="text" style="width:80%;max-width:500px;padding:10px 16px;border-radius:8px;border:2px solid #ffd700;background:rgba(255,255,255,0.1);color:#ffd700;font-size:1.3em;font-weight:700;text-align:center;outline:none">
                    </div>
                    <!-- Editable sub-text -->
                    <div id="hwpSubView">
                        <p id="hwpSubText" style="color:rgba(255,255,255,0.8);font-size:1em;margin:0">Results will be published by the Super Admin once the events are completed.<br>Check back soon!</p>
                    </div>
                    <div id="hwpSubEdit" style="display:none;margin-top:8px">
                        <textarea id="hwpSubInput" rows="2" style="width:80%;max-width:500px;padding:10px 14px;border-radius:8px;border:2px solid rgba(255,255,255,0.4);background:rgba(255,255,255,0.1);color:white;font-size:0.95em;text-align:center;outline:none;resize:vertical"></textarea>
                    </div>
                    <!-- Super Admin edit controls (only shown when SA logged in) -->
                    <div id="hwpBannerEditControls" class="super-admin-only" style="display:none;margin-top:16px;gap:8px;flex-wrap:wrap;justify-content:center">
                        <button onclick="hwpToggleBannerEdit()" id="hwpBannerEditBtn" style="background:rgba(255,215,0,0.2);color:#ffd700;border:1px solid #ffd700;padding:6px 16px;border-radius:6px;cursor:pointer;font-size:13px;font-weight:600">‚úèÔ∏è Edit Banner Text</button>
                        <button onclick="hwpSaveBanner()" id="hwpBannerSaveBtn" style="display:none;background:#ffd700;color:#1a0030;border:none;padding:6px 16px;border-radius:6px;cursor:pointer;font-size:13px;font-weight:700">üíæ Save</button>
                        <button onclick="hwpCancelBannerEdit()" id="hwpBannerCancelBtn" style="display:none;background:rgba(255,255,255,0.15);color:white;border:1px solid rgba(255,255,255,0.3);padding:6px 16px;border-radius:6px;cursor:pointer;font-size:13px">Cancel</button>
                        <span id="hwpBannerSaveMsg" style="display:none;background:rgba(40,167,69,0.3);color:#a5d6a7;border:1px solid #28a745;padding:5px 12px;border-radius:6px;font-size:12px;font-weight:600">‚úÖ Saved!</span>
                    </div>
                </div>
            </div>

            <!-- ‚îÄ‚îÄ HOW WE PUBLISH ‚Äî full section (white card below banner) ‚îÄ‚îÄ -->
            <div style="background:white">

                <!-- Section header with SA edit toggle -->
                <div style="background:linear-gradient(135deg,#f3e5ff,#fce4ec);padding:20px 28px;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:10px;border-bottom:2px solid #e8d5f5">
                    <div style="display:flex;align-items:center;gap:10px">
                        <span style="font-size:1.5em">üìã</span>
                        <div>
                            <h3 id="hwpSectionTitle" style="color:#3d0060;margin:0;font-size:1.1em;font-weight:800">How We Publish the Leaderboard</h3>
                            <p style="color:#666;margin:3px 0 0;font-size:12px">Transparent process ‚Äî Spurthi Youth Fest 2026</p>
                        </div>
                    </div>
                    <!-- SA edit mode toggle -->
                    <div id="hwpEditModeControls" class="super-admin-only" style="display:none;gap:8px">
                        <button onclick="hwpToggleEditMode()" id="hwpEditModeBtn" style="background:linear-gradient(135deg,#6a1b9a,#c44569);color:white;border:none;padding:7px 16px;border-radius:6px;cursor:pointer;font-size:13px;font-weight:600">‚úèÔ∏è Edit This Section</button>
                        <button onclick="hwpSaveAll()" id="hwpSaveAllBtn" style="display:none;background:#28a745;color:white;border:none;padding:7px 16px;border-radius:6px;cursor:pointer;font-size:13px;font-weight:700">üíæ Save All Changes</button>
                        <button onclick="hwpCancelEdit()" id="hwpCancelBtn" style="display:none;background:#666;color:white;border:none;padding:7px 16px;border-radius:6px;cursor:pointer;font-size:13px">‚úï Cancel</button>
                        <span id="hwpSaveAllMsg" style="display:none;background:#d4edda;color:#155724;border:1px solid #c3e6cb;padding:5px 12px;border-radius:6px;font-size:12px;font-weight:600">‚úÖ All changes saved!</span>
                    </div>
                </div>

                <div style="padding:24px 28px">

                    <!-- Overview text ‚Äî editable -->
                    <div id="hwpOverviewView" style="background:linear-gradient(135deg,#f3e5ff,#fce4ec);border-radius:10px;padding:16px 18px;margin-bottom:22px;border-left:4px solid #6a1b9a">
                        <p id="hwpOverviewText" style="margin:0;color:#3d0060;font-size:13.5px;line-height:1.75">The <strong style="color:#c44569">Class of the Year 2026</strong> leaderboard ranks all <strong>11 classes</strong> competing across <strong>16 events</strong> at Spurthi Youth Fest. Rankings are hidden until the Super Admin verifies all results and officially publishes them ‚Äî ensuring every score is accurate before you see it.</p>
                    </div>
                    <div id="hwpOverviewEdit" style="display:none;margin-bottom:22px">
                        <label style="font-size:12px;color:#6a1b9a;font-weight:700;display:block;margin-bottom:6px">Overview paragraph (supports basic HTML like &lt;strong&gt;):</label>
                        <textarea id="hwpOverviewInput" rows="4" style="width:100%;padding:10px 14px;border:2px solid #6a1b9a;border-radius:8px;font-size:13px;line-height:1.6;resize:vertical;outline:none"></textarea>
                    </div>

                    <!-- Points breakdown ‚Äî 4 editable cards -->
                    <h4 style="color:#1a0030;font-size:1em;margin:0 0 12px;display:flex;align-items:center;gap:8px">
                        <span style="background:linear-gradient(135deg,#6a1b9a,#c44569);color:white;border-radius:50%;width:24px;height:24px;display:inline-flex;align-items:center;justify-content:center;font-size:11px;flex-shrink:0;font-weight:700">1</span>
                        How Points Are Calculated
                    </h4>
                    <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px;margin-bottom:24px" id="hwpPointsGrid">

                        <div style="background:#fffde7;border-radius:10px;padding:15px;border-top:4px solid #ffc107" data-hwp-card="0">
                            <div style="display:flex;align-items:center;gap:8px;margin-bottom:7px"><span style="font-size:1.3em">üé§</span><strong id="hwpCard0Title" style="color:#856404;font-size:0.9em">Youthfest Registration</strong></div>
                            <p id="hwpCard0Body" style="margin:0;color:#555;font-size:12.5px;line-height:1.6">Each class earns points for <strong>every event they enrol in</strong>. More participation = more points for your class.</p>
                            <div class="hwpCardEditArea" style="display:none;margin-top:8px">
                                <input type="text" class="hwpCardTitleInput" data-idx="0" placeholder="Card title" style="width:100%;padding:5px 8px;border:1px solid #ffc107;border-radius:4px;font-size:12px;margin-bottom:5px">
                                <textarea class="hwpCardBodyInput" data-idx="0" rows="3" placeholder="Card body text" style="width:100%;padding:5px 8px;border:1px solid #ffc107;border-radius:4px;font-size:12px;resize:vertical"></textarea>
                            </div>
                        </div>

                        <div style="background:#e8f5e9;border-radius:10px;padding:15px;border-top:4px solid #28a745" data-hwp-card="1">
                            <div style="display:flex;align-items:center;gap:8px;margin-bottom:7px"><span style="font-size:1.3em">üß†</span><strong id="hwpCard1Title" style="color:#155724;font-size:0.9em">Quiz Competition</strong></div>
                            <p id="hwpCard1Body" style="margin:0;color:#555;font-size:12.5px;line-height:1.6">Per published quiz day: <strong>flat bonus</strong> to the winner &amp; runner-up class, plus a <strong>participation rate bonus</strong> ‚Äî fair across all class sizes.</p>
                            <div class="hwpCardEditArea" style="display:none;margin-top:8px">
                                <input type="text" class="hwpCardTitleInput" data-idx="1" placeholder="Card title" style="width:100%;padding:5px 8px;border:1px solid #28a745;border-radius:4px;font-size:12px;margin-bottom:5px">
                                <textarea class="hwpCardBodyInput" data-idx="1" rows="3" placeholder="Card body text" style="width:100%;padding:5px 8px;border:1px solid #28a745;border-radius:4px;font-size:12px;resize:vertical"></textarea>
                            </div>
                        </div>

                        <div style="background:#f3e5ff;border-radius:10px;padding:15px;border-top:4px solid #6a1b9a" data-hwp-card="2">
                            <div style="display:flex;align-items:center;gap:8px;margin-bottom:7px"><span style="font-size:1.3em">üèÜ</span><strong id="hwpCard2Title" style="color:#4a148c;font-size:0.9em">Event Results</strong></div>
                            <p id="hwpCard2Body" style="margin:0;color:#555;font-size:12.5px;line-height:1.6">When jury results are published, the <strong>1st place class</strong> gets winner pts and <strong>2nd place</strong> gets runner-up pts ‚Äî automatically calculated.</p>
                            <div class="hwpCardEditArea" style="display:none;margin-top:8px">
                                <input type="text" class="hwpCardTitleInput" data-idx="2" placeholder="Card title" style="width:100%;padding:5px 8px;border:1px solid #6a1b9a;border-radius:4px;font-size:12px;margin-bottom:5px">
                                <textarea class="hwpCardBodyInput" data-idx="2" rows="3" placeholder="Card body text" style="width:100%;padding:5px 8px;border:1px solid #6a1b9a;border-radius:4px;font-size:12px;resize:vertical"></textarea>
                            </div>
                        </div>

                        <div style="background:#e0f7fa;border-radius:10px;padding:15px;border-top:4px solid #17a2b8" data-hwp-card="3">
                            <div style="display:flex;align-items:center;gap:8px;margin-bottom:7px"><span style="font-size:1.3em">‚ú®</span><strong id="hwpCard3Title" style="color:#0c5460;font-size:0.9em">Special / Custom Criteria</strong></div>
                            <p id="hwpCard3Body" style="margin:0;color:#555;font-size:12.5px;line-height:1.6">The Super Admin may add bonus points for criteria like discipline, attendance, best decorated class, or other special achievements.</p>
                            <div class="hwpCardEditArea" style="display:none;margin-top:8px">
                                <input type="text" class="hwpCardTitleInput" data-idx="3" placeholder="Card title" style="width:100%;padding:5px 8px;border:1px solid #17a2b8;border-radius:4px;font-size:12px;margin-bottom:5px">
                                <textarea class="hwpCardBodyInput" data-idx="3" rows="3" placeholder="Card body text" style="width:100%;padding:5px 8px;border:1px solid #17a2b8;border-radius:4px;font-size:12px;resize:vertical"></textarea>
                            </div>
                        </div>

                    </div>

                    <!-- Steps ‚Äî editable -->
                    <h4 style="color:#1a0030;font-size:1em;margin:0 0 12px;display:flex;align-items:center;gap:8px">
                        <span style="background:linear-gradient(135deg,#6a1b9a,#c44569);color:white;border-radius:50%;width:24px;height:24px;display:inline-flex;align-items:center;justify-content:center;font-size:11px;flex-shrink:0;font-weight:700">2</span>
                        How the Super Admin Publishes Results
                    </h4>
                    <div id="hwpStepsGrid" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:10px;margin-bottom:22px">
                        <!-- Steps rendered by JS from Firebase / defaults -->
                    </div>

                    <!-- Important notes ‚Äî editable textarea -->
                    <div style="background:#fff8e1;border-radius:10px;padding:15px 18px;border-left:4px solid #ffc107;margin-bottom:20px">
                        <h5 style="color:#856404;margin:0 0 8px;font-size:0.9em">‚ö†Ô∏è Important Notes</h5>
                        <div id="hwpNotesView">
                            <ul id="hwpNotesList" style="margin:0;padding-left:16px;color:#555;font-size:13px;line-height:1.9">
                                <li>Only the <strong>Super Admin</strong> can publish or hide the leaderboard.</li>
                                <li>All point calculations are <strong>fully automatic</strong> ‚Äî no manual tampering.</li>
                                <li>The leaderboard refreshes every <strong>60 seconds</strong> once live.</li>
                                <li>Rankings may be updated progressively as more results are published.</li>
                            </ul>
                        </div>
                        <div id="hwpNotesEdit" style="display:none;margin-top:8px">
                            <label style="font-size:11px;color:#856404;font-weight:700;display:block;margin-bottom:5px">One note per line:</label>
                            <textarea id="hwpNotesInput" rows="5" style="width:100%;padding:8px 12px;border:2px solid #ffc107;border-radius:6px;font-size:13px;line-height:1.7;resize:vertical;outline:none"></textarea>
                        </div>
                    </div>

                    <!-- Footer -->
                    <div style="text-align:center;padding-top:14px;border-top:1px solid #f0e6ff">
                        <p style="margin:0;color:#999;font-size:11.5px">
                            üéì <strong style="color:#6a1b9a">Spurthi Youth Fest 2026</strong> ¬∑ Davan Institute of Advanced Management Studies, Davangere<br>
                            <span style="font-size:10.5px">Platform by Harsha Gujjar, Director ‚Äî Davan College</span>
                        </p>
                    </div>

                </div>
            </div>
        </div>
        <div id="lbPublicBody" style="display:none">
        <div class="lb-body">

            <!-- Scoring Legend -->
            <div class="lb-legend">
                <span class="lb-legend-title">üìä Scoring:</span>
                <span class="lb-legend-item">
                    <span class="lb-legend-dot" style="background:#ffc107"></span>
                    Youthfest Reg: pts/event enrolled
                </span>
                <span class="lb-legend-item">
                    <span class="lb-legend-dot" style="background:#28a745"></span>
                    Quiz: pts/correct answer
                </span>
                <span class="lb-legend-item">
                    <span class="lb-legend-dot" style="background:#6a1b9a"></span>
                    üèÜ Event Results: winner/runner-up pts
                </span>
                <span class="lb-legend-item">
                    <span class="lb-legend-dot" style="background:#17a2b8"></span>
                    ‚ú® Special criteria pts
                </span>
                <button class="lb-refresh-btn" onclick="loadLeaderboard()">üîÑ Refresh</button>
            </div>

            <!-- Podium Top 3 -->
            <div class="lb-podium-section">
                <div class="lb-podium-title">üèÖ Top 3 Classes</div>
                <div class="lb-podium" id="lbPodium">
                    <div class="lb-loading">
                        <div class="lb-loading-spinner"></div>
                        Loading rankings‚Ä¶
                    </div>
                </div>
            </div>

            <!-- Full Rankings Table -->
            <div class="lb-table-section">
                <div class="lb-table-header">üìã Full Rankings</div>
                <div class="lb-table-wrap">
                    <table class="lb-table">
                        <thead>
                            <tr>
                                <th>Rank</th>
                                <th>Class</th>
                                <th>üé§ YF Reg</th>
                                <th>üß† Quiz</th>
                                <th>üèÜ Results</th>
                                <th>Total</th>
                                <th>Progress</th>
                            </tr>
                        </thead>
                        <tbody id="lbTableBody">
                            <tr>
                                <td colspan="6" style="text-align:center;padding:40px;color:#bbb">
                                    <div class="lb-loading-spinner" style="margin:0 auto 10px"></div>
                                    Loading‚Ä¶
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <div class="lb-last-updated" id="lbLastUpdated">Fetching live data‚Ä¶</div>
            </div>


        </div>
        </div><!-- /lbPublicBody -->
    </div><!-- /lb-section -->

    <script>
    // ============================================================
    //  CLASS OF THE YEAR 2026 ‚Äî LEADERBOARD ENGINE
    //  db is resolved via getDb() helper ‚Äî safe across all script blocks

    // ‚îÄ‚îÄ Safe Firebase db getter (works across separate <script> blocks) ‚îÄ‚îÄ
    function getDb() {
        if (window.db) return window.db;
        if (typeof db !== 'undefined' && db) return db;
        throw new Error("Firebase not initialised yet. Please wait and try again.");
    }

    //  Points:
    //    Youthfest Registration ‚Üí 10 pts per event a class enrolled in
    //    Online Quiz            ‚Üí 5 pts per correct answer per student per day
    // ============================================================

    // Star decoration in header
    (function spawnStars() {
        const container = document.getElementById('lbStars');
        if (!container) return;
        const symbols = ['‚ú¶','‚úß','‚ãÜ','‚òÖ','‚ú©'];
        for (let i = 0; i < 18; i++) {
            const s = document.createElement('span');
            s.className = 'lb-star';
            s.textContent = symbols[Math.floor(Math.random() * symbols.length)];
            s.style.top  = Math.random() * 100 + '%';
            s.style.left = Math.random() * 100 + '%';
            s.style.animationDelay = (Math.random() * 3) + 's';
            s.style.fontSize = (0.7 + Math.random() * 1.2) + 'em';
            container.appendChild(s);
        }
    })();
    // ============================================================
    //  LEADERBOARD ENGINE v3 ‚Äî FINAL
    //  Sources:
    //  1. Youthfest Registration  ‚Üí yfPtsPerEvent per event enrolled
    //  2. Quiz (per PUBLISHED day only):
    //       a) Winner class       ‚Üí quizWinnerPts (flat)
    //       b) Runner-up class    ‚Üí quizRunnerUpPts (flat)
    //       c) Participation rate ‚Üí (studentsWithMaxScore / classStrength) √ó quizMaxPts
    //          ‚Äî fair across classes of different sizes
    //  3. Youthfest event results ‚Üí winnerPts / runnerUpPts (jury published)
    //  4. Custom criteria         ‚Üí manual points from Super Admin
    //  Leaderboard itself hidden until Super Admin publishes it
    //  Config: leaderboardConfig/scoring | classStrengths | published | customCriteria
    // ============================================================

    const LB_CLASSES = [
        '1st B.Com','2nd B.Com','3rd B.Com',
        '1ST BCA','2ND BCA A SEC','2ND BCA B SEC',
        '3RD BCA A SEC','3RD BCA B SEC','3RD BCA C SEC',
        '2ND BBA','3RD BBA'
    ];

    let lbCfg = {
        yfPtsPerEvent: 10, winnerPts: 50, runnerUpPts: 30,
        quizWinnerPts: 20, quizRunnerUpPts: 10, quizMaxPts: 10
    };
    let lbClassStrengths = {}; // cls ‚Üí number of students

    async function getLbConfig() {
        try {
            const [cfgSnap, strSnap] = await Promise.all([
                getDb().ref('leaderboardConfig/scoring').once('value'),
                getDb().ref('leaderboardConfig/classStrengths').once('value')
            ]);
            if (cfgSnap.exists()) {
                const d = cfgSnap.val();
                lbCfg = {
                    yfPtsPerEvent:   d.yfPtsPerEvent   || 10,
                    winnerPts:       d.winnerPts        || 50,
                    runnerUpPts:     d.runnerUpPts      || 30,
                    quizWinnerPts:   d.quizWinnerPts    || 20,
                    quizRunnerUpPts: d.quizRunnerUpPts  || 10,
                    quizMaxPts:      d.quizMaxPts       || 10
                };
            }
            if (strSnap.exists()) {
                lbClassStrengths = strSnap.val() || {};
            }
        } catch(e) {}
        return lbCfg;
    }

    // ‚îÄ‚îÄ Check publish status and show/hide leaderboard ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    async function checkLbPublished() {
        try {
            const snap = await getDb().ref('leaderboardConfig/published').once('value');
            const pub = snap.val() === true;
            document.getElementById('lbPublicBody').style.display  = pub ? 'block' : 'none';
            document.getElementById('lbHiddenMsg').style.display   = pub ? 'none'  : 'block';
            return pub;
        } catch(e) {
            document.getElementById('lbHiddenMsg').style.display = 'block';
            return false;
        }
    }

    async function loadLeaderboard() {
        const pub = await checkLbPublished();
        if (!pub) return; // don't fetch data if not published

        try {
            const cfg = await getLbConfig();
            const init = () => { const o = {}; LB_CLASSES.forEach(c => o[c] = 0); return o; };

            const yfPts     = init();
            const quizPts   = init();
            const resultPts = init();
            const customPts = init();

            // ‚îÄ‚îÄ 1. Youthfest Registration ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            const yfSnap = await getDb().ref('youthfest-enrollments').once('value');
            if (yfSnap.exists()) {
                yfSnap.forEach(child => {
                    const d   = child.val();
                    const cls = d.classYear || d.class || '';
                    if (yfPts[cls] !== undefined) yfPts[cls] += cfg.yfPtsPerEvent;
                });
            }

            // ‚îÄ‚îÄ 2. Quiz Points (PUBLISHED DAYS ONLY) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            // Criteria:
            //   a) Flat bonus to winner's class
            //   b) Flat bonus to runner-up's class
            //   c) Participation-rate bonus ‚Äî fair across class sizes:
            //      count how many students in the class scored max (2/2)
            //      divide by class strength ‚Üí multiply by quizMaxPts
            //      if strength not set, falls back to raw max-correct √ó pts

            const quizResultsSnap = await getDb().ref('quizResults').once('value');
            const publishedDates    = new Set();
            const quizWinnersByDate = {};

            if (quizResultsSnap.exists()) {
                quizResultsSnap.forEach(dateNode => {
                    const res = dateNode.val();
                    if (res && res.winner && res.runnerUp) {
                        publishedDates.add(dateNode.key);
                        quizWinnersByDate[dateNode.key] = {
                            winnerClass: res.winner.class  || '',
                            runnerClass: res.runnerUp.class || ''
                        };
                    }
                });
            }

            if (publishedDates.size > 0) {
                const quizSubSnap = await getDb().ref('quizSubmissions').once('value');
                if (quizSubSnap.exists()) {
                    quizSubSnap.forEach(dateNode => {
                        const date = dateNode.key;
                        if (!publishedDates.has(date)) return;

                        const w = quizWinnersByDate[date];

                        // a) Winner class bonus
                        if (w.winnerClass && quizPts[w.winnerClass] !== undefined)
                            quizPts[w.winnerClass] += cfg.quizWinnerPts;

                        // b) Runner-up class bonus
                        if (w.runnerClass && quizPts[w.runnerClass] !== undefined)
                            quizPts[w.runnerClass] += cfg.quizRunnerUpPts;

                        // c) Participation-rate bonus per class
                        // Count students who scored the maximum (2/2) per class
                        const classMaxCount  = {}; // how many got max score
                        const classAnyCount  = {}; // how many attempted at all
                        const maxPossible    = 2;  // quiz has 2 questions

                        dateNode.forEach(subNode => {
                            const s  = subNode.val();
                            const cl = s.studentClass || '';
                            if (!LB_CLASSES.includes(cl)) return;
                            classAnyCount[cl]  = (classAnyCount[cl]  || 0) + 1;
                            if ((parseInt(s.score) || 0) >= maxPossible)
                                classMaxCount[cl] = (classMaxCount[cl] || 0) + 1;
                        });

                        LB_CLASSES.forEach(cl => {
                            if (!classAnyCount[cl]) return; // class didn't play
                            const strength = lbClassStrengths[cl.replace(/[.\[\]#$\/]/g,'_')]
                                          || lbClassStrengths[cl]
                                          || 0;
                            const topCount = classMaxCount[cl] || 0;
                            let bonus = 0;
                            if (strength > 0) {
                                // Fair formula: (top scorers / class size) √ó max pts
                                bonus = Math.round((topCount / strength) * cfg.quizMaxPts * 10) / 10;
                            } else {
                                // Fallback if strength not set: just use topCount √ó 1
                                bonus = topCount;
                            }
                            if (quizPts[cl] !== undefined) quizPts[cl] += bonus;
                        });
                    });
                }
            }

            // ‚îÄ‚îÄ 3. Published Youthfest Event Results ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            const setupSnap = await getDb().ref('jurySetup').once('value');
            if (setupSnap.exists()) {
                for (const [evName, setup] of Object.entries(setupSnap.val())) {
                    if (!setup.resultsPublished) continue;
                    const mSnap = await getDb().ref('juryMarks/' + evName).once('value');
                    if (!mSnap.exists()) continue;
                    const j1 = mSnap.val().jury1 || {}, j2 = mSnap.val().jury2 || {};
                    const allK = new Set([...Object.keys(j1), ...Object.keys(j2)]);
                    const evRes = [];
                    allK.forEach(sk => {
                        const d1=j1[sk], d2=j2[sk];
                        const cls=(d1&&d1.originalClassName)||(d2&&d2.originalClassName)||sk;
                        let t1=0,t2=0;
                        if(d1&&d1.marks)(Array.isArray(d1.marks)?d1.marks:Object.values(d1.marks)).forEach(m=>t1+=(m||0));
                        if(d2&&d2.marks)(Array.isArray(d2.marks)?d2.marks:Object.values(d2.marks)).forEach(m=>t2+=(m||0));
                        evRes.push({cls,avg:(t1+t2)/2});
                    });
                    evRes.sort((a,b)=>b.avg-a.avg);
                    if(evRes[0]&&resultPts[evRes[0].cls]!==undefined) resultPts[evRes[0].cls]+=cfg.winnerPts;
                    if(evRes[1]&&resultPts[evRes[1].cls]!==undefined) resultPts[evRes[1].cls]+=cfg.runnerUpPts;
                }
            }

            // ‚îÄ‚îÄ 4. Custom Criteria ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            const customSnap = await getDb().ref('leaderboardConfig/customCriteria').once('value');
            if (customSnap.exists()) {
                customSnap.forEach(critNode => {
                    const crit = critNode.val();
                    if (!crit || !crit.points) return;
                    Object.keys(crit.points).forEach(k => {
                        LB_CLASSES.forEach(cls => {
                            if (cls.replace(/[.\[\]#$\/]/g,'_') === k && customPts[cls] !== undefined)
                                customPts[cls] += (crit.points[k] || 0);
                        });
                    });
                });
            }

            // ‚îÄ‚îÄ 5. Merge, sort, render ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            const ranked = LB_CLASSES.map(cls => {
                const total=(yfPts[cls]||0)+(quizPts[cls]||0)+(resultPts[cls]||0)+(customPts[cls]||0);
                return {cls,yfPts:yfPts[cls]||0,quizPts:quizPts[cls]||0,resultPts:resultPts[cls]||0,customPts:customPts[cls]||0,total};
            }).sort((a,b)=>b.total-a.total||b.yfPts-a.yfPts||b.quizPts-a.quizPts);

            const maxTotal = ranked[0]?.total || 1;
            renderPodium(ranked.slice(0,3));
            renderTable(ranked, maxTotal);

            const now = new Date();
            document.getElementById('lbLastUpdated').textContent =
                '‚è± Last updated: ' + now.toLocaleTimeString('en-IN',{hour:'2-digit',minute:'2-digit',second:'2-digit'})
                + ' ¬∑ Quiz: ' + publishedDates.size + ' day' + (publishedDates.size!==1?'s':'')+' counted';

        } catch (err) {
            console.error('Leaderboard error:', err);
            document.getElementById('lbPodium').innerHTML='<div class="lb-empty">‚ö†Ô∏è Could not load data. Please refresh.</div>';
            document.getElementById('lbTableBody').innerHTML='<tr><td colspan="7" class="lb-empty">‚ö†Ô∏è Could not load data.</td></tr>';
        }
    }

    function medalEmoji(rank) { return ['ü•á','ü•à','ü•â'][rank]||''; }
    function podiumEmoji(rank) { return ['1Ô∏è‚É£','2Ô∏è‚É£','3Ô∏è‚É£'][rank]||''; }

    function renderPodium(top3) {
        const podium = document.getElementById('lbPodium');
        if (!top3||top3.length===0||top3[0].total===0) {
            podium.innerHTML='<div class="lb-empty">No scores yet. Scores will appear once events begin! üéâ</div>';
            return;
        }
        const order=[top3[1],top3[0],top3[2]].filter(Boolean);
        const posClass=['lb-pos-2','lb-pos-1','lb-pos-3'];
        const actualRank=[2,1,3];
        let html='';
        order.forEach((entry,i)=>{
            const rank=actualRank[i], isFirst=rank===1;
            html+=`<div class="lb-podium-slot ${posClass[i]}">
                <div class="lb-podium-name">${isFirst?'üëë ':''}${entry.cls}</div>
                <div class="lb-podium-score">${entry.total} pts</div>
                <div class="lb-podium-block">${podiumEmoji(rank-1)}</div>
            </div>`;
        });
        podium.innerHTML=html;
    }

    function renderTable(ranked, maxTotal) {
        const tbody=document.getElementById('lbTableBody');
        if(!ranked||ranked.length===0){tbody.innerHTML='<tr><td colspan="7" class="lb-empty">No data yet!</td></tr>';return;}
        let html='';
        ranked.forEach((entry,i)=>{
            const rank=i+1;
            const rankClass=rank<=3?`lb-rank-${rank}`:'lb-rank-other';
            const rankMedal=rank<=3?medalEmoji(rank-1):rank;
            const barPct=maxTotal>0?Math.round((entry.total/maxTotal)*100):0;
            const delay=(i*0.05).toFixed(2);
            const rowBg=rank===1?'background:linear-gradient(90deg,#fffbea,#fff);':rank===2?'background:linear-gradient(90deg,#f8f8f8,#fff);':rank===3?'background:linear-gradient(90deg,#fff5f0,#fff);':'';
            const resBadge=entry.resultPts>0?`<span class="lb-score-tag" style="background:#d4edda;color:#155724;border:1px solid #28a745">üèÜ ${entry.resultPts}</span> `:'';
            const custBadge=entry.customPts>0?`<span class="lb-score-tag" style="background:#e8f4fd;color:#0c5460;border:1px solid #17a2b8">‚ú® ${entry.customPts}</span>`:'';
            html+=`<tr style="${rowBg}animation-delay:${delay}s">
                <td><span class="lb-rank-badge ${rankClass}">${rankMedal}</span></td>
                <td><span class="lb-class-chip">${entry.cls}</span></td>
                <td><span class="lb-score-tag lb-score-yf">üé§ ${entry.yfPts}</span></td>
                <td><span class="lb-score-tag lb-score-quiz">üß† ${entry.quizPts}</span></td>
                <td>${resBadge}${custBadge||(entry.resultPts===0&&entry.customPts===0?'<span style="color:#ddd">‚Äî</span>':'')}</td>
                <td><span class="lb-pts-total">${entry.total}</span> <span class="lb-pts-event">pts</span></td>
                <td><div class="lb-bar-wrap"><div class="lb-bar-fill" style="width:${barPct}%"></div></div></td>
            </tr>`;
        });
        tbody.innerHTML=html;
    }

    // ‚îÄ‚îÄ Auto-load ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    (function lbInit() {
        function tryLoad() {
            if (typeof db !== 'undefined' && db) {
                loadLeaderboard();
                setInterval(loadLeaderboard, 60000);
            } else {
                setTimeout(tryLoad, 800);
            }
        }
        tryLoad();
    })();

    // ============================================================
    //  LEADERBOARD ADMIN PANEL FUNCTIONS (Super Admin only)
    // ============================================================

    async function toggleLeaderboardPublish() {
        const btn    = document.getElementById('lbPublishBtn');
        const status = document.getElementById('lbVisibilityStatus');
        try {
            const snap = await getDb().ref('leaderboardConfig/published').once('value');
            const current = snap.val() === true;
            const next = !current;
            await getDb().ref('leaderboardConfig/published').set(next);
            updateLbPublishUI(next);
            showLbAdminMsg(next
                ? '‚úÖ Leaderboard is now LIVE ‚Äî students can see it!'
                : 'üîí Leaderboard hidden ‚Äî students cannot see it.',
                next ? 'success' : 'error');
        } catch(err) {
            showLbAdminMsg('‚ùå Error: ' + err.message, 'error');
        }
    }

    function updateLbPublishUI(isPublished) {
        const btn    = document.getElementById('lbPublishBtn');
        const status = document.getElementById('lbVisibilityStatus');
        if (!btn || !status) return;
        if (isPublished) {
            status.textContent = '‚úÖ LIVE ‚Äî Students can see it';
            status.style.color = '#69f0ae';
            btn.textContent    = 'üîí Hide Leaderboard';
            btn.className      = 'btn btn-danger';
        } else {
            status.textContent = 'üîí Hidden from students';
            status.style.color = '#ffd700';
            btn.textContent    = 'üì¢ Publish Leaderboard';
            btn.className      = 'btn btn-success';
        }
    }

    async function loadLbPublishStatus() {
        try {
            const snap = await getDb().ref('leaderboardConfig/published').once('value');
            updateLbPublishUI(snap.val() === true);
        } catch(e) {
            updateLbPublishUI(false);
        }
    }

    async function saveLbConfig() {
        const btn = document.querySelector('[onclick="saveLbConfig()"]');
        const okEl  = document.getElementById('lbCfgSaveMsg');
        const errEl = document.getElementById('lbCfgErrMsg');
        if (okEl)  okEl.style.display  = 'none';
        if (errEl) errEl.style.display = 'none';
        if (btn) { btn.disabled = true; btn.textContent = '‚è≥ Saving‚Ä¶'; }
        const yfPts   = parseInt(document.getElementById('lbCfgYfPts').value)      || 10;
        const winPts  = parseInt(document.getElementById('lbCfgWinPts').value)     || 50;
        const runPts  = parseInt(document.getElementById('lbCfgRunPts').value)     || 30;
        const qWin    = parseInt(document.getElementById('lbCfgQuizWinPts').value) || 20;
        const qRun    = parseInt(document.getElementById('lbCfgQuizRunPts').value) || 10;
        const qMax    = parseInt(document.getElementById('lbCfgQuizMaxPts').value) || 10;
        try {
            await getDb().ref('leaderboardConfig/scoring').set({
                yfPtsPerEvent: yfPts, winnerPts: winPts, runnerUpPts: runPts,
                quizWinnerPts: qWin, quizRunnerUpPts: qRun, quizMaxPts: qMax,
                updatedAt: new Date().toISOString()
            });
            document.getElementById('lbWinPtsDisplay').textContent = winPts;
            document.getElementById('lbRunPtsDisplay').textContent = runPts;
            if (okEl)  { okEl.style.display  = 'inline-block'; setTimeout(() => okEl.style.display  = 'none', 4000); }
            showLbAdminMsg('‚úÖ Config saved! Leaderboard refreshes in ‚â§60 s.', 'success');
        } catch(err) {
            if (errEl) { errEl.textContent = '‚ùå Error: ' + err.message; errEl.style.display = 'inline-block'; setTimeout(() => errEl.style.display = 'none', 6000); }
            showLbAdminMsg('‚ùå Error: ' + err.message, 'error');
        } finally {
            if (btn) { btn.disabled = false; btn.textContent = 'üíæ Save Config'; }
        }
    }

    async function loadLbConfigIntoForm() {
        await loadLbPublishStatus();
        try {
            const [cfgSnap, strSnap] = await Promise.all([
                getDb().ref('leaderboardConfig/scoring').once('value'),
                getDb().ref('leaderboardConfig/classStrengths').once('value')
            ]);
            if (cfgSnap.exists()) {
                const d = cfgSnap.val();
                document.getElementById('lbCfgYfPts').value       = d.yfPtsPerEvent   || 10;
                document.getElementById('lbCfgWinPts').value      = d.winnerPts        || 50;
                document.getElementById('lbCfgRunPts').value      = d.runnerUpPts      || 30;
                document.getElementById('lbCfgQuizWinPts').value  = d.quizWinnerPts    || 20;
                document.getElementById('lbCfgQuizRunPts').value  = d.quizRunnerUpPts  || 10;
                document.getElementById('lbCfgQuizMaxPts').value  = d.quizMaxPts       || 10;
                document.getElementById('lbWinPtsDisplay').textContent = d.winnerPts   || 50;
                document.getElementById('lbRunPtsDisplay').textContent = d.runnerUpPts || 30;
            }
            // Build class strength grid
            const savedStr = strSnap.exists() ? strSnap.val() : {};
            const grid = document.getElementById('lbClassStrengthGrid');
            if (grid) {
                let html = '';
                LB_CLASSES.forEach(cls => {
                    const safeKey = cls.replace(/[.\[\]#$\/]/g,'_');
                    const val = savedStr[safeKey] || savedStr[cls] || '';
                    const safeId = 'lbStr_' + cls.replace(/[^a-zA-Z0-9]/g,'_');
                    html += `<div style="display:flex;align-items:center;gap:6px;background:#f1f8e9;padding:7px 10px;border-radius:6px;border:1px solid #a5d6a7">
                        <span style="font-size:0.78em;color:#1b5e20;flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap" title="${cls}">${cls}</span>
                        <input type="number" id="${safeId}" value="${val}" min="1" max="200" placeholder="Count"
                            style="width:65px;padding:4px 6px;border:1px solid #a5d6a7;border-radius:4px;text-align:center;font-size:0.85em">
                    </div>`;
                });
                grid.innerHTML = html;
            }
        } catch(e) {
            console.error('loadLbConfigIntoForm error:', e);
            const grid = document.getElementById('lbClassStrengthGrid');
            if (grid) grid.innerHTML = '<p style="color:red;font-size:12px">‚ùå Failed to load: ' + e.message + '</p>';
        }
    }

    async function saveLbClassStrengths() {
        const btn = document.querySelector('[onclick="saveLbClassStrengths()"]');
        const okEl  = document.getElementById('lbStrSaveMsg');
        const errEl = document.getElementById('lbStrErrMsg');
        if (okEl)  okEl.style.display  = 'none';
        if (errEl) errEl.style.display = 'none';
        if (btn) { btn.disabled = true; btn.textContent = '‚è≥ Saving‚Ä¶'; }
        const obj = {};
        LB_CLASSES.forEach(cls => {
            const safeId  = 'lbStr_' + cls.replace(/[^a-zA-Z0-9]/g,'_');
            const safeKey = cls.replace(/[.\[\]#$\/]/g,'_');
            const inp = document.getElementById(safeId);
            if (inp && inp.value) obj[safeKey] = parseInt(inp.value) || 0;
        });
        try {
            await getDb().ref('leaderboardConfig/classStrengths').set(obj);
            if (okEl)  { okEl.style.display  = 'inline-block'; setTimeout(() => okEl.style.display  = 'none', 4000); }
            showLbAdminMsg('‚úÖ Class strengths saved! Quiz participation rates updated.', 'success');
        } catch(err) {
            if (errEl) { errEl.textContent = '‚ùå ' + err.message; errEl.style.display = 'inline-block'; setTimeout(() => errEl.style.display = 'none', 6000); }
            showLbAdminMsg('‚ùå Error: ' + err.message, 'error');
        } finally {
            if (btn) { btn.disabled = false; btn.textContent = 'üíæ Save Class Strengths'; }
        }
    }

    async function loadLbPublishedResults() {
        const container = document.getElementById('lbPublishedResultsList');
        container.innerHTML = '<p style="color:#aaa;font-size:13px">Loading‚Ä¶</p>';
        try {
            const cfg = await getLbConfig();
            const snap = await getDb().ref('jurySetup').once('value');
            if (!snap.exists()) {
                container.innerHTML = '<p style="color:#aaa;font-size:13px">No events set up yet.</p>';
                return;
            }
            let html = '<div class="table-wrapper"><table style="min-width:500px"><thead><tr><th>Event</th><th>Status</th><th>Winner Class</th><th>Runner-Up Class</th></tr></thead><tbody>';
            for (const [evName, setup] of Object.entries(snap.val())) {
                const pub = setup.resultsPublished ? '‚úÖ Published' : '‚è≥ Not published';
                let winner='‚Äî', runnerUp='‚Äî';
                if (setup.resultsPublished) {
                    const mSnap = await getDb().ref('juryMarks/'+evName).once('value');
                    if (mSnap.exists()) {
                        const j1=mSnap.val().jury1||{}, j2=mSnap.val().jury2||{};
                        const allK=new Set([...Object.keys(j1),...Object.keys(j2)]);
                        const evR=[];
                        allK.forEach(sk=>{
                            const d1=j1[sk],d2=j2[sk];
                            const cls=(d1&&d1.originalClassName)||(d2&&d2.originalClassName)||sk;
                            let t1=0,t2=0;
                            if(d1&&d1.marks)(Array.isArray(d1.marks)?d1.marks:Object.values(d1.marks)).forEach(m=>t1+=(m||0));
                            if(d2&&d2.marks)(Array.isArray(d2.marks)?d2.marks:Object.values(d2.marks)).forEach(m=>t2+=(m||0));
                            evR.push({cls,avg:(t1+t2)/2});
                        });
                        evR.sort((a,b)=>b.avg-a.avg);
                        if(evR[0]) winner=`<strong>${evR[0].cls}</strong> <span style="color:#c44569">+${cfg.winnerPts}pts</span>`;
                        if(evR[1]) runnerUp=`<strong>${evR[1].cls}</strong> <span style="color:#666">+${cfg.runnerUpPts}pts</span>`;
                    }
                }
                html+=`<tr><td><strong>${evName}</strong></td><td style="color:${setup.resultsPublished?'#155724':'#856404'}">${pub}</td><td>${winner}</td><td>${runnerUp}</td></tr>`;
            }
            html+='</tbody></table></div>';
            container.innerHTML=html;
        } catch(err) {
            container.innerHTML='<p style="color:red">Error: '+err.message+'</p>';
        }
    }

    async function addLbCriterion() {
        const name = document.getElementById('lbNewCriterionName').value.trim();
        if (!name) { showLbAdminMsg('Please enter a criterion name.','error'); return; }
        try {
            const key = getDb().ref('leaderboardConfig/customCriteria').push().key;
            await getDb().ref('leaderboardConfig/customCriteria/'+key).set({name,createdAt:new Date().toISOString(),points:{}});
            document.getElementById('lbNewCriterionName').value='';
            showLbAdminMsg('‚úÖ Criterion "'+name+'" added!','success');
            loadLbCriteriaList();
        } catch(err) { showLbAdminMsg('‚ùå Error: '+err.message,'error'); }
    }

    async function loadLbCriteriaList() {
        const container = document.getElementById('lbCriteriaList');
        container.innerHTML='<p style="color:#aaa;text-align:center;padding:20px;font-size:13px">Loading‚Ä¶</p>';
        try {
            const snap = await getDb().ref('leaderboardConfig/customCriteria').once('value');
            if (!snap.exists()) {
                container.innerHTML='<p style="color:#aaa;text-align:center;padding:20px;font-size:13px">No custom criteria yet. Add one above!</p>';
                return;
            }
            let html='';
            snap.forEach(critNode=>{
                const key=critNode.key, crit=critNode.val(), pts=crit.points||{};
                html+=`<div style="background:white;border:1px solid #ffe082;border-radius:10px;padding:15px;margin-bottom:15px">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;flex-wrap:wrap;gap:8px">
                        <strong style="color:#e65100;font-size:1em">‚ú® ${crit.name}</strong>
                        <button class="btn btn-danger btn-small" onclick="deleteLbCriterion('${key}','${crit.name.replace(/'/g,"\\'")}')">üóë Delete</button>
                    </div>
                    <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:8px">`;
                LB_CLASSES.forEach(cls=>{
                    const safeKey=cls.replace(/[.\[\]#$\/]/g,'_');
                    const val=pts[safeKey]||pts[cls]||0;
                    const safeId='lbPts_'+key+'_'+cls.replace(/[^a-zA-Z0-9]/g,'_');
                    html+=`<div style="display:flex;align-items:center;gap:6px;background:#fffdf0;padding:6px 10px;border-radius:6px;border:1px solid #ffe082">
                        <span style="font-size:0.78em;color:#555;flex:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis" title="${cls}">${cls}</span>
                        <input type="number" id="${safeId}" value="${val}" min="0" max="9999"
                            style="width:65px;padding:4px;border:1px solid #ddd;border-radius:4px;text-align:center;font-size:0.85em">
                    </div>`;
                });
                html+=`</div>
                    <button class="btn btn-small btn-success" onclick="saveLbCriterionPoints('${key}')" style="margin-top:12px">üíæ Save Points for "${crit.name}"</button>
                </div>`;
            });
            container.innerHTML=html;
        } catch(err) { container.innerHTML='<p style="color:red">Error: '+err.message+'</p>'; }
    }

    async function saveLbCriterionPoints(key) {
        try {
            const snap = await getDb().ref('leaderboardConfig/customCriteria/'+key).once('value');
            const crit = snap.val();
            if (!crit) { showLbAdminMsg('Criterion not found.','error'); return; }
            const pointsObj={};
            LB_CLASSES.forEach(cls=>{
                const safeId='lbPts_'+key+'_'+cls.replace(/[^a-zA-Z0-9]/g,'_');
                const safeKey=cls.replace(/[.\[\]#$\/]/g,'_');
                const inp=document.getElementById(safeId);
                pointsObj[safeKey]=inp?(parseInt(inp.value)||0):0;
            });
            await getDb().ref('leaderboardConfig/customCriteria/'+key+'/points').set(pointsObj);
            showLbAdminMsg('‚úÖ Points saved for "'+crit.name+'"!','success');
        } catch(err) { showLbAdminMsg('‚ùå Error: '+err.message,'error'); }
    }

    async function deleteLbCriterion(key,name) {
        if(!confirm('Delete criterion "'+name+'"?\n\nAll points for this criterion will be removed.')) return;
        try {
            await getDb().ref('leaderboardConfig/customCriteria/'+key).remove();
            showLbAdminMsg('‚úÖ "'+name+'" deleted.','success');
            loadLbCriteriaList();
        } catch(err) { showLbAdminMsg('‚ùå Error: '+err.message,'error'); }
    }

    async function loadLbAdminPreview() {
        const container = document.getElementById('lbAdminPreview');
        const updEl     = document.getElementById('lbPreviewUpdated');
        container.innerHTML = '<p style="color:rgba(255,255,255,0.4);text-align:center;padding:30px">‚è≥ Fetching live data from Firebase‚Ä¶</p>';
        try {
            const cfg = await getLbConfig();
            const init = () => { const o={}; LB_CLASSES.forEach(c => o[c]=0); return o; };
            const yfP=init(), quizP=init(), resP=init(), custP=init();

            // ‚îÄ‚îÄ 1. Youthfest Registration ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            const yfSnap = await getDb().ref('youthfest-enrollments').once('value');
            if (yfSnap.exists()) yfSnap.forEach(c => {
                const d=c.val(), cl=d.classYear||d.class||'';
                if (yfP[cl] !== undefined) yfP[cl] += cfg.yfPtsPerEvent;
            });

            // ‚îÄ‚îÄ 2. Quiz Points (published days only) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            const qrSnap = await getDb().ref('quizResults').once('value');
            const pubDates=new Set(); const qWinMap={};
            if (qrSnap.exists()) qrSnap.forEach(dn => {
                const r=dn.val();
                if (r && r.winner && r.runnerUp) {
                    pubDates.add(dn.key);
                    qWinMap[dn.key] = { w: r.winner.class||'', ru: r.runnerUp.class||'' };
                }
            });
            if (pubDates.size > 0) {
                const qsSnap = await getDb().ref('quizSubmissions').once('value');
                if (qsSnap.exists()) qsSnap.forEach(dn => {
                    if (!pubDates.has(dn.key)) return;
                    const w = qWinMap[dn.key];
                    if (w.w  && quizP[w.w]  !== undefined) quizP[w.w]  += cfg.quizWinnerPts;
                    if (w.ru && quizP[w.ru] !== undefined) quizP[w.ru] += cfg.quizRunnerUpPts;
                    const cmx={};
                    dn.forEach(sn => {
                        const s=sn.val(), cl=s.studentClass||'';
                        if (LB_CLASSES.includes(cl)) { if(!cmx[cl]) cmx[cl]=0; if((parseInt(s.score)||0)>=2) cmx[cl]++; }
                    });
                    LB_CLASSES.forEach(cl => {
                        if (!cmx[cl]) return;
                        const str = lbClassStrengths[cl.replace(/[.\[\]#$\/]/g,'_')] || lbClassStrengths[cl] || 0;
                        const b = str>0 ? Math.round((cmx[cl]/str)*cfg.quizMaxPts*10)/10 : cmx[cl];
                        if (quizP[cl] !== undefined) quizP[cl] += b;
                    });
                });
            }

            // ‚îÄ‚îÄ 3. Event Results (published jury results) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            const sSnap = await getDb().ref('jurySetup').once('value');
            if (sSnap.exists()) {
                for (const [ev, setup] of Object.entries(sSnap.val())) {
                    if (!setup.resultsPublished) continue;
                    const mSnap = await getDb().ref('juryMarks/'+ev).once('value');
                    if (!mSnap.exists()) continue;
                    const j1=mSnap.val().jury1||{}, j2=mSnap.val().jury2||{};
                    const allK=new Set([...Object.keys(j1),...Object.keys(j2)]);
                    const evR=[];
                    allK.forEach(sk => {
                        const d1=j1[sk], d2=j2[sk];
                        const cls=(d1&&d1.originalClassName)||(d2&&d2.originalClassName)||sk;
                        let t1=0,t2=0;
                        if(d1&&d1.marks)(Array.isArray(d1.marks)?d1.marks:Object.values(d1.marks)).forEach(m=>t1+=(m||0));
                        if(d2&&d2.marks)(Array.isArray(d2.marks)?d2.marks:Object.values(d2.marks)).forEach(m=>t2+=(m||0));
                        evR.push({cls, avg:(t1+t2)/2});
                    });
                    evR.sort((a,b) => b.avg-a.avg);
                    if (evR[0] && resP[evR[0].cls] !== undefined) resP[evR[0].cls] += cfg.winnerPts;
                    if (evR[1] && resP[evR[1].cls] !== undefined) resP[evR[1].cls] += cfg.runnerUpPts;
                }
            }

            // ‚îÄ‚îÄ 4. Custom Criteria ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            const cSnap = await getDb().ref('leaderboardConfig/customCriteria').once('value');
            if (cSnap.exists()) cSnap.forEach(cn => {
                const c=cn.val(); if(!c||!c.points) return;
                Object.keys(c.points).forEach(k => {
                    LB_CLASSES.forEach(cl => {
                        if (cl.replace(/[.\[\]#$\/]/g,'_')===k && custP[cl]!==undefined) custP[cl]+=(c.points[k]||0);
                    });
                });
            });

            // ‚îÄ‚îÄ Rank & render ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            const ranked = LB_CLASSES.map(cl => ({
                cl, yfP:yfP[cl]||0, quizP:quizP[cl]||0, resP:resP[cl]||0, custP:custP[cl]||0,
                total:(yfP[cl]||0)+(quizP[cl]||0)+(resP[cl]||0)+(custP[cl]||0)
            })).sort((a,b) => b.total-a.total);

            const medals = ['ü•á','ü•à','ü•â'];
            let html = '<div class="table-wrapper"><table style="min-width:700px;background:white;border-radius:8px;overflow:hidden">'
                     + '<thead><tr>'
                     + '<th style="background:#1a0030;color:#ffd700;padding:10px">Rank</th>'
                     + '<th style="background:#1a0030;color:#ffd700">Class</th>'
                     + '<th style="background:#1a0030;color:#ffc107">üé§ YF Reg</th>'
                     + '<th style="background:#1a0030;color:#a5d6a7">üß† Quiz</th>'
                     + '<th style="background:#1a0030;color:#ce93d8">üèÜ Results</th>'
                     + '<th style="background:#1a0030;color:#80deea">‚ú® Custom</th>'
                     + '<th style="background:#c44569;color:white;font-size:1.05em">TOTAL</th>'
                     + '</tr></thead><tbody>';

            ranked.forEach((e,i) => {
                const rowBg = i===0 ? 'background:#fffde7' : i===1 ? 'background:#f8f8f8' : i===2 ? 'background:#fff3e0' : 'background:white';
                const rankCell = i<3 ? medals[i] : `<strong>${i+1}</strong>`;
                const totalStyle = i===0 ? 'font-weight:900;color:#c44569;font-size:1.2em' : 'font-weight:700;color:#c44569';
                html += `<tr style="${rowBg}">
                    <td style="text-align:center;font-size:1.1em">${rankCell}</td>
                    <td style="font-weight:600">${e.cl}</td>
                    <td style="color:#856404;text-align:center">${e.yfP}</td>
                    <td style="color:#155724;text-align:center">${e.quizP}</td>
                    <td style="color:#6a1b9a;text-align:center">${e.resP}</td>
                    <td style="color:#0c5460;text-align:center">${e.custP}</td>
                    <td style="${totalStyle};text-align:center">${e.total}</td>
                </tr>`;
            });
            html += '</tbody></table></div>';

            // Data source summary
            const now = new Date().toLocaleTimeString('en-IN');
            html += `<div style="margin-top:10px;padding:8px 12px;background:rgba(255,255,255,0.08);border-radius:6px;font-size:11px;color:rgba(255,255,255,0.5)">
                üìä YF Reg pts used: ${cfg.yfPtsPerEvent}/event &nbsp;|&nbsp;
                üß† Quiz winner: ${cfg.quizWinnerPts}pts, runner-up: ${cfg.quizRunnerUpPts}pts, max participation: ${cfg.quizMaxPts}pts &nbsp;|&nbsp;
                üèÜ Event winner: ${cfg.winnerPts}pts, runner-up: ${cfg.runnerUpPts}pts &nbsp;|&nbsp;
                Published quiz days counted: ${pubDates.size}
            </div>`;

            container.innerHTML = html;
            if (updEl) updEl.textContent = 'Last updated: ' + now;

        } catch(err) {
            container.innerHTML = '<p style="color:#ff6b6b;text-align:center;padding:20px">‚ùå Error loading preview: <strong>' + err.message + '</strong></p>';
            if (updEl) updEl.textContent = 'Failed to load';
        }
    }

    function showLbAdminMsg(msg, type) {
        const el = document.getElementById('lbAdminMessage');
        if (!el) return;
        el.className = 'message ' + type + ' show';
        el.textContent = msg;
        setTimeout(() => el.classList.remove('show'), 6000);
    }

    // Leaderboard tab loading is handled inside showTab() in the main script above

    // ============================================================
    //  HOW WE PUBLISH ‚Äî Editable Section Engine
    //  Super Admin can edit all text via Firebase
    //  Path: leaderboardConfig/howWePublish
    // ============================================================

    const HWP_DEFAULTS = {
        heading:  'Leaderboard Coming Soon!',
        subText:  'Results will be published by the Super Admin once the events are completed.\nCheck back soon!',
        overview: 'The <strong style="color:#c44569">Class of the Year 2026</strong> leaderboard ranks all <strong>11 classes</strong> competing across <strong>16 events</strong> at Spurthi Youth Fest. Rankings are hidden until the Super Admin verifies all results and officially publishes them ‚Äî ensuring every score is accurate before you see it.',
        cards: [
            { title: 'Youthfest Registration', body: 'Each class earns points for <strong>every event they enrol in</strong>. More participation = more points for your class.' },
            { title: 'Quiz Competition',        body: 'Per published quiz day: <strong>flat bonus</strong> to the winner &amp; runner-up class, plus a <strong>participation rate bonus</strong> ‚Äî fair across all class sizes.' },
            { title: 'Event Results',           body: 'When jury results are published, the <strong>1st place class</strong> gets winner pts and <strong>2nd place</strong> gets runner-up pts ‚Äî automatically calculated.' },
            { title: 'Special / Custom Criteria', body: 'The Super Admin may add bonus points for criteria like discipline, attendance, best decorated class, or other special achievements.' }
        ],
        steps: [
            { title: 'Complete Events & Jury Scoring',  body: 'All events conducted. Jury 1 & Jury 2 fill and submit marks.' },
            { title: 'Publish Quiz Results',            body: 'Daily quiz winners & runners-up declared. Only published days count.' },
            { title: 'Verify Scoring Config',           body: 'Points per event, quiz pts, winner/runner-up pts confirmed & saved.' },
            { title: 'Set Class Strengths',             body: 'Total students per class entered to ensure fair participation scoring.' },
            { title: 'Preview & Verify',                body: 'Live preview checked internally before releasing to students.' },
            { title: 'üì¢ Publish to Students',          body: 'Only after full verification ‚Äî rankings go LIVE for all students to see.', highlight: true }
        ],
        notes: [
            'Only the <strong>Super Admin</strong> can publish or hide the leaderboard.',
            'All point calculations are <strong>fully automatic</strong> ‚Äî no manual tampering.',
            'The leaderboard refreshes every <strong>60 seconds</strong> once live.',
            'Rankings may be updated progressively as more results are published during the fest period.'
        ]
    };

    let hwpData = JSON.parse(JSON.stringify(HWP_DEFAULTS)); // working copy
    let hwpEditMode = false;

    // ‚îÄ‚îÄ Load from Firebase (or use defaults) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    async function hwpLoad() {
        try {
            const snap = await getDb().ref('leaderboardConfig/howWePublish').once('value');
            if (snap.exists()) {
                const d = snap.val();
                if (d.heading)  hwpData.heading  = d.heading;
                if (d.subText)  hwpData.subText  = d.subText;
                if (d.overview) hwpData.overview = d.overview;
                if (d.cards  && Array.isArray(d.cards))  hwpData.cards  = d.cards;
                if (d.steps  && Array.isArray(d.steps))  hwpData.steps  = d.steps;
                if (d.notes  && Array.isArray(d.notes))  hwpData.notes  = d.notes;
            }
        } catch(e) { console.warn('hwpLoad error (using defaults):', e.message); }
        hwpRender();
        hwpShowAdminControls();
    }

    // ‚îÄ‚îÄ Render all content from hwpData ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function hwpRender() {
        // Banner
        const hEl = document.getElementById('hwpHeadingText');
        const sEl = document.getElementById('hwpSubText');
        if (hEl) hEl.innerHTML = hwpData.heading;
        if (sEl) sEl.innerHTML = hwpData.subText.replace(/\n/g, '<br>');

        // Overview
        const ov = document.getElementById('hwpOverviewText');
        if (ov) ov.innerHTML = hwpData.overview;

        // Cards
        hwpData.cards.forEach((c, i) => {
            const t = document.getElementById('hwpCard'+i+'Title');
            const b = document.getElementById('hwpCard'+i+'Body');
            if (t) t.innerHTML = c.title;
            if (b) b.innerHTML = c.body;
        });

        // Steps
        const grid = document.getElementById('hwpStepsGrid');
        if (grid) {
            grid.innerHTML = hwpData.steps.map((s, i) => {
                const isLast = s.highlight;
                const numBg  = isLast ? '#28a745' : '#c44569';
                const cardBg = isLast ? 'background:linear-gradient(135deg,#e8f5e9,#d4edda);border:2px solid #28a745' : 'background:#fafafa;border:1px solid #eee';
                const titleColor = isLast ? '#155724' : '#333';
                const bodyColor  = isLast ? '#155724' : '#666';
                return `<div style="${cardBg};border-radius:8px;padding:13px;display:flex;gap:11px;align-items:flex-start" data-step="${i}">
                    <span style="background:${numBg};color:white;border-radius:50%;width:23px;height:23px;display:inline-flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;flex-shrink:0;margin-top:1px">${i+1}</span>
                    <div>
                        <strong style="color:${titleColor};font-size:12.5px" id="hwpStep${i}Title">${s.title}</strong>
                        <p style="margin:3px 0 0;color:${bodyColor};font-size:11.5px" id="hwpStep${i}Body">${s.body}</p>
                        <div class="hwpStepEditArea" style="display:none;margin-top:6px">
                            <input type="text" class="hwpStepTitleInput" data-idx="${i}" value="${s.title.replace(/"/g,'&quot;')}" style="width:100%;padding:4px 7px;border:1px solid #ccc;border-radius:4px;font-size:11.5px;margin-bottom:4px">
                            <textarea class="hwpStepBodyInput" data-idx="${i}" rows="2" style="width:100%;padding:4px 7px;border:1px solid #ccc;border-radius:4px;font-size:11.5px;resize:vertical">${s.body}</textarea>
                            <label style="font-size:11px;color:#666;display:flex;align-items:center;gap:5px;margin-top:3px">
                                <input type="checkbox" class="hwpStepHighlight" data-idx="${i}" ${s.highlight?'checked':''} style="width:auto"> Highlight as final step (green)
                            </label>
                        </div>
                    </div>
                </div>`;
            }).join('');
        }

        // Notes
        const nl = document.getElementById('hwpNotesList');
        if (nl) nl.innerHTML = hwpData.notes.map(n => `<li>${n}</li>`).join('');
    }

    // ‚îÄ‚îÄ Show admin controls if Super Admin is logged in ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function hwpShowAdminControls() {
        const isSA = typeof isSuperAdmin !== 'undefined' && isSuperAdmin;
        if (!isSA) return;
        const bannerCtrl  = document.getElementById('hwpBannerEditControls');
        const sectionCtrl = document.getElementById('hwpEditModeControls');
        if (bannerCtrl)  { bannerCtrl.style.display  = 'flex'; }
        if (sectionCtrl) { sectionCtrl.style.display = 'flex'; }
    }

    // ‚îÄ‚îÄ Banner edit ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function hwpToggleBannerEdit() {
        const isEditing = document.getElementById('hwpHeadingEdit').style.display !== 'none';
        if (!isEditing) {
            document.getElementById('hwpHeadingInput').value = hwpData.heading;
            document.getElementById('hwpSubInput').value     = hwpData.subText;
            document.getElementById('hwpHeadingView').style.display = 'none';
            document.getElementById('hwpSubView').style.display     = 'none';
            document.getElementById('hwpHeadingEdit').style.display = 'block';
            document.getElementById('hwpSubEdit').style.display     = 'block';
            document.getElementById('hwpBannerEditBtn').style.display  = 'none';
            document.getElementById('hwpBannerSaveBtn').style.display  = 'inline-block';
            document.getElementById('hwpBannerCancelBtn').style.display= 'inline-block';
        }
    }
    function hwpCancelBannerEdit() {
        document.getElementById('hwpHeadingView').style.display = 'block';
        document.getElementById('hwpSubView').style.display     = 'block';
        document.getElementById('hwpHeadingEdit').style.display = 'none';
        document.getElementById('hwpSubEdit').style.display     = 'none';
        document.getElementById('hwpBannerEditBtn').style.display   = 'inline-block';
        document.getElementById('hwpBannerSaveBtn').style.display   = 'none';
        document.getElementById('hwpBannerCancelBtn').style.display = 'none';
    }
    async function hwpSaveBanner() {
        hwpData.heading = document.getElementById('hwpHeadingInput').value.trim() || hwpData.heading;
        hwpData.subText = document.getElementById('hwpSubInput').value.trim()     || hwpData.subText;
        try {
            await getDb().ref('leaderboardConfig/howWePublish/heading').set(hwpData.heading);
            await getDb().ref('leaderboardConfig/howWePublish/subText').set(hwpData.subText);
            hwpRender();
            hwpCancelBannerEdit();
            const msg = document.getElementById('hwpBannerSaveMsg');
            if (msg) { msg.style.display='inline-block'; setTimeout(()=>msg.style.display='none',3000); }
        } catch(e) { alert('Save error: ' + e.message); }
    }

    // ‚îÄ‚îÄ Section edit mode ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function hwpToggleEditMode() {
        hwpEditMode = true;
        // Overview
        document.getElementById('hwpOverviewView').style.display = 'none';
        document.getElementById('hwpOverviewEdit').style.display = 'block';
        document.getElementById('hwpOverviewInput').value = hwpData.overview;
        // Cards
        document.querySelectorAll('.hwpCardEditArea').forEach((el,i) => {
            el.style.display = 'block';
            const tIn = el.querySelector('.hwpCardTitleInput');
            const bIn = el.querySelector('.hwpCardBodyInput');
            if (tIn) tIn.value = hwpData.cards[i] ? hwpData.cards[i].title : '';
            if (bIn) bIn.value = hwpData.cards[i] ? hwpData.cards[i].body.replace(/<[^>]+>/g,'') : '';
        });
        // Steps
        document.querySelectorAll('.hwpStepEditArea').forEach(el => el.style.display='block');
        // Notes
        document.getElementById('hwpNotesView').style.display = 'none';
        document.getElementById('hwpNotesEdit').style.display = 'block';
        document.getElementById('hwpNotesInput').value = hwpData.notes.map(n=>n.replace(/<[^>]+>/g,'')).join('\n');
        // Buttons
        document.getElementById('hwpEditModeBtn').style.display  = 'none';
        document.getElementById('hwpSaveAllBtn').style.display   = 'inline-block';
        document.getElementById('hwpCancelBtn').style.display    = 'inline-block';
    }
    function hwpCancelEdit() {
        hwpEditMode = false;
        hwpRender();
        document.getElementById('hwpOverviewView').style.display = 'block';
        document.getElementById('hwpOverviewEdit').style.display = 'none';
        document.getElementById('hwpNotesView').style.display    = 'block';
        document.getElementById('hwpNotesEdit').style.display    = 'none';
        document.querySelectorAll('.hwpCardEditArea').forEach(el => el.style.display='none');
        document.getElementById('hwpEditModeBtn').style.display  = 'inline-block';
        document.getElementById('hwpSaveAllBtn').style.display   = 'none';
        document.getElementById('hwpCancelBtn').style.display    = 'none';
    }
    async function hwpSaveAll() {
        // Collect overview
        hwpData.overview = document.getElementById('hwpOverviewInput').value.trim() || hwpData.overview;

        // Collect cards
        document.querySelectorAll('.hwpCardTitleInput').forEach(inp => {
            const i = parseInt(inp.dataset.idx);
            if (!isNaN(i) && hwpData.cards[i]) hwpData.cards[i].title = inp.value.trim();
        });
        document.querySelectorAll('.hwpCardBodyInput').forEach(inp => {
            const i = parseInt(inp.dataset.idx);
            if (!isNaN(i) && hwpData.cards[i]) hwpData.cards[i].body = inp.value.trim();
        });

        // Collect steps
        document.querySelectorAll('.hwpStepTitleInput').forEach(inp => {
            const i = parseInt(inp.dataset.idx);
            if (!isNaN(i) && hwpData.steps[i]) hwpData.steps[i].title = inp.value.trim();
        });
        document.querySelectorAll('.hwpStepBodyInput').forEach(inp => {
            const i = parseInt(inp.dataset.idx);
            if (!isNaN(i) && hwpData.steps[i]) hwpData.steps[i].body = inp.value.trim();
        });
        document.querySelectorAll('.hwpStepHighlight').forEach(inp => {
            const i = parseInt(inp.dataset.idx);
            if (!isNaN(i) && hwpData.steps[i]) hwpData.steps[i].highlight = inp.checked;
        });

        // Collect notes
        const rawNotes = document.getElementById('hwpNotesInput').value.trim();
        if (rawNotes) hwpData.notes = rawNotes.split('\n').map(n=>n.trim()).filter(Boolean);

        const saveBtn = document.getElementById('hwpSaveAllBtn');
        if (saveBtn) { saveBtn.disabled=true; saveBtn.textContent='‚è≥ Saving‚Ä¶'; }
        try {
            await getDb().ref('leaderboardConfig/howWePublish').set({
                heading:  hwpData.heading,
                subText:  hwpData.subText,
                overview: hwpData.overview,
                cards:    hwpData.cards,
                steps:    hwpData.steps,
                notes:    hwpData.notes,
                updatedAt: new Date().toISOString()
            });
            hwpCancelEdit();
            hwpRender();
            const msg = document.getElementById('hwpSaveAllMsg');
            if (msg) { msg.style.display='inline-block'; setTimeout(()=>msg.style.display='none',4000); }
        } catch(e) {
            alert('‚ùå Save error: ' + e.message);
        } finally {
            if (saveBtn) { saveBtn.disabled=false; saveBtn.textContent='üíæ Save All Changes'; }
        }
    }

    // ‚îÄ‚îÄ Auto-init when db is ready ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    (function hwpInit() {
        function tryInit() {
            try {
                getDb(); // will throw if not ready
                hwpLoad();
            } catch(e) { setTimeout(tryInit, 600); }
        }
        tryInit();
    })();

    </script>

    <!-- ============================================ -->
    <!-- RULES AND REGULATIONS SECTION                -->
    <!-- TO EDIT: Just change the text below          -->
    <!-- TO ADD PDF: Replace "rules.pdf" with your    -->
    <!-- PDF file name and upload it to same folder   -->
    <!-- ============================================ -->
    <div class="content" style="margin-bottom:30px;margin-top:40px;padding:40px 30px;">
        <div style="text-align:center;margin-bottom:30px;">
            <h2 style="color:#c44569;margin-bottom:20px;">üìã General Rules and Regulations</h2>
            
            <!-- ============================================ -->
            <!-- TO ADD/REMOVE PDF LINK:                      -->
            <!-- Delete the entire line below to remove link  -->
            <!-- Or change "rules.pdf" to your PDF filename   -->
            <!-- ============================================ -->
            <a href="rules.pdf" target="_blank" style="display:inline-block;background:linear-gradient(135deg, #c44569 0%, #6a1b9a 100%);color:white;padding:12px 30px;border-radius:8px;text-decoration:none;font-weight:600;margin-bottom:20px;">
                üìÑ Download Complete Rules & Regulations PDF (Coming Soon)
            </a>
        </div>

        <!-- ============================================ -->
        <!-- TO EDIT COORDINATOR NAMES:                   -->
        <!-- Change the names below                       -->
        <!-- ============================================ -->
        <div style="background:#fff3cd;padding:20px;border-radius:8px;border-left:5px solid #ffc107;margin-bottom:20px;">
            <p style="margin:0;color:#856404;font-weight:600;">Event Coordinators: Lalitha S K & Priyanka V</p>
        </div>

        <!-- ============================================ -->
        <!-- TO EDIT RULES: Change the text below         -->
        <!-- Keep the HTML tags as they are               -->
        <!-- ============================================ -->
        <div style="background:white;padding:25px;border-radius:8px;border:2px solid #e0e0e0;">
            <ol style="line-height:1.8;color:#333;">
                <!-- Rule 1 -->
                <li style="margin-bottom:15px;">
                    <strong>Last date for registration</strong> with one time Refundable amount 
                    <span style="color:#c44569;font-weight:bold;">‚Çπ1,500/-</span> 
                    on or before 
                    <span style="color:#c44569;font-weight:bold;">23rd February, Monday within 3:30 PM</span>.
                </li>
                
                <!-- Rule 2 -->
                <li style="margin-bottom:15px;">
                    <strong>Last date for submission of Music and Work Organising batch</strong> 
                    on or before 
                    <span style="color:#c44569;font-weight:bold;">7th March, Saturday</span>.
                </li>
                
                <!-- Rule 3 -->
                <li style="margin-bottom:15px;">
                    Students arriving late (Event and for the Class registration on the date of event) 
                    or absent for the event will be fined 
                    <span style="color:#c44569;font-weight:bold;">‚Çπ500/- per day</span>.
                </li>
                
                <!-- Rule 4 -->
                <li style="margin-bottom:15px;">
                    Teams not submitting Music, or any other assignments with respect to the event, 
                    on date and time, will lead into 
                    <span style="color:#c44569;font-weight:bold;">non-refund of deposit ‚Çπ1,500/-</span>.
                </li>
            </ol>
        </div>
    </div>
    <!-- ============================================ -->
    <!-- END OF RULES SECTION                         -->
    <!-- ============================================ -->
    
    <!-- Footer -->
    <footer style="background: white; border-radius: 12px; padding: 25px; margin-top: 30px; box-shadow: 0 4px 20px rgba(0,0,0,0.1);">
        <div style="text-align: center;">
            
            <!-- ================================================== -->
            <!-- CIRCULAR LOGO (Top)                                -->
            <!-- Replace "davan_logo_2026.gif" with your image file -->
            <!-- ================================================== -->
            <div style="margin-bottom: 0px;">
                <img src="davan_logo_2026.gif" alt="Spurthi Davan Logo" style="height: 200px; width: auto; display: inline-block;">
            </div>
            
            <p style="color: #6a1b9a; font-size: 0.9em; margin-bottom: 8px;">
                ¬© 2026 Davan Institute of Advanced Management Studies
            </p>
            
            <!-- ============================================ -->
            <!-- SUPER ADMIN: UPDATE VERSION AND DATE HERE    -->
            <!-- ============================================ -->
            <p style="color: #666; font-size: 0.85em; margin-bottom: 8px;">
                <strong>Version:</strong> 2.2 (Leaderboard, enrolment ) | <strong>Last Updated:</strong> February 17, 2026 (8.30pm)
            </p>
            <!-- ============================================ -->
            
            <p style="color: #c44569; font-size: 0.85em; font-weight: 600; margin-bottom: 8px;">
                Built by Harsha Gujjar, Director - Davan College
            </p>
            
            <!-- ================================================== -->
            <!-- TEXT LOGO (Below "Built by" line)                  -->
            <!-- Replace 