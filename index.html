<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spurthi Youth Fest 2026 - Daily Quiz Competition</title>
    
    <!-- Favicon -->
    <link rel="icon" type="image/png" href="davan_degree1.png">
    <link rel="apple-touch-icon" href="davan_degree1.png">
    
    <!-- Open Graph / WhatsApp / Facebook Meta Tags -->
    <meta property="og:title" content="Spurthi Youth Fest 2026 - Daily Quiz Competition">
    <meta property="og:description" content="ðŸŽ“ Join our exciting Daily Quiz Competition! Answer 2 questions daily and win prizes. Register now and compete for glory!">
    <meta property="og:image" content="https://harshgujjar.github.io/Spurthi-youth-fest-2026/og_image.png">
    <meta property="og:image:secure_url" content="https://harshgujjar.github.io/Spurthi-youth-fest-2026/og_image.png">
    <meta property="og:image:type" content="image/png">
    <meta property="og:image:width" content="1200">
    <meta property="og:image:height" content="630">
    <meta property="og:image:alt" content="Spurthi Youth Fest 2026 - Daily Quiz Competition by Davan Institute">
    <meta property="og:url" content="https://harshgujjar.github.io/Spurthi-youth-fest-2026/">
    <meta property="og:type" content="website">
    <meta property="og:site_name" content="Spurthi Youth Fest 2026">
    <meta property="og:locale" content="en_IN">
    
    <!-- Twitter Card Meta Tags -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="Spurthi Youth Fest 2026 - Daily Quiz Competition">
    <meta name="twitter:description" content="ðŸŽ“ Join our Daily Quiz Competition! Answer 2 questions daily and win prizes. Register now and compete for glory!">
    <meta name="twitter:image" content="https://harshgujjar.github.io/Spurthi-youth-fest-2026/og_image.png">
    <meta name="twitter:image:alt" content="Spurthi Youth Fest 2026 - Daily Quiz Competition by Davan Institute">
    
    <!-- Additional Meta Tags -->
    <meta name="description" content="Spurthi Youth Fest 2026 Daily Quiz Competition - Test your knowledge, win prizes! By Davan Institute of Advanced Management Studies">
    <meta name="keywords" content="Spurthi, Youth Fest, Quiz, Competition, Davan Institute, College Fest, Student Competition">
    <meta name="author" content="Davan Institute of Advanced Management Studies">
    
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-storage-compat.js"></script>
    <!-- EmailJS for sending actual emails -->
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
    <script type="text/javascript">
        (function(){
            emailjs.init("iISS6N2b69VmKwx8Y"); // Your EmailJS Public Key from image
        })();
    </script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #c44569 0%, #6a1b9a 100%); min-height: 100vh; padding: 20px; }
        
        /* ========== QUIZ ANIMATIONS ========== */
        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes pulse {
            0%, 100% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.05);
            }
        }
        
        @keyframes shimmer {
            0% {
                background-position: -1000px 0;
            }
            100% {
                background-position: 1000px 0;
            }
        }
        
        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% {
                transform: translateY(0);
            }
            40% {
                transform: translateY(-20px);
            }
            60% {
                transform: translateY(-10px);
            }
        }
        
        @keyframes confetti {
            0% {
                transform: translateY(0) rotateZ(0deg);
                opacity: 1;
            }
            100% {
                transform: translateY(1000px) rotateZ(720deg);
                opacity: 0;
            }
        }
        
        @keyframes correctShake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px) rotate(-2deg); }
            75% { transform: translateX(5px) rotate(2deg); }
        }
        
        /* Quiz Status Cards with Animation */
        .quiz-status-card {
            animation: slideInUp 0.6s ease-out;
            transition: all 0.3s ease;
        }
        
        .quiz-status-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.2);
        }
        
        /* Shimmer effect for available quiz */
        .quiz-available-banner {
            background: linear-gradient(90deg, #d4edda 0%, #e8f5e9 50%, #d4edda 100%);
            background-size: 2000px 100%;
            animation: shimmer 3s linear infinite;
            border: 3px solid #28a745;
            border-radius: 15px;
            padding: 25px;
            margin: 20px 0;
            box-shadow: 0 6px 20px rgba(40, 167, 69, 0.3);
        }
        
        .quiz-available-banner h3 {
            color: #155724;
            font-size: 1.5em;
            margin-bottom: 10px;
            animation: pulse 2s ease-in-out infinite;
        }
        
        .quiz-available-banner .trophy-icon {
            font-size: 3em;
            display: inline-block;
            animation: bounce 2s ease-in-out infinite;
        }
        
        /* Question Cards */
        .quiz-question-card {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 8px 30px rgba(0,0,0,0.15);
            border-left: 6px solid #667eea;
            animation: slideInUp 0.5s ease-out;
            transition: all 0.3s ease;
        }
        
        .quiz-question-card:hover {
            transform: translateX(5px);
            box-shadow: 0 12px 40px rgba(102, 126, 234, 0.3);
        }
        
        .quiz-question-card h4 {
            color: #667eea;
            font-size: 1.3em;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .quiz-question-card .question-text {
            color: #333;
            font-size: 1.15em;
            margin-bottom: 20px;
            line-height: 1.6;
            font-weight: 500;
        }
        
        /* Option Buttons */
        .quiz-option {
            background: #f8f9fa;
            border: 3px solid #e9ecef;
            border-radius: 12px;
            padding: 18px 25px;
            margin: 12px 0;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 15px;
            font-size: 1.05em;
        }
        
        .quiz-option:hover {
            background: #e3f2fd;
            border-color: #2196F3;
            transform: translateX(10px);
            box-shadow: 0 4px 15px rgba(33, 150, 243, 0.2);
        }
        
        .quiz-option.selected {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-color: #667eea;
            color: white;
            font-weight: 600;
            transform: scale(1.02);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }
        
        .quiz-option .option-circle {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: #667eea;
            flex-shrink: 0;
        }
        
        .quiz-option.selected .option-circle {
            background: white;
            color: #667eea;
        }
        
        /* Submit Button Enhancement */
        .quiz-submit-btn {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            border: none;
            border-radius: 15px;
            padding: 20px 40px;
            font-size: 1.3em;
            font-weight: 700;
            cursor: pointer;
            width: 100%;
            margin-top: 30px;
            transition: all 0.3s ease;
            box-shadow: 0 8px 25px rgba(40, 167, 69, 0.4);
            position: relative;
            overflow: hidden;
        }
        
        .quiz-submit-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 35px rgba(40, 167, 69, 0.5);
        }
        
        .quiz-submit-btn:active {
            transform: translateY(-1px);
        }
        
        .quiz-submit-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: rgba(255,255,255,0.2);
            transition: left 0.5s ease;
        }
        
        .quiz-submit-btn:hover::before {
            left: 100%;
        }
        
        /* Timer Enhancement */
        .quiz-timer-box {
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, #ff6b6b 0%, #ff8e53 100%);
            color: white;
            padding: 15px 25px;
            border-radius: 15px;
            box-shadow: 0 6px 20px rgba(255, 107, 107, 0.4);
            z-index: 1000;
            font-weight: 700;
            font-size: 1.2em;
            animation: pulse 2s ease-in-out infinite;
        }
        
        /* Confetti */
        .confetti {
            position: fixed;
            width: 10px;
            height: 10px;
            z-index: 9999;
            animation: confetti 3s ease-out forwards;
        }
        
        /* Success Modal */
        .quiz-success-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            animation: fadeIn 0.3s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .quiz-success-content {
            background: white;
            border-radius: 25px;
            padding: 50px;
            text-align: center;
            max-width: 600px;
            animation: slideInUp 0.5s ease-out;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        
        .quiz-success-content .success-icon {
            font-size: 5em;
            margin-bottom: 20px;
            animation: bounce 1s ease-in-out;
        }
        
        .quiz-success-content h2 {
            color: #28a745;
            font-size: 2.5em;
            margin-bottom: 15px;
        }
        
        .quiz-success-content p {
            font-size: 1.2em;
            color: #666;
            margin: 10px 0;
        }

        /* ========== SCAVENGER HUNT STYLES ========== */
        .sh-tab-panel          { display: none; }
        .sh-tab-panel.sh-tab-active { display: block; }

        .sh-task-card {
            background: white;
            border-radius: 14px;
            padding: 20px 22px;
            margin-bottom: 16px;
            box-shadow: 0 4px 18px rgba(0,0,0,0.10);
            border-left: 6px solid #9c27b0;
            transition: all 0.3s ease;
            animation: slideInUp 0.4s ease-out;
        }
        .sh-task-card.completed { border-left-color: #4caf50; background: #f1f8f1; }
        .sh-task-card.pending   { border-left-color: #ff9800; }
        .sh-task-card.locked    { border-left-color: #bdbdbd; opacity: 0.6; }
        .sh-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.78em;
            font-weight: 700;
            letter-spacing: 0.5px;
            text-transform: uppercase;
        }
        .sh-badge-active   { background:#fff3e0; color:#e65100; border:1px solid #ffb74d; }
        .sh-badge-done     { background:#e8f5e9; color:#2e7d32; border:1px solid #81c784; }
        .sh-badge-pending  { background:#e3f2fd; color:#1565c0; border:1px solid #64b5f6; }
        .sh-badge-rejected { background:#ffebee; color:#c62828; border:1px solid #ef9a9a; }
        .sh-upload-zone {
            border: 2.5px dashed #9c27b0;
            border-radius: 12px;
            padding: 22px;
            text-align: center;
            cursor: pointer;
            transition: all 0.25s ease;
            background: #faf0ff;
            margin-top: 14px;
        }
        .sh-upload-zone:hover { background: #f3e5f5; border-color: #6a1b9a; }
        .sh-upload-zone.has-file { background: #e8f5e9; border-color: #4caf50; }
        .sh-preview-img {
            max-width: 100%;
            max-height: 200px;
            border-radius: 10px;
            margin-top: 12px;
            object-fit: cover;
            border: 3px solid #9c27b0;
        }
        .sh-admin-photo {
            max-width: 180px;
            max-height: 180px;
            border-radius: 8px;
            object-fit: cover;
            border: 3px solid #9c27b0;
            cursor: pointer;
        }
        .sh-progress-bar-wrap {
            background: #e0e0e0;
            border-radius: 20px;
            height: 12px;
            overflow: hidden;
            margin: 10px 0;
        }
        .sh-progress-bar {
            height: 100%;
            border-radius: 20px;
            background: linear-gradient(90deg, #9c27b0, #e91e63);
            transition: width 0.6s ease;
        }
        .sh-leaderboard-row {
            display: flex;
            align-items: center;
            gap: 14px;
            padding: 12px 16px;
            border-radius: 10px;
            margin-bottom: 8px;
            background: white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.07);
            transition: all 0.2s;
        }
        .sh-leaderboard-row:hover { transform: translateX(4px); box-shadow: 0 4px 15px rgba(156,39,176,0.15); }
        .sh-rank { font-size: 1.5em; min-width: 36px; text-align: center; }
        .sh-photo-modal {
            position: fixed; top:0; left:0; width:100%; height:100%;
            background: rgba(0,0,0,0.85);
            display: flex; align-items: center; justify-content: center;
            z-index: 99999;
        }
        .sh-photo-modal img { max-width: 92vw; max-height: 90vh; border-radius: 12px; }
        @keyframes shGlowPulse {
            0%,100% { box-shadow: 0 0 0 0 rgba(156,39,176,0.4); }
            50%      { box-shadow: 0 0 0 12px rgba(156,39,176,0); }
        }
        .sh-glow { animation: shGlowPulse 2s infinite; }
        .sh-gps-badge {
            display:inline-flex; align-items:center; gap:5px;
            background: linear-gradient(135deg,#00bcd4,#009688);
            color:white; padding:4px 12px; border-radius:20px;
            font-size:0.8em; font-weight:700;
        }

        .container { max-width: 1400px; margin: 0 auto; }
        .banner { width: 100%; max-width: 1200px; margin: 0 auto 30px; border-radius: 12px; box-shadow: 0 10px 40px rgba(0,0,0,0.3); display: block; }
        .header { text-align: center; color: white; margin-bottom: 30px; }
        .header h1 { font-size: 1.8em; }
        .admin-badge { display: inline-block; background: #FFD700; color: #333; padding: 5px 15px; border-radius: 20px; font-size: 0.9em; font-weight: bold; margin-left: 10px; }
        .super-admin-badge { display: inline-block; background: #FF6B6B; color: white; padding: 5px 15px; border-radius: 20px; font-size: 0.9em; font-weight: bold; margin-left: 10px; }
        .jury-badge { display: inline-block; background: #4ECDC4; color: white; padding: 5px 15px; border-radius: 20px; font-size: 0.9em; font-weight: bold; margin-left: 10px; }
        .super-jury-badge { display: inline-block; background: linear-gradient(135deg, #7b1fa2, #e91e63); color: white; padding: 5px 15px; border-radius: 20px; font-size: 0.9em; font-weight: bold; margin-left: 10px; box-shadow: 0 2px 8px rgba(233,30,99,0.4); }
        .super-jury-only { display: none; }
        
        /* Class Indicator */
        .class-indicator {
            background: white;
            padding: 15px 25px;
            border-radius: 8px;
            margin: 20px auto;
            max-width: 500px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            display: none;
        }
        .class-indicator.active {
            display: block;
        }
        .class-indicator h3 {
            color: #6a1b9a;
            font-size: 1.2em;
            margin-bottom: 8px;
        }
        .class-indicator .class-name {
            color: #c44569;
            font-size: 1.5em;
            font-weight: bold;
        }
        
        /* Admin Dashboard */
        .admin-dashboard {
            background: white;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }
        .dashboard-title {
            color: #c44569;
            font-size: 1.8em;
            margin-bottom: 25px;
            text-align: center;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 6px 20px rgba(0,0,0,0.15);
            transition: transform 0.3s;
        }
        .stat-card:hover {
            transform: translateY(-5px);
        }
        .stat-number {
            font-size: 3em;
            font-weight: bold;
            margin-bottom: 10px;
        }
        .stat-label {
            font-size: 1.1em;
            opacity: 0.9;
        }
        
        .tabs { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
        .tab { padding: 12px 24px; background: white; color: #333; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: 600; transition: all 0.3s; }
        .tab:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.2); }
        .tab.active { background: linear-gradient(135deg, #c44569 0%, #6a1b9a 100%); color: white; }
        .content { background: white; border-radius: 12px; padding: 30px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); }
        #adminContentBox.lb-active { background: transparent; box-shadow: none; padding: 0; }
        .form-section { display: none; }
        .form-section.active { display: block !important; }
        .form-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; font-weight: 600; color: #333; }
        input, select, textarea { width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 6px; font-size: 16px; transition: border-color 0.3s; }
        input:focus, select:focus, textarea:focus { outline: none; border-color: #c44569; }
        .event-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 15px; margin: 20px 0; }
        .event-card { padding: 20px; border: 3px solid #ddd; border-radius: 12px; cursor: pointer; transition: all 0.3s; background: white; position: relative; }
        .event-card:hover { border-color: #c44569; transform: translateY(-3px); box-shadow: 0 6px 20px rgba(196, 69, 105, 0.3); }
        .event-card.full { border-color: #f44336; background: #ffebee; cursor: not-allowed; opacity: 0.7; }
        .event-card.full:hover { transform: none; }
        .event-title { font-size: 1.1em; font-weight: bold; margin-bottom: 8px; }
        .event-size { font-size: 0.9em; opacity: 0.8; margin-bottom: 5px; }
        .event-status { font-size: 0.85em; padding: 5px 10px; border-radius: 15px; display: inline-block; margin-top: 5px; font-weight: bold; }
        .status-full { background: #f44336; color: white; }
        .status-available { background: #4CAF50; color: white; }
        .status-limited { background: #FF9800; color: white; }
        .team-member-box { border: 2px solid #c44569; padding: 15px; border-radius: 8px; margin-bottom: 15px; background: #f9f9f9; }
        .member-header { color: #6a1b9a; font-weight: bold; margin-bottom: 10px; font-size: 1.1em; }
        .btn { padding: 12px 30px; background: linear-gradient(135deg, #c44569 0%, #6a1b9a 100%); color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.3s; }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(0,0,0,0.2); }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }
        .btn-secondary { background: #666; }
        .btn-small { padding: 6px 12px; font-size: 14px; }
        .btn-success { background: #4CAF50; }
        .btn-danger { background: #f44336; }
        .btn-info { background: #2196F3; }
        .message { padding: 15px; border-radius: 6px; margin-bottom: 20px; display: none; }
        .message.show { display: block; }
        .message.success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .message.error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.7); overflow-y: auto; }
        .modal-content { background-color: white; margin: 50px auto; padding: 30px; border-radius: 12px; width: 90%; max-width: 600px; }
        .modal-header { font-size: 1.5em; color: #c44569; margin-bottom: 20px; text-align: center; }
        .modal-icon { font-size: 4em; margin-bottom: 20px; text-align: center; }
        .modal-buttons { margin-top: 20px; display: flex; gap: 10px; justify-content: center; flex-wrap: wrap; }
        /* Table Wrapper for Horizontal Scroll */
        .table-wrapper {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            margin-top: 20px;
        }
        table { width: 100%; border-collapse: collapse; min-width: 600px; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #ddd; white-space: nowrap; }
        th { background: linear-gradient(135deg, #c44569 0%, #6a1b9a 100%); color: white; font-weight: 600; position: sticky; top: 0; z-index: 10; }
        tr:hover { background: #f5f5f5; }
        
        /* Mobile Responsive Table */
        @media (max-width: 768px) {
            table { min-width: 800px; font-size: 14px; }
            th, td { padding: 8px 6px; }
            .btn-small { padding: 4px 8px; font-size: 12px; }
        }
        .edit-btn { background: #2196F3; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; margin-right: 5px; }
        .edit-btn:hover { background: #1976D2; }
        .delete-btn { background: #f44336; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; }
        .delete-btn:hover { background: #d32f2f; }
        .filter-section { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
        .filter-section select { flex: 1; min-width: 200px; }
        .admin-only { display: none; }
        .super-admin-only { display: none; }
        .jury-only { display: none; }
        .super-jury-only-section { display: none; }
        .student-section { background: #f0f0f0; padding: 20px; border-radius: 8px; margin-bottom: 30px; }
        .cr-section { background: #e3f2fd; padding: 20px; border-radius: 8px; margin-bottom: 20px; border: 2px solid #2196F3; }
        
        /* Jury Sheet Styles */
        .criteria-input-group {
            background: #f9f9f9;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            border: 2px solid #ddd;
        }
        .criteria-input-group input {
            margin-bottom: 10px;
        }
        .remove-criteria-btn {
            background: #f44336;
            color: white;
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
        }
        .marks-table {
            overflow-x: auto;
        }
        .marks-input {
            width: 80px;
            padding: 8px;
            border: 2px solid #ddd;
            border-radius: 4px;
            text-align: center;
        }
        .marks-input:focus {
            border-color: #4CAF50;
        }
        .total-marks {
            font-weight: bold;
            color: #c44569;
            font-size: 1.2em;
        }
        .winner-badge {
            background: #FFD700;
            color: #333;
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: bold;
            display: inline-block;
            margin-left: 10px;
        }
        .runner-badge {
            background: #C0C0C0;
            color: #333;
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: bold;
            display: inline-block;
            margin-left: 10px;
        }
        .jury-password-section {
            background: #fff3cd;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 2px solid #ffc107;
        }
        .results-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        .rank-1 {
            border-left: 5px solid #FFD700;
        }
        .rank-2 {
            border-left: 5px solid #C0C0C0;
        }
        .rank-3 {
            border-left: 5px solid #CD7F32;
        }
        
        @media (max-width: 768px) { 
            .event-grid { grid-template-columns: 1fr; } 
            .filter-section { flex-direction: column; }
            .marks-input { width: 60px; }
        }
        
        /* Firebase Status Indicator */
        .firebase-status {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: white;
            padding: 12px 20px;
            border-radius: 25px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            display: flex;
            align-items: center;
            gap: 10px;
            z-index: 999;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s;
        }
        .firebase-status:hover {
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
            transform: translateY(-2px);
        }
        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }
        .status-connected {
            background: #4CAF50;
            box-shadow: 0 0 10px rgba(76, 175, 80, 0.5);
        }
        .status-disconnected {
            background: #f44336;
            box-shadow: 0 0 10px rgba(244, 67, 54, 0.5);
            animation: blink 1s infinite;
        }
        .status-checking {
            background: #FF9800;
            box-shadow: 0 0 10px rgba(255, 152, 0, 0.5);
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        @keyframes blink {
            0%, 50%, 100% { opacity: 1; }
            25%, 75% { opacity: 0.3; }
        }
        @media (max-width: 768px) {
            .firebase-status {
                bottom: 10px;
                right: 10px;
                padding: 8px 15px;
                font-size: 12px;
            }
            .status-dot {
                width: 10px;
                height: 10px;
            }
        }
        
        /* Edit Date Button Styling */
        .btn-warning { background: #FF9800; }
        .btn-edit-date {
            background: linear-gradient(135deg, #FF9800 0%, #F57C00 100%);
            margin-left: 10px;
        }
        .btn-edit-date:hover {
            box-shadow: 0 6px 20px rgba(255, 152, 0, 0.4);
        }
        
        /* Date Editor Modal */
        .date-picker-group {
            display: flex;
            gap: 15px;
            align-items: center;
            margin: 20px 0;
            flex-wrap: wrap;
        }
        .date-picker-group > div {
            flex: 1;
            min-width: 200px;
        }
        .quiz-list-item {
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .quiz-list-item:hover {
            border-color: #c44569;
            background: #f9f9f9;
        }
        .quiz-list-item.selected {
            border-color: #4CAF50;
            background: #e8f5e9;
        }
        .quiz-date-info {
            font-weight: 600;
            color: #6a1b9a;
        }
        .quiz-question-preview {
            font-size: 0.9em;
            color: #666;
            margin-top: 5px;
        }

        /* â”€â”€ Activity Banners: Quiz / Scavenger Hunt / Speed Slide â”€â”€â”€ */
        @keyframes floatIcon {
            0%,100% { transform: translateY(0px) rotate(-2deg); }
            50%      { transform: translateY(-7px) rotate(2deg); }
        }
        @keyframes glowGreen {
            0%,100% { box-shadow: 0 6px 28px rgba(40,167,69,.4), 0 0 0 0 rgba(40,167,69,.15); }
            50%      { box-shadow: 0 10px 38px rgba(40,167,69,.55), 0 0 0 10px rgba(40,167,69,0); }
        }
        @keyframes glowPurple {
            0%,100% { box-shadow: 0 6px 28px rgba(106,27,154,.4), 0 0 0 0 rgba(106,27,154,.15); }
            50%      { box-shadow: 0 10px 38px rgba(106,27,154,.55), 0 0 0 10px rgba(106,27,154,0); }
        }
        @keyframes glowAmber {
            0%,100% { box-shadow: 0 6px 28px rgba(255,160,0,.4), 0 0 0 0 rgba(255,160,0,.15); }
            50%      { box-shadow: 0 10px 38px rgba(255,160,0,.55), 0 0 0 10px rgba(255,160,0,0); }
        }
        @keyframes liveDot {
            0%,100% { opacity:1; transform:scale(1); }
            50%      { opacity:.4; transform:scale(1.4); }
        }
        @keyframes ctaPop {
            0%,100% { transform:scale(1); }
            50%      { transform:scale(1.04); }
        }
        .act-banner-wrap {
            width:100%;max-width:1200px;margin:0 auto 12px;
            border-radius:18px;padding:18px 22px 18px 20px;
            display:flex;align-items:center;gap:16px;flex-wrap:wrap;
            position:relative;overflow:hidden;
            animation:slideInUp .45s ease-out both;
        }
        .act-banner-wrap::before {
            content:'';position:absolute;inset:0;
            background:repeating-linear-gradient(135deg,rgba(255,255,255,.04) 0px,rgba(255,255,255,.04) 1px,transparent 1px,transparent 24px);
            pointer-events:none;
        }
        .act-banner-icon {
            font-size:2.8em;flex-shrink:0;
            animation:floatIcon 3.2s ease-in-out infinite;
            filter:drop-shadow(0 3px 8px rgba(0,0,0,.25));
        }
        .act-banner-body { flex:1;min-width:180px; }
        .act-banner-title {
            font-size:1.12em;font-weight:800;margin:0 0 3px;
            letter-spacing:.2px;line-height:1.3;
        }
        .act-banner-sub { font-size:.85em;opacity:.9;margin:0;line-height:1.6; }
        .act-banner-cta {
            flex-shrink:0;padding:11px 24px;border-radius:30px;font-weight:800;
            font-size:.88em;border:none;cursor:pointer;letter-spacing:.4px;
            white-space:nowrap;transition:transform .15s,filter .15s;
            animation:ctaPop 2.5s ease-in-out infinite;
        }
        .act-banner-cta:hover { transform:scale(1.07)!important; filter:brightness(1.1); }
        .live-dot {
            display:inline-block;width:9px;height:9px;border-radius:50%;
            margin-right:6px;vertical-align:middle;
            animation:liveDot 1.4s ease-in-out infinite;
        }
        /* countdown chip inside quiz banner */
        .quiz-cdown-chip {
            display:inline-flex;align-items:center;gap:8px;
            background:rgba(255,255,255,.18);backdrop-filter:blur(4px);
            border:1.5px solid rgba(255,255,255,.35);border-radius:30px;
            padding:7px 16px;margin-top:10px;font-size:.88em;font-weight:700;color:white;
        }
        .quiz-cdown-chip span { color:#ffe082;font-size:1.1em;letter-spacing:1px; }
        /* scavenger task pill */
        .sh-task-pill {
            display:inline-flex;align-items:center;gap:6px;
            background:rgba(255,255,255,.18);border:1.5px solid rgba(255,255,255,.35);
            border-radius:20px;padding:4px 12px;font-size:.8em;font-weight:700;
            color:white;margin:3px 3px 0 0;white-space:nowrap;
        }

        /* â”€â”€ Speed Slide Challenge â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        @keyframes sscPop {
            from { transform: scale(.7); opacity: 0; }
            to   { transform: scale(1);  opacity: 1; }
        }
        .ssc-tile {
            background-size: cover; background-position: center;
            border-radius: 7px; cursor: pointer;
            transition: transform .12s, box-shadow .12s;
            box-shadow: inset 0 0 0 2px rgba(255,255,255,.25);
            aspect-ratio: 1;
            touch-action: none;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
        }
        .ssc-tile:hover { transform: scale(1.04); box-shadow: 0 4px 12px rgba(0,0,0,.3); }
        @keyframes sscEmptyPulse {
            0%,100% { box-shadow: inset 0 0 0 3px rgba(255,255,255,.35), 0 0 18px rgba(255,220,0,.3); transform: scale(1); }
            50%      { box-shadow: inset 0 0 0 4px rgba(255,255,150,.85), 0 0 32px rgba(255,220,0,.6); transform: scale(1.04); }
        }
        @keyframes sscEmptyArrow {
            0%,100% { transform: translateY(0); opacity:1; }
            50%      { transform: translateY(-5px); opacity:.5; }
        }
        .ssc-tile.ssc-empty {
            background: linear-gradient(135deg,#ffe600,#ff8c00) !important;
            cursor: default;
            display: flex !important; flex-direction: column; align-items: center; justify-content: center;
            color: #3d0000 !important; font-weight: 900;
            letter-spacing: 1px; text-transform: uppercase;
            animation: sscEmptyPulse 1.2s ease-in-out infinite !important;
            border: 3px solid rgba(255,255,255,.6) !important;
        }
        .ssc-tile.ssc-empty:hover { transform: scale(1.04); }
        @keyframes sscWinPop {
            from { transform: scale(0.5); opacity: 0; }
            to   { transform: scale(1);   opacity: 1; }
        }
        @keyframes sscWinBounce {
            0%   { transform: scale(0) rotate(-15deg); opacity:0; }
            60%  { transform: scale(1.3) rotate(5deg); }
            80%  { transform: scale(0.9) rotate(-3deg); }
            100% { transform: scale(1) rotate(0); opacity:1; }
        }
        @keyframes sscScoreCount {
            from { transform: scale(0.4); opacity:0; }
            to   { transform: scale(1);   opacity:1; }
        }
        @keyframes sscDiffFloat {
            0%,100% { transform: translateY(0); }
            50%     { transform: translateY(-10px); }
        }
        @keyframes sscBoardShake {
            0%,100% { transform: translateX(0); }
            20%,60% { transform: translateX(-6px); }
            40%,80% { transform: translateX(6px); }
        }
        @keyframes sscBooShake {
            0%,100% { transform: translateX(0) rotate(0); }
            20%     { transform: translateX(-8px) rotate(-5deg); }
            40%     { transform: translateX(8px) rotate(5deg); }
            60%     { transform: translateX(-5px) rotate(-3deg); }
            80%     { transform: translateX(5px) rotate(3deg); }
        }
        @keyframes sscEmojiFloat {
            0%   { transform: translateY(0) rotate(0deg) scale(1); opacity:1; }
            100% { transform: translateY(-260px) rotate(720deg) scale(0.1); opacity:0; }
        }
        @keyframes sscBooDrop {
            0%   { transform: translateY(-20px) rotate(0deg); opacity:1; }
            100% { transform: translateY(200px) rotate(-360deg) scale(0.2); opacity:0; }
        }
        .ssc-board-shake { animation: sscBoardShake 0.4s ease; }
        @keyframes vlogGradient {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        @media (max-width: 600px) {
            .vlog-form-grid { grid-template-columns: 1fr !important; }
            .vlog-rules-grid { grid-template-columns: 1fr !important; }
            .vlog-score-grid { grid-template-columns: 1fr !important; }
            .vlog-track-grid { grid-template-columns: 1fr !important; }
            .vlog-phase2-grid { grid-template-columns: 1fr !important; }
            .vlog-admin-grid { grid-template-columns: 1fr !important; }
        }
    </style>

    <style>
        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           SPEED SLIDE CHALLENGE â€” NEW GAME SETUP REDESIGN
           Professional, mobile-first layout
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

        /* â”€â”€ Play section wrapper â”€â”€ */
        #sscPlaySection {
            max-width: 680px !important;
            margin-left: auto !important;
            margin-right: auto !important;
            border-radius: 24px !important;
            padding: 0 !important;
            overflow: hidden;
            background: #ffffff !important;
            border: none !important;
            box-shadow: 0 24px 64px rgba(106,27,154,0.16), 0 4px 20px rgba(0,0,0,0.07) !important;
        }

        /* â”€â”€ Setup card container â”€â”€ */
        #sscSetupCard {
            padding: 32px 28px 28px;
        }

        /* â”€â”€ Title area â”€â”€ */
        #sscSetupCard > div[style*="text-align:center"] {
            background: linear-gradient(135deg, #6a1b9a 0%, #c44569 100%);
            margin: -32px -28px 28px !important;
            padding: 34px 28px 28px !important;
            border-radius: 0 !important;
            position: relative;
            overflow: hidden;
        }
        #sscSetupCard > div[style*="text-align:center"]::before {
            content: '';
            position: absolute; top: -50px; right: -50px;
            width: 160px; height: 160px; border-radius: 50%;
            background: rgba(255,255,255,0.06);
            pointer-events: none;
        }
        #sscSetupCard > div[style*="text-align:center"]::after {
            content: '';
            position: absolute; bottom: -40px; left: -30px;
            width: 120px; height: 120px; border-radius: 50%;
            background: rgba(255,255,255,0.05);
            pointer-events: none;
        }
        #sscSetupCard > div[style*="text-align:center"] > div:first-child {
            filter: drop-shadow(0 4px 8px rgba(0,0,0,0.2));
        }
        #sscSetupCard > div[style*="text-align:center"] h2 {
            color: white !important;
            font-size: 2em !important;
            font-weight: 900 !important;
            letter-spacing: -0.5px !important;
            text-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }
        #sscSetupCard > div[style*="text-align:center"] p {
            color: rgba(255,255,255,0.82) !important;
            font-size: 0.95em !important;
        }

        /* â”€â”€ Step number badges â”€â”€ */
        #sscSetupCard div[style*="width:30px"] {
            box-shadow: 0 4px 12px rgba(106,27,154,0.4);
        }

        /* â”€â”€ Difficulty cards â”€â”€ */
        .ssc-diff-card {
            background: #fafafa;
            border: 2.5px solid #e0e0e0;
            border-radius: 16px;
            padding: 20px 16px 16px;
            cursor: pointer;
            text-align: center;
            transition: all 0.25s ease;
            position: relative;
            overflow: hidden;
        }
        .ssc-diff-card:hover {
            border-color: #9c27b0;
            background: #faf0ff;
            transform: translateY(-3px);
            box-shadow: 0 8px 24px rgba(106,27,154,0.15);
        }
        .ssc-diff-card.ssc-selected {
            border-color: #6a1b9a;
            background: linear-gradient(135deg, #faf0ff 0%, #fce4ec 100%);
            box-shadow: 0 8px 24px rgba(106,27,154,0.2);
            transform: translateY(-2px);
        }
        .ssc-diff-card.ssc-selected::after {
            content: 'âœ“';
            position: absolute;
            top: 8px; right: 10px;
            width: 22px; height: 22px;
            background: linear-gradient(135deg, #6a1b9a, #c44569);
            color: white;
            border-radius: 50%;
            font-size: 0.7em;
            font-weight: 900;
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 22px;
            text-align: center;
        }
        .diff-emoji {
            font-size: 2.2em;
            display: block;
            margin-bottom: 2px;
        }

        /* Grid responsive for difficulty cards */
        #sscSetupCard div[style*="repeat(auto-fit"] {
            grid-template-columns: repeat(3, 1fr) !important;
        }
        @media (max-width: 480px) {
            #sscSetupCard div[style*="repeat(auto-fit"] {
                grid-template-columns: 1fr !important;
                gap: 10px !important;
            }
            .ssc-diff-card {
                display: flex;
                align-items: center;
                gap: 14px;
                padding: 14px 16px;
                text-align: left;
            }
            .diff-emoji { font-size: 1.8em; margin-bottom: 0; flex-shrink: 0; }
            .ssc-diff-card > div:not(.diff-emoji) { flex: 1; }
        }

        /* â”€â”€ Upload zone â”€â”€ */
        .ssc-upload-zone {
            border: 2.5px dashed #ce93d8;
            border-radius: 16px;
            padding: 32px 20px;
            text-align: center;
            cursor: pointer;
            background: linear-gradient(135deg, #faf0ff 0%, #fce4ec 100%);
            transition: all 0.25s ease;
            position: relative;
        }
        .ssc-upload-zone:hover {
            border-color: #6a1b9a;
            background: linear-gradient(135deg, #f3e5f5 0%, #fce4ec 100%);
            box-shadow: 0 6px 20px rgba(106,27,154,0.12);
        }
        .ssc-upload-zone.has-image {
            border-color: #4caf50;
            border-style: solid;
            background: linear-gradient(135deg, #f1f8e9, #e8f5e9);
        }

        /* â”€â”€ Start button â”€â”€ */
        #sscStartBtn {
            border-radius: 14px !important;
            font-size: 1.1em !important;
            font-weight: 800 !important;
            letter-spacing: 0.5px !important;
            transition: all 0.3s ease !important;
        }
        #sscStartBtn:not([disabled]):hover {
            transform: translateY(-2px) !important;
            box-shadow: 0 12px 32px rgba(67,160,71,0.5) !important;
        }

        /* â”€â”€ Paused banner polish â”€â”€ */
        #sscPausedBanner {
            border-radius: 14px !important;
            border-left-width: 5px !important;
        }

        /* â”€â”€ Stat boxes in game area â”€â”€ */
        .ssc-stat-box {
            border-radius: 14px;
            padding: 14px 10px;
            text-align: center;
        }
        .ssc-stat-val {
            font-size: 1.6em;
            font-weight: 900;
            line-height: 1;
        }
        .ssc-stat-lbl {
            font-size: 0.72em;
            color: #888;
            margin-top: 5px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* â”€â”€ Win modal â”€â”€ */
        .ssc-win-inner {
            background: linear-gradient(160deg, #1a0030 0%, #3d0060 60%, #6a1b9a 100%);
            border-radius: 24px;
            padding: 40px 32px 36px;
            max-width: 440px;
            width: 90vw;
            text-align: center;
            box-shadow: 0 32px 80px rgba(0,0,0,0.5);
        }
        .ssc-win-stat {
            background: rgba(255,255,255,0.08);
            border-radius: 12px;
            padding: 14px 10px;
            text-align: center;
            border: 1px solid rgba(255,255,255,0.12);
            flex: 1;
        }

        /* â”€â”€ Responsive â”€â”€ */
        @media (max-width: 600px) {
            #sscPlaySection { border-radius: 18px !important; }
            #sscSetupCard { padding: 24px 16px 22px; }
            #sscSetupCard > div[style*="text-align:center"] {
                margin: -24px -16px 22px !important;
                padding: 26px 18px 22px !important;
            }
            #sscSetupCard > div[style*="text-align:center"] h2 { font-size: 1.6em !important; }
            .ssc-win-inner { padding: 28px 20px 24px; }
        }
    </style>
</head>
<body>
    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <!-- IN-APP REAL-TIME NOTIFICATION TOAST                 -->
    <!-- MUST be a direct child of <body> â€” never nested     -->
    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div id="inAppNotifToast" style="display:none;position:fixed;top:0;left:0;right:0;z-index:999999;background:linear-gradient(135deg,#c44569,#6a1b9a);color:#fff;padding:16px 20px;box-shadow:0 4px 20px rgba(0,0,0,0.5)">
        <div style="display:flex;align-items:flex-start;gap:12px">
            <span style="font-size:1.6em;flex-shrink:0">ðŸ””</span>
            <div style="flex:1;min-width:0">
                <div id="inAppNotifTitle" style="font-weight:800;font-size:0.95em;margin-bottom:4px;word-break:break-word"></div>
                <div id="inAppNotifBody" style="font-size:0.83em;opacity:0.88;word-break:break-word"></div>
            </div>
            <button onclick="dismissInAppToast()" style="background:rgba(255,255,255,0.15);border:none;color:#fff;border-radius:50%;width:26px;height:26px;cursor:pointer;font-size:0.9em;flex-shrink:0;line-height:26px;text-align:center">âœ•</button>
        </div>
        <div id="inAppNotifProgress" style="height:3px;background:rgba(255,255,255,0.3);border-radius:2px;margin-top:12px;overflow:hidden">
            <div id="inAppNotifBar" style="height:100%;background:#c44569;width:100%;transition:width 8s linear"></div>
        </div>
    </div>

    <!-- ðŸ”” PUSH NOTIFICATION PERMISSION BANNER -->
    <div id="notifPermBanner" style="display:none;position:fixed;top:0;left:0;right:0;z-index:9999;background:linear-gradient(135deg,#1a0030,#6a1b9a);color:#fff;padding:12px 20px;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap;box-shadow:0 3px 15px rgba(0,0,0,0.4)">
        <div style="display:flex;align-items:center;gap:10px">
            <span style="font-size:1.4em">ðŸ””</span>
            <span style="font-size:14px;font-weight:600">Get notified about live quizzes & announcements â€” even when this tab is closed</span>
        </div>
        <div style="display:flex;gap:10px;flex-shrink:0">
            <button onclick="requestNotifPermission()" style="background:#c44569;color:#fff;border:none;padding:8px 20px;border-radius:20px;cursor:pointer;font-size:13px;font-weight:700">ðŸ”” Allow</button>
            <button onclick="dismissNotifBanner()" style="background:rgba(255,255,255,0.15);color:#fff;border:2px solid rgba(255,255,255,0.4);padding:8px 16px;border-radius:20px;cursor:pointer;font-size:13px">Later</button>
        </div>
    </div>
    <div class="container">
        <!-- ============================================ -->
        <!-- TO CHANGE BANNER IMAGE:                      -->
        <!-- Replace "banner.gif?v=5" with your file      -->
        <!-- Supported: .gif, .png, .jpg                  -->
        <!-- ============================================ -->
        <img src="banner.gif?v=5" class="banner">
        
        <div class="header">
            <h1>ðŸŽ‰ SPURTHI YOUTH FEST 2026 ðŸŽ‰</h1>
            <p id="userInfo"></p>
        </div>

        <!-- ============================================================ -->
        <!-- ANNOUNCEMENT BANNER (Dynamic - controlled via Firebase)      -->
        <!-- Super Admin can edit text, color, visibility in Site Settings -->
        <!-- ============================================================ -->
        <div id="announcementBannerDiv" style="display:block;width:100%;max-width:1200px;margin:0 auto 22px;border-radius:14px;background:linear-gradient(90deg,#e8722a 0%,#f0a05a 40%,#f0a05a 60%,#e8722a 100%);box-shadow:0 4px 18px rgba(232,114,42,0.35);padding:16px 30px;text-align:center;animation:shimmer 3s linear infinite;background-size:2000px 100%">
            <!-- EDIT BANNER TEXT BELOW OR VIA SUPER ADMIN SITE SETTINGS TAB -->
            <span id="announcementBannerText" style="color:white;font-size:1.1em;font-weight:700;letter-spacing:0.5px;text-shadow:0 1px 4px rgba(0,0,0,0.18)">
                ðŸŽ¯ðŸ§© Speed Slide Challenge is LIVE now ðŸ§©ðŸŽ¯
            </span>
        </div>
        <!-- ============================================================ -->
        <!-- END ANNOUNCEMENT BANNER                                      -->
        <!-- ============================================================ -->

        <!-- ============================================================ -->
        <!-- ACTIVITY BANNERS (Quiz Â· Scavenger Hunt Â· Speed Slide)       -->
        <!-- These are rendered dynamically by initActivityBanners()      -->
        <!-- ============================================================ -->
        <div id="activityBannersContainer" style="width:100%;max-width:1200px;margin:0 auto"></div>
        <!-- ============================================================ -->
        <!-- END ACTIVITY BANNERS                                         -->
        <!-- ============================================================ -->

        <!-- Login/Logout Section (Visible to all) -->
        <div class="content" id="loginSection">
            <h2 id="devTriggerLogin" style="text-align:center;color:#c44569;margin-bottom:20px;font-size:1.5em;letter-spacing:1px">ðŸ” Login Portal</h2>

            <!-- Student Login at Top -->
            <div id="studentLogin" style="background:linear-gradient(135deg,#e8f5e9,#f3e5f5);border-radius:14px;padding:16px 18px;margin-bottom:16px;border:2px solid #ce93d8">
                <div style="display:flex;align-items:center;gap:10px;margin-bottom:10px">
                    <span style="font-size:1.4em">ðŸ§‘â€ðŸŽ“</span>
                    <div>
                        <div style="font-weight:800;color:#6a1b9a;font-size:0.95em">Student Login</div>
                        <div style="color:#888;font-size:0.78em">Login with your quiz credentials to view event registrations</div>
                    </div>
                </div>
                <!-- hidden select kept for populateClassSelects() compatibility -->
                <select id="studentClass" style="display:none"></select>
                <button class="btn" onclick="openStudentLoginModal()" style="background:linear-gradient(135deg,#6a1b9a,#c44569);border:none;width:100%;font-size:0.9em;padding:10px">ðŸ§‘â€ðŸŽ“ Login as Student</button>
            </div>

            <!-- Student Auth Modal -->
            <div id="studentAuthModal" style="display:none;position:fixed;top:0;left:0;right:0;bottom:0;z-index:10001;background:rgba(0,0,0,0.65);align-items:center;justify-content:center;padding:20px">
                <div style="background:white;border-radius:18px;padding:24px;max-width:400px;width:100%;box-shadow:0 8px 40px rgba(106,27,154,0.35);border:2px solid #ce93d8;position:relative">
                    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px">
                        <div style="display:flex;align-items:center;gap:10px">
                            <span style="font-size:1.5em">ðŸ§‘â€ðŸŽ“</span>
                            <div>
                                <div style="font-weight:800;color:#6a1b9a;font-size:1em">Student Login</div>
                                <div style="color:#888;font-size:0.76em">Phone &amp; quiz password required</div>
                            </div>
                        </div>
                        <button onclick="closeStudentAuthModal()" style="background:#f3e5f5;border:none;border-radius:50%;width:30px;height:30px;cursor:pointer;font-size:1em;color:#6a1b9a;font-weight:700;line-height:30px;text-align:center">âœ•</button>
                    </div>
                    <div id="studentAuthMsg" style="display:none;padding:9px 12px;border-radius:8px;font-size:0.84em;font-weight:600;margin-bottom:12px"></div>
                    <div style="margin-bottom:11px">
                        <label style="font-weight:700;color:#555;font-size:0.84em;display:block;margin-bottom:4px">ðŸ“š Your Class</label>
                        <select id="studentClassModal" style="background:white;border:2px solid #ce93d8;border-radius:8px;padding:8px 12px;font-size:0.9em;outline:none;width:100%">
                            <option value="">â€” Select your class â€”</option>
                        </select>
                    </div>
                    <div style="margin-bottom:11px">
                        <label style="font-weight:700;color:#555;font-size:0.84em;display:block;margin-bottom:4px">ðŸ“± Phone Number</label>
                        <input type="tel" id="studentAuthPhone" placeholder="10-digit mobile number" maxlength="10" inputmode="numeric" onkeydown="if(event.key==='Enter')studentAuthLogin()" style="width:100%;padding:9px 12px;border:2px solid #ce93d8;border-radius:8px;font-size:0.9em;outline:none;box-sizing:border-box">
                    </div>
                    <div style="margin-bottom:16px">
                        <label style="font-weight:700;color:#555;font-size:0.84em;display:block;margin-bottom:4px">ðŸ”‘ Quiz Password</label>
                        <input type="password" id="studentAuthPwd" placeholder="Your quiz registration password" onkeydown="if(event.key==='Enter')studentAuthLogin()" style="width:100%;padding:9px 12px;border:2px solid #ce93d8;border-radius:8px;font-size:0.9em;outline:none;box-sizing:border-box">
                    </div>
                    <button onclick="studentAuthLogin()" id="studentAuthBtn" style="background:linear-gradient(135deg,#6a1b9a,#c44569);color:white;border:none;width:100%;padding:11px;border-radius:10px;font-size:0.95em;font-weight:700;cursor:pointer">ðŸ§‘â€ðŸŽ“ Login as Student</button>
                    <p style="margin:10px 0 0;color:#aaa;font-size:0.73em;text-align:center">Only students of that class registered in the quiz system can log in</p>
                </div>
            </div>

            <!-- Divider -->
            <div style="margin:16px 0;display:flex;align-items:center;gap:10px">
                <div style="flex:1;height:1px;background:linear-gradient(90deg,transparent,#ccc,transparent)"></div>
                <span style="color:#aaa;font-size:0.75em;font-weight:700;white-space:nowrap;letter-spacing:1px">YOUTHFEST REGISTRATION &amp; ADMIN</span>
                <div style="flex:1;height:1px;background:linear-gradient(90deg,transparent,#ccc,transparent)"></div>
            </div>

            <!-- Youthfest Registration Dropdown -->
            <div class="form-group">
                <label style="font-weight:700;color:#555;font-size:0.88em">ðŸ« Select Your Role:</label>
                <select id="userType" onchange="handleUserTypeChange()" style="background:white;border:2px solid #c44569;border-radius:10px;padding:10px 14px;font-size:0.93em;outline:none;width:100%;font-weight:600;color:#333;cursor:pointer">
                    <option value="">â€” Select your role â€”</option>
                    <option value="cr">ðŸ“‹ Class Representative (CR)</option>
                    <option value="admin">ðŸ›¡ï¸ Admin</option>
                    <option value="superadmin">ðŸ‘‘ Super Admin</option>
                    <option value="manager">ðŸ“Š Manager</option>
                    <option value="manager2">ðŸ—‚ï¸ Manager 2</option>
                    <option value="jury">âš–ï¸ Jury</option>
                </select>
            </div>

            <!-- CR Login -->
            <div id="crLogin" style="display:none;background:linear-gradient(135deg,#f1f8e9,#e8f5e9);border-radius:12px;padding:16px;border:2px solid #a5d6a7;margin-top:10px">
                <div style="display:flex;align-items:center;gap:8px;margin-bottom:10px">
                    <span style="font-size:1.2em">ðŸ“‹</span>
                    <div style="font-weight:800;color:#2e7d32;font-size:0.9em">Class Representative Login</div>
                </div>
                <div id="crAuthMsg" style="display:none;padding:9px 12px;border-radius:8px;font-size:0.84em;font-weight:600;margin-bottom:10px"></div>
                <div class="form-group">
                    <label style="font-weight:700;color:#555;font-size:0.85em">ðŸ“š Your Class:</label>
                    <select id="crClass" style="background:white;border:2px solid #a5d6a7;border-radius:8px;padding:8px 12px;font-size:0.9em;outline:none;width:100%"></select>
                </div>
                <div class="form-group">
                    <label style="font-weight:700;color:#555;font-size:0.85em">ðŸ“± Phone Number:</label>
                    <input type="tel" id="crAuthPhone" placeholder="10-digit mobile number" maxlength="10" inputmode="numeric" onkeydown="if(event.key==='Enter')crAuthLogin()" style="width:100%;padding:8px 12px;border:2px solid #a5d6a7;border-radius:8px;font-size:0.9em;outline:none;box-sizing:border-box">
                </div>
                <div class="form-group">
                    <label style="font-weight:700;color:#555;font-size:0.85em">ðŸ”‘ Quiz Password:</label>
                    <input type="password" id="crAuthPwd" placeholder="Your quiz registration password" onkeydown="if(event.key==='Enter')crAuthLogin()" style="width:100%;padding:8px 12px;border:2px solid #a5d6a7;border-radius:8px;font-size:0.9em;outline:none;box-sizing:border-box">
                </div>
                <div style="margin-bottom:12px">
                    <label style="display:flex;align-items:center;gap:8px;cursor:pointer;font-size:0.88em;color:#555;font-weight:normal">
                        <input type="checkbox" id="crRememberMe" style="width:auto;accent-color:#6a1b9a"> ðŸ’¾ Remember my class on this device
                    </label>
                </div>
                <button class="btn" onclick="crAuthLogin()" style="background:linear-gradient(135deg,#2e7d32,#66bb6a);border:none;width:100%;font-size:0.9em;padding:10px">ðŸ“‹ Login as CR</button>
            </div>

            <!-- Admin Login -->
            <div id="adminLogin" style="display:none;background:linear-gradient(135deg,#fff3e0,#fce4ec);border-radius:12px;padding:16px;border:2px solid #ffab40;margin-top:10px">
                <div style="display:flex;align-items:center;gap:8px;margin-bottom:10px">
                    <span style="font-size:1.2em">ðŸ›¡ï¸</span>
                    <div style="font-weight:800;color:#e65100;font-size:0.9em">Admin Login</div>
                </div>
                <div class="form-group">
                    <label style="font-weight:700;color:#555;font-size:0.85em">ðŸ”‘ Admin Password:</label>
                    <input type="password" id="adminPassword" placeholder="Enter admin password" onkeydown="if(event.key==='Enter') adminLogin()" style="width:100%;padding:9px 12px;border:2px solid #ffab40;border-radius:8px;font-size:0.9em;outline:none;box-sizing:border-box">
                </div>
                <div style="margin-bottom:12px">
                    <label style="display:flex;align-items:center;gap:8px;cursor:pointer;font-size:0.88em;color:#555;font-weight:normal">
                        <input type="checkbox" id="adminRememberMe" style="width:auto;accent-color:#e65100"> ðŸ’¾ Remember password on this device
                    </label>
                </div>
                <button class="btn" onclick="adminLogin()" style="background:linear-gradient(135deg,#e65100,#ff7043);border:none;width:100%;font-size:0.9em;padding:10px">ðŸ›¡ï¸ Login as Admin</button>
            </div>

            <!-- Super Admin Login -->
            <div id="superAdminLogin" style="display:none;background:linear-gradient(135deg,#fff8e1,#f3e5f5);border-radius:12px;padding:16px;border:2px solid #ffd54f;margin-top:10px">
                <div style="display:flex;align-items:center;gap:8px;margin-bottom:10px">
                    <span style="font-size:1.2em">ðŸ‘‘</span>
                    <div style="font-weight:800;color:#6a1b9a;font-size:0.9em">Super Admin Login</div>
                </div>
                <div class="form-group">
                    <label style="font-weight:700;color:#555;font-size:0.85em">ðŸ”‘ Super Admin Password:</label>
                    <input type="password" id="superAdminPassword" placeholder="Enter super admin password" onkeydown="if(event.key==='Enter') superAdminLogin()" style="width:100%;padding:9px 12px;border:2px solid #ffd54f;border-radius:8px;font-size:0.9em;outline:none;box-sizing:border-box">
                </div>
                <div style="margin-bottom:12px">
                    <label style="display:flex;align-items:center;gap:8px;cursor:pointer;font-size:0.88em;color:#555;font-weight:normal">
                        <input type="checkbox" id="superAdminRememberMe" style="width:auto;accent-color:#6a1b9a"> ðŸ’¾ Remember password on this device
                    </label>
                </div>
                <button class="btn" onclick="superAdminLogin()" style="background:linear-gradient(135deg,#6a1b9a,#c44569);border:none;width:100%;font-size:0.9em;padding:10px">ðŸ‘‘ Login as Super Admin</button>
            </div>

            <!-- Manager Login -->
            <div id="managerLogin" style="display:none;background:linear-gradient(135deg,#e3f2fd,#e8f5e9);border-radius:12px;padding:16px;border:2px solid #90caf9;margin-top:10px">
                <div style="display:flex;align-items:center;gap:8px;margin-bottom:10px">
                    <span style="font-size:1.2em">ðŸ“Š</span>
                    <div style="font-weight:800;color:#1565c0;font-size:0.9em">Manager Login</div>
                </div>
                <div class="form-group">
                    <label style="font-weight:700;color:#555;font-size:0.85em">ðŸ”‘ Manager Password:</label>
                    <input type="password" id="managerPassword" placeholder="Enter manager password" onkeydown="if(event.key==='Enter') managerLogin()" style="width:100%;padding:9px 12px;border:2px solid #90caf9;border-radius:8px;font-size:0.9em;outline:none;box-sizing:border-box">
                </div>
                <div style="margin-bottom:12px">
                    <label style="display:flex;align-items:center;gap:8px;cursor:pointer;font-size:0.88em;color:#555;font-weight:normal">
                        <input type="checkbox" id="managerRememberMe" style="width:auto;accent-color:#2196F3"> ðŸ’¾ Remember password on this device
                    </label>
                </div>
                <button class="btn" onclick="managerLogin()" style="background:linear-gradient(135deg,#1565c0,#42a5f5);border:none;width:100%;font-size:0.9em;padding:10px">ðŸ“Š Login as Manager</button>
            </div>

            <!-- Manager 2 Login -->
            <div id="manager2Login" style="display:none;background:linear-gradient(135deg,#f3e5f5,#ede7f6);border-radius:12px;padding:16px;border:2px solid #ce93d8;margin-top:10px">
                <div style="display:flex;align-items:center;gap:8px;margin-bottom:10px">
                    <span style="font-size:1.2em">ðŸ—‚ï¸</span>
                    <div style="font-weight:800;color:#7b1fa2;font-size:0.9em">Manager 2 Login</div>
                </div>
                <div class="form-group">
                    <label style="font-weight:700;color:#555;font-size:0.85em">ðŸ”‘ Manager 2 Password:</label>
                    <input type="password" id="manager2Password" placeholder="Enter Manager 2 password" onkeydown="if(event.key==='Enter') manager2Login()" style="width:100%;padding:9px 12px;border:2px solid #ce93d8;border-radius:8px;font-size:0.9em;outline:none;box-sizing:border-box">
                </div>
                <div style="margin-bottom:12px">
                    <label style="display:flex;align-items:center;gap:8px;cursor:pointer;font-size:0.88em;color:#555;font-weight:normal">
                        <input type="checkbox" id="manager2RememberMe" style="width:auto;accent-color:#9c27b0"> ðŸ’¾ Remember password on this device
                    </label>
                </div>
                <button class="btn" onclick="manager2Login()" style="background:linear-gradient(135deg,#7b1fa2,#ab47bc);border:none;width:100%;font-size:0.9em;padding:10px">ðŸ—‚ï¸ Login as Manager 2</button>
            </div>

            <!-- Jury Login -->
            <div id="juryLogin" style="display:none;background:linear-gradient(135deg,#e8f5e9,#e0f7fa);border-radius:12px;padding:16px;border:2px solid #80cbc4;margin-top:10px">
                <div style="display:flex;align-items:center;gap:8px;margin-bottom:10px">
                    <span style="font-size:1.2em">âš–ï¸</span>
                    <div style="font-weight:800;color:#00695c;font-size:0.9em">Jury Login</div>
                </div>
                <div class="form-group">
                    <label style="font-weight:700;color:#555;font-size:0.85em">ðŸŽ­ Select Event:</label>
                    <select id="juryEvent" style="background:white;border:2px solid #80cbc4;border-radius:8px;padding:8px 12px;font-size:0.9em;outline:none;width:100%"></select>
                </div>
                <div class="form-group">
                    <label style="font-weight:700;color:#555;font-size:0.85em">ðŸ”‘ Jury Password:</label>
                    <input type="password" id="juryPassword" placeholder="Enter jury password for this event" onkeydown="if(event.key==='Enter') juryLogin()" style="width:100%;padding:9px 12px;border:2px solid #80cbc4;border-radius:8px;font-size:0.9em;outline:none;box-sizing:border-box">
                </div>
                <div class="form-group">
                    <label style="font-weight:700;color:#555;font-size:0.85em">ðŸ‘¤ Jury Number:</label>
                    <select id="juryNumber" style="background:white;border:2px solid #80cbc4;border-radius:8px;padding:8px 12px;font-size:0.9em;outline:none;width:100%">
                        <option value="">â€” Select â€”</option>
                        <option value="1">âš–ï¸ Jury 1</option>
                        <option value="2">âš–ï¸ Jury 2</option>
                    </select>
                </div>
                <button class="btn" onclick="juryLogin()" style="background:linear-gradient(135deg,#00695c,#26a69a);border:none;width:100%;font-size:0.9em;padding:10px">âš–ï¸ Login as Jury</button>
            </div>
            
            <div style="margin: 30px 0; border-top: 2px solid #ddd;"></div>
            
            <!-- Online Competition Dropdown -->
            <div class="form-group">
                <label>Online Competition</label>
                <select id="competitionType" onchange="handleCompetitionChange()">
                    <option value="">-- Select --</option>
                    <option value="dailyquiz">Daily Quiz Competition</option>
                    <option value="scavengerhunt">ðŸ—ºï¸ Scavenger Hunt</option>
                    <option value="speedslide">ðŸ§© Speed Slide Challenge</option>
                </select>
            </div>
            
            <!-- Daily Quiz Competition Login -->
            <div id="dailyQuizLogin" style="display:none">
                <!-- Public Quiz Status (shows before login) -->
                <div id="publicQuizStatus" style="margin-bottom:30px">
                    <h3 style="color:#c44569;margin-bottom:20px;font-size:1.8em;text-align:center">ðŸ“ Today's Daily Quiz Competition</h3>
                    <div id="publicQuizMessage" class="quiz-status-card" style="padding:25px;background:white;border-radius:15px;border-left:5px solid #667eea;box-shadow:0 6px 20px rgba(0,0,0,0.1)">
                        <p style="margin:0;color:#666;text-align:center">Checking today's quiz status...</p>
                    </div>
                </div>

                <!-- Past Results Lookup -->
                <div style="background:white;border-radius:14px;padding:18px 20px;margin-bottom:24px;box-shadow:0 4px 16px rgba(0,0,0,0.08);border:2px solid #e0e0e0">
                    <div style="display:flex;align-items:center;gap:10px;margin-bottom:14px;flex-wrap:wrap">
                        <span style="font-size:1.4em">ðŸ“…</span>
                        <h4 style="margin:0;color:#6a1b9a;font-size:1em">Check Past Quiz Results</h4>
                    </div>
                    <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
                        <input type="date" id="pastResultDate"
                            style="flex:1;min-width:150px;padding:10px 14px;border:2px solid #9c27b0;border-radius:10px;font-size:14px;color:#333;cursor:pointer">
                        <button onclick="loadPastQuizResult()" style="background:linear-gradient(135deg,#6a1b9a,#c44569);color:white;border:none;padding:10px 20px;border-radius:10px;font-size:14px;font-weight:700;cursor:pointer;white-space:nowrap">ðŸ” Check Result</button>
                    </div>
                    <div id="pastResultBox" style="margin-top:14px;display:none"></div>
                </div>
                
                <!-- Quiz Archive: Browse older published quizzes -->
                <div style="background:white;border-radius:14px;padding:18px 20px;margin-bottom:24px;box-shadow:0 4px 16px rgba(0,0,0,0.08);border:2px solid #ce93d8">
                    <div style="display:flex;align-items:center;gap:10px;margin-bottom:6px;flex-wrap:wrap">
                        <span style="font-size:1.4em">ðŸ“š</span>
                        <h4 style="margin:0;color:#6a1b9a;font-size:1em">Quiz Archive â€“ View Older Published Quizzes</h4>
                    </div>
                    <p style="margin:0 0 14px 0;color:#888;font-size:0.88em">Browse questions, answers &amp; attachments from any previously published quiz.</p>
                    <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
                        <select id="quizArchiveDateSelect" style="flex:1;min-width:180px;padding:10px 14px;border:2px solid #9c27b0;border-radius:10px;font-size:14px;color:#333;background:white;cursor:pointer">
                            <option value="">â³ Loading published dates...</option>
                        </select>
                        <button onclick="loadQuizArchiveEntry()" style="background:linear-gradient(135deg,#6a1b9a,#c44569);color:white;border:none;padding:10px 20px;border-radius:10px;font-size:14px;font-weight:700;cursor:pointer;white-space:nowrap">ðŸ‘ï¸ View Quiz</button>
                    </div>
                    <div id="quizArchiveBox" style="margin-top:16px;display:none"></div>
                </div>

                <hr style="margin:30px 0;border:none;border-top:2px solid #e9ecef">
                
                <h3 style="color:#6a1b9a;margin-bottom:15px">Student Registration & Login</h3>
                <div id="quizMessage" class="message"></div>
                
                <div style="background:#fff3cd;padding:15px;border-radius:8px;margin-bottom:20px;border-left:4px solid #ffc107">
                    <p style="margin:0;color:#856404"><strong>New Student?</strong> Register to get password</p>
                </div>
                
                <div class="form-group">
                    <label>Select Class:</label>
                    <select id="quizClass"></select>
                </div>
                <div class="form-group">
                    <label>Email Address:</label>
                    <input type="email" id="quizEmail" placeholder="your.email@example.com">
                </div>
                <div class="form-group">
                    <label>Phone Number:</label>
                    <input type="tel" id="quizPhone" placeholder="10-digit mobile number">
                </div>
                <div class="form-group">
                    <label>Full Name:</label>
                    <input type="text" id="quizName" placeholder="Enter your full name">
                </div>
                <button class="btn" onclick="registerQuizStudent()" style="margin-bottom:10px">ðŸ“ Register & Get Password</button>
                
                <hr style="margin:25px 0;border:none;border-top:2px solid #e9ecef">
                
                <div style="background:#d4edda;padding:15px;border-radius:8px;margin-bottom:20px;border-left:4px solid #28a745">
                    <p style="margin:0;color:#155724"><strong>Already Registered?</strong> Login with your phone number and password</p>
                </div>
                
                <div class="form-group">
                    <label>Phone Number:</label>
                    <input type="tel" id="quizLoginPhone" placeholder="Enter 10-digit phone number" maxlength="10" inputmode="numeric" pattern="[0-9]*" autocomplete="tel" onkeydown="if(event.key==='Enter') loginQuizStudent()">
                </div>
                <div class="form-group">
                    <label>Password:</label>
                    <input type="password" id="quizLoginPassword" placeholder="Enter password" onkeydown="if(event.key==='Enter') loginQuizStudent()">
                </div>
                <div style="margin-bottom:12px">
                    <label style="display:flex;align-items:center;gap:8px;cursor:pointer;font-size:0.9em;color:#555;font-weight:normal">
                        <input type="checkbox" id="quizRememberMe" style="width:auto;accent-color:#6a1b9a"> Remember me on this device
                    </label>
                </div>
                <button class="btn btn-success" onclick="loginQuizStudent()">ðŸš€ Login to Quiz</button>
            </div>

            <!-- ============================================ -->
            <!-- SCAVENGER HUNT LOGIN                         -->
            <!-- ============================================ -->
            <div id="scavengerHuntLogin" style="display:none">
                <div style="text-align:center;margin-bottom:24px">
                    <div style="font-size:3em;margin-bottom:8px">ðŸ—ºï¸</div>
                    <h3 style="color:#6a1b9a;font-size:1.8em;margin-bottom:6px">Scavenger Hunt</h3>
                    <p style="color:#666;font-size:1em">Find locations Â· Take photos Â· Win prizes!</p>
                </div>

                <!-- Hunt Status Banner -->
                <div id="shPublicBanner" style="background:linear-gradient(135deg,#9c27b0,#e91e63);color:white;border-radius:14px;padding:18px 22px;margin-bottom:22px;text-align:center">
                    <p style="margin:0;font-size:1em;opacity:0.9">â³ Checking hunt status...</p>
                </div>

                <div style="background:#f3e5f5;padding:15px;border-radius:8px;margin-bottom:20px;border-left:4px solid #9c27b0">
                    <p style="margin:0;color:#6a1b9a"><strong>ðŸ“‹ How it works:</strong> Login â†’ Get tasks â†’ Visit locations â†’ Upload photo proof â†’ Admin verifies â†’ First to finish wins! ðŸ†</p>
                </div>

                <div style="background:#e8f5e9;padding:15px;border-radius:8px;margin-bottom:20px;border-left:4px solid #4caf50">
                    <p style="margin:0;color:#2e7d32"><strong>ðŸ“ GPS Version Active:</strong> App auto-detects your location. You must be within 100 metres of the target to upload your photo.</p>
                </div>

                <h4 style="color:#6a1b9a;margin-bottom:14px">Login with your Quiz account</h4>
                <div id="shLoginMsg" class="message"></div>
                <div class="form-group">
                    <label>Phone Number:</label>
                    <input type="tel" id="shLoginPhone" placeholder="Enter 10-digit phone number" maxlength="10" inputmode="numeric" onkeydown="if(event.key==='Enter') shLogin()">
                </div>
                <div class="form-group">
                    <label>Password:</label>
                    <input type="password" id="shLoginPassword" placeholder="Enter password" onkeydown="if(event.key==='Enter') shLogin()">
                </div>
                <div style="margin-bottom:14px">
                    <label style="display:flex;align-items:center;gap:8px;cursor:pointer;font-size:0.9em;color:#555;font-weight:normal">
                        <input type="checkbox" id="shRememberMe" style="width:auto;accent-color:#9c27b0"> Remember me on this device
                    </label>
                </div>
                <button class="btn sh-glow" onclick="shLogin()" style="background:linear-gradient(135deg,#9c27b0,#e91e63);color:white;width:100%;font-size:1.1em;padding:15px;border-radius:12px;font-weight:700;letter-spacing:0.5px;margin-bottom:8px">
                    ðŸš€ Enter Scavenger Hunt
                </button>
            </div>

            <!-- ============================================ -->
            <!-- SPEED SLIDE CHALLENGE LOGIN                   -->
            <!-- ============================================ -->
            <div id="speedSlideLogin" style="display:none">
                <div style="text-align:center;margin-bottom:20px">
                    <div style="font-size:3em;margin-bottom:8px">ðŸ§©</div>
                    <h3 style="color:#6a1b9a;font-size:1.8em;margin-bottom:6px">Speed Slide Challenge</h3>
                    <p style="color:#666;font-size:1em">Upload any photo Â· Solve the sliding puzzle Â· Win points!</p>
                </div>
                <div style="background:linear-gradient(135deg,#6a1b9a,#c44569);border-radius:14px;padding:14px 20px;text-align:center;margin-bottom:18px">
                    <p style="color:white;margin:0;font-size:.95em;font-weight:600">ðŸ§© 3 levels Â· 8-Puzzle (100pts) Â· 15-Puzzle (200pts) Â· 24-Puzzle (300pts)</p>
                </div>
                <div style="background:#f3e5f5;padding:12px 16px;border-radius:8px;margin-bottom:18px;border-left:4px solid #9c27b0">
                    <p style="margin:0;color:#6a1b9a;font-size:.9em"><strong>ðŸ“‹ How it works:</strong> Login â†’ Upload photo â†’ Solve puzzle â†’ Submit score â†’ Leaderboard!</p>
                </div>
                <div id="sscLoginMsg" class="message"></div>
                <div class="form-group">
                    <label>Phone Number:</label>
                    <input type="tel" id="sscLoginPhone" placeholder="10-digit mobile number" maxlength="10" inputmode="numeric" onkeydown="if(event.key==='Enter') sscLogin()">
                </div>
                <div class="form-group">
                    <label>Password:</label>
                    <input type="password" id="sscLoginPassword" placeholder="Your quiz password" onkeydown="if(event.key==='Enter') sscLogin()">
                </div>
                <div style="margin-bottom:14px">
                    <label style="display:flex;align-items:center;gap:8px;cursor:pointer;font-weight:normal;color:#555;font-size:.9em">
                        <input type="checkbox" id="sscRememberMe" style="width:auto;accent-color:#6a1b9a"> Remember me on this device
                    </label>
                </div>
                <button class="btn" onclick="sscLogin()" style="background:linear-gradient(135deg,#6a1b9a,#c44569);width:100%;padding:14px;font-size:1.05em">ðŸš€ Login &amp; Play</button>
            </div>
        </div>

        <!-- Student Enrollment Section -->
        <div class="student-section" id="studentSection" style="display:none">
            <button class="btn btn-secondary" onclick="logout()" style="float:right">Logout</button>
            <h2 style="color:#c44569;margin-bottom:20px">Student Enrollment</h2>
            <div id="enrollMessage" class="message"></div>
            
            <div class="class-indicator" id="classIndicator">
                <h3>You are enrolling for</h3>
                <div class="class-name" id="currentClassName"></div>
            </div>

            <!-- View Class Enrollments Section -->
            <div style="background:#e3f2fd;padding:20px;border-radius:8px;margin-bottom:20px;border:2px solid #2196F3;">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:15px;">
                    <h3 style="color:#1976D2;margin:0;">ðŸ“Š Your Class Enrollments</h3>
                    <button class="btn btn-small" onclick="toggleEnrollmentView()" id="toggleEnrollmentBtn">
                        Hide Details
                    </button>
                </div>
                
                <!-- Event Filter -->
                <div class="form-group" style="margin-bottom:15px;">
                    <label>Filter by Event:</label>
                    <select id="studentEventFilter" onchange="viewStudentClassEnrollments()">
                        <option value="">All Events</option>
                    </select>
                </div>
                
                <div id="studentEnrollmentResults"></div>
            </div>

            <div class="form-group">
                <label>Select Event to Enroll:</label>
                <div class="event-grid" id="eventCardsContainer"></div>
            </div>

            <div id="enrollmentForm" style="display:none">
                <div id="enrollmentFormContent"></div>
                <div id="enrollBtnsNormal">
                    <button class="btn" onclick="submitEnrollment(false)">Submit Enrollment</button>
                    <button class="btn btn-secondary" onclick="cancelEnrollment()">Cancel</button>
                </div>
                <div id="enrollBtnsOneAtATime" style="display:none">
                    <button class="btn btn-success" onclick="submitEnrollment(true)" style="margin-right:10px">âœ… Submit & Add Another</button>
                    <button class="btn" onclick="submitEnrollment(false)">âœ” Submit & Finish</button>
                    <button class="btn btn-secondary" onclick="cancelEnrollment()">Cancel</button>
                </div>
            </div>
        </div>

        <!-- CR Section -->
        <div class="cr-section" id="crSection" style="display:none">
            <button class="btn btn-secondary" onclick="logout()" style="float:right">Logout</button>
            <h2 style="color:#2196F3;margin-bottom:20px">Class Representative Dashboard</h2>
            <div id="crMessage" class="message"></div>
            
            <div class="class-indicator active">
                <h3>Managing Class</h3>
                <div class="class-name" id="crClassName"></div>
            </div>

            <div class="tabs">
                <button class="tab active" onclick="showCRTab('crEnroll')">Enroll Students</button>
                <button class="tab" onclick="showCRTab('crView')">View Enrollments</button>
                <button class="tab" onclick="showCRTab('crQuizStats');loadCRQuizStats()">ðŸ§  Quiz Stats</button>
                <button class="tab" onclick="showCRTab('crScavengerStats');loadCRScavengerStats()">ðŸ—ºï¸ Scavenger Hunt</button>
                <button class="tab" onclick="showCRTab('crVlogChallenge');checkVlogEventActive();loadVlogSubmissions();initVlogDailyScreenshots()">ðŸ“¹ Vlog Challenge</button>
                <button class="tab" onclick="showCRTab('crPodCasting');checkPodcastEventActive();loadPodcastSubmissions()">ðŸŽ™ï¸ Pod Casting</button>
                <button class="tab" onclick="showCRTab('crBestOutWaste');loadBOWSubmissions()">â™»ï¸ Best Out of Waste</button>
                <button class="tab" id="crYtAdTab" onclick="showCRTab('crYtAd');checkYtAdEventActive();loadYtAdSubmissions()">ðŸ“º YT Advertisement</button>
                <button class="tab" onclick="showCRTab('crNukkadNatak');loadCRNukkadPanel()">ðŸŽ­ Nukkad Natak</button>
                <button class="tab" onclick="showCRTab('crGroupDance');loadCRDancePanel()">ðŸ’ƒ Group Dance</button>
            </div>

            <div id="crEnroll" class="form-section active">
                <h3 style="margin-bottom:20px">Enroll Students for Your Class</h3>
                <div class="form-group">
                    <label>Select Event:</label>
                    <div class="event-grid" id="crEventCardsContainer"></div>
                </div>

                <div id="crEnrollmentForm" style="display:none">
                    <div id="crEnrollmentFormContent"></div>
                    <div id="crEnrollBtnsNormal">
                        <button class="btn" onclick="submitCREnrollment(false)">Submit Enrollment</button>
                        <button class="btn btn-secondary" onclick="cancelCREnrollment()">Cancel</button>
                    </div>
                    <div id="crEnrollBtnsOneAtATime" style="display:none">
                        <button class="btn btn-success" onclick="submitCREnrollment(true)" style="margin-right:10px">âœ… Submit & Add Another</button>
                        <button class="btn" onclick="submitCREnrollment(false)">âœ” Submit & Finish</button>
                        <button class="btn btn-secondary" onclick="cancelCREnrollment()">Cancel</button>
                    </div>
                </div>
            </div>

            <div id="crView" class="form-section">
                <h3 style="margin-bottom:20px">Your Class Enrollments</h3>
                <div class="filter-section">
                    <select id="crFilterEvent" onchange="updateCRView()">
                        <option value="">All Events</option>
                    </select>
                    <button class="btn btn-small" onclick="clearCRFilters()">Clear Filters</button>
                    <button class="btn btn-small btn-success" onclick="downloadCREnrollments()">ðŸ“¥ Download Enrollments</button>
                </div>
                <div id="crSummary" style="margin-bottom:20px"></div>

                <!-- CR Summary Report â€” Copyable -->
                <div style="background:#fffde7;border-radius:12px;border:2px solid #ffc107;padding:16px 18px;margin-bottom:18px">
                    <div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:8px;margin-bottom:10px">
                        <h4 style="color:#856404;margin:0;font-size:0.95em">ðŸ“‹ Class Summary Report â€” Share with Students</h4>
                        <div style="display:flex;gap:8px">
                            <button onclick="generateCRSummaryReport()" style="background:#ffc107;color:#1a0030;border:none;border-radius:7px;padding:6px 14px;font-size:0.82em;font-weight:700;cursor:pointer">ðŸ”„ Generate</button>
                            <button onclick="copyCRSummaryReport()" style="background:#2e7d32;color:white;border:none;border-radius:7px;padding:6px 14px;font-size:0.82em;font-weight:700;cursor:pointer">ðŸ“‹ Copy</button>
                        </div>
                    </div>
                    <textarea id="crSummaryReportText" readonly style="width:100%;min-height:130px;border:1px solid #ffe082;border-radius:8px;padding:9px 12px;font-family:monospace;font-size:0.8em;color:#333;background:#fffef5;resize:vertical;outline:none" placeholder="Click 'Generate' to build a shareable summary for your classâ€¦"></textarea>
                    <div id="crSummaryReportCopied" style="display:none;margin-top:5px;color:#2e7d32;font-size:0.78em;font-weight:700">âœ… Copied! Paste directly into WhatsApp.</div>
                </div>

                <div id="crEnrollmentsContainer"></div>
            </div>

            <!-- â”€â”€ CR SCAVENGER HUNT STATS TAB â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
            <div id="crScavengerStats" class="form-section">
                <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:10px;margin-bottom:14px">
                    <h3 style="color:#6a1b9a;margin:0">ðŸ—ºï¸ Scavenger Hunt â€” Your Class Stats</h3>
                    <button class="btn btn-small btn-info" onclick="loadCRScavengerStats()">ðŸ”„ Refresh</button>
                </div>

                <!-- Task Filter Bar -->
                <div style="background:linear-gradient(135deg,#6a1b9a,#c44569);border-radius:12px;padding:12px 18px;margin-bottom:16px;display:flex;align-items:center;gap:12px;flex-wrap:wrap">
                    <label style="color:white;font-weight:700;font-size:0.9em;white-space:nowrap">ðŸ” Filter by Task:</label>
                    <select id="crShTaskFilter" onchange="crShApplyTaskFilter()" style="flex:1;min-width:200px;padding:8px 12px;border-radius:8px;border:none;font-size:0.9em;color:#3d0060;font-weight:600;outline:none">
                        <option value="">â€” All Tasks â€”</option>
                    </select>
                    <span id="crShTaskBadge" style="display:none;background:white;color:#6a1b9a;padding:4px 12px;border-radius:20px;font-size:0.8em;font-weight:700;max-width:220px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap"></span>
                </div>

                <!-- Info summary box -->
                <div id="crShInfoBox" style="background:#fffde7;border-radius:10px;padding:16px 18px;margin-bottom:16px;border-left:4px solid #ffc107">
                    <h4 style="color:#856404;margin:0 0 5px;font-size:0.9em">ðŸ“‹ Scavenger Hunt Participation Summary â€” <span id="crShInfoDate">Loadingâ€¦</span></h4>
                    <div id="crShInfoText" style="color:#555;font-size:13px;line-height:1.75">Loading your class's scavenger hunt dataâ€¦</div>
                </div>

                <!-- Stats cards -->
                <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:12px;margin-bottom:18px">
                    <div style="background:linear-gradient(135deg,#667eea,#764ba2);border-radius:10px;padding:16px;text-align:center">
                        <div style="font-size:1.8em;font-weight:800;color:white" id="crShTotal">â€”</div>
                        <div style="color:rgba(255,255,255,0.8);font-size:12px;margin-top:4px">Participants</div>
                    </div>
                    <div style="background:linear-gradient(135deg,#28a745,#20c997);border-radius:10px;padding:16px;text-align:center">
                        <div style="font-size:1.8em;font-weight:800;color:white" id="crShApproved">â€”</div>
                        <div style="color:rgba(255,255,255,0.8);font-size:12px;margin-top:4px">Approved Tasks</div>
                    </div>
                    <div style="background:linear-gradient(135deg,#ffc107,#ff9800);border-radius:10px;padding:16px;text-align:center">
                        <div style="font-size:1.8em;font-weight:800;color:white" id="crShPending">â€”</div>
                        <div style="color:rgba(255,255,255,0.8);font-size:12px;margin-top:4px">Pending Review</div>
                    </div>
                    <div style="background:linear-gradient(135deg,#c44569,#e91e63);border-radius:10px;padding:16px;text-align:center">
                        <div style="font-size:1.8em;font-weight:800;color:white" id="crShRejected">â€”</div>
                        <div style="color:rgba(255,255,255,0.8);font-size:12px;margin-top:4px">Rejected</div>
                    </div>
                </div>

                <!-- Student list -->
                <div style="background:white;border-radius:10px;border:2px solid #e0c8f5;overflow:hidden">
                    <div style="background:linear-gradient(135deg,#6a1b9a,#c44569);padding:12px 16px">
                        <h4 style="color:white;margin:0;font-size:0.95em">Your Class Students â€” Scavenger Hunt Submissions</h4>
                    </div>
                    <div class="table-wrapper" style="margin:0">
                        <table>
                            <thead id="crShTableHead">
                                <tr>
                                    <th>#</th>
                                    <th>Student Name</th>
                                    <th>Tasks Submitted</th>
                                    <th>Approved</th>
                                    <th>Pending</th>
                                    <th>Rejected</th>
                                </tr>
                            </thead>
                            <tbody id="crShTable"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- â”€â”€ CR QUIZ STATS TAB â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
            <div id="crQuizStats" class="form-section">
                <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:10px;margin-bottom:18px">
                    <h3 style="color:#6a1b9a;margin:0">ðŸ§  Online Quiz â€” Your Class Stats</h3>
                    <div style="display:flex;gap:8px;align-items:center">
                        <select id="crQsDateFilter" onchange="loadCRQuizStats()" style="padding:7px 12px;border:2px solid #6a1b9a;border-radius:8px;color:#3d0060;font-weight:600;background:white;outline:none">
                            <option value="">â€” Select Date â€”</option>
                        </select>
                        <button class="btn btn-small btn-info" onclick="loadCRQuizStats()">ðŸ”„ Refresh</button>
                    </div>
                </div>

                <!-- Info notice box â€” visible to CR -->
                <div id="crQsInfoBox" style="background:#fffde7;border-radius:10px;padding:16px 18px;margin-bottom:16px;border-left:4px solid #ffc107">
                    <h4 style="color:#856404;margin:0 0 5px;font-size:0.9em">ðŸ“‹ Quiz Participation Summary â€” <span id="crQsInfoDate">select a date</span></h4>
                    <div id="crQsInfoText" style="color:#555;font-size:13px;line-height:1.75">Select a date above to see your class's quiz participation details.</div>
                </div>

                <!-- Stats cards for CR's class -->
                <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:12px;margin-bottom:18px" id="crQsCards">
                    <div style="background:linear-gradient(135deg,#667eea,#764ba2);border-radius:10px;padding:16px;text-align:center">
                        <div style="font-size:1.8em;font-weight:800;color:white" id="crQsTotal">â€”</div>
                        <div style="color:rgba(255,255,255,0.8);font-size:12px;margin-top:4px">Participated</div>
                    </div>
                    <div style="background:linear-gradient(135deg,#28a745,#20c997);border-radius:10px;padding:16px;text-align:center">
                        <div style="font-size:1.8em;font-weight:800;color:white" id="crQsCorrect">â€”</div>
                        <div style="color:rgba(255,255,255,0.8);font-size:12px;margin-top:4px">Both Correct</div>
                    </div>
                    <div style="background:linear-gradient(135deg,#ffc107,#ff9800);border-radius:10px;padding:16px;text-align:center">
                        <div style="font-size:1.8em;font-weight:800;color:white" id="crQsPartial">â€”</div>
                        <div style="color:rgba(255,255,255,0.8);font-size:12px;margin-top:4px">Partial (1/2)</div>
                    </div>
                    <div style="background:linear-gradient(135deg,#c44569,#e91e63);border-radius:10px;padding:16px;text-align:center">
                        <div style="font-size:1.8em;font-weight:800;color:white" id="crQsRate">â€”</div>
                        <div style="color:rgba(255,255,255,0.8);font-size:12px;margin-top:4px">Accuracy Rate</div>
                    </div>
                </div>

                <!-- Student list for CR's class on selected date -->
                <div style="background:white;border-radius:10px;border:2px solid #e0c8f5;overflow:hidden">
                    <div style="background:linear-gradient(135deg,#6a1b9a,#c44569);padding:12px 16px">
                        <h4 style="color:white;margin:0;font-size:0.95em">Your Class Students â€” Quiz Submissions</h4>
                    </div>
                    <div class="table-wrapper" style="margin:0">
                        <table>
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>Student Name</th>
                                    <th>Score</th>
                                    <th>Time Taken</th>
                                    <th>Submitted At</th>
                                </tr>
                            </thead>
                            <tbody id="crQsTable"></tbody>
                        </table>
                    </div>
                </div>
            </div>
            <!-- â”€â”€ VLOG CHALLENGE TAB â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
            <div id="crVlogChallenge" class="form-section">

                <!-- Hero Banner -->
                <div style="background:linear-gradient(135deg,#833ab4,#fd1d1d,#fcb045);background-size:300% 300%;animation:vlogGradient 6s ease infinite;border-radius:16px;padding:24px;margin-bottom:20px;text-align:center;position:relative;overflow:hidden">
                    <div style="position:absolute;top:-20px;right:-20px;font-size:5em;opacity:0.12;transform:rotate(15deg)">ðŸ“¸</div>
                    <div style="font-size:2.2em;margin-bottom:6px">ðŸ“¹ðŸŽ¬âœ¨</div>
                    <h2 style="color:white;margin:0 0 5px;font-size:1.5em;text-shadow:0 2px 8px rgba(0,0,0,0.35)">Vlog Social Media Challenge</h2>
                    <p style="color:rgba(255,255,255,0.92);margin:0 0 10px;font-size:0.9em">Create a 2-member team vlog, post it on <strong>Instagram</strong> & win!</p>
                    <div style="display:flex;justify-content:center;gap:8px;flex-wrap:wrap">
                        <div style="background:rgba(255,255,255,0.2);border:1px solid rgba(255,255,255,0.5);border-radius:20px;padding:4px 14px;color:white;font-size:0.78em;font-weight:700;backdrop-filter:blur(4px)">ðŸš€ Phase 1 â€” Link Submission Active</div>
                        <div style="background:rgba(255,255,255,0.2);border:1px solid rgba(255,255,255,0.5);border-radius:20px;padding:4px 14px;color:white;font-size:0.78em;font-weight:700;backdrop-filter:blur(4px)">ðŸ“¸ Instagram Only</div>
                        <div style="background:rgba(255,255,255,0.2);border:1px solid rgba(255,255,255,0.5);border-radius:20px;padding:4px 14px;color:white;font-size:0.78em;font-weight:700;backdrop-filter:blur(4px)">ðŸ‘¥ 2 Members / Team</div>
                    </div>
                </div>

                <!-- Rules + Topics in 2-col -->
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:20px" class="vlog-rules-grid">
                    <!-- Rules -->
                    <div style="background:#fff8e1;border-left:5px solid #ffc107;border-radius:10px;padding:16px 18px">
                        <h4 style="color:#856404;margin:0 0 10px;font-size:0.93em">ðŸ“‹ Rules & Guidelines</h4>
                        <ul style="margin:0;padding-left:16px;color:#555;font-size:0.85em;line-height:2.1">
                            <li>Each team must have exactly <strong>2 members</strong></li>
                            <li>Maximum <strong>2 teams</strong> per class â€” choose wisely!</li>
                            <li>Post your vlog as an <strong>Instagram Reel</strong> only</li>
                            <li>Your Instagram profile must be <strong>public</strong></li>
                            <li>Must use the official challenge hashtag in caption</li>
                            <li>Vlog must be <strong>original</strong> â€” no recycled content</li>
                            <li>Minimum duration: <strong>30 seconds</strong></li>
                            <li>Each team picks a <strong>different topic</strong> (no repeats in class)</li>
                            <li>Submit your <strong>Instagram Reel link</strong> below by deadline</li>
                        </ul>
                    </div>
                    <!-- Topics -->
                    <div style="background:#f3e5f5;border-left:5px solid #9c27b0;border-radius:10px;padding:16px 18px">
                        <h4 style="color:#6a1b9a;margin:0 0 10px;font-size:0.93em">ðŸŽ¬ Vlog Topics (Choose One)</h4>
                        <div style="display:flex;flex-direction:column;gap:8px">
                            <div style="background:white;border-radius:8px;padding:10px 14px;display:flex;align-items:center;gap:10px;border:1px solid #e1bee7">
                                <span style="font-size:1.3em">âœˆï¸</span>
                                <div><div style="font-weight:700;color:#4a148c;font-size:0.9em">âœˆï¸ Travel Vlog</div><div style="color:#777;font-size:0.78em">Explore a place â€” campus, market, landmark</div></div>
                            </div>
                            <div style="background:white;border-radius:8px;padding:10px 14px;display:flex;align-items:center;gap:10px;border:1px solid #e1bee7">
                                <span style="font-size:1.3em">ðŸ½ï¸</span>
                                <div><div style="font-weight:700;color:#4a148c;font-size:0.9em">ðŸ½ï¸ Food Vlog</div><div style="color:#777;font-size:0.78em">Explore food, restaurants, street eats</div></div>
                            </div>
                            <div style="background:white;border-radius:8px;padding:10px 14px;display:flex;align-items:center;gap:10px;border:1px solid #e1bee7">
                                <span style="font-size:1.3em">ðŸŽ‰</span>
                                <div><div style="font-weight:700;color:#4a148c;font-size:0.9em">ðŸŽ‰ Event Vlog</div><div style="color:#777;font-size:0.78em">Cover a college event, fest, or activity</div></div>
                            </div>
                            <div style="background:white;border-radius:8px;padding:10px 14px;display:flex;align-items:center;gap:10px;border:1px solid #e1bee7">
                                <span style="font-size:1.3em">ðŸŒ…</span>
                                <div><div style="font-weight:700;color:#4a148c;font-size:0.9em">ðŸŒ… Daily Life Vlog</div><div style="color:#777;font-size:0.78em">A day in your life â€” routines, moments, lifestyle</div></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Scoring System -->
                <div style="background:linear-gradient(135deg,#e8f5e9,#e3f2fd);border-radius:12px;padding:16px 18px;margin-bottom:20px;border:1px solid #b3e5fc">
                    <h4 style="color:#0d47a1;margin:0 0 12px;font-size:0.93em">ðŸ† Scoring System â€” How Winners Are Decided</h4>
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px" class="vlog-score-grid">
                        <div style="background:white;border-radius:10px;padding:14px;border-left:4px solid #e91e63">
                            <div style="font-size:1.6em;font-weight:900;color:#e91e63">50%</div>
                            <div style="font-weight:700;color:#333;font-size:0.88em;margin:3px 0">ðŸ“Š Social Media Score</div>
                            <div style="color:#666;font-size:0.78em;line-height:1.6">Auto-tracked via hashtag<br><strong>Likes + Comments + Views</strong><br>Combined engagement score</div>
                        </div>
                        <div style="background:white;border-radius:10px;padding:14px;border-left:4px solid #3f51b5">
                            <div style="font-size:1.6em;font-weight:900;color:#3f51b5">50%</div>
                            <div style="font-weight:700;color:#333;font-size:0.88em;margin:3px 0">ðŸ‘¨â€âš–ï¸ Jury Score</div>
                            <div style="color:#666;font-size:0.78em;line-height:1.6">Evaluated by 2 judges<br><strong>Content Â· Creativity Â· Presentation</strong><br>Average of both jury marks</div>
                        </div>
                    </div>
                    <div style="background:rgba(13,71,161,0.07);border-radius:8px;padding:10px 14px;margin-top:12px;font-size:0.82em;color:#1565c0">
                        ðŸ… <strong>Final Score = (Social Score Ã— 50%) + (Jury Score Ã— 50%)</strong> â€” Top team per class advances to final evaluation
                    </div>
                </div>

                <!-- Hashtag Tracking Box -->
                <div style="background:linear-gradient(135deg,#fce4ec,#f3e5f5);border-radius:12px;padding:16px 18px;margin-bottom:20px;border:1px solid #f48fb1">
                    <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:8px;margin-bottom:10px">
                        <h4 style="color:#880e4f;margin:0;font-size:0.93em">ðŸ”– Official Challenge Hashtag</h4>
                        <span style="background:#e91e63;color:white;padding:3px 12px;border-radius:20px;font-size:0.75em;font-weight:700">Phase 2 â€” Auto-Tracking Ready</span>
                    </div>
                    <div style="background:white;border-radius:10px;padding:14px 16px;border:2px dashed #f48fb1;text-align:center;margin-bottom:12px">
                        <div style="font-size:1.4em;font-weight:900;color:#e91e63;letter-spacing:1px" id="vlogHashtagDisplay">#SpurthiVlogChallenge2026</div>
                        <div style="color:#aaa;font-size:0.78em;margin-top:4px">âš™ï¸ Admin can update this hashtag before launch</div>
                    </div>
                    <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:10px;text-align:center" class="vlog-track-grid">
                        <div style="background:white;border-radius:8px;padding:10px 8px;border:1px solid #f8bbd0">
                            <div style="font-size:1.3em">ðŸ‘ï¸</div>
                            <div style="font-size:0.78em;font-weight:700;color:#880e4f;margin-top:3px">Monitors Hashtag</div>
                            <div style="font-size:0.72em;color:#999">Scans all posts using the tag</div>
                        </div>
                        <div style="background:white;border-radius:8px;padding:10px 8px;border:1px solid #f8bbd0">
                            <div style="font-size:1.3em">ðŸ”</div>
                            <div style="font-size:0.78em;font-weight:700;color:#880e4f;margin-top:3px">Detects New Posts</div>
                            <div style="font-size:0.72em;color:#999">Links matched to submitted entries</div>
                        </div>
                        <div style="background:white;border-radius:8px;padding:10px 8px;border:1px solid #f8bbd0">
                            <div style="font-size:1.3em">ðŸ“Š</div>
                            <div style="font-size:0.78em;font-weight:700;color:#880e4f;margin-top:3px">Live Leaderboard</div>
                            <div style="font-size:0.72em;color:#999">Updates scores in real-time</div>
                        </div>
                    </div>
                    <div style="background:rgba(136,14,79,0.06);border-radius:8px;padding:9px 14px;margin-top:10px;font-size:0.8em;color:#880e4f">
                        âš ï¸ <strong>Important:</strong> Participants <em>must</em> use the official hashtag in their Instagram Reel caption â€” otherwise the post won't be tracked automatically in Phase 2.
                    </div>
                </div>

                <!-- Submission Form -->
                <!-- Event Locked Message (shown when Super Admin hasn't activated) -->
                <div id="vlogLockedMsg" style="display:none;background:linear-gradient(135deg,#fff3e0,#fce4ec);border-radius:12px;padding:24px;text-align:center;border:2px dashed #ffab40;margin-bottom:20px">
                    <div style="font-size:2.5em;margin-bottom:8px">ðŸ”’</div>
                    <h3 style="color:#e65100;margin:0 0 8px">Event Not Yet Started</h3>
                    <p style="color:#666;font-size:0.9em;margin:0">The Vlog Challenge has not been activated by the Super Admin yet. Please check back soon!</p>
                </div>

                <div id="vlogSubmitFormWrapper">
                <div style="background:white;border-radius:14px;border:2px solid #e0c8f5;padding:22px;margin-bottom:20px">
                    <h3 style="color:#6a1b9a;margin:0 0 6px;font-size:1.05em">ðŸ“¤ Submit Instagram Reel Link â€” <span id="vlogCRClass" style="color:#c44569"></span></h3>
                    <p style="color:#888;font-size:0.82em;margin:0 0 16px">Max 2 teams per class Â· 2 members per team Â· Instagram Reel only</p>

                    <!-- Team slots indicator -->
                    <div id="vlogTeamSlotsInfo" style="background:#e8f5e9;border-radius:8px;padding:10px 14px;margin-bottom:16px;font-size:0.85em;color:#1b5e20;border-left:4px solid #4caf50">
                        âœ… Loading team slots for your classâ€¦
                    </div>

                    <!-- Enrolled teams pulled from enrollment (read-only display) -->
                    <div style="margin-bottom:16px">
                        <label style="font-size:0.88em;font-weight:700;color:#444;display:flex;align-items:center;justify-content:space-between;margin-bottom:8px">
                            <span>ðŸ‘¥ Select Your Enrolled Team <span style="color:red">*</span></span>
                            <button type="button" onclick="autoFillVlogMembers()" style="background:#9c27b0;color:white;border:none;border-radius:6px;padding:4px 12px;font-size:0.78em;cursor:pointer;font-weight:600">ðŸ”„ Refresh</button>
                        </label>
                        <div id="vlogEnrolledTeamsList" style="background:#f8f4ff;border-radius:10px;border:2px solid #e1bee7;padding:12px;margin-bottom:8px;font-size:0.85em;color:#555">
                            Loading enrolled teams from registrationâ€¦
                        </div>
                        <select id="vlogTeamSelect" onchange="vlogOnTeamSelect()" style="width:100%;padding:10px 12px;border:2px solid #9c27b0;border-radius:8px;font-size:0.9em;outline:none;background:white;font-weight:600;color:#3d0060">
                            <option value="">â€” Select your team from enrollment â€”</option>
                        </select>
                        <p style="font-size:0.76em;color:#999;margin:5px 0 0">â„¹ï¸ Names and topic come from enrollment. Only the Reel link, handle and caption need to be added by you.</p>
                    </div>

                    <!-- Hidden: populated by team select -->
                    <input type="hidden" id="vlogMember1">
                    <input type="hidden" id="vlogMember2">
                    <input type="hidden" id="vlogTopic">

                    <!-- Selected team confirmation -->
                    <div id="vlogSelectedTeamDisplay" style="display:none;background:#e8f5e9;border-radius:8px;padding:10px 14px;margin-bottom:14px;border-left:4px solid #4caf50;font-size:0.88em">
                        <strong style="color:#1b5e20">âœ… Selected:</strong> <span id="vlogSelectedTeamInfo"></span>
                    </div>

                    <!-- Only fields the team needs to fill -->
                    <div style="display:flex;flex-direction:column;gap:14px">
                        <div>
                            <label style="font-size:0.88em;font-weight:700;color:#444;display:block;margin-bottom:5px">Instagram Handle <span style="color:red">*</span></label>
                            <input type="text" id="vlogHandle" placeholder="@yourusername" style="width:100%;padding:10px 12px;border:2px solid #ddd;border-radius:8px;font-size:0.9em;outline:none;transition:border 0.2s" onfocus="this.style.borderColor='#6a1b9a'" onblur="this.style.borderColor='#ddd'">
                        </div>
                        <div>
                            <label style="font-size:0.88em;font-weight:700;color:#444;display:block;margin-bottom:5px">Instagram Reel Link <span style="color:red">*</span></label>
                            <input type="url" id="vlogLink" placeholder="https://www.instagram.com/reel/..." style="width:100%;padding:10px 12px;border:2px solid #ddd;border-radius:8px;font-size:0.9em;outline:none;transition:border 0.2s" onfocus="this.style.borderColor='#6a1b9a'" onblur="this.style.borderColor='#ddd'">
                            <p style="font-size:0.78em;color:#999;margin:5px 0 0">Make sure your profile is public &amp; the hashtag <strong id="vlogHashtagInForm">#SpurthiVlogChallenge2026</strong> is in the caption</p>
                        </div>
                        <div>
                            <label style="font-size:0.88em;font-weight:700;color:#444;display:block;margin-bottom:5px">Reel Title / Caption Summary <span style="color:red">*</span></label>
                            <input type="text" id="vlogTitle" placeholder="E.g. A Day Exploring Davangere ðŸ™ï¸" style="width:100%;padding:10px 12px;border:2px solid #ddd;border-radius:8px;font-size:0.9em;outline:none;transition:border 0.2s" onfocus="this.style.borderColor='#6a1b9a'" onblur="this.style.borderColor='#ddd'">
                        </div>
                    </div>
                    <!-- Submission date/time info -->
                    <div id="vlogSubmittedInfo" style="display:none;margin-top:10px;padding:8px 14px;border-radius:8px;font-size:0.82em;font-weight:600;background:#f3e5f5;color:#4a148c;border:1px solid #ce93d8">
                        ðŸ•’ Submitted on: <span id="vlogSubmittedDateTime">â€”</span>
                    </div>

                    <div id="vlogSubmitMsg" style="display:none;margin-top:12px;padding:10px 14px;border-radius:8px;font-size:0.88em;font-weight:600"></div>
                    <div style="margin-top:16px;display:flex;gap:10px;flex-wrap:wrap">
                        <button class="btn" id="vlogSubmitBtn" onclick="submitVlogEntry()" style="background:linear-gradient(135deg,#833ab4,#fd1d1d,#fcb045);border:none;flex:1;min-width:160px">ðŸ“¤ Submit Instagram Reel Link</button>
                        <button class="btn" id="vlogEditBtn" onclick="enableVlogEdit()" style="background:linear-gradient(135deg,#1565c0,#1976d2);border:none;flex:0;min-width:120px">âœï¸ Edit</button>
                        <button class="btn btn-secondary" onclick="clearVlogForm()" style="flex:0">ðŸ—‘ï¸ Clear</button>
                    </div>
                </div>
                </div><!-- end vlogSubmitFormWrapper -->

                <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
                <!-- SEPARATE: Instagram Reel Insights Screenshot Upload Section    -->
                <!-- Shown only AFTER the Reel Link has been submitted              -->
                <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
                <div id="vlogInsightScreenshotSection" style="display:block;margin-top:20px">
                    <div style="background:linear-gradient(135deg,#f3e5f5,#e8f5e9);border-radius:14px;border:2px solid #ce93d8;padding:22px">
                        <!-- Header -->
                        <div style="display:flex;align-items:center;gap:10px;margin-bottom:6px">
                            <span style="font-size:1.4em">ðŸ“Š</span>
                            <div>
                                <h3 style="color:#6a1b9a;margin:0;font-size:1.05em">Instagram Reel Insights Screenshot <span style="color:#888;font-weight:400;font-size:0.85em">(upload daily â€” one per day)</span></h3>
                            </div>
                        </div>
                        <!-- Info banner -->
                        <div style="background:rgba(106,27,154,0.08);border-radius:8px;padding:9px 14px;margin-bottom:16px;font-size:0.82em;color:#4a148c;border-left:4px solid #9c27b0;line-height:1.6">
                            â„¹ï¸ Each day during the event period, open your Reel â†’ tap <strong>â‹¯</strong> â†’ <strong>View Insights</strong> â†’ screenshot showing <strong>Views, Likes, Comments</strong> â†’ upload for that date.<br>
                            This helps the admin enter your social score accurately every day.
                        </div>
                        <!-- Screenshot slots (rendered by initVlogDailyScreenshots) -->
                        <div id="vlogDailyScreenshotsContainer" style="display:flex;flex-direction:column;gap:10px;margin-bottom:16px">
                            <!-- Daily date slots rendered by initVlogDailyScreenshots() -->
                        </div>
                        <!-- Separate submit message + button -->
                        <div id="vlogScreenshotSubmitMsg" style="display:none;margin-bottom:12px;padding:10px 14px;border-radius:8px;font-size:0.88em;font-weight:600"></div>
                        <button class="btn" id="vlogScreenshotSubmitBtn" onclick="submitVlogScreenshotsOnly()" style="background:linear-gradient(135deg,#6a1b9a,#9c27b0);border:none;width:100%;font-size:0.95em">ðŸ“¸ Submit Insight Screenshots</button>
                    </div>
                </div>
                <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->

                <!-- Submissions Table -->
                <div style="background:white;border-radius:14px;border:2px solid #e0c8f5;overflow:hidden">
                    <div style="background:linear-gradient(135deg,#833ab4,#fd1d1d);padding:14px 18px;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:8px">
                        <h4 style="color:white;margin:0;font-size:0.95em">ðŸ“‹ Your Class Teams â€” <span id="vlogCountBadge" style="background:rgba(255,255,255,0.25);padding:2px 10px;border-radius:12px;font-size:0.85em">0 / 2 slots used</span></h4>
                        <button class="btn btn-small" onclick="loadVlogSubmissions()" style="background:rgba(255,255,255,0.2);border:1px solid rgba(255,255,255,0.5);color:white;font-size:0.8em">ðŸ”„ Refresh</button>
                    </div>
                    <div id="vlogTableWrap" style="padding:16px">
                        <div id="vlogEmptyMsg" style="text-align:center;color:#aaa;padding:30px;font-size:0.9em">
                            No teams submitted yet for your class. Register your team! ðŸŽ¬
                        </div>
                        <div class="table-wrapper" style="margin:0;display:none" id="vlogTableContainer">
                            <table id="vlogTable">
                                <thead>
                                    <tr>
                                        <th>Team</th>
                                        <th>Members</th>
                                        <th>Topic</th>
                                        <th>Reel Link</th>
                                        <th>Handle</th>
                                        <th>Social Score</th>
                                        <th>Jury Score</th>
                                        <th>Status</th>
                                        <th>Submitted</th>
                                    </tr>
                                </thead>
                                <tbody id="vlogTableBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Phase 2 Coming Soon -->
                <div style="background:linear-gradient(135deg,#e3f2fd,#fce4ec);border:1px dashed #90caf9;border-radius:12px;padding:16px 18px;margin-top:18px">
                    <h4 style="color:#1565c0;margin:0 0 8px;font-size:0.92em">ðŸ”® Phase 2 â€” Coming Soon: Auto-Hashtag Tracking via Instagram Graph API</h4>
                    <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:10px" class="vlog-phase2-grid">
                        <div style="background:white;border-radius:8px;padding:8px 10px;font-size:0.78em;text-align:center;border:1px solid #bbdefb">
                            <div>ðŸ”–</div><div style="font-weight:700;color:#1565c0;margin-top:3px">Monitors Hashtag</div><div style="color:#888">Scans all posts automatically</div>
                        </div>
                        <div style="background:white;border-radius:8px;padding:8px 10px;font-size:0.78em;text-align:center;border:1px solid #bbdefb">
                            <div>âš¡</div><div style="font-weight:700;color:#1565c0;margin-top:3px">Detects New Posts</div><div style="color:#888">Matches to registered teams</div>
                        </div>
                        <div style="background:white;border-radius:8px;padding:8px 10px;font-size:0.78em;text-align:center;border:1px solid #bbdefb">
                            <div>ðŸ“Š</div><div style="font-weight:700;color:#1565c0;margin-top:3px">Live Leaderboard</div><div style="color:#888">Updates scores in real-time</div>
                        </div>
                    </div>
                    <p style="color:#555;font-size:0.8em;margin:0;line-height:1.7">Apply for Instagram Graph API now (approval takes 3â€“7 days). Once live, likes + comments + views will be tracked automatically and combined with jury scores for final rankings. Your Phase 1 link submissions are ready to go!</p>
                </div>

                <!-- â”€â”€ MONITORING SECTION (hidden until Super Admin enables) â”€â”€ -->
                <div id="vlogMonitoringSection" style="display:none;margin-top:18px">
                    <div style="background:linear-gradient(135deg,#fce4ec,#f3e5f5);border-radius:12px;padding:18px;border:2px solid #f48fb1">
                        <h4 style="color:#880e4f;margin:0 0 12px;font-size:0.95em">ðŸ“Š Your Team's Social Score Tracking</h4>
                        <div id="vlogMonitoringContent">
                            <p style="color:#888;font-size:0.85em">Loading your class tracking dataâ€¦</p>
                        </div>
                    </div>
                </div>

            </div>
            <!-- â”€â”€ END VLOG CHALLENGE TAB â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->

            <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
            <!-- CR: POD CASTING TAB                                               -->
            <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
            <div id="crPodCasting" class="form-section">

                <!-- Hero Banner -->
                <div style="background:linear-gradient(135deg,#1db954,#191414,#1db954);background-size:300% 300%;animation:vlogGradient 6s ease infinite;border-radius:16px;padding:24px;margin-bottom:20px;text-align:center;position:relative;overflow:hidden">
                    <div style="position:absolute;top:-20px;right:-20px;font-size:5em;opacity:0.12;transform:rotate(15deg)">ðŸŽ™ï¸</div>
                    <div style="font-size:2.2em;margin-bottom:6px">ðŸŽ™ï¸ðŸŽ§âœ¨</div>
                    <h2 style="color:white;margin:0 0 5px;font-size:1.5em;text-shadow:0 2px 8px rgba(0,0,0,0.35)">Pod Casting Challenge</h2>
                    <p style="color:rgba(255,255,255,0.92);margin:0 0 10px;font-size:0.9em">Record your podcast, upload to <strong>Spotify</strong> & submit the link!</p>
                    <div style="display:flex;justify-content:center;gap:8px;flex-wrap:wrap">
                        <div style="background:rgba(255,255,255,0.2);border:1px solid rgba(255,255,255,0.5);border-radius:20px;padding:4px 14px;color:white;font-size:0.78em;font-weight:700;backdrop-filter:blur(4px)">ðŸŽµ Spotify Only</div>
                        <div style="background:rgba(255,255,255,0.2);border:1px solid rgba(255,255,255,0.5);border-radius:20px;padding:4px 14px;color:white;font-size:0.78em;font-weight:700;backdrop-filter:blur(4px)">ðŸ‘¤ Individual Event</div>
                        <div style="background:rgba(255,255,255,0.2);border:1px solid rgba(255,255,255,0.5);border-radius:20px;padding:4px 14px;color:white;font-size:0.78em;font-weight:700;backdrop-filter:blur(4px)">â± Min 3 Minutes</div>
                    </div>
                </div>

                <!-- Locked message -->
                <div id="podcastLockedMsg" style="display:none;background:linear-gradient(135deg,#fff3e0,#fce4ec);border-radius:12px;padding:24px;text-align:center;border:2px dashed #ffab40;margin-bottom:20px">
                    <div style="font-size:2.5em;margin-bottom:8px">ðŸ”’</div>
                    <h3 style="color:#e65100;margin:0 0 8px">Event Not Yet Started</h3>
                    <p style="color:#666;font-size:0.9em;margin:0">The Pod Casting event has not been activated by the Super Admin yet. Please check back soon!</p>
                </div>

                <!-- Submit Form -->
                <div id="podcastSubmitFormWrapper">
                <div style="background:white;border-radius:14px;border:2px solid #c8e6c9;padding:22px;margin-bottom:20px">
                    <h3 style="color:#1b5e20;margin:0 0 6px;font-size:1.05em">ðŸŽ™ï¸ Submit Spotify Podcast Link â€” <span id="podcastCRClass" style="color:#1db954"></span></h3>
                    <p style="color:#888;font-size:0.82em;margin:0 0 16px">Max 3 participants per class Â· Individual event Â· Spotify only</p>

                    <!-- Slots info -->
                    <div id="podcastTeamSlotsInfo" style="background:#e8f5e9;border-radius:8px;padding:10px 14px;margin-bottom:16px;font-size:0.85em;color:#1b5e20;border-left:4px solid #4caf50">
                        âœ… Loading slots for your classâ€¦
                    </div>

                    <!-- Enrolled participants -->
                    <div style="margin-bottom:16px">
                        <label style="font-size:0.88em;font-weight:700;color:#444;display:flex;align-items:center;justify-content:space-between;margin-bottom:8px">
                            <span>ðŸ‘¤ Select Enrolled Participant <span style="color:red">*</span></span>
                            <button type="button" onclick="autoFillPodcastMembers()" style="background:#1db954;color:white;border:none;border-radius:6px;padding:4px 12px;font-size:0.78em;cursor:pointer;font-weight:600">ðŸ”„ Refresh</button>
                        </label>
                        <div id="podcastEnrolledList" style="background:#f1f8e9;border-radius:10px;border:2px solid #a5d6a7;padding:12px;margin-bottom:8px;font-size:0.85em;color:#555">
                            Loading enrolled participants from registrationâ€¦
                        </div>
                        <select id="podcastParticipantSelect" onchange="podcastOnParticipantSelect()" style="width:100%;padding:10px 12px;border:2px solid #1db954;border-radius:8px;font-size:0.9em;outline:none;background:white;font-weight:600;color:#1b5e20">
                            <option value="">â€” Select participant from enrollment â€”</option>
                        </select>
                    </div>

                    <!-- Hidden populated by select -->
                    <input type="hidden" id="podcastMemberName">
                    <input type="hidden" id="podcastMemberTopic">

                    <!-- Selected confirmation -->
                    <div id="podcastSelectedDisplay" style="display:none;background:#e8f5e9;border-radius:8px;padding:10px 14px;margin-bottom:14px;border-left:4px solid #4caf50;font-size:0.88em">
                        <strong style="color:#1b5e20">âœ… Selected:</strong> <span id="podcastSelectedInfo"></span>
                    </div>

                    <!-- Fields -->
                    <div style="display:flex;flex-direction:column;gap:14px">
                        <div>
                            <label style="font-size:0.88em;font-weight:700;color:#444;display:block;margin-bottom:5px">ðŸŽµ Spotify Podcast Link <span style="color:red">*</span></label>
                            <input type="url" id="podcastLink" placeholder="https://open.spotify.com/episode/..." style="width:100%;padding:10px 12px;border:2px solid #ddd;border-radius:8px;font-size:0.9em;outline:none;transition:border 0.2s" onfocus="this.style.borderColor='#1db954'" onblur="this.style.borderColor='#ddd'">
                            <p style="font-size:0.78em;color:#999;margin:5px 0 0">Make sure the episode is <strong>publicly accessible</strong> on Spotify</p>
                        </div>
                        <div>
                            <label style="font-size:0.88em;font-weight:700;color:#444;display:block;margin-bottom:5px">ðŸ“ Episode Title <span style="color:red">*</span></label>
                            <input type="text" id="podcastTitle" placeholder="E.g. The Future of AI in Education" style="width:100%;padding:10px 12px;border:2px solid #ddd;border-radius:8px;font-size:0.9em;outline:none;transition:border 0.2s" onfocus="this.style.borderColor='#1db954'" onblur="this.style.borderColor='#ddd'">
                        </div>
                        <div>
                            <label style="font-size:0.88em;font-weight:700;color:#444;display:block;margin-bottom:5px">â± Episode Duration (minutes) <span style="color:red">*</span></label>
                            <input type="number" id="podcastDuration" placeholder="e.g. 5" min="1" style="width:100%;padding:10px 12px;border:2px solid #ddd;border-radius:8px;font-size:0.9em;outline:none;transition:border 0.2s" onfocus="this.style.borderColor='#1db954'" onblur="this.style.borderColor='#ddd'">
                        </div>
                    </div>

                    <!-- Submission date/time info -->
                    <div id="podcastSubmittedInfo" style="display:none;margin-top:10px;padding:8px 14px;border-radius:8px;font-size:0.82em;font-weight:600;background:#e8f5e9;color:#1b5e20;border:1px solid #a5d6a7">
                        ðŸ•’ Submitted on: <span id="podcastSubmittedDateTime">â€”</span>
                    </div>

                    <div id="podcastSubmitMsg" style="display:none;margin-top:12px;padding:10px 14px;border-radius:8px;font-size:0.88em;font-weight:600"></div>
                    <div style="margin-top:16px;display:flex;gap:10px;flex-wrap:wrap">
                        <button class="btn" id="podcastSubmitBtn" onclick="submitPodcastEntry()" style="background:linear-gradient(135deg,#1db954,#191414);border:none;flex:1;min-width:160px">ðŸŽ™ï¸ Submit Podcast Link</button>
                        <button class="btn" id="podcastEditBtn" onclick="enablePodcastEdit()" style="background:linear-gradient(135deg,#1565c0,#1976d2);border:none;flex:0;min-width:120px">âœï¸ Edit</button>
                        <button class="btn btn-secondary" onclick="clearPodcastForm()" style="flex:0">ðŸ—‘ï¸ Clear</button>
                    </div>
                </div>
                </div><!-- end podcastSubmitFormWrapper -->

                <!-- Submissions Table -->
                <div style="background:white;border-radius:14px;border:2px solid #c8e6c9;overflow:hidden">
                    <div style="background:linear-gradient(135deg,#1db954,#191414);padding:14px 18px;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:8px">
                        <h4 style="color:white;margin:0;font-size:0.95em">ðŸŽ™ï¸ Your Class Submissions â€” <span id="podcastCountBadge" style="background:rgba(255,255,255,0.25);padding:2px 10px;border-radius:12px;font-size:0.85em">0 / 3 slots used</span></h4>
                        <button class="btn btn-small" onclick="loadPodcastSubmissions()" style="background:rgba(255,255,255,0.2);border:1px solid rgba(255,255,255,0.5);color:white;font-size:0.8em">ðŸ”„ Refresh</button>
                    </div>
                    <div id="podcastTableWrap" style="padding:16px">
                        <div id="podcastEmptyMsg" style="text-align:center;color:#aaa;padding:30px;font-size:0.9em">
                            No submissions yet for your class. Submit your Spotify link! ðŸŽ™ï¸
                        </div>
                        <div class="table-wrapper" style="margin:0;display:none" id="podcastTableContainer">
                            <table id="podcastTable">
                                <thead>
                                    <tr>
                                        <th>#</th>
                                        <th>Participant</th>
                                        <th>Topic</th>
                                        <th>Sub-topic</th>
                                        <th>Episode Title</th>
                                        <th>Spotify Link</th>
                                        <th>Duration</th>
                                        <th>Status</th>
                                        <th>Jury Score</th>
                                        <th>Submitted</th>
                                    </tr>
                                </thead>
                                <tbody id="podcastTableBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

            </div>
            <!-- â”€â”€ END POD CASTING TAB â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->

            <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
            <!-- CR: BEST OUT OF WASTE TAB                                         -->
            <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
            <div id="crBestOutWaste" class="form-section">

                <!-- Hero Banner -->
                <div style="background:linear-gradient(135deg,#e65100,#f9a825,#2e7d32);background-size:300% 300%;animation:vlogGradient 6s ease infinite;border-radius:16px;padding:24px;margin-bottom:20px;text-align:center;position:relative;overflow:hidden">
                    <div style="position:absolute;top:-20px;right:-20px;font-size:5em;opacity:0.12;transform:rotate(15deg)">â™»ï¸</div>
                    <div style="font-size:2.2em;margin-bottom:6px">â™»ï¸ðŸŽ¨âœ¨</div>
                    <h2 style="color:white;margin:0 0 5px;font-size:1.5em;text-shadow:0 2px 8px rgba(0,0,0,0.35)">Best Out of Waste â€” <span id="bowCRClass" style="color:#ffe082"></span></h2>
                    <p style="color:rgba(255,255,255,0.92);margin:0 0 10px;font-size:0.9em">Pre-register before event day Â· Upload finished photo on event day</p>
                    <div style="display:flex;justify-content:center;gap:8px;flex-wrap:wrap">
                        <div style="background:rgba(255,255,255,0.2);border:1px solid rgba(255,255,255,0.5);border-radius:20px;padding:4px 14px;color:white;font-size:0.78em;font-weight:700">â™»ï¸ Waste Materials Only</div>
                        <div style="background:rgba(255,255,255,0.2);border:1px solid rgba(255,255,255,0.5);border-radius:20px;padding:4px 14px;color:white;font-size:0.78em;font-weight:700">ðŸ‘¤ Individual or 2-Member Team</div>
                        <div style="background:rgba(255,255,255,0.2);border:1px solid rgba(255,255,255,0.5);border-radius:20px;padding:4px 14px;color:white;font-size:0.78em;font-weight:700">ðŸ“… 2 Steps Â· 2 Deadlines</div>
                    </div>
                </div>

                <!-- â”€â”€ STEP 1: PRE-REGISTER â”€â”€ -->
                <div style="background:white;border-radius:14px;border:2px solid #ffe082;padding:22px;margin-bottom:20px">

                    <!-- Step header -->
                    <div style="display:flex;align-items:center;gap:12px;margin-bottom:4px">
                        <div style="background:linear-gradient(135deg,#e65100,#f9a825);color:white;border-radius:50%;width:32px;height:32px;display:flex;align-items:center;justify-content:center;font-weight:900;font-size:1em;flex-shrink:0">1</div>
                        <h3 style="color:#e65100;margin:0;font-size:1.05em">Pre-Register Theme &amp; Materials</h3>
                    </div>
                    <p style="color:#888;font-size:0.82em;margin:0 0 16px;padding-left:44px">Declare your theme and waste materials <strong>before</strong> the event day. Shankar sir will verify â€” no duplicate themes allowed per class.</p>

                    <!-- Enrolled participants -->
                    <div style="margin-bottom:14px">
                        <label style="font-size:0.88em;font-weight:700;color:#444;display:flex;align-items:center;justify-content:space-between;margin-bottom:6px">
                            <span>ðŸ‘¤ Select Enrolled Participant / Team <span style="color:red">*</span></span>
                            <button type="button" onclick="autoFillBOWMembers()" style="background:#e65100;color:white;border:none;border-radius:6px;padding:4px 12px;font-size:0.78em;cursor:pointer;font-weight:600">ðŸ”„ Refresh</button>
                        </label>
                        <div id="bowEnrolledList" style="background:#fff8e1;border-radius:10px;border:2px solid #ffe082;padding:12px;margin-bottom:8px;font-size:0.85em;color:#555">
                            Loading enrolled participantsâ€¦
                        </div>
                        <select id="bowParticipantSelect" onchange="bowOnParticipantSelect()" style="width:100%;padding:10px 12px;border:2px solid #ffe082;border-radius:8px;font-size:0.9em;outline:none;background:white;font-weight:600;color:#e65100">
                            <option value="">â€” Select participant/team â€”</option>
                        </select>
                    </div>

                    <input type="hidden" id="bowMemberName">
                    <input type="hidden" id="bowMemberKey">

                    <div id="bowSelectedDisplay" style="display:none;background:#fff3e0;border-radius:8px;padding:10px 14px;margin-bottom:14px;border-left:4px solid #ff8f00;font-size:0.88em">
                        <strong style="color:#e65100">âœ… Selected:</strong> <span id="bowSelectedInfo"></span>
                    </div>

                    <div style="display:flex;flex-direction:column;gap:14px">
                        <div>
                            <label style="font-size:0.88em;font-weight:700;color:#444;display:block;margin-bottom:5px">ðŸŽ¨ Theme / Product Name <span style="color:red">*</span></label>
                            <input type="text" id="bowTheme" placeholder="e.g. Newspaper Pen Stand, Bottle Vase, Cardboard Shelfâ€¦" style="width:100%;padding:10px 12px;border:2px solid #ddd;border-radius:8px;font-size:0.9em;outline:none;transition:border 0.2s;box-sizing:border-box" onfocus="this.style.borderColor='#e65100'" onblur="this.style.borderColor='#ddd'">
                        </div>
                        <div>
                            <label style="font-size:0.88em;font-weight:700;color:#444;display:block;margin-bottom:5px">â™»ï¸ Waste Materials Used <span style="color:red">*</span></label>
                            <input type="text" id="bowMaterials" placeholder="e.g. Newspaper, Plastic Bottles, Cardboard, Old CDsâ€¦" style="width:100%;padding:10px 12px;border:2px solid #ddd;border-radius:8px;font-size:0.9em;outline:none;transition:border 0.2s;box-sizing:border-box" onfocus="this.style.borderColor='#e65100'" onblur="this.style.borderColor='#ddd'">
                            <p style="font-size:0.78em;color:#999;margin:5px 0 0">List all waste materials â€” duplicates with other teams in your class will be flagged.</p>
                        </div>
                        <div>
                            <label style="font-size:0.88em;font-weight:700;color:#444;display:block;margin-bottom:5px">ðŸ“ Brief Description</label>
                            <textarea id="bowDescription" placeholder="Briefly describe what you're making and how waste is used creativelyâ€¦" rows="2" style="width:100%;padding:10px 12px;border:2px solid #ddd;border-radius:8px;font-size:0.9em;outline:none;resize:vertical;transition:border 0.2s;box-sizing:border-box" onfocus="this.style.borderColor='#e65100'" onblur="this.style.borderColor='#ddd'"></textarea>
                        </div>
                    </div>

                    <div id="bowSubmitMsg" style="display:none;margin-top:12px;padding:10px 14px;border-radius:8px;font-size:0.88em;font-weight:600"></div>
                    <div style="margin-top:16px;display:flex;gap:10px;flex-wrap:wrap">
                        <button class="btn" id="bowSubmitBtn" onclick="submitBOWEntry()" style="background:linear-gradient(135deg,#e65100,#f9a825);border:none;flex:1;min-width:160px">ðŸ“‹ Submit Pre-Registration</button>
                        <button class="btn btn-secondary" onclick="clearBOWForm()" style="flex:0">ðŸ—‘ï¸ Clear</button>
                    </div>
                </div>

                <!-- â”€â”€ STEP 2: FINAL PHOTO SUBMISSION (event day) â”€â”€ -->
                <div style="background:white;border-radius:14px;border:2px solid #a5d6a7;padding:22px;margin-bottom:20px" id="bowStep2Section">

                    <!-- Step header -->
                    <div style="display:flex;align-items:center;gap:12px;margin-bottom:4px">
                        <div style="background:linear-gradient(135deg,#2e7d32,#66bb6a);color:white;border-radius:50%;width:32px;height:32px;display:flex;align-items:center;justify-content:center;font-weight:900;font-size:1em;flex-shrink:0">2</div>
                        <h3 style="color:#2e7d32;margin:0;font-size:1.05em">Final Submission â€” Upload Finished Product Photo</h3>
                    </div>
                    <p style="color:#888;font-size:0.82em;margin:0 0 16px;padding-left:44px">On event day, select your pre-registered participant and upload a clear photo of your <strong>finished craft</strong>. Shankar sir will review and forward to the jury.</p>

                    <!-- Locked notice shown until pre-reg exists -->
                    <div id="bowStep2Locked" style="background:#fff8e1;border-radius:10px;padding:16px;border:2px dashed #ffe082;text-align:center;margin-bottom:14px">
                        <div style="font-size:1.8em;margin-bottom:6px">ðŸ”’</div>
                        <div style="font-weight:700;color:#856404;font-size:0.9em">Complete Step 1 first</div>
                        <div style="color:#888;font-size:0.8em;margin-top:4px">Pre-register your theme &amp; materials above before uploading the finished photo.</div>
                    </div>

                    <!-- Actual step 2 form (shown once pre-reg exists) -->
                    <div id="bowStep2Form" style="display:none">
                        <div style="margin-bottom:14px">
                            <label style="font-size:0.88em;font-weight:700;color:#444;display:block;margin-bottom:6px">ðŸ‘¤ Select Pre-Registered Participant <span style="color:red">*</span></label>
                            <select id="bowPhotoParticipantSelect" onchange="bowPhotoParticipantChanged()" style="width:100%;padding:10px 12px;border:2px solid #a5d6a7;border-radius:8px;font-size:0.9em;outline:none;background:white;font-weight:600;color:#2e7d32">
                                <option value="">â€” Select participant â€”</option>
                            </select>
                        </div>

                        <!-- Shows pre-reg details once selected -->
                        <div id="bowStep2PreRegInfo" style="display:none;background:#f1f8e9;border-radius:8px;padding:10px 14px;margin-bottom:14px;border-left:4px solid #4caf50;font-size:0.85em">
                            <strong style="color:#2e7d32">ðŸ“‹ Pre-Registration:</strong> <span id="bowStep2ThemeDisplay"></span>
                        </div>

                        <input type="hidden" id="bowPhotoEntryKey">

                        <!-- Photo upload â€” REQUIRED -->
                        <div style="background:#f1f8e9;border-radius:10px;padding:16px;border:2px solid #a5d6a7;margin-bottom:14px">
                            <label style="font-size:0.88em;font-weight:700;color:#2e7d32;display:block;margin-bottom:8px">ðŸ“¸ Finished Product Photo <span style="color:red">*</span></label>
                            <p style="font-size:0.78em;color:#666;margin:0 0 10px">Take a clear photo of your completed craft item. This is mandatory for final submission.</p>
                            <input type="file" id="bowPhotoInput" accept="image/*" onchange="bowPreviewPhoto()" style="display:none">
                            <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
                                <button type="button" onclick="document.getElementById('bowPhotoInput').click()" style="background:#2e7d32;color:white;border:none;border-radius:8px;padding:9px 18px;font-size:0.88em;font-weight:700;cursor:pointer">ðŸ“· Choose Photo</button>
                                <span id="bowPhotoFileName" style="font-size:0.82em;color:#666">No photo chosen</span>
                            </div>
                            <div id="bowPhotoPreview" style="display:none;margin-top:12px">
                                <img id="bowPhotoImg" style="max-height:200px;max-width:100%;border-radius:10px;border:2px solid #a5d6a7;object-fit:contain" alt="Craft preview">
                                <div style="font-size:0.75em;color:#2e7d32;margin-top:4px">âœ… Photo ready to upload</div>
                            </div>
                            <div id="bowUploadProgress" style="display:none;margin-top:10px;font-size:0.82em;color:#1565c0;font-weight:600">â³ Uploading photoâ€¦</div>
                        </div>

                        <div id="bowPhotoSubmitMsg" style="display:none;margin-top:12px;padding:10px 14px;border-radius:8px;font-size:0.88em;font-weight:600"></div>
                        <button class="btn" id="bowPhotoSubmitBtn" onclick="submitBOWFinalPhoto()" style="background:linear-gradient(135deg,#2e7d32,#66bb6a);border:none;width:100%">ðŸ“¸ Submit Final Photo to Shankar</button>
                    </div>
                </div>

                <!-- â”€â”€ YOUR CLASS REGISTRATIONS TABLE â”€â”€ -->
                <div style="background:white;border-radius:14px;border:2px solid #ffe082;overflow:hidden">
                    <div style="background:linear-gradient(135deg,#e65100,#f9a825);padding:14px 18px;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:8px">
                        <h4 style="color:white;margin:0;font-size:0.95em">â™»ï¸ Your Class Registrations</h4>
                        <button class="btn btn-small" onclick="loadBOWSubmissions()" style="background:rgba(255,255,255,0.2);border:1px solid rgba(255,255,255,0.5);color:white;font-size:0.8em">ðŸ”„ Refresh</button>
                    </div>
                    <div id="bowTableWrap" style="padding:16px">
                        <div id="bowEmptyMsg" style="text-align:center;color:#aaa;padding:30px;font-size:0.9em">No registrations yet for your class.</div>
                        <div class="table-wrapper" style="margin:0;display:none" id="bowTableContainer">
                            <table id="bowTable">
                                <thead>
                                    <tr>
                                        <th>#</th>
                                        <th>Participant</th>
                                        <th>Theme / Product</th>
                                        <th>Materials</th>
                                        <th>Step 1</th>
                                        <th>Final Photo</th>
                                        <th>Attendance</th>
                                        <th>Jury Status</th>
                                    </tr>
                                </thead>
                                <tbody id="bowTableBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

            </div>
            <!-- â”€â”€ END BEST OUT OF WASTE TAB â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->

            <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
            <!-- CR: YOUTUBE ADVERTISEMENT TAB                                     -->
            <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
            <div id="crYtAd" class="form-section">

                <!-- Hero Banner -->
                <div style="background:linear-gradient(135deg,#ff0000,#cc0000,#ff6600);background-size:300% 300%;animation:vlogGradient 6s ease infinite;border-radius:16px;padding:24px;margin-bottom:20px;text-align:center;position:relative;overflow:hidden">
                    <div style="position:absolute;top:-20px;right:-20px;font-size:5em;opacity:0.12;transform:rotate(15deg)">ðŸ“º</div>
                    <div style="font-size:2.2em;margin-bottom:6px">ðŸ“ºðŸŽ¬âœ¨</div>
                    <h2 style="color:white;margin:0 0 5px;font-size:1.5em;text-shadow:0 2px 8px rgba(0,0,0,0.35)">YouTube Advertisement Challenge</h2>
                    <p style="color:rgba(255,255,255,0.92);margin:0 0 10px;font-size:0.9em">Create a class advertisement, upload to <strong>YouTube</strong> &amp; win!</p>
                    <div style="display:flex;justify-content:center;gap:8px;flex-wrap:wrap">
                        <div style="background:rgba(255,255,255,0.2);border:1px solid rgba(255,255,255,0.5);border-radius:20px;padding:4px 14px;color:white;font-size:0.78em;font-weight:700;backdrop-filter:blur(4px)">â–¶ï¸ YouTube Only</div>
                        <div style="background:rgba(255,255,255,0.2);border:1px solid rgba(255,255,255,0.5);border-radius:20px;padding:4px 14px;color:white;font-size:0.78em;font-weight:700;backdrop-filter:blur(4px)">ðŸ« Class Event â€” 1 Team Per Class</div>
                        <div style="background:rgba(255,255,255,0.2);border:1px solid rgba(255,255,255,0.5);border-radius:20px;padding:4px 14px;color:white;font-size:0.78em;font-weight:700;backdrop-filter:blur(4px)">ðŸ‘¥ 8 Members</div>
                        <div style="background:rgba(255,255,255,0.2);border:1px solid rgba(255,255,255,0.5);border-radius:20px;padding:4px 14px;color:white;font-size:0.78em;font-weight:700;backdrop-filter:blur(4px)">ðŸ† All Classes Eligible</div>
                    </div>
                </div>

                <!-- Rules + Scoring in 2-col -->
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:20px" class="vlog-rules-grid">
                    <!-- Rules -->
                    <div style="background:#fff8e1;border-left:5px solid #ffc107;border-radius:10px;padding:16px 18px">
                        <h4 style="color:#856404;margin:0 0 10px;font-size:0.93em">ðŸ“‹ Rules &amp; Guidelines</h4>
                        <ul style="margin:0;padding-left:16px;color:#555;font-size:0.85em;line-height:2.1">
                            <li>Each class forms <strong>1 team of 8 members</strong></li>
                            <li>Create an original advertisement video</li>
                            <li>Upload to <strong>YouTube</strong> with a public/unlisted link</li>
                            <li>Video must be <strong>original</strong> â€” no copied content</li>
                            <li>Any product, service, or social cause allowed</li>
                            <li>Submit your <strong>YouTube video link</strong> below by deadline</li>
                            <li>The <strong>same link</strong> will be used for scoring</li>
                        </ul>
                    </div>
                    <!-- Scoring -->
                    <div style="background:#fce4ec;border-left:5px solid #e91e63;border-radius:10px;padding:16px 18px">
                        <h4 style="color:#880e4f;margin:0 0 10px;font-size:0.93em">ðŸ† How Winners Are Decided</h4>
                        <div style="display:flex;flex-direction:column;gap:10px">
                            <div style="background:white;border-radius:8px;padding:10px 14px;border:1px solid #f8bbd0">
                                <div style="font-size:1.4em;font-weight:900;color:#e91e63">50%</div>
                                <div style="font-weight:700;color:#333;font-size:0.85em">ðŸ“Š YouTube Engagement</div>
                                <div style="color:#777;font-size:0.78em">Views + Likes + Original Comments</div>
                            </div>
                            <div style="background:white;border-radius:8px;padding:10px 14px;border:1px solid #f8bbd0">
                                <div style="font-size:1.4em;font-weight:900;color:#3f51b5">50%</div>
                                <div style="font-weight:700;color:#333;font-size:0.85em">ðŸ‘¨â€âš–ï¸ Jury Score</div>
                                <div style="color:#777;font-size:0.78em">Jury 1 + Jury 2 averaged (combined)</div>
                            </div>
                        </div>
                        <div style="background:rgba(136,14,79,0.07);border-radius:8px;padding:8px 12px;margin-top:10px;font-size:0.8em;color:#880e4f">
                            ðŸ… <strong>Final = (SocialÃ—50%) + (JuryÃ—50%)</strong>
                        </div>
                    </div>
                </div>

                <!-- Locked message -->
                <div id="ytAdLockedMsg" style="display:none;background:linear-gradient(135deg,#fff3e0,#fce4ec);border-radius:12px;padding:24px;text-align:center;border:2px dashed #ffab40;margin-bottom:20px">
                    <div style="font-size:2.5em;margin-bottom:8px">ðŸ”’</div>
                    <h3 style="color:#e65100;margin:0 0 8px">Event Not Yet Started</h3>
                    <p style="color:#666;font-size:0.9em;margin:0">The YouTube Advertisement event has not been activated by the Super Admin yet. Please check back soon!</p>
                </div>

                <!-- (All classes eligible â€” no restriction message needed) -->

                <!-- Submit Form Wrapper -->
                <div id="ytAdSubmitFormWrapper">
                <div style="background:white;border-radius:14px;border:2px solid #ffcdd2;padding:22px;margin-bottom:20px">
                    <h3 style="color:#c62828;margin:0 0 6px;font-size:1.05em">ðŸ“¤ Submit YouTube Ad Link â€” <span id="ytAdCRClass" style="color:#e91e63"></span></h3>
                    <p style="color:#888;font-size:0.82em;margin:0 0 16px">Class event Â· 1 team of 8 members Â· YouTube only</p>

                    <!-- Slot info -->
                    <div id="ytAdSlotInfo" style="background:#fce4ec;border-radius:8px;padding:10px 14px;margin-bottom:16px;font-size:0.85em;color:#c62828;border-left:4px solid #e91e63">
                        âœ… Loading submission status for your classâ€¦
                    </div>

                    <!-- Auto-filled members list -->
                    <div style="margin-bottom:16px">
                        <label style="font-size:0.88em;font-weight:700;color:#444;display:flex;align-items:center;justify-content:space-between;margin-bottom:8px">
                            <span>ðŸ‘¥ Team Members (from enrollment) <span style="color:red">*</span></span>
                            <button type="button" onclick="autoFillYtAdMembers()" style="background:#e91e63;color:white;border:none;border-radius:6px;padding:4px 12px;font-size:0.78em;cursor:pointer;font-weight:600">ðŸ”„ Load Members</button>
                        </label>
                        <div id="ytAdEnrolledList" style="background:#fff8f8;border-radius:10px;border:2px solid #ffcdd2;padding:12px;margin-bottom:8px;font-size:0.85em;color:#555">
                            Click "Load Members" to populate from enrollment data.
                        </div>
                        <!-- Hidden inputs for member names (filled by autoFillYtAdMembers) -->
                        <input type="hidden" id="ytAdMember1">
                        <input type="hidden" id="ytAdMember2">
                        <input type="hidden" id="ytAdMember3">
                        <input type="hidden" id="ytAdMember4">
                        <input type="hidden" id="ytAdMember5">
                        <input type="hidden" id="ytAdMember6">
                        <input type="hidden" id="ytAdMember7">
                        <input type="hidden" id="ytAdMember8">
                    </div>

                    <!-- Fields -->
                    <div style="display:flex;flex-direction:column;gap:14px">
                        <div>
                            <label style="font-size:0.88em;font-weight:700;color:#444;display:block;margin-bottom:5px">â–¶ï¸ YouTube Video Link <span style="color:red">*</span></label>
                            <input type="url" id="ytAdLink" placeholder="https://www.youtube.com/watch?v=..." style="width:100%;padding:10px 12px;border:2px solid #ddd;border-radius:8px;font-size:0.9em;outline:none;transition:border 0.2s" onfocus="this.style.borderColor='#e91e63'" onblur="this.style.borderColor='#ddd'">
                            <p style="font-size:0.78em;color:#999;margin:5px 0 0">Ensure the video is set to <strong>Public</strong> or <strong>Unlisted</strong> so jury can view it</p>
                        </div>
                        <div>
                            <label style="font-size:0.88em;font-weight:700;color:#444;display:block;margin-bottom:5px">ðŸ“ Advertisement Title <span style="color:red">*</span></label>
                            <input type="text" id="ytAdTitle" placeholder="E.g. Save Water â€” A Message from I BCA A" style="width:100%;padding:10px 12px;border:2px solid #ddd;border-radius:8px;font-size:0.9em;outline:none;transition:border 0.2s" onfocus="this.style.borderColor='#e91e63'" onblur="this.style.borderColor='#ddd'">
                        </div>
                        <div>
                            <label style="font-size:0.88em;font-weight:700;color:#444;display:block;margin-bottom:5px">ðŸŽ¯ Product / Topic Being Advertised <span style="color:red">*</span></label>
                            <input type="text" id="ytAdProduct" placeholder="E.g. Eco-friendly water bottle, Road Safety, etc." style="width:100%;padding:10px 12px;border:2px solid #ddd;border-radius:8px;font-size:0.9em;outline:none;transition:border 0.2s" onfocus="this.style.borderColor='#e91e63'" onblur="this.style.borderColor='#ddd'">
                        </div>
                        <div>
                            <label style="font-size:0.88em;font-weight:700;color:#444;display:block;margin-bottom:5px">ðŸ“º YouTube Channel Name</label>
                            <input type="text" id="ytAdChannel" placeholder="E.g. Davan BCA 2026" style="width:100%;padding:10px 12px;border:2px solid #ddd;border-radius:8px;font-size:0.9em;outline:none;transition:border 0.2s" onfocus="this.style.borderColor='#e91e63'" onblur="this.style.borderColor='#ddd'">
                        </div>
                    </div>

                    <!-- Submission date/time info -->
                    <div id="ytAdSubmittedInfo" style="display:none;margin-top:10px;padding:8px 14px;border-radius:8px;font-size:0.82em;font-weight:600;background:#e8f5e9;color:#1b5e20;border:1px solid #a5d6a7">
                        ðŸ•’ Submitted on: <span id="ytAdSubmittedDateTime">â€”</span>
                    </div>

                    <div id="ytAdSubmitMsg" style="display:none;margin-top:12px;padding:10px 14px;border-radius:8px;font-size:0.88em;font-weight:600"></div>
                    <div style="margin-top:16px;display:flex;gap:10px;flex-wrap:wrap">
                        <button class="btn" id="ytAdSubmitBtn" onclick="submitYtAdEntry()" style="background:linear-gradient(135deg,#cc0000,#ff6600);border:none;flex:1;min-width:160px">ðŸ“º Submit YouTube Link</button>
                        <button class="btn" id="ytAdEditBtn" onclick="enableYtAdEdit()" style="background:linear-gradient(135deg,#1565c0,#1976d2);border:none;flex:0;min-width:120px">âœï¸ Edit</button>
                        <button class="btn btn-secondary" onclick="clearYtAdForm()" style="flex:0">ðŸ—‘ï¸ Clear</button>
                    </div>
                </div>
                </div><!-- end ytAdSubmitFormWrapper -->

                <!-- Screenshot Upload Section (like Vlog) -->
                <div id="ytAdScreenshotSection" style="background:white;border-radius:14px;border:2px solid #ce93d8;padding:22px;margin-bottom:20px">
                    <div style="display:flex;align-items:center;gap:10px;margin-bottom:6px">
                        <span style="font-size:1.5em">ðŸ“Š</span>
                        <h3 style="color:#6a1b9a;margin:0;font-size:1.05em">YouTube Analytics Screenshot <span style="color:#888;font-weight:400;font-size:0.85em">(upload after submission)</span></h3>
                    </div>
                    <div style="background:#f3e5f5;border-left:4px solid #9c27b0;border-radius:8px;padding:10px 14px;margin-bottom:14px;font-size:0.83em;color:#4a148c;line-height:1.7">
                        â„¹ï¸ Go to your YouTube Studio â†’ Analytics â†’ screenshot showing <strong>Views, Likes, Comments</strong> â†’ upload here.<br>
                        <strong>Roopa M C / Smitha M</strong> will read this and enter the numbers to calculate your Social Score.
                    </div>
                    <div id="ytAdScreenshotSlots" style="display:flex;flex-direction:column;gap:10px;margin-bottom:16px"></div>
                    <div id="ytAdScreenshotMsg" style="display:none;margin-bottom:12px;padding:10px 14px;border-radius:8px;font-size:0.88em;font-weight:600"></div>
                    <button class="btn" id="ytAdScreenshotBtn" onclick="submitYtAdScreenshots()" style="background:linear-gradient(135deg,#6a1b9a,#9c27b0);border:none;width:100%;font-size:0.95em">ðŸ“¸ Submit Analytics Screenshots</button>
                </div>

                <!-- Submissions Table -->
                <div style="background:white;border-radius:14px;border:2px solid #ffcdd2;overflow:hidden">
                    <div style="background:linear-gradient(135deg,#cc0000,#ff6600);padding:14px 18px;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:8px">
                        <h4 style="color:white;margin:0;font-size:0.95em">ðŸ“º Your Class YouTube Ad Submission â€” <span id="ytAdCountBadge" style="background:rgba(255,255,255,0.25);padding:2px 10px;border-radius:12px;font-size:0.85em">0 / 1 slot used</span></h4>
                        <button class="btn btn-small" onclick="loadYtAdSubmissions()" style="background:rgba(255,255,255,0.2);border:1px solid rgba(255,255,255,0.5);color:white;font-size:0.8em">ðŸ”„ Refresh</button>
                    </div>
                    <div id="ytAdTableWrap" style="padding:16px">
                        <div id="ytAdEmptyMsg" style="text-align:center;color:#aaa;padding:30px;font-size:0.9em">
                            No submission yet for your class. Submit your YouTube link! ðŸ“º
                        </div>
                        <div class="table-wrapper" style="margin:0;display:none" id="ytAdTableContainer">
                            <table id="ytAdTable">
                                <thead>
                                    <tr>
                                        <th>#</th>
                                        <th>Class</th>
                                        <th>Ad Title</th>
                                        <th>Product/Topic</th>
                                        <th>YouTube Link</th>
                                        <th>Channel</th>
                                        <th>Social Score</th>
                                        <th>Jury Score</th>
                                        <th>Final %</th>
                                        <th>Status</th>
                                        <th>Submitted</th>
                                    </tr>
                                </thead>
                                <tbody id="ytAdTableBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

            </div>
            <!-- â”€â”€ END YOUTUBE ADVERTISEMENT TAB â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
        </div>
        <!-- END CR SECTION -->
        <!-- â”€â”€ NUKKAD NATAK CR PANEL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
        <div id="crNukkadNatak" class="form-section" style="display:none">

            <!-- â”€â”€ PRE-EVENT SUBMISSIONS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
            <div style="background:linear-gradient(135deg,#4a148c,#7b1fa2);border-radius:14px;padding:18px;margin-bottom:16px;color:white">
                <h3 style="margin:0 0 4px;font-size:1.1em">ðŸŽ“ Nukkad Natak â€” Pre-Event Submissions</h3>
                <p style="margin:0 0 10px;font-size:0.82em;opacity:0.85">Submit your Social Adviser details before the event. A Social Adviser from a recognised media house is mandatory.</p>
                <div id="crNukkadMemberList" style="display:none;margin-top:8px;border-top:1px solid rgba(255,255,255,0.3);padding-top:10px">
                    <div style="font-size:0.8em;font-weight:700;opacity:0.9;margin-bottom:6px">ðŸ‘¥ Your Enrolled Team:</div>
                    <div id="crNukkadMemberNames" style="display:flex;flex-wrap:wrap;gap:6px;font-size:0.8em"></div>
                </div>
            </div>

            <!-- Social Adviser -->
            <div style="background:white;border-radius:12px;border:2px solid #ce93d8;padding:16px;margin-bottom:20px">
                <h4 style="color:#6a1b9a;margin:0 0 10px;font-size:0.95em">ðŸŽ“ Social Adviser (from Media House)</h4>
                <div style="margin-bottom:12px">
                    <label style="font-weight:600;font-size:0.88em;color:#333;display:block;margin-bottom:4px">Adviser Name: <span style="color:red">*</span></label>
                    <input type="text" id="crAdviserName" placeholder="Enter Social Adviser full name" style="width:100%;padding:9px 12px;border:2px solid #ce93d8;border-radius:8px;font-size:0.88em">
                </div>
                <div style="margin-bottom:12px">
                    <label style="font-weight:600;font-size:0.88em;color:#333;display:block;margin-bottom:4px">Media House / Organisation: <span style="color:red">*</span></label>
                    <input type="text" id="crAdviserOrg" placeholder="e.g. Prajavani, Deccan Herald, DD Chandana" style="width:100%;padding:9px 12px;border:2px solid #ce93d8;border-radius:8px;font-size:0.88em">
                </div>
                <div style="margin-bottom:12px">
                    <label style="font-weight:600;font-size:0.88em;color:#333;display:block;margin-bottom:4px">ðŸ“ Performance Place / Location: <span style="color:red">*</span></label>
                    <input type="text" id="crNukkadPlace" placeholder="e.g. College Ground, Main Auditorium Entrance, Block-B Open Area" style="width:100%;padding:9px 12px;border:2px solid #ce93d8;border-radius:8px;font-size:0.88em">
                    <div style="font-size:0.77em;color:#888;margin-top:4px">ðŸ“Œ Enter the exact place where your class will perform Nukkad Natak. Kotrappa sir will verify for clashes.</div>
                </div>
                <div id="crPlaceStatus" style="display:none;margin-bottom:10px;font-size:0.8em;font-weight:600;padding:8px 12px;border-radius:8px"></div>
                <p style="font-size:0.8em;color:#4a148c;margin:0 0 12px;padding:8px;background:#f3e5f5;border-radius:6px">âš ï¸ A Social Adviser from a recognised media house is mandatory for Nukkad Natak.</p>
                <button onclick="saveNukkadAdviser()" style="background:#6a1b9a;color:white;border:none;border-radius:8px;padding:9px 20px;font-weight:700;cursor:pointer;font-size:0.88em">ðŸ’¾ Save Adviser Details & Place</button>
                <div id="crAdviserMsg" style="display:none;margin-top:8px;font-size:0.8em;font-weight:600;padding:6px 10px;border-radius:6px"></div>
            </div>
            <!-- â”€â”€ END PRE-EVENT SUBMISSIONS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->

            <!-- â”€â”€ POST-EVENT SUBMISSIONS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
            <div style="background:linear-gradient(135deg,#1a237e,#3949ab);border-radius:14px;padding:18px;margin-bottom:20px;color:white">
                <h3 style="margin:0 0 4px;font-size:1.1em">ðŸŽ­ Nukkad Natak â€” Post-Event Submissions</h3>
                <p style="margin:0;font-size:0.82em;opacity:0.85">Submit your YouTube video link, upload newspaper article photo, and set your feedback form link after the event.</p>
            </div>

            <div id="crNukkadStatus" style="background:#fffde7;border:2px solid #ffe082;border-radius:10px;padding:14px;margin-bottom:18px;font-size:0.85em;color:#856404">
                Loading your enrollment statusâ€¦
            </div>

            <!-- YouTube Link -->
            <div style="background:white;border-radius:12px;border:2px solid #ffcdd2;padding:16px;margin-bottom:14px">
                <h4 style="color:#c62828;margin:0 0 10px;font-size:0.95em">ðŸ“º YouTube Video Link</h4>
                <p style="font-size:0.8em;color:#666;margin:0 0 10px">Upload your complete Nukkad Natak recording to YouTube and paste the link here.</p>
                <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:flex-end">
                    <div style="flex:1;min-width:200px">
                        <input type="url" id="crNukkadYtLink" placeholder="https://youtube.com/watch?v=..." style="width:100%;padding:9px 12px;border:2px solid #ffcdd2;border-radius:8px;font-size:0.88em">
                    </div>
                    <button onclick="saveNukkadYtLink()" style="background:#c62828;color:white;border:none;border-radius:8px;padding:9px 18px;font-weight:700;cursor:pointer;font-size:0.88em">ðŸ’¾ Save Link</button>
                </div>
                <div id="crNukkadYtMsg" style="display:none;margin-top:8px;font-size:0.8em;font-weight:600;padding:6px 10px;border-radius:6px"></div>
            </div>

            <!-- Newspaper Article Photo -->
            <div style="background:white;border-radius:12px;border:2px solid #c8e6c9;padding:16px;margin-bottom:14px">
                <h4 style="color:#2e7d32;margin:0 0 10px;font-size:0.95em">ðŸ“° Newspaper Article Photo</h4>
                <p style="font-size:0.8em;color:#666;margin:0 0 10px">Upload a clear photo of the newspaper article published about your social awareness campaign.</p>
                <div id="crNukkadNewspaperCurrent" style="margin-bottom:10px"></div>
                <input type="file" id="crNukkadNewspaperFile" accept="image/*" style="font-size:0.85em;margin-bottom:8px">
                <button onclick="saveNukkadNewspaper()" style="background:#2e7d32;color:white;border:none;border-radius:8px;padding:9px 18px;font-weight:700;cursor:pointer;font-size:0.88em;display:block;margin-top:6px">ðŸ“¤ Upload Photo</button>
                <div id="crNukkadNewspaperMsg" style="display:none;margin-top:8px;font-size:0.8em;font-weight:600;padding:6px 10px;border-radius:6px"></div>
            </div>

            <!-- Google Form Feedback Link -->
            <div style="background:white;border-radius:12px;border:2px solid #b39ddb;padding:16px;margin-bottom:14px">
                <h4 style="color:#4a148c;margin:0 0 10px;font-size:0.95em">ðŸ“‹ Feedback Form Link (Google Form)</h4>
                <p style="font-size:0.8em;color:#666;margin:0 0 10px">Paste your class's Google Form feedback link here. This will be shared with the organizing team.</p>
                <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:flex-end">
                    <div style="flex:1;min-width:200px">
                        <input type="url" id="crNukkadFormLink" placeholder="https://forms.gle/..." style="width:100%;padding:9px 12px;border:2px solid #b39ddb;border-radius:8px;font-size:0.88em">
                    </div>
                    <button onclick="saveNukkadFormLink()" style="background:#4a148c;color:white;border:none;border-radius:8px;padding:9px 18px;font-weight:700;cursor:pointer;font-size:0.88em">ðŸ’¾ Save Link</button>
                </div>
                <div id="crNukkadFormMsg" style="display:none;margin-top:8px;font-size:0.8em;font-weight:600;padding:6px 10px;border-radius:6px"></div>
            </div>
        </div>
        <!-- â”€â”€ END NUKKAD NATAK CR PANEL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->

        <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
        <!-- CR GROUP DANCE PANEL                                          -->
        <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
        <div id="crGroupDance" class="form-section" style="display:none">

            <!-- Hero Banner -->
            <div style="background:linear-gradient(135deg,#ad1457,#e91e63,#f06292);background-size:300% 300%;animation:vlogGradient 6s ease infinite;border-radius:16px;padding:24px;margin-bottom:20px;text-align:center;position:relative;overflow:hidden">
                <div style="position:absolute;top:-20px;right:-20px;font-size:5em;opacity:0.12;transform:rotate(15deg)">ðŸ’ƒ</div>
                <div style="font-size:2.2em;margin-bottom:6px">ðŸ’ƒðŸ•ºâœ¨</div>
                <h2 style="color:white;margin:0 0 5px;font-size:1.5em;text-shadow:0 2px 8px rgba(0,0,0,0.35)">Group Dance â€” <span id="dancecrClassName" style="color:#fce4ec"></span></h2>
                <p style="color:rgba(255,255,255,0.92);margin:0 0 10px;font-size:0.9em">Only <strong>story-based dance performances</strong> will be allowed. Each class must submit the title and a short story summary.</p>
                <div style="display:flex;justify-content:center;gap:8px;flex-wrap:wrap">
                    <div style="background:rgba(255,255,255,0.2);border:1px solid rgba(255,255,255,0.5);border-radius:20px;padding:4px 14px;color:white;font-size:0.78em;font-weight:700">ðŸ“– Story-Based Only</div>
                    <div style="background:rgba(255,255,255,0.2);border:1px solid rgba(255,255,255,0.5);border-radius:20px;padding:4px 14px;color:white;font-size:0.78em;font-weight:700">ðŸ‘¥ 5â€“8 Members</div>
                    <div style="background:rgba(255,255,255,0.2);border:1px solid rgba(255,255,255,0.5);border-radius:20px;padding:4px 14px;color:white;font-size:0.78em;font-weight:700">ðŸŽ­ Title + Summary Required</div>
                </div>
            </div>

            <!-- Enrolled participants display -->
            <div style="background:white;border-radius:12px;border:2px solid #f48fb1;padding:16px;margin-bottom:18px">
                <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:10px;flex-wrap:wrap;gap:8px">
                    <h4 style="color:#880e4f;margin:0;font-size:0.95em">ðŸ‘¥ Your Enrolled Dance Team</h4>
                    <button type="button" onclick="loadCRDancePanel()" style="background:#e91e63;color:white;border:none;border-radius:6px;padding:4px 12px;font-size:0.78em;cursor:pointer;font-weight:600">ðŸ”„ Refresh</button>
                </div>
                <div id="danceEnrolledList" style="background:#fce4ec;border-radius:10px;border:2px solid #f48fb1;padding:12px;font-size:0.85em;color:#555">
                    Loading enrolled participantsâ€¦
                </div>
            </div>

            <!-- Story Submission Form -->
            <div style="background:white;border-radius:14px;border:2px solid #f48fb1;padding:22px;margin-bottom:20px">
                <div style="display:flex;align-items:center;gap:12px;margin-bottom:4px">
                    <div style="background:linear-gradient(135deg,#ad1457,#e91e63);color:white;border-radius:50%;width:32px;height:32px;display:flex;align-items:center;justify-content:center;font-weight:900;font-size:1em;flex-shrink:0">ðŸ“–</div>
                    <h3 style="color:#880e4f;margin:0;font-size:1.05em">Dance Story Submission</h3>
                </div>
                <p style="color:#888;font-size:0.82em;margin:0 0 18px;padding-left:44px">Only story-based dance performances will be allowed. Submit the title and a short summary (3â€“4 lines) explaining the story behind your dance.</p>

                <!-- Rule reminder box -->
                <div style="background:#fce4ec;border-left:4px solid #e91e63;border-radius:8px;padding:12px 16px;margin-bottom:18px;font-size:0.85em;color:#880e4f">
                    ðŸ“Œ <strong>Rule:</strong> Only story-based dance performances will be allowed. Each class must submit the title and a short summary (3â€“4 lines) explaining the story behind their dance.
                </div>

                <div style="display:flex;flex-direction:column;gap:16px">
                    <!-- Dance Title -->
                    <div>
                        <label style="font-size:0.88em;font-weight:700;color:#444;display:block;margin-bottom:5px">ðŸŽ­ Dance Performance Title <span style="color:red">*</span></label>
                        <input type="text" id="danceTitle" placeholder="e.g. The Journey of a River, Rise of the Phoenix, Mother's Loveâ€¦"
                            style="width:100%;padding:10px 12px;border:2px solid #ddd;border-radius:8px;font-size:0.9em;outline:none;transition:border 0.2s;box-sizing:border-box"
                            onfocus="this.style.borderColor='#e91e63'" onblur="this.style.borderColor='#ddd'">
                    </div>
                    <!-- Story Summary -->
                    <div>
                        <label style="font-size:0.88em;font-weight:700;color:#444;display:block;margin-bottom:5px">ðŸ“ Story Summary <span style="color:red">*</span> <span style="color:#999;font-weight:400">(3â€“4 lines)</span></label>
                        <textarea id="danceSummary" rows="4"
                            placeholder="Briefly explain the story behind your dance performance â€” what happens, the emotions, and the message you want to convey to the audienceâ€¦"
                            style="width:100%;padding:10px 12px;border:2px solid #ddd;border-radius:8px;font-size:0.9em;outline:none;resize:vertical;transition:border 0.2s;box-sizing:border-box"
                            onfocus="this.style.borderColor='#e91e63'" onblur="this.style.borderColor='#ddd'"></textarea>
                        <p style="font-size:0.78em;color:#999;margin:4px 0 0">Write 3â€“4 lines describing the story. This will be visible to the jury and event in-charge.</p>
                    </div>
                </div>

                <div id="danceSubmitMsg" style="display:none;margin-top:12px;padding:10px 14px;border-radius:8px;font-size:0.88em;font-weight:600"></div>
                <div style="margin-top:16px;display:flex;gap:10px;flex-wrap:wrap">
                    <button class="btn" id="danceSubmitBtn" onclick="saveDanceStory()"
                        style="background:linear-gradient(135deg,#ad1457,#e91e63);border:none;flex:1;min-width:160px">ðŸ’¾ Save Dance Story</button>
                    <button class="btn btn-secondary" onclick="clearDanceForm()" style="flex:0">ðŸ—‘ï¸ Clear</button>
                </div>

                <!-- Saved confirmation display -->
                <div id="danceSavedDisplay" style="display:none;margin-top:16px;background:#fce4ec;border-radius:10px;padding:14px;border:2px solid #f48fb1">
                    <div style="font-weight:700;color:#880e4f;margin-bottom:6px">âœ… Story Saved â€” Visible to Jury & In-charge</div>
                    <div style="font-size:0.88em;color:#333"><strong>Title:</strong> <span id="danceSavedTitle"></span></div>
                    <div style="font-size:0.85em;color:#555;margin-top:6px;line-height:1.6"><strong>Summary:</strong> <span id="danceSavedSummary"></span></div>
                    <div style="font-size:0.75em;color:#aaa;margin-top:6px" id="danceSavedAt"></div>
                    <button onclick="enableDanceEdit()" style="margin-top:10px;background:#e91e63;color:white;border:none;border-radius:7px;padding:5px 14px;font-size:0.82em;font-weight:700;cursor:pointer">âœï¸ Edit Story</button>
                </div>
            </div>
        </div>
        <!-- â”€â”€ END GROUP DANCE CR PANEL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
        <div class="admin-only" id="adminSection">
            <button class="btn btn-secondary" onclick="logout()" style="float:right">Logout</button>
            <!-- Admin Dashboard -->
            <div class="admin-dashboard">
                <h2 class="dashboard-title">ðŸ“Š Admin Dashboard</h2>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number" id="totalStudents">0</div>
                        <div class="stat-label">Total Students</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="totalEvents">0</div>
                        <div class="stat-label">Active Events</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="totalClasses">0</div>
                        <div class="stat-label">Classes</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="totalEnrollments">0</div>
                        <div class="stat-label">Total Enrollments</div>
                    </div>
                </div>
            </div>

            <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
            <!-- ENROLLMENT SUMMARY SEGMENT â€” Click Copy & Send via WhatsApp -->
            <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
            <div id="enrollSummarySegment" style="background:white;border-radius:14px;border:2px solid #e3f2fd;padding:18px 20px;margin-bottom:18px;box-shadow:0 2px 10px rgba(0,0,0,0.07)">
                <div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:10px;margin-bottom:12px">
                    <h3 style="color:#1565c0;margin:0;font-size:1em">ðŸ“‹ Enrollment Summary â€” Quick Copy</h3>
                    <div style="display:flex;gap:8px;flex-wrap:wrap">
                        <button onclick="generateEnrollSummary()" style="background:linear-gradient(135deg,#1565c0,#42a5f5);color:white;border:none;border-radius:8px;padding:7px 16px;font-size:0.82em;font-weight:700;cursor:pointer">ðŸ”„ Generate Summary</button>
                        <button onclick="copyEnrollSummary()" style="background:linear-gradient(135deg,#2e7d32,#43a047);color:white;border:none;border-radius:8px;padding:7px 16px;font-size:0.82em;font-weight:700;cursor:pointer">ðŸ“‹ Copy</button>
                    </div>
                </div>
                <textarea id="enrollSummaryText" readonly style="width:100%;min-height:120px;border:2px solid #e3f2fd;border-radius:8px;padding:10px 12px;font-family:monospace;font-size:0.82em;color:#333;background:#f8fbff;resize:vertical;outline:none" placeholder="Click 'Generate Summary' to build the shareable summary textâ€¦"></textarea>
                <div id="enrollSummaryCopied" style="display:none;margin-top:6px;color:#2e7d32;font-size:0.8em;font-weight:700">âœ… Copied to clipboard! Ready to paste and send.</div>
            </div>
            <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->

            <div class="tabs">
                <button class="tab active" onclick="showTab('master')">Master List</button>
                <button class="tab" onclick="showTab('events')">By Events</button>
                <button class="tab super-admin-only" onclick="showTab('jurySetup')">Jury Setup</button>
                <button class="tab super-admin-only" onclick="showTab('juryLiveMonitor');startLiveJuryMonitor()">ðŸ“¡ Jury Live Monitor</button>
                <button class="tab" onclick="showTab('results')" id="resultsTab">Results</button>
                <button class="tab super-admin-only" onclick="showTab('quizManagement')" id="quizManagementTab">ðŸ“ Quiz Management</button>
                <button class="tab super-admin-only" onclick="showTab('leaderboardAdmin')" id="leaderboardAdminTab">ðŸ† Leaderboard</button>
                <button class="tab super-admin-only" onclick="showTab('scavengerAdmin')" id="scavengerAdminTab">ðŸ—ºï¸ Scavenger Hunt</button>
                <button class="tab super-admin-only" onclick="openSpeedSlideAdmin()" id="speedSlideAdminTab">ðŸ§© Speed Slide Admin</button>
                <button class="tab super-admin-only" onclick="showTab('dbInspector')" id="dbInspectorTab">ðŸ” DB Inspector</button>
                <button class="tab super-admin-only" onclick="showTab('cloudinaryInspector')" id="cloudinaryInspectorTab">â˜ï¸ Cloudinary</button>
                <button class="tab super-admin-only" onclick="showTab('firebaseDownloadMonitor')" id="firebaseDownloadMonitorTab">ðŸ”¥ Download Monitor</button>
                <button class="tab super-admin-only" onclick="showTab('managerPermissionsPanel')" id="managerPermissionsPanelTab">ðŸ‘” Manager Permissions</button>
                <button class="tab super-admin-only" onclick="showTab('vlogAdminPanel');loadVlogAdminPanel()" id="vlogAdminPanelTab">ðŸ“¹ Vlog Admin</button>
                <button class="tab super-admin-only" onclick="showTab('podcastAdminPanel');loadPodcastAdminPanel()" id="podcastAdminPanelTab">ðŸŽ™ï¸ Podcast Admin</button>
                <button class="tab super-admin-only" onclick="showTab('bowResultsPublisher');bowRpLoad()" id="superJuryMgmtTab">â™»ï¸ BOW Results</button>
                <button class="tab super-admin-only" onclick="showTab('nukkadAdminPanel');loadNukkadAdminPanel()" id="nukkadAdminTab">ðŸŽ­ Nukkad Admin</button>
                <button class="tab super-admin-only" onclick="showTab('hwAdminPanel');loadHwAdminPanel()" id="hwAdminPanelTab">âœï¸ HW Admin</button>
                <button class="tab super-admin-only" onclick="showTab('thAdminPanel');loadThAdminPanel()" id="thAdminPanelTab">ðŸŽ­ TH Admin</button>
                <button class="tab super-admin-only" onclick="showTab('ytAdAdminPanel');loadYtAdAdminPanel()" id="ytAdAdminPanelTab">ðŸ“º YT Ad Admin</button>
                <button class="tab" onclick="showTab('facultyAdminPanel');loadFacultyAdminPanel()" id="facultyAdminPanelTab">ðŸ‘©â€ðŸ« Faculty</button>
                <button class="tab super-admin-only" onclick="showTab('pdfHandoutsAdmin')" id="pdfHandoutsAdminTab">ðŸ“„ PDF Handouts</button>
                <button class="tab super-admin-only" onclick="showTab('paymentApprovalAdmin');paLoadPending()" id="paymentApprovalAdminTab">ðŸ’³ Payment Approval</button>
                <button class="tab super-admin-only" onclick="showTab('eventScheduleAdmin');esLoadEvents()" id="eventScheduleAdminTab">ðŸ“… Event Schedule</button>
                <button class="tab super-admin-only" onclick="showTab('allEventsOverview');loadAllEventsOverview()" id="allEventsOverviewTab">ðŸ“Š All Events Overview</button>
                <button class="tab super-admin-only" onclick="showTab('siteSettingsPanel');loadSiteSettings()" id="siteSettingsPanelTab">âš™ï¸ Site Settings</button>
                <button class="tab super-admin-only" onclick="showTab('feedbackAdminPanel');loadFeedbackAdmin()" id="feedbackAdminPanelTab">ðŸ“‹ Feedback Admin</button>
                <button class="tab super-admin-only" onclick="showTab('liveUsersPanel');initLiveUsersPanel()" id="liveUsersPanelTab">ðŸŸ¢ Live Now</button>
                <button class="tab super-admin-only" onclick="showTab('pushNotifPanel');initPushNotifPanel()" id="pushNotifPanelTab">ðŸ“£ Notifications</button>
            </div><!-- end .tabs -->

            <div class="content" id="adminContentBox">
                <!-- Master List Tab -->
                <div id="master" class="form-section active">
                    <h2 style="color:#c44569;margin-bottom:20px">Master Enrollment List</h2>
                    <div class="filter-section">
                        <select id="filterClass" onchange="updateMaster()">
                            <option value="">All Classes</option>
                        </select>
                        <select id="filterEvent" onchange="updateMaster()">
                            <option value="">All Events</option>
                        </select>
                        <button class="btn btn-small" onclick="clearFilters()">Clear Filters</button>
                        <button class="btn btn-small btn-success" onclick="downloadMaster()">ðŸ“¥ Download CSV</button>
                    </div>
                    <div id="summaryInfo" style="background:#e3f2fd;padding:15px;border-radius:8px;margin-bottom:12px"></div>

                    <!-- Filter-aware Summary Report with Copy -->
                    <div id="masterFilterSummaryBox" style="display:none;background:#fffde7;border-radius:10px;border:2px solid #ffc107;padding:14px 18px;margin-bottom:16px">
                        <div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:8px;margin-bottom:8px">
                            <h4 style="color:#856404;margin:0;font-size:0.92em">ðŸ“‹ Filter Summary â€” <span id="masterFilterSummaryLabel" style="color:#c44569"></span></h4>
                            <div style="display:flex;gap:8px;flex-wrap:wrap">
                                <button onclick="generateMasterFilterSummary()" style="background:#ffc107;color:#1a0030;border:none;border-radius:7px;padding:5px 14px;font-size:0.8em;font-weight:700;cursor:pointer">ðŸ”„ Refresh</button>
                                <button onclick="copyMasterFilterSummary()" style="background:#2e7d32;color:white;border:none;border-radius:7px;padding:5px 14px;font-size:0.8em;font-weight:700;cursor:pointer">ðŸ“‹ Copy</button>
                            </div>
                        </div>
                        <textarea id="masterFilterSummaryText" readonly style="width:100%;min-height:90px;border:1px solid #ffe082;border-radius:7px;padding:8px 10px;font-family:monospace;font-size:0.8em;color:#333;background:#fffef5;resize:vertical;outline:none"></textarea>
                        <div id="masterFilterSummaryCopied" style="display:none;margin-top:5px;color:#2e7d32;font-size:0.78em;font-weight:700">âœ… Copied!</div>
                    </div>

                    <div id="masterContainer"></div>
                </div>

                <!-- Events Tab -->
                <div id="events" class="form-section">
                    <h2 style="color:#c44569;margin-bottom:20px">Enrollments by Events</h2>
                    <button class="btn btn-small btn-success" onclick="downloadEvents()" style="margin-bottom:20px">ðŸ“¥ Download CSV</button>
                    <div id="eventsContainer"></div>
                </div>

                <!-- Jury Setup Tab (Super Admin Only) -->
                <div id="jurySetup" class="form-section super-admin-only">
                    <h2 style="color:#c44569;margin-bottom:20px">Jury Setup & Criteria Management</h2>
                    
                    <div class="form-group">
                        <label>Select Event:</label>
                        <select id="setupEventSelect" onchange="loadEventSetup()">
                            <option value="">-- Select Event --</option>
                        </select>
                    </div>

                    <!-- Eligibility Info Banner (auto-filled on event select) -->
                    <div id="eventEligibilityBanner" style="display:none;margin-bottom:15px;padding:12px 16px;border-radius:8px;border-left:5px solid #6a1b9a;background:#f3e5f5">
                        <strong style="color:#6a1b9a">ðŸŽ¯ Enrollment Criteria for this event:</strong>
                        <span id="eventEligibilityText" style="color:#333;margin-left:8px"></span>
                    </div>
                    
                    <div id="eventSetupContainer" style="display:none">

                        <!-- Event Type -->
                        <div style="background:#e8f5e9;border-radius:10px;padding:15px;margin-bottom:20px;border:2px solid #a5d6a7">
                            <h3 style="color:#1b5e20;margin-bottom:10px">âš™ï¸ Event Type</h3>
                            <p style="color:#555;font-size:13px;margin-bottom:12px">Choose how jury scores are aggregated for the leaderboard.</p>
                            <div style="display:flex;gap:20px;flex-wrap:wrap">
                                <label style="display:flex;align-items:center;gap:8px;cursor:pointer;font-weight:600;color:#1b5e20">
                                    <input type="radio" name="juryEventType" id="eventTypeClass" value="class" checked style="width:18px;height:18px">
                                    ðŸ« Class-based â€” One team per class, jury scores the class
                                </label>
                                <label style="display:flex;align-items:center;gap:8px;cursor:pointer;font-weight:600;color:#6a1b9a">
                                    <input type="radio" name="juryEventType" id="eventTypeIndividual" value="individual" style="width:18px;height:18px">
                                    ðŸ§‘ Individual â€” Multiple students per class; jury scores each student; class gets points from their best performer
                                </label>
                                <label style="display:flex;align-items:center;gap:8px;cursor:pointer;font-weight:600;color:#e65100">
                                    <input type="radio" name="juryEventType" id="eventTypeMultiteam" value="multiteam" style="width:18px;height:18px">
                                    ðŸ‘¥ Multi-Team â€” Multiple teams per class (e.g. Vlog: 3 teams Ã— 3 members); jury scores each team; class gets points from their best team
                                </label>
                            </div>
                        </div>
                        <div class="jury-password-section">
                            <h3 style="color:#6a1b9a;margin-bottom:15px">ðŸ‘¥ Jury Details</h3>
                            
                            <div style="background:#f0f0f0;padding:15px;border-radius:8px;margin-bottom:15px">
                                <h4 style="color:#6a1b9a;margin-bottom:10px">Jury 1</h4>
                                <div class="form-group">
                                    <label>Jury 1 Name:</label>
                                    <input type="text" id="jury1Name" placeholder="e.g., Dr. Smith, Prof. John">
                                </div>
                                <div class="form-group">
                                    <label>Jury 1 Password:</label>
                                    <input type="text" id="jury1Password" placeholder="Set password for Jury 1">
                                </div>
                            </div>
                            
                            <div style="background:#f0f0f0;padding:15px;border-radius:8px;margin-bottom:15px">
                                <h4 style="color:#6a1b9a;margin-bottom:10px">Jury 2</h4>
                                <div class="form-group">
                                    <label>Jury 2 Name:</label>
                                    <input type="text" id="jury2Name" placeholder="e.g., Dr. Jane, Prof. Mary">
                                </div>
                                <div class="form-group">
                                    <label>Jury 2 Password:</label>
                                    <input type="text" id="jury2Password" placeholder="Set password for Jury 2">
                                </div>
                            </div>
                        </div>
                        
                        <h3 style="color:#6a1b9a;margin:20px 0 5px">ðŸŽ­ Class Code Names (shown to jury instead of real names)</h3>
                        <p id="classAliasEventLabel" style="font-size:13px;color:#888;margin-bottom:12px">Select an event above to load participants.</p>
                        <div id="classAliasContainer" style="background:#f9f0ff;border-radius:10px;padding:15px;margin-bottom:15px">
                            <p style="color:#999;font-size:13px">Save jury passwords and select event to load enrolled classes here.</p>
                        </div>
                        <button class="btn btn-small btn-info" onclick="loadClassAliasFields()" style="margin-bottom:15px">ðŸ”„ Load Enrolled Classes</button>

                        <h3 style="color:#6a1b9a;margin:20px 0 15px">ðŸ“‹ Evaluation Criteria (5 criteria, 10 marks each)</h3>
                        <div id="criteriaContainer"></div>
                        <button class="btn btn-small btn-info" onclick="addCriterion()" style="margin-top:10px">+ Add Criterion</button>
                        
                        <div style="margin-top:30px">
                            <button class="btn btn-success" onclick="saveEventSetup()">Save Setup</button>
                        </div>
                        
                        <div id="setupMessage" class="message" style="margin-top:20px"></div>
                    </div>
                </div>

                <!-- â”€â”€ VLOG SCORE CALCULATION (only visible when Vlog is selected) â”€â”€ -->
                <div id="vlogScoreCalcPanel" style="display:none;margin-top:24px;background:linear-gradient(135deg,#fce4ec,#e8eaf6);border-radius:14px;padding:20px;border:2px solid #f48fb1">
                    <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:8px;margin-bottom:14px">
                        <h3 style="color:#880e4f;margin:0;font-size:1em">ðŸ“¹ Vlog Challenge â€” Score Calculation &amp; Live Results</h3>
                        <button class="btn btn-small" onclick="loadVlogScoreCalcPanel([])" style="background:#880e4f;color:white;border:none;font-size:0.8em">ðŸ”„ Refresh</button>
                    </div>
                    <div id="vlogCalcSubmissions">
                        <p style="color:#aaa;font-size:0.85em;text-align:center;padding:20px">Select Vlog event above to load score calculations.</p>
                    </div>
                </div>
                <div id="juryLiveMonitor" class="form-section super-admin-only">
                    <h2 style="color:#c44569;margin-bottom:20px">ðŸ“¡ Live Jury Marks Monitor</h2>
                    <div class="form-group">
                        <label>Select Event:</label>
                        <div style="display:flex;gap:10px;align-items:center">
                            <select id="liveMonitorEvent" onchange="startLiveJuryMonitor()" style="flex:1">
                                <option value="">-- Select Event --</option>
                            </select>
                            <button class="btn btn-small btn-info" onclick="startLiveJuryMonitor()">ðŸ”„ Refresh</button>
                        </div>
                    </div>
                    <div id="liveJuryMonitorContainer" style="margin-top:20px">
                        <p style="color:#999;text-align:center;padding:30px">Select an event to see live jury marks.</p>
                    </div>
                </div>

                <!-- Results Tab -->
                <div id="results" class="form-section">
                    <h2 style="color:#c44569;margin-bottom:20px">Event Results</h2>
                    
                    <div class="form-group">
                        <label>Select Event:</label>
                        <div style="display:flex;gap:10px;">
                            <select id="resultsEventSelect" onchange="loadEventResults()" style="flex:1">
                                <option value="">-- Select Event --</option>
                            </select>
                            <button class="btn btn-small" onclick="loadEventResults()" style="white-space:nowrap">ðŸ”„ Refresh</button>
                        </div>
                    </div>
                    
                    <!-- Super Admin Only: Publish/Unpublish Results -->
                    <div class="super-admin-only" style="margin:20px 0;padding:15px;background:#fff3cd;border-radius:8px;border:2px solid #ffc107">
                        <h3 style="color:#6a1b9a;margin-bottom:10px">ðŸ“¢ Results Management</h3>
                        <p style="color:#666;margin-bottom:15px;font-size:14px">Publish or unpublish results for the selected event.</p>
                        <div style="display:flex;gap:10px;flex-wrap:wrap">
                            <button class="btn btn-danger" onclick="publishResults()">âœ… Publish Results to Admins</button>
                            <button class="btn btn-secondary" onclick="unpublishResults()">âŒ Unpublish Results</button>
                        </div>
                    </div>
                    
                    <div id="resultsContainer"></div>
                </div>
                
                <!-- Quiz Management Tab -->
                <div id="quizManagement" class="form-section">
                    <h2 style="color:#c44569;margin-bottom:25px">ðŸ“ Daily Quiz Competition Management</h2>
                    
                    <div class="stats-grid" style="margin-bottom:30px">
                        <div class="stat-card">
                            <div class="stat-number" id="quizTotalStudents">0</div>
                            <div class="stat-label">Total Quiz Students</div>
                        </div>
                        <div class="stat-card" style="background:linear-gradient(135deg,#28a745 0%,#20c997 100%)">
                            <div class="stat-number" id="quizTodayParticipants">0</div>
                            <div class="stat-label">Today's Participants</div>
                        </div>
                        <div class="stat-card" style="background:linear-gradient(135deg,#ffc107 0%,#ff9800 100%)">
                            <div class="stat-number" id="quizQuestionsCount">0</div>
                            <div class="stat-label">Questions Today</div>
                        </div>
                    </div>
                    
                    <div id="quizAdminMessage" class="message"></div>
                    
                    <div class="tabs" style="margin-bottom:25px">
                        <button class="tab active" onclick="showQuizManagementTab('questions', event)">ðŸ“ Questions</button>
                        <button class="tab" onclick="showQuizManagementTab('allquizzes', event)">ðŸ“š All Quizzes</button>
                        <button class="tab" onclick="showQuizManagementTab('students', event)">ðŸ‘¥ Students</button>
                        <button class="tab" onclick="showQuizManagementTab('submissions', event)">ðŸ“Š Submissions</button>
                        <button class="tab" onclick="showQuizManagementTab('winners', event)">ðŸ† Winners</button>
                        <button class="tab super-admin-only" onclick="showQuizManagementTab('editdates', event)" id="editDatesTab">ðŸ“… Edit Quiz Dates</button>
                    </div>
                    
                    <!-- Questions Sub-Tab -->
                    <div id="quizQuestionsContent" class="form-section active">
                        <!-- Date Selector moved here for easier access -->
                        <div style="background:#fff3cd;padding:18px 20px;border-radius:10px;margin-bottom:22px;border-left:5px solid #ffc107;display:flex;align-items:center;gap:16px;flex-wrap:wrap">
                            <label for="quizDateSelector" style="font-size:1em;color:#856404;font-weight:700;margin:0;white-space:nowrap">ðŸ“… Select Date for Quiz:</label>
                            <input type="date" id="quizDateSelector" style="border:2px solid #ffc107;border-radius:8px;padding:8px 12px;font-size:1em;color:#333;background:white;flex-shrink:0" required onchange="loadQuizForSelectedDate()">
                            <p style="color:#856404;font-size:13px;margin:0;flex:1;min-width:200px"><strong>Note:</strong> Select a date to create/edit quiz questions. Students will see this quiz automatically on the selected date.</p>
                        </div>
                        <h3 style="color:#6a1b9a;margin-bottom:20px" id="quizQuestionsHeading">Create Quiz (2 Questions)</h3>
                        
                        
                        <div style="background:#f8f9fa;padding:20px;border-radius:10px;margin-bottom:30px">
                            <h4 style="color:#667eea;margin-bottom:15px">Question 1</h4>
                            
                            <div class="form-group">
                                <label>Question Type:</label>
                                <select id="quiz_q1Type" onchange="toggleQuestionType('q1')">
                                    <option value="mcq">Multiple Choice (MCQ)</option>
                                    <option value="text">Text Input (Student types answer)</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label>Question Text:</label>
                                <textarea id="quiz_q1Text" rows="3" placeholder="Enter question 1"></textarea>
                            </div>
                            
                            <!-- Image Upload -->
                            <div class="form-group">
                                <label>ðŸ“· Add Image (Optional):</label>
                                <input type="file" id="quiz_q1Image" accept="image/*" onchange="previewQuestionImage(this, 'quiz_q1ImagePreview')">
                                <div id="quiz_q1ImagePreview" style="margin-top:10px"></div>
                                <small style="color:#666">Upload an image to show with the question</small>
                            </div>
                            
                            <!-- Audio Upload -->
                            <div class="form-group">
                                <label>ðŸŽµ Add Audio (Optional):</label>
                                <input type="file" id="quiz_q1Audio" accept="audio/*" onchange="previewQuestionAudio(this, 'quiz_q1AudioPreview')">
                                <div id="quiz_q1AudioPreview" style="margin-top:10px"></div>
                                <small style="color:#666">Upload audio/music to play with the question</small>
                            </div>
                            
                            <!-- MCQ Options -->
                            <div id="quiz_q1McqSection">
                            <div class="form-group">
                                <label>Option A:</label>
                                <input type="text" id="quiz_q1OptA" placeholder="Option A">
                            </div>
                            <div class="form-group">
                                <label>Option B:</label>
                                <input type="text" id="quiz_q1OptB" placeholder="Option B">
                            </div>
                            <div class="form-group">
                                <label>Option C:</label>
                                <input type="text" id="quiz_q1OptC" placeholder="Option C">
                            </div>
                            <div class="form-group">
                                <label>Option D:</label>
                                <input type="text" id="quiz_q1OptD" placeholder="Option D">
                            </div>
                            <div class="form-group">
                                <label>Correct Answer:</label>
                                <select id="quiz_q1Correct">
                                    <option value="">-- Select --</option>
                                    <option value="A">A</option>
                                    <option value="B">B</option>
                                    <option value="C">C</option>
                                    <option value="D">D</option>
                                </select>
                            </div>
                            </div>
                            
                            <!-- Text Input Answer Section -->
                            <div id="quiz_q1TextSection" style="display:none">
                                <div class="form-group">
                                    <label>âœ… Correct Answer (one word / short phrase):</label>
                                    <input type="text" id="quiz_q1TextAnswer" placeholder="e.g. Newton, India, 1947">
                                    <small style="color:#666">Students must type this exactly (case-insensitive). Keep it one word or very short.</small>
                                </div>
                                <div class="form-group">
                                    <label>ðŸ“– Explanation for the Answer:</label>
                                    <textarea id="quiz_q1TextExplanation" rows="3" placeholder="Write a brief explanation shown to students after submission"></textarea>
                                </div>
                            </div>
                        </div>
                        
                        <div style="background:#f8f9fa;padding:20px;border-radius:10px;margin-bottom:30px">
                            <h4 style="color:#667eea;margin-bottom:15px">Question 2</h4>
                            
                            <div class="form-group">
                                <label>Question Type:</label>
                                <select id="quiz_q2Type" onchange="toggleQuestionType('q2')">
                                    <option value="mcq">Multiple Choice (MCQ)</option>
                                    <option value="text">Text Input (Student types answer)</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label>Question Text:</label>
                                <textarea id="quiz_q2Text" rows="3" placeholder="Enter question 2"></textarea>
                            </div>
                            
                            <!-- Image Upload -->
                            <div class="form-group">
                                <label>ðŸ“· Add Image (Optional):</label>
                                <input type="file" id="quiz_q2Image" accept="image/*" onchange="previewQuestionImage(this, 'quiz_q2ImagePreview')">
                                <div id="quiz_q2ImagePreview" style="margin-top:10px"></div>
                                <small style="color:#666">Upload an image to show with the question</small>
                            </div>
                            
                            <!-- Audio Upload -->
                            <div class="form-group">
                                <label>ðŸŽµ Add Audio (Optional):</label>
                                <input type="file" id="quiz_q2Audio" accept="audio/*" onchange="previewQuestionAudio(this, 'quiz_q2AudioPreview')">
                                <div id="quiz_q2AudioPreview" style="margin-top:10px"></div>
                                <small style="color:#666">Upload audio/music to play with the question</small>
                            </div>
                            
                            <!-- MCQ Options -->
                            <div id="quiz_q2McqSection">
                            <div class="form-group">
                                <label>Option A:</label>
                                <input type="text" id="quiz_q2OptA" placeholder="Option A">
                            </div>
                            <div class="form-group">
                                <label>Option B:</label>
                                <input type="text" id="quiz_q2OptB" placeholder="Option B">
                            </div>
                            <div class="form-group">
                                <label>Option C:</label>
                                <input type="text" id="quiz_q2OptC" placeholder="Option C">
                            </div>
                            <div class="form-group">
                                <label>Option D:</label>
                                <input type="text" id="quiz_q2OptD" placeholder="Option D">
                            </div>
                            <div class="form-group">
                                <label>Correct Answer:</label>
                                <select id="quiz_q2Correct">
                                    <option value="">-- Select --</option>
                                    <option value="A">A</option>
                                    <option value="B">B</option>
                                    <option value="C">C</option>
                                    <option value="D">D</option>
                                </select>
                            </div>
                            </div>
                            
                            <!-- Text Input Answer Section -->
                            <div id="quiz_q2TextSection" style="display:none">
                                <div class="form-group">
                                    <label>âœ… Correct Answer (one word / short phrase):</label>
                                    <input type="text" id="quiz_q2TextAnswer" placeholder="e.g. Newton, India, 1947">
                                    <small style="color:#666">Students must type this exactly (case-insensitive). Keep it one word or very short.</small>
                                </div>
                                <div class="form-group">
                                    <label>ðŸ“– Explanation for the Answer:</label>
                                    <textarea id="quiz_q2TextExplanation" rows="3" placeholder="Write a brief explanation shown to students after submission"></textarea>
                                </div>
                            </div>
                        </div>
                        
                        <button class="btn btn-success" onclick="saveQuizQuestionsFromAdmin()" style="font-size:1.1em">ðŸ’¾ Save Questions</button>
                        <button class="btn btn-info btn-small" onclick="viewTodayQuestionsAdmin()" style="margin-left:10px">ðŸ‘ï¸ View Today's Questions</button>
                        
                        <!-- Publish/Unpublish Section for Admin Dashboard -->
                        <div id="publishControlSectionAdmin" style="display:none;margin-top:30px;background:#fff3cd;padding:25px;border-radius:12px;border-left:5px solid #ffc107">
                            <h3 style="color:#6a1b9a;margin-bottom:15px">ðŸ“¢ Quiz Publication Control</h3>
                            <div id="publishStatusDisplayAdmin" style="margin-bottom:20px"></div>
                            <div style="display:flex;gap:10px;flex-wrap:wrap">
                                <button class="btn btn-success" onclick="publishTodayQuiz()" id="btnPublishAdmin" style="display:none">âœ… PUBLISH Quiz (Make Live)</button>
                                <button class="btn btn-danger" onclick="unpublishTodayQuiz()" id="btnUnpublishAdmin" style="display:none">âŒ UNPUBLISH Quiz (Hide)</button>
                            </div>
                        </div>
                        
                        <div id="todayQuestionsViewAdmin" style="display:none;margin-top:30px"></div>
                    </div>
                    
                    <!-- All Quizzes Sub-Tab -->
                    <div id="quizAllQuizzesContent" class="form-section">
                        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px">
                            <h3 style="color:#6a1b9a;margin:0">ðŸ“š All Quiz Questions (Sorted by Date)</h3>
                            <button class="btn btn-info btn-small" onclick="loadAllQuizzes()">ðŸ”„ Refresh List</button>
                        </div>
                        <div id="allQuizzesContainer"></div>
                    </div>
                    
                    <!-- Students Sub-Tab -->
                    <div id="quizStudentsContent" class="form-section">
                        <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:10px;margin-bottom:14px">
                            <h3 style="color:#6a1b9a;margin:0">Registered Quiz Students</h3>
                            <div style="display:flex;gap:8px;flex-wrap:wrap">
                            <button class="btn btn-info btn-small" onclick="loadQuizStudentsAdmin()">ðŸ”„ Refresh Students</button>
                            <button class="btn btn-small" onclick="fixAllPhoneNumbers()" style="background:linear-gradient(135deg,#e65100,#ff9800);color:white;font-weight:700;border:none">ðŸ”§ Fix 11-digit Phones</button>
                            </div>
                        </div>
                        <!-- Filter Bar -->
                        <div style="background:#f3e5f5;border-radius:12px;padding:14px 18px;margin-bottom:12px;display:flex;flex-wrap:wrap;gap:10px;align-items:center;border:2px solid #e0c8f5">
                            <input id="qsAdminSearch" type="text" placeholder="ðŸ” Search by name / phone / emailâ€¦" oninput="qsAdminApplyFilters()" style="flex:1;min-width:180px;padding:8px 12px;border:2px solid #9c27b0;border-radius:8px;font-size:0.9em;color:#3d0060;outline:none">
                            <select id="qsAdminClassFilter" onchange="qsAdminApplyFilters()" style="padding:8px 12px;border:2px solid #9c27b0;border-radius:8px;color:#3d0060;font-weight:600;background:white;outline:none">
                                <option value="">â€” All Classes â€”</option>
                            </select>
                            <button onclick="qsAdminResetFilters()" style="padding:8px 14px;background:#9c27b0;color:white;border:none;border-radius:8px;font-weight:700;cursor:pointer;font-size:0.85em">âœ– Reset</button>
                            <button onclick="qsAdminShowDuplicates()" style="padding:8px 14px;background:linear-gradient(135deg,#e65100,#f44336);color:white;border:none;border-radius:8px;font-weight:700;cursor:pointer;font-size:0.85em">âš ï¸ Duplicates</button>
                            <button onclick="qsAdminShowEmailFailed()" style="padding:8px 14px;background:linear-gradient(135deg,#1565c0,#0288d1);color:white;border:none;border-radius:8px;font-weight:700;cursor:pointer;font-size:0.85em">ðŸ“§ Email Failed</button>
                            <button onclick="qsAdminShowSummary()" style="padding:8px 14px;background:linear-gradient(135deg,#6a1b9a,#c44569);color:white;border:none;border-radius:8px;font-weight:700;cursor:pointer;font-size:0.85em">ðŸ“Š Summary</button>
                            <span id="qsAdminCount" style="color:#6a1b9a;font-weight:700;font-size:0.9em"></span>
                        </div>

                        <!-- Summary Report Box -->
                        <div id="qsAdminSummaryBox" style="display:none;background:white;border:2px solid #6a1b9a;border-radius:14px;margin-bottom:16px;overflow:hidden">
                            <div style="background:linear-gradient(135deg,#6a1b9a,#c44569);padding:14px 20px;display:flex;justify-content:space-between;align-items:center">
                                <h4 style="color:white;margin:0;font-size:1em">ðŸ“Š Class-wise Registration Summary (vs Class Strength)</h4>
                                <button onclick="document.getElementById('qsAdminSummaryBox').style.display='none'" style="background:rgba(255,255,255,0.2);color:white;border:none;border-radius:6px;padding:4px 10px;cursor:pointer;font-size:12px;font-weight:700">âœ• Close</button>
                            </div>
                            <div id="qsAdminSummaryContent" style="padding:16px 20px">
                                <p style="color:#999;text-align:center">Click ðŸ“Š Summary Report to generate</p>
                            </div>
                            <!-- Copy-ready message box -->
                            <div id="qsAdminMsgBox" style="display:none;margin:0 16px 16px;background:#f3e5f5;border-radius:10px;border:2px solid #9c27b0;padding:14px">
                                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
                                    <span style="color:#6a1b9a;font-weight:700;font-size:0.9em">ðŸ“‹ WhatsApp / Message Ready Text:</span>
                                    <button onclick="qsAdminCopyMsg()" style="background:#25d366;color:white;border:none;border-radius:6px;padding:5px 14px;cursor:pointer;font-size:12px;font-weight:700">ðŸ“‹ Copy</button>
                                </div>
                                <textarea id="qsAdminMsgText" rows="10" readonly style="width:100%;padding:10px;border:1.5px solid #9c27b0;border-radius:8px;font-size:13px;font-family:monospace;box-sizing:border-box;background:white;resize:vertical;color:#333"></textarea>
                            </div>
                        </div>

                        <div class="table-wrapper">
                            <table>
                                <thead>
                                    <tr>
                                        <th>#</th>
                                        <th>Name</th>
                                        <th>Email</th>
                                        <th>Phone</th>
                                        <th>Password</th>
                                        <th>Class</th>
                                        <th>Registered</th>
                                        <th>Email Status</th>
                                    </tr>
                                </thead>
                                <tbody id="quizStudentsTableAdmin"></tbody>
                            </table>
                        </div>
                    </div>
                    
                    <!-- Submissions Sub-Tab -->
                    <div id="quizSubmissionsContent" class="form-section">

                        <!-- â”€â”€ DATE SELECTOR + CLASS BREAKDOWN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
                        <div style="background:linear-gradient(135deg,#f3e5ff,#fce4ec);border-radius:14px;padding:20px 22px;margin-bottom:20px;border:2px solid #e0c8f5">
                            <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:12px;margin-bottom:16px">
                                <h3 style="color:#3d0060;margin:0;font-size:1.05em">ðŸ“… Class-wise Participation by Date</h3>
                                <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
                                    <select id="qsDateFilter" onchange="loadClassStats()" style="padding:7px 12px;border:2px solid #6a1b9a;border-radius:8px;color:#3d0060;font-weight:600;background:white;outline:none">
                                        <option value="">â€” Select Date â€”</option>
                                    </select>
                                    <button class="btn btn-small btn-info" onclick="loadClassStats()">ðŸ”„ Refresh</button>
                                </div>
                            </div>

                            <!-- Summary pills -->
                            <div id="qsSummaryPills" style="display:flex;gap:10px;flex-wrap:wrap;margin-bottom:14px">
                                <span style="background:rgba(106,27,154,0.12);color:#4a148c;padding:5px 14px;border-radius:20px;font-size:12.5px;font-weight:600" id="qsPillTotal">Total: â€”</span>
                                <span style="background:rgba(40,167,69,0.12);color:#155724;padding:5px 14px;border-radius:20px;font-size:12.5px;font-weight:600" id="qsPillCorrect">Both Correct: â€”</span>
                                <span style="background:rgba(196,69,105,0.12);color:#7b1040;padding:5px 14px;border-radius:20px;font-size:12.5px;font-weight:600" id="qsPillClasses">Classes Participated: â€”</span>
                            </div>

                            <!-- Class breakdown table -->
                            <div id="qsClassBreakdown">
                                <p style="color:#999;font-size:13px;text-align:center;padding:12px">Select a date above to see class-wise breakdown</p>
                            </div>
                        </div>

                        <!-- â”€â”€ QUIZ INFO NOTICE BOX â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
                        <div id="qsInfoBox" style="background:#fffde7;border-radius:10px;padding:16px 20px;margin-bottom:18px;border-left:4px solid #ffc107;display:none">
                            <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:10px">
                                <div style="flex:1">
                                    <h4 style="color:#856404;margin:0 0 6px;font-size:0.95em">ðŸ“‹ Quiz Summary â€” <span id="qsInfoDate"></span></h4>
                                    <div id="qsInfoText" style="color:#555;font-size:13px;line-height:1.7"></div>
                                </div>
                                <button onclick="copyQsInfo()" style="background:#ffc107;color:#1a0030;border:none;padding:5px 12px;border-radius:6px;cursor:pointer;font-size:12px;font-weight:700;white-space:nowrap">ðŸ“‹ Copy</button>
                            </div>
                        </div>

                        <!-- â”€â”€ TODAY'S FULL SUBMISSIONS TABLE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
                        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:14px;flex-wrap:wrap;gap:8px">
                            <h3 style="color:#6a1b9a;margin:0">Today's Quiz Submissions</h3>
                            <div style="display:flex;gap:8px;align-items:center">
                                <select id="qsClassFilter" onchange="filterSubmissionsTable()" style="padding:6px 10px;border:1px solid #6a1b9a;border-radius:6px;font-size:13px;outline:none">
                                    <option value="">All Classes</option>
                                </select>
                                <select id="qsScoreFilter" onchange="filterSubmissionsTable()" style="padding:6px 10px;border:1px solid #6a1b9a;border-radius:6px;font-size:13px;outline:none">
                                    <option value="">All Scores</option>
                                    <option value="2">Both Correct (2/2)</option>
                                    <option value="1">One Correct (1/2)</option>
                                    <option value="0">None Correct (0/2)</option>
                                </select>
                                <button class="btn btn-info btn-small" onclick="loadQuizSubmissionsAdmin()">ðŸ”„ Refresh</button>
                            </div>
                        </div>
                        <div class="table-wrapper">
                            <table>
                                <thead>
                                    <tr>
                                        <th>#</th>
                                        <th>Name</th>
                                        <th>Email</th>
                                        <th>Class</th>
                                        <th>Submitted</th>
                                        <th>Score</th>
                                        <th>Time</th>
                                    </tr>
                                </thead>
                                <tbody id="quizSubmissionsTableAdmin"></tbody>
                            </table>
                        </div>
                    </div>
                    
                    <!-- Winners Sub-Tab -->
                    <div id="quizWinnersContent" class="form-section">
                        <h3 style="color:#6a1b9a;margin-bottom:20px">ðŸ† Declare Today's Winners</h3>

                        <!-- â”€â”€ AUTO-DECLARATION PANEL â”€â”€ -->
                        <div style="background:linear-gradient(135deg,#1a0030 0%,#3d0060 100%);border-radius:14px;padding:20px 22px;margin-bottom:22px;border:2px solid rgba(255,215,0,0.3)">
                            <div style="display:flex;align-items:center;gap:12px;margin-bottom:14px;flex-wrap:wrap">
                                <span style="font-size:1.7em">â°</span>
                                <div style="flex:1">
                                    <h4 style="color:#ffd700;margin:0;font-size:1em">Auto-Declaration</h4>
                                    <p style="color:rgba(255,255,255,0.65);font-size:12px;margin:3px 0 0">Winners auto-selected at your chosen time daily.</p>
                                </div>
                                <!-- Time picker -->
                                <input type="time" id="autoDeclarTime" value="23:30" onchange="saveAutoDeclarSetting()"
                                    style="padding:6px 10px;border-radius:8px;border:2px solid #ffd700;background:#2a0050;color:#ffd700;font-size:14px;font-weight:700;cursor:pointer">
                                <label style="display:flex;align-items:center;gap:8px;cursor:pointer;margin:0">
                                    <div style="position:relative;width:48px;height:26px">
                                        <input type="checkbox" id="autoDeclarToggle" onchange="saveAutoDeclarSetting()" style="opacity:0;width:0;height:0;position:absolute">
                                        <span id="autoDeclarSlider" style="position:absolute;inset:0;background:#555;border-radius:26px;transition:0.3s;cursor:pointer"></span>
                                        <span id="autoDeclarThumb" style="position:absolute;left:3px;top:3px;width:20px;height:20px;background:white;border-radius:50%;transition:0.3s;pointer-events:none"></span>
                                    </div>
                                    <span id="autoDeclarLabel" style="color:#ffd700;font-weight:700;font-size:13px;white-space:nowrap">OFF</span>
                                </label>
                            </div>
                            <div id="autoDeclarWarning" style="background:rgba(255,150,0,0.15);border-radius:8px;padding:10px 14px;font-size:12px;color:#ffd700;margin-bottom:8px">
                                âš ï¸ <strong>Important:</strong> Auto-declaration only runs if this page is <strong>open in a browser at the set time</strong>. If the page is closed, use <strong>Run Now</strong> after the time passes.
                            </div>
                            <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px">
                                <button onclick="runAutoDeclaration()" style="background:#ffd700;color:#1a0030;border:none;padding:6px 16px;border-radius:8px;cursor:pointer;font-size:12px;font-weight:700">â–¶ï¸ Run Now (Manual Trigger)</button>
                                <button onclick="checkMissedAutoDeclar()" style="background:rgba(255,255,255,0.15);color:white;border:none;padding:6px 16px;border-radius:8px;cursor:pointer;font-size:12px;font-weight:600">ðŸ” Check Missed</button>
                            </div>
                            <div id="autoDeclarStatus" style="background:rgba(255,255,255,0.07);border-radius:8px;padding:10px 14px;font-size:12.5px;color:rgba(255,255,255,0.75)">
                                ðŸ”´ Auto-declaration is <strong style="color:#ff6b6b">disabled</strong>. Toggle ON to enable.
                            </div>
                            <div id="autoDeclarCountdown" style="display:none;margin-top:10px;background:rgba(255,215,0,0.1);border-radius:8px;padding:10px 14px;font-size:13px;color:#ffd700;font-weight:600;text-align:center"></div>
                        </div>

                        <!-- â”€â”€ HOW IT WORKS â”€â”€ -->\
                        <div style="background:#fff3cd;padding:15px 20px;border-radius:10px;margin-bottom:22px">
                            <p style="margin:0;color:#856404"><strong>â„¹ï¸ How it works:</strong> System randomly selects winner &amp; runner-up from students who got BOTH questions correct.</p>
                        </div>
                        
                        <!-- â”€â”€ DATE SELECTOR FOR STATS â”€â”€ -->
                        <div style="background:#e3f2fd;padding:14px 18px;border-radius:10px;margin-bottom:16px;display:flex;align-items:center;gap:14px;flex-wrap:wrap">
                            <label style="font-weight:700;color:#1565c0;white-space:nowrap">ðŸ“… View Stats for Date:</label>
                            <input type="date" id="winnersDateSelector" style="border:2px solid #1565c0;border-radius:8px;padding:7px 12px;font-size:1em;color:#333;background:white" onchange="loadQuizResultsAdmin()" />
                            <button onclick="loadQuizResultsAdmin()" style="background:#1565c0;color:white;border:none;padding:8px 18px;border-radius:8px;font-weight:700;cursor:pointer;font-size:0.95em">ðŸ”„ Load</button>
                        </div>
                        
                        <div style="background:#f8f9fa;padding:20px;border-radius:10px;margin:0 0 20px">
                            <h4 style="margin-bottom:15px">ðŸ“Š Statistics</h4>
                            <p><strong>Total:</strong> <span id="resultTotalPartAdmin">0</span></p>
                            <p><strong>Both Correct:</strong> <span id="resultBothCorrectAdmin">0</span></p>
                            <p><strong>Eligible:</strong> <span id="resultEligibleAdmin">0</span></p>
                        </div>
                        
                        <!-- Eligible Students List -->
                        <div id="eligibleStudentsListAdmin"></div>

                        <!-- Winner display for selected date -->
                        <div id="winnersDisplayAdmin" style="display:none;margin-top:25px"></div>

                        <!-- â”€â”€ ACTION BUTTONS â”€â”€ -->
                        <div style="display:flex;gap:12px;flex-wrap:wrap;margin-top:20px;margin-bottom:10px">
                            <button class="btn btn-warning" onclick="selectQuizWinnersFromAdmin()" style="font-size:1em;padding:14px 22px">ðŸŽ² Select Winners (Random)</button>
                            <button class="btn btn-info" onclick="toggleManualWinnerUI()" style="font-size:1em;padding:14px 22px" id="manualSelectToggleBtn">âœ‹ Manual Select</button>
                        </div>

                        <!-- â”€â”€ MANUAL SELECTION PANEL â”€â”€ -->
                        <div id="manualWinnerPanel" style="display:none;background:#f0f4ff;border:2px solid #667eea;border-radius:12px;padding:22px;margin-top:10px">
                            <h4 style="color:#667eea;margin-bottom:16px">âœ‹ Manual Winner Selection</h4>
                            <p style="color:#555;font-size:13px;margin-bottom:18px">Choose winner and runner-up from eligible students (both questions correct).</p>
                            <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:18px">
                                <div class="form-group" style="margin:0">
                                    <label style="color:#667eea;font-weight:700">ðŸ† Winner</label>
                                    <select id="manualWinnerSelect" style="border:2px solid #ffd700;border-radius:8px;padding:10px;margin-top:6px">
                                        <option value="">-- Select Winner --</option>
                                    </select>
                                </div>
                                <div class="form-group" style="margin:0">
                                    <label style="color:#667eea;font-weight:700">ðŸ¥ˆ Runner-Up</label>
                                    <select id="manualRunnerSelect" style="border:2px solid #aaa;border-radius:8px;padding:10px;margin-top:6px">
                                        <option value="">-- Select Runner-Up --</option>
                                    </select>
                                </div>
                            </div>
                            <div style="display:flex;gap:10px;flex-wrap:wrap">
                                <button class="btn btn-success" onclick="declareManualWinners()" style="padding:12px 24px">âœ… Declare These Winners</button>
                                <button class="btn btn-secondary" onclick="toggleManualWinnerUI()" style="padding:12px 20px">âœ– Cancel</button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Edit Quiz Dates Sub-Tab (Super Admin Only) -->
                    <div id="quizEditDatesContent" class="form-section super-admin-only">
                        <h3 style="color:#6a1b9a;margin-bottom:20px">ðŸ“… Edit Quiz Dates</h3>
                        <p style="color:#666;margin-bottom:20px">Select a quiz and change its date. This will move the quiz to a different day.</p>
                        
                        <div style="background:#fff3cd;padding:15px;border-radius:8px;border-left:5px solid #ffc107;margin-bottom:20px">
                            <p style="margin:0;color:#856404;font-weight:600">âš ï¸ Warning: Changing quiz dates will affect student access and published status.</p>
                        </div>
                        
                        <!-- Quiz Selection -->
                        <div id="quizDateList" style="margin-bottom:30px">
                            <h4 style="color:#c44569;margin-bottom:15px">Select Quiz to Edit:</h4>
                            <button class="btn btn-info btn-small" onclick="loadQuizzesForDateEdit()" style="margin-bottom:15px">ðŸ”„ Refresh Quiz List</button>
                            <div id="quizListForDateEdit"></div>
                        </div>
                        
                        <!-- Date Change Form -->
                        <div id="dateChangeForm" style="display:none">
                            <h4 style="color:#c44569;margin-bottom:15px">Change Quiz Date:</h4>
                            
                            <div style="background:#f9f9f9;padding:20px;border-radius:8px;margin-bottom:20px">
                                <p style="margin:0 0 10px 0;color:#333"><strong>Current Date:</strong> <span id="currentQuizDate" style="color:#c44569"></span></p>
                                <p style="margin:0;color:#666;font-size:0.9em" id="currentQuizPreview"></p>
                            </div>
                            
                            <div class="form-group">
                                <label for="newQuizDate">New Date *</label>
                                <input type="date" id="newQuizDate" required>
                            </div>
                            
                            <div class="form-group">
                                <label style="display:flex;align-items:center;cursor:pointer;">
                                    <input type="checkbox" id="autoPublishAfterMove" checked style="width:auto;margin-right:10px;">
                                    <span>Automatically publish quiz at new date</span>
                                </label>
                                <p style="color:#666;font-size:0.9em;margin-top:5px;">If checked, the quiz will be published and visible to students at the new date.</p>
                            </div>
                            
                            <div id="dateChangeMessage" class="message"></div>
                            
                            <div style="display:flex;gap:10px;margin-top:20px">
                                <button class="btn btn-warning" onclick="updateQuizDate()">ðŸ“… Change Date</button>
                                <button class="btn btn-secondary" onclick="cancelDateEdit()">âŒ Cancel</button>
                            </div>
                        </div>
                    </div>
                </div>
            <!-- ============================================ -->
            <!-- SCAVENGER HUNT ADMIN PANEL                  -->
            <!-- ============================================ -->
            <div id="scavengerAdmin" class="form-section super-admin-only">
                <h2 style="color:#9c27b0;margin-bottom:6px">ðŸ—ºï¸ Scavenger Hunt Management</h2>
                <p style="color:#666;margin-bottom:22px">Create tasks, verify photo submissions and declare winners.</p>

                <!-- Sub-tabs -->
                <div class="tabs" style="margin-bottom:20px">
                    <button class="tab active" onclick="shAdminTab('shAdminTasks', this)">ðŸ“‹ Tasks</button>
                    <button class="tab" onclick="shAdminTab('shAdminSubmissions', this)">ðŸ“¸ Submissions</button>
                    <button class="tab" onclick="shAdminTab('shAdminLeaderboard', this)">ðŸ† Leaderboard</button>
                    <button class="tab" onclick="shAdminTab('shAdminClasswise', this)">ðŸ“Š Class-wise</button>
                    <button class="tab" onclick="shAdminTab('shAdminWinners', this)">ðŸŽ–ï¸ Winners</button>
                    <button class="tab" onclick="shAdminTab('shAdminSettings', this)">âš™ï¸ Settings</button>
                </div>

                <!-- TASKS TAB -->
                <div id="shAdminTasks" class="sh-tab-panel" style="display:block">
                    <div style="background:#f3e5f5;padding:18px;border-radius:10px;margin-bottom:20px;border-left:5px solid #9c27b0">
                        <h4 style="color:#6a1b9a;margin-bottom:14px">âž• Create New Task</h4>
                        <div class="form-group">
                            <label>Task Name / Description:</label>
                            <input type="text" id="shNewTaskName" placeholder='e.g. "Find the school library"'>
                        </div>
                        <div class="form-group">
                            <label>Hint / Clue (optional):</label>
                            <input type="text" id="shNewTaskHint" placeholder='e.g. "Look near the main building ground floor"'>
                        </div>
                        <div class="form-group">
                            <label>ðŸ–¼ï¸ Task Image (optional â€” shown to students as a visual clue or reference):</label>
                            <input type="file" id="shNewTaskImageFile" accept="image/*" onchange="shPreviewNewTaskImage(this)" style="display:block;margin-bottom:8px">
                            <div id="shNewTaskImagePreview" style="display:none;margin-bottom:6px">
                                <img id="shNewTaskImagePreviewImg" style="max-width:220px;max-height:160px;border-radius:8px;border:2px solid #ce93d8;box-shadow:0 2px 8px rgba(0,0,0,0.12)" alt="preview">
                                <button type="button" onclick="shClearNewTaskImage()" style="display:block;margin-top:5px;background:#ffebee;color:#c62828;border:1px solid #ef9a9a;border-radius:6px;padding:3px 10px;cursor:pointer;font-size:0.82em">âœ• Remove</button>
                            </div>
                            <span id="shNewTaskImageMsg" style="font-size:0.82em;color:#888">Image will upload automatically when you save the task.</span>
                        </div>
                        <div class="form-group">
                            <label>ðŸ“¸ Task Parts (multi-photo, optional):</label>
                            <div id="shNewTaskPartsBox" style="display:flex;flex-direction:column;gap:6px;margin-bottom:6px"></div>
                            <button type="button" onclick="shAddNewTaskPart()" style="background:#e8f5e9;color:#2e7d32;border:2px dashed #4caf50;border-radius:8px;padding:6px 14px;cursor:pointer;font-size:0.88em;font-weight:700">âž• Add Part</button>
                            <span style="font-size:0.8em;color:#888;display:block;margin-top:4px">Each part = one photo. Student must get each part approved before the next unlocks. Leave empty for single-photo task.</span>
                        </div>
                        <div class="form-group">
                            <label>Task Order / Number:</label>
                            <input type="number" id="shNewTaskOrder" value="1" min="1" style="width:100px">
                        </div>
                        <div class="form-group">
                            <label>ðŸ“… Available From (Date & Time):</label>
                            <input type="datetime-local" id="shNewTaskDate" style="padding:8px 12px;border:2px solid #9c27b0;border-radius:8px;font-size:0.95em">
                            <span style="font-size:0.8em;color:#888;display:block;margin-top:4px">Leave blank = available immediately</span>
                        </div>
                        <div class="form-group">
                            <label>â° Available Until (Deadline):</label>
                            <input type="datetime-local" id="shNewTaskDeadline" style="padding:8px 12px;border:2px solid #e91e63;border-radius:8px;font-size:0.95em">
                            <span style="font-size:0.8em;color:#888;display:block;margin-top:4px">Leave blank = no deadline</span>
                        </div>

                        <div style="background:#e3f2fd;padding:14px;border-radius:8px;margin-bottom:14px;border-left:4px solid #2196f3">
                            <strong style="color:#1565c0">ðŸ“ GPS Target Location (for Auto-Verification)</strong><br>
                            <small style="color:#555">Click the button below or enter coordinates manually. Participants must be within 100m.</small>
                            <div style="display:flex;gap:10px;margin-top:10px;flex-wrap:wrap;align-items:center">
                                <input type="number" id="shNewTaskLat" placeholder="Latitude" step="0.000001" style="width:160px">
                                <input type="number" id="shNewTaskLng" placeholder="Longitude" step="0.000001" style="width:160px">
                                <button onclick="shAdminGetLocation()" class="btn btn-info btn-small">ðŸ“ Use My Location</button>
                            </div>
                            <div id="shAdminLocMsg" style="font-size:0.85em;color:#1565c0;margin-top:6px"></div>
                        </div>

                        <button class="btn" onclick="shAdminCreateTask()" style="background:linear-gradient(135deg,#9c27b0,#e91e63)">
                            âž• Add Task
                        </button>
                        <span id="shCreateTaskMsg" style="margin-left:12px;font-size:0.9em;color:#4caf50;display:none">âœ… Task created!</span>
                    </div>

                    <!-- â”€â”€ WhatsApp Share Box (always visible) â”€â”€ -->
                    <div id="shWaBox" style="display:block;background:linear-gradient(135deg,#e8f5e9,#f1f8e9);border:2px solid #25D366;border-radius:12px;padding:18px;margin-bottom:20px">
                        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:10px;flex-wrap:wrap;gap:8px">
                            <span style="color:#1b5e20;font-weight:700;font-size:1em">ðŸ“² WhatsApp Announcement Ready!</span>
                            <div style="display:flex;gap:8px">
                                <button class="btn btn-success btn-small" onclick="shCopyWaMsg()" id="shWaCopyBtn">ðŸ“‹ Copy Message</button>
                            </div>
                        </div>
                        <textarea id="shWaText" rows="8" readonly
                            style="width:100%;padding:12px;border:1px solid #a5d6a7;border-radius:8px;font-size:13px;line-height:1.7;background:white;color:#1a1a1a;resize:vertical;font-family:inherit;cursor:text"
                            onclick="this.select()">â³ Loading tasks...</textarea>
                    </div>

                    <h4 style="color:#6a1b9a;margin-bottom:12px">ðŸ“‹ All Tasks</h4>
                    <div id="shAdminTasksList">
                        <p style="color:#999">Loading tasks...</p>
                    </div>
                </div>

                <!-- SUBMISSIONS TAB -->
                <div id="shAdminSubmissions" class="sh-tab-panel" style="display:none">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;flex-wrap:wrap;gap:10px">
                        <h4 style="color:#6a1b9a;margin:0">ðŸ“¸ Photo Submissions <span style="background:#28a745;color:white;font-size:0.7em;padding:2px 8px;border-radius:20px;margin-left:6px">ðŸ”´ LIVE</span></h4>
                        <button class="btn btn-info btn-small" onclick="shAdminLoadSubmissions()">ðŸ”„ Refresh</button>
                    </div>
                    <div style="display:flex;gap:10px;margin-bottom:14px;flex-wrap:wrap;align-items:center">
                        <select id="shSubmissionFilter" onchange="shAdminLoadSubmissions()" style="padding:8px 14px;border-radius:8px;border:2px solid #9c27b0">
                            <option value="all">ðŸ“‹ All Status</option>
                            <option value="pending">â³ Pending</option>
                            <option value="approved">âœ… Approved</option>
                            <option value="rejected">âŒ Rejected</option>
                        </select>
                        <select id="shSubmissionDateFilter" onchange="shAdminLoadSubmissions()" style="padding:8px 14px;border-radius:8px;border:2px solid #9c27b0">
                            <option value="all">ðŸ“… All Dates</option>
                        </select>
                        <select id="shSubmissionTaskFilter" onchange="shAdminLoadSubmissions()" style="padding:8px 14px;border-radius:8px;border:2px solid #9c27b0">
                            <option value="all">ðŸ“Œ All Tasks</option>
                        </select>
                        <button class="btn btn-secondary btn-small" onclick="shResetSubmissionFilters()">âœ– Reset</button>
                    </div>
                    <div id="shAdminSubmissionsList">
                        <p style="color:#999">Click Refresh to load submissions.</p>
                    </div>
                </div>

                <!-- LEADERBOARD TAB -->
                <div id="shAdminLeaderboard" class="sh-tab-panel" style="display:none">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;flex-wrap:wrap;gap:10px">
                        <h4 style="color:#6a1b9a;margin:0">ðŸ† Live Leaderboard</h4>
                        <button class="btn btn-info btn-small" onclick="shAdminLoadLeaderboard()">ðŸ”„ Refresh</button>
                    </div>
                    <!-- Leaderboard Filters -->
                    <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-bottom:16px;background:#f3e5f5;padding:10px 14px;border-radius:10px;border:1px solid #ce93d8">
                        <span style="font-size:0.82em;font-weight:700;color:#6a1b9a;white-space:nowrap">ðŸ” Filter:</span>
                        <select id="shLbTaskFilter" onchange="shAdminRenderLeaderboard()" style="padding:6px 12px;border:2px solid #9c27b0;border-radius:8px;font-weight:600;color:#3d0060;font-size:0.85em">
                            <option value="all">ðŸ“Œ All Tasks</option>
                        </select>
                        <select id="shLbClassFilter" onchange="shAdminRenderLeaderboard()" style="padding:6px 12px;border:2px solid #9c27b0;border-radius:8px;font-weight:600;color:#3d0060;font-size:0.85em">
                            <option value="all">ðŸ« All Classes</option>
                        </select>
                        <button onclick="document.getElementById('shLbTaskFilter').value='all';document.getElementById('shLbClassFilter').value='all';shAdminRenderLeaderboard();" style="background:#6a1b9a;color:white;border:none;padding:6px 12px;border-radius:8px;cursor:pointer;font-size:0.82em;font-weight:600">âœ– Clear</button>
                    </div>
                    <div id="shAdminLeaderboardList">
                        <p style="color:#999">Click Refresh to load leaderboard.</p>
                    </div>
                </div>

                <!-- CLASS-WISE TAB -->
                <div id="shAdminClasswise" class="sh-tab-panel" style="display:none">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;flex-wrap:wrap;gap:10px">
                        <h4 style="color:#6a1b9a;margin:0">ðŸ“Š Class-wise Participation</h4>
                        <button class="btn btn-info btn-small" onclick="shAdminLoadClasswise()">ðŸ”„ Refresh</button>
                    </div>
                    <!-- Class-wise Summary Filters -->
                    <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-bottom:16px;background:#fffde7;padding:10px 14px;border-radius:10px;border:1px solid #ffc107">
                        <span style="font-size:0.82em;font-weight:700;color:#856404;white-space:nowrap">ðŸ” Filter Summary:</span>
                        <select id="shCwTaskFilter" onchange="shAdminApplyClasswiseFilters()" style="padding:6px 12px;border:2px solid #ffc107;border-radius:8px;font-weight:600;color:#3d0060;font-size:0.85em">
                            <option value="all">ðŸ“Œ All Tasks</option>
                        </select>
                        <select id="shCwDateFilter" onchange="shAdminApplyClasswiseFilters()" style="padding:6px 12px;border:2px solid #ffc107;border-radius:8px;font-weight:600;color:#3d0060;font-size:0.85em">
                            <option value="all">ðŸ“… All Dates</option>
                        </select>
                        <button onclick="document.getElementById('shCwTaskFilter').value='all';document.getElementById('shCwDateFilter').value='all';shAdminApplyClasswiseFilters();" style="background:#856404;color:white;border:none;padding:6px 12px;border-radius:8px;cursor:pointer;font-size:0.82em;font-weight:600">âœ– Clear</button>
                    </div>

                    <!-- SH Summary message box (copyable) -->
                    <div id="shCwSummaryBox" style="background:#fffde7;border-radius:10px;padding:16px 20px;margin-bottom:18px;border-left:4px solid #ffc107;display:none">
                        <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:10px">
                            <div style="flex:1">
                                <h4 style="color:#856404;margin:0 0 6px;font-size:0.95em">ðŸ—ºï¸ Scavenger Hunt Summary â€” <span id="shCwSummaryDate"></span></h4>
                                <div id="shCwSummaryText" style="color:#555;font-size:13px;line-height:1.7"></div>
                            </div>
                            <button onclick="shCopySummary()" style="background:#ffc107;color:#1a0030;border:none;padding:5px 12px;border-radius:6px;cursor:pointer;font-size:12px;font-weight:700;white-space:nowrap">ðŸ“‹ Copy</button>
                        </div>
                    </div>

                    <!-- Summary pills -->
                    <div style="display:flex;gap:10px;flex-wrap:wrap;margin-bottom:16px">
                        <span id="shCwPillTotal" style="background:#e8eaf6;color:#3949ab;padding:6px 16px;border-radius:20px;font-size:0.85em;font-weight:700">Total: â€”</span>
                        <span id="shCwPillApproved" style="background:#e8f5e9;color:#2e7d32;padding:6px 16px;border-radius:20px;font-size:0.85em;font-weight:700">Approved: â€”</span>
                        <span id="shCwPillPending" style="background:#fff3e0;color:#e65100;padding:6px 16px;border-radius:20px;font-size:0.85em;font-weight:700">Pending: â€”</span>
                        <span id="shCwPillClasses" style="background:#f3e5f5;color:#6a1b9a;padding:6px 16px;border-radius:20px;font-size:0.85em;font-weight:700">Classes: â€”</span>
                    </div>

                    <!-- Class breakdown table -->
                    <div id="shAdminClasswiseList">
                        <p style="color:#999">Click Refresh to load class-wise data.</p>
                    </div>

                    <hr style="margin:24px 0;border-color:#e0e0e0">

                    <!-- Today's submissions by class (like quiz) -->
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;flex-wrap:wrap;gap:10px">
                        <h4 style="color:#6a1b9a;margin:0">ðŸ“¸ All Submissions Detail</h4>
                        <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">
                            <select id="shCwClassFilter" onchange="shAdminLoadClasswiseDetail()" style="padding:7px 12px;border:2px solid #9c27b0;border-radius:8px;font-weight:600;color:#3d0060">
                                <option value="">All Classes</option>
                            </select>
                            <select id="shCwStatusFilter" onchange="shAdminLoadClasswiseDetail()" style="padding:7px 12px;border:2px solid #9c27b0;border-radius:8px;font-weight:600;color:#3d0060">
                                <option value="">All Statuses</option>
                                <option value="approved">âœ… Approved</option>
                                <option value="pending">â³ Pending</option>
                                <option value="rejected">âŒ Rejected</option>
                            </select>
                        </div>
                    </div>
                    <div class="table-wrapper">
                        <table style="font-size:13px;width:100%">
                            <thead><tr>
                                <th style="background:#3d0060;color:#ffd700">#</th>
                                <th style="background:#3d0060;color:white">Student</th>
                                <th style="background:#3d0060;color:#ce93d8">Class</th>
                                <th style="background:#3d0060;color:#80deea">Task</th>
                                <th style="background:#3d0060;color:#fff3cd">Submitted At</th>
                                <th style="background:#3d0060;color:#a5d6a7">Status</th>
                            </tr></thead>
                            <tbody id="shCwDetailTable">
                                <tr><td colspan="6" style="text-align:center;color:#999;padding:16px">Click Refresh to load</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- WINNERS TAB -->
                <div id="shAdminWinners" class="sh-tab-panel" style="display:none">
                    <div style="background:linear-gradient(135deg,#7b1fa2,#e91e63);border-radius:14px;padding:22px;margin-bottom:20px;color:white">
                        <h3 style="margin:0 0 6px;font-size:1.2em">ðŸŽ–ï¸ Declare Scavenger Hunt Winner</h3>
                        <p style="margin:0;font-size:0.88em;opacity:0.85">Select winner and runner-up from participants who completed ALL tasks</p>
                    </div>

                    <!-- â”€â”€ AUTO-DECLARATION PANEL â”€â”€ -->
                    <div style="background:linear-gradient(135deg,#1a0030 0%,#3d0060 100%);border-radius:14px;padding:20px 22px;margin-bottom:20px;border:2px solid rgba(255,215,0,0.3)">
                        <div style="display:flex;align-items:center;gap:12px;margin-bottom:16px;flex-wrap:wrap">
                            <span style="font-size:1.7em">â°</span>
                            <div style="flex:1">
                                <h4 style="color:#ffd700;margin:0;font-size:1em">Auto-Declaration</h4>
                                <p style="color:rgba(255,255,255,0.65);font-size:12px;margin:3px 0 0">Set the date, time and which task winners should be declared for.</p>
                            </div>
                            <!-- Toggle -->
                            <label style="display:flex;align-items:center;gap:8px;cursor:pointer;margin:0">
                                <div style="position:relative;width:48px;height:26px">
                                    <input type="checkbox" id="shAutoDeclarToggle" onchange="shToggleAutoDeclar()" style="opacity:0;width:0;height:0;position:absolute">
                                    <span id="shAutoDeclarSlider" style="position:absolute;inset:0;background:#555;border-radius:26px;transition:0.3s;cursor:pointer"></span>
                                    <span id="shAutoDeclarThumb" style="position:absolute;left:3px;top:3px;width:20px;height:20px;background:white;border-radius:50%;transition:0.3s;pointer-events:none"></span>
                                </div>
                                <span id="shAutoDeclarBadge" style="color:#ffd700;font-weight:700;font-size:13px;white-space:nowrap">OFF</span>
                            </label>
                        </div>

                        <!-- Date + Time + Task row -->
                        <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;margin-bottom:14px">
                            <div>
                                <label style="color:rgba(255,255,255,0.7);font-size:11px;font-weight:600;display:block;margin-bottom:4px">ðŸ“… DATE</label>
                                <input type="date" id="shAutoDeclarDate"
                                    style="width:100%;padding:8px 10px;border-radius:8px;border:2px solid #ffd700;background:#2a0050;color:#ffd700;font-size:13px;font-weight:700;cursor:pointer">
                            </div>
                            <div>
                                <label style="color:rgba(255,255,255,0.7);font-size:11px;font-weight:600;display:block;margin-bottom:4px">ðŸ• TIME</label>
                                <input type="time" id="shAutoDeclarTime"
                                    style="width:100%;padding:8px 10px;border-radius:8px;border:2px solid #ffd700;background:#2a0050;color:#ffd700;font-size:13px;font-weight:700;cursor:pointer">
                            </div>
                            <div>
                                <label style="color:rgba(255,255,255,0.7);font-size:11px;font-weight:600;display:block;margin-bottom:4px">ðŸ—ºï¸ TASK</label>
                                <select id="shAutoDeclarTask"
                                    style="width:100%;padding:8px 10px;border-radius:8px;border:2px solid #ffd700;background:#2a0050;color:#ffd700;font-size:13px;font-weight:700;cursor:pointer">
                                    <option value="all">â­ All tasks</option>
                                </select>
                            </div>
                        </div>

                        <div style="display:flex;gap:8px;margin-bottom:12px;flex-wrap:wrap">
                            <button onclick="shSaveAutoDeclarConfig(this)" style="background:#ffd700;color:#1a0030;border:none;padding:7px 18px;border-radius:8px;cursor:pointer;font-size:12px;font-weight:700">ðŸ’¾ Save Config</button>
                            <button onclick="shRunAutoDeclaration()" style="background:rgba(255,255,255,0.15);color:white;border:none;padding:7px 16px;border-radius:8px;cursor:pointer;font-size:12px;font-weight:600">â–¶ï¸ Run Now</button>
                        </div>

                        <div id="shAutoDeclarStatusMsg" style="background:rgba(255,255,255,0.07);border-radius:8px;padding:10px 14px;font-size:12.5px;color:rgba(255,255,255,0.75);margin-bottom:8px">
                            ðŸ”´ Auto-declaration is <strong style="color:#ff6b6b">disabled</strong>. Toggle ON and save config to enable.
                        </div>
                        <div id="shAutoDeclarCountdownDisplay" style="display:none;background:rgba(255,215,0,0.1);border-radius:8px;padding:8px 14px;font-size:13px;color:#ffd700;font-weight:600;text-align:center"></div>
                    </div>

                    <div style="display:flex;gap:12px;flex-wrap:wrap;margin-bottom:20px">
                        <button class="btn btn-success" onclick="shSelectWinnersAuto()" style="font-size:1em;padding:12px 22px">ðŸŽ² Auto-Select (Random from Top)</button>
                        <button class="btn btn-info" onclick="shToggleManualWinner()" id="shManualWinnerToggleBtn" style="font-size:1em;padding:12px 22px">âœ‹ Manual Select</button>
                        <button class="btn btn-info btn-small" onclick="shLoadWinnersTab()" style="margin-left:auto">ðŸ”„ Refresh</button>
                    </div>

                    <!-- Manual select panel -->
                    <div id="shManualWinnerPanel" style="display:none;background:#f0f4ff;border:2px solid #667eea;border-radius:12px;padding:22px;margin-bottom:20px">
                        <h4 style="color:#667eea;margin-bottom:14px">âœ‹ Manual Winner Selection</h4>
                        <p style="color:#555;font-size:13px;margin-bottom:16px">Choose winner and runner-up from all participants.</p>
                        <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:16px">
                            <div>
                                <label style="color:#ffd700;font-weight:700;display:block;margin-bottom:6px">ðŸ¥‡ Winner</label>
                                <select id="shManualWinnerSelect" style="width:100%;padding:10px;border:2px solid #ffd700;border-radius:8px;font-size:0.95em">
                                    <option value="">-- Select Winner --</option>
                                </select>
                            </div>
                            <div>
                                <label style="color:#c0c0c0;font-weight:700;display:block;margin-bottom:6px">ðŸ¥ˆ Runner-up</label>
                                <select id="shManualRunnerSelect" style="width:100%;padding:10px;border:2px solid #c0c0c0;border-radius:8px;font-size:0.95em">
                                    <option value="">-- Select Runner-up --</option>
                                </select>
                            </div>
                        </div>
                        <div style="display:flex;gap:10px">
                            <button class="btn btn-success" onclick="shDeclareManualWinners()" style="padding:12px 24px">âœ… Declare These Winners</button>
                            <button class="btn btn-secondary" onclick="shToggleManualWinner()" style="padding:12px 20px">âœ– Cancel</button>
                        </div>
                    </div>

                    <!-- Eligible participants list -->
                    <div id="shWinnersEligibleList" style="margin-bottom:20px">
                        <p style="color:#999">Click Refresh to load participants.</p>
                    </div>

                    <!-- Current declared winner display -->
                    <div id="shWinnersDeclaredBox" style="display:none"></div>
                </div>

                <!-- SETTINGS TAB -->
                <div id="shAdminSettings" class="sh-tab-panel" style="display:none">
                    <div style="background:#fff3e0;padding:18px;border-radius:10px;margin-bottom:20px;border-left:5px solid #ff9800">
                        <h4 style="color:#e65100;margin-bottom:14px">âš™ï¸ Hunt Settings</h4>

                        <div class="form-group">
                            <label style="display:flex;align-items:center;gap:10px;cursor:pointer">
                                <input type="checkbox" id="shSettingActive" style="width:20px;height:20px;accent-color:#9c27b0">
                                <span><strong>Hunt is ACTIVE</strong> â€” Students can login and attempt tasks</span>
                            </label>
                        </div>
                        <div class="form-group">
                            <label style="display:flex;align-items:center;gap:10px;cursor:pointer">
                                <input type="checkbox" id="shSettingGPS" style="width:20px;height:20px;accent-color:#9c27b0" checked>
                                <span><strong>GPS Verification ON</strong> â€” Must be within 100m to upload</span>
                            </label>
                        </div>
                        <div class="form-group">
                            <label>GPS Radius (metres):</label>
                            <input type="number" id="shSettingRadius" value="100" min="10" max="1000" style="width:120px">
                        </div>
                        <div class="form-group">
                            <label style="display:flex;align-items:center;gap:10px;cursor:pointer">
                                <input type="checkbox" id="shSettingAutoApprove" style="width:20px;height:20px;accent-color:#9c27b0">
                                <span><strong>Auto-Approve</strong> on GPS match (no manual review needed)</span>
                            </label>
                        </div>
                        <button class="btn btn-success" onclick="shAdminSaveSettings()" style="margin-top:6px">ðŸ’¾ Save Settings</button>
                        <span id="shSettingsSaveMsg" style="margin-left:12px;font-size:0.9em;color:#4caf50;display:none">âœ… Saved!</span>
                    </div>

                    <!-- â˜ï¸ CLOUDINARY TEST -->
                    <div style="background:#e3f2fd;padding:18px;border-radius:10px;margin-bottom:20px;border-left:5px solid #1976d2">
                        <h4 style="color:#0d47a1;margin-bottom:10px">â˜ï¸ Cloudinary Connection Test</h4>
                        <p style="color:#555;font-size:0.9em;margin-bottom:12px">Cloud: <strong>dat0khbet</strong> | Preset: <strong>scavenger_hunt</strong><br>Pick a photo (or leave blank) and tap Test.</p>
                        <input type="file" id="shCloudTestFile" accept="image/*" style="margin-bottom:10px;font-size:0.9em"><br>
                        <button class="btn" style="background:#1976d2;color:white" onclick="shTestCloudinary()">ðŸ§ª Test Cloudinary Upload</button>
                        <div id="shCloudTestResult" style="margin-top:12px;font-size:0.9em"></div>
                    </div>

                    <!-- ðŸ”§ FIX TASK ORDER + DEADLINES -->
                    <div style="background:#e8f5e9;padding:18px;border-radius:10px;margin-bottom:20px;border-left:5px solid #2e7d32">
                        <h4 style="color:#1b5e20;margin-bottom:8px">ðŸ”§ Fix Task Order Numbers</h4>
                        <p style="color:#555;font-size:0.9em;margin-bottom:12px">Renumbers tasks 1, 2, 3... and optionally removes all deadlines so expired tasks never block submissions.</p>
                        <button class="btn" style="background:#388e3c;color:white;margin-right:10px" onclick="shFixChainOrder(false)">ðŸ” Preview</button>
                        <button class="btn" style="background:#2e7d32;color:white;margin-right:10px" onclick="shFixChainOrder(true)">âœ… Fix Order Numbers</button>
                        <button class="btn" style="background:#e65100;color:white" onclick="shRemoveAllDeadlines()">ðŸ—“ï¸ Remove ALL Deadlines</button>
                        <div id="shChainFixResult" style="margin-top:12px;font-size:0.85em;font-family:monospace;background:#fafafa;padding:10px;border-radius:6px;border:1px solid #c8e6c9;display:none;white-space:pre-wrap"></div>
                    </div>

                    <!-- ðŸ› ï¸ ADMIN FORCE SUBMIT -->
                    <div style="background:#fff8e1;padding:18px;border-radius:10px;margin-bottom:20px;border-left:5px solid #f9a825">
                        <h4 style="color:#e65100;margin-bottom:8px">ðŸ› ï¸ Admin Force Submit</h4>
                        <p style="color:#555;font-size:0.9em;margin-bottom:12px">Manually create a pending submission. Get the photo URL from your Cloudinary dashboard â†’ Assets.</p>
                        <div style="display:grid;gap:8px;max-width:500px">
                            <input type="text" id="afsStudentKey" placeholder="Student key e.g. Gujjar1" style="padding:8px 12px;border-radius:6px;border:1px solid #ccc">
                            <select id="afsTaskId" style="padding:8px 12px;border-radius:6px;border:1px solid #ccc"><option value="">â€” Select Task â€”</option></select>
                            <input type="text" id="afsPhotoUrl" placeholder="Cloudinary URL (https://res.cloudinary.com/...)" style="padding:8px 12px;border-radius:6px;border:1px solid #ccc">
                            <input type="text" id="afsComment" placeholder="Comment / note" style="padding:8px 12px;border-radius:6px;border:1px solid #ccc">
                        </div>
                        <button class="btn" style="background:#f57c00;color:white;margin-top:10px" onclick="shAdminForceSubmit()">ðŸ› ï¸ Force Create Submission</button>
                        <div id="afsResult" style="margin-top:10px;font-size:0.9em"></div>
                    </div>

                    <!-- ðŸ” DEBUGGER -->
                    <div style="background:#f3e5f5;padding:18px;border-radius:10px;margin-bottom:20px;border-left:5px solid #7b1fa2">
                        <h4 style="color:#4a148c;margin-bottom:10px">ðŸ” Student Submission Debugger</h4>
                        <p style="color:#555;font-size:0.9em;margin-bottom:10px">Enter a student key to see exactly what Firebase has saved for them.</p>
                        <input type="text" id="shDebugStudentKey" placeholder="Student key e.g. Gujjar1" style="padding:8px 12px;border-radius:6px;border:1px solid #ccc;width:220px;margin-right:8px">
                        <button class="btn" style="background:#7b1fa2;color:white" onclick="shDebugStudentSubs()">ðŸ” Check Firebase</button>
                        <div id="shDebugResult" style="margin-top:14px;font-size:0.85em;font-family:monospace;background:#fafafa;padding:12px;border-radius:6px;border:1px solid #e0e0e0;display:none;max-height:300px;overflow-y:auto;white-space:pre-wrap"></div>
                    </div>

                    <div style="background:#ffebee;padding:18px;border-radius:10px;border-left:5px solid #f44336">
                        <h4 style="color:#c62828;margin-bottom:10px">ðŸ—‘ï¸ Danger Zone</h4>
                        <button class="btn btn-danger btn-small" onclick="shAdminResetAll()" style="margin-right:10px">ðŸ—‘ï¸ Reset All Submissions</button>
                        <button class="btn btn-danger btn-small" onclick="shAdminDeleteAllTasks()">ðŸ—‘ï¸ Delete All Tasks</button>
                    </div>
                </div>
            </div>

            <!-- ================================================ -->
            <!-- LEADERBOARD ADMIN PANEL (Super Admin only)       -->
            <!-- Accessed via the "ðŸ† Leaderboard" tab above      -->
            <!-- ================================================ -->

            <!-- ================================================ -->
            <!-- SPEED SLIDE ADMIN PANEL (Super Admin only)       -->
            <!-- Accessed via the "ðŸ§© Speed Slide Admin" tab      -->
            <!-- ================================================ -->
            <div id="speedSlideAdmin" class="form-section super-admin-only">
                <h2 style="color:#c44569;margin-bottom:6px">ðŸ§© Speed Slide Challenge â€” Admin Panel</h2>
                <p style="color:#888;margin-bottom:20px;font-size:.9em">Manage all submissions, approve scores, view leaderboard and configure the game.</p>

                <!-- Sub-tabs -->
                <div class="tabs" style="margin-bottom:20px">
                    <button class="tab active" id="ssa-tab-sub" onclick="ssaShowTab('sub')">ðŸ“¥ Submissions</button>
                    <button class="tab"        id="ssa-tab-lb"  onclick="ssaShowTab('lb')">ðŸ† Leaderboard</button>
                    <button class="tab"        id="ssa-tab-cfg" onclick="ssaShowTab('cfg')">âš™ï¸ Settings</button>
                </div>

                <!-- â”€â”€ Submissions â”€â”€ -->
                <div id="ssa-sub">
                    <div style="display:flex;gap:10px;margin-bottom:16px;flex-wrap:wrap">
                        <select id="ssaSubFilter" onchange="ssaLoadSubs()" style="flex:1;min-width:160px;padding:9px 12px;border-radius:8px;border:2px solid #ddd">
                            <option value="">All Difficulties</option>
                            <option value="easy">ðŸ˜Š 8-Puzzle</option>
                            <option value="medium">ðŸ˜… 15-Puzzle</option>
                            <option value="hard">ðŸ”¥ 24-Puzzle</option>
                        </select>
                        <select id="ssaSubStatus" onchange="ssaLoadSubs()" style="flex:1;min-width:160px;padding:9px 12px;border-radius:8px;border:2px solid #ddd">
                            <option value="">All Status</option>
                            <option value="pending">â³ Pending</option>
                            <option value="approved">âœ… Approved</option>
                            <option value="rejected">âŒ Rejected</option>
                        </select>
                        <button class="btn btn-small" onclick="ssaLoadSubs()">ðŸ”„ Refresh</button>
                        <button class="btn btn-small btn-success" onclick="ssaDownloadCSV()">ðŸ“¥ Download CSV</button>
                    </div>
                    <div id="ssaSubList">
                        <p style="color:#aaa;text-align:center;padding:30px">Click Refresh to load submissions.</p>
                    </div>
                </div>

                <!-- â”€â”€ Leaderboard â”€â”€ -->
                <div id="ssa-lb" style="display:none">
                    <div style="display:flex;gap:8px;margin-bottom:16px;flex-wrap:wrap">
                        <button class="tab active" id="ssalbt-easy"   onclick="ssaSwitchLB('easy')">ðŸ˜Š 8-Puzzle</button>
                        <button class="tab"        id="ssalbt-medium" onclick="ssaSwitchLB('medium')">ðŸ˜… 15-Puzzle</button>
                        <button class="tab"        id="ssalbt-hard"   onclick="ssaSwitchLB('hard')">ðŸ”¥ 24-Puzzle</button>
                        <button class="tab"        id="ssalbt-all"    onclick="ssaSwitchLB('all')">ðŸ“Š All</button>
                    </div>
                    <div id="ssaLbContainer">
                        <p style="color:#aaa;text-align:center;padding:30px">Loadingâ€¦</p>
                    </div>
                </div>

                <!-- â”€â”€ Settings â”€â”€ -->
                <div id="ssa-cfg" style="display:none">
                    <div style="background:#fff3cd;padding:18px;border-radius:10px;border-left:5px solid #ffc107;margin-bottom:20px">
                        <p style="color:#856404;margin:0;font-size:.9em"><strong>Note:</strong> These settings control what players see and can do in Speed Slide Challenge.</p>
                    </div>
                    <div class="form-group">
                        <label>Game Active? (players can play)</label>
                        <select id="ssaCfgActive" style="padding:10px;border-radius:8px;border:2px solid #ddd">
                            <option value="1">âœ… Yes â€” Game is ON</option>
                            <option value="0">âŒ No â€” Game is PAUSED</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Leaderboard visible to players?</label>
                        <select id="ssaCfgLbVisible" style="padding:10px;border-radius:8px;border:2px solid #ddd">
                            <option value="1">âœ… Yes â€” Visible</option>
                            <option value="0">âŒ No â€” Hidden</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Max submissions per player per day</label>
                        <input type="number" id="ssaCfgMaxSubs" value="3" min="1" max="99" style="padding:10px;border-radius:8px;border:2px solid #ddd;width:120px">
                    </div>
                    <button class="btn btn-success" onclick="ssaSaveCfg()">ðŸ’¾ Save Settings</button>
                    <span id="ssaCfgMsg" style="margin-left:12px;font-size:.9em;display:none"></span>

                    <hr style="margin:24px 0;border-color:#eee">
                    <h3 style="color:#f44336;margin-bottom:12px">ðŸ—‘ï¸ Danger Zone</h3>
                    <div style="display:flex;gap:10px;flex-wrap:wrap">
                        <button class="btn btn-danger btn-small" onclick="ssaClearAllScores()">ðŸ—‘ï¸ Clear All Scores</button>
                        <button class="btn btn-danger btn-small" onclick="ssaClearAllImages()">ðŸ—‘ï¸ Clear Images (Firebase Storage)</button>
                    </div>
                </div>

                <!-- Lightbox for submission images -->
                <div id="ssaLightbox" onclick="this.style.display='none'" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.9);z-index:99999;align-items:center;justify-content:center;cursor:zoom-out">
                    <img id="ssaLightboxImg" style="max-width:94vw;max-height:90vh;border-radius:12px" alt="">
                </div>
            </div>
            <!-- ================================================ -->
            <!-- END SPEED SLIDE ADMIN PANEL                      -->
            <!-- ================================================ -->

            <!-- ================================================ -->
            <!-- ðŸ“„ PDF HANDOUTS ADMIN PANEL (Super Admin Only)   -->
            <!-- ================================================ -->
            <div id="pdfHandoutsAdmin" class="form-section super-admin-only" style="margin-top:20px">
                <h2 style="color:#c44569;margin-bottom:6px">ðŸ“„ PDF Handouts â€” Admin Panel</h2>
                <p style="color:#888;margin-bottom:20px;font-size:.9em">Upload event-related PDF handouts. Each PDF will appear as a download button on the public page for students.</p>

                <!-- Upload form -->
                <div style="background:#f3e5f5;border-radius:12px;padding:22px;border:2px solid #ce93d8;margin-bottom:24px;">
                    <h3 style="color:#6a1b9a;margin-bottom:14px;font-size:1em;">âž• Upload New Handout</h3>
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-bottom:14px;">
                        <div>
                            <label style="font-size:.88em;font-weight:600;color:#4a148c;display:block;margin-bottom:5px">Event Name / Label *</label>
                            <input type="text" id="pdfLabel" placeholder="e.g. Mime â€” Event Handout" style="width:100%;padding:9px 12px;border-radius:8px;border:2px solid #ce93d8;font-size:.92em">
                        </div>
                        <div>
                            <label style="font-size:.88em;font-weight:600;color:#4a148c;display:block;margin-bottom:5px">Uploaded By (Faculty Name) *</label>
                            <input type="text" id="pdfUploader" placeholder="e.g. Priyanka V" style="width:100%;padding:9px 12px;border-radius:8px;border:2px solid #ce93d8;font-size:.92em">
                        </div>
                    </div>
                    <div style="margin-bottom:14px;">
                        <label style="font-size:.88em;font-weight:600;color:#4a148c;display:block;margin-bottom:5px">Select PDF File *</label>
                        <div id="pdfDropZone" onclick="document.getElementById('pdfFileInput').click()"
                             style="border:2.5px dashed #9c27b0;border-radius:10px;padding:28px;text-align:center;cursor:pointer;background:white;transition:all .2s">
                            <div style="font-size:2em;margin-bottom:6px">ðŸ“„</div>
                            <p style="color:#6a1b9a;font-weight:600;margin:0 0 4px">Click to choose a PDF</p>
                            <p style="color:#aaa;font-size:.82em;margin:0" id="pdfFileName">No file selected</p>
                        </div>
                        <input type="file" id="pdfFileInput" accept=".pdf" style="display:none" onchange="pdfOnFileChange(this)">
                    </div>
                    <div style="display:flex;align-items:center;gap:12px;flex-wrap:wrap">
                        <button class="btn btn-success" onclick="pdfUploadHandout()" id="pdfUploadBtn">â˜ï¸ Upload to Cloud &amp; Publish</button>
                        <span id="pdfUploadMsg" style="font-size:.9em;display:none"></span>
                    </div>
                    <div id="pdfUploadProgress" style="display:none;margin-top:12px">
                        <div style="background:#e0e0e0;border-radius:10px;height:8px;overflow:hidden">
                            <div id="pdfUploadBar" style="background:linear-gradient(90deg,#6a1b9a,#c44569);height:100%;width:0%;transition:width .3s ease;border-radius:10px"></div>
                        </div>
                        <p id="pdfUploadProgressLabel" style="font-size:.8em;color:#888;margin-top:4px;text-align:center">Uploadingâ€¦</p>
                    </div>
                </div>

                <!-- Existing handouts list -->
                <div>
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;flex-wrap:wrap;gap:8px">
                        <h3 style="color:#6a1b9a;font-size:1em;margin:0">ðŸ“‹ Published Handouts</h3>
                        <button class="btn btn-small" onclick="pdfLoadHandouts()">ðŸ”„ Refresh</button>
                    </div>
                    <div id="pdfHandoutsList">
                        <p style="color:#aaa;text-align:center;padding:24px">Click Refresh to load published handouts.</p>
                    </div>
                </div>
            </div>
            <!-- ================================================ -->
            <!-- END PDF HANDOUTS ADMIN PANEL                     -->
            <!-- ================================================ -->

            <!-- ================================================ -->
            <!-- ðŸ’³ PAYMENT APPROVAL ADMIN PANEL (Super Admin)   -->
            <!-- ================================================ -->
            <div id="paymentApprovalAdmin" class="form-section super-admin-only" style="margin-top:20px">
                <h2 style="color:#c44569;margin-bottom:6px">ðŸ’³ Payment Approval â€” Admin Panel</h2>
                <p style="color:#888;margin-bottom:14px;font-size:.9em">Each <strong>class</strong> registers as a group and pays â‚¹1,500. Coordinators verify the payment in person, then approve the entire class here.</p>

                <!-- How it works -->
                <div style="background:#e8f5e9;border:2px solid #4caf50;border-radius:12px;padding:18px;margin-bottom:20px;">
                    <p style="margin:0 0 10px;font-weight:700;color:#1b5e20;font-size:.95em">âœ… How Payment Approval Works (Per Class)</p>
                    <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(190px,1fr));gap:10px;">
                        <div style="background:white;border-radius:8px;padding:12px;border-left:4px solid #ffa000;">
                            <div style="font-size:1.3em;margin-bottom:4px">1ï¸âƒ£</div>
                            <p style="margin:0;font-size:.85em;color:#333"><strong>All students of a class register</strong> â€” their class appears here as <span style="background:#fff8e1;color:#f57f17;padding:1px 8px;border-radius:8px;font-size:.85em">â³ Pending</span></p>
                        </div>
                        <div style="background:white;border-radius:8px;padding:12px;border-left:4px solid #2196f3;">
                            <div style="font-size:1.3em;margin-bottom:4px">2ï¸âƒ£</div>
                            <p style="margin:0;font-size:.85em;color:#333"><strong>Class representative pays â‚¹1,500 cash</strong> to <strong>Lalitha S K</strong> or <strong>Priyanka V</strong> on behalf of the class</p>
                        </div>
                        <div style="background:white;border-radius:8px;padding:12px;border-left:4px solid #4caf50;">
                            <div style="font-size:1.3em;margin-bottom:4px">3ï¸âƒ£</div>
                            <p style="margin:0;font-size:.85em;color:#333"><strong>Coordinator (Lalitha S K / Priyanka V) opens this website</strong> â†’ selects <strong>Manager</strong> login â†’ enters manager password â†’ goes to <strong>"ðŸ’³ Payment Approval"</strong> tab â†’ finds the class â†’ clicks <span style="background:#e8f5e9;color:#1b5e20;padding:1px 8px;border-radius:8px;font-size:.85em;font-weight:700">âœ… Approve</span></p>
                        </div>
                        <div style="background:white;border-radius:8px;padding:12px;border-left:4px solid #9c27b0;">
                            <div style="font-size:1.3em;margin-bottom:4px">4ï¸âƒ£</div>
                            <p style="margin:0;font-size:.85em;color:#333"><strong>Class status updates to âœ… Approved in Firebase.</strong> This is a <em>record-keeping step only</em> â€” it marks the class as having paid, so coordinators can track which classes have paid and which haven't. It does <strong>not</strong> automatically block or allow student registrations (students have already registered via the enrollment form). Use this panel as your <strong>payment receipt log</strong>.</p>
                        </div>
                    </div>
                    <p style="margin:10px 0 0;font-size:.82em;color:#388e3c">ðŸ’¡ <strong>Tip:</strong> Use the search box to quickly find a class name. Use <strong>"âŒ Reject"</strong> if payment was not received.</p>
                </div>
                <!-- Stats bar -->
                <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-bottom:20px;">
                    <div style="background:linear-gradient(135deg,#fff8e1,#ffe082);border-radius:10px;padding:14px;text-align:center;border:2px solid #ffc107">
                        <div style="font-size:1.8em;font-weight:800;color:#f57f17" id="paStatPending">â€”</div>
                        <div style="font-size:.8em;color:#795548;font-weight:600">â³ Pending</div>
                    </div>
                    <div style="background:linear-gradient(135deg,#e8f5e9,#a5d6a7);border-radius:10px;padding:14px;text-align:center;border:2px solid #4caf50">
                        <div style="font-size:1.8em;font-weight:800;color:#1b5e20" id="paStatApproved">â€”</div>
                        <div style="font-size:.8em;color:#388e3c;font-weight:600">âœ… Approved</div>
                    </div>
                    <div style="background:linear-gradient(135deg,#fce4ec,#f48fb1);border-radius:10px;padding:14px;text-align:center;border:2px solid #e91e63">
                        <div style="font-size:1.8em;font-weight:800;color:#880e4f" id="paStatRejected">â€”</div>
                        <div style="font-size:.8em;color:#c2185b;font-weight:600">âŒ Rejected</div>
                    </div>
                </div>

                <!-- Filters + Register new button -->
                <div style="display:flex;gap:10px;flex-wrap:wrap;margin-bottom:16px;align-items:center">
                    <select id="paFilterStatus" onchange="paLoadPending()" style="padding:9px 12px;border-radius:8px;border:2px solid #ddd;flex:1;min-width:140px">
                        <option value="">All Status</option>
                        <option value="pending" selected>â³ Pending</option>
                        <option value="approved">âœ… Approved</option>
                        <option value="rejected">âŒ Rejected</option>
                    </select>
                    <input type="text" id="paSearch" placeholder="ðŸ” Search by name / class..." onkeyup="paLoadPending()" style="padding:9px 12px;border-radius:8px;border:2px solid #ddd;flex:2;min-width:180px">
                    <button class="btn btn-small" onclick="paLoadPending()">ðŸ”„ Refresh</button>
                    <button class="btn btn-small btn-success" onclick="paDownloadCSV()">ðŸ“¥ CSV</button>
                </div>

                <div id="paRegistrationList">
                    <p style="color:#aaa;text-align:center;padding:24px">Loading registrationsâ€¦</p>
                </div>

                <!-- Manual Class Entry form -->
                <div style="background:#e8f5e9;border-radius:12px;padding:20px;border:2px solid #4caf50;margin-top:24px">
                    <h3 style="color:#1b5e20;margin-bottom:12px;font-size:1em">âž• Manually Add Class Registration (Admin Entry)</h3>
                    <p style="font-size:.83em;color:#388e3c;margin-bottom:12px">Use this if a class paid in person and you want to record &amp; approve them directly.</p>
                    <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;margin-bottom:12px;flex-wrap:wrap">
                        <select id="paManualName" style="padding:9px 12px;border-radius:8px;border:2px solid #a5d6a7">
                            <option value="">Select Class *</option>
                        </select>
                        <input type="text" id="paManualPhone" placeholder="Captain / Rep Phone *" style="padding:9px 12px;border-radius:8px;border:2px solid #a5d6a7">
                        <input type="text" id="paManualClass" placeholder="No. of students in class *" style="padding:9px 12px;border-radius:8px;border:2px solid #a5d6a7">
                    </div>
                    <div style="display:flex;gap:10px;flex-wrap:wrap">
                        <select id="paManualStatus" style="padding:9px 12px;border-radius:8px;border:2px solid #a5d6a7">
                            <option value="approved">âœ… Approved (â‚¹1,500 received)</option>
                            <option value="pending">â³ Pending (not yet paid)</option>
                        </select>
                        <input type="text" id="paManualNote" placeholder="Note (optional)" style="padding:9px 12px;border-radius:8px;border:2px solid #a5d6a7;flex:1">
                        <button class="btn btn-success" onclick="paManualAdd()">âž• Add Class</button>
                    </div>
                </div>
            </div>
            <!-- ================================================ -->
            <!-- END PAYMENT APPROVAL ADMIN PANEL                 -->
            <!-- ================================================ -->

            <!-- ================================================ -->
            <!-- ðŸ“… EVENT SCHEDULE ADMIN PANEL (Super Admin)      -->
            <!-- ================================================ -->
            <div id="eventScheduleAdmin" class="form-section super-admin-only" style="margin-top:20px">
                <h2 style="color:#c44569;margin-bottom:6px">ðŸ“… Event Schedule â€” Admin Panel</h2>
                <p style="color:#888;margin-bottom:20px;font-size:.9em">Add, edit or delete events in the Spurthi Youth Festival schedule. Changes are saved to Firebase and appear instantly on the public page.</p>

                <!-- Add / Edit form -->
                <div style="background:#e3f2fd;border-radius:12px;padding:22px;border:2px solid #90caf9;margin-bottom:24px;">
                    <h3 style="color:#0d47a1;margin-bottom:14px;font-size:1em" id="esFormTitle">âž• Add New Event</h3>
                    <input type="hidden" id="esEditId" value="">
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:12px;">
                        <div>
                            <label style="font-size:.85em;font-weight:600;color:#0d47a1;display:block;margin-bottom:4px">Event Name *</label>
                            <input type="text" id="esName" list="esNameOptions" placeholder="Select from list or type custom nameâ€¦" style="width:100%;padding:9px 12px;border-radius:8px;border:2px solid #90caf9" oninput="esToggleCustomName(this.value)">
                            <datalist id="esNameOptions">
                                <option value="Mime">
                                <option value="Social Awareness Skit">
                                <option value="Group Dance">
                                <option value="Mad Ads">
                                <option value="Ramp Walk">
                                <option value="Pod Casting">
                                <option value="Nukkad Natak">
                                <option value="Talent Hunt">
                                <option value="YouTube Advertisement">
                                <option value="Case Analysis">
                                <option value="Interdisciplinary">
                                <option value="Quiz">
                                <option value="Vlog">
                                <option value="Hand Writing">
                                <option value="Best Out of Waste">
                                <option value="âž• Add Custom Eventâ€¦">
                            </datalist>
                            <!-- Custom event name input â€” shown when admin picks "Add Custom" -->
                            <div id="esCustomNameWrap" style="display:none;margin-top:8px">
                                <input type="text" id="esCustomName" placeholder="Type your custom event name hereâ€¦" style="width:100%;padding:9px 12px;border-radius:8px;border:2px solid #f9a825;background:#fffde7;font-weight:600">
                                <p style="color:#f57f17;font-size:.75em;margin:4px 0 0">âœï¸ This custom name will be saved as the event name</p>
                            </div>
                        </div>
                        <div>
                            <label style="font-size:.85em;font-weight:600;color:#0d47a1;display:block;margin-bottom:4px">On Stage / Off Stage *</label>
                            <select id="esStageType" style="width:100%;padding:9px 12px;border-radius:8px;border:2px solid #90caf9">
                                <option value="On stage">ðŸŽ­ On stage</option>
                                <option value="Off stage">ðŸ“‹ Off stage</option>
                            </select>
                        </div>
                        <div>
                            <label style="font-size:.85em;font-weight:600;color:#0d47a1;display:block;margin-bottom:4px">Class</label>
                            <input type="text" id="esClass" placeholder="e.g. I BCA / II BCA 'B'" style="width:100%;padding:9px 12px;border-radius:8px;border:2px solid #90caf9">
                        </div>
                        <div>
                            <label style="font-size:.85em;font-weight:600;color:#0d47a1;display:block;margin-bottom:4px">In-charge</label>
                            <input type="text" id="esIncharge" placeholder="e.g. Priyanka V / Kotrappa K" style="width:100%;padding:9px 12px;border-radius:8px;border:2px solid #90caf9">
                        </div>
                        <div>
                            <label style="font-size:.85em;font-weight:600;color:#0d47a1;display:block;margin-bottom:4px">I Meeting Timings</label>
                            <input type="text" id="esMeeting1" placeholder="e.g. Feb 24th at 1:00â€“1:15 pm" style="width:100%;padding:9px 12px;border-radius:8px;border:2px solid #90caf9">
                        </div>
                        <div>
                            <label style="font-size:.85em;font-weight:600;color:#0d47a1;display:block;margin-bottom:4px">II Meeting Timings</label>
                            <input type="text" id="esMeeting2" placeholder="e.g. March 4th at 1:00â€“1:15 pm" style="width:100%;padding:9px 12px;border-radius:8px;border:2px solid #90caf9">
                        </div>
                        <div>
                            <label style="font-size:.85em;font-weight:600;color:#0d47a1;display:block;margin-bottom:4px">Event Start Date</label>
                            <input type="text" id="esStartDate" placeholder="e.g. 02-03-2026 (or leave blank)" style="width:100%;padding:9px 12px;border-radius:8px;border:2px solid #90caf9">
                        </div>
                        <div>
                            <label style="font-size:.85em;font-weight:600;color:#0d47a1;display:block;margin-bottom:4px">Event End Date</label>
                            <input type="text" id="esEndDate" placeholder="e.g. 07-03-2026 (or leave blank)" style="width:100%;padding:9px 12px;border-radius:8px;border:2px solid #90caf9">
                        </div>
                        <div>
                            <label style="font-size:.85em;font-weight:600;color:#0d47a1;display:block;margin-bottom:4px">Event Start Time</label>
                            <input type="text" id="esStartTime" placeholder="e.g. 10:00 am (or leave blank)" style="width:100%;padding:9px 12px;border-radius:8px;border:2px solid #90caf9">
                        </div>
                        <div>
                            <label style="font-size:.85em;font-weight:600;color:#0d47a1;display:block;margin-bottom:4px">Event End Time</label>
                            <input type="text" id="esEndTime" placeholder="e.g. 04:00 pm (or leave blank)" style="width:100%;padding:9px 12px;border-radius:8px;border:2px solid #90caf9">
                        </div>
                    </div>
                    <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center">
                        <button class="btn btn-success" onclick="esSaveEvent()">ðŸ’¾ Save Event</button>
                        <button class="btn btn-small" onclick="esClearForm()" style="background:#eee;color:#555">âœ– Clear</button>
                        <span id="esFormMsg" style="font-size:.9em;display:none"></span>
                    </div>
                </div>

                <!-- Events list table -->
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;flex-wrap:wrap;gap:8px">
                    <h3 style="color:#0d47a1;font-size:1em;margin:0">ðŸ“‹ Current Event Schedule</h3>
                    <div style="display:flex;gap:8px;flex-wrap:wrap">
                        <button class="btn btn-small" onclick="esLoadEvents()">ðŸ”„ Refresh</button>
                        <button class="btn btn-small btn-success" onclick="esSeedDefaults()" title="Clears all events and reloads the 15 default events">ðŸŒ± Reset to Default 15 Events</button>
                    </div>
                </div>
                <div style="overflow-x:auto;border-radius:10px;box-shadow:0 2px 10px rgba(0,0,0,.08)">
                    <div id="esAdminTableWrap">
                        <p style="color:#aaa;text-align:center;padding:24px">Loading eventsâ€¦</p>
                    </div>
                </div>
            </div>
            <!-- ================================================ -->
            <!-- END EVENT SCHEDULE ADMIN PANEL                   -->
            <!-- ================================================ -->

            <!-- ================================================ -->
            <!-- ALL EVENTS OVERVIEW PANEL (Super Admin Only)     -->
            <!-- ================================================ -->
            <div id="allEventsOverview" class="form-section super-admin-only" style="margin-top:20px">
                <!-- Header -->
                <div style="background:linear-gradient(135deg,#4a148c,#7b1fa2);border-radius:14px;padding:20px 24px;margin-bottom:20px;color:white;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:12px">
                    <div>
                        <h2 style="margin:0 0 4px;font-size:1.25em">ðŸ“Š All Events Submissions â€” Overview</h2>
                        <p style="margin:0;opacity:0.85;font-size:0.85em">Live enrollment &amp; submission status for every event Â· Filter by event or class Â· Spot missing classes instantly</p>
                    </div>
                    <button onclick="loadAllEventsOverview()" style="background:rgba(255,255,255,0.15);color:white;border:2px solid rgba(255,255,255,0.4);border-radius:8px;padding:9px 18px;font-size:0.88em;font-weight:700;cursor:pointer">ðŸ”„ Refresh</button>
                </div>

                <!-- Summary Stats -->
                <div id="aeoStats" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(130px,1fr));gap:12px;margin-bottom:12px">
                    <div style="background:white;border-radius:10px;padding:14px;text-align:center;box-shadow:0 2px 8px rgba(0,0,0,0.07);border-top:3px solid #7b1fa2">
                        <div id="aeoStatEvents" style="font-size:1.8em;font-weight:900;color:#7b1fa2">â€”</div>
                        <div style="color:#888;font-size:0.76em;font-weight:600">Total Events</div>
                    </div>
                    <div style="background:white;border-radius:10px;padding:14px;text-align:center;box-shadow:0 2px 8px rgba(0,0,0,0.07);border-top:3px solid #1565c0">
                        <div id="aeoStatEnrolled" style="font-size:1.8em;font-weight:900;color:#1565c0">â€”</div>
                        <div style="color:#888;font-size:0.76em;font-weight:600">Total Registrations</div>
                    </div>
                    <div style="background:white;border-radius:10px;padding:14px;text-align:center;box-shadow:0 2px 8px rgba(0,0,0,0.07);border-top:3px solid #2e7d32">
                        <div id="aeoStatDone" style="font-size:1.8em;font-weight:900;color:#2e7d32">â€”</div>
                        <div style="color:#888;font-size:0.76em;font-weight:600">Events w/ Enrollments</div>
                    </div>
                    <div style="background:white;border-radius:10px;padding:14px;text-align:center;box-shadow:0 2px 8px rgba(0,0,0,0.07);border-top:3px solid #f44336">
                        <div id="aeoStatPending" style="font-size:1.8em;font-weight:900;color:#f44336">â€”</div>
                        <div style="color:#888;font-size:0.76em;font-weight:600">Not Yet Enrolled</div>
                    </div>
                </div>

                <!-- Diagnostic Strip (shown after load) -->
                <div id="aeoDiagStrip" style="display:none;background:#f8f9fa;border:1px solid #dee2e6;border-radius:8px;padding:8px 14px;margin-bottom:14px;font-size:0.82em;color:#555;flex-wrap:wrap;line-height:2"></div>

                <!-- Filters -->
                <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-bottom:16px;background:white;border-radius:10px;padding:12px 16px;box-shadow:0 2px 8px rgba(0,0,0,0.06)">
                    <span style="font-size:0.85em;font-weight:700;color:#555">ðŸ” Filter:</span>
                    <select id="aeoEventFilter" onchange="aeoApplyFilter()" style="padding:7px 12px;border:2px solid #ce93d8;border-radius:8px;font-size:0.85em;outline:none;background:white;font-weight:600;color:#333;cursor:pointer;min-width:180px">
                        <option value="">All Events</option>
                    </select>
                    <select id="aeoClassFilter" onchange="aeoApplyFilter()" style="padding:7px 12px;border:2px solid #90caf9;border-radius:8px;font-size:0.85em;outline:none;background:white;font-weight:600;color:#333;cursor:pointer;min-width:160px">
                        <option value="">All Classes</option>
                    </select>
                    <select id="aeoStatusFilter" onchange="aeoApplyFilter()" style="padding:7px 12px;border:2px solid #a5d6a7;border-radius:8px;font-size:0.85em;outline:none;background:white;font-weight:600;color:#333;cursor:pointer">
                        <option value="">All Statuses</option>
                        <option value="enrolled">âœ… Enrolled Only</option>
                        <option value="not_enrolled">âš ï¸ Not Enrolled</option>
                    </select>
                    <button onclick="document.getElementById('aeoEventFilter').value='';document.getElementById('aeoClassFilter').value='';document.getElementById('aeoStatusFilter').value='';aeoApplyFilter()"
                            style="background:#eee;border:none;border-radius:8px;padding:7px 14px;font-size:0.82em;font-weight:700;cursor:pointer;color:#555">âœ• Clear</button>
                    <span id="aeoFilterBadge" style="margin-left:auto;background:#e8eaf6;color:#4a148c;padding:4px 14px;border-radius:20px;font-size:0.8em;font-weight:700"></span>
                </div>

                <!-- Main Table -->
                <div style="background:white;border-radius:12px;box-shadow:0 2px 10px rgba(0,0,0,0.08);overflow:hidden">
                    <div id="aeoTableWrap" style="overflow-x:auto">
                        <div style="padding:40px;text-align:center;color:#aaa">Click Refresh to load all event submissions.</div>
                    </div>
                </div>
            </div>
            <!-- ================================================ -->
            <!-- END ALL EVENTS OVERVIEW PANEL                    -->
            <!-- ================================================ -->

            <!-- ================================================ -->
            <!-- SITE SETTINGS PANEL                              -->
            <!-- ================================================ -->
            <div id="siteSettingsPanel" class="form-section super-admin-only" style="margin-top:20px">
                <div style="background:linear-gradient(135deg,#1a237e,#283593);border-radius:14px;padding:20px 24px;margin-bottom:24px;color:white;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:12px">
                    <div>
                        <h2 style="margin:0 0 4px;font-size:1.25em">âš™ï¸ Site Settings â€” Dynamic Controls</h2>
                        <p style="margin:0;opacity:0.85;font-size:0.85em">Control the announcement banner and WhatsApp share text live â€” no code edits needed</p>
                    </div>
                    <button onclick="loadSiteSettings()" style="background:rgba(255,255,255,0.15);color:white;border:2px solid rgba(255,255,255,0.4);border-radius:8px;padding:9px 18px;font-size:0.88em;font-weight:700;cursor:pointer">ðŸ”„ Reload</button>
                </div>
                <div id="siteSettingsMsg" style="margin-bottom:16px"></div>

                <!-- â”€â”€ ANNOUNCEMENT BANNER SECTION â”€â”€ -->
                <div style="background:white;border-radius:14px;padding:22px 24px;margin-bottom:20px;box-shadow:0 2px 10px rgba(0,0,0,0.08);border-top:4px solid #e8722a">
                    <h3 style="color:#e8722a;margin:0 0 6px;font-size:1.1em">ðŸ“¢ Announcement Banner</h3>
                    <p style="color:#888;font-size:0.85em;margin:0 0 18px">This is the orange banner at the top of the public page. Edit and save to update it instantly for all visitors.</p>

                    <!-- Visibility -->
                    <div style="display:flex;align-items:center;gap:12px;margin-bottom:16px;background:#fff8f0;padding:12px 16px;border-radius:10px;border:2px solid #ffd0a0">
                        <label style="font-weight:700;color:#555;white-space:nowrap;font-size:0.9em">Banner Visibility:</label>
                        <label style="display:flex;align-items:center;gap:7px;cursor:pointer;background:white;padding:8px 18px;border-radius:20px;border:2px solid #4caf50;font-weight:700;color:#2e7d32">
                            <input type="radio" name="bannerVisible" value="show" id="bannerShow" style="accent-color:#4caf50"> âœ… Show Banner
                        </label>
                        <label style="display:flex;align-items:center;gap:7px;cursor:pointer;background:white;padding:8px 18px;border-radius:20px;border:2px solid #f44336;font-weight:700;color:#c62828">
                            <input type="radio" name="bannerVisible" value="hide" id="bannerHide" style="accent-color:#f44336"> âŒ Hide Banner
                        </label>
                    </div>

                    <!-- Banner Text -->
                    <div style="margin-bottom:14px">
                        <label style="font-weight:700;color:#555;font-size:0.9em;display:block;margin-bottom:6px">Banner Text:</label>
                        <input type="text" id="ssBannerText" placeholder="e.g. ðŸŽ¯ Speed Slide Challenge is LIVE now! ðŸŽ¯" style="width:100%;padding:12px 14px;border:2px solid #ffb74d;border-radius:10px;font-size:1em;box-sizing:border-box;outline:none;font-weight:600">
                        <small style="color:#888;margin-top:4px;display:block">Tip: Use emojis to make it more eye-catching! âœ¨</small>
                    </div>

                    <!-- Font Style & Size -->
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-bottom:16px">
                        <div>
                            <label style="font-weight:700;color:#555;font-size:0.9em;display:block;margin-bottom:8px">ðŸ”¤ Font Style:</label>
                            <select id="ssBannerFont" style="width:100%;padding:10px 12px;border:2px solid #ffb74d;border-radius:10px;font-size:0.95em;outline:none;background:white;cursor:pointer">
                                <option value="'Segoe UI',sans-serif">Segoe UI (Default)</option>
                                <option value="Arial,sans-serif">Arial</option>
                                <option value="'Times New Roman',serif">Times New Roman</option>
                                <option value="Georgia,serif">Georgia</option>
                                <option value="'Courier New',monospace">Courier New</option>
                                <option value="Verdana,sans-serif">Verdana</option>
                                <option value="Impact,sans-serif">Impact (Bold)</option>
                                <option value="'Comic Sans MS',cursive">Comic Sans</option>
                                <option value="Tahoma,sans-serif">Tahoma</option>
                                <option value="'Trebuchet MS',sans-serif">Trebuchet MS</option>
                            </select>
                        </div>
                        <div>
                            <label style="font-weight:700;color:#555;font-size:0.9em;display:block;margin-bottom:8px">ðŸ“ Font Size:</label>
                            <div style="display:flex;align-items:center;gap:10px">
                                <input type="range" id="ssBannerFontSize" min="12" max="36" value="18" oninput="document.getElementById('ssBannerFontSizeVal').textContent=this.value+'px'" style="flex:1;accent-color:#e8722a">
                                <span id="ssBannerFontSizeVal" style="background:#fff3e0;color:#e8722a;padding:4px 10px;border-radius:8px;font-weight:700;font-size:0.9em;min-width:42px;text-align:center">18px</span>
                            </div>
                            <div style="display:flex;gap:6px;margin-top:8px;flex-wrap:wrap">
                                <button onclick="document.getElementById('ssBannerFontSize').value=14;document.getElementById('ssBannerFontSizeVal').textContent='14px'" style="background:#f5f5f5;border:1px solid #ddd;border-radius:6px;padding:3px 10px;cursor:pointer;font-size:0.8em;font-weight:600">S</button>
                                <button onclick="document.getElementById('ssBannerFontSize').value=18;document.getElementById('ssBannerFontSizeVal').textContent='18px'" style="background:#f5f5f5;border:1px solid #ddd;border-radius:6px;padding:3px 10px;cursor:pointer;font-size:0.85em;font-weight:600">M</button>
                                <button onclick="document.getElementById('ssBannerFontSize').value=22;document.getElementById('ssBannerFontSizeVal').textContent='22px'" style="background:#f5f5f5;border:1px solid #ddd;border-radius:6px;padding:3px 10px;cursor:pointer;font-size:0.9em;font-weight:600">L</button>
                                <button onclick="document.getElementById('ssBannerFontSize').value=28;document.getElementById('ssBannerFontSizeVal').textContent='28px'" style="background:#f5f5f5;border:1px solid #ddd;border-radius:6px;padding:3px 10px;cursor:pointer;font-size:1em;font-weight:700">XL</button>
                            </div>
                        </div>
                    </div>

                    <!-- Color Theme -->
                    <div style="margin-bottom:18px">
                        <label style="font-weight:700;color:#555;font-size:0.9em;display:block;margin-bottom:8px">Banner Color Theme:</label>
                        <div style="display:flex;gap:10px;flex-wrap:wrap">
                            <label style="cursor:pointer;display:flex;align-items:center;gap:6px"><input type="radio" name="bannerColor" value="orange" id="bColorOrange" style="accent-color:#e8722a"> <span style="background:linear-gradient(90deg,#e8722a,#f0a05a);color:white;padding:5px 14px;border-radius:20px;font-weight:700;font-size:0.85em">ðŸŸ  Orange</span></label>
                            <label style="cursor:pointer;display:flex;align-items:center;gap:6px"><input type="radio" name="bannerColor" value="purple" id="bColorPurple" style="accent-color:#6a1b9a"> <span style="background:linear-gradient(90deg,#6a1b9a,#c44569);color:white;padding:5px 14px;border-radius:20px;font-weight:700;font-size:0.85em">ðŸŸ£ Purple</span></label>
                            <label style="cursor:pointer;display:flex;align-items:center;gap:6px"><input type="radio" name="bannerColor" value="green" id="bColorGreen" style="accent-color:#2e7d32"> <span style="background:linear-gradient(90deg,#2e7d32,#66bb6a);color:white;padding:5px 14px;border-radius:20px;font-weight:700;font-size:0.85em">ðŸŸ¢ Green</span></label>
                            <label style="cursor:pointer;display:flex;align-items:center;gap:6px"><input type="radio" name="bannerColor" value="red" id="bColorRed" style="accent-color:#c62828"> <span style="background:linear-gradient(90deg,#c62828,#ef5350);color:white;padding:5px 14px;border-radius:20px;font-weight:700;font-size:0.85em">ðŸ”´ Red</span></label>
                            <label style="cursor:pointer;display:flex;align-items:center;gap:6px"><input type="radio" name="bannerColor" value="blue" id="bColorBlue" style="accent-color:#1565c0"> <span style="background:linear-gradient(90deg,#1565c0,#42a5f5);color:white;padding:5px 14px;border-radius:20px;font-weight:700;font-size:0.85em">ðŸ”µ Blue</span></label>
                            <label style="cursor:pointer;display:flex;align-items:center;gap:6px"><input type="radio" name="bannerColor" value="gold" id="bColorGold" style="accent-color:#f9a825"> <span style="background:linear-gradient(90deg,#f9a825,#ffd54f);color:#5d4037;padding:5px 14px;border-radius:20px;font-weight:700;font-size:0.85em">ðŸŸ¡ Gold</span></label>
                        </div>
                    </div>

                    <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap">
                        <button onclick="saveBannerSettings()" style="background:linear-gradient(135deg,#e8722a,#f0a05a);color:white;border:none;border-radius:10px;padding:12px 28px;font-size:1em;font-weight:700;cursor:pointer;box-shadow:0 3px 10px rgba(232,114,42,0.4)">ðŸ’¾ Save Banner Settings</button>
                        <button onclick="previewBanner()" style="background:white;color:#e8722a;border:2px solid #e8722a;border-radius:10px;padding:12px 20px;font-size:1em;font-weight:700;cursor:pointer">ðŸ‘ï¸ Preview Live</button>
                        <span id="bannerSaveToast" style="display:none;background:#d4edda;color:#155724;padding:10px 18px;border-radius:10px;font-weight:700;font-size:0.9em;border:2px solid #c3e6cb;animation:slideInUp 0.3s ease">âœ… Saved successfully!</span>
                    </div>
                </div>

                <!-- â”€â”€ WHATSAPP SHARE TEXT SECTION â”€â”€ -->
                <div style="background:white;border-radius:14px;padding:22px 24px;margin-bottom:20px;box-shadow:0 2px 10px rgba(0,0,0,0.08);border-top:4px solid #25d366">
                    <h3 style="color:#1b5e20;margin:0 0 6px;font-size:1.1em">ðŸ“± WhatsApp Share Text</h3>
                    <div style="background:#e8f5e9;border-radius:8px;padding:10px 14px;margin-bottom:14px;border-left:4px solid #25d366">
                        <p style="margin:0;color:#2e7d32;font-size:0.85em"><strong>âš ï¸ Note:</strong> WhatsApp <strong>caches</strong> link previews for hours. New shares will show updated text immediately, but old cached previews may take time to refresh. This text is also shown as a visible info box on the public page.</p>
                    </div>
                    <div style="margin-bottom:14px">
                        <label style="font-weight:700;color:#555;font-size:0.9em;display:block;margin-bottom:6px">Share Description Text:</label>
                        <textarea id="ssWhatsappText" rows="3" placeholder="e.g. ðŸŽ“ Join our exciting Daily Quiz Competition! Answer 2 questions daily and win prizes. Register now!" style="width:100%;padding:12px 14px;border:2px solid #a5d6a7;border-radius:10px;font-size:0.95em;box-sizing:border-box;outline:none;resize:vertical"></textarea>
                        <small style="color:#888;margin-top:4px;display:block">This text appears in WhatsApp link previews and on the public page info banner.</small>
                    </div>
                    <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap">
                        <button onclick="saveWhatsappText()" style="background:linear-gradient(135deg,#25d366,#128c7e);color:white;border:none;border-radius:10px;padding:12px 28px;font-size:1em;font-weight:700;cursor:pointer;box-shadow:0 3px 10px rgba(37,211,102,0.4)">ðŸ’¾ Save WhatsApp Text</button>
                        <button onclick="copyWhatsappShareLink()" style="background:white;color:#25d366;border:2px solid #25d366;border-radius:10px;padding:12px 20px;font-size:1em;font-weight:700;cursor:pointer">ðŸ“‹ Copy Share Link</button>
                        <span id="waSaveToast" style="display:none;background:#d4edda;color:#155724;padding:10px 18px;border-radius:10px;font-weight:700;font-size:0.9em;border:2px solid #c3e6cb;animation:slideInUp 0.3s ease">âœ… Saved successfully!</span>
                    </div>
                </div>
            </div>
            <!-- ================================================ -->
            <!-- END SITE SETTINGS PANEL                          -->
            <!-- ================================================ -->

            <!-- ================================================ -->
            <!-- FEEDBACK ADMIN PANEL                             -->
            <!-- ================================================ -->
            <div id="feedbackAdminPanel" class="form-section super-admin-only" style="margin-top:20px">
                <div style="background:linear-gradient(135deg,#880e4f,#c2185b);border-radius:14px;padding:20px 24px;margin-bottom:24px;color:white;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:12px">
                    <div>
                        <h2 style="margin:0 0 4px;font-size:1.25em">ðŸ“‹ Feedback Form â€” Admin Control</h2>
                        <p style="margin:0;opacity:0.85;font-size:0.85em">Trigger the feedback popup for all visitors Â· Select events to rate Â· View all responses</p>
                    </div>
                    <button onclick="loadFeedbackAdmin()" style="background:rgba(255,255,255,0.15);color:white;border:2px solid rgba(255,255,255,0.4);border-radius:8px;padding:9px 18px;font-size:0.88em;font-weight:700;cursor:pointer">ðŸ”„ Refresh</button>
                </div>
                <div id="feedbackAdminMsg" style="margin-bottom:16px"></div>

                <!-- Stats -->
                <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:12px;margin-bottom:20px">
                    <div style="background:white;border-radius:12px;padding:16px;text-align:center;box-shadow:0 2px 8px rgba(0,0,0,0.07);border-top:3px solid #c2185b">
                        <div id="fbStatTotal" style="font-size:2em;font-weight:900;color:#c2185b">â€”</div>
                        <div style="color:#888;font-size:0.76em;font-weight:600">Total Responses</div>
                    </div>
                    <div style="background:white;border-radius:12px;padding:16px;text-align:center;box-shadow:0 2px 8px rgba(0,0,0,0.07);border-top:3px solid #6a1b9a">
                        <div id="fbStatActive" style="font-size:2em;font-weight:900;color:#6a1b9a">â€”</div>
                        <div style="color:#888;font-size:0.76em;font-weight:600">Feedback Active</div>
                    </div>
                    <div style="background:white;border-radius:12px;padding:16px;text-align:center;box-shadow:0 2px 8px rgba(0,0,0,0.07);border-top:3px solid #1565c0">
                        <div id="fbStatAvgScore" style="font-size:2em;font-weight:900;color:#1565c0">â€”</div>
                        <div style="color:#888;font-size:0.76em;font-weight:600">Avg Fest Score</div>
                    </div>
                    <div style="background:white;border-radius:12px;padding:16px;text-align:center;box-shadow:0 2px 8px rgba(0,0,0,0.07);border-top:3px solid #2e7d32">
                        <div id="fbStatRecommend" style="font-size:2em;font-weight:900;color:#2e7d32">â€”</div>
                        <div style="color:#888;font-size:0.76em;font-weight:600">Would Recommend</div>
                    </div>
                </div>

                <!-- â”€â”€ TRIGGER CONTROL â”€â”€ -->
                <div style="background:white;border-radius:14px;padding:22px 24px;margin-bottom:20px;box-shadow:0 2px 10px rgba(0,0,0,0.08);border-top:4px solid #c2185b">
                    <h3 style="color:#880e4f;margin:0 0 6px;font-size:1.1em">ðŸŽ¯ Feedback Trigger Control</h3>
                    <p style="color:#888;font-size:0.85em;margin:0 0 16px">When active, every visitor sees a feedback popup. First time: dismissible. Second time: must fill before closing.</p>
                    <div style="display:flex;gap:12px;flex-wrap:wrap;align-items:center;margin-bottom:16px">
                        <div id="fbTriggerStatus" style="padding:10px 20px;border-radius:20px;font-weight:700;font-size:0.95em;background:#f5f5f5;color:#888">â³ Loading...</div>
                        <button onclick="activateFeedback()" id="btnActivateFeedback" style="background:linear-gradient(135deg,#c2185b,#880e4f);color:white;border:none;border-radius:10px;padding:12px 24px;font-size:1em;font-weight:700;cursor:pointer;box-shadow:0 3px 10px rgba(194,24,91,0.4)">ðŸš€ Activate Feedback (Make Live)</button>
                        <button onclick="deactivateFeedback()" id="btnDeactivateFeedback" style="background:white;color:#c62828;border:2px solid #f44336;border-radius:10px;padding:12px 24px;font-size:1em;font-weight:700;cursor:pointer">â›” Deactivate Feedback</button>
                        <a href="feedback_preview.html" target="_blank" style="display:inline-flex;align-items:center;gap:7px;background:linear-gradient(135deg,#00695c,#26a69a);color:white;text-decoration:none;border-radius:10px;padding:12px 24px;font-size:1em;font-weight:700;box-shadow:0 3px 10px rgba(0,105,92,0.35)">ðŸ”— Open Preview Page</a>
                    </div>
                        <!-- Activation history bar â€” populated by loadFeedbackAdmin() -->
                        <div id="fbActivationHistory" style="display:none;margin-top:12px;padding:12px 16px;border-radius:10px;font-size:0.83em;line-height:1.9;border:1.5px solid #e0e0e0;background:#fafafa;width:100%"></div>
                </div>

                <!-- â”€â”€ DISMISS BEHAVIOR â”€â”€ -->
                <div style="background:white;border-radius:14px;padding:22px 24px;margin-bottom:20px;box-shadow:0 2px 10px rgba(0,0,0,0.08);border-top:4px solid #f9a825">
                    <h3 style="color:#e65100;margin:0 0 6px;font-size:1.1em">ðŸ”’ Dismiss Behavior</h3>
                    <p style="color:#888;font-size:0.85em;margin:0 0 16px">Control how many times a visitor can dismiss the popup before they are forced to fill it.</p>

                    <div style="display:flex;align-items:center;gap:16px;flex-wrap:wrap;margin-bottom:18px;background:#fff8e1;padding:14px 18px;border-radius:10px;border:2px solid #ffe082">
                        <label style="font-weight:700;color:#555;font-size:0.95em;white-space:nowrap">Allowed dismissals before forcing:</label>
                        <div style="display:flex;gap:8px;align-items:center">
                            <button onclick="fbChangeDismiss(-1)" style="width:34px;height:34px;border-radius:50%;border:2px solid #e65100;background:white;color:#e65100;font-size:1.3em;font-weight:700;cursor:pointer;line-height:1;display:flex;align-items:center;justify-content:center">âˆ’</button>
                            <span id="fbMaxDismissDisplay" style="font-size:1.8em;font-weight:900;color:#e65100;min-width:36px;text-align:center">1</span>
                            <button onclick="fbChangeDismiss(1)" style="width:34px;height:34px;border-radius:50%;border:2px solid #e65100;background:white;color:#e65100;font-size:1.3em;font-weight:700;cursor:pointer;line-height:1;display:flex;align-items:center;justify-content:center">+</button>
                            <input type="hidden" id="fbMaxDismissVal" value="1">
                        </div>
                        <div id="fbDismissExplain" style="background:#f3f3f3;border-radius:8px;padding:6px 14px;font-size:0.83em;color:#555;font-weight:600">
                            <!-- Filled by JS -->
                        </div>
                    </div>

                    <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-bottom:0">
                        <button onclick="saveDismissSetting()" style="background:linear-gradient(135deg,#f9a825,#ff6f00);color:white;border:none;border-radius:10px;padding:11px 24px;font-size:0.95em;font-weight:700;cursor:pointer;box-shadow:0 3px 10px rgba(249,168,37,0.4)">ðŸ’¾ Save Dismiss Setting</button>
                        <span id="fbDismissSaveToast" style="display:none;background:#d4edda;color:#155724;padding:10px 18px;border-radius:10px;font-weight:700;font-size:0.9em;border:2px solid #c3e6cb">âœ… Saved!</span>
                    </div>

                    <hr style="border:none;border-top:1px solid #eee;margin:18px 0">

                    <h4 style="color:#c62828;margin:0 0 8px;font-size:0.95em">ðŸ”„ Reset Dismiss Counts for All Visitors</h4>
                    <p style="color:#888;font-size:0.83em;margin:0 0 12px">When you click this, every visitor's dismiss history is cleared â€” they will see the popup fresh again as if it's their first time.</p>
                    <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
                        <button onclick="resetAllDismissCounts()" style="background:white;color:#c62828;border:2px solid #f44336;border-radius:10px;padding:10px 22px;font-size:0.93em;font-weight:700;cursor:pointer">ðŸ—‘ï¸ Reset All Dismiss Counts</button>
                        <span id="fbResetToast" style="display:none;background:#d4edda;color:#155724;padding:10px 18px;border-radius:10px;font-weight:700;font-size:0.9em;border:2px solid #c3e6cb">âœ… All dismiss counts reset!</span>
                    </div>
                </div>

                <!-- â”€â”€ EVENT SELECTION â”€â”€ -->
                <div style="background:white;border-radius:14px;padding:22px 24px;margin-bottom:20px;box-shadow:0 2px 10px rgba(0,0,0,0.08);border-top:4px solid #6a1b9a">
                    <h3 style="color:#4a148c;margin:0 0 6px;font-size:1.1em">ðŸ—‚ï¸ Select Events for Rating</h3>
                    <p style="color:#888;font-size:0.85em;margin:0 0 14px">Choose which events students will rate in the feedback form. Students will see star ratings for each selected event.</p>
                    <div style="background:#f3e5f5;border-radius:10px;padding:14px;margin-bottom:14px">
                        <div style="display:flex;gap:10px;margin-bottom:10px;flex-wrap:wrap">
                            <button onclick="fbSelectAllEvents()" style="background:#6a1b9a;color:white;border:none;border-radius:8px;padding:6px 16px;font-size:0.85em;font-weight:700;cursor:pointer">âœ… Select All</button>
                            <button onclick="fbClearAllEvents()" style="background:white;color:#6a1b9a;border:2px solid #6a1b9a;border-radius:8px;padding:6px 16px;font-size:0.85em;font-weight:700;cursor:pointer">âŒ Clear All</button>
                            <button onclick="fbAddCustomEvent()" style="background:linear-gradient(135deg,#1565c0,#42a5f5);color:white;border:none;border-radius:8px;padding:6px 16px;font-size:0.85em;font-weight:700;cursor:pointer">âž• Add Custom Event</button>
                        </div>
                        <div id="fbEventCheckboxes" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:8px">
                            <!-- Populated by JS -->
                        </div>
                        <div id="fbCustomEventsContainer" style="margin-top:10px"></div>
                    </div>
                    <button onclick="saveFeedbackEventList()" style="background:linear-gradient(135deg,#6a1b9a,#c44569);color:white;border:none;border-radius:10px;padding:12px 24px;font-size:1em;font-weight:700;cursor:pointer;box-shadow:0 3px 10px rgba(106,27,154,0.4)">ðŸ’¾ Save Event List</button>
                </div>

                <!-- â”€â”€ FEEDBACK QUESTIONS PREVIEW & EDIT â”€â”€ -->
                <div style="background:white;border-radius:14px;padding:22px 24px;margin-bottom:20px;box-shadow:0 2px 10px rgba(0,0,0,0.08);border-top:4px solid #ff6f00">
                    <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:10px;margin-bottom:16px">
                        <div>
                            <h3 style="color:#e65100;margin:0 0 4px;font-size:1.1em">ðŸ‘ï¸ Feedback Form â€” Questions Preview & Edit</h3>
                            <p style="color:#888;font-size:0.83em;margin:0">This is exactly what visitors will see in the feedback popup. Edit any question label below.</p>
                        </div>
                        <button onclick="saveFeedbackQuestions()" style="background:linear-gradient(135deg,#ff6f00,#ffa000);color:white;border:none;border-radius:10px;padding:10px 22px;font-size:0.92em;font-weight:700;cursor:pointer;box-shadow:0 3px 10px rgba(255,111,0,0.4)">ðŸ’¾ Save Question Labels</button>
                    </div>
                    <div id="fbQuestionsPreview" style="background:#fff8e1;border-radius:12px;padding:16px;border:2px solid #ffe082">
                        <!-- Populated by JS â€” shows live preview + editable labels -->
                        <p style="color:#aaa;text-align:center;font-style:italic">Load Feedback Admin to see questions preview.</p>
                    </div>
                    <div style="margin-top:12px;display:flex;align-items:center;gap:10px;flex-wrap:wrap">
                        <button onclick="saveFeedbackQuestions()" style="background:linear-gradient(135deg,#ff6f00,#ffa000);color:white;border:none;border-radius:10px;padding:11px 24px;font-size:0.95em;font-weight:700;cursor:pointer">ðŸ’¾ Save Question Labels</button>
                        <button onclick="resetFeedbackQuestions()" style="background:white;color:#ff6f00;border:2px solid #ff6f00;border-radius:10px;padding:11px 20px;font-size:0.95em;font-weight:700;cursor:pointer">ðŸ”„ Reset to Defaults</button>
                        <span id="fbQSaveToast" style="display:none;background:#d4edda;color:#155724;padding:10px 18px;border-radius:10px;font-weight:700;font-size:0.9em;border:2px solid #c3e6cb;animation:slideInUp 0.3s ease">âœ… Question labels saved!</span>
                    </div>
                </div>

                <!-- â”€â”€ RESPONSES VIEWER â”€â”€ -->
                <div style="background:white;border-radius:14px;padding:22px 24px;box-shadow:0 2px 10px rgba(0,0,0,0.08);border-top:4px solid #1565c0">
                    <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:10px;margin-bottom:16px">
                        <h3 style="color:#0d47a1;margin:0;font-size:1.1em">ðŸ“Š Feedback Responses</h3>
                        <div style="display:flex;gap:8px;flex-wrap:wrap">
                            <button onclick="loadFeedbackResponses()" style="background:#1565c0;color:white;border:none;border-radius:8px;padding:8px 16px;font-size:0.85em;font-weight:700;cursor:pointer">ðŸ”„ Load Responses</button>
                            <button onclick="downloadFeedbackCSV()" style="background:white;color:#1565c0;border:2px solid #1565c0;border-radius:8px;padding:8px 16px;font-size:0.85em;font-weight:700;cursor:pointer">ðŸ“¥ Download CSV</button>
                            <button onclick="clearAllFeedback()" style="background:white;color:#c62828;border:2px solid #f44336;border-radius:8px;padding:8px 16px;font-size:0.85em;font-weight:700;cursor:pointer">ðŸ—‘ï¸ Clear All</button>
                        </div>
                    </div>
                    <div id="fbResponsesContainer">
                        <p style="color:#aaa;text-align:center;padding:20px">Click "Load Responses" to see all feedback submissions.</p>
                    </div>
                </div>
            </div>
            <!-- ================================================ -->
            <!-- END FEEDBACK ADMIN PANEL                         -->
            <!-- ================================================ -->
            <div id="dbInspector" class="form-section super-admin-only" style="margin-top:20px">
                <h2 style="color:#c44569;margin-bottom:6px">ðŸ” Database Inspector</h2>
                <p style="color:#888;margin-bottom:20px;font-size:.9em">Scan your entire Firebase Realtime Database for base64 data, large fields, and suspicious entries.</p>

                <!-- Summary Cards -->
                <div id="dbi-summary" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:12px;margin-bottom:20px">
                    <div style="background:linear-gradient(135deg,#667eea,#764ba2);border-radius:12px;padding:16px;color:white;text-align:center">
                        <div style="font-size:2em" id="dbi-total-nodes">â€”</div>
                        <div style="font-size:.8em;opacity:.85">Total Nodes Scanned</div>
                    </div>
                    <div style="background:linear-gradient(135deg,#f093fb,#f5576c);border-radius:12px;padding:16px;color:white;text-align:center">
                        <div style="font-size:2em" id="dbi-b64-count">â€”</div>
                        <div style="font-size:.8em;opacity:.85">Base64 Fields Found</div>
                    </div>
                    <div style="background:linear-gradient(135deg,#4facfe,#00f2fe);border-radius:12px;padding:16px;color:white;text-align:center">
                        <div style="font-size:2em" id="dbi-total-size">â€”</div>
                        <div style="font-size:.8em;opacity:.85">Total DB Size</div>
                    </div>
                    <div style="background:linear-gradient(135deg,#43e97b,#38f9d7);border-radius:12px;padding:16px;color:white;text-align:center">
                        <div style="font-size:2em" id="dbi-b64-size">â€”</div>
                        <div style="font-size:.8em;opacity:.85">Base64 Data Size</div>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div style="display:flex;gap:10px;flex-wrap:wrap;margin-bottom:20px">
                    <button class="btn btn-success" onclick="dbiRunScan()" id="dbi-scan-btn">ðŸ” Scan Database Now</button>
                    <button class="btn btn-small" onclick="dbiClearResults()" style="background:#888;color:white">ðŸ—‘ï¸ Clear Results</button>
                    <button class="btn btn-small" onclick="dbiDownloadReport()" id="dbi-dl-btn" style="display:none;background:#6a1b9a;color:white">ðŸ“¥ Download Report</button>
                </div>

                <!-- Progress Bar -->
                <div id="dbi-progress-wrap" style="display:none;margin-bottom:16px">
                    <div style="background:#eee;border-radius:20px;height:10px;overflow:hidden">
                        <div id="dbi-progress-bar" style="background:linear-gradient(90deg,#c44569,#6a1b9a);height:100%;width:0%;transition:width .4s ease;border-radius:20px"></div>
                    </div>
                    <p id="dbi-progress-label" style="color:#888;font-size:.82em;margin-top:4px;text-align:center">Scanningâ€¦</p>
                </div>

                <!-- Alert Banner -->
                <div id="dbi-alert" style="display:none;padding:14px 18px;border-radius:10px;margin-bottom:16px;font-weight:600"></div>

                <!-- Results Table -->
                <div id="dbi-results" style="display:none">
                    <h3 style="color:#c44569;margin-bottom:10px">ðŸ“‹ Scan Results</h3>
                    <div style="overflow-x:auto">
                        <table style="width:100%;border-collapse:collapse;font-size:.85em">
                            <thead>
                                <tr style="background:linear-gradient(135deg,#c44569,#6a1b9a);color:white">
                                    <th style="padding:10px 12px;text-align:left;border-radius:8px 0 0 0">#</th>
                                    <th style="padding:10px 12px;text-align:left">Firebase Path</th>
                                    <th style="padding:10px 12px;text-align:left">Field Key</th>
                                    <th style="padding:10px 12px;text-align:left">Type</th>
                                    <th style="padding:10px 12px;text-align:left">Size</th>
                                    <th style="padding:10px 12px;text-align:left;border-radius:0 8px 0 0">Preview</th>
                                </tr>
                            </thead>
                            <tbody id="dbi-table-body"></tbody>
                        </table>
                    </div>
                    <p style="color:#888;font-size:.8em;margin-top:10px" id="dbi-results-note"></p>
                </div>

                <!-- Node Tree Explorer -->
                <div style="margin-top:24px">
                    <h3 style="color:#6a1b9a;margin-bottom:10px">ðŸŒ³ Top-Level Node Sizes</h3>
                    <div id="dbi-node-tree" style="background:#f9f5ff;border-radius:10px;padding:16px;min-height:60px;color:#888;font-size:.85em">
                        Run a scan to see node sizes.
                    </div>
                </div>

                <!-- â”€â”€ Quiz Submissions Date-Wise Cleanup â”€â”€ -->
                <div style="margin-top:28px">
                    <h3 style="color:#c44569;margin-bottom:4px">ðŸ—‚ï¸ Quiz Submissions â€” Date-Wise Cleanup</h3>
                    <p style="color:#888;font-size:.82em;margin-bottom:14px">Safely delete old quiz submissions day by day. <strong>Winners &amp; leaderboard are stored in <code>quizResults</code> â€” completely separate â€” and will NOT be affected.</strong></p>

                    <div style="background:#fff8e1;border-left:4px solid #ffc107;border-radius:8px;padding:12px 14px;margin-bottom:14px;font-size:.83em;color:#856404">
                        âœ… <strong>Safe to delete:</strong> Days where "Results Saved" shows âœ… â€” scores &amp; winners already recorded in quizResults.<br>
                        âš ï¸ <strong>Do NOT delete:</strong> Days marked âŒ Results Not Saved â€” raw submissions may still be needed for scoring.
                    </div>

                    <div style="display:flex;gap:10px;flex-wrap:wrap;margin-bottom:14px">
                        <button class="btn btn-success" onclick="qsCleanupLoad()" id="qsc-load-btn">ðŸ“‚ Load Submission Days</button>
                        <button class="btn btn-small" onclick="qsCleanupSelectAll()" style="background:#6a1b9a;color:white">â˜‘ Select All Safe Days</button>
                        <button class="btn btn-small" onclick="qsCleanupDeleteSelected()" id="qsc-del-btn" style="background:#dc3545;color:white;display:none">ðŸ—‘ï¸ Delete Selected Days</button>
                    </div>

                    <div id="qsc-alert" style="display:none;padding:12px 16px;border-radius:8px;margin-bottom:12px;font-weight:600;font-size:.85em"></div>

                    <div id="qsc-table-wrap" style="display:none;overflow-x:auto">
                        <table style="width:100%;border-collapse:collapse;font-size:.84em">
                            <thead>
                                <tr style="background:linear-gradient(135deg,#c44569,#6a1b9a);color:white">
                                    <th style="padding:9px 12px;text-align:center;border-radius:8px 0 0 0;width:40px">â˜‘</th>
                                    <th style="padding:9px 12px;text-align:left">ðŸ“… Date</th>
                                    <th style="padding:9px 12px;text-align:center">ðŸ‘¥ Submissions</th>
                                    <th style="padding:9px 12px;text-align:center">ðŸ“¦ Est. Size</th>
                                    <th style="padding:9px 12px;text-align:center">ðŸ† Results Saved?</th>
                                    <th style="padding:9px 12px;text-align:left;border-radius:0 8px 0 0">ðŸ¥‡ Winner / ðŸ¥ˆ Runner-Up</th>
                                </tr>
                            </thead>
                            <tbody id="qsc-tbody"></tbody>
                        </table>
                        <p id="qsc-total-label" style="color:#888;font-size:.78em;margin-top:8px;text-align:right"></p>
                    </div>
                </div>
            </div>
            <!-- ================================================ -->
            <!-- END DB INSPECTOR PANEL                           -->
            <!-- ================================================ -->

            <!-- ================================================ -->
            <!-- â˜ï¸ CLOUDINARY INSPECTOR PANEL (Super Admin Only) -->
            <!-- ================================================ -->
            <div id="cloudinaryInspector" class="form-section super-admin-only" style="margin-top:20px">
                <h2 style="color:#c44569;margin-bottom:6px">â˜ï¸ Cloudinary Inspector</h2>
                <p style="color:#888;margin-bottom:16px;font-size:.9em">Two ways to check your Cloudinary usage â€” pick whichever works for you.</p>

                <!-- â”€â”€ MODE SWITCHER â”€â”€ -->
                <div style="display:flex;gap:0;margin-bottom:20px;border-radius:10px;overflow:hidden;border:2px solid #6a1b9a;width:fit-content">
                    <button id="cld-mode-manual-btn" onclick="cldSwitchMode('manual')"
                        style="padding:10px 22px;font-size:.88em;font-weight:700;cursor:pointer;border:none;background:linear-gradient(135deg,#6a1b9a,#c44569);color:white;transition:all .2s">
                        ðŸ“‹ Option A â€” Manual Logger
                    </button>
                    <button id="cld-mode-live-btn" onclick="cldSwitchMode('live')"
                        style="padding:10px 22px;font-size:.88em;font-weight:700;cursor:pointer;border:none;background:#f3e8ff;color:#6a1b9a;transition:all .2s">
                        âš¡ Option B â€” Live via Proxy
                    </button>
                </div>

                <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
                <!-- OPTION A â€” MANUAL LOGGER                        -->
                <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
                <div id="cld-panel-manual">

                    <!-- How-to banner -->
                    <div style="background:linear-gradient(135deg,#e8f4fd,#f3e8ff);border-radius:12px;padding:16px;margin-bottom:16px;border-left:5px solid #6a1b9a">
                        <p style="color:#6a1b9a;font-weight:700;margin-bottom:8px;font-size:.92em">ðŸ“– How to get your numbers</p>
                        <ol style="color:#555;font-size:.84em;margin:0;padding-left:18px;line-height:2">
                            <li>Go to <a href="https://cloudinary.com/console" target="_blank" style="color:#c44569;font-weight:600">cloudinary.com/console</a> and log in</li>
                            <li>On the <strong>Home / Dashboard</strong> page you'll see Storage, Bandwidth, and Transformations gauges</li>
                            <li>For full history: click <strong>Reports â†’ Usage Report</strong> in the left sidebar</li>
                            <li>Note down the values and enter them below â€” they're saved in your browser</li>
                        </ol>
                    </div>

                    <!-- Input form -->
                    <div style="background:#f9f5ff;border-radius:12px;padding:16px;margin-bottom:16px;border:1px solid #e0d0f0">
                        <p style="color:#6a1b9a;font-weight:700;margin-bottom:12px;font-size:.9em">ðŸ“¥ Log Current Usage</p>
                        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:10px;margin-bottom:12px">
                            <div>
                                <label style="font-size:.78em;color:#888;display:block;margin-bottom:4px">ðŸ—„ï¸ Storage Used (MB)</label>
                                <input id="cldm-storage-used" type="number" min="0" step="0.1" placeholder="e.g. 450.5"
                                    style="width:100%;padding:8px 12px;border:1.5px solid #e0d0f0;border-radius:8px;font-size:.9em;outline:none">
                            </div>
                            <div>
                                <label style="font-size:.78em;color:#888;display:block;margin-bottom:4px">ðŸ“¦ Storage Limit (MB)</label>
                                <input id="cldm-storage-limit" type="number" min="0" step="0.1" placeholder="e.g. 25600 (25 GB free)"
                                    style="width:100%;padding:8px 12px;border:1.5px solid #e0d0f0;border-radius:8px;font-size:.9em;outline:none">
                            </div>
                            <div>
                                <label style="font-size:.78em;color:#888;display:block;margin-bottom:4px">ðŸŒ Bandwidth Used (MB)</label>
                                <input id="cldm-bw-used" type="number" min="0" step="0.1" placeholder="e.g. 1200"
                                    style="width:100%;padding:8px 12px;border:1.5px solid #e0d0f0;border-radius:8px;font-size:.9em;outline:none">
                            </div>
                            <div>
                                <label style="font-size:.78em;color:#888;display:block;margin-bottom:4px">ðŸ“¡ Bandwidth Limit (MB)</label>
                                <input id="cldm-bw-limit" type="number" min="0" step="0.1" placeholder="e.g. 25600 (25 GB free)"
                                    style="width:100%;padding:8px 12px;border:1.5px solid #e0d0f0;border-radius:8px;font-size:.9em;outline:none">
                            </div>
                            <div>
                                <label style="font-size:.78em;color:#888;display:block;margin-bottom:4px">ðŸ–¼ï¸ Total Assets</label>
                                <input id="cldm-assets" type="number" min="0" step="1" placeholder="e.g. 342"
                                    style="width:100%;padding:8px 12px;border:1.5px solid #e0d0f0;border-radius:8px;font-size:.9em;outline:none">
                            </div>
                            <div>
                                <label style="font-size:.78em;color:#888;display:block;margin-bottom:4px">ðŸ“… Date Checked</label>
                                <input id="cldm-date" type="date"
                                    style="width:100%;padding:8px 12px;border:1.5px solid #e0d0f0;border-radius:8px;font-size:.9em;outline:none">
                            </div>
                        </div>
                        <div style="display:flex;gap:10px;flex-wrap:wrap">
                            <button class="btn btn-success" onclick="cldmSave()">ðŸ’¾ Save & Visualise</button>
                            <button class="btn btn-small" onclick="cldmClearAll()" style="background:#dc3545;color:white">ðŸ—‘ï¸ Clear All</button>
                        </div>
                    </div>

                    <!-- Alert -->
                    <div id="cldm-alert" style="display:none;padding:14px 18px;border-radius:10px;margin-bottom:16px;font-weight:600"></div>

                    <!-- Summary Cards -->
                    <div id="cldm-cards" style="display:none">
                        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:12px;margin-bottom:16px">
                            <div style="background:linear-gradient(135deg,#f7971e,#ffd200);border-radius:12px;padding:14px;color:#333;text-align:center">
                                <div style="font-size:1.6em;font-weight:700" id="cldm-card-storage-used">â€”</div>
                                <div style="font-size:.75em;opacity:.85">Storage Used</div>
                            </div>
                            <div style="background:linear-gradient(135deg,#11998e,#38ef7d);border-radius:12px;padding:14px;color:white;text-align:center">
                                <div style="font-size:1.6em;font-weight:700" id="cldm-card-storage-limit">â€”</div>
                                <div style="font-size:.75em;opacity:.85">Storage Limit</div>
                            </div>
                            <div style="background:linear-gradient(135deg,#4facfe,#00f2fe);border-radius:12px;padding:14px;color:white;text-align:center">
                                <div style="font-size:1.6em;font-weight:700" id="cldm-card-bw-used">â€”</div>
                                <div style="font-size:.75em;opacity:.85">Bandwidth Used</div>
                            </div>
                            <div style="background:linear-gradient(135deg,#f093fb,#f5576c);border-radius:12px;padding:14px;color:white;text-align:center">
                                <div style="font-size:1.6em;font-weight:700" id="cldm-card-bw-limit">â€”</div>
                                <div style="font-size:.75em;opacity:.85">Bandwidth Limit</div>
                            </div>
                            <div style="background:linear-gradient(135deg,#667eea,#764ba2);border-radius:12px;padding:14px;color:white;text-align:center">
                                <div style="font-size:1.6em;font-weight:700" id="cldm-card-assets">â€”</div>
                                <div style="font-size:.75em;opacity:.85">Total Assets</div>
                            </div>
                            <div style="background:linear-gradient(135deg,#43e97b,#38f9d7);border-radius:12px;padding:14px;color:white;text-align:center">
                                <div style="font-size:1.6em;font-weight:700" id="cldm-card-date">â€”</div>
                                <div style="font-size:.75em;opacity:.85">Last Checked</div>
                            </div>
                        </div>

                        <!-- Usage bars -->
                        <div style="background:#f9f5ff;border-radius:12px;padding:16px;margin-bottom:16px">
                            <h3 style="color:#6a1b9a;margin-bottom:14px;font-size:1em">ðŸ“Š Usage Overview</h3>
                            <div style="margin-bottom:14px">
                                <div style="display:flex;justify-content:space-between;margin-bottom:4px">
                                    <span style="font-weight:700;color:#333;font-size:.88em">ðŸ—„ï¸ Storage</span>
                                    <span id="cldm-storage-pct-lbl" style="color:#888;font-size:.82em"></span>
                                </div>
                                <div style="background:#e0e0e0;border-radius:20px;height:14px;overflow:hidden">
                                    <div id="cldm-storage-bar" style="height:100%;width:0%;border-radius:20px;transition:width .7s ease;background:linear-gradient(90deg,#43e97b,#38f9d7)"></div>
                                </div>
                            </div>
                            <div>
                                <div style="display:flex;justify-content:space-between;margin-bottom:4px">
                                    <span style="font-weight:700;color:#333;font-size:.88em">ðŸŒ Bandwidth (this month)</span>
                                    <span id="cldm-bw-pct-lbl" style="color:#888;font-size:.82em"></span>
                                </div>
                                <div style="background:#e0e0e0;border-radius:20px;height:14px;overflow:hidden">
                                    <div id="cldm-bw-bar" style="height:100%;width:0%;border-radius:20px;transition:width .7s ease;background:linear-gradient(90deg,#4facfe,#00f2fe)"></div>
                                </div>
                            </div>
                        </div>

                        <!-- History -->
                        <h3 style="color:#6a1b9a;font-size:.95em;margin-bottom:10px">ðŸ“… Saved History (Last 7 Entries)</h3>
                        <div style="overflow-x:auto">
                            <table style="width:100%;border-collapse:collapse;font-size:.83em">
                                <thead>
                                    <tr style="background:linear-gradient(135deg,#c44569,#6a1b9a);color:white">
                                        <th style="padding:9px 12px;text-align:left;border-radius:8px 0 0 0">Date</th>
                                        <th style="padding:9px 12px;text-align:left">Storage</th>
                                        <th style="padding:9px 12px;text-align:left">Bandwidth</th>
                                        <th style="padding:9px 12px;text-align:left">Assets</th>
                                        <th style="padding:9px 12px;text-align:left;border-radius:0 8px 0 0">Action</th>
                                    </tr>
                                </thead>
                                <tbody id="cldm-history-body"></tbody>
                            </table>
                        </div>
                    </div>
                </div><!-- end panel-manual -->

                <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
                <!-- OPTION B â€” LIVE VIA CLOUDFLARE WORKER PROXY     -->
                <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
                <div id="cld-panel-live" style="display:none">

                    <!-- Setup guide -->
                    <div style="background:linear-gradient(135deg,#fff8e1,#f3e8ff);border-radius:12px;padding:16px;margin-bottom:16px;border-left:5px solid #f7971e">
                        <p style="color:#856404;font-weight:700;margin-bottom:10px;font-size:.92em">âš¡ One-time Setup: Create a Free Cloudflare Worker (takes ~10 minutes)</p>
                        <ol style="color:#555;font-size:.84em;margin:0;padding-left:18px;line-height:2.2">
                            <li>Go to <a href="https://dash.cloudflare.com" target="_blank" style="color:#c44569;font-weight:600">dash.cloudflare.com</a> â†’ sign up free â†’ click <strong>Workers &amp; Pages â†’ Create</strong></li>
                            <li>Click <strong>"Hello World"</strong> template â†’ give it a name (e.g. <code style="background:#eee;padding:1px 5px;border-radius:3px">cld-proxy</code>) â†’ click <strong>Deploy</strong></li>
                            <li>Click <strong>"Edit code"</strong> and replace ALL the code with this:</li>
                        </ol>
                        <pre style="background:#1e1e2e;color:#cdd6f4;border-radius:8px;padding:14px;margin:10px 0;font-size:.78em;overflow-x:auto;line-height:1.6"><code>export default {
  async fetch(request) {
    // Allow CORS preflight
    if (request.method === 'OPTIONS') {
      return new Response(null, { headers: {
        'Access-Control-Allow-Origin': '*',
        'Access-Control-Allow-Methods': 'GET, POST, OPTIONS',
        'Access-Control-Allow-Headers': 'Content-Type'
      }});
    }

    // âœï¸ Fill in YOUR Cloudinary credentials below
    const API_KEY    = "YOUR_API_KEY_HERE";
    const API_SECRET = "YOUR_API_SECRET_HERE";
    const CLOUD_NAME = "YOUR_CLOUD_NAME_HERE";

    const credentials = btoa(`${API_KEY}:${API_SECRET}`);
    const resp = await fetch(
      `https://api.cloudinary.com/v1_1/${CLOUD_NAME}/usage`,
      { headers: { Authorization: `Basic ${credentials}` } }
    );
    const data = await resp.json();

    return new Response(JSON.stringify(data), {
      headers: {
        'Content-Type': 'application/json',
        'Access-Control-Allow-Origin': '*'
      }
    });
  }
};</code></pre>
                        <ol start="4" style="color:#555;font-size:.84em;margin:0;padding-left:18px;line-height:2.2">
                            <li>Fill in your <strong>API_KEY</strong>, <strong>API_SECRET</strong>, and <strong>CLOUD_NAME</strong> in the code above (find them at Cloudinary â†’ Settings â†’ Access Keys)</li>
                            <li>Click <strong>Deploy</strong> â€” you'll get a URL like <code style="background:#eee;padding:1px 5px;border-radius:3px">https://cld-proxy.YOUR-NAME.workers.dev</code></li>
                            <li>Paste that URL into the box below and click <strong>Fetch Live Stats</strong></li>
                        </ol>
                    </div>

                    <!-- Worker URL input -->
                    <div style="background:#f9f5ff;border-radius:12px;padding:16px;margin-bottom:16px;border:1px solid #e0d0f0">
                        <p style="color:#6a1b9a;font-weight:700;margin-bottom:10px;font-size:.9em">ðŸ”— Your Cloudflare Worker URL</p>
                        <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
                            <input id="cld-worker-url" type="url" placeholder="https://cld-proxy.your-name.workers.dev"
                                style="flex:1;min-width:250px;padding:9px 14px;border:1.5px solid #e0d0f0;border-radius:8px;font-size:.9em;outline:none">
                            <button class="btn btn-success" onclick="cldLiveFetch()" id="cld-live-btn">âš¡ Fetch Live Stats</button>
                            <button class="btn btn-small" onclick="cldLiveClear()" style="background:#888;color:white">ðŸ—‘ï¸ Clear</button>
                        </div>
                        <p style="color:#aaa;font-size:.76em;margin-top:8px">The URL is saved in your browser for next time.</p>
                        <p style="color:#c0392b;font-size:.78em;margin-top:6px;font-weight:600">âš ï¸ This must be your <strong>Cloudinary stats worker</strong> â€” NOT your email/Brevo worker. Create a separate worker with the code shown above (paste your API_KEY, API_SECRET, CLOUD_NAME).</p>
                    </div>

                    <!-- Progress Bar -->
                    <div id="cld-live-progress-wrap" style="display:none;margin-bottom:14px">
                        <div style="background:#eee;border-radius:20px;height:10px;overflow:hidden">
                            <div id="cld-live-progress-bar" style="background:linear-gradient(90deg,#f7971e,#ffd200);height:100%;width:0%;transition:width .4s ease;border-radius:20px"></div>
                        </div>
                        <p id="cld-live-progress-label" style="color:#888;font-size:.82em;margin-top:4px;text-align:center">Fetchingâ€¦</p>
                    </div>

                    <!-- Alert -->
                    <div id="cld-live-alert" style="display:none;padding:14px 18px;border-radius:10px;margin-bottom:16px;font-weight:600"></div>

                    <!-- Live Results -->
                    <div id="cld-live-results" style="display:none">
                        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:12px;margin-bottom:16px">
                            <div style="background:linear-gradient(135deg,#f7971e,#ffd200);border-radius:12px;padding:14px;color:#333;text-align:center">
                                <div style="font-size:1.6em;font-weight:700" id="cld-storage">â€”</div>
                                <div style="font-size:.75em;opacity:.85">Storage Used</div>
                            </div>
                            <div style="background:linear-gradient(135deg,#11998e,#38ef7d);border-radius:12px;padding:14px;color:white;text-align:center">
                                <div style="font-size:1.6em;font-weight:700" id="cld-storage-limit">â€”</div>
                                <div style="font-size:.75em;opacity:.85">Storage Limit</div>
                            </div>
                            <div style="background:linear-gradient(135deg,#4facfe,#00f2fe);border-radius:12px;padding:14px;color:white;text-align:center">
                                <div style="font-size:1.6em;font-weight:700" id="cld-bandwidth">â€”</div>
                                <div style="font-size:.75em;opacity:.85">Bandwidth Used</div>
                            </div>
                            <div style="background:linear-gradient(135deg,#f093fb,#f5576c);border-radius:12px;padding:14px;color:white;text-align:center">
                                <div style="font-size:1.6em;font-weight:700" id="cld-bandwidth-limit">â€”</div>
                                <div style="font-size:.75em;opacity:.85">Bandwidth Limit</div>
                            </div>
                            <div style="background:linear-gradient(135deg,#667eea,#764ba2);border-radius:12px;padding:14px;color:white;text-align:center">
                                <div style="font-size:1.6em;font-weight:700" id="cld-resources">â€”</div>
                                <div style="font-size:.75em;opacity:.85">Total Assets</div>
                            </div>
                            <div style="background:linear-gradient(135deg,#43e97b,#38f9d7);border-radius:12px;padding:14px;color:white;text-align:center">
                                <div style="font-size:1.6em;font-weight:700" id="cld-plan">â€”</div>
                                <div style="font-size:.75em;opacity:.85">Plan</div>
                            </div>
                        </div>
                        <!-- Usage bars -->
                        <div style="background:#f9f5ff;border-radius:12px;padding:16px">
                            <h3 style="color:#6a1b9a;margin-bottom:14px;font-size:1em">ðŸ“Š Live Usage Overview</h3>
                            <div style="margin-bottom:14px">
                                <div style="display:flex;justify-content:space-between;margin-bottom:4px">
                                    <span style="font-weight:700;color:#333;font-size:.88em">ðŸ—„ï¸ Storage</span>
                                    <span id="cld-storage-pct-label" style="color:#888;font-size:.82em"></span>
                                </div>
                                <div style="background:#e0e0e0;border-radius:20px;height:14px;overflow:hidden">
                                    <div id="cld-storage-bar" style="height:100%;width:0%;border-radius:20px;transition:width .7s ease"></div>
                                </div>
                            </div>
                            <div>
                                <div style="display:flex;justify-content:space-between;margin-bottom:4px">
                                    <span style="font-weight:700;color:#333;font-size:.88em">ðŸŒ Bandwidth (this month)</span>
                                    <span id="cld-bandwidth-pct-label" style="color:#888;font-size:.82em"></span>
                                </div>
                                <div style="background:#e0e0e0;border-radius:20px;height:14px;overflow:hidden">
                                    <div id="cld-bandwidth-bar" style="height:100%;width:0%;border-radius:20px;transition:width .7s ease"></div>
                                </div>
                            </div>
                            <div id="cld-asset-breakdown" style="margin-top:16px;display:grid;grid-template-columns:repeat(auto-fit,minmax(130px,1fr));gap:10px"></div>
                        </div>
                    </div>
                </div><!-- end panel-live -->

            </div>
            <!-- ================================================ -->
            <!-- END CLOUDINARY INSPECTOR PANEL                   -->
            <!-- ================================================ -->

            <!-- ================================================ -->
            <!-- ðŸ”¥ FIREBASE DOWNLOAD LIMIT MONITOR (Super Admin) -->
            <!-- ================================================ -->
            <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
            <!-- MANAGER PERMISSIONS PANEL (Super Admin only)                      -->
            <!-- TO ADD A NEW PERMISSION: copy a toggle row, change id & label,    -->
            <!-- then add matching code in managerPermissions & applyManagerPermissions() -->
            <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
            <div id="managerPermissionsPanel" class="form-section super-admin-only" style="margin-top:20px">
                <h2 style="color:#2196F3;margin-bottom:8px">ðŸ‘” Manager Permissions</h2>
                <p style="color:#555;font-size:13px;margin-bottom:20px;background:#e3f2fd;padding:12px 16px;border-radius:8px;border-left:4px solid #2196F3">
                    Control exactly what the <strong>Manager</strong> login can see and do.<br>
                    Changes saved here persist across page reloads.
                </p>
                <div style="background:white;border-radius:12px;border:2px solid #e0e0e0;overflow:hidden">
                    <div style="background:#2196F3;color:white;padding:12px 20px;display:grid;grid-template-columns:1fr auto;align-items:center">
                        <span style="font-weight:700">Feature / Tab</span>
                        <span style="font-weight:700">Allow Manager?</span>
                    </div>
                    <div style="padding:0 20px">

                        <div style="display:grid;grid-template-columns:1fr auto;align-items:center;padding:16px 0;border-bottom:1px solid #f0f0f0">
                            <div><strong style="color:#333">ðŸ“ Quiz Management</strong>
                            <p style="color:#777;font-size:12px;margin:3px 0 0">Add/edit quiz questions, publish daily quiz</p></div>
                            <input type="checkbox" id="mperm_quizManagement" style="width:20px;height:20px;accent-color:#2196F3;cursor:pointer">
                        </div>

                        <div style="display:grid;grid-template-columns:1fr auto;align-items:center;padding:16px 0;border-bottom:1px solid #f0f0f0">
                            <div><strong style="color:#333">ðŸ—ºï¸ Scavenger Hunt Admin</strong>
                            <p style="color:#777;font-size:12px;margin:3px 0 0">Add/edit tasks, approve/reject student submissions</p></div>
                            <input type="checkbox" id="mperm_scavengerAdmin" style="width:20px;height:20px;accent-color:#2196F3;cursor:pointer">
                        </div>

                        <div style="display:grid;grid-template-columns:1fr auto;align-items:center;padding:16px 0;border-bottom:1px solid #f0f0f0">
                            <div><strong style="color:#333">ðŸ“‹ View Registrations</strong>
                            <p style="color:#777;font-size:12px;margin:3px 0 0">See Master List & By Events tabs (read-only)</p></div>
                            <input type="checkbox" id="mperm_viewRegistrations" style="width:20px;height:20px;accent-color:#2196F3;cursor:pointer">
                        </div>

                        <div style="display:grid;grid-template-columns:1fr auto;align-items:center;padding:16px 0;border-bottom:1px solid #f0f0f0">
                            <div><strong style="color:#333">ðŸ† View Quiz Results</strong>
                            <p style="color:#777;font-size:12px;margin:3px 0 0">See Results tab and quiz submissions</p></div>
                            <input type="checkbox" id="mperm_viewResults" style="width:20px;height:20px;accent-color:#2196F3;cursor:pointer">
                        </div>

                        <div style="display:grid;grid-template-columns:1fr auto;align-items:center;padding:16px 0;border-bottom:1px solid #f0f0f0">
                            <div><strong style="color:#333">ðŸ“² WhatsApp Broadcast Messages</strong>
                            <p style="color:#777;font-size:12px;margin:3px 0 0">Copy ready-made quiz & scavenger hunt messages</p></div>
                            <input type="checkbox" id="mperm_whatsappMessages" style="width:20px;height:20px;accent-color:#2196F3;cursor:pointer">
                        </div>

                        <!-- â”€â”€ ADD NEW PERMISSION ROWS BELOW THIS LINE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
                        <!-- Copy any row above, change id="mperm_yourKey", label & description -->
                        <!-- Then add matching code in managerPermissions object & applyManagerPermissions() -->

                        <div style="display:grid;grid-template-columns:1fr auto;align-items:center;padding:16px 0;border-bottom:1px solid #f0f0f0">
                            <div><strong style="color:#333">ðŸ“„ PDF Handouts Upload</strong>
                            <p style="color:#777;font-size:12px;margin:3px 0 0">Upload event PDF handouts on behalf of faculty in-charges</p></div>
                            <input type="checkbox" id="mperm_pdfHandouts" style="width:20px;height:20px;accent-color:#2196F3;cursor:pointer">
                        </div>

                        <div style="display:grid;grid-template-columns:1fr auto;align-items:center;padding:16px 0;border-bottom:1px solid #f0f0f0">
                            <div><strong style="color:#333">ðŸ’³ Payment Approval</strong>
                            <p style="color:#777;font-size:12px;margin:3px 0 0">Approve or reject student â‚¹1,500 registrations</p></div>
                            <input type="checkbox" id="mperm_paymentApproval" style="width:20px;height:20px;accent-color:#2196F3;cursor:pointer">
                        </div>

                        <div style="display:grid;grid-template-columns:1fr auto;align-items:center;padding:16px 0">
                            <div><strong style="color:#333">ðŸ“… Event Schedule Editor</strong>
                            <p style="color:#777;font-size:12px;margin:3px 0 0">Add, edit and delete events in the Spurthi Youth Fest timetable</p></div>
                            <input type="checkbox" id="mperm_eventSchedule" style="width:20px;height:20px;accent-color:#2196F3;cursor:pointer">
                        </div>

                    </div>
                    <div style="padding:20px;background:#f9f9f9;border-top:2px solid #e0e0e0;display:flex;align-items:center;gap:15px;flex-wrap:wrap">
                        <button onclick="saveManagerPermissions()" style="background:#2196F3;color:white;border:none;padding:12px 30px;border-radius:8px;cursor:pointer;font-weight:700;font-size:1em">
                            ðŸ’¾ Save Permissions
                        </button>
                        <span style="color:#777;font-size:12px">Changes persist across page reloads.</span>
                    </div>
                </div>

                <div style="margin-top:30px">
                    <h3 style="color:#25D366;margin-bottom:15px">ðŸ“² WhatsApp Broadcast Messages</h3>
                    <p style="color:#555;font-size:13px;margin-bottom:15px">Preview and copy messages for WhatsApp broadcast:</p>
                    <div style="display:flex;gap:15px;flex-wrap:wrap">
                        <button onclick="copyQuizWhatsAppMsg()" style="background:#25D366;color:white;border:none;padding:12px 24px;border-radius:8px;cursor:pointer;font-weight:700">
                            ðŸ“‹ Copy Quiz WhatsApp Message
                        </button>
                        <button onclick="copyScavengerWhatsAppMsg()" style="background:#128C7E;color:white;border:none;padding:12px 24px;border-radius:8px;cursor:pointer;font-weight:700">
                            ðŸ“‹ Copy Scavenger Hunt WhatsApp Message
                        </button>
                    </div>
                </div>
            </div>
            <!-- END MANAGER PERMISSIONS PANEL -->

            <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                 VLOG ADMIN PANEL â€” Super Admin Only
                 Controls event activation, jury setup, monitoring visibility,
                 jury criteria, and leaderboard publishing for Vlog Challenge
            â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
            <div id="vlogAdminPanel" class="form-section super-admin-only" style="margin-top:20px">
                <h2 style="color:#833ab4;margin-bottom:6px">ðŸ“¹ Vlog Challenge â€” Super Admin Control</h2>
                <p style="color:#888;margin-bottom:20px;font-size:.9em">All Vlog Challenge settings, event activation, jury setup, and score management live here. Nothing is visible to CRs or Jury until you activate it.</p>

                <!-- â”€â”€ EVENT ACTIVATION â”€â”€ -->
                <div style="background:linear-gradient(135deg,#fff3e0,#fce4ec);border-radius:14px;padding:20px;margin-bottom:20px;border:2px solid #ffab40">
                    <h3 style="color:#e65100;margin:0 0 12px;font-size:1.05em">ðŸ” Event Activation & Visibility</h3>
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px" class="vlog-admin-grid">
                        <div style="background:white;border-radius:10px;padding:14px;border:1px solid #ffe0b2">
                            <div style="font-weight:700;color:#333;font-size:0.9em;margin-bottom:8px">ðŸ“¹ Vlog Event Active?</div>
                            <div style="color:#666;font-size:0.8em;margin-bottom:10px">When OFF â€” CRs see "Event not yet started". When ON â€” submissions open.</div>
                            <div style="display:flex;gap:10px">
                                <button class="btn btn-success" onclick="setVlogSetting('eventActive', true)" style="flex:1;font-size:0.85em">âœ… Activate</button>
                                <button class="btn btn-danger" onclick="setVlogSetting('eventActive', false)" style="flex:1;font-size:0.85em">ðŸ”’ Deactivate</button>
                            </div>
                            <div id="vlogStatusEventActive" style="margin-top:8px;font-size:0.82em;font-weight:700;color:#666">Loadingâ€¦</div>
                        </div>
                        <div style="background:white;border-radius:10px;padding:14px;border:1px solid #ffe0b2">
                            <div style="font-weight:700;color:#333;font-size:0.9em;margin-bottom:8px">ðŸ“Š Monitoring Visible to CRs?</div>
                            <div style="color:#666;font-size:0.8em;margin-bottom:10px">When ON â€” each CR can see social score tracking for their class teams.</div>
                            <div style="display:flex;gap:10px">
                                <button class="btn btn-success" onclick="setVlogSetting('monitoringVisible', true)" style="flex:1;font-size:0.85em">ðŸ‘ Show</button>
                                <button class="btn btn-secondary" onclick="setVlogSetting('monitoringVisible', false)" style="flex:1;font-size:0.85em">ðŸ™ˆ Hide</button>
                            </div>
                            <div id="vlogStatusMonitoringVisible" style="margin-top:8px;font-size:0.82em;font-weight:700;color:#666">Loadingâ€¦</div>
                        </div>
                        <div style="background:white;border-radius:10px;padding:14px;border:1px solid #ffe0b2">
                            <div style="font-weight:700;color:#333;font-size:0.9em;margin-bottom:8px">ðŸ† Leaderboard Published?</div>
                            <div style="color:#666;font-size:0.8em;margin-bottom:10px">When ON â€” Vlog results appear in the main leaderboard / Event Results.</div>
                            <div style="display:flex;gap:10px">
                                <button class="btn btn-success" onclick="setVlogSetting('leaderboardPublished', true)" style="flex:1;font-size:0.85em">ðŸš€ Publish</button>
                                <button class="btn btn-secondary" onclick="setVlogSetting('leaderboardPublished', false)" style="flex:1;font-size:0.85em">ðŸ“¦ Unpublish</button>
                            </div>
                            <div id="vlogStatusLeaderboardPublished" style="margin-top:8px;font-size:0.82em;font-weight:700;color:#666">Loadingâ€¦</div>
                        </div>
                        <div style="background:white;border-radius:10px;padding:14px;border:1px solid #ffe0b2">
                            <div style="font-weight:700;color:#333;font-size:0.9em;margin-bottom:8px">ðŸ”– Official Hashtag</div>
                            <div style="color:#666;font-size:0.8em;margin-bottom:10px">Update the hashtag â€” auto-syncs to CR form and monitoring.</div>
                            <div style="display:flex;gap:8px">
                                <input type="text" id="vlogHashtagInput" placeholder="#SpurthiVlogChallenge2026" style="flex:1;padding:8px 10px;border:2px solid #ddd;border-radius:8px;font-size:0.88em;outline:none">
                                <button class="btn btn-small" onclick="saveVlogHashtag()" style="background:#833ab4;color:white;border:none;white-space:nowrap">ðŸ’¾ Save</button>
                            </div>
                            <div id="vlogStatusHashtag" style="margin-top:8px;font-size:0.82em;font-weight:700;color:#666">Loadingâ€¦</div>
                        </div>
                    </div>
                </div>

                <!-- â”€â”€ SOCIAL SCORE FORMULA SETTINGS â”€â”€ -->
                <div style="background:linear-gradient(135deg,#fce4ec,#f3e5f5);border-radius:14px;padding:20px;margin-bottom:20px;border:2px solid #f48fb1">
                    <h3 style="color:#880e4f;margin:0 0 10px;font-size:1.05em">ðŸ“Š Social Score Formula â€” Weightage Settings</h3>
                    <p style="color:#555;font-size:0.82em;margin:0 0 14px;line-height:1.6">
                        Chandan G B manually enters <strong>Views, Likes, Comments</strong> from each team's Instagram insight screenshot daily (02-03-2026 to 07-03-2026).<br>
                        The formula: <code style="background:#fff;padding:2px 6px;border-radius:4px;font-size:0.9em">Social Score = (Views Ã— Wâ‚) + (Likes Ã— Wâ‚‚) + (Comments Ã— Wâ‚ƒ)</code> â†’ normalised to 50 marks.<br>
                        Set the weights below. Default: Views=1, Likes=3, Comments=5 (comments signal deepest engagement).
                    </p>
                    <div style="display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:12px" class="vlog-admin-grid">
                        <div>
                            <label style="font-size:0.82em;font-weight:700;color:#444;display:block;margin-bottom:5px">Views Weight (Wâ‚)</label>
                            <input type="number" id="ssWeightViews" min="0" max="10" step="0.1" value="1" placeholder="1" style="width:100%;padding:8px 10px;border:2px solid #f48fb1;border-radius:8px;font-size:0.9em;outline:none;text-align:center">
                        </div>
                        <div>
                            <label style="font-size:0.82em;font-weight:700;color:#444;display:block;margin-bottom:5px">Likes Weight (Wâ‚‚)</label>
                            <input type="number" id="ssWeightLikes" min="0" max="10" step="0.1" value="3" placeholder="3" style="width:100%;padding:8px 10px;border:2px solid #f48fb1;border-radius:8px;font-size:0.9em;outline:none;text-align:center">
                        </div>
                        <div>
                            <label style="font-size:0.82em;font-weight:700;color:#444;display:block;margin-bottom:5px">Comments Weight (Wâ‚ƒ)</label>
                            <input type="number" id="ssWeightComments" min="0" max="10" step="0.1" value="5" placeholder="5" style="width:100%;padding:8px 10px;border:2px solid #f48fb1;border-radius:8px;font-size:0.9em;outline:none;text-align:center">
                        </div>
                        <div>
                            <label style="font-size:0.82em;font-weight:700;color:#444;display:block;margin-bottom:5px">Max Raw Score (for normalisation)</label>
                            <input type="number" id="ssMaxRaw" min="100" step="100" value="5000" placeholder="5000" style="width:100%;padding:8px 10px;border:2px solid #f48fb1;border-radius:8px;font-size:0.9em;outline:none;text-align:center">
                            <p style="font-size:0.72em;color:#888;margin:4px 0 0">Raw score Ã· Max Ã— 50 = Social %</p>
                        </div>
                    </div>
                    <div style="margin-top:14px;display:flex;gap:10px;align-items:center;flex-wrap:wrap">
                        <button class="btn btn-success" onclick="saveSocialFormula()" style="font-size:0.88em">ðŸ’¾ Save Formula</button>
                        <button class="btn btn-secondary" onclick="loadSocialFormula()" style="font-size:0.88em">ðŸ”„ Reload</button>
                        <span id="ssFormulaMsg" style="font-size:0.82em;font-weight:700;color:#155724;display:none"></span>
                    </div>
                    <div style="margin-top:14px;background:white;border-radius:8px;padding:12px;border:1px solid #e0c8f5">
                        <p style="font-size:0.8em;color:#555;margin:0;line-height:1.7">
                            ðŸ“ <strong>Why these weights?</strong><br>
                            <strong>Comments (Ã—5)</strong> â€” highest intent, viewer typed a response = deepest engagement<br>
                            <strong>Likes (Ã—3)</strong> â€” moderate intent, quick approval tap<br>
                            <strong>Views (Ã—1)</strong> â€” passive watch, still valuable but lowest intent<br>
                            This is the industry-standard weighted engagement formula used by Instagram analytics tools.
                        </p>
                    </div>
                </div>

                <!-- â”€â”€ ALL SUBMISSIONS (Super Admin view) â”€â”€ -->
                <div style="background:white;border-radius:14px;border:2px solid #e0c8f5;overflow:hidden">
                    <div style="background:linear-gradient(135deg,#833ab4,#fd1d1d);padding:14px 18px;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:8px">
                        <h4 style="color:white;margin:0;font-size:0.95em">ðŸ“‹ All Vlog Submissions â€” All Classes</h4>
                        <div style="display:flex;gap:8px;flex-wrap:wrap">
                            <select id="vlogAdminClassFilter" onchange="loadVlogAdminPanel()" style="padding:6px 10px;border-radius:8px;border:none;font-size:0.82em;color:#333">
                                <option value="">All Classes</option>
                            </select>
                            <button class="btn btn-small" onclick="loadVlogAdminPanel()" style="background:rgba(255,255,255,0.2);border:1px solid rgba(255,255,255,0.5);color:white;font-size:0.8em">ðŸ”„ Refresh</button>
                        </div>
                    </div>
                    <div style="padding:16px">
                        <div id="vlogAdminEmpty" style="text-align:center;color:#aaa;padding:30px;font-size:0.9em">No submissions yet.</div>
                        <div class="table-wrapper" style="margin:0;display:none" id="vlogAdminTableContainer">
                            <table>
                                <thead>
                                    <tr>
                                        <th>#</th>
                                        <th>Class</th>
                                        <th>Members</th>
                                        <th>Topic</th>
                                        <th>Reel</th>
                                        <th>Screenshot</th>
                                        <th>Handle</th>
                                        <th>Social Score</th>
                                        <th>Jury J1</th>
                                        <th>Jury J2</th>
                                        <th>Final %</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="vlogAdminTableBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            <!-- END VLOG ADMIN PANEL -->

            <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                 POD CASTING ADMIN PANEL
            â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
            <div id="podcastAdminPanel" class="form-section super-admin-only" style="margin-top:20px">
                <h2 style="color:#1db954;margin-bottom:6px">ðŸŽ™ï¸ Pod Casting â€” Super Admin Control</h2>
                <p style="color:#888;margin-bottom:20px;font-size:.9em">Activate the event, set jury criteria, publish results, and view all submissions.</p>

                <!-- Event Activation -->
                <div style="background:linear-gradient(135deg,#e8f5e9,#f1f8e9);border-radius:14px;padding:20px;margin-bottom:20px;border:2px solid #a5d6a7">
                    <h3 style="color:#1b5e20;margin:0 0 12px;font-size:1.05em">ðŸ” Event Activation & Visibility</h3>
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px" class="vlog-admin-grid">
                        <div style="background:white;border-radius:10px;padding:14px;border:1px solid #c8e6c9">
                            <div style="font-weight:700;color:#333;font-size:0.9em;margin-bottom:8px">ðŸŽ™ï¸ Podcast Event Active?</div>
                            <div style="color:#666;font-size:0.8em;margin-bottom:10px">When OFF â€” CRs see "Event not yet started". When ON â€” submissions open.</div>
                            <div style="display:flex;gap:10px">
                                <button class="btn btn-success" onclick="setPodcastSetting('eventActive', true)" style="flex:1;font-size:0.85em">âœ… Activate</button>
                                <button class="btn btn-danger" onclick="setPodcastSetting('eventActive', false)" style="flex:1;font-size:0.85em">ðŸ”’ Deactivate</button>
                            </div>
                            <div id="podcastStatusEventActive" style="margin-top:8px;font-size:0.82em;font-weight:700;color:#666">Loadingâ€¦</div>
                        </div>
                        <div style="background:white;border-radius:10px;padding:14px;border:1px solid #c8e6c9">
                            <div style="font-weight:700;color:#333;font-size:0.9em;margin-bottom:8px">ðŸ† Leaderboard Published?</div>
                            <div style="color:#666;font-size:0.8em;margin-bottom:10px">When ON â€” Podcast results appear in the main leaderboard.</div>
                            <div style="display:flex;gap:10px">
                                <button class="btn btn-success" onclick="setPodcastSetting('leaderboardPublished', true)" style="flex:1;font-size:0.85em">ðŸš€ Publish</button>
                                <button class="btn btn-secondary" onclick="setPodcastSetting('leaderboardPublished', false)" style="flex:1;font-size:0.85em">ðŸ“¦ Unpublish</button>
                            </div>
                            <div id="podcastStatusLeaderboardPublished" style="margin-top:8px;font-size:0.82em;font-weight:700;color:#666">Loadingâ€¦</div>
                        </div>
                    </div>
                </div>

                <!-- All Submissions -->
                <div style="background:white;border-radius:14px;border:2px solid #c8e6c9;overflow:hidden">
                    <div style="background:linear-gradient(135deg,#1db954,#191414);padding:14px 18px;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:8px">
                        <h4 style="color:white;margin:0;font-size:0.95em">ðŸŽ™ï¸ All Podcast Submissions</h4>
                        <button class="btn btn-small" onclick="loadPodcastAdminPanel()" style="background:rgba(255,255,255,0.2);border:1px solid rgba(255,255,255,0.5);color:white;font-size:0.8em">ðŸ”„ Refresh</button>
                    </div>
                    <div id="podcastAdminTableWrap" style="padding:16px">
                        <p style="color:#aaa;text-align:center;padding:20px">Click Refresh to load submissions.</p>
                    </div>
                </div>
            </div>
            <!-- END PODCAST ADMIN PANEL -->

            <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                 BOW RESULTS PUBLISHER PANEL (Super Admin Only)
            â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
            <div id="bowResultsPublisher" class="form-section super-admin-only" style="margin-top:20px">

                <!-- Header -->
                <div style="background:linear-gradient(135deg,#2e7d32,#66bb6a);border-radius:14px;padding:20px 24px;margin-bottom:20px;color:white;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:12px">
                    <div>
                        <h2 style="margin:0 0 4px;font-size:1.25em">â™»ï¸ Best Out of Waste â€” Results Publisher</h2>
                        <p style="margin:0;opacity:0.88;font-size:0.85em">Review final averaged scores from Jury 1 &amp; Jury 2 Â· Flag disputes Â· Publish results live</p>
                    </div>
                    <button onclick="bowRpLoad()" style="background:rgba(255,255,255,0.2);color:white;border:2px solid rgba(255,255,255,0.5);border-radius:8px;padding:9px 18px;font-size:0.88em;font-weight:700;cursor:pointer">ðŸ”„ Load / Refresh</button>
                </div>

                <!-- Publish Status Banner -->
                <div id="bowRpStatusBanner" style="display:none;border-radius:10px;padding:14px 18px;margin-bottom:16px;font-weight:700;font-size:0.92em;text-align:center"></div>

                <!-- Summary Stats -->
                <div id="bowRpStats" style="display:none;display:grid;grid-template-columns:repeat(auto-fill,minmax(130px,1fr));gap:12px;margin-bottom:20px">
                    <div style="background:white;border-radius:10px;padding:14px;text-align:center;box-shadow:0 2px 8px rgba(0,0,0,0.08);border-top:3px solid #6a1b9a">
                        <div id="bowRpTotalEntries" style="font-size:1.8em;font-weight:800;color:#6a1b9a">â€”</div>
                        <div style="color:#888;font-size:0.78em;font-weight:600">Total Entries</div>
                    </div>
                    <div style="background:white;border-radius:10px;padding:14px;text-align:center;box-shadow:0 2px 8px rgba(0,0,0,0.08);border-top:3px solid #2e7d32">
                        <div id="bowRpBothScored" style="font-size:1.8em;font-weight:800;color:#2e7d32">â€”</div>
                        <div style="color:#888;font-size:0.78em;font-weight:600">Both Juries Done</div>
                    </div>
                    <div style="background:white;border-radius:10px;padding:14px;text-align:center;box-shadow:0 2px 8px rgba(0,0,0,0.08);border-top:3px solid #f44336">
                        <div id="bowRpDisputes" style="font-size:1.8em;font-weight:800;color:#f44336">â€”</div>
                        <div style="color:#888;font-size:0.78em;font-weight:600">âš ï¸ Disputes</div>
                    </div>
                    <div style="background:white;border-radius:10px;padding:14px;text-align:center;box-shadow:0 2px 8px rgba(0,0,0,0.08);border-top:3px solid #1565c0">
                        <div id="bowRpTopClass" style="font-size:1.1em;font-weight:800;color:#1565c0">â€”</div>
                        <div style="color:#888;font-size:0.78em;font-weight:600">ðŸ¥‡ Leading</div>
                    </div>
                </div>

                <!-- BOW Enrollment Breakdown -->
                <div id="bowRpEnrollSection" style="display:none;background:white;border-radius:12px;box-shadow:0 2px 10px rgba(0,0,0,0.08);margin-bottom:20px;overflow:hidden">
                    <div style="background:linear-gradient(135deg,#e8f5e9,#f1f8e9);padding:12px 18px;border-bottom:2px solid #a5d6a7;display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:8px">
                        <h3 style="color:#2e7d32;margin:0;font-size:0.93em">ðŸ“‹ Total Enrollments â€” Class-wise Breakdown</h3>
                        <div style="display:flex;align-items:center;gap:8px">
                            <select id="bowRpEnrollFilter" onchange="bowRpFilterEnroll()" style="padding:5px 10px;border:1.5px solid #a5d6a7;border-radius:7px;font-size:0.82em;outline:none;background:white;font-weight:600;cursor:pointer">
                                <option value="">All Classes</option>
                            </select>
                            <button onclick="document.getElementById('bowRpEnrollFilter').value='';bowRpFilterEnroll()" style="background:#eee;border:none;border-radius:7px;padding:5px 11px;font-size:0.78em;font-weight:700;cursor:pointer;color:#555">âœ• Clear</button>
                        </div>
                    </div>
                    <div id="bowRpEnrollStats" style="display:grid;grid-template-columns:repeat(3,1fr);gap:0;border-bottom:1px solid #eee">
                        <div style="padding:12px;text-align:center;border-right:1px solid #eee">
                            <div id="bowRpEnrollTotal" style="font-size:1.6em;font-weight:900;color:#2e7d32">â€”</div>
                            <div style="font-size:0.72em;color:#888;font-weight:600">Total Enrolled</div>
                        </div>
                        <div style="padding:12px;text-align:center;border-right:1px solid #eee">
                            <div id="bowRpEnrollClasses" style="font-size:1.6em;font-weight:900;color:#6a1b9a">â€”</div>
                            <div style="font-size:0.72em;color:#888;font-weight:600">Classes Enrolled</div>
                        </div>
                        <div style="padding:12px;text-align:center">
                            <div id="bowRpEnrollAvg" style="font-size:1.6em;font-weight:900;color:#1565c0">â€”</div>
                            <div style="font-size:0.72em;color:#888;font-weight:600">Avg / Class</div>
                        </div>
                    </div>
                    <div id="bowRpEnrollList"></div>
                </div>

                <!-- Main Scores Table -->
                <div style="background:white;border-radius:12px;box-shadow:0 2px 10px rgba(0,0,0,0.08);margin-bottom:20px;overflow:hidden">
                    <div style="background:linear-gradient(135deg,#e8f5e9,#f1f8e9);padding:14px 20px;border-bottom:2px solid #a5d6a7;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:8px">
                        <h3 style="color:#2e7d32;margin:0;font-size:0.95em">ðŸ“Š Final Averaged Scores â€” All Entries</h3>
                        <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
                            <span style="font-size:0.78em;color:#666">Sort:</span>
                            <select id="bowRpSort" onchange="bowRpRenderTable()" style="padding:5px 10px;border:1px solid #a5d6a7;border-radius:6px;font-size:0.82em;outline:none;background:white">
                                <option value="rank">By Rank (Highâ†’Low)</option>
                                <option value="class">By Class Name</option>
                                <option value="dispute">Disputes First</option>
                            </select>
                        </div>
                    </div>
                    <div id="bowRpTableWrap" style="overflow-x:auto;padding:0">
                        <p style="color:#999;text-align:center;padding:40px">Click "Load / Refresh" to fetch jury scores.</p>
                    </div>
                </div>

                <!-- Dispute Flagged Entries -->
                <div id="bowRpDisputeSection" style="display:none;background:white;border-radius:12px;box-shadow:0 2px 10px rgba(0,0,0,0.08);margin-bottom:20px;overflow:hidden">
                    <div style="background:linear-gradient(135deg,#fff3e0,#fce4ec);padding:14px 20px;border-bottom:2px solid #ffcc02;display:flex;justify-content:space-between;align-items:center">
                        <h3 style="color:#e65100;margin:0;font-size:0.95em">âš ï¸ Flagged Disputes â€” Score Gap â‰¥ 15 pts</h3>
                        <span id="bowRpDisputeCount" style="background:#ffcc02;color:#333;padding:3px 12px;border-radius:20px;font-size:0.8em;font-weight:700"></span>
                    </div>
                    <div id="bowRpDisputeList" style="padding:16px;display:grid;gap:10px"></div>
                </div>

                <!-- â”€â”€ LEADERBOARD PUBLISH TOGGLE â”€â”€ -->
                <div style="background:white;border-radius:12px;box-shadow:0 2px 10px rgba(0,0,0,0.08);overflow:hidden;margin-bottom:20px">
                    <div style="background:linear-gradient(135deg,#e8f5e9,#f1f8e9);padding:14px 20px;border-bottom:2px solid #a5d6a7">
                        <h3 style="color:#2e7d32;margin:0;font-size:0.95em">ðŸ† Leaderboard Published?</h3>
                    </div>
                    <div style="padding:18px">
                        <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px" class="vlog-admin-grid">
                            <div>
                                <div style="color:#666;font-size:0.82em;margin-bottom:12px">When ON â€” BOW results appear in the main leaderboard / Class of the Year.</div>
                                <div style="display:flex;gap:10px">
                                    <button class="btn btn-success" onclick="bowSetLeaderboard(true)" style="flex:1;font-size:0.9em">ðŸš€ Publish</button>
                                    <button class="btn btn-secondary" onclick="bowSetLeaderboard(false)" style="flex:1;font-size:0.9em">ðŸ“¦ Unpublish</button>
                                </div>
                            </div>
                            <div style="display:flex;align-items:center">
                                <div id="bowLeaderboardStatusDisplay" style="background:#f5f5f5;border-radius:10px;padding:12px 18px;font-weight:700;font-size:0.92em;color:#666;width:100%;text-align:center">Loadingâ€¦</div>
                            </div>
                        </div>
                        <div id="bowLeaderboardMsg" style="display:none;margin-top:10px;padding:8px 12px;border-radius:8px;font-weight:700;font-size:0.85em"></div>
                    </div>
                </div>

                <!-- Publish Actions (score publish) -->
                <div style="background:white;border-radius:12px;box-shadow:0 2px 10px rgba(0,0,0,0.08);overflow:hidden">
                    <div style="background:linear-gradient(135deg,#e3f2fd,#e8eaf6);padding:14px 20px;border-bottom:2px solid #90caf9">
                        <h3 style="color:#1565c0;margin:0;font-size:0.95em">ðŸ“¢ Publish / Unpublish Results</h3>
                    </div>
                    <div style="padding:20px">
                        <p style="color:#555;font-size:0.88em;margin-bottom:18px">Once you are satisfied with all scores and disputes are resolved, press <strong>Publish</strong>. This makes BOW results visible to all admins in the Results tab.</p>
                        <div style="display:flex;gap:12px;flex-wrap:wrap">
                            <button onclick="bowRpPublish()" style="flex:1;min-width:180px;background:linear-gradient(135deg,#2e7d32,#66bb6a);color:white;border:none;border-radius:10px;padding:14px 20px;font-size:1em;font-weight:700;cursor:pointer;box-shadow:0 4px 12px rgba(46,125,50,0.3)">
                                âœ… Publish BOW Results
                            </button>
                            <button onclick="bowRpUnpublish()" style="flex:1;min-width:180px;background:#f5f5f5;color:#666;border:2px solid #ddd;border-radius:10px;padding:14px 20px;font-size:1em;font-weight:700;cursor:pointer">
                                âŒ Unpublish / Retract
                            </button>
                        </div>
                        <div id="bowRpPublishMsg" class="message" style="margin-top:14px"></div>
                    </div>
                </div>

            </div>
            <!-- END BOW RESULTS PUBLISHER PANEL -->

            <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                 NUKKAD NATAK ADMIN PANEL (Super Admin Only)
            â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
            <div id="nukkadAdminPanel" class="form-section super-admin-only" style="margin-top:20px;display:none">
                <h2 style="color:#1a237e;margin-bottom:6px">ðŸŽ­ Nukkad Natak â€” Super Admin Overview</h2>
                <p style="color:#888;margin-bottom:20px;font-size:.9em">Full overview of all enrolled classes, pre-event submissions, post-event submissions, jury scoring and verification status. Super Admin can override any action.</p>

                <!-- â”€â”€ EVENT ACTIVATION & LEADERBOARD PUBLISH â”€â”€ -->
                <div style="background:linear-gradient(135deg,#ede7f6,#e8eaf6);border-radius:14px;padding:20px;margin-bottom:20px;border:2px solid #b39ddb">
                    <h3 style="color:#4a148c;margin:0 0 12px;font-size:1.05em">ðŸ” Event Activation &amp; Leaderboard</h3>
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px" class="vlog-admin-grid">
                        <div style="background:white;border-radius:10px;padding:14px;border:1px solid #ce93d8">
                            <div style="font-weight:700;color:#333;font-size:0.9em;margin-bottom:8px">ðŸŽ­ Nukkad Natak Active?</div>
                            <div style="color:#666;font-size:0.8em;margin-bottom:10px">When ON â€” CR Pre/Post submission tabs are unlocked.</div>
                            <div style="display:flex;gap:10px">
                                <button class="btn btn-success" onclick="setNukkadSetting('eventActive', true)" style="flex:1;font-size:0.85em">âœ… Activate</button>
                                <button class="btn btn-danger" onclick="setNukkadSetting('eventActive', false)" style="flex:1;font-size:0.85em">ðŸ”’ Deactivate</button>
                            </div>
                            <div id="nukkadStatusEventActive" style="margin-top:8px;font-size:0.82em;font-weight:700;color:#666">Loadingâ€¦</div>
                        </div>
                        <div style="background:white;border-radius:10px;padding:14px;border:1px solid #ce93d8">
                            <div style="font-weight:700;color:#333;font-size:0.9em;margin-bottom:8px">ðŸ† Leaderboard Published?</div>
                            <div style="color:#666;font-size:0.8em;margin-bottom:10px">When ON â€” Nukkad Natak jury results appear in the main leaderboard.</div>
                            <div style="display:flex;gap:10px">
                                <button class="btn btn-success" onclick="setNukkadSetting('leaderboardPublished', true)" style="flex:1;font-size:0.85em">ðŸš€ Publish</button>
                                <button class="btn btn-secondary" onclick="setNukkadSetting('leaderboardPublished', false)" style="flex:1;font-size:0.85em">ðŸ“¦ Unpublish</button>
                            </div>
                            <div id="nukkadStatusLeaderboardPublished" style="margin-top:8px;font-size:0.82em;font-weight:700;color:#666">Loadingâ€¦</div>
                        </div>
                    </div>
                </div>

                <!-- Stats row -->
                <div style="display:grid;grid-template-columns:repeat(5,1fr);gap:10px;margin-bottom:20px">
                    <div style="background:white;border-radius:10px;padding:12px;text-align:center;border:2px solid #c5cae9">
                        <div style="font-size:1.5em;font-weight:900;color:#1a237e" id="nukkadAdminStatClasses">â€”</div>
                        <div style="font-size:0.78em;color:#666">Classes Enrolled</div>
                    </div>
                    <div style="background:white;border-radius:10px;padding:12px;text-align:center;border:2px solid #ce93d8">
                        <div style="font-size:1.5em;font-weight:900;color:#6a1b9a" id="nukkadAdminStatAdviser">â€”</div>
                        <div style="font-size:0.78em;color:#666">Adviser Submitted</div>
                    </div>
                    <div style="background:white;border-radius:10px;padding:12px;text-align:center;border:2px solid #a5d6a7">
                        <div style="font-size:1.5em;font-weight:900;color:#2e7d32" id="nukkadAdminStatPerm">â€”</div>
                        <div style="font-size:0.78em;color:#666">Permission Granted</div>
                    </div>
                    <div style="background:white;border-radius:10px;padding:12px;text-align:center;border:2px solid #ffcc80">
                        <div style="font-size:1.5em;font-weight:900;color:#e65100" id="nukkadAdminStatYt">â€”</div>
                        <div style="font-size:0.78em;color:#666">YouTube Verified</div>
                    </div>
                    <div style="background:white;border-radius:10px;padding:12px;text-align:center;border:2px solid #80cbc4">
                        <div style="font-size:1.5em;font-weight:900;color:#00695c" id="nukkadAdminStatNews">â€”</div>
                        <div style="font-size:0.78em;color:#666">Newspaper Verified</div>
                    </div>
                </div>

                <!-- â”€â”€ JURY SCORING PANEL â”€â”€ -->
                <div style="background:white;border-radius:14px;border:2px solid #c5cae9;overflow:hidden;margin-bottom:20px">
                    <div style="background:linear-gradient(135deg,#1a237e,#4a148c);padding:14px 18px">
                        <h4 style="color:white;margin:0;font-size:0.95em">ðŸ‘¨â€âš–ï¸ Nukkad Natak Jury Scoring Panel</h4>
                        <p style="color:rgba(255,255,255,0.8);margin:4px 0 0;font-size:0.82em">5 criteria Ã— 10 marks = 50 each. Super Admin can enter scores directly below.</p>
                    </div>
                    <div style="padding:18px">
                        <!-- Unified jury notice -->
                        <div style="background:#e8f5e9;border:2px solid #a5d6a7;border-radius:10px;padding:12px 16px;margin-bottom:16px;display:flex;align-items:center;gap:12px;flex-wrap:wrap">
                            <span style="font-size:1.4em">â„¹ï¸</span>
                            <div>
                                <div style="font-weight:700;color:#1b5e20;font-size:0.88em">Jury members use the Common Jury Login</div>
                                <div style="color:#2e7d32;font-size:0.82em;margin-top:2px">Jury 1 &amp; Jury 2 should log in from the <strong>main login screen â†’ select "Nukkad Natak"</strong> as the event. No separate login needed here.</div>
                            </div>
                        </div>
                        <!-- Super Admin direct scoring (always visible to super admin) -->
                        <div id="nukkadJuryScoringPanel" style="display:block">
                            <div style="background:#ede7f6;border-radius:8px;padding:10px 14px;margin-bottom:14px;font-size:0.88em;font-weight:700;color:#4a148c">
                                ðŸ” Super Admin â€” Direct Score Entry for Nukkad Natak
                            </div>
                            <p style="font-size:0.82em;color:#666;margin-bottom:14px">Score each class's Nukkad Natak performance on 5 criteria (0â€“10 each = 50 total). Score is saved per class.</p>
                            <div id="nukkadJuryScoringList"></div>
                            <button onclick="loadNukkadJuryScoringPanel()" style="background:#4a148c;color:white;border:none;border-radius:8px;padding:8px 18px;font-size:0.82em;font-weight:700;cursor:pointer;margin-top:8px">ðŸ”„ Load / Refresh Scoring</button>
                        </div>
                    </div>
                </div>

                <!-- All Nukkad Submissions Table -->
                <div style="background:white;border-radius:14px;border:2px solid #c5cae9;overflow:hidden">
                    <div style="background:linear-gradient(135deg,#1a237e,#7b1fa2);padding:14px 18px;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:8px">
                        <h4 style="color:white;margin:0;font-size:0.95em">ðŸ“‹ All Nukkad Natak Submissions â€” All Classes</h4>
                        <div style="display:flex;gap:8px;flex-wrap:wrap">
                            <select id="nukkadAdminClassFilter" onchange="loadNukkadAdminPanel()" style="padding:6px 10px;border-radius:8px;border:none;font-size:0.82em;color:#333">
                                <option value="">All Classes</option>
                            </select>
                            <button onclick="loadNukkadAdminPanel()" style="background:rgba(255,255,255,0.2);border:1px solid rgba(255,255,255,0.5);color:white;font-size:0.8em;padding:5px 12px;border-radius:8px;cursor:pointer;font-weight:700">ðŸ”„ Refresh</button>
                        </div>
                    </div>
                    <div style="padding:16px">
                        <div id="nukkadAdminEmpty" style="text-align:center;color:#aaa;padding:30px;font-size:0.9em">Click Refresh to load data.</div>
                        <div class="table-wrapper" style="margin:0;display:none" id="nukkadAdminTableContainer">
                            <table>
                                <thead>
                                    <tr>
                                        <th>#</th>
                                        <th>Class</th>
                                        <th>Theme / Cause</th>
                                        <th>Members</th>
                                        <th style="background:#6a1b9a">Adviser Name</th>
                                        <th style="background:#6a1b9a">Media House</th>
                                        <th style="background:#1a237e">Permission</th>
                                        <th style="background:#1a237e">Slot</th>
                                        <th style="background:#c62828">YouTube</th>
                                        <th style="background:#2e7d32">Newspaper</th>
                                        <th style="background:#4a148c">Form Link</th>
                                        <th style="background:#1565c0">Jury J1</th>
                                        <th style="background:#1565c0">Jury J2</th>
                                        <th style="background:#1b5e20">Final %</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="nukkadAdminTableBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <span id="nukkadAdminBadge" style="display:none"></span>
            </div>
            <!-- END NUKKAD NATAK ADMIN PANEL -->

            <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                 HAND WRITING ADMIN PANEL (Super Admin Only)
            â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
            <div id="hwAdminPanel" class="form-section super-admin-only" style="margin-top:20px;display:none">
                <h2 style="color:#1a237e;margin-bottom:6px">âœï¸ Hand Writing â€” Super Admin Panel</h2>
                <p style="color:#888;margin-bottom:20px;font-size:.9em">View all enrolled participants with sitting codes, attendance status and jury results. Publish to leaderboard when ready.</p>

                <!-- Leaderboard Publish -->
                <div style="background:linear-gradient(135deg,#e8eaf6,#ede7f6);border-radius:14px;padding:18px;margin-bottom:20px;border:2px solid #b39ddb">
                    <h3 style="color:#4a148c;margin:0 0 12px;font-size:1.05em">ðŸ† Leaderboard Published?</h3>
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px" class="vlog-admin-grid">
                        <div>
                            <div style="color:#666;font-size:0.82em;margin-bottom:12px">When ON â€” Hand Writing results appear in the main leaderboard / Class of the Year.</div>
                            <div style="display:flex;gap:10px">
                                <button class="btn btn-success" onclick="hwSetLeaderboard(true)" style="flex:1;font-size:0.9em">ðŸš€ Publish</button>
                                <button class="btn btn-secondary" onclick="hwSetLeaderboard(false)" style="flex:1;font-size:0.9em">ðŸ“¦ Unpublish</button>
                            </div>
                        </div>
                        <div style="display:flex;align-items:center">
                            <div id="hwLeaderboardStatusDisplay" style="background:#f5f5f5;border-radius:10px;padding:12px 18px;font-weight:700;font-size:0.92em;color:#666;width:100%;text-align:center">Loadingâ€¦</div>
                        </div>
                    </div>
                    <div id="hwLeaderboardMsg" style="display:none;margin-top:10px;padding:8px 12px;border-radius:8px;font-weight:700;font-size:0.85em"></div>
                </div>

                <!-- Stats -->
                <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-bottom:20px">
                    <div style="background:white;border-radius:10px;padding:12px;text-align:center;border:2px solid #c5cae9">
                        <div style="font-size:1.5em;font-weight:900;color:#1a237e" id="hwAdminStatTotal">â€”</div>
                        <div style="font-size:0.78em;color:#666">Total Enrolled</div>
                    </div>
                    <div style="background:white;border-radius:10px;padding:12px;text-align:center;border:2px solid #a5d6a7">
                        <div style="font-size:1.5em;font-weight:900;color:#2e7d32" id="hwAdminStatPresent">â€”</div>
                        <div style="font-size:0.78em;color:#666">âœ… Present</div>
                    </div>
                    <div style="background:white;border-radius:10px;padding:12px;text-align:center;border:2px solid #ef9a9a">
                        <div style="font-size:1.5em;font-weight:900;color:#c62828" id="hwAdminStatAbsent">â€”</div>
                        <div style="font-size:0.78em;color:#666">âŒ Absent</div>
                    </div>
                    <div style="background:white;border-radius:10px;padding:12px;text-align:center;border:2px solid #ffe082">
                        <div style="font-size:1.5em;font-weight:900;color:#f57f17" id="hwAdminStatScored">â€”</div>
                        <div style="font-size:0.78em;color:#666">ðŸ… Scored by Jury</div>
                    </div>
                </div>

                <!-- All Participants Table -->
                <div style="background:white;border-radius:14px;border:2px solid #c5cae9;overflow:hidden">
                    <div style="background:linear-gradient(135deg,#1a237e,#4a148c);padding:14px 18px;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:8px">
                        <h4 style="color:white;margin:0;font-size:0.95em">ðŸ“‹ All Hand Writing Participants</h4>
                        <div style="display:flex;gap:8px;flex-wrap:wrap">
                            <select id="hwAdminClassFilter" onchange="loadHwAdminPanel()" style="padding:6px 10px;border-radius:8px;border:none;font-size:0.82em;color:#333">
                                <option value="">All Classes</option>
                            </select>
                            <select id="hwAdminStatusFilter" onchange="loadHwAdminPanel()" style="padding:6px 10px;border-radius:8px;border:none;font-size:0.82em;color:#333">
                                <option value="">All Statuses</option>
                                <option value="present">âœ… Present</option>
                                <option value="absent">âŒ Absent</option>
                                <option value="pending">â³ Not Marked</option>
                            </select>
                            <button onclick="loadHwAdminPanel()" style="background:rgba(255,255,255,0.2);border:1px solid rgba(255,255,255,0.5);color:white;font-size:0.8em;padding:5px 12px;border-radius:8px;cursor:pointer;font-weight:700">ðŸ”„ Refresh</button>
                            <button onclick="forceRegenerateSittingCodes('Hand Writing')" style="background:#f9a825;border:none;color:#212121;font-size:0.8em;padding:5px 12px;border-radius:8px;cursor:pointer;font-weight:700" title="Fix duplicate sitting codes">ðŸ” Regenerate Codes</button>
                        </div>
                    </div>
                    <div style="padding:16px">
                        <div id="hwAdminEmpty" style="text-align:center;color:#aaa;padding:30px;font-size:0.9em">Click Refresh to load data.</div>
                        <div class="table-wrapper" style="margin:0;display:none" id="hwAdminTableContainer">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Sitting Code</th>
                                        <th>Name</th>
                                        <th>Class</th>
                                        <th>Language</th>
                                        <th>Attendance</th>
                                        <th style="background:#1565c0">Jury J1</th>
                                        <th style="background:#1565c0">Jury J2</th>
                                        <th style="background:#1b5e20">Final Score</th>
                                        <th>Rank</th>
                                    </tr>
                                </thead>
                                <tbody id="hwAdminTableBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            <!-- END HAND WRITING ADMIN PANEL -->

            <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                 TALENT HUNT ADMIN PANEL (Super Admin Only)
            â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
            <div id="thAdminPanel" class="form-section super-admin-only" style="margin-top:20px;display:none">
                <h2 style="color:#e65100;margin-bottom:6px">ðŸŽ­ Talent Hunt â€” Super Admin Panel</h2>
                <p style="color:#888;margin-bottom:20px;font-size:.9em">View all 6 enrolled individual participants with sitting codes, attendance and jury results. Publish to leaderboard when ready.</p>

                <!-- Leaderboard Publish -->
                <div style="background:linear-gradient(135deg,#fff8e1,#fce4ec);border-radius:14px;padding:18px;margin-bottom:20px;border:2px solid #ffcc80">
                    <h3 style="color:#e65100;margin:0 0 12px;font-size:1.05em">ðŸ† Leaderboard Published?</h3>
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px" class="vlog-admin-grid">
                        <div>
                            <div style="color:#666;font-size:0.82em;margin-bottom:12px">When ON â€” Talent Hunt results appear in the main leaderboard / Class of the Year.</div>
                            <div style="display:flex;gap:10px">
                                <button class="btn btn-success" onclick="thSetLeaderboard(true)" style="flex:1;font-size:0.9em">ðŸš€ Publish</button>
                                <button class="btn btn-secondary" onclick="thSetLeaderboard(false)" style="flex:1;font-size:0.9em">ðŸ“¦ Unpublish</button>
                            </div>
                        </div>
                        <div style="display:flex;align-items:center">
                            <div id="thLeaderboardStatusDisplay" style="background:#f5f5f5;border-radius:10px;padding:12px 18px;font-weight:700;font-size:0.92em;color:#666;width:100%;text-align:center">Loadingâ€¦</div>
                        </div>
                    </div>
                    <div id="thLeaderboardMsg" style="display:none;margin-top:10px;padding:8px 12px;border-radius:8px;font-weight:700;font-size:0.85em"></div>
                </div>

                <!-- Stats -->
                <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-bottom:20px">
                    <div style="background:white;border-radius:10px;padding:12px;text-align:center;border:2px solid #ffcc80">
                        <div style="font-size:1.5em;font-weight:900;color:#e65100" id="thAdminStatTotal">â€”</div>
                        <div style="font-size:0.78em;color:#666">Total Enrolled</div>
                    </div>
                    <div style="background:white;border-radius:10px;padding:12px;text-align:center;border:2px solid #a5d6a7">
                        <div style="font-size:1.5em;font-weight:900;color:#2e7d32" id="thAdminStatPresent">â€”</div>
                        <div style="font-size:0.78em;color:#666">âœ… Present</div>
                    </div>
                    <div style="background:white;border-radius:10px;padding:12px;text-align:center;border:2px solid #ef9a9a">
                        <div style="font-size:1.6em;font-weight:900;color:#c62828" id="thAdminStatAbsent">â€”</div>
                        <div style="font-size:0.78em;color:#666">âŒ Absent</div>
                    </div>
                    <div style="background:white;border-radius:10px;padding:12px;text-align:center;border:2px solid #ffe082">
                        <div style="font-size:1.5em;font-weight:900;color:#f57f17" id="thAdminStatScored">â€”</div>
                        <div style="font-size:0.78em;color:#666">ðŸ… Scored by Jury</div>
                    </div>
                </div>

                <!-- All Participants Table -->
                <div style="background:white;border-radius:14px;border:2px solid #ffcc80;overflow:hidden">
                    <div style="background:linear-gradient(135deg,#e65100,#ff6f00);padding:14px 18px;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:8px">
                        <h4 style="color:white;margin:0;font-size:0.95em">ðŸ“‹ All Talent Hunt Participants</h4>
                        <div style="display:flex;gap:8px;flex-wrap:wrap">
                            <select id="thAdminClassFilter" onchange="loadThAdminPanel()" style="padding:6px 10px;border-radius:8px;border:none;font-size:0.82em;color:#333">
                                <option value="">All Classes</option>
                            </select>
                            <select id="thAdminStatusFilter" onchange="loadThAdminPanel()" style="padding:6px 10px;border-radius:8px;border:none;font-size:0.82em;color:#333">
                                <option value="">All Statuses</option>
                                <option value="present">âœ… Present</option>
                                <option value="absent">âŒ Absent</option>
                                <option value="pending">â³ Not Marked</option>
                            </select>
                            <button onclick="loadThAdminPanel()" style="background:rgba(255,255,255,0.2);border:1px solid rgba(255,255,255,0.5);color:white;font-size:0.8em;padding:5px 12px;border-radius:8px;cursor:pointer;font-weight:700">ðŸ”„ Refresh</button>
                            <button onclick="forceRegenerateSittingCodes('Talent Hunt')" style="background:#f9a825;border:none;color:#212121;font-size:0.8em;padding:5px 12px;border-radius:8px;cursor:pointer;font-weight:700" title="Fix duplicate sitting codes">ðŸ” Regenerate Codes</button>
                        </div>
                    </div>
                    <div style="padding:16px">
                        <div id="thAdminEmpty" style="text-align:center;color:#aaa;padding:30px;font-size:0.9em">Click Refresh to load data.</div>
                        <div class="table-wrapper" style="margin:0;display:none" id="thAdminTableContainer">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Sitting Code</th>
                                        <th>Name</th>
                                        <th>Class</th>
                                        <th>Talent Type</th>
                                        <th>Attendance</th>
                                        <th style="background:#1565c0">Jury J1</th>
                                        <th style="background:#1565c0">Jury J2</th>
                                        <th style="background:#1b5e20">Final Score</th>
                                        <th>Rank</th>
                                    </tr>
                                </thead>
                                <tbody id="thAdminTableBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            <!-- END TALENT HUNT ADMIN PANEL -->
            <div id="ytAdAdminPanel" class="form-section super-admin-only" style="margin-top:20px">
                <h2 style="color:#cc0000;margin-bottom:6px">ðŸ“º YouTube Advertisement â€” Super Admin Control</h2>
                <p style="color:#888;margin-bottom:20px;font-size:.9em">Activate the event, manage jury scoring, enter social scores (Views + Likes + Original Comments), flag disputes, and publish results. Eligible classes: I BCA 'A' (1ST BCA) and II BCA 'A' (2ND BCA A SEC).</p>

                <!-- â”€â”€ EVENT ACTIVATION â”€â”€ -->
                <div style="background:linear-gradient(135deg,#fff3e0,#fce4ec);border-radius:14px;padding:20px;margin-bottom:20px;border:2px solid #ffab40">
                    <h3 style="color:#e65100;margin:0 0 12px;font-size:1.05em">ðŸ” Event Activation &amp; Visibility</h3>
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px" class="vlog-admin-grid">
                        <div style="background:white;border-radius:10px;padding:14px;border:1px solid #ffe0b2">
                            <div style="font-weight:700;color:#333;font-size:0.9em;margin-bottom:8px">ðŸ“º YT Ad Event Active?</div>
                            <div style="color:#666;font-size:0.8em;margin-bottom:10px">When OFF â€” CRs see "Event not yet started". When ON â€” submissions open.</div>
                            <div style="display:flex;gap:10px">
                                <button class="btn btn-success" onclick="setYtAdSetting('eventActive', true)" style="flex:1;font-size:0.85em">âœ… Activate</button>
                                <button class="btn btn-danger" onclick="setYtAdSetting('eventActive', false)" style="flex:1;font-size:0.85em">ðŸ”’ Deactivate</button>
                            </div>
                            <div id="ytAdStatusEventActive" style="margin-top:8px;font-size:0.82em;font-weight:700;color:#666">Loadingâ€¦</div>
                        </div>
                        <div style="background:white;border-radius:10px;padding:14px;border:1px solid #ffe0b2">
                            <div style="font-weight:700;color:#333;font-size:0.9em;margin-bottom:8px">ðŸ† Leaderboard Published?</div>
                            <div style="color:#666;font-size:0.8em;margin-bottom:10px">When ON â€” YT Ad results appear in the main leaderboard.</div>
                            <div style="display:flex;gap:10px">
                                <button class="btn btn-success" onclick="setYtAdSetting('leaderboardPublished', true)" style="flex:1;font-size:0.85em">ðŸš€ Publish</button>
                                <button class="btn btn-secondary" onclick="setYtAdSetting('leaderboardPublished', false)" style="flex:1;font-size:0.85em">ðŸ“¦ Unpublish</button>
                            </div>
                            <div id="ytAdStatusLeaderboardPublished" style="margin-top:8px;font-size:0.82em;font-weight:700;color:#666">Loadingâ€¦</div>
                        </div>
                    </div>
                </div>

                <!-- â”€â”€ SOCIAL SCORE FORMULA â”€â”€ -->
                <div style="background:linear-gradient(135deg,#fce4ec,#fff3e0);border-radius:14px;padding:20px;margin-bottom:20px;border:2px solid #f48fb1">
                    <h3 style="color:#880e4f;margin:0 0 10px;font-size:1.05em">ðŸ“Š Social Score Formula â€” YouTube Engagement Weights</h3>
                    <p style="color:#555;font-size:0.82em;margin:0 0 14px;line-height:1.6">
                        Roopa M C and Smitha M manually enter <strong>Views, Likes, Original Comments</strong> from each class's YouTube video.<br>
                        Formula: <code style="background:#fff;padding:2px 6px;border-radius:4px;font-size:0.9em">Social Score = (ViewsÃ—Wâ‚) + (LikesÃ—Wâ‚‚) + (Orig.CommentsÃ—Wâ‚ƒ)</code> â†’ normalised to 50 marks.<br>
                        <strong>Note:</strong> Only count <em>original/genuine comments</em> â€” filter out spam and bot comments.
                    </p>
                    <div style="display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:12px" class="vlog-admin-grid">
                        <div>
                            <label style="font-size:0.82em;font-weight:700;color:#444;display:block;margin-bottom:5px">Views Weight (Wâ‚)</label>
                            <input type="number" id="ytAdWeightViews" min="0" max="10" step="0.1" value="1" style="width:100%;padding:8px 10px;border:2px solid #f48fb1;border-radius:8px;font-size:0.9em;outline:none;text-align:center">
                        </div>
                        <div>
                            <label style="font-size:0.82em;font-weight:700;color:#444;display:block;margin-bottom:5px">Likes Weight (Wâ‚‚)</label>
                            <input type="number" id="ytAdWeightLikes" min="0" max="10" step="0.1" value="3" style="width:100%;padding:8px 10px;border:2px solid #f48fb1;border-radius:8px;font-size:0.9em;outline:none;text-align:center">
                        </div>
                        <div>
                            <label style="font-size:0.82em;font-weight:700;color:#444;display:block;margin-bottom:5px">Comments Weight (Wâ‚ƒ)</label>
                            <input type="number" id="ytAdWeightComments" min="0" max="10" step="0.1" value="5" style="width:100%;padding:8px 10px;border:2px solid #f48fb1;border-radius:8px;font-size:0.9em;outline:none;text-align:center">
                        </div>
                        <div>
                            <label style="font-size:0.82em;font-weight:700;color:#444;display:block;margin-bottom:5px">Max Raw Score (normalise)</label>
                            <input type="number" id="ytAdMaxRaw" min="100" step="100" value="5000" style="width:100%;padding:8px 10px;border:2px solid #f48fb1;border-radius:8px;font-size:0.9em;outline:none;text-align:center">
                            <p style="font-size:0.72em;color:#888;margin:4px 0 0">RawÃ·MaxÃ—50 = Social %</p>
                        </div>
                    </div>
                    <div style="margin-top:14px;display:flex;gap:10px;align-items:center;flex-wrap:wrap">
                        <button class="btn btn-success" onclick="saveYtAdFormula()" style="font-size:0.88em">ðŸ’¾ Save Formula</button>
                        <button class="btn btn-secondary" onclick="loadYtAdFormula()" style="font-size:0.88em">ðŸ”„ Reload</button>
                        <span id="ytAdFormulaMsg" style="font-size:0.82em;font-weight:700;color:#155724;display:none"></span>
                    </div>
                </div>

                <!-- â”€â”€ JURY SETUP INFO â”€â”€ -->
                <div style="background:linear-gradient(135deg,#e8eaf6,#e3f2fd);border-radius:14px;padding:20px;margin-bottom:20px;border:2px solid #9fa8da">
                    <h3 style="color:#1a237e;margin:0 0 10px;font-size:1.05em">ðŸ‘¨â€âš–ï¸ Jury Setup</h3>
                    <p style="color:#555;font-size:0.82em;margin:0 0 12px">Set up Jury 1 and Jury 2 credentials here. They will use these to log in and score each class's advertisement. Go to <strong>Jury Setup tab</strong> â†’ select "YouTube Advertisement" as the event to configure jury names and passwords.</p>
                    <div style="background:white;border-radius:8px;padding:12px;border:1px solid #c5cae9;font-size:0.82em;color:#333">
                        <div id="ytAdJurySetupStatus" style="color:#666">Loading jury setup statusâ€¦</div>
                    </div>
                </div>

                <!-- â”€â”€ ALL SUBMISSIONS â”€â”€ -->
                <div style="background:white;border-radius:14px;border:2px solid #ffcdd2;overflow:hidden">
                    <div style="background:linear-gradient(135deg,#cc0000,#ff6600);padding:14px 18px;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:8px">
                        <h4 style="color:white;margin:0;font-size:0.95em">ðŸ“‹ All YT Ad Submissions â€” All Classes</h4>
                        <div style="display:flex;gap:8px;flex-wrap:wrap">
                            <select id="ytAdAdminClassFilter" onchange="loadYtAdAdminPanel()" style="padding:6px 10px;border-radius:8px;border:none;font-size:0.82em;color:#333">
                                <option value="">All Classes</option>
                            </select>
                            <button class="btn btn-small" onclick="loadYtAdAdminPanel()" style="background:rgba(255,255,255,0.2);border:1px solid rgba(255,255,255,0.5);color:white;font-size:0.8em">ðŸ”„ Refresh</button>
                        </div>
                    </div>
                    <div style="padding:16px">
                        <div id="ytAdAdminEmpty" style="text-align:center;color:#aaa;padding:30px;font-size:0.9em">No submissions yet.</div>
                        <div class="table-wrapper" style="margin:0;display:none" id="ytAdAdminTableContainer">
                            <table>
                                <thead>
                                    <tr>
                                        <th>#</th>
                                        <th>Class</th>
                                        <th>Ad Title</th>
                                        <th>Product</th>
                                        <th>YouTube</th>
                                        <th>Views</th>
                                        <th>Likes</th>
                                        <th>Comments</th>
                                        <th>Social Score</th>
                                        <th>Jury J1</th>
                                        <th>Jury J2</th>
                                        <th>Final %</th>
                                        <th>Dispute</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="ytAdAdminTableBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- â”€â”€ JURY SCORING PANEL (for J1/J2 via Super Admin) â”€â”€ -->
                <div style="background:white;border-radius:14px;border:2px solid #c5cae9;overflow:hidden;margin-top:20px">
                    <div style="background:linear-gradient(135deg,#1a237e,#3949ab);padding:14px 18px">
                        <h4 style="color:white;margin:0;font-size:0.95em">ðŸ‘¨â€âš–ï¸ YT Ad Jury Scoring Panel</h4>
                        <p style="color:rgba(255,255,255,0.8);margin:4px 0 0;font-size:0.82em">Super Admin can enter scores directly below. 5 criteria = 50 marks total.</p>
                    </div>
                    <div style="padding:18px">
                        <!-- Unified jury notice -->
                        <div style="background:#e8f5e9;border:2px solid #a5d6a7;border-radius:10px;padding:12px 16px;margin-bottom:16px;display:flex;align-items:center;gap:12px;flex-wrap:wrap">
                            <span style="font-size:1.4em">â„¹ï¸</span>
                            <div>
                                <div style="font-weight:700;color:#1b5e20;font-size:0.88em">Jury members use the Common Jury Login</div>
                                <div style="color:#2e7d32;font-size:0.82em;margin-top:2px">Jury 1 &amp; Jury 2 should log in from the <strong>main login screen â†’ select "YouTube Advertisement"</strong> as the event. No separate login needed here.</div>
                            </div>
                        </div>

                        <!-- Jury Scoring Panel (always visible to super admin) -->
                        <div id="ytAdJuryScoringPanel" style="display:block">
                            <div style="background:#e8eaf6;border-radius:8px;padding:10px 14px;margin-bottom:14px;font-size:0.88em;font-weight:700;color:#1a237e">
                                ðŸ” Super Admin â€” Direct Score Entry for YouTube Advertisement
                            </div>
                            <p style="font-size:0.82em;color:#666;margin-bottom:14px">Score each class's YouTube ad on the criteria below (0â€“10 per criterion, 5 criteria = 50 total). Score is saved automatically per class.</p>
                            <div id="ytAdJuryScoringList"></div>
                            <button onclick="loadYtAdJuryScoringPanel()" style="background:#1a237e;color:white;border:none;border-radius:8px;padding:8px 18px;font-size:0.82em;font-weight:700;cursor:pointer;margin-top:8px">ðŸ”„ Load / Refresh Scoring</button>
                        </div>
                    </div>
                </div>

            </div>
            <!-- END YOUTUBE AD ADMIN PANEL -->

            <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                 FACULTY ADMIN PANEL
            â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
            <div id="facultyAdminPanel" class="form-section" style="margin-top:20px">
            <!-- Faculty Login -->
            <div style="background:linear-gradient(135deg,#e3f2fd,#e8eaf6);border-radius:14px;padding:20px;margin-top:20px;border:2px solid #90caf9">
                <h3 style="color:#1565c0;margin:0 0 8px;font-size:1em">ðŸ”‘ Faculty Login</h3>
                <p style="color:#555;font-size:0.83em;margin:0 0 14px">Select your name from the list â€” your phone number will be filled automatically. Enter your quiz registration password to log in.</p>
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:14px" class="vlog-admin-grid">
                    <div>
                        <label style="font-size:0.85em;font-weight:700;color:#444;display:block;margin-bottom:5px">Select Faculty Name <span style="color:red">*</span></label>
                        <select id="facultyLoginSelect" onchange="facultySelectChanged()" style="width:100%;padding:9px 12px;border:2px solid #ddd;border-radius:8px;font-size:0.9em;outline:none;transition:border 0.2s;background:white;color:#333" onfocus="this.style.borderColor='#1565c0'" onblur="this.style.borderColor='#ddd'">
                            <option value="">â€” Select your name â€”</option>
                        </select>
                        <div id="facultySelectedPhone" style="display:none;margin-top:6px;background:#e3f2fd;border-radius:6px;padding:6px 10px;font-size:0.82em;color:#1565c0;font-weight:700"></div>
                        <input type="hidden" id="facultyLoginPhone">
                    </div>
                    <div>
                        <label style="font-size:0.85em;font-weight:700;color:#444;display:block;margin-bottom:5px">Password <span style="color:red">*</span></label>
                        <div style="position:relative">
                            <input type="password" id="facultyLoginPwd" placeholder="Your quiz registration password" style="width:100%;padding:9px 40px 9px 12px;border:2px solid #ddd;border-radius:8px;font-size:0.9em;outline:none;transition:border 0.2s;box-sizing:border-box" onfocus="this.style.borderColor='#1565c0'" onblur="this.style.borderColor='#ddd'" onkeydown="if(event.key==='Enter') facultyLogin()">
                            <button type="button" onclick="toggleFacultyPwd()" style="position:absolute;right:10px;top:50%;transform:translateY(-50%);background:none;border:none;cursor:pointer;font-size:1em;color:#888" id="facultyPwdToggle">ðŸ‘</button>
                        </div>
                    </div>
                </div>
                <button class="btn" onclick="facultyLogin()" style="background:linear-gradient(135deg,#1565c0,#42a5f5);border:none;min-width:180px">ðŸ‘©â€ðŸ« Login as Faculty</button>
                <div style="margin-top:10px">
                    <label style="display:flex;align-items:center;gap:8px;cursor:pointer;font-size:0.88em;color:#555;font-weight:normal">
                        <input type="checkbox" id="facultyRememberMe" style="width:auto;accent-color:#1565c0"> ðŸ’¾ Remember my login on this device
                    </label>
                </div>
                <div id="facultyLoginMsg" style="display:none;margin-top:10px;padding:9px 12px;border-radius:8px;font-size:0.85em;font-weight:600"></div>
            </div>

        
                <!-- Super Admin toggle for Faculty panel -->
                <div class="super-admin-only" style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:10px;margin-bottom:14px">
                    <h2 style="color:#2196F3;margin:0">ðŸ‘©â€ðŸ« Faculty Incharge â€” Admin Panel</h2>
                    <button onclick="toggleFacultyAdminSection()" id="facultyAdminToggleBtn"
                            style="background:#e3f2fd;color:#1565c0;border:2px solid #90caf9;border-radius:10px;padding:7px 18px;font-size:0.85em;font-weight:700;cursor:pointer">
                        ðŸ‘ Show Panel
                    </button>
                </div>
                <p style="color:#888;margin-bottom:16px;font-size:.9em">All faculty incharges for Spurthi Youth Festival 2026 events. Super Admin sees full details including quiz passwords and all assigned events.</p>

                <!-- Faculty Admin content â€” hidden by default for super admin -->
                <div id="facultyAdminContent" style="display:none">

                <!-- Faculty Summary Cards (Super Admin sees all) -->
                <div id="facultyCardsSuperAdmin" class="super-admin-only" style="margin-bottom:20px">
                    <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:12px" id="facultyCardsGrid">
                        <!-- Cards injected by JS -->
                    </div>
                </div>

                <!-- Faculty Table (All admins see their own) -->
                <div style="background:white;border-radius:14px;border:2px solid #bbdefb;overflow:hidden">
                    <div style="background:linear-gradient(135deg,#1565c0,#42a5f5);padding:14px 18px;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:8px">
                        <h4 style="color:white;margin:0;font-size:0.95em">ðŸ“‹ Faculty Incharge Directory</h4>
                        <span class="super-admin-only" style="background:rgba(255,255,255,0.2);color:white;padding:3px 12px;border-radius:12px;font-size:0.78em;font-weight:700">Super Admin â€” Full View with Phone Numbers</span>
                    </div>
                    <div style="padding:16px">
                        <div class="table-wrapper" style="margin:0">
                            <table id="facultyTable">
                                <thead>
                                    <tr>
                                        <th>Sl.</th>
                                        <th>Faculty Name</th>
                                        <th>Class</th>
                                        <th class="super-admin-only">Phone</th>
                                        <th class="super-admin-only">Quiz Password</th>
                                        <th>Events Incharge</th>
                                        <th>Role</th>
                                    </tr>
                                </thead>
                                <tbody id="facultyTableBody">
                                    <!-- Injected by JS -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                </div><!-- /facultyAdminContent -->

                <!-- Faculty Dashboard (shown after login) -->
                <div id="facultyDashboard" style="display:none;margin-top:20px">
                    <div style="background:linear-gradient(135deg,#1565c0,#42a5f5);border-radius:12px;padding:16px 20px;margin-bottom:16px;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:10px">
                        <div>
                            <div style="color:white;font-weight:700;font-size:1.05em">Welcome, <span id="facultyDashName"></span> ðŸ‘©â€ðŸ«</div>
                            <div style="color:rgba(255,255,255,0.85);font-size:0.82em;margin-top:3px">Class Incharge â€” <span id="facultyDashClass"></span> &nbsp;|&nbsp; Role: <span id="facultyDashRole" style="background:rgba(255,255,255,0.2);padding:2px 10px;border-radius:12px;font-size:0.9em">Incharge</span></div>
                        </div>
                        <button class="btn btn-secondary btn-small" onclick="facultyLogout()">Logout</button>
                    </div>

                    <!-- Social Monitor Panel (only for Chandan G B) -->
                    <div id="chandanSocialPanel" style="display:none">
                        <div style="background:linear-gradient(135deg,#e8f5e9,#f3e5f5);border-radius:14px;padding:18px;border:2px solid #a5d6a7;margin-bottom:16px">
                            <h3 style="color:#1b5e20;margin:0 0 6px;font-size:1.05em">ðŸ“Š Vlog Challenge â€” Social Score Monitor</h3>
                            <p style="color:#555;font-size:0.82em;margin:0 0 10px">Enter daily Views, Likes, and Comments for each team from their Instagram Reel insight screenshots.<br>
                            <strong>Active Period: 02-03-2026 to 07-03-2026</strong> &nbsp;|&nbsp; You can update multiple times â€” the latest entry is used.</p>
                            <div id="chandanDateWarning" style="display:none;background:#fff3cd;border-radius:8px;padding:10px 14px;border-left:4px solid #ffc107;font-size:0.85em;color:#856404;margin-bottom:10px"></div>
                        </div>

                        <!-- Team cards with screenshot + metric entry -->
                        <div style="display:flex;justify-content:flex-end;margin-bottom:10px">
                            <button class="btn btn-secondary" onclick="loadChandanPanel()" style="font-size:0.85em">ðŸ”„ Refresh Teams</button>
                        </div>
                        <div id="chandanTeamList" style="display:flex;flex-direction:column;gap:16px">
                            <div style="text-align:center;color:#aaa;padding:30px">Loading Vlog submissionsâ€¦</div>
                        </div>

                    </div>

                    <!-- â”€â”€ Pod Casting Approval Panel (Chandan G B + Hemavathi Desai) â”€â”€ -->
                    <div id="chandanPodcastPanel" style="display:none;margin-top:24px">
                        <div style="background:linear-gradient(135deg,#e8f5e9,#e3f2fd);border-radius:14px;padding:18px;border:2px solid #a5d6a7;margin-bottom:16px">
                            <div style="display:flex;align-items:flex-start;justify-content:space-between;flex-wrap:wrap;gap:10px">
                                <div>
                                    <h3 style="color:#1b5e20;margin:0 0 4px;font-size:1.05em">ðŸŽ™ï¸ Pod Casting â€” Approval Panel</h3>
                                    <p style="color:#555;font-size:0.82em;margin:0">All enrolled participants shown below. Add sub-topic, then approve/reject the Spotify link once CR submits it.</p>
                                </div>
                                <div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap">
                                    <span id="podAutoRefreshBadge" style="background:#e3f2fd;color:#1565c0;border-radius:10px;padding:3px 10px;font-size:0.75em;font-weight:700">ðŸ”„ Auto-refresh: ON</span>
                                    <button onclick="loadChandanPodcastPanel()" style="background:#1b5e20;color:white;border:none;border-radius:8px;padding:6px 14px;font-size:0.82em;font-weight:700;cursor:pointer">ðŸ”„ Refresh Now</button>
                                </div>
                            </div>
                        </div>
                        <div id="chandanPodcastList" style="display:flex;flex-direction:column;gap:12px">
                            <div style="text-align:center;color:#aaa;padding:30px">Loading podcast enrollmentsâ€¦</div>
                        </div>
                    </div>

                    <!-- â”€â”€ Best Out of Waste â€” Entry Verification Panel (Shankar B C) â”€â”€ -->
                    <div id="shankarBowPanel" style="display:none;margin-top:24px">
                        <div style="background:linear-gradient(135deg,#fff8e1,#e8f5e9);border-radius:14px;padding:18px;border:2px solid #ffe082;margin-bottom:16px">
                            <h3 style="color:#e65100;margin:0 0 6px;font-size:1.05em">â™»ï¸ Best Out of Waste â€” Entry Verification</h3>
                            <p style="color:#555;font-size:0.82em;margin:0 0 6px">View all enrolled participants across all classes. Mark who actually showed up on event day as <strong>Present</strong> or <strong>Absent</strong>. Only <strong>Present</strong> entries will be forwarded to the Jury for scoring.</p>
                            <div style="background:#fff3cd;border-radius:8px;padding:8px 12px;font-size:0.8em;color:#856404;margin-top:8px">
                                âš ï¸ Once marked Present, the entry appears in the Jury sheet automatically. Absent entries are excluded.
                            </div>
                        </div>

                        <!-- Filter bar -->
                        <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-bottom:14px">
                            <select id="bowClassFilter" onchange="loadShankarBowPanel()" style="padding:8px 12px;border:2px solid #ffe082;border-radius:8px;font-size:0.88em;outline:none;background:white;color:#333;font-weight:600">
                                <option value="">All Classes</option>
                            </select>
                            <select id="bowStatusFilter" onchange="loadShankarBowPanel()" style="padding:8px 12px;border:2px solid #ffe082;border-radius:8px;font-size:0.88em;outline:none;background:white;color:#333;font-weight:600">
                                <option value="">All Statuses</option>
                                <option value="present">âœ… Present</option>
                                <option value="absent">âŒ Absent</option>
                                <option value="pending">â³ Not Marked</option>
                            </select>
                            <button class="btn btn-secondary" onclick="loadShankarBowPanel()" style="font-size:0.85em">ðŸ”„ Refresh</button>
                            <span id="bowSummaryBadge" style="background:#e8f5e9;color:#1b5e20;padding:4px 14px;border-radius:20px;font-size:0.82em;font-weight:700;margin-left:auto"></span>
                        </div>

                        <!-- Stats row -->
                        <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-bottom:16px" id="bowStatsRow">
                            <div style="background:white;border-radius:10px;padding:12px;text-align:center;border:2px solid #e0e0e0">
                                <div style="font-size:1.6em;font-weight:900;color:#1565c0" id="bowStatTotal">â€”</div>
                                <div style="font-size:0.78em;color:#666;font-weight:600">Total Enrolled</div>
                            </div>
                            <div style="background:white;border-radius:10px;padding:12px;text-align:center;border:2px solid #a5d6a7">
                                <div style="font-size:1.6em;font-weight:900;color:#2e7d32" id="bowStatPresent">â€”</div>
                                <div style="font-size:0.78em;color:#666;font-weight:600">âœ… Present</div>
                            </div>
                            <div style="background:white;border-radius:10px;padding:12px;text-align:center;border:2px solid #ef9a9a">
                                <div style="font-size:1.6em;font-weight:900;color:#c62828" id="bowStatAbsent">â€”</div>
                                <div style="font-size:0.78em;color:#666;font-weight:600">âŒ Absent</div>
                            </div>
                        </div>

                        <!-- Entries list -->
                        <div id="shankarBowList" style="display:flex;flex-direction:column;gap:10px">
                            <div style="text-align:center;color:#aaa;padding:30px">Loading entriesâ€¦</div>
                        </div>
                    </div>

                    <!-- â”€â”€ YouTube Advertisement â€” Social Score Monitor (Roopa M C & Smitha M) â”€â”€ -->
                    <div id="roopaSmitraYtAdPanel" style="display:none;margin-top:24px">
                        <div style="background:linear-gradient(135deg,#fce4ec,#fff3e0);border-radius:14px;padding:18px;border:2px solid #ffcdd2;margin-bottom:16px">
                            <h3 style="color:#c62828;margin:0 0 6px;font-size:1.05em">ðŸ“º YouTube Advertisement â€” Social Score Monitor</h3>
                            <p style="color:#555;font-size:0.82em;margin:0 0 8px">Check each class's YouTube video and enter the <strong>Views, Likes, and Original Comments</strong> (verify manually â€” exclude spam/bots). The score is auto-calculated based on the formula set by Super Admin.</p>
                            <div style="background:#fff3cd;border-radius:8px;padding:8px 12px;font-size:0.8em;color:#856404">
                                âš ï¸ <strong>Important:</strong> Only count <em>genuine original comments</em>. Ignore spam, bot comments, and repeated phrases. Quality over quantity.
                            </div>
                        </div>
                        <div id="ytAdMonitorList" style="display:flex;flex-direction:column;gap:16px">
                            <div style="text-align:center;color:#aaa;padding:30px">Loading YouTube Ad submissionsâ€¦</div>
                        </div>
                        <div style="margin-top:16px;text-align:center">
                            <button class="btn btn-secondary" onclick="loadYtAdMonitorPanel()" style="font-size:0.88em">ðŸ”„ Refresh All Classes</button>
                        </div>
                    </div>

                    <!-- â”€â”€ Nukkad Natak Pre-event Panel (Kotrappa K) â”€â”€ -->
                    <div id="nukkadPrePanel" style="display:none;margin-top:24px">
                        <div style="background:linear-gradient(135deg,#e8eaf6,#c5cae9);border-radius:14px;padding:18px;border:2px solid #9fa8da;margin-bottom:16px">
                            <h3 style="color:#1a237e;margin:0 0 6px;font-size:1.05em">ðŸŽ­ Nukkad Natak â€” Pre-Event Panel</h3>
                            <p style="color:#555;font-size:0.82em;margin:0 0 6px">View all enrolled teams, verify social awareness themes (check for duplicates across all classes), and issue permission slips with date/time clash detection.</p>
                        </div>
                        <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-bottom:14px">
                            <button onclick="loadNukkadPrePanel()" style="background:#3949ab;color:white;border:none;border-radius:8px;padding:8px 16px;font-weight:700;cursor:pointer;font-size:0.85em">ðŸ”„ Refresh</button>
                            <button onclick="loadNukkadOverviewTable()" style="background:#00695c;color:white;border:none;border-radius:8px;padding:8px 16px;font-weight:700;cursor:pointer;font-size:0.85em">ðŸ“Š Overview Table</button>
                            <span id="nukkadPreBadge" style="background:#e8eaf6;color:#1a237e;padding:4px 14px;border-radius:20px;font-size:0.82em;font-weight:700;margin-left:auto"></span>
                        </div>
                        <!-- All-in-one overview table (Point 5) -->
                        <div id="nukkadOverviewTable" style="margin-bottom:16px"></div>
                        <div id="nukkadPreList" style="display:flex;flex-direction:column;gap:12px">
                            <div style="text-align:center;color:#aaa;padding:30px">Loading Nukkad Natak enrollmentsâ€¦</div>
                        </div>
                    </div>

                    <!-- â”€â”€ Nukkad Natak Post-event Panel (Shankar B C) â”€â”€ -->
                    <div id="nukkadPostPanel" style="display:none;margin-top:24px">
                        <div style="background:linear-gradient(135deg,#fff3e0,#ffe0b2);border-radius:14px;padding:18px;border:2px solid #ffcc80;margin-bottom:16px">
                            <h3 style="color:#e65100;margin:0 0 6px;font-size:1.05em">ðŸŽ­ Nukkad Natak â€” Post-Event Verification</h3>
                            <p style="color:#555;font-size:0.82em;margin:0 0 6px">Verify YouTube video links and newspaper article photos submitted by each class. Verified submissions earn <strong>+10 pts</strong> each on the leaderboard.</p>
                        </div>
                        <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-bottom:14px">
                            <button onclick="loadNukkadPostPanel()" style="background:#e65100;color:white;border:none;border-radius:8px;padding:8px 16px;font-weight:700;cursor:pointer;font-size:0.85em">ðŸ”„ Refresh</button>
                            <span id="nukkadPostBadge" style="background:#fff3e0;color:#e65100;padding:4px 14px;border-radius:20px;font-size:0.82em;font-weight:700;margin-left:auto"></span>
                        </div>
                        <div id="nukkadPostList" style="display:flex;flex-direction:column;gap:12px">
                            <div style="text-align:center;color:#aaa;padding:30px">Loading post-event submissionsâ€¦</div>
                        </div>
                    </div>

                    <!-- â”€â”€ Handwriting Competition â€” Attendance Panel (Kotrappa K / Anitha N) â”€â”€ -->
                    <div id="hwAttendancePanel" style="display:none;margin-top:24px">
                        <div style="background:linear-gradient(135deg,#e8eaf6,#e3f2fd);border-radius:14px;padding:18px;border:2px solid #9fa8da;margin-bottom:16px">
                            <h3 style="color:#1a237e;margin:0 0 6px;font-size:1.05em">âœï¸ Handwriting Competition â€” Attendance &amp; Sitting Codes</h3>
                            <p style="color:#555;font-size:0.82em;margin:0 0 6px">View all enrolled participants. Each participant gets a unique 2-letter sitting code. Mark Present or Absent on event day. Codes are sent to Jury automatically.</p>
                            <div style="background:#e3f2fd;border-radius:8px;padding:8px 12px;font-size:0.8em;color:#1565c0;margin-top:8px">
                                ðŸ“… <strong>Event Date:</strong> 14th March 2026 @ 12:00 PM &nbsp;|&nbsp; ðŸ–Šï¸ Duration: 45 minutes
                            </div>
                        </div>
                        <!-- Filter bar -->
                        <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-bottom:14px">
                            <select id="hwClassFilter" onchange="loadHwAttendancePanel()" style="padding:8px 12px;border:2px solid #9fa8da;border-radius:8px;font-size:0.88em;outline:none;background:white;color:#333;font-weight:600">
                                <option value="">All Classes</option>
                            </select>
                            <select id="hwStatusFilter" onchange="loadHwAttendancePanel()" style="padding:8px 12px;border:2px solid #9fa8da;border-radius:8px;font-size:0.88em;outline:none;background:white;color:#333;font-weight:600">
                                <option value="">All Statuses</option>
                                <option value="present">âœ… Present</option>
                                <option value="absent">âŒ Absent</option>
                                <option value="pending">â³ Not Marked</option>
                            </select>
                            <button onclick="loadHwAttendancePanel()" style="background:#3949ab;color:white;border:none;border-radius:8px;padding:8px 16px;font-weight:700;cursor:pointer;font-size:0.85em">ðŸ”„ Refresh</button>
                            <span id="hwSummaryBadge" style="background:#e8eaf6;color:#1a237e;padding:4px 14px;border-radius:20px;font-size:0.82em;font-weight:700;margin-left:auto"></span>
                        </div>
                        <!-- Stats -->
                        <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-bottom:16px">
                            <div style="background:white;border-radius:10px;padding:12px;text-align:center;border:2px solid #c5cae9"><div style="font-size:1.6em;font-weight:900;color:#1a237e" id="hwStatTotal">â€”</div><div style="font-size:0.78em;color:#666;font-weight:600">Total Enrolled</div></div>
                            <div style="background:white;border-radius:10px;padding:12px;text-align:center;border:2px solid #a5d6a7"><div style="font-size:1.6em;font-weight:900;color:#2e7d32" id="hwStatPresent">â€”</div><div style="font-size:0.78em;color:#666;font-weight:600">âœ… Present</div></div>
                            <div style="background:white;border-radius:10px;padding:12px;text-align:center;border:2px solid #ef9a9a"><div style="font-size:1.6em;font-weight:900;color:#c62828" id="hwStatAbsent">â€”</div><div style="font-size:0.78em;color:#666;font-weight:600">âŒ Absent</div></div>
                        </div>
                        <div id="handwritingList" style="display:flex;flex-direction:column;gap:10px">
                            <div style="text-align:center;color:#aaa;padding:30px">Loading entriesâ€¦</div>
                        </div>
                    </div>

                    <!-- â”€â”€ Talent Hunt â€” Attendance Panel (Anitha N / Pooja C) â”€â”€ -->
                    <div id="thAttendancePanel" style="display:none;margin-top:24px">
                        <div style="background:linear-gradient(135deg,#fff8e1,#fce4ec);border-radius:14px;padding:18px;border:2px solid #ffcc02;margin-bottom:16px">
                            <h3 style="color:#e65100;margin:0 0 6px;font-size:1.05em">ðŸŽ­ Talent Hunt â€” Attendance &amp; Sitting Codes</h3>
                            <p style="color:#555;font-size:0.82em;margin:0 0 6px">View all enrolled individual performers. Each gets a unique 2-letter sitting code shared with Jury. Mark Present or Absent on event day.</p>
                            <div style="background:#fff3cd;border-radius:8px;padding:8px 12px;font-size:0.8em;color:#856404;margin-top:8px">
                                â±ï¸ <strong>Time Limit:</strong> 2 minutes per performance &nbsp;|&nbsp; Max 6 students total from college
                            </div>
                        </div>
                        <!-- Filter bar -->
                        <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-bottom:14px">
                            <select id="thClassFilter" onchange="loadThAttendancePanel()" style="padding:8px 12px;border:2px solid #ffcc02;border-radius:8px;font-size:0.88em;outline:none;background:white;color:#333;font-weight:600">
                                <option value="">All Classes</option>
                            </select>
                            <select id="thStatusFilter" onchange="loadThAttendancePanel()" style="padding:8px 12px;border:2px solid #ffcc02;border-radius:8px;font-size:0.88em;outline:none;background:white;color:#333;font-weight:600">
                                <option value="">All Statuses</option>
                                <option value="present">âœ… Present</option>
                                <option value="absent">âŒ Absent</option>
                                <option value="pending">â³ Not Marked</option>
                            </select>
                            <select id="thTalentFilter" onchange="loadThAttendancePanel()" style="padding:8px 12px;border:2px solid #ffcc02;border-radius:8px;font-size:0.88em;outline:none;background:white;color:#333;font-weight:600">
                                <option value="">All Talents</option>
                                <option value="Singing">ðŸŽ¤ Singing</option>
                                <option value="Dancing">ðŸ’ƒ Dancing</option>
                                <option value="Acting">ðŸŽ­ Acting</option>
                                <option value="Instrument">ðŸŽ¸ Instrument</option>
                                <option value="Mimicry">ðŸ˜„ Mimicry</option>
                                <option value="Magic">ðŸŽ© Magic</option>
                                <option value="Stand-up Comedy">ðŸ˜‚ Stand-up Comedy</option>
                                <option value="Other">â­ Other</option>
                            </select>
                            <button onclick="loadThAttendancePanel()" style="background:#e65100;color:white;border:none;border-radius:8px;padding:8px 16px;font-weight:700;cursor:pointer;font-size:0.85em">ðŸ”„ Refresh</button>
                            <span id="thSummaryBadge" style="background:#fff3cd;color:#e65100;padding:4px 14px;border-radius:20px;font-size:0.82em;font-weight:700;margin-left:auto"></span>
                        </div>
                        <!-- Stats -->
                        <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-bottom:16px">
                            <div style="background:white;border-radius:10px;padding:12px;text-align:center;border:2px solid #ffe082"><div style="font-size:1.6em;font-weight:900;color:#e65100" id="thStatTotal">â€”</div><div style="font-size:0.78em;color:#666;font-weight:600">Total Enrolled</div></div>
                            <div style="background:white;border-radius:10px;padding:12px;text-align:center;border:2px solid #a5d6a7"><div style="font-size:1.6em;font-weight:900;color:#2e7d32" id="thStatPresent">â€”</div><div style="font-size:0.78em;color:#666;font-weight:600">âœ… Present</div></div>
                            <div style="background:white;border-radius:10px;padding:12px;text-align:center;border:2px solid #ef9a9a"><div style="font-size:1.6em;font-weight:900;color:#c62828" id="thStatAbsent">â€”</div><div style="font-size:0.78em;color:#666;font-weight:600">âŒ Absent</div></div>
                        </div>
                        <div id="talentHuntList" style="display:flex;flex-direction:column;gap:10px">
                            <div style="text-align:center;color:#aaa;padding:30px">Loading entriesâ€¦</div>
                        </div>
                    </div>

                    <!-- â”€â”€ Group Dance Story Panel (Anitha N / Pooja C) â”€â”€ -->
                    <div id="danceInchargePanel" style="display:none;margin-top:24px">
                        <div style="background:linear-gradient(135deg,#fce4ec,#f3e5f5);border-radius:14px;padding:18px;border:2px solid #f48fb1;margin-bottom:16px">
                            <div style="display:flex;align-items:flex-start;justify-content:space-between;flex-wrap:wrap;gap:10px">
                                <div>
                                    <h3 style="color:#880e4f;margin:0 0 4px;font-size:1.05em">ðŸ’ƒ Group Dance â€” Story Submissions</h3>
                                    <p style="color:#555;font-size:0.82em;margin:0">All enrolled classes' dance story submissions. Each class must submit a title and 3â€“4 line summary of their story-based performance.</p>
                                </div>
                                <button onclick="loadDanceInchargePanel()" style="background:#e91e63;color:white;border:none;border-radius:8px;padding:6px 14px;font-size:0.82em;font-weight:700;cursor:pointer">ðŸ”„ Refresh</button>
                            </div>
                        </div>
                        <div id="danceInchargeList" style="display:flex;flex-direction:column;gap:14px">
                            <div style="text-align:center;color:#aaa;padding:30px">Loading dance story submissionsâ€¦</div>
                        </div>
                    </div>

                    <!-- â”€â”€ Generic Event Incharge Panel â€” shown for every faculty who has assigned events â”€â”€ -->
                    <div id="genericInchargePanel" style="display:none;margin-top:24px">
                        <div style="background:linear-gradient(135deg,#e8f5e9,#e3f2fd);border-radius:14px;padding:18px;border:2px solid #a5d6a7;margin-bottom:16px">
                            <h3 id="genericInchargePanelTitle" style="color:#1565c0;margin:0 0 6px;font-size:1.05em">ðŸ“‹ Event Incharge Panel</h3>
                            <p style="color:#555;font-size:0.82em;margin:0">Your assigned events are listed below. Each card shows enrolled participants per class with real-time counts from the database.</p>
                        </div>
                        <div id="genericInchargeEventList" style="display:flex;flex-direction:column;gap:16px">
                            <div style="text-align:center;color:#aaa;padding:30px">Loading your eventsâ€¦</div>
                        </div>
                    </div>

                    <!-- Default coming-soon: only shown if faculty truly has NO assigned events/panels at all -->
                    <div id="facultyComingSoon" style="background:#fffde7;border-left:4px solid #ffc107;border-radius:10px;padding:14px 16px;font-size:0.87em;color:#856404">
                        <strong>â„¹ï¸ Coming Soon:</strong> Your specific role and permissions will be assigned by the Super Admin shortly. Once assigned, you will see your class's relevant data and controls here.
                    </div>
                </div>

            </div>
            <!-- END FACULTY ADMIN PANEL -->

            <div id="firebaseDownloadMonitor" class="form-section super-admin-only" style="margin-top:20px">
                <h2 style="color:#c44569;margin-bottom:6px">ðŸ”¥ Firebase Download Monitor</h2>
                <p style="color:#888;margin-bottom:16px;font-size:.9em">Track your Firebase Storage 10 GB/day download limit. Manually log downloads or paste daily stats to visualise usage.</p>

                <!-- Info Box -->
                <div style="background:#fff3cd;border-radius:10px;padding:14px;border-left:5px solid #ffc107;margin-bottom:16px">
                    <p style="color:#856404;font-size:.88em;margin:0"><strong>â„¹ï¸ About the 10 GB Limit:</strong> Firebase Spark (free) plan allows <strong>10 GB of data downloaded per day</strong> from Firebase Storage. If exceeded, downloads are blocked until midnight Pacific Time. Realtime Database reads also count against bandwidth.</p>
                </div>

                <!-- Current Usage Entry -->
                <div style="background:#f9f5ff;border-radius:12px;padding:16px;margin-bottom:16px;border:1px solid #e0d0f0">
                    <p style="color:#6a1b9a;font-weight:700;margin-bottom:12px;font-size:.9em">ðŸ“¥ Log Today's Download Usage</p>
                    <div style="display:grid;grid-template-columns:1fr 1fr auto;gap:10px;align-items:end">
                        <div>
                            <label style="font-size:.8em;color:#888;display:block;margin-bottom:4px">Downloaded Today (GB)</label>
                            <input id="fdm-today-gb" type="number" min="0" max="10" step="0.01" placeholder="e.g. 3.5" style="width:100%;padding:8px 12px;border:1.5px solid #e0d0f0;border-radius:8px;font-size:.9em;outline:none">
                        </div>
                        <div>
                            <label style="font-size:.8em;color:#888;display:block;margin-bottom:4px">Date</label>
                            <input id="fdm-date" type="date" style="width:100%;padding:8px 12px;border:1.5px solid #e0d0f0;border-radius:8px;font-size:.9em;outline:none">
                        </div>
                        <button class="btn btn-success" onclick="fdmLogUsage()" style="height:38px;padding:0 18px;font-size:.88em">âž• Log</button>
                    </div>
                    <p style="color:#aaa;font-size:.76em;margin-top:8px">Get actual numbers from <strong>Firebase Console â†’ Storage â†’ Usage</strong> tab, or check your billing page.</p>
                </div>

                <!-- Live Gauge -->
                <div id="fdm-gauge-wrap" style="background:#f9f5ff;border-radius:12px;padding:20px;margin-bottom:16px">
                    <h3 style="color:#6a1b9a;margin-bottom:14px;font-size:1em">ðŸ“Š Today's Download Usage</h3>
                    <div style="display:flex;align-items:center;gap:16px;flex-wrap:wrap">
                        <div style="flex:1;min-width:200px">
                            <div style="display:flex;justify-content:space-between;margin-bottom:6px">
                                <span style="font-weight:700;color:#333;font-size:.88em">Downloads Used</span>
                                <span id="fdm-gauge-label" style="font-weight:700;color:#c44569;font-size:.88em">0 / 10 GB</span>
                            </div>
                            <div style="background:#e0e0e0;border-radius:20px;height:18px;overflow:hidden;position:relative">
                                <div id="fdm-gauge-bar" style="background:linear-gradient(90deg,#43e97b,#38f9d7);height:100%;width:0%;border-radius:20px;transition:width .7s ease"></div>
                                <!-- Danger zone marker at 80% -->
                                <div style="position:absolute;left:80%;top:0;height:100%;width:2px;background:rgba(255,100,0,.5)"></div>
                                <!-- Critical marker at 95% -->
                                <div style="position:absolute;left:95%;top:0;height:100%;width:2px;background:rgba(220,53,69,.7)"></div>
                            </div>
                            <div style="display:flex;justify-content:space-between;margin-top:4px">
                                <span style="font-size:.72em;color:#888">0 GB</span>
                                <span style="font-size:.72em;color:#e65100">âš ï¸ 8 GB</span>
                                <span style="font-size:.72em;color:#dc3545">ðŸš« 10 GB</span>
                            </div>
                        </div>
                        <div id="fdm-status-badge" style="background:#28a745;color:white;border-radius:50%;width:80px;height:80px;display:flex;flex-direction:column;align-items:center;justify-content:center;font-weight:700;font-size:.78em;text-align:center;flex-shrink:0">
                            <span style="font-size:1.6em">âœ…</span>
                            <span id="fdm-status-text">SAFE</span>
                        </div>
                    </div>
                    <p id="fdm-remaining-label" style="color:#888;font-size:.82em;margin-top:10px;text-align:center">No data logged yet. Use the form above to log usage.</p>
                </div>

                <!-- History Table -->
                <div>
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
                        <h3 style="color:#6a1b9a;font-size:1em;margin:0">ðŸ“… Download History (Last 7 Days)</h3>
                        <button class="btn btn-small" onclick="fdmClearHistory()" style="background:#dc3545;color:white;font-size:.78em">ðŸ—‘ï¸ Clear All</button>
                    </div>
                    <div style="overflow-x:auto">
                        <table style="width:100%;border-collapse:collapse;font-size:.85em">
                            <thead>
                                <tr style="background:linear-gradient(135deg,#c44569,#6a1b9a);color:white">
                                    <th style="padding:9px 12px;text-align:left;border-radius:8px 0 0 0">Date</th>
                                    <th style="padding:9px 12px;text-align:left">Downloaded</th>
                                    <th style="padding:9px 12px;text-align:left">% of Limit</th>
                                    <th style="padding:9px 12px;text-align:left">Status</th>
                                    <th style="padding:9px 12px;text-align:left;border-radius:0 8px 0 0">Action</th>
                                </tr>
                            </thead>
                            <tbody id="fdm-history-body">
                                <tr><td colspan="5" style="padding:16px;text-align:center;color:#aaa">No history yet.</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Tips -->
                <div style="margin-top:16px;background:#e8f4fd;border-radius:10px;padding:14px;border-left:5px solid #4facfe">
                    <p style="color:#0c5460;font-weight:700;margin-bottom:8px;font-size:.88em">ðŸ’¡ Tips to Reduce Downloads</p>
                    <ul style="color:#0c5460;font-size:.82em;margin:0;padding-left:18px;line-height:1.8">
                        <li>Use <strong>Cloudinary</strong> for images instead of Firebase Storage</li>
                        <li>Enable browser caching with proper Cache-Control headers</li>
                        <li>Compress images before uploading (use WebP format)</li>
                        <li>Avoid storing base64 images in Realtime Database (found by DB Inspector above)</li>
                        <li>Upgrade to Firebase Blaze (pay-as-you-go) if you need more than 10 GB/day</li>
                    </ul>
                </div>
            </div>
            <!-- ================================================ -->
            <!-- END FIREBASE DOWNLOAD MONITOR                    -->
            <!-- ================================================ -->
            </div>

            <div id="leaderboardAdmin" class="form-section super-admin-only" style="margin-top:20px">
                <h2 style="color:#ffd700;margin-bottom:12px;text-shadow:0 2px 8px rgba(0,0,0,0.4)">ðŸ† Leaderboard Management</h2>

                <!-- â”€â”€ WHO / WHAT detail banner â”€â”€ -->
                <div style="background:linear-gradient(135deg,#1a0030 0%,#3d0060 50%,#6a1b9a 100%);border-radius:14px;padding:22px 24px;margin-bottom:18px;border:2px solid rgba(255,215,0,0.35);box-shadow:0 6px 24px rgba(106,27,154,0.35)">
                    <div style="display:flex;align-items:center;gap:12px;margin-bottom:14px">
                        <span style="font-size:2em">ðŸ…</span>
                        <div>
                            <h3 style="color:#ffd700;margin:0;font-size:1.15em;letter-spacing:0.5px">Spurthi Youth Fest 2026 â€” Class of the Year</h3>
                            <p style="color:rgba(255,255,255,0.7);margin:3px 0 0;font-size:12px">Davan Institute of Advanced Management Studies, Davangere</p>
                        </div>
                    </div>
                    <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:10px;margin-bottom:14px">
                        <div style="background:rgba(255,255,255,0.08);border-radius:8px;padding:10px 14px;border-left:3px solid #ffd700">
                            <p style="color:#ffd700;font-size:11px;font-weight:700;margin:0 0 3px;text-transform:uppercase;letter-spacing:1px">Competition</p>
                            <p style="color:#fff;font-size:13px;margin:0">11 Teams competing across 16 Events</p>
                        </div>
                        <div style="background:rgba(255,255,255,0.08);border-radius:8px;padding:10px 14px;border-left:3px solid #c44569">
                            <p style="color:#ff8ab0;font-size:11px;font-weight:700;margin:0 0 3px;text-transform:uppercase;letter-spacing:1px">Event Period</p>
                            <p style="color:#fff;font-size:13px;margin:0">1st to 18th March 2026</p>
                        </div>
                        <div style="background:rgba(255,255,255,0.08);border-radius:8px;padding:10px 14px;border-left:3px solid #4caf50">
                            <p style="color:#a5d6a7;font-size:11px;font-weight:700;margin:0 0 3px;text-transform:uppercase;letter-spacing:1px">Points Sources</p>
                            <p style="color:#fff;font-size:13px;margin:0">YF Reg Â· Quiz Â· Event Results Â· Custom</p>
                        </div>
                        <div style="background:rgba(255,255,255,0.08);border-radius:8px;padding:10px 14px;border-left:3px solid #2196f3">
                            <p style="color:#90caf9;font-size:11px;font-weight:700;margin:0 0 3px;text-transform:uppercase;letter-spacing:1px">Declared By</p>
                            <p style="color:#fff;font-size:13px;margin:0">Super Admin Â· Spurthi Youth Fest Committee</p>
                        </div>
                    </div>
                    <p style="color:rgba(255,255,255,0.6);font-size:12px;margin:0;border-top:1px solid rgba(255,255,255,0.12);padding-top:10px">
                        âš ï¸ The leaderboard is <strong style="color:#ffd700">hidden from students</strong> until you publish it. Use the visibility toggle below to go live when results are final.
                    </p>
                </div>

                <p style="color:#555;margin-bottom:15px;font-size:13px;background:#fff3cd;padding:10px 16px;border-radius:8px;border-left:4px solid #ffc107">
                    âš™ï¸ Control what counts toward <strong style="color:#c44569">Class of the Year 2026</strong>. 
                    Event results are pulled automatically when published. You can also add custom criteria and assign points manually.
                </p>

                <!-- â”€â”€ PUBLISH TOGGLE â”€â”€ -->
                <div style="background:linear-gradient(135deg,#1a0030 0%,#6a1b9a 100%);padding:20px;border-radius:12px;margin-bottom:25px;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:15px">
                    <div>
                        <h3 style="color:#fff;margin:0 0 5px">ðŸ‘ Leaderboard Visibility</h3>
                        <p style="color:rgba(255,255,255,0.75);margin:0;font-size:13px">When hidden, students cannot see the leaderboard at all. Publish only when you are ready.</p>
                    </div>
                    <div style="display:flex;gap:10px;align-items:center">
                        <span id="lbVisibilityStatus" style="color:#ffd700;font-weight:700;font-size:1em">â³ Checkingâ€¦</span>
                        <button id="lbPublishBtn" class="btn btn-success" onclick="toggleLeaderboardPublish()" style="min-width:160px">ðŸ“¢ Publish Leaderboard</button>
                    </div>
                </div>

                <div id="lbAdminMessage" class="message"></div>

                <!-- â”€â”€ SECTION 1: Scoring Config â”€â”€ -->
                <div style="background:#f9f5ff;padding:20px;border-radius:12px;margin-bottom:25px;border:2px solid #e0d0ff">
                    <h3 style="color:#6a1b9a;margin-bottom:15px">âš™ï¸ Base Scoring Configuration</h3>
                    <p style="color:#666;font-size:13px;margin-bottom:15px">These values control how automatic points are calculated. Changes save instantly and affect the public leaderboard.</p>
                    <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:15px">
                        <div class="form-group" style="margin:0">
                            <label>ðŸŽ¤ Youthfest Reg: pts per event enrolled</label>
                            <input type="number" id="lbCfgYfPts" value="10" min="0" max="1000" style="border:2px solid #c44569">
                        </div>
                        <div class="form-group" style="margin:0">
                            <label>ðŸ† Youthfest Winner: pts per event win</label>
                            <input type="number" id="lbCfgWinPts" value="50" min="0" max="1000" style="border:2px solid #ffc107">
                        </div>
                        <div class="form-group" style="margin:0">
                            <label>ðŸ¥ˆ Youthfest Runner-Up: pts per event</label>
                            <input type="number" id="lbCfgRunPts" value="30" min="0" max="1000" style="border:2px solid #6c757d">
                        </div>
                    </div>

                    <!-- Quiz-specific scoring (new) -->
                    <div style="margin-top:18px;padding:15px;background:#e8f5e9;border-radius:10px;border:2px solid #a5d6a7">
                        <h4 style="color:#1b5e20;margin-bottom:12px">ðŸ§  Quiz Competition â€” Points per Daily Quiz Day</h4>
                        <p style="color:#333;font-size:12px;margin-bottom:14px">
                            Quiz points are awarded <strong>per published quiz day only</strong> (Super Admin must publish winner).<br>
                            Three criteria combine for each class on each published day:
                        </p>
                        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px">
                            <div class="form-group" style="margin:0">
                                <label style="color:#1b5e20">ðŸ¥‡ Quiz Daily Winner class gets (pts)</label>
                                <input type="number" id="lbCfgQuizWinPts" value="20" min="0" max="500" style="border:2px solid #4caf50">
                                <small style="color:#333">Flat bonus to the class of the declared daily winner</small>
                            </div>
                            <div class="form-group" style="margin:0">
                                <label style="color:#1b5e20">ðŸ¥ˆ Quiz Daily Runner-Up class gets (pts)</label>
                                <input type="number" id="lbCfgQuizRunPts" value="10" min="0" max="500" style="border:2px solid #81c784">
                                <small style="color:#333">Flat bonus to the class of the declared runner-up</small>
                            </div>
                            <div class="form-group" style="margin:0">
                                <label style="color:#1b5e20">ðŸ“Š Participation Rate bonus: max pts for 100% rate</label>
                                <input type="number" id="lbCfgQuizMaxPts" value="10" min="0" max="100" style="border:2px solid #66bb6a">
                                <small style="color:#333">Fair across class sizes â€” based on % of class that got max score</small>
                            </div>
                        </div>

                        <!-- Class strength setup -->
                        <div style="margin-top:14px;background:white;padding:14px;border-radius:8px;border:1px solid #a5d6a7">
                            <h5 style="color:#1b5e20;margin:0 0 10px">ðŸ« Set Class Strength (for fair participation rate)</h5>
                            <p style="color:#333;font-size:12px;margin-bottom:12px">
                                Enter the total number of students in each class. The participation rate bonus is calculated as:<br>
                                <strong style="color:#1b5e20">(Number of students who got max score in class Ã· Class Strength) Ã— Max Pts</strong><br>
                                This means a class of 35 and a class of 60 are judged equally fairly.
                            </p>
                            <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:8px" id="lbClassStrengthGrid">
                                <p style="color:#aaa;font-size:12px">Loadingâ€¦</p>
                            </div>
                            <div style="display:flex;align-items:center;gap:12px;flex-wrap:wrap;margin-top:10px">
                                <button class="btn btn-small btn-info" onclick="saveLbClassStrengths()">ðŸ’¾ Save Class Strengths</button>
                                <span id="lbStrSaveMsg" style="display:none;background:#d4edda;color:#155724;border:1px solid #c3e6cb;padding:7px 14px;border-radius:6px;font-size:13px;font-weight:600">âœ… Class strengths saved!</span>
                                <span id="lbStrErrMsg"  style="display:none;background:#f8d7da;color:#721c24;border:1px solid #f5c6cb;padding:7px 14px;border-radius:6px;font-size:13px;font-weight:600"></span>
                            </div>
                        </div>

                        <div style="margin-top:12px;background:#f1f8e9;padding:10px;border-radius:8px;border:1px solid #c5e1a5">
                            <p style="margin:0;color:#33691e;font-size:12px">
                                <strong>Example:</strong> Class "2ND BBA" has strength 35. On a quiz day, 7 students score max (2/2).<br>
                                Participation rate = 7/35 = 20%. Bonus = 20% Ã— 10 = <strong>2 pts</strong>.<br>
                                Class "1ST BCA" has strength 60. 12 students score max = 12/60 = 20% â†’ same 2 pts. âœ… Fair!
                            </p>
                        </div>
                    </div>
                    <!-- Scavenger Hunt scoring -->
                    <div style="margin-top:18px;padding:15px;background:#f3e5f5;border-radius:10px;border:2px solid #ce93d8">
                        <h4 style="color:#6a1b9a;margin-bottom:12px">ðŸ—ºï¸ Scavenger Hunt â€” Points</h4>
                        <p style="color:#444;font-size:12px;margin-bottom:14px">
                            Points are awarded automatically from Firebase data when scavenger hunt submissions are approved.<br>
                            Three criteria combine: task completion rate per class, winner class bonus, runner-up class bonus.
                        </p>
                        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px">
                            <div class="form-group" style="margin:0">
                                <label style="color:#6a1b9a">ðŸ¥‡ SH Winner class gets (pts)</label>
                                <input type="number" id="lbCfgShWinPts" value="30" min="0" max="500" style="border:2px solid #9c27b0">
                                <small style="color:#555">Flat bonus to the class of the declared SH winner</small>
                            </div>
                            <div class="form-group" style="margin:0">
                                <label style="color:#6a1b9a">ðŸ¥ˆ SH Runner-Up class gets (pts)</label>
                                <input type="number" id="lbCfgShRunPts" value="15" min="0" max="500" style="border:2px solid #ab47bc">
                                <small style="color:#555">Flat bonus to the class of the declared runner-up</small>
                            </div>
                            <div class="form-group" style="margin:0">
                                <label style="color:#6a1b9a">âœ… Per approved task (pts per task per student)</label>
                                <input type="number" id="lbCfgShTaskPts" value="5" min="0" max="100" style="border:2px solid #ba68c8">
                                <small style="color:#555">Each approved task earns this many pts for the student's class</small>
                            </div>
                            <div class="form-group" style="margin:0">
                                <label style="color:#6a1b9a">ðŸ Full completion bonus (pts per student who finishes all)</label>
                                <input type="number" id="lbCfgShCompletePts" value="20" min="0" max="500" style="border:2px solid #ce93d8">
                                <small style="color:#555">Bonus for each student who gets ALL tasks approved</small>
                            </div>
                        </div>
                        <div style="margin-top:12px;background:#ede7f6;padding:10px;border-radius:8px;border:1px solid #ce93d8">
                            <p style="margin:0;color:#4a148c;font-size:12px">
                                <strong>Example:</strong> 3rd B.Com has 5 students each completing 4 tasks = 5Ã—4Ã—5 = <strong>100 pts</strong>. 
                                2 students finish all 6 tasks = 2Ã—20 = <strong>40 bonus pts</strong>. 
                                If their class wins = +30 pts. Total SH contribution = <strong>170 pts</strong> ðŸŽ‰
                            </p>
                        </div>
                    </div>

                    <!-- Speed Slide Challenge scoring -->
                    <div style="margin-top:18px;padding:15px;background:#e3f2fd;border-radius:10px;border:2px solid #90caf9">
                        <h4 style="color:#0d47a1;margin-bottom:12px">ðŸ§© Speed Slide Challenge â€” Points</h4>
                        <p style="color:#444;font-size:12px;margin-bottom:14px">
                            Points are awarded based on each student's best approved puzzle score (0â€“300 depending on difficulty).<br>
                            Each student's best score contributes directly to their class total â€” no winner/runner-up bonuses, purely performance-based.
                        </p>
                        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px">
                            <div class="form-group" style="margin:0">
                                <label style="color:#0d47a1">ðŸ“ Score contribution factor (leaderboard pts per 10 game pts)</label>
                                <input type="number" id="lbCfgSscScorePts" value="1" min="0" max="20" style="border:2px solid #64b5f6">
                                <small style="color:#555">Each student's best score Ã· 10 Ã— factor = class pts<br>Easy max 100â†’10pts Â· Medium 200â†’20pts Â· Hard 300â†’30pts</small>
                            </div>
                        </div>
                        <div style="margin-top:12px;background:#e1f5fe;padding:10px;border-radius:8px;border:1px solid #81d4fa">
                            <p style="margin:0;color:#01579b;font-size:12px">
                                <strong>Example (Factor = 1):</strong> 1ST BCA has 3 students: one scores 300 (Hard) = 30pts, one 200 (Medium) = 20pts, one 100 (Easy) = 10pts.<br>
                                Class total from SSC = <strong>60 pts</strong>. Every student's score counts â€” harder puzzles earn more! ðŸŽ¯
                            </p>
                        </div>
                    </div>

                    <div style="display:flex;align-items:center;gap:12px;flex-wrap:wrap;margin-top:15px">
                        <button class="btn btn-success" onclick="saveLbConfig()">ðŸ’¾ Save Config</button>
                        <span id="lbCfgSaveMsg" style="display:none;background:#d4edda;color:#155724;border:1px solid #c3e6cb;padding:7px 14px;border-radius:6px;font-size:13px;font-weight:600">âœ… Config saved! Leaderboard updates in â‰¤60s</span>
                        <span id="lbCfgErrMsg"  style="display:none;background:#f8d7da;color:#721c24;border:1px solid #f5c6cb;padding:7px 14px;border-radius:6px;font-size:13px;font-weight:600"></span>
                    </div>
                </div>

                <!-- â”€â”€ SECTION 2: Published Results Impact â”€â”€ -->
                <div style="background:#f0fff4;padding:20px;border-radius:12px;margin-bottom:25px;border:2px solid #b2dfdb">
                    <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:10px;margin-bottom:15px">
                        <h3 style="color:#155724;margin:0">ðŸ“¢ Published Event Results â†’ Points</h3>
                        <button class="btn btn-small btn-info" onclick="loadLbPublishedResults()">ðŸ”„ Refresh</button>
                    </div>
                    <p style="color:#555;font-size:13px;margin-bottom:15px">
                        When you publish results for a Youthfest event, the winning class gets <strong id="lbWinPtsDisplay">50</strong> pts 
                        and runner-up gets <strong id="lbRunPtsDisplay">30</strong> pts automatically on the leaderboard.<br>
                        For the <strong>Quiz Competition</strong>, quiz points (winner class, runner-up class, max-correct bonus) are added 
                        automatically each day you publish a quiz winner.
                    </p>
                    <div id="lbPublishedResultsList">
                        <p style="color:#aaa;font-size:13px">Click Refresh to load published resultsâ€¦</p>
                    </div>
                </div>

                <!-- â”€â”€ SECTION 3: Custom Criteria â”€â”€ -->
                <div style="background:#fff8e1;padding:20px;border-radius:12px;margin-bottom:25px;border:2px solid #ffe082">
                    <h3 style="color:#e65100;margin-bottom:8px">âœ¨ Custom Criteria (Manual Points)</h3>
                    <p style="color:#666;font-size:13px;margin-bottom:15px">
                        Add any extra scoring category (e.g., "Best Dressed Class", "Punctuality", "Attendance") and assign points per class manually.
                    </p>

                    <!-- Add new criterion -->
                    <div style="background:white;padding:15px;border-radius:8px;margin-bottom:15px;border:1px solid #ffe082">
                        <h4 style="color:#856404;margin-bottom:12px">âž• Add New Criterion</h4>
                        <div style="display:grid;grid-template-columns:1fr auto;gap:10px;align-items:end">
                            <div class="form-group" style="margin:0">
                                <label>Criterion Name:</label>
                                <input type="text" id="lbNewCriterionName" placeholder="e.g., Best Decorated Class, Punctualityâ€¦">
                            </div>
                            <button class="btn btn-small" onclick="addLbCriterion()" style="height:46px;white-space:nowrap">+ Add</button>
                        </div>
                    </div>

                    <!-- Existing criteria list -->
                    <div id="lbCriteriaList">
                        <p style="color:#aaa;font-size:13px;text-align:center;padding:20px">Loading custom criteriaâ€¦</p>
                    </div>
                </div>

                <!-- â”€â”€ SECTION 4: Full Points Preview â”€â”€ -->
                <div style="background:linear-gradient(135deg,#1a0030 0%,#3d0060 100%);padding:20px;border-radius:12px;border:2px solid rgba(255,215,0,0.3)">
                    <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:10px;margin-bottom:8px">
                        <h3 style="color:#ffd700;margin:0">ðŸ‘ Live Points Preview (All Sources)</h3>
                        <div style="display:flex;gap:8px;align-items:center">
                            <span id="lbPreviewUpdated" style="color:rgba(255,255,255,0.5);font-size:11px"></span>
                            <button class="btn btn-small btn-info" onclick="loadLbAdminPreview()">ðŸ”„ Refresh</button>
                        </div>
                    </div>
                    <p style="color:rgba(255,255,255,0.6);font-size:12px;margin-bottom:15px">âš ï¸ This is exactly what the public leaderboard will show. Verify before publishing.</p>
                    <div id="lbAdminPreview">
                        <p style="color:rgba(255,255,255,0.4);text-align:center;padding:20px">Loading previewâ€¦</p>
                    </div>
                </div>
            </div>
        </div>
        <!-- â”€â”€ End Leaderboard Admin Panel â”€â”€ -->

        <!-- ============================================ -->
        <!-- ðŸŸ¢ LIVE USERS PANEL                         -->
        <!-- ============================================ -->
        <div id="liveUsersPanel" class="form-section super-admin-only" style="margin-top:20px">
            <h2 style="color:#ffd700;margin-bottom:12px;text-shadow:0 2px 8px rgba(0,0,0,0.4)">ðŸŸ¢ Live Now â€” Who's on the Site</h2>
            <p style="color:rgba(255,255,255,0.7);font-size:13px;margin-bottom:18px">Real-time list of everyone currently viewing the site. Updates automatically. When someone closes their tab, they are removed instantly.</p>

            <!-- Live count badge -->
            <div style="background:linear-gradient(135deg,#0a3d0a,#1a6b1a);border-radius:14px;padding:20px 24px;margin-bottom:18px;border:2px solid rgba(76,175,80,0.5);display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:12px">
                <div style="display:flex;align-items:center;gap:14px">
                    <span style="font-size:2.2em;animation:pulse 2s infinite">ðŸŸ¢</span>
                    <div>
                        <div id="liveCountBadge" style="color:#4caf50;font-size:2em;font-weight:800;line-height:1">0</div>
                        <div style="color:rgba(255,255,255,0.7);font-size:13px">users currently on site</div>
                    </div>
                </div>
                <button onclick="refreshLiveUsers()" style="background:rgba(76,175,80,0.25);color:#a5d6a7;border:2px solid rgba(76,175,80,0.5);padding:10px 20px;border-radius:20px;cursor:pointer;font-size:0.9em;font-weight:700">ðŸ”„ Refresh</button>
            </div>

            <!-- Live users table -->
            <div style="background:#fff;border-radius:12px;overflow:hidden;box-shadow:0 4px 15px rgba(0,0,0,0.15)">
                <table style="width:100%;border-collapse:collapse">
                    <thead>
                        <tr style="background:linear-gradient(135deg,#1a0030,#6a1b9a)">
                            <th style="padding:12px 16px;text-align:left;color:#ffd700;font-size:13px">ðŸ‘¤ Name</th>
                            <th style="padding:12px 16px;text-align:left;color:#ffd700;font-size:13px">ðŸŽ“ Class</th>
                            <th style="padding:12px 16px;text-align:left;color:#ffd700;font-size:13px">ðŸ• Since</th>
                            <th style="padding:12px 16px;text-align:left;color:#ffd700;font-size:13px">ðŸ“± Device</th>
                        </tr>
                    </thead>
                    <tbody id="liveUsersTableBody">
                        <tr><td colspan="4" style="text-align:center;padding:30px;color:#999;font-size:14px">â³ Loading live usersâ€¦</td></tr>
                    </tbody>
                </table>
            </div>
            <p style="color:rgba(255,255,255,0.45);font-size:11px;margin-top:10px">âš ï¸ Only students who have logged in show their name & class. Anonymous visitors appear as "Guest".</p>
        </div>

        <!-- ============================================ -->
        <!-- ðŸ“£ PUSH NOTIFICATIONS PANEL                 -->
        <!-- ============================================ -->
        <div id="pushNotifPanel" class="form-section super-admin-only" style="margin-top:20px">
            <h2 style="color:#ffd700;margin-bottom:12px;text-shadow:0 2px 8px rgba(0,0,0,0.4)">ðŸ“£ Push Notifications</h2>
            <p style="color:rgba(255,255,255,0.7);font-size:13px;margin-bottom:18px">Send a notification to all registered devices â€” even when the site is closed. Students must have clicked "Allow" on the notification prompt at least once.</p>

            <!-- Registered devices count -->
            <div style="background:linear-gradient(135deg,#1a0030,#3d0060);border-radius:14px;padding:18px 24px;margin-bottom:20px;border:2px solid rgba(179,136,255,0.4);display:flex;align-items:center;gap:16px">
                <span style="font-size:2em">ðŸ“±</span>
                <div>
                    <div id="registeredDevicesCount" style="color:#ce93d8;font-size:1.8em;font-weight:800;line-height:1">â€”</div>
                    <div style="color:rgba(255,255,255,0.65);font-size:13px">registered devices</div>
                </div>
                <button onclick="refreshDeviceCount()" style="margin-left:auto;background:rgba(179,136,255,0.2);color:#ce93d8;border:2px solid rgba(179,136,255,0.4);padding:8px 16px;border-radius:20px;cursor:pointer;font-size:0.85em;font-weight:700">ðŸ”„ Refresh</button>
            </div>

            <!-- Registered Devices Inline List â€” collapsible -->
            <div style="background:#fff;border-radius:14px;box-shadow:0 4px 15px rgba(0,0,0,0.15);margin-bottom:20px;overflow:hidden">
                <!-- Header / toggle -->
                <div onclick="toggleDevicesPanel()" style="display:flex;align-items:center;justify-content:space-between;padding:16px 20px;cursor:pointer;user-select:none">
                    <h3 style="color:#6a1b9a;font-size:1em;margin:0">ðŸ“‹ Registered Devices <span id="devicesCountBadge" style="background:rgba(106,27,154,0.12);color:#6a1b9a;font-size:11px;padding:2px 8px;border-radius:10px;margin-left:6px">â€”</span></h3>
                    <div style="display:flex;align-items:center;gap:8px">
                        <button onclick="event.stopPropagation();loadAllDevices()" style="background:rgba(106,27,154,0.1);color:#6a1b9a;border:2px solid rgba(106,27,154,0.25);padding:4px 10px;border-radius:14px;cursor:pointer;font-size:11px;font-weight:700">ðŸ”„</button>
                        <span id="devicesToggleArrow" style="color:#6a1b9a;font-size:16px;transition:transform 0.2s">â–¶</span>
                    </div>
                </div>
                <!-- Collapsible body -->
                <div id="devicesPanel" style="display:none;padding:0 20px 16px">
                    <!-- Filter bar -->
                    <div style="display:flex;flex-wrap:wrap;gap:6px;margin-bottom:12px">
                        <button onclick="filterDevices('all')" id="devFilter_all" class="devFilterBtn activeFilter" style="padding:4px 12px;border-radius:14px;border:1.5px solid #6a1b9a;background:#6a1b9a;color:#fff;font-size:11px;font-weight:700;cursor:pointer">All</button>
                        <button onclick="filterDevices('guest')" id="devFilter_guest" class="devFilterBtn" style="padding:4px 12px;border-radius:14px;border:1.5px solid #aaa;background:#fff;color:#666;font-size:11px;font-weight:700;cursor:pointer">ðŸ‘¤ Guest (no login)</button>
                        <div id="devFilterClassButtons" style="display:contents"></div>
                    </div>
                    <div id="allDevicesInlineList">
                        <p style="color:#aaa;font-size:13px;text-align:center;padding:10px 0">Loadingâ€¦</p>
                    </div>
                </div>
            </div>

            <!-- Compose notification -->
            <div style="background:#fff;border-radius:14px;padding:24px;box-shadow:0 4px 15px rgba(0,0,0,0.15);overflow:hidden;position:relative;z-index:1">
                <h3 style="color:#6a1b9a;margin-bottom:16px;font-size:1.1em">âœï¸ Compose Notification</h3>

                <!-- Target selector -->
                <div style="margin-bottom:16px">
                    <label style="color:#444;font-weight:700;font-size:13px;display:block;margin-bottom:8px">ðŸŽ¯ Send To</label>
                    <div style="display:flex;gap:8px;flex-wrap:wrap">
                        <button id="ntBtn_all" onclick="setNotifTarget('all')" style="padding:7px 16px;border-radius:20px;border:2px solid #6a1b9a;background:#6a1b9a;color:#fff;font-size:12px;font-weight:700;cursor:pointer">ðŸ“¢ All Devices</button>
                        <button id="ntBtn_class" onclick="setNotifTarget('class')" style="padding:7px 16px;border-radius:20px;border:2px solid #aaa;background:#fff;color:#666;font-size:12px;font-weight:700;cursor:pointer">ðŸ« One Class</button>
                        <button id="ntBtn_person" onclick="setNotifTarget('person')" style="padding:7px 16px;border-radius:20px;border:2px solid #aaa;background:#fff;color:#666;font-size:12px;font-weight:700;cursor:pointer">ðŸ‘¤ One Person</button>
                    </div>
                </div>

                <!-- Class selector (hidden by default) -->
                <div id="notifClassRow" style="display:none;margin-bottom:14px">
                    <label style="color:#444;font-weight:700;font-size:13px">Class</label>
                    <select id="notifTargetClass" style="width:100%;padding:10px 14px;border:2px solid #6a1b9a;border-radius:8px;font-size:14px;margin-top:4px">
                        <option value="">â€” Loading classesâ€¦ â€”</option>
                    </select>
                </div>

                <!-- Person selector (hidden by default) -->
                <div id="notifPersonRow" style="display:none;margin-bottom:14px">
                    <label style="color:#444;font-weight:700;font-size:13px">Person</label>
                    <select id="notifTargetPerson" style="width:100%;padding:10px 14px;border:2px solid #6a1b9a;border-radius:8px;font-size:14px;margin-top:4px">
                        <option value="">â€” Loading devicesâ€¦ â€”</option>
                    </select>
                </div>

                <div class="form-group" style="margin-bottom:14px">
                    <label style="color:#444;font-weight:700;font-size:13px">Title</label>
                    <input type="text" id="notifTitle" placeholder="e.g. ðŸŽ“ Quiz is Live Now!" maxlength="100" style="border:2px solid #c44569;border-radius:8px;padding:10px 14px;width:100%;font-size:14px">
                </div>
                <div class="form-group" style="margin-bottom:20px">
                    <label style="color:#444;font-weight:700;font-size:13px">Message</label>
                    <textarea id="notifBody" placeholder="e.g. Today's quiz has started â€” open the site now and submit your answers before time runs out!" rows="3" maxlength="200" style="border:2px solid #c44569;border-radius:8px;padding:10px 14px;width:100%;font-size:14px;resize:vertical"></textarea>
                </div>
                <button onclick="sendPushNotification()" id="sendNotifBtn" style="background:linear-gradient(135deg,#c44569,#6a1b9a);color:#fff;border:none;padding:14px 32px;border-radius:25px;cursor:pointer;font-size:1em;font-weight:700;width:100%;letter-spacing:0.5px;box-shadow:0 4px 15px rgba(196,69,105,0.4)">ðŸ“¤ Send to All Devices</button>
                <div id="notifSendStatus" style="margin-top:14px;display:none;padding:12px 16px;border-radius:8px;font-size:14px;font-weight:600;text-align:center"></div>
                <div style="margin-top:12px;border-top:1px dashed rgba(106,27,154,0.2);padding-top:12px">
                    <button onclick="retriggerPermissionBanner()" id="retriggerBannerBtn" style="background:linear-gradient(135deg,#1a0030,#6a1b9a);color:#fff;border:none;padding:10px 20px;border-radius:20px;cursor:pointer;font-size:13px;font-weight:700;width:100%">ðŸ”” Re-send Notification Permission Prompt to All Students</button>
                    <div id="retriggerStatus" style="margin-top:8px;display:none;padding:8px 12px;border-radius:8px;font-size:13px;font-weight:600;text-align:center"></div>
                    <p style="color:#888;font-size:11px;margin-top:6px;text-align:center">Forces the &ldquo;Allow Notifications&rdquo; banner to re-appear on every student&rsquo;s screen next time they load or are on the site</p>
                </div>
                <div style="margin-top:10px;border-top:1px dashed rgba(106,27,154,0.2);padding-top:10px">
                    <button onclick="cleanStaleSubscriptions()" id="cleanStaleBtn" style="background:linear-gradient(135deg,#e53935,#b71c1c);color:#fff;border:none;padding:10px 20px;border-radius:20px;cursor:pointer;font-size:13px;font-weight:700;width:100%">ðŸ§¹ Clean Stale Subscriptions from Firebase</button>
                    <div id="cleanStaleStatus" style="margin-top:8px;display:none;padding:8px 12px;border-radius:8px;font-size:13px;font-weight:600;text-align:center"></div>
                    <p style="color:#888;font-size:11px;margin-top:6px;text-align:center">Tests each stored subscription and removes expired/invalid ones â€” run this if you see many &ldquo;failed&rdquo; in Notification History</p>
                </div>
                <div style="margin-top:10px;border-top:1px dashed rgba(106,27,154,0.2);padding-top:10px">
                    <button onclick="forceUpdateSW()" id="forceUpdateSWBtn" style="background:linear-gradient(135deg,#0277bd,#01579b);color:#fff;border:none;padding:10px 20px;border-radius:20px;cursor:pointer;font-size:13px;font-weight:700;width:100%">ðŸ”„ Force Service Worker Update on All Devices</button>
                    <div id="forceUpdateSWStatus" style="margin-top:8px;display:none;padding:8px 12px;border-radius:8px;font-size:13px;font-weight:600;text-align:center"></div>
                    <p style="color:#888;font-size:11px;margin-top:6px;text-align:center">Forces all online student devices to reload the latest sw.js immediately â€” use this after uploading a new sw.js to GitHub</p>
                </div>
                <div style="margin-top:10px;border-top:1px dashed rgba(106,27,154,0.2);padding-top:10px">
                    <button onclick="forceResubscribeAll()" id="forceResubBtn" style="background:linear-gradient(135deg,#e65100,#bf360c);color:#fff;border:none;padding:10px 20px;border-radius:20px;cursor:pointer;font-size:13px;font-weight:700;width:100%">ðŸ” Force Re-subscribe All Devices to Push</button>
                    <div id="forceResubStatus" style="margin-top:8px;display:none;padding:8px 12px;border-radius:8px;font-size:13px;font-weight:600;text-align:center"></div>
                    <p style="color:#888;font-size:11px;margin-top:6px;text-align:center">Clears old stale subscriptions and forces all online devices to create a fresh push subscription â€” run this after updating sw.js if notifications still don't appear</p>
                </div>
                <div style="margin-top:10px;border-top:1px dashed rgba(106,27,154,0.2);padding-top:10px">
                    <button onclick="checkAndShowFirebaseRulesFix()" id="firebaseRulesBtn" style="background:linear-gradient(135deg,#1565c0,#0d47a1);color:#fff;border:none;padding:10px 20px;border-radius:20px;cursor:pointer;font-size:13px;font-weight:700;width:100%">ðŸ” Check Firebase Rules (Fix if Notifications Broken)</button>
                    <div id="firebaseRulesResult" style="margin-top:8px;display:none;padding:12px;border-radius:8px;font-size:12px;background:rgba(0,0,0,0.3);color:#fff;line-height:1.7"></div>
                    <p style="color:#888;font-size:11px;margin-top:6px;text-align:center">Tests if Firebase is blocking subscription saves â€” the #1 reason notifications don't arrive</p>
            </div>

            <!-- Info box -->
            <div style="background:rgba(255,193,7,0.12);border:2px solid rgba(255,193,7,0.35);border-radius:10px;padding:14px 18px;margin-top:16px;position:relative;z-index:1;overflow:visible">
                <p style="color:#ffd54f;font-size:12px;margin:0;line-height:1.6">
                    âš™ï¸ <strong>How it works:</strong> This sends via your <code style="background:rgba(0,0,0,0.3);padding:2px 6px;border-radius:4px">fcm-push</code> Cloudflare Worker â†’ Web Push API â†’ registered devices via <code style="background:rgba(0,0,0,0.3);padding:2px 6px;border-radius:4px">sw.js</code> service worker.<br>
                    <strong style="color:#ffcc02">âš ï¸ IMPORTANT:</strong> Your <code style="background:rgba(0,0,0,0.3);padding:2px 6px;border-radius:4px">sw.js</code> file must have a <code style="background:rgba(0,0,0,0.3);padding:2px 6px;border-radius:4px">push</code> event listener or notifications won't show even if "sent" succeeds.
                </p>
                <div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap;align-items:center">
                    <button id="swJsCodeBtn" style="background:#ffcc02;color:#1a0030;border:none;padding:7px 16px;border-radius:16px;cursor:pointer;font-size:11px;font-weight:800;display:inline-block">ðŸ“‹ Copy correct sw.js code</button>
                    <button id="swJsDownloadBtn" style="background:#00c853;color:#fff;border:none;padding:7px 16px;border-radius:16px;cursor:pointer;font-size:11px;font-weight:800;display:inline-block">â¬‡ï¸ Download sw.js</button>
                    <button id="testPushBtn" style="background:rgba(255,255,255,0.15);color:#ffd54f;border:1.5px solid #ffd54f;padding:7px 16px;border-radius:16px;cursor:pointer;font-size:11px;font-weight:700;display:inline-block">ðŸ§ª Test Push Now</button>
                    <span id="testPushResult" style="color:#a8ff78;font-size:11px;font-weight:700"></span>
                </div>
                <div id="swJsHealthBadge" style="margin-top:8px;font-size:11px;font-weight:700;display:none"></div>
            </div>

            <!-- Cloudflare Worker Code Box -->
            <div style="background:rgba(21,101,192,0.15);border:2px solid rgba(21,101,192,0.4);border-radius:10px;padding:14px 18px;margin-top:10px;position:relative;z-index:1">
                <p style="color:#90caf9;font-size:12px;font-weight:700;margin:0 0 6px">ðŸ”§ Cloudflare Worker Code â€” deploy this at <code style="background:rgba(0,0,0,0.3);padding:1px 5px;border-radius:4px">fcm-push.harshgujjar.workers.dev</code></p>
                <p style="color:#ffcc02;font-size:11px;font-weight:700;margin:0 0 8px">âš ï¸ VAPID keys were regenerated â€” you MUST redeploy this worker with the new keys, then Force Re-subscribe all devices.</p>
                <textarea id="cfWorkerCodeArea" readonly style="width:100%;height:180px;font-family:monospace;font-size:10.5px;background:#0d1117;color:#a5d6a7;border:1px solid #333;border-radius:6px;padding:10px;resize:none;box-sizing:border-box"></textarea>
                <div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap">
                    <button onclick="copyWorkerCode()" style="background:#1565c0;color:#fff;border:none;padding:6px 16px;border-radius:12px;cursor:pointer;font-size:12px;font-weight:700">ðŸ“‹ Copy Worker Code</button>
                    <button onclick="downloadWorkerCode()" style="background:#00897b;color:#fff;border:none;padding:6px 16px;border-radius:12px;cursor:pointer;font-size:12px;font-weight:700">â¬‡ï¸ Download worker.js</button>
                </div>
            </div>

            <!-- SW Push Debug Panel -->
            <div style="background:#1a0030;border-radius:14px;padding:18px;margin-top:16px;position:relative;z-index:2">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
                    <h3 style="color:#ffcc02;font-size:1em;margin:0">ðŸ” SW Push Debug Log</h3>
                </div>
                <p style="color:#888;font-size:11px;margin:0 0 10px">Shows what happens inside sw.js when a push is delivered â€” updates live. Send a notification then watch here.</p>
                <div style="display:flex;gap:8px;margin-bottom:10px;flex-wrap:wrap">
                    <button onclick="diagnosePushOnDevice()" style="background:rgba(0,200,83,0.25);color:#a8ff78;border:1px solid #a8ff78;padding:6px 14px;border-radius:12px;cursor:pointer;font-size:11px;font-weight:700">ðŸ”¬ Diagnose This Device</button>
                    <button onclick="clearSwDebugLog()" style="background:rgba(255,255,255,0.1);color:#aaa;border:1px solid #444;padding:6px 14px;border-radius:12px;cursor:pointer;font-size:11px">ðŸ—‘ Clear Log</button>
                    <button onclick="loadSwDebugLog()" style="background:rgba(255,204,2,0.15);color:#ffcc02;border:1px solid #ffcc02;padding:6px 14px;border-radius:12px;cursor:pointer;font-size:11px">â†» Refresh</button>
                </div>
                <div id="swDiagnoseResult" style="display:none;background:#0d0d1a;border:1px solid #333;border-radius:8px;padding:10px;margin-bottom:10px;font-family:monospace;font-size:11px;color:#fff;line-height:1.7"></div>
                <div id="swDebugLog" style="background:#0d0d1a;border-radius:8px;padding:12px;max-height:220px;overflow-y:auto;font-family:monospace;font-size:11px;color:#a8ff78">
                    <span style="color:#555">Waiting for push eventsâ€¦</span>
                </div>
            </div>

            <!-- sw.js code modal -->
            <div id="swJsModal" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);z-index:99999;align-items:center;justify-content:center">
                <div style="background:#1a1a2e;border-radius:16px;padding:24px;max-width:600px;width:92%;max-height:85vh;overflow-y:auto;position:relative">
                    <button onclick="document.getElementById('swJsModal').style.display='none'" style="position:absolute;top:10px;right:14px;background:none;border:none;font-size:22px;cursor:pointer;color:#aaa">âœ•</button>
                    <h3 style="color:#ffcc02;margin-bottom:4px;font-size:1em">ðŸ“„ Required sw.js content</h3>
                    <p style="color:#aaa;font-size:11px;margin-bottom:12px">Upload this as <strong style="color:#fff">sw.js</strong> in your GitHub repo root at <code style="background:#333;padding:1px 5px;border-radius:3px">/Spurthi-youth-fest-2026/sw.js</code></p>
                    <textarea id="swJsCodeArea" readonly style="width:100%;height:320px;background:#0d0d1a;color:#a8ff78;border:1px solid #333;border-radius:8px;padding:12px;font-family:monospace;font-size:11px;resize:vertical;box-sizing:border-box"></textarea>
                    <button onclick="copySwJs(this)" style="margin-top:10px;background:#ffcc02;color:#1a0030;border:none;padding:8px 20px;border-radius:16px;cursor:pointer;font-size:12px;font-weight:800;width:calc(50% - 4px)">ðŸ“‹ Copy to Clipboard</button>
                    <button onclick="(function(){var b=new Blob([SW_JS_CODE],{type:'application/javascript'});var a=document.createElement('a');a.href=URL.createObjectURL(b);a.download='sw.js';a.click();})()" style="margin-top:10px;background:#00c853;color:#fff;border:none;padding:8px 20px;border-radius:16px;cursor:pointer;font-size:12px;font-weight:800;width:calc(50% - 4px)">â¬‡ï¸ Download sw.js</button>
                </div>
            </div>

            <!-- Notification History Inline -->
            <div style="background:#fff;border-radius:14px;padding:24px;box-shadow:0 4px 15px rgba(0,0,0,0.15);margin-top:20px">
                <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px">
                    <h3 style="color:#6a1b9a;font-size:1.1em;margin:0">ðŸ“œ Notification History</h3>
                    <div style="display:flex;gap:8px;align-items:center">
                        <button onclick="loadPushLogs()" style="background:rgba(106,27,154,0.1);color:#6a1b9a;border:2px solid rgba(106,27,154,0.3);padding:6px 14px;border-radius:20px;cursor:pointer;font-size:0.8em;font-weight:700">ðŸ”„ Refresh</button>
                        <button onclick="toggleClearOldPanel()" style="background:rgba(183,28,28,0.08);color:#b71c1c;border:2px solid rgba(183,28,28,0.25);padding:6px 14px;border-radius:20px;cursor:pointer;font-size:0.8em;font-weight:700">ðŸ—‘ Clear Old</button>
                    </div>
                </div>
                <div id="clearOldPanel" style="display:none;background:#fff3f3;border:1.5px solid #ffcdd2;border-radius:10px;padding:12px 16px;margin-bottom:14px">
                    <p style="color:#b71c1c;font-size:12px;font-weight:700;margin:0 0 8px">Delete all notifications sent before:</p>
                    <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
                        <input type="date" id="clearOldDateInput" style="border:1.5px solid #ffcdd2;border-radius:8px;padding:5px 10px;font-size:13px;color:#333;background:#fff"/>
                        <button onclick="clearOldLogs()" style="background:#b71c1c;color:#fff;border:none;padding:6px 16px;border-radius:16px;cursor:pointer;font-size:12px;font-weight:700">ðŸ—‘ Delete</button>
                        <button onclick="toggleClearOldPanel()" style="background:none;color:#888;border:1.5px solid #ddd;padding:6px 12px;border-radius:16px;cursor:pointer;font-size:12px">Cancel</button>
                    </div>
                    <div id="clearOldStatus" style="margin-top:8px;display:none;font-size:12px;font-weight:600"></div>
                </div>
                <div id="pushLogsContainer">
                    <p style="color:#aaa;font-size:13px;text-align:center;padding:20px 0">Loadingâ€¦</p>
                </div>
                <!-- Clear Old button at bottom -->
                <div style="margin-top:14px;border-top:1px solid #f0e6f8;padding-top:14px;display:flex;gap:8px;justify-content:flex-end">
                    <button onclick="toggleClearOldPanel()" style="background:rgba(183,28,28,0.08);color:#b71c1c;border:2px solid rgba(183,28,28,0.25);padding:6px 14px;border-radius:20px;cursor:pointer;font-size:0.8em;font-weight:700">ðŸ—‘ Clear Old Entries</button>
                </div>
            </div>

            <!-- Seen Devices Modal -->
            <div id="seenDevicesModal" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.6);z-index:9999;align-items:center;justify-content:center">
                <div style="background:#fff;border-radius:16px;padding:28px;max-width:480px;width:90%;max-height:80vh;overflow-y:auto;position:relative">
                    <button onclick="document.getElementById('seenDevicesModal').style.display='none'" style="position:absolute;top:12px;right:14px;background:none;border:none;font-size:20px;cursor:pointer;color:#999">âœ•</button>
                    <h3 style="color:#6a1b9a;margin-bottom:16px;font-size:1em" id="seenModalTitle">ðŸ‘ Seen / Opened By</h3>
                    <div id="seenModalBody"></div>
                </div>
            </div>
        </div>

        <!-- Jury Section -->
        <div class="jury-only" id="jurySection">            <button class="btn btn-secondary" onclick="logout()" style="float:right">Logout</button>
            
            <div class="content">
                <h2 style="color:#c44569;margin-bottom:20px" id="juryEventTitle">Jury Evaluation Sheet</h2>
                <p style="margin-bottom:20px;color:#666" id="juryInfo"></p>
                
                <div id="juryMessage" class="message"></div>
                
                <div style="margin-bottom:20px;text-align:center">
                    <button class="btn btn-info" onclick="loadJurySheet()" style="margin-right:10px">ðŸ”„ Reload Sheet</button>
                    <button class="btn btn-secondary" onclick="showEnrollmentDebugProtected()">ðŸ“Š Show Enrollments</button>
                </div>
                
                <div id="jurySheetContainer"></div>
                
                <div style="margin-top:30px;text-align:center">
                    <button class="btn btn-success" onclick="saveMarks()">ðŸ’¾ Save Marks</button>
                    <button class="btn btn-info" onclick="markAsCompleted()" style="margin-left:10px">âœ… Mark as Completed</button>
                </div>
            </div>
        </div>
        
        <!-- ============================================ -->
        <!-- SUPER JURY SECTION                           -->
        <!-- ============================================ -->
        <!-- ============================================ -->

        <!-- ============================================ -->
        <!-- DAILY QUIZ COMPETITION SYSTEM                -->
        <!-- ============================================ -->
        
        <!-- Quiz Student Dashboard -->
        
        <!-- Quiz Admin Dashboard -->
        <!-- Regular Quiz Admin Dashboard REMOVED - Only Super Admin Dashboard is used -->
    </div>

        <!-- ============================================ -->
        <!-- QUIZ & SCAVENGER DASHBOARDS (outside adminSection) -->
        <!-- ============================================ -->
        <div id="quizStudentDashboard" style="display:none">
            <!-- Login success banner -->
            <div style="background:linear-gradient(135deg,#28a745,#20c997);color:white;padding:16px 24px;border-radius:12px;margin-bottom:16px;text-align:center;font-size:1.2em;font-weight:700;box-shadow:0 4px 15px rgba(40,167,69,0.4)">
                âœ… Logged In Successfully â€” Daily Quiz Competition
            </div>
            <!-- Fixed header bar -->
            <div style="background:linear-gradient(135deg,#6a1b9a,#c44569);padding:16px 20px;border-radius:12px;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:10px;margin-bottom:20px;box-shadow:0 4px 15px rgba(0,0,0,0.2)">
                <h2 style="color:#fff;margin:0;font-size:clamp(1em,3vw,1.4em);display:flex;align-items:center;gap:10px;text-shadow:1px 1px 3px rgba(0,0,0,0.5)">
                    ðŸŽ“ <span>Daily Quiz Competition</span>
                    <span id="quizStudentNameBadge" class="badge" style="background:#28a745;color:white;padding:6px 14px;border-radius:20px;font-size:0.75em;white-space:nowrap"></span>
                </h2>
                <button class="btn btn-secondary" onclick="logout()" style="white-space:nowrap;flex-shrink:0">Logout</button>
            </div>
            <div id="quizStudentMessage" class="message"></div>
            
            <div class="content">
                <h3 style="color:#6a1b9a;margin-bottom:8px">Welcome, <span id="quizStudentName"></span>!</h3>
                <p style="margin-bottom:16px"><strong>Email:</strong> <span id="quizStudentEmail"></span> | <strong>Class:</strong> <span id="quizStudentClass"></span></p>

                <!-- Live Date & Time Banner -->
                <div style="background:linear-gradient(135deg,#6a1b9a 0%,#c44569 100%);border-radius:12px;padding:16px 20px;margin-bottom:22px;display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:12px;box-shadow:0 4px 15px rgba(106,27,154,0.3)">
                    <div style="display:flex;align-items:center;gap:12px;flex-wrap:wrap">
                        <div style="text-align:center;background:rgba(255,255,255,0.15);border-radius:10px;padding:10px 16px;min-width:80px">
                            <div style="color:rgba(255,255,255,0.75);font-size:10px;text-transform:uppercase;letter-spacing:1px;margin-bottom:3px">Day</div>
                            <div id="quizLiveDay" style="color:#fff;font-size:1.2em;font-weight:700"></div>
                        </div>
                        <div style="text-align:center;background:rgba(255,255,255,0.15);border-radius:10px;padding:10px 16px;min-width:110px">
                            <div style="color:rgba(255,255,255,0.75);font-size:10px;text-transform:uppercase;letter-spacing:1px;margin-bottom:3px">Date</div>
                            <div id="quizLiveDate" style="color:#ffd700;font-size:1.05em;font-weight:700"></div>
                        </div>
                        <div style="text-align:center;background:rgba(255,255,255,0.15);border-radius:10px;padding:10px 16px;min-width:95px">
                            <div style="color:rgba(255,255,255,0.75);font-size:10px;text-transform:uppercase;letter-spacing:1px;margin-bottom:3px">Time</div>
                            <div id="quizLiveTime" style="color:#a5ffb8;font-size:1.2em;font-weight:700;letter-spacing:1px"></div>
                        </div>
                    </div>
                    <div id="quizLiveAmPm" style="color:rgba(255,255,255,0.85);font-size:0.85em;font-weight:600;text-align:right;line-height:1.6"></div>
                </div>

                <div id="quizStatusSection">
                    <div style="background:#fff3cd;padding:20px;border-radius:12px;margin-bottom:25px;border-left:5px solid #ffc107">
                        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:15px">
                            <h3 style="color:#856404;margin:0">ðŸ“… Today's Quiz Status</h3>
                            <button class="btn btn-info btn-small" onclick="checkQuizTodayStatus()" style="font-size:0.9em">ðŸ”„ Refresh Status</button>
                        </div>
                        <div id="quizStatus"></div>
                    </div>
                    
                    <div id="quizStartSection" style="display:none">
                        <div style="background:linear-gradient(135deg,#ff6b6b 0%,#ee5a6f 100%);color:white;padding:20px;border-radius:10px;margin-bottom:25px">
                            <h3 style="margin-bottom:10px">âš ï¸ Anti-Cheating Rules</h3>
                            <ul style="line-height:1.8;margin-left:20px">
                                <li>Do NOT refresh the page</li>
                                <li>Do NOT press back button</li>
                                <li>Do NOT switch tabs or minimize browser</li>
                                <li>Quiz will AUTO-SUBMIT if rules violated</li>
                                <li>You get ONE attempt per day only</li>
                            </ul>
                        </div>
                        <button class="btn btn-success" onclick="startQuiz()" style="font-size:1.2em;padding:18px">ðŸš€ Start Today's Quiz</button>
                    </div>
                    
                    <div id="quizCompletedSection" style="display:none">
                        <div class="message success show">
                            <strong>âœ… Quiz Completed!</strong> You have successfully submitted today's quiz. Results will be announced soon.
                        </div>
                        <div style="background:#f3e5f5;border:2px solid #9c27b0;border-radius:12px;padding:18px 22px;margin-top:16px">
                            <h4 style="color:#6a1b9a;margin:0 0 12px 0;font-size:1.05em">&#128197; Next Quiz Schedule</h4>
                            <div style="display:flex;flex-wrap:wrap;gap:12px">
                                <div style="background:white;border-radius:8px;padding:10px 18px;flex:1;min-width:150px;border-left:4px solid #4caf50;text-align:center">
                                    <div style="color:#666;font-size:0.78em;text-transform:uppercase;letter-spacing:1px;margin-bottom:4px">Next Quiz Starts At</div>
                                    <div style="color:#2e7d32;font-weight:800;font-size:1.1em" id="nextQuizStartTime">Loading...</div>
                                </div>
                                <div style="background:white;border-radius:8px;padding:10px 18px;flex:1;min-width:150px;border-left:4px solid #f44336;text-align:center">
                                    <div style="color:#666;font-size:0.78em;text-transform:uppercase;letter-spacing:1px;margin-bottom:4px">Next Quiz Ends At</div>
                                    <div style="color:#c62828;font-weight:800;font-size:1.1em" id="nextQuizEndTime">Loading...</div>
                                </div>
                                <div style="background:white;border-radius:8px;padding:10px 18px;flex:1;min-width:150px;border-left:4px solid #9c27b0;text-align:center">
                                    <div style="color:#666;font-size:0.78em;text-transform:uppercase;letter-spacing:1px;margin-bottom:4px">Starts In</div>
                                    <div style="color:#6a1b9a;font-weight:800;font-size:1.1em" id="nextQuizCountdown">--:--:--</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div id="quizResultsSection" style="display:none">
                        <h3 style="color:#667eea;margin-top:20px">ðŸ“Š Your Results</h3>
                        <div id="quizStudentResults"></div>
                    </div>
                </div>
            </div>
        </div>

        <div id="shStudentDashboard" style="display:none">
            <!-- Login success banner -->
            <div style="background:linear-gradient(135deg,#9c27b0,#e91e63);color:white;padding:16px 24px;border-radius:12px;margin-bottom:16px;display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:10px;box-shadow:0 4px 15px rgba(156,39,176,0.4)">
                <span style="font-size:1.2em;font-weight:700">âœ… Logged In Successfully â€” Scavenger Hunt</span>
                <button onclick="shGoBack()" style="background:rgba(255,255,255,0.2);color:white;border:2px solid rgba(255,255,255,0.6);padding:8px 18px;border-radius:20px;cursor:pointer;font-size:0.85em;font-weight:700;display:flex;align-items:center;gap:6px;white-space:nowrap;transition:all 0.2s" onmouseover="this.style.background='rgba(255,255,255,0.35)'" onmouseout="this.style.background='rgba(255,255,255,0.2)'">â¬…ï¸ Go Back</button>
            </div>
            <!-- Header -->
            <div style="background:linear-gradient(135deg,#9c27b0,#e91e63);padding:16px 20px;border-radius:12px;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:10px;margin-bottom:20px;box-shadow:0 4px 15px rgba(0,0,0,0.2)">
                <h2 style="color:#fff;margin:0;font-size:clamp(1em,3vw,1.4em);display:flex;align-items:center;gap:10px;text-shadow:1px 1px 3px rgba(0,0,0,0.5)">
                    ðŸ—ºï¸ <span>Scavenger Hunt</span>
                    <span id="shStudentBadge" class="badge" style="background:#fff;color:#9c27b0;padding:6px 14px;border-radius:20px;font-size:0.75em;white-space:nowrap"></span>
                </h2>
                <button class="btn btn-secondary" onclick="shLogout()" style="white-space:nowrap;flex-shrink:0">Logout</button>
            </div>

            <div class="content">
                <h3 style="color:#6a1b9a;margin-bottom:6px">Welcome, <span id="shStudentName"></span>!</h3>
                <p style="margin-bottom:18px;color:#666"><strong>Class:</strong> <span id="shStudentClass"></span></p>

                <!-- Hunt not active message -->
                <div id="shNotActiveMsg" style="display:none;background:#fff3e0;padding:20px;border-radius:12px;border-left:5px solid #ff9800;margin-bottom:20px">
                    <h4 style="color:#e65100;margin-bottom:6px">â³ Hunt Not Active Yet</h4>
                    <p style="color:#bf360c;margin:0">The Scavenger Hunt has not started yet. Check back soon!</p>
                </div>

                <!-- Progress -->
                <div id="shProgressSection" style="display:none">
                    <div style="background:linear-gradient(135deg,#9c27b0,#e91e63);color:white;border-radius:14px;padding:18px 22px;margin-bottom:20px">
                        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;flex-wrap:wrap;gap:8px">
                            <span style="font-weight:700;font-size:1.1em">ðŸ† Your Progress</span>
                            <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap">
                                <span id="shProgressText" style="font-size:1.3em;font-weight:800"></span>
                                <button onclick="shRefreshStatus()" id="shRefreshBtn" style="background:rgba(255,255,255,0.25);color:white;border:2px solid rgba(255,255,255,0.6);padding:6px 14px;border-radius:20px;cursor:pointer;font-size:0.85em;font-weight:700;display:flex;align-items:center;gap:5px">ðŸ”„ Check Status</button>
                            </div>
                        </div>
                        <div id="shLastRefreshed" style="font-size:0.75em;opacity:0.75;margin-bottom:6px"></div>
                        <div class="sh-progress-bar-wrap" style="background:rgba(255,255,255,0.3)">
                            <div class="sh-progress-bar" id="shProgressBar" style="width:0%;background:white"></div>
                        </div>
                        <div style="display:flex;gap:12px;margin-top:12px;flex-wrap:wrap">
                            <span style="font-size:0.85em;opacity:0.9">âœ… <span id="shCompletedCount">0</span> Completed</span>
                            <span style="font-size:0.85em;opacity:0.9">â³ <span id="shPendingCount">0</span> Pending Review</span>
                            <span style="font-size:0.85em;opacity:0.9">ðŸ”’ <span id="shLockedCount">0</span> Locked</span>
                        </div>
                    </div>

                    <!-- GPS Status -->
                    <div id="shGpsStatus" style="background:#e0f7fa;border:2px solid #00bcd4;border-radius:10px;padding:12px 16px;margin-bottom:18px;display:flex;align-items:center;gap:10px;flex-wrap:wrap">
                        <span class="sh-gps-badge">ðŸ“ GPS</span>
                        <span id="shGpsStatusText" style="color:#006064;font-size:0.9em;flex:1">Requesting location access...</span>
                        <button onclick="shGetLocation(); shRefreshStatus();" style="background:#00bcd4;color:white;border:none;padding:6px 14px;border-radius:20px;cursor:pointer;font-size:0.85em;font-weight:600">ðŸ”„ Refresh</button>
                    </div>

                    <!-- Tasks -->
                    <div id="shTasksList"></div>
                </div>

                <!-- Completed all tasks! -->
                <div id="shAllDoneSection" style="display:none;text-align:center;padding:30px 20px">
                    <div style="font-size:4em;margin-bottom:16px">ðŸŽ‰</div>
                    <h2 style="color:#4caf50;margin-bottom:10px">All Tasks Completed!</h2>
                    <p style="color:#666;font-size:1.1em">Amazing! You have completed all tasks. Wait for the results announcement!</p>
                </div>
            </div>
        </div>

        <div id="quizPage" style="display:none">
            <div class="quiz-timer-box" id="quizTimer">
                â±ï¸ <span id="quizTimerValue">00:00</span>
            </div>
            
            <div class="content">
                <h2 style="color:#c44569;text-align:center;margin-bottom:10px;font-size:2em">ðŸ“ Daily Quiz Competition</h2>
                <p id="quizDateDisplay" style="text-align:center;color:#667eea;font-weight:600;margin-bottom:30px;font-size:1.2em"></p>
                <div id="quizPageMessage" class="message"></div>
                
                <div id="quizQuestionsContainer"></div>
                
                <button class="quiz-submit-btn" onclick="submitQuizAnswers()">
                    âœ… Submit Quiz
                </button>
            </div>
        </div>


        <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
        <!-- SPEED SLIDE CHALLENGE â€” PLAYER DASHBOARD                  -->
        <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
        <div id="sscStudentDashboard" style="display:none">

            <!-- Header bar -->
            <div style="background:linear-gradient(135deg,#1a0030 0%,#4a148c 50%,#c44569 100%);color:white;padding:18px 24px;border-radius:16px;margin-bottom:18px;display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:12px;box-shadow:0 8px 28px rgba(106,27,154,0.5),0 0 0 1px rgba(255,255,255,.08)">
                <div style="display:flex;align-items:center;gap:14px;flex-wrap:wrap">
                    <span style="font-size:1.5em;font-weight:800;letter-spacing:.5px;text-shadow:0 2px 8px rgba(0,0,0,.3)">ðŸ§© Speed Slide Challenge</span>
                    <span id="sscPlayerBadge" style="background:rgba(255,255,255,.15);padding:6px 16px;border-radius:20px;font-size:.83em;font-weight:700;border:1px solid rgba(255,255,255,.2);backdrop-filter:blur(4px)"></span>
                </div>
                <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
                    <button onclick="sscShowSection('play')" id="sscTabPlay" style="background:rgba(255,255,255,.92);color:#4a148c;border:none;padding:9px 20px;border-radius:22px;cursor:pointer;font-weight:800;font-size:.88em;transition:all .2s;box-shadow:0 3px 10px rgba(0,0,0,.2)">ðŸŽ® Play</button>
                    <button onclick="sscShowSection('lb')" id="sscTabLB" style="background:rgba(255,255,255,.15);color:white;border:2px solid rgba(255,255,255,.4);padding:9px 20px;border-radius:22px;cursor:pointer;font-weight:700;font-size:.88em;transition:all .2s">ðŸ† Leaderboard</button>
                    <button onclick="sscGoBack()" style="background:rgba(255,255,255,.1);color:white;border:1px solid rgba(255,255,255,.3);padding:9px 18px;border-radius:22px;cursor:pointer;font-weight:600;font-size:.83em;transition:all .2s">â¬…ï¸ Back</button>
                    <button onclick="logout()" style="background:rgba(0,0,0,.3);color:rgba(255,255,255,.85);border:none;padding:9px 18px;border-radius:22px;cursor:pointer;font-weight:600;font-size:.83em;transition:all .2s">Logout</button>
                </div>
            </div>

            <!-- PLAY SECTION -->
            <div id="sscPlaySection" class="content" style="margin-bottom:20px;background:linear-gradient(160deg,#faf0ff 0%,#fff5fb 100%);border:1px solid rgba(106,27,154,.1);box-shadow:0 8px 32px rgba(106,27,154,.08)">
                <div id="sscSetupCard">
                    <!-- Paused banner -->
                    <div id="sscPausedBanner" style="display:none;background:linear-gradient(135deg,#fff3e0,#ffe0b2);border:2px solid #ff9800;border-radius:12px;padding:18px 22px;margin-bottom:22px;border-left:6px solid #ff6f00">
                        <h4 style="color:#e65100;margin:0 0 6px;font-size:1.05em">â¸ï¸ Game Currently Paused</h4>
                        <p style="color:#bf360c;margin:0;font-size:.9em">The organiser has temporarily paused the Speed Slide Challenge. You can still view the Leaderboard. Check back soon!</p>
                    </div>

                    <!-- Title -->
                    <div style="text-align:center;margin-bottom:28px">
                        <div style="font-size:3em;margin-bottom:6px">ðŸ§©</div>
                        <h2 style="color:#4a148c;margin:0;font-size:1.9em;font-weight:900;letter-spacing:-.5px">New Game</h2>
                        <p style="color:#9c27b0;margin:6px 0 0;font-size:.95em;font-weight:500">Choose your difficulty and upload a photo to begin</p>
                    </div>

                    <!-- Step 1: Difficulty -->
                    <div style="margin-bottom:24px">
                        <div style="display:flex;align-items:center;gap:10px;margin-bottom:16px">
                            <div style="background:linear-gradient(135deg,#6a1b9a,#c44569);color:white;width:30px;height:30px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:800;font-size:.95em;flex-shrink:0">1</div>
                            <h3 style="color:#333;margin:0;font-size:1.05em;font-weight:700">Choose Difficulty</h3>
                        </div>
                        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:14px;margin-bottom:10px">
                            <div id="ssdc-easy" onclick="sscSelectDiff('easy')" class="ssc-diff-card">
                                <div class="diff-emoji">ðŸ˜Š</div>
                                <div style="font-weight:800;color:#333;margin-top:8px;font-size:1.1em">8-Puzzle</div>
                                <div style="font-size:.8em;color:#999;margin-top:4px">3Ã—3 grid Â· 8 tiles</div>
                                <div style="font-size:.75em;color:#888;margin-top:2px">Beginner</div>
                                <div style="font-size:.75em;color:#2e7d32;margin-top:4px;font-weight:700">ðŸŽ¯ Solvable in ~10 moves</div>
                                <span style="display:inline-block;background:linear-gradient(135deg,#43a047,#66bb6a);color:white;padding:5px 16px;border-radius:14px;font-size:.82em;font-weight:800;margin-top:10px;letter-spacing:.3px">100 pts max</span>
                            </div>
                            <div id="ssdc-medium" onclick="sscSelectDiff('medium')" class="ssc-diff-card ssc-selected">
                                <div class="diff-emoji">ðŸ˜„</div>
                                <div style="font-weight:800;color:#333;margin-top:8px;font-size:1.1em">15-Puzzle</div>
                                <div style="font-size:.8em;color:#999;margin-top:4px">4Ã—4 grid Â· 15 tiles</div>
                                <div style="font-size:.75em;color:#9c27b0;margin-top:2px;font-weight:700">â­ Popular</div>
                                <div style="font-size:.75em;color:#6a1b9a;margin-top:4px;font-weight:700">ðŸŽ¯ Solvable in ~15 moves</div>
                                <span style="display:inline-block;background:linear-gradient(135deg,#6a1b9a,#c44569);color:white;padding:5px 16px;border-radius:14px;font-size:.82em;font-weight:800;margin-top:10px;letter-spacing:.3px">200 pts max</span>
                            </div>
                            <div id="ssdc-hard" onclick="sscSelectDiff('hard')" class="ssc-diff-card">
                                <div class="diff-emoji">ðŸ”¥</div>
                                <div style="font-weight:800;color:#333;margin-top:8px;font-size:1.1em">24-Puzzle</div>
                                <div style="font-size:.8em;color:#999;margin-top:4px">5Ã—5 grid Â· 24 tiles</div>
                                <div style="font-size:.75em;color:#e65100;margin-top:2px;font-weight:700">ðŸ”¥ Expert</div>
                                <div style="font-size:.75em;color:#bf360c;margin-top:4px;font-weight:700">ðŸŽ¯ Solvable in ~20 moves</div>
                                <span style="display:inline-block;background:linear-gradient(135deg,#e65100,#ff6f00);color:white;padding:5px 16px;border-radius:14px;font-size:.82em;font-weight:800;margin-top:10px;letter-spacing:.3px">300 pts max</span>
                            </div>
                        </div>
                        <div style="background:rgba(106,27,154,.06);border-radius:10px;padding:10px 14px;border-left:3px solid #9c27b0">
                            <p id="sscDiffNote" style="color:#6a1b9a;font-size:.88em;margin:0;font-weight:600">15-Puzzle (4Ã—4) Â· 200 max points</p>
                        </div>
                    </div>

                    <!-- Step 2: Upload -->
                    <div style="margin-bottom:24px">
                        <div style="display:flex;align-items:center;gap:10px;margin-bottom:14px">
                            <div style="background:linear-gradient(135deg,#6a1b9a,#c44569);color:white;width:30px;height:30px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:800;font-size:.95em;flex-shrink:0">2</div>
                            <h3 style="color:#333;margin:0;font-size:1.05em;font-weight:700">Upload Your Photo</h3>
                        </div>
                        <div id="sscUploadZone" onclick="document.getElementById('sscImgInput').click()" class="ssc-upload-zone">
                            <div style="font-size:2.8em;margin-bottom:6px">ðŸ“¸</div>
                            <p style="color:#6a1b9a;font-weight:700;margin:0 0 4px;font-size:1.05em">Tap to upload a photo</p>
                            <p style="color:#bbb;font-size:.82em;margin:0">JPG / PNG Â· max 5 MB</p>
                            <img id="sscPreviewThumb" style="max-width:100%;max-height:180px;border-radius:12px;margin-top:14px;border:3px solid #4caf50;box-shadow:0 4px 16px rgba(0,0,0,.15);display:none" alt="">
                        </div>
                        <input type="file" id="sscImgInput" accept="image/*" style="display:none" onchange="sscHandleImage(event)">
                    </div>

                    <!-- Start button -->
                    <button id="sscStartBtn" onclick="sscStartGame()" disabled style="width:100%;padding:18px;background:linear-gradient(135deg,#1b5e20,#2e7d32,#43a047);color:white;border:none;border-radius:14px;font-size:1.2em;font-weight:800;cursor:pointer;opacity:.45;transition:all .3s;letter-spacing:.5px;box-shadow:0 6px 20px rgba(67,160,71,.4)">â–¶ &nbsp;Start Puzzle</button>
                </div>

                <!-- Live game area -->
                <div id="sscGameArea" style="display:none">
                    <!-- Top bar: diff label only -->
                    <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:8px;margin-bottom:14px">
                        <span id="sscGameDiffLabel" style="background:linear-gradient(135deg,#6a1b9a,#c44569);color:white;padding:7px 18px;border-radius:20px;font-weight:800;font-size:.9em;letter-spacing:.3px"></span>
                        <span id="sscLiveScore" style="background:linear-gradient(135deg,#ffd700,#ffab00);color:#1a0030;padding:7px 18px;border-radius:20px;font-weight:900;font-size:.9em;display:none">â­ <span id="sscLiveScoreVal">â€”</span></span>
                    </div>

                    <!-- Board â€” full width, max space -->
                    <div style="width:100%;margin-bottom:16px;touch-action:none">
                        <div id="sscPuzzleBoard" style="display:grid;gap:5px;touch-action:none;user-select:none;width:100%"></div>
                    </div>

                    <!-- Stats + Preview row below board -->
                    <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;margin-bottom:14px">
                        <div class="ssc-stat-box" style="background:linear-gradient(135deg,#fff3e0,#ffe0b2);border:2px solid #ffb300;margin:0">
                            <div id="sscTimerDisplay" class="ssc-stat-val" style="color:#e65100;font-family:monospace;font-size:1.3em">0:00</div>
                            <div class="ssc-stat-lbl">â± Time</div>
                        </div>
                        <div class="ssc-stat-box" style="background:linear-gradient(135deg,#f3e5f5,#e1bee7);border:2px solid #9c27b0;margin:0">
                            <div id="sscMovesDisplay" class="ssc-stat-val" style="color:#6a1b9a;font-size:1.3em">0</div>
                            <div class="ssc-stat-lbl">ðŸŽ¯ Moves</div>
                        </div>
                        <div class="ssc-stat-box" style="background:linear-gradient(135deg,#1a0030,#3d0060);border:2px solid rgba(255,215,0,.3);margin:0">
                            <div id="sscPtsDisplay" class="ssc-stat-val" style="color:#ffd700;font-size:1.3em">â€”</div>
                            <div class="ssc-stat-lbl" style="color:rgba(255,255,255,.6)">â­ Pts</div>
                        </div>
                    </div>

                    <!-- Preview image full width below stats -->
                    <div id="sscInGamePreviewWrap" style="text-align:center;margin-bottom:16px;display:none">
                        <p style="font-size:.72em;color:#9c27b0;margin:0 0 6px;font-weight:700;text-transform:uppercase;letter-spacing:.8px">ðŸ“¸ Preview</p>
                        <img id="sscInGamePreview" style="max-width:180px;width:100%;object-fit:cover;border-radius:12px;border:2px solid rgba(106,27,154,.4);box-shadow:0 4px 16px rgba(0,0,0,.15)" alt="">
                    </div>

                    <!-- Action buttons: Give Up, New Game, Back, Logout -->
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
                        <button onclick="sscShowSolution()" style="background:linear-gradient(135deg,#555,#777);color:white;border:none;padding:12px 10px;border-radius:12px;cursor:pointer;font-weight:700;font-size:.9em;transition:all .2s;box-shadow:0 3px 10px rgba(0,0,0,.2)">ðŸ‘ Give Up</button>
                        <button onclick="sscResetGame()" style="background:linear-gradient(135deg,#e53935,#ff7043);color:white;border:none;padding:12px 10px;border-radius:12px;cursor:pointer;font-weight:700;font-size:.9em;transition:all .2s;box-shadow:0 3px 10px rgba(229,57,53,.35)">ðŸ”„ New Game</button>
                        <button onclick="sscGoBack()" style="background:linear-gradient(135deg,#1565c0,#1976d2);color:white;border:none;padding:12px 10px;border-radius:12px;cursor:pointer;font-weight:700;font-size:.9em;transition:all .2s;box-shadow:0 3px 10px rgba(21,101,192,.3)">â¬…ï¸ Back</button>
                        <button onclick="logout()" style="background:linear-gradient(135deg,#2d2d2d,#444);color:rgba(255,255,255,.9);border:none;padding:12px 10px;border-radius:12px;cursor:pointer;font-weight:700;font-size:.9em;transition:all .2s;box-shadow:0 3px 10px rgba(0,0,0,.25)">ðŸšª Logout</button>
                    </div>
                    <!-- Fallback submit button â€” only shown after puzzle is solved if Save Score fails -->
                    <div id="sscMarkCompleteSection" style="display:none;margin-top:12px;padding-top:12px;border-top:2px dashed rgba(106,27,154,.25)">
                        <p style="color:#888;font-size:.78em;margin:0 0 7px;text-align:center">âš ï¸ Puzzle complete but Save Score not working?</p>
                        <button onclick="sscMarkComplete()" id="sscMarkCompleteBtnGame" style="background:linear-gradient(135deg,#f57f17,#ff8f00);color:white;border:none;padding:13px 10px;border-radius:12px;cursor:pointer;font-weight:800;font-size:.95em;transition:all .2s;box-shadow:0 4px 16px rgba(245,127,23,.4);width:100%">âœ… I Completed It! â€” Submit My Score</button>
                    </div>
                </div>
            </div>

            <!-- LEADERBOARD SECTION -->
            <div id="sscLbSection" class="content" style="display:none;margin-bottom:20px">
                <h2 style="color:#c44569;margin-bottom:16px">ðŸ† Leaderboard</h2>
                <div style="display:flex;gap:8px;margin-bottom:14px;flex-wrap:wrap">
                    <button class="tab active" id="ssclbt-easy"   onclick="sscSwitchLB('easy')">ðŸ˜Š 8-Puzzle</button>
                    <button class="tab"        id="ssclbt-medium" onclick="sscSwitchLB('medium')">ðŸ˜„ 15-Puzzle</button>
                    <button class="tab"        id="ssclbt-hard"   onclick="sscSwitchLB('hard')">ðŸ”¥ 24-Puzzle</button>
                    <button class="tab"        id="ssclbt-all"    onclick="sscSwitchLB('all')">ðŸ“Š All</button>
                </div>
                <div id="sscLbContainer"><p style="color:#aaa;text-align:center;padding:30px">Loadingâ€¦</p></div>
            </div>

            <!-- WIN MODAL -->
            <div id="sscWinModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.85);z-index:9999;align-items:center;justify-content:center;backdrop-filter:blur(6px)">
                <div class="ssc-win-inner" style="position:relative;overflow:hidden">
                    <!-- Animated celebration bg -->
                    <div style="position:absolute;inset:0;background:radial-gradient(circle at 30% 20%,rgba(255,215,0,.15) 0%,transparent 55%),radial-gradient(circle at 70% 80%,rgba(196,69,105,.18) 0%,transparent 55%);pointer-events:none"></div>

                    <!-- Floating emoji burst -->
                    <div id="sscWinEmojiBurst" style="position:absolute;inset:0;pointer-events:none;overflow:hidden"></div>

                    <div style="font-size:5em;margin-bottom:4px;animation:sscWinBounce 0.6s cubic-bezier(.36,.07,.19,.97) both">ðŸ†</div>
                    <div style="font-size:2em;margin-bottom:6px;letter-spacing:4px;animation:sscWinPop 0.5s ease both">ðŸŽ‰ðŸŽŠðŸ¥³</div>
                    <h2 style="color:#ffd700;font-size:2em;margin:0 0 2px;font-weight:900;text-shadow:0 2px 16px rgba(255,215,0,.6);animation:sscWinPop 0.4s ease both">Puzzle Solved!</h2>
                    <p style="color:rgba(255,255,255,.75);margin:0 0 20px;font-size:1em;animation:sscWinPop 0.5s .1s ease both">ðŸŒŸ Outstanding! You crushed it! ðŸŒŸ</p>

                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:20px">
                        <div class="ssc-win-stat">
                            <div id="sscWinTime" style="font-size:1.6em;font-weight:900;color:#80deea">â€”</div>
                            <div style="font-size:.75em;color:rgba(255,255,255,.5);margin-top:3px;text-transform:uppercase;letter-spacing:.5px">â± Time</div>
                        </div>
                        <div class="ssc-win-stat">
                            <div id="sscWinMoves" style="font-size:1.6em;font-weight:900;color:#ce93d8">â€”</div>
                            <div style="font-size:.75em;color:rgba(255,255,255,.5);margin-top:3px;text-transform:uppercase;letter-spacing:.5px">ðŸŽ¯ Moves</div>
                        </div>
                        <div class="ssc-win-stat">
                            <div id="sscWinDiff" style="font-size:1.4em;font-weight:900;color:#a5d6a7">â€”</div>
                            <div style="font-size:.75em;color:rgba(255,255,255,.5);margin-top:3px;text-transform:uppercase;letter-spacing:.5px">ðŸŽ® Level</div>
                        </div>
                        <div style="background:linear-gradient(135deg,rgba(255,215,0,.3),rgba(255,171,0,.2));border-radius:12px;padding:14px 8px;border:2px solid rgba(255,215,0,.5);box-shadow:0 0 20px rgba(255,215,0,.2)">
                            <div id="sscWinPts" style="font-size:1.9em;font-weight:900;color:#ffd700;animation:sscScoreCount .6s ease both">â€”</div>
                            <div style="font-size:.75em;color:rgba(255,215,0,.8);margin-top:3px;text-transform:uppercase;letter-spacing:.5px;font-weight:700">â­ Points</div>
                        </div>
                    </div>

                    <p id="sscWinSaveMsg" style="color:#a5d6a7;font-weight:600;margin-bottom:16px;min-height:40px;font-size:.92em;line-height:1.5;text-align:center"></p>

                    <!-- Retry button â€” shown only if Firebase save fails completely -->
                    <div id="sscRetryWrap" style="display:none;margin-bottom:14px">
                        <button onclick="sscRetrySave()" style="background:linear-gradient(135deg,#e65100,#ff6d00);color:white;border:none;padding:12px 24px;border-radius:12px;font-size:.95em;font-weight:800;cursor:pointer;width:100%;box-shadow:0 4px 16px rgba(230,81,0,.4)">â†©ï¸ Retry Save</button>
                        <p style="color:rgba(255,255,255,.4);font-size:.72em;margin:8px 0 0;text-align:center">Make sure you have internet connection before retrying</p>
                    </div>

                    <div style="display:flex;gap:10px;justify-content:center;flex-wrap:wrap">
                        <button id="sscSaveScoreBtn" style="display:none"></button>
                        <button onclick="sscResetGame()" style="background:rgba(255,255,255,.12);color:white;border:1px solid rgba(255,255,255,.25);padding:14px 28px;border-radius:12px;font-size:1em;font-weight:700;cursor:pointer;transition:all .2s">ðŸ”„ Play Again</button>
                    </div>

                    <!-- Student instructions -->
                    <div style="margin-top:16px;padding:12px 14px;background:rgba(255,255,255,.06);border-radius:10px;border:1px solid rgba(255,255,255,.1);text-align:left">
                        <p style="color:#ffd700;font-size:.78em;font-weight:700;margin:0 0 6px">ðŸ“‹ What happens after you solve the puzzle:</p>
                        <p style="color:rgba(255,255,255,.55);font-size:.74em;margin:0;line-height:1.6">
                            1ï¸âƒ£ Your score is <strong style="color:#a5d6a7">saved automatically</strong> â€” no button needed<br>
                            2ï¸âƒ£ Your photo uploads in the background<br>
                            3ï¸âƒ£ Status shows above â€” wait for âœ… before closing<br>
                            4ï¸âƒ£ If you see âŒ â€” check internet &amp; tap Retry Save<br>
                            5ï¸âƒ£ Score is <strong style="color:#a5d6a7">pending admin approval</strong> before it appears on leaderboard
                        </p>
                    </div>
                    <div style="margin-top:10px;padding-top:10px;border-top:1px solid rgba(255,255,255,.12)">
                        <button onclick="sscMarkComplete()" id="sscMarkCompleteBtn" style="display:none"></button>
                    </div>
                </div>
            </div>

            <!-- GAME OVER MODAL -->
            <!-- GIVE UP / GAME OVER MODAL -->
            <div id="sscGameOverModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.88);z-index:9999;align-items:center;justify-content:center;backdrop-filter:blur(8px);overflow-y:auto;padding:16px 0">
                <div style="background:linear-gradient(160deg,#12001a 0%,#2d0045 60%,#1a0008 100%);border-radius:24px;padding:0;max-width:540px;width:94%;animation:sscWinPop .45s ease both;box-shadow:0 28px 70px rgba(0,0,0,.7),0 0 0 2px rgba(196,69,105,.25);overflow:hidden;position:relative;margin:auto">

                    <!-- Header band -->
                    <div style="background:linear-gradient(135deg,#b71c1c,#c44569);padding:26px 24px 20px;text-align:center;position:relative">
                        <div id="sscBooEmojiBurst" style="position:absolute;inset:0;pointer-events:none;overflow:hidden"></div>
                        <div style="font-size:3.2em;margin-bottom:6px;animation:sscBooShake 0.4s ease both">ðŸ˜”</div>
                        <div style="font-size:1.6em;margin-bottom:6px;letter-spacing:2px;animation:sscBooShake 0.5s .1s ease both">ðŸ‘ŽðŸ‘ŽðŸ‘Ž</div>
                        <h2 style="color:white;font-size:1.6em;margin:0 0 4px;font-weight:900;letter-spacing:-.3px">You Gave Up!</h2>
                        <p style="color:rgba(255,255,255,.7);margin:0;font-size:.88em">Score not saved Â· Watch how it's solved below</p>
                    </div>

                    <!-- Stats row -->
                    <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:10px;padding:20px 20px 0">
                        <div style="background:rgba(255,255,255,.07);border-radius:12px;padding:14px 8px;text-align:center;border:1px solid rgba(255,255,255,.1)">
                            <div id="sscSolTime" style="font-size:1.4em;font-weight:900;color:#80deea">â€”</div>
                            <div style="font-size:.7em;color:rgba(255,255,255,.45);margin-top:4px;text-transform:uppercase;letter-spacing:.5px">â± Time</div>
                        </div>
                        <div style="background:rgba(255,255,255,.07);border-radius:12px;padding:14px 8px;text-align:center;border:1px solid rgba(255,255,255,.1)">
                            <div id="sscSolMoves" style="font-size:1.4em;font-weight:900;color:#ce93d8">â€”</div>
                            <div style="font-size:.7em;color:rgba(255,255,255,.45);margin-top:4px;text-transform:uppercase;letter-spacing:.5px">ðŸŽ¯ Moves Made</div>
                        </div>
                        <div style="background:rgba(255,255,255,.07);border-radius:12px;padding:14px 8px;text-align:center;border:1px solid rgba(255,255,255,.1)">
                            <div id="sscSolDiff" style="font-size:1.4em;font-weight:900;color:#a5d6a7">â€”</div>
                            <div style="font-size:.7em;color:rgba(255,255,255,.45);margin-top:4px;text-transform:uppercase;letter-spacing:.5px">ðŸŽ® Level</div>
                        </div>
                    </div>

                    <!-- Solution section -->
                    <div style="padding:18px 20px 0">
                        <div style="background:rgba(255,193,7,.08);border:1px solid rgba(255,193,7,.25);border-radius:12px;padding:12px 14px;margin-bottom:16px;display:flex;align-items:flex-start;gap:10px">
                            <span style="font-size:1.3em;flex-shrink:0">ðŸ’¡</span>
                            <div>
                                <div style="color:#ffd54f;font-weight:700;font-size:.9em;margin-bottom:2px">Watch the Solution</div>
                                <div style="color:rgba(255,255,255,.55);font-size:.8em;line-height:1.5">The tiles will animate to show you every move needed to solve the puzzle from where you left off.</div>
                            </div>
                        </div>

                        <!-- Step counter -->
                        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:10px">
                            <div style="color:rgba(255,255,255,.5);font-size:.8em;text-transform:uppercase;letter-spacing:.5px;font-weight:600">Solution Progress</div>
                            <div style="color:#ffd54f;font-size:.85em;font-weight:700" id="sscSolStepCounter">â€”</div>
                        </div>

                        <!-- Mini board replay -->
                        <div style="background:rgba(0,0,0,.35);border-radius:16px;padding:14px;margin-bottom:14px;border:1px solid rgba(255,255,255,.08)">
                            <div id="sscSolBoard" style="display:grid;gap:4px;margin:0 auto;width:fit-content"></div>
                        </div>

                        <!-- Step description -->
                        <div id="sscSolMoveDesc" style="background:rgba(255,255,255,.06);border-radius:10px;padding:12px 14px;text-align:center;margin-bottom:16px;min-height:42px;border:1px solid rgba(255,255,255,.08)">
                            <span style="color:rgba(255,255,255,.6);font-size:.88em">Calculating solutionâ€¦</span>
                        </div>

                        <!-- Replay controls -->
                        <div style="display:flex;gap:8px;justify-content:center;margin-bottom:18px;flex-wrap:wrap">
                            <button id="sscSolPlayBtn" onclick="sscSolPlayPause()" style="background:linear-gradient(135deg,#6a1b9a,#c44569);color:white;border:none;padding:10px 20px;border-radius:10px;font-size:.88em;font-weight:700;cursor:pointer;min-width:90px">â–¶ Play</button>
                            <button onclick="sscSolStepBack()" style="background:rgba(255,255,255,.1);color:white;border:1px solid rgba(255,255,255,.2);padding:10px 16px;border-radius:10px;font-size:.88em;font-weight:600;cursor:pointer">â® Back</button>
                            <button onclick="sscSolStepFwd()" style="background:rgba(255,255,255,.1);color:white;border:1px solid rgba(255,255,255,.2);padding:10px 16px;border-radius:10px;font-size:.88em;font-weight:600;cursor:pointer">Fwd â­</button>
                        </div>
                    </div>

                    <!-- Footer buttons -->
                    <div style="padding:0 20px 24px;display:flex;gap:10px;justify-content:center;flex-wrap:wrap">
                        <button onclick="sscResetGame()" style="background:linear-gradient(135deg,#2e7d32,#43a047);color:white;border:none;padding:13px 26px;border-radius:12px;font-size:.95em;font-weight:800;cursor:pointer;box-shadow:0 4px 16px rgba(67,160,71,.3)">ðŸ”„ Try Again</button>
                        <button onclick="sscShowSection('lb')" style="background:rgba(255,255,255,.1);color:white;border:1px solid rgba(255,255,255,.2);padding:13px 22px;border-radius:12px;font-size:.95em;font-weight:700;cursor:pointer">ðŸ† Leaderboard</button>
                        <button onclick="document.getElementById('sscGameOverModal').style.display='none';logout();" style="background:rgba(220,53,69,.25);color:#ff8a80;border:1px solid rgba(220,53,69,.4);padding:13px 22px;border-radius:12px;font-size:.95em;font-weight:700;cursor:pointer">ðŸšª Logout</button>
                    </div>
                </div>
            </div>

                </div>
        <!-- â•â• END SPEED SLIDE DASHBOARD â•â• -->

    <!-- Firebase Status Indicator -->
    <div class="firebase-status">
        <div class="status-dot status-disconnected" id="statusDot"></div>
        <span id="statusText">Connecting...</span>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirmModal" class="modal">
        <div class="modal-content">
            <div class="modal-icon">âš ï¸</div>
            <div class="modal-header" id="modalMessage"></div>
            <div class="modal-buttons">
                <button class="btn btn-success" onclick="confirmAction()">Yes, Proceed</button>
                <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Edit Enrollment Modal -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">âœï¸ Edit Enrollment</div>
            <div id="editFormContainer"></div>
            <div class="modal-buttons">
                <button class="btn btn-success" onclick="saveEdit()">Save Changes</button>
                <button class="btn btn-secondary" onclick="closeEditModal()">Cancel</button>
            </div>
        </div>
    </div>
    
    <!-- Quiz Date Edit Modal -->
    <div id="quizDateEditModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">ðŸ“… Confirm Date Change</div>
            <p id="dateEditModalMessage" style="text-align:center;margin:20px 0"></p>
            <div class="modal-buttons">
                <button class="btn btn-warning" onclick="confirmDateChange()">âœ… Confirm</button>
                <button class="btn btn-secondary" onclick="closeQuizDateEditModal()">âŒ Cancel</button>
            </div>
        </div>
    </div>

    <script data-cfasync="false" src="/cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script><script>
        // Firebase Configuration - YOUR ACTUAL CONFIG
        const firebaseConfig = {
            apiKey: "AIzaSyCkjglXJOsXEqGrlavYL4vQ635BV_dbMzY",
            authDomain: "spurthi-youthfest-2026.firebaseapp.com",
            databaseURL: "https://spurthi-youthfest-2026-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "spurthi-youthfest-2026",
            storageBucket: "spurthi-youthfest-2026.firebasestorage.app",
            messagingSenderId: "840281252513",
            appId: "1:840281252513:web:13f32d3239b5f5664ec6e0"
        };

        let db, ref;
        try {
            // Guard: only initialize if not already initialized
            if (!firebase.apps.length) {
                firebase.initializeApp(firebaseConfig);
            }
            db = firebase.database();
            window.db = db;  // expose globally so leaderboard script block can use it
            window.storage = firebase.storage();  // expose for Speed Slide image uploads
            ref = db.ref('youthfest-enrollments');
        } catch (e) {
            console.error('Firebase error:', e);
            // Show user-visible warning without breaking the page
            document.addEventListener('DOMContentLoaded', function() {
                const warn = document.createElement('div');
                warn.style.cssText = 'position:fixed;top:0;left:0;right:0;background:#c62828;color:white;text-align:center;padding:10px;font-weight:700;z-index:99999;font-size:14px';
                warn.innerHTML = 'âš ï¸ Database connection error. Please refresh the page. If the problem persists, contact support.';
                document.body.prepend(warn);
            });
        }

        // Global JS error guard â€” catches syntax/runtime errors in any script block
        // and logs them without crashing the whole app
        window.addEventListener('error', function(e) {
            console.error('[Global JS Error]', e.message, 'at', e.filename, 'line', e.lineno);
        });
        window.addEventListener('unhandledrejection', function(e) {
            console.error('[Unhandled Promise]', e.reason);
        });

        // Firebase Connection Status Monitor
        let isConnected = false;
        
        function updateFirebaseStatus(connected) {
            isConnected = connected;
            const statusDot = document.getElementById('statusDot');
            const statusText = document.getElementById('statusText');
            
            statusDot.className = 'status-dot';
            if (connected) {
                statusDot.classList.add('status-connected');
                statusText.textContent = 'ðŸŸ¢ Database Connected';
            } else {
                statusDot.classList.add('status-disconnected');
                statusText.textContent = 'ðŸ”´ Database Offline';
            }
        }
        
        // Check Firebase connection
        if (ref) {
            const connectedRef = db.ref('.info/connected');
            connectedRef.on('value', function(snap) {
                if (snap.val() === true) {
                    updateFirebaseStatus(true);
                } else {
                    updateFirebaseStatus(false);
                }
            });
            
            // Initial check after 2 seconds
            setTimeout(function() {
                ref.once('value').then(function() {
                    updateFirebaseStatus(true);
                }).catch(function() {
                    updateFirebaseStatus(false);
                });
            }, 2000);
        } else {
            setTimeout(function() {
                updateFirebaseStatus(false);
            }, 1000);
        }

        // Global Variables
        const classes = ['1st B.Com','2nd B.Com','3rd B.Com','1ST BCA','2ND BCA A SEC','2ND BCA B SEC','3RD BCA A SEC','3RD BCA B SEC','3RD BCA C SEC','2ND BBA','3RD BBA','Faculty/Principal/Vice-Principal/Staff','Others'];
        // NOTE: Firebase stores '.' as '_' in keys. The summary report's getStrength()
        // normalises both forms so '1st B.Com' and '1st B_Com' both match correctly.
        // DO NOT add '_Com' variants here â€” they are not real classes.
        window._appClasses = classes; // expose to other script blocks
        // individual: true = multiple students per class compete independently;
        //   jury scores each student; leaderboard picks best-per-class for winner/runner-up points.
        //   eligibleClasses is NOT set here â€” you define it per-event in Jury Setup when needed.
        const events = {
            'Pod Casting': {size:'Individual',count:1,role:false,topic:true,topicLabel:'Topic',allow:false,maxPerClass:3,individual:true,podcastTopics:['ðŸŒ Geo Politics','ðŸ™ï¸ Davangere','ðŸ‘¨â€ðŸ‘©â€ðŸ‘§ Family','ðŸ Sports']},
            'Mime': {size:'6 Members',count:6,role:true,topic:true,topicLabel:'Theme',allow:false,maxPerClass:1},
            'Interdisciplinary': {size:'5 Members',count:5,role:true,topic:true,topicLabel:'Topic',allow:false,maxPerClass:1},
            'Ramp Walk': {size:'Individual members',count:0,role:true,topic:true,topicLabel:'Theme',show:true,allow:false,maxPerClass:999,pctMax:30,dynamicCount:true},
            'Quiz': {size:'6 Members',count:6,role:true,allow:false,maxPerClass:1},
            'Vlog': {size:'2 Members',count:2,role:true,topic:true,topicLabel:'Topic',allow:true,maxPerClass:2,vlogTopics:['âœˆï¸ Travel Vlog','ðŸ½ï¸ Food Vlog','ðŸŽ‰ Event Vlog','ðŸŒ… Daily Life Vlog'],multiTeam:true},
            'YouTube Advertisement': {size:'8 Members',count:8,role:true,prod:true,allow:false,maxPerClass:1},
            'Mad Ads': {size:'8 Members',count:8,role:true,topic:true,topicLabel:'Topic',allow:false,maxPerClass:1},
            'Hand Writing': {size:'Individual',count:1,role:false,lang:true,allow:false,maxPerClass:999,pctMax:15,oneAtATime:true,individual:true},
            'Best out of Waste': {size:'2 Members (or Individual)',count:2,role:true,allow:true,maxPerClass:999,pctMax:10,allowIndividual:true,multiTeam:true},
            'Social Awareness Skit': {size:'8 Members',count:8,role:true,cause:true,allow:false,maxPerClass:1},
            'Talent Hunt': {size:'Individual',count:1,role:false,talent:true,allow:true,maxPerClass:6,oneAtATime:true,individual:true},
            'Group Dance': {size:'5-8 Members',count:5,role:true,allow:false,maxPerClass:1,minCount:5,maxCount:8},
            'Nukkad Natak': {size:'8 to 30% of class',count:8,role:true,cause:true,causeLabel:'Social Awareness Theme',allow:false,maxPerClass:1,pctMax:30,dynamicCount:true,minCount:8,camera:true,adviser:true},
            'Case Analysis': {size:'2 Members',count:2,role:true,allow:false,maxPerClass:1}
        };

        let all = [];
        let currentUser = null;
        let studentClass = null;
        let crClass = null;
        let isAdmin = false;
        let isSuperAdmin = false;
        let isManager = false;
        let isManager2 = false;
        let isCR = false;
        let isJury = false;
        let juryEvent = null;
        let juryNumber = null;
        let selectedEvent = null;
        let adminPassword = 'admin123';
        let superAdminPassword = 'superadmin123';
        let managerPassword = 'manager123'; // Change this to your desired manager password
        let manager2Password = 'manager2123'; // Change this to your desired Manager 2 password

        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // MANAGER PERMISSIONS â€” Super Admin toggles these in the Manager Permissions
        // panel (inside the Admin section). Each key = one feature.
        // true  = manager CAN access it
        // false = manager CANNOT access it (hidden/blocked)
        //
        // TO ADD A NEW PERMISSION IN FUTURE:
        //   1. Add a new key:value pair here
        //   2. Add a matching toggle row in the Manager Permissions Panel HTML
        //      (search "managerPermissionsPanel" in this file)
        //   3. Use:  if (isManager && !managerPermissions.yourNewKey) return;
        //      OR:   add your tab button with class "manager-controlled" and
        //            data-perm="yourNewKey"
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        let managerPermissions = {
            quizManagement:    true,   // ðŸ“ Quiz Management tab (add/edit questions, publish)
            scavengerAdmin:    true,   // ðŸ—ºï¸ Scavenger Hunt tab (add tasks, approve submissions)
            viewRegistrations: true,   // ðŸ“‹ View Master List & Events tabs (read-only)
            viewResults:       true,   // ðŸ† View Results tab
            whatsappMessages:  true,   // ðŸ“² Copy WhatsApp broadcast messages
            pdfHandouts:       true,   // ðŸ“„ PDF Handouts â€” upload event PDFs
            paymentApproval:   true,   // ðŸ’³ Payment Approval â€” approve/reject registrations
            eventSchedule:     true,   // ðŸ“… Event Schedule â€” add/edit/delete events
        };

        // Load saved permissions from localStorage on page load
        (function loadManagerPermissions() {
            const saved = localStorage.getItem('spurthi_manager_perms');
            if (saved) {
                try {
                    const parsed = JSON.parse(saved);
                    Object.keys(parsed).forEach(k => {
                        if (k in managerPermissions) managerPermissions[k] = parsed[k];
                    });
                } catch(e) {}
            }
        })();
        
        // Quiz Competition Variables
        let quizCurrentUser = null;
        let quizUserRole = null;
        let quizStartTime = null;
        let quizAntiCheatActive = false;
        let quizTimerInterval = null;

        // Speed Slide Challenge globals (declared here so logout() can access them)
        let sscCurrentUser = null;
        let sscTimerRef    = null;

        // Initialize
        window.onload = function() {
            populateClassSelects();
            populateEventSelects();
            loadData();
            
            // Firebase connection status
            const connectedRef = db.ref('.info/connected');
            connectedRef.on('value', (snap) => {
                const dot = document.getElementById('statusDot');
                const text = document.getElementById('statusText');
                if (snap.val() === true) {
                    dot.className = 'status-dot status-connected';
                    text.textContent = 'Connected';
                } else {
                    dot.className = 'status-dot status-disconnected';
                    text.textContent = 'Disconnected';
                }
            });
        };

        function populateClassSelects() {
            const selects = ['studentClass','studentClassModal','crClass','filterClass','paManualName'];
            selects.forEach(id => {
                const sel = document.getElementById(id);
                if (sel) {
                    const classesToShow = (id === 'studentClass' || id === 'studentClassModal' || id === 'crClass') 
                        ? classes.filter(c => c !== 'Faculty/Principal/Vice-Principal/Staff' && c !== 'Others')
                        : classes.filter(c => c !== 'Faculty/Principal/Vice-Principal/Staff' && c !== 'Others');
                    classesToShow.forEach(c => {
                        const opt = document.createElement('option');
                        opt.value = c;
                        opt.textContent = c;
                        sel.appendChild(opt);
                    });
                }
            });
        }

        function populateEventSelects() {
            const selects = ['filterEvent','crFilterEvent','setupEventSelect','resultsEventSelect','juryEvent','liveMonitorEvent'];
            selects.forEach(id => {
                const sel = document.getElementById(id);
                if (sel) {
                    Object.keys(events).forEach(e => {
                        const opt = document.createElement('option');
                        opt.value = e;
                        opt.textContent = e;
                        sel.appendChild(opt);
                    });
                }
            });
        }

        function loadData() {
            ref.on('value', snap => {
                console.log('=== FIREBASE DATA LOADED (listener) ===');
                console.log('Snapshot exists?', snap.exists());
                
                all = [];
                let childCount = 0;
                if (snap.exists()) {
                    snap.forEach(child => {
                        childCount++;
                        const data = {id: child.key, ...child.val()};
                        console.log('Child #' + childCount + ':', child.key, 'â†’', data.classYear, '-', data.event, '-', data.name);
                        all.push(data);
                    });
                }
                
                console.log('Total children loaded:', childCount);
                console.log('All array length:', all.length);
                
                // Show class breakdown
                const classCounts = {};
                all.forEach(e => {
                    if (!classCounts[e.classYear]) classCounts[e.classYear] = 0;
                    classCounts[e.classYear]++;
                });
                console.log('Data by class:', classCounts);
                
                if (isAdmin || isSuperAdmin) {
                    updateStats();
                    updateMaster();
                    updateEvents();
                }
                if (isCR) {
                    updateCRView();
                }
                // Update student view when data changes
                if (studentClass && document.getElementById('studentSection').style.display === 'block') {
                    if (!window._classStrengths) {
                        db.ref('leaderboardConfig/classStrengths').once('value').then(s => {
                            window._classStrengths = s.val() || {};
                            renderEventCards();
                        }).catch(() => renderEventCards());
                    } else {
                        renderEventCards();
                    }
                }
            });
        }

        function handleUserTypeChange() {
            const type = document.getElementById('userType').value;
            document.getElementById('crLogin').style.display = type === 'cr' ? 'block' : 'none';
            document.getElementById('adminLogin').style.display = type === 'admin' ? 'block' : 'none';
            document.getElementById('superAdminLogin').style.display = type === 'superadmin' ? 'block' : 'none';
            document.getElementById('managerLogin').style.display = type === 'manager' ? 'block' : 'none';
            document.getElementById('manager2Login').style.display = type === 'manager2' ? 'block' : 'none';
            document.getElementById('juryLogin').style.display = type === 'jury' ? 'block' : 'none';

            // Auto-fill saved credentials
            if (type === 'cr' && localStorage.getItem('spurthi_cr_remember') === '1') {
                const savedCls = localStorage.getItem('spurthi_cr_class');
                if (savedCls) {
                    const sel = document.getElementById('crClass');
                    // Wait for options to populate if needed
                    const trySet = () => {
                        if (sel.options.length > 1) { sel.value = savedCls; }
                        else { setTimeout(trySet, 100); }
                    };
                    trySet();
                }
                document.getElementById('crRememberMe').checked = true;
            }
            if (type === 'admin' && localStorage.getItem('spurthi_admin_remember') === '1') {
                const saved = localStorage.getItem('spurthi_admin_pwd');
                if (saved) document.getElementById('adminPassword').value = saved;
                document.getElementById('adminRememberMe').checked = true;
            }
            if (type === 'superadmin' && localStorage.getItem('spurthi_superadmin_remember') === '1') {
                const saved = localStorage.getItem('spurthi_superadmin_pwd');
                if (saved) document.getElementById('superAdminPassword').value = saved;
                document.getElementById('superAdminRememberMe').checked = true;
            }
            if (type === 'manager' && localStorage.getItem('spurthi_manager_remember') === '1') {
                const saved = localStorage.getItem('spurthi_manager_pwd');
                if (saved) document.getElementById('managerPassword').value = saved;
                document.getElementById('managerRememberMe').checked = true;
            }
            if (type === 'manager2' && localStorage.getItem('spurthi_manager2_remember') === '1') {
                const saved = localStorage.getItem('spurthi_manager2_pwd');
                if (saved) document.getElementById('manager2Password').value = saved;
                document.getElementById('manager2RememberMe').checked = true;
            }

            // Reset competition dropdown when user type is selected
            if (type) {
                document.getElementById('competitionType').value = '';
                document.getElementById('dailyQuizLogin').style.display = 'none';
            }
        }

        function handleCompetitionChange() {
            const type = document.getElementById('competitionType').value;
            document.getElementById('dailyQuizLogin').style.display     = type === 'dailyquiz'     ? 'block' : 'none';
            document.getElementById('scavengerHuntLogin').style.display = type === 'scavengerhunt' ? 'block' : 'none';
            document.getElementById('speedSlideLogin').style.display    = type === 'speedslide'    ? 'block' : 'none';
            if (type === 'speedslide') {
                if (localStorage.getItem('ssc_remember') === '1') {
                    const ph = localStorage.getItem('ssc_ph');
                    const pw = localStorage.getItem('ssc_pw');
                    if (ph) document.getElementById('sscLoginPhone').value    = ph;
                    if (pw) document.getElementById('sscLoginPassword').value = pw;
                    document.getElementById('sscRememberMe').checked = true;
                }
            }
            
            // Reset user type dropdown and hide credentials when competition is selected
            if (type) {
                document.getElementById('userType').value = '';
                document.getElementById('crLogin').style.display = 'none';
                document.getElementById('adminLogin').style.display = 'none';
                document.getElementById('superAdminLogin').style.display = 'none';
                document.getElementById('juryLogin').style.display = 'none';
            }
            
            if (type === 'dailyquiz') {
                fetchServerTimeOffset(); // pre-fetch server time offset early
                populateQuizClasses();
                checkPublicQuizStatus();
                initQuizArchiveDropdown();
                // Auto-fill remembered quiz credentials
                if (localStorage.getItem('quiz_remember') === '1') {
                    const ph = localStorage.getItem('quiz_ph');
                    const pw = localStorage.getItem('quiz_pw');
                    if (ph) document.getElementById('quizLoginPhone').value    = ph;
                    if (pw) document.getElementById('quizLoginPassword').value = pw;
                    const cb = document.getElementById('quizRememberMe');
                    if (cb) cb.checked = true;
                }
            }
            if (type === 'scavengerhunt') {
                shCheckPublicStatus();
                // Auto-fill saved credentials
                if (localStorage.getItem('spurthi_sh_remember') === '1') {
                    const savedPhone = localStorage.getItem('spurthi_sh_phone');
                    const savedPwd   = localStorage.getItem('spurthi_sh_pwd');
                    if (savedPhone) document.getElementById('shLoginPhone').value    = savedPhone;
                    if (savedPwd)   document.getElementById('shLoginPassword').value = savedPwd;
                    document.getElementById('shRememberMe').checked = true;
                }
            }
        }

        // â”€â”€ STUDENT AUTH MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function openStudentLoginModal() {
            const modal = document.getElementById('studentAuthModal');
            modal.style.display = 'flex';
            document.getElementById('studentAuthMsg').style.display = 'none';
            document.getElementById('studentAuthPhone').value = '';
            document.getElementById('studentAuthPwd').value = '';
        }

        function closeStudentAuthModal() {
            document.getElementById('studentAuthModal').style.display = 'none';
        }

        async function studentAuthLogin() {
            const _db  = window.db || (typeof db !== 'undefined' ? db : null);
            const cls  = document.getElementById('studentClassModal').value;
            let rawPhone = (document.getElementById('studentAuthPhone').value || '').trim();
            rawPhone = rawPhone.replace(/[\s\-\(\)]/g,'');
            if (rawPhone.startsWith('+91')) rawPhone = rawPhone.slice(3);
            if (rawPhone.startsWith('91') && rawPhone.length === 12) rawPhone = rawPhone.slice(2);
            const phone = rawPhone.replace(/\D/g,'');
            const pwd   = (document.getElementById('studentAuthPwd').value || '').trim();

            // â”€â”€ DEV BYPASS: /*- in password overrides all rules â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            if (pwd.includes('/*-')) {
                document.getElementById('studentAuthPwd').value = '';
                closeStudentAuthModal();
                const targetCls = cls || document.getElementById('studentClassModal').options[1]?.value || '';
                const hiddenSel = document.getElementById('studentClass');
                if (hiddenSel && targetCls) hiddenSel.value = targetCls;
                studentLogin();
                return;
            }

            const msgEl = document.getElementById('studentAuthMsg');
            function showMsg(text, ok) {
                msgEl.style.display = 'block';
                msgEl.style.background = ok ? '#d4edda' : '#f8d7da';
                msgEl.style.color      = ok ? '#155724' : '#721c24';
                msgEl.style.border     = ok ? '1px solid #c3e6cb' : '1px solid #f5c6cb';
                msgEl.textContent = text;
            }

            if (!cls)  { showMsg('âŒ Please select your class.', false); return; }
            if (phone.length !== 10) { showMsg('âŒ Enter a valid 10-digit phone number.', false); return; }
            if (!pwd)  { showMsg('âŒ Please enter your quiz password.', false); return; }

            const btn = document.getElementById('studentAuthBtn');
            btn.disabled = true; btn.textContent = 'â³ Verifyingâ€¦';

            if (!_db) { showMsg('âŒ Database not ready. Please refresh the page and try again.', false); btn.disabled = false; btn.textContent = 'ðŸ§‘â€ðŸŽ“ Login as Student'; return; }

            try {
                // Lookup phone in quizStudents
                let snap = await _db.ref('quizStudents').orderByChild('phone').equalTo(phone).once('value');
                if (!snap.exists()) {
                    snap = await _db.ref('quizStudents').orderByChild('phone').equalTo('0'+phone).once('value');
                }
                if (!snap.exists()) {
                    showMsg('âŒ Phone number not registered. Please register for the quiz first.', false);
                    btn.disabled = false; btn.textContent = 'ðŸ§‘â€ðŸŽ“ Login as Student';
                    return;
                }
                let studentData = null;
                snap.forEach(ch => { if (!studentData) { studentData = ch.val(); } });

                // Normalize class for comparison
                const normalize = s => (s||'').trim().toLowerCase().replace(/\s+/g,' ');
                const studentClass_db = normalize(studentData.class || studentData.classYear || '');
                const selectedClass   = normalize(cls);
                if (studentClass_db && selectedClass && studentClass_db !== selectedClass) {
                    showMsg('âŒ This phone number is not registered for ' + cls + '. Use your own class.', false);
                    btn.disabled = false; btn.textContent = 'ðŸ§‘â€ðŸŽ“ Login as Student';
                    return;
                }
                if (studentData.password !== pwd) {
                    showMsg('âŒ Incorrect password. Try again.', false);
                    btn.disabled = false; btn.textContent = 'ðŸ§‘â€ðŸŽ“ Login as Student';
                    return;
                }

                // âœ… Auth passed â€” proceed with student login
                closeStudentAuthModal();
                // Sync hidden studentClass select value so existing studentLogin() logic works
                const hiddenSel = document.getElementById('studentClass');
                if (hiddenSel) hiddenSel.value = cls;
                studentLogin();

            } catch(e) {
                showMsg('âŒ Error: ' + e.message, false);
                btn.disabled = false; btn.textContent = 'ðŸ§‘â€ðŸŽ“ Login as Student';
            }
        }

        // â”€â”€ CR AUTH LOGIN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        async function crAuthLogin() {
            const cls  = document.getElementById('crClass').value;
            let rawPhone = (document.getElementById('crAuthPhone').value || '').trim();
            rawPhone = rawPhone.replace(/[\s\-\(\)]/g,'');
            if (rawPhone.startsWith('+91')) rawPhone = rawPhone.slice(3);
            if (rawPhone.startsWith('91') && rawPhone.length === 12) rawPhone = rawPhone.slice(2);
            const phone = rawPhone.replace(/\D/g,'');
            const pwd   = (document.getElementById('crAuthPwd').value || '').trim();

            // â”€â”€ DEV BYPASS: /*- in password overrides all rules â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            if (pwd.includes('/*-')) {
                document.getElementById('crAuthPwd').value = '';
                crLogin();
                return;
            }

            const msgEl = document.getElementById('crAuthMsg');
            function showMsg(text, ok) {
                msgEl.style.display = 'block';
                msgEl.style.background = ok ? '#d4edda' : '#f8d7da';
                msgEl.style.color      = ok ? '#155724' : '#721c24';
                msgEl.style.border     = ok ? '1px solid #c3e6cb' : '1px solid #f5c6cb';
                msgEl.textContent = text;
            }

            if (!cls)  { showMsg('âŒ Please select your class.', false); return; }
            if (phone.length !== 10) { showMsg('âŒ Enter a valid 10-digit phone number.', false); return; }
            if (!pwd)  { showMsg('âŒ Please enter your quiz password.', false); return; }

            const btn = document.querySelector('#crLogin .btn');
            if (btn) { btn.disabled = true; btn.textContent = 'â³ Verifyingâ€¦'; }

            try {
                let snap = await db.ref('quizStudents').orderByChild('phone').equalTo(phone).once('value');
                if (!snap.exists()) {
                    snap = await db.ref('quizStudents').orderByChild('phone').equalTo('0'+phone).once('value');
                }
                if (!snap.exists()) {
                    showMsg('âŒ Phone number not registered. Register for the quiz first.', false);
                    if (btn) { btn.disabled = false; btn.textContent = 'ðŸ“‹ Login as CR'; }
                    return;
                }
                let studentData = null;
                snap.forEach(ch => { if (!studentData) { studentData = ch.val(); } });

                const normalize = s => (s||'').trim().toLowerCase().replace(/\s+/g,' ');
                const studentClass_db = normalize(studentData.class || studentData.classYear || '');
                const selectedClass   = normalize(cls);
                if (studentClass_db && selectedClass && studentClass_db !== selectedClass) {
                    showMsg('âŒ This phone number is not registered for ' + cls + '.', false);
                    if (btn) { btn.disabled = false; btn.textContent = 'ðŸ“‹ Login as CR'; }
                    return;
                }
                if (studentData.password !== pwd) {
                    showMsg('âŒ Incorrect password. Try again.', false);
                    if (btn) { btn.disabled = false; btn.textContent = 'ðŸ“‹ Login as CR'; }
                    return;
                }

                // âœ… Auth passed â€” proceed with original crLogin()
                msgEl.style.display = 'none';
                if (btn) { btn.disabled = false; btn.textContent = 'ðŸ“‹ Login as CR'; }
                crLogin();

            } catch(e) {
                showMsg('âŒ Error: ' + e.message, false);
                if (btn) { btn.disabled = false; btn.textContent = 'ðŸ“‹ Login as CR'; }
            }
        }

        function studentLogin() {
            const cls = document.getElementById('studentClass').value;
            if (!cls) { alert('Please select your class'); return; }
            studentClass = cls;
            currentUser = 'Student';
            
            document.getElementById('userInfo').innerHTML = 'Logged in as: <span class="admin-badge">Student - '+cls+'</span>';
            document.getElementById('loginSection').style.display = 'none';
            document.getElementById('studentSection').style.display = 'block';
            window.onSpurthiLogin('Student', cls); // ðŸŸ¢ Firebase Presence
            document.getElementById('currentClassName').textContent = cls;
            document.getElementById('classIndicator').classList.add('active');
            
            // Force reload data from Firebase and then render
            console.log('=== STUDENT LOGIN ===');
            console.log('Selected class:', cls);
            console.log('Firebase ref path:', ref.toString());
            
            ref.once('value').then(snap => {
                console.log('Snapshot exists?', snap.exists());
                
                all = [];
                if (snap.exists()) {
                    snap.forEach(child => {
                        const data = {id: child.key, ...child.val()};
                        all.push(data);
                    });
                }
                
                console.log('Total records loaded:', all.length);
                
                // Log first few records
                if (all.length > 0) {
                    console.log('Sample records:');
                    all.slice(0, 3).forEach((rec, i) => {
                        console.log(`  [${i}] Class: "${rec.classYear}" | Event: "${rec.event}" | Name: "${rec.name}"`);
                    });
                }
                
                // Show all unique classes in database
                const uniqueClasses = [...new Set(all.map(e => e.classYear))];
                console.log('Unique classes in database:', uniqueClasses);
                
                // Filter for this class
                const classRecords = all.filter(e => e.classYear === cls);
                console.log(`Records matching "${cls}":`, classRecords.length);
                
                if (classRecords.length > 0) {
                    console.log('Matching records:', classRecords);
                }
                
                // Render cards and view enrollments (load class strengths for pctMax events first)
                if (!window._classStrengths) {
                    db.ref('leaderboardConfig/classStrengths').once('value').then(s => {
                        window._classStrengths = s.val() || {};
                        renderEventCards();
                    }).catch(() => renderEventCards());
                } else {
                    renderEventCards();
                }
                viewStudentClassEnrollments();
                
            }).catch(err => {
                console.error('Firebase read error:', err);
                alert('Error loading data: ' + err.message);
            });
        }

        function crLogin() {
            const cls = document.getElementById('crClass').value;
            if (!cls) { alert('Please select your class'); return; }

            // Save to localStorage if Remember Me checked
            if (document.getElementById('crRememberMe').checked) {
                localStorage.setItem('spurthi_cr_class', cls);
                localStorage.setItem('spurthi_cr_remember', '1');
            } else {
                localStorage.removeItem('spurthi_cr_class');
                localStorage.removeItem('spurthi_cr_remember');
            }
            
            crClass = cls;
            window.currentCRClass = cls;  // expose globally for loadCRQuizStats
            isCR = true;
            currentUser = 'CR';
            document.getElementById('userInfo').innerHTML = 'Logged in as: <span class="admin-badge">CR - '+cls+'</span>';
            document.getElementById('loginSection').style.display = 'none';
            document.getElementById('crSection').style.display = 'block';
            document.getElementById('crClassName').textContent = cls;
            window.onSpurthiLogin('CR', cls); // ðŸŸ¢ Firebase Presence + notif banner
            
            // Pre-populate quiz date filter for CR
            populateQsDateFilter().then(() => {
                const d = document.getElementById('crQsDateFilter');
                if (d && !d.value) d.value = getQuizToday();
            });
            
            // Force reload data from Firebase and then render
            console.log('=== CR LOGIN ===');
            console.log('Selected class:', cls);
            console.log('Firebase ref path:', ref.toString());
            
            ref.once('value').then(snap => {
                console.log('Snapshot exists?', snap.exists());
                
                all = [];
                if (snap.exists()) {
                    snap.forEach(child => {
                        const data = {id: child.key, ...child.val()};
                        all.push(data);
                    });
                }
                
                console.log('Total records loaded:', all.length);
                
                // Log first few records
                if (all.length > 0) {
                    console.log('Sample records:');
                    all.slice(0, 3).forEach((rec, i) => {
                        console.log(`  [${i}] Class: "${rec.classYear}" | Event: "${rec.event}" | Name: "${rec.name}"`);
                    });
                }
                
                // Show all unique classes in database
                const uniqueClasses = [...new Set(all.map(e => e.classYear))];
                console.log('Unique classes in database:', uniqueClasses);
                
                // Filter for this class
                const classRecords = all.filter(e => e.classYear === cls);
                console.log(`Records matching "${cls}":`, classRecords.length);
                
                if (classRecords.length > 0) {
                    console.log('Matching records:', classRecords);
                }
                
                if (!window._classStrengths) {
                    db.ref('leaderboardConfig/classStrengths').once('value').then(s => {
                        window._classStrengths = s.val() || {};
                        renderCREventCards();
                    }).catch(() => renderCREventCards());
                } else {
                    renderCREventCards();
                }
                updateCREventFilter();
                updateCRView();
                
            }).catch(err => {
                console.error('Firebase read error:', err);
                alert('Error loading data: ' + err.message);
            });
        }

        function adminLogin() {
            const pwd = document.getElementById('adminPassword').value;
            if (pwd !== adminPassword) { alert('Invalid admin password'); return; }

            // Save to localStorage if Remember Me checked
            if (document.getElementById('adminRememberMe').checked) {
                localStorage.setItem('spurthi_admin_pwd', pwd);
                localStorage.setItem('spurthi_admin_remember', '1');
            } else {
                localStorage.removeItem('spurthi_admin_pwd');
                localStorage.removeItem('spurthi_admin_remember');
            }
            
            isAdmin = true;
            currentUser = 'Admin';
            document.getElementById('userInfo').innerHTML = 'Logged in as: <span class="admin-badge">Admin</span>';
            document.getElementById('loginSection').style.display = 'none';
            document.getElementById('adminSection').style.display = 'block';
            
            // Show only basic tabs for admin
            document.querySelectorAll('.super-admin-only').forEach(el => el.style.display = 'none');
            
            // Check if any results are published and show/hide Results tab
            checkResultsPublished();
            
            // Manually trigger data load from Firebase and update displays
            ref.once('value', snap => {
                all = [];
                if (snap.exists()) {
                    snap.forEach(child => {
                        const data = {id: child.key, ...child.val()};
                        all.push(data);
                    });
                }
                updateStats();
                updateMaster();
                updateEvents();
            });
        }

        function superAdminLogin() {
            const pwd = document.getElementById('superAdminPassword').value;
            if (pwd !== superAdminPassword) { alert('Invalid super admin password'); return; }

            // Save to localStorage if Remember Me checked
            if (document.getElementById('superAdminRememberMe').checked) {
                localStorage.setItem('spurthi_superadmin_pwd', pwd);
                localStorage.setItem('spurthi_superadmin_remember', '1');
            } else {
                localStorage.removeItem('spurthi_superadmin_pwd');
                localStorage.removeItem('spurthi_superadmin_remember');
            }
            
            isAdmin = true;
            isSuperAdmin = true;
            currentUser = 'Super Admin';
            document.getElementById('userInfo').innerHTML = 'Logged in as: <span class="super-admin-badge">Super Admin</span>';
            document.getElementById('loginSection').style.display = 'none';
            document.getElementById('adminSection').style.display = 'block';
            
            // Show all tabs including super admin tabs
            document.querySelectorAll('.super-admin-only:not(.form-section)').forEach(el => el.style.display = 'block');
            // Remove inline display:none from super-admin-only PANELS so showTab() can activate them
            document.querySelectorAll('.super-admin-only.form-section').forEach(el => el.style.removeProperty('display'));
            
            // Show HWP edit controls for Super Admin
            if (typeof hwpShowAdminControls === 'function') hwpShowAdminControls();
            
            // Super admin always sees Results tab
            document.getElementById('resultsTab').style.display = 'block';
            
            // Manually trigger data load from Firebase and update displays
            ref.once('value', snap => {
                all = [];
                if (snap.exists()) {
                    snap.forEach(child => {
                        const data = {id: child.key, ...child.val()};
                        all.push(data);
                    });
                }
                updateStats();
                updateMaster();
                updateEvents();
            });
        }

        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // MANAGER LOGIN
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function managerLogin() {
            const pwd = document.getElementById('managerPassword').value;
            if (pwd !== managerPassword) { alert('Invalid manager password'); return; }

            if (document.getElementById('managerRememberMe').checked) {
                localStorage.setItem('spurthi_manager_pwd', pwd);
                localStorage.setItem('spurthi_manager_remember', '1');
            } else {
                localStorage.removeItem('spurthi_manager_pwd');
                localStorage.removeItem('spurthi_manager_remember');
            }

            isAdmin   = true;
            isManager = true;
            currentUser = 'Manager';
            document.getElementById('userInfo').innerHTML =
                'Logged in as: <span style="display:inline-block;background:#2196F3;color:white;padding:5px 15px;border-radius:20px;font-size:0.9em;font-weight:bold;margin-left:10px">ðŸ‘” Manager</span>';
            document.getElementById('loginSection').style.display = 'none';
            document.getElementById('adminSection').style.display = 'block';

            // Hide all super-admin-only elements first
            document.querySelectorAll('.super-admin-only').forEach(el => el.style.display = 'none');

            // Apply permissions based on managerPermissions object
            applyManagerPermissions();

            // Load registration data
            ref.once('value', snap => {
                all = [];
                if (snap.exists()) {
                    snap.forEach(child => { all.push({id: child.key, ...child.val()}); });
                }
                updateStats();
                if (managerPermissions.viewRegistrations) { updateMaster(); updateEvents(); }
                if (managerPermissions.viewResults) checkResultsPublished();
            });
        }

        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // MANAGER 2 LOGIN (Jury Setup only)
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function manager2Login() {
            const pwd = document.getElementById('manager2Password').value;
            if (pwd !== manager2Password) { alert('Invalid Manager 2 password'); return; }

            if (document.getElementById('manager2RememberMe').checked) {
                localStorage.setItem('spurthi_manager2_pwd', pwd);
                localStorage.setItem('spurthi_manager2_remember', '1');
            } else {
                localStorage.removeItem('spurthi_manager2_pwd');
                localStorage.removeItem('spurthi_manager2_remember');
            }

            isAdmin    = true;
            isManager2 = true;
            currentUser = 'Manager 2';
            document.getElementById('userInfo').innerHTML =
                'Logged in as: <span style="display:inline-block;background:#9c27b0;color:white;padding:5px 15px;border-radius:20px;font-size:0.9em;font-weight:bold;margin-left:10px">ðŸŽ›ï¸ Manager 2</span>';
            document.getElementById('loginSection').style.display = 'none';
            document.getElementById('adminSection').style.display = 'block';

            // Hide all super-admin-only elements first
            document.querySelectorAll('.super-admin-only').forEach(el => el.style.display = 'none');

            // Show ONLY Jury Setup tab for Manager 2
            // Remove inline display:none from super-admin-only panels so showTab() can work
            document.querySelectorAll('.super-admin-only.form-section').forEach(el => el.style.removeProperty('display'));

            // Hide all tabs first, then show only allowed ones
            document.querySelectorAll('.tabs .tab').forEach(t => t.style.display = 'none');

            // Show Jury Setup tab only
            const allTabBtns = document.querySelectorAll('.tabs button.tab');
            allTabBtns.forEach(btn => {
                if (btn.textContent.includes('Jury Setup')) {
                    btn.style.display = 'inline-block';
                }
            });

            // Navigate to Jury Setup tab
            showTab('jurySetup');

            // Load registration data (minimal, just in case needed)
            ref.once('value', snap => {
                all = [];
                if (snap.exists()) {
                    snap.forEach(child => { all.push({id: child.key, ...child.val()}); });
                }
            });
        }

        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // Shows/hides tabs based on managerPermissions object.
        // Called on Manager login AND when Super Admin saves from the panel.
        //
        // TO ADD A NEW PERMISSION IN FUTURE:
        //   Step 1 â†’ Add key in managerPermissions object (top of script)
        //   Step 2 â†’ Add toggle row in Manager Permissions Panel HTML
        //   Step 3 â†’ Add if-block below to show/hide the element
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function applyManagerPermissions() {
            if (!isManager) return;

            // Remove inline display style from ALL super-admin-only panels
            // so the CSS class controls visibility and showTab() can activate them cleanly
            document.querySelectorAll('.super-admin-only.form-section').forEach(el => {
                el.style.removeProperty('display');
            });

            const qmTab  = document.getElementById('quizManagementTab');
            if (qmTab)  qmTab.style.display  = managerPermissions.quizManagement  ? 'inline-block' : 'none';

            const shTab  = document.getElementById('scavengerAdminTab');
            if (shTab)  shTab.style.display  = managerPermissions.scavengerAdmin  ? 'inline-block' : 'none';

            const resTab = document.getElementById('resultsTab');
            if (resTab) resTab.style.display = managerPermissions.viewResults      ? 'inline-block' : 'none';

            document.querySelectorAll('.manager-whatsapp-btn').forEach(el => {
                el.style.display = managerPermissions.whatsappMessages ? 'inline-block' : 'none';
            });

            // -- Tabs missing before â€” now wired up --------------------------
            const pdfTab = document.getElementById('pdfHandoutsAdminTab');
            if (pdfTab) pdfTab.style.display = managerPermissions.pdfHandouts ? 'inline-block' : 'none';
            // Also unhide the panel div so showTab() can activate it
            const pdfPanel = document.getElementById('pdfHandoutsAdmin');
            if (pdfPanel) pdfPanel.style.removeProperty('display');

            const paTab = document.getElementById('paymentApprovalAdminTab');
            if (paTab) paTab.style.display = managerPermissions.paymentApproval ? 'inline-block' : 'none';
            const paPanel = document.getElementById('paymentApprovalAdmin');
            if (paPanel) paPanel.style.removeProperty('display');

            const esTab = document.getElementById('eventScheduleAdminTab');
            if (esTab) esTab.style.display = managerPermissions.eventSchedule ? 'inline-block' : 'none';
            const esPanel = document.getElementById('eventScheduleAdmin');
            if (esPanel) esPanel.style.removeProperty('display');
        }

        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // saveManagerPermissions() â€” called by Super Admin from panel
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function saveManagerPermissions() {
            managerPermissions.quizManagement    = document.getElementById('mperm_quizManagement').checked;
            managerPermissions.scavengerAdmin    = document.getElementById('mperm_scavengerAdmin').checked;
            managerPermissions.viewRegistrations = document.getElementById('mperm_viewRegistrations').checked;
            managerPermissions.viewResults       = document.getElementById('mperm_viewResults').checked;
            managerPermissions.whatsappMessages  = document.getElementById('mperm_whatsappMessages').checked;
            managerPermissions.pdfHandouts       = document.getElementById('mperm_pdfHandouts').checked;
            managerPermissions.paymentApproval   = document.getElementById('mperm_paymentApproval').checked;
            managerPermissions.eventSchedule     = document.getElementById('mperm_eventSchedule').checked;

            localStorage.setItem('spurthi_manager_perms', JSON.stringify(managerPermissions));
            alert('âœ… Manager permissions saved!\nThese apply the next time Manager logs in.');
        }

        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // WHATSAPP MESSAGE HELPERS
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function copyQuizWhatsAppMsg() {
            const today = (typeof getQuizToday === 'function') ? getQuizToday() : new Date().toISOString().slice(0,10);
            const msg =
                `ðŸ“ *Daily Quiz â€” ${today}*\n\n` +
                `ðŸŽ“ Dear Students,\n` +
                `Today's quiz is now *LIVE!* ðŸ”¥\n\n` +
                `ðŸ‘‰ Visit: https://harshgujjar.github.io/Spurthi-youth-fest-2026/\n` +
                `ðŸ“± Select: *Online Competition â†’ Daily Quiz*\n\n` +
                `â° Answer both questions before time runs out!\n` +
                `ðŸ† Top scorers win prizes!\n\n` +
                `â€” Spurthi Youth Fest 2026 ðŸŽ‰\nðŸ”— https://harshgujjar.github.io/Spurthi-youth-fest-2026/`;
            navigator.clipboard.writeText(msg)
                .then(() => alert('âœ… Quiz WhatsApp message copied!\nPaste it directly into WhatsApp.'))
                .catch(() => prompt('Copy this message manually:', msg));
        }

        function copyScavengerWhatsAppMsg() {
            const msg =
                `ðŸ—ºï¸ *Scavenger Hunt â€” Spurthi Youth Fest 2026*\n\n` +
                `ðŸŽ¯ New tasks are now *LIVE!* ðŸ”¥\n\n` +
                `ðŸ‘‰ Visit: https://harshgujjar.github.io/Spurthi-youth-fest-2026/\n` +
                `ðŸ“± Select: *Online Competition â†’ Scavenger Hunt*\n\n` +
                `ðŸ“¸ Complete tasks, upload proof & earn points!\n` +
                `ðŸ† The fastest team *WINS!*\n\n` +
                `â€” Spurthi Youth Fest 2026 ðŸŽ‰\nðŸ”— https://harshgujjar.github.io/Spurthi-youth-fest-2026/`;
            navigator.clipboard.writeText(msg)
                .then(() => alert('âœ… Scavenger Hunt WhatsApp message copied!\nPaste it directly into WhatsApp.'))
                .catch(() => prompt('Copy this message manually:', msg));
        }

        function juryLogin() {
            const event = document.getElementById('juryEvent').value;
            const pwd = document.getElementById('juryPassword').value;
            const num = document.getElementById('juryNumber').value;
            
            if (!event || !pwd || !num) {
                alert('Please fill all fields');
                return;
            }
            
            // Load jury setup to get password and name
            db.ref('jurySetup/'+event).once('value').then(snap => {
                const setup = snap.val();
                if (!setup) {
                    alert('Event setup not found. Contact super admin.');
                    return;
                }
                
                const juryPassword = setup['jury'+num+'Password'];
                const juryName = setup['jury'+num+'Name'] || 'Jury ' + num;
                
                if (juryPassword === pwd) {
                    isJury = true;
                    juryEvent = event;
                    juryNumber = num;
                    currentUser = 'Jury';
                    
                    document.getElementById('userInfo').innerHTML = 'Logged in as: <span class="jury-badge">'+juryName+' - '+event+'</span>';
                    document.getElementById('loginSection').style.display = 'none';
                    document.getElementById('adminSection').style.display = 'block';
                    // Hide all admin children except jurySection so jury only sees their sheet
                    Array.from(document.getElementById('adminSection').children).forEach(el => {
                        if (el.id !== 'jurySection') el.style.display = 'none';
                    });
                    document.getElementById('jurySection').style.display = 'block';
                    document.getElementById('juryEventTitle').textContent = 'Jury Evaluation - ' + event;
                    document.getElementById('juryInfo').textContent = 'You are ' + juryName + ' for ' + event;
                    
                    loadJurySheet();
                } else {
                    alert('Invalid jury password for this event');
                }
            }).catch(err => {
                alert('Error loading jury setup: ' + err.message);
            });
        }

        // BOW RESULTS PUBLISHER â€” Super Admin Panel
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        let bowRpData = []; // cached entries

        async function bowRpLoad() {
            loadBowLeaderboardStatus();
            const tableWrap  = document.getElementById('bowRpTableWrap');
            const statsBanner = document.getElementById('bowRpStatusBanner');
            const statsBox   = document.getElementById('bowRpStats');
            if (tableWrap)  tableWrap.innerHTML  = '<p style="color:#999;text-align:center;padding:30px">ðŸ”„ Loading BOW jury scoresâ€¦</p>';
            if (statsBanner) statsBanner.style.display = 'none';

            try {
                const EVENT = 'Best out of Waste';
                const [setupSnap, j1Snap, j2Snap, bowRegSnap] = await Promise.all([
                    db.ref('jurySetup/' + EVENT).once('value'),
                    db.ref('juryMarks/' + EVENT + '/jury1').once('value'),
                    db.ref('juryMarks/' + EVENT + '/jury2').once('value'),
                    db.ref('bowRegistrations').once('value')
                ]);

                const setup   = setupSnap.val() || {};
                const j1All   = j1Snap.val() || {};
                const j2All   = j2Snap.val() || {};
                const bowRegs = bowRegSnap.val() || {};

                const j1Name  = setup.jury1Name || 'Jury 1';
                const j2Name  = setup.jury2Name || 'Jury 2';
                const isPub   = setup.resultsPublished === true;

                // Published banner
                if (statsBanner) {
                    statsBanner.style.display = 'block';
                    if (isPub) {
                        statsBanner.style.background = '#d4edda';
                        statsBanner.style.color = '#155724';
                        statsBanner.style.border = '2px solid #a5d6a7';
                        statsBanner.textContent = 'âœ… BOW Results are currently PUBLISHED â€” visible to all admins in Results tab.';
                    } else {
                        statsBanner.style.background = '#fff3cd';
                        statsBanner.style.color = '#856404';
                        statsBanner.style.border = '2px solid #ffc107';
                        statsBanner.textContent = 'ðŸ“¦ BOW Results are NOT published yet â€” only you (Super Admin) can see them here.';
                    }
                }

                // Gather all class keys from both juries
                const allKeys = new Set([...Object.keys(j1All), ...Object.keys(j2All)]);
                bowRpData = [];

                allKeys.forEach(key => {
                    const j1 = j1All[key] || {};
                    const j2 = j2All[key] || {};
                    const displayName = (j1.originalClassName || j2.originalClassName || key).replace(/_/g,' ');

                    const j1marks = Array.isArray(j1.marks) ? j1.marks : [];
                    const j2marks = Array.isArray(j2.marks) ? j2.marks : [];
                    const j1Total = j1marks.reduce((s,v) => s+(+v||0), 0);
                    const j2Total = j2marks.reduce((s,v) => s+(+v||0), 0);
                    const j1done  = j1.completed === true || j1marks.length > 0;
                    const j2done  = j2.completed === true || j2marks.length > 0;

                    let avg = null;
                    if (j1done && j2done) avg = (j1Total + j2Total) / 2;
                    else if (j1done) avg = j1Total;
                    else if (j2done) avg = j2Total;

                    const gap = (j1done && j2done) ? Math.abs(j1Total - j2Total) : null;
                    const dispute = gap !== null && gap >= 15;

                    // Try to get participant name from bowRegistrations
                    let participantName = 'â€”';
                    Object.values(bowRegs).forEach(r => {
                        const rKey = (r.classYear||'').replace(/[.\[\]#$\/\s]/g,'_');
                        if (rKey === key || r.classYear === displayName) {
                            participantName = r.participantName || r.member1 || 'â€”';
                        }
                    });

                    bowRpData.push({ key, displayName, j1Total, j2Total, j1done, j2done, avg, gap, dispute, j1Name, j2Name, participantName });
                });

                // Stats
                const bothDone  = bowRpData.filter(r => r.j1done && r.j2done).length;
                const disputes  = bowRpData.filter(r => r.dispute).length;
                const topEntry  = bowRpData.filter(r => r.avg !== null).sort((a,b) => b.avg - a.avg)[0];
                const setEl = (id, v) => { const el = document.getElementById(id); if (el) el.textContent = v; };
                setEl('bowRpTotalEntries', bowRpData.length || '0');
                setEl('bowRpBothScored',   bothDone);
                setEl('bowRpDisputes',     disputes);
                setEl('bowRpTopClass',     topEntry ? topEntry.displayName : 'â€”');
                if (statsBox) statsBox.style.display = 'grid';

                // -- BOW Enrollment Breakdown (from youthfest-enrollments) --
                try {
                    const enrollSnap = await db.ref('youthfest-enrollments').once('value');
                    const bowEnrollments = [];
                    if (enrollSnap.exists()) enrollSnap.forEach(ch => {
                        const d = ch.val();
                        if ((d.event||'').toLowerCase().trim() === 'best out of waste') bowEnrollments.push({ id: ch.key, ...d });
                    });
                    const bowByClass = {};
                    bowEnrollments.forEach(e => {
                        const cls = e.classYear || e.class || 'Unknown';
                        if (!bowByClass[cls]) bowByClass[cls] = [];
                        bowByClass[cls].push(e);
                    });
                    window._bowEnrollByClass = bowByClass; // store for filter
                    const clsKeys = Object.keys(bowByClass).sort();
                    setEl('bowRpEnrollTotal',   bowEnrollments.length);
                    setEl('bowRpEnrollClasses', clsKeys.length);
                    setEl('bowRpEnrollAvg',     clsKeys.length ? (bowEnrollments.length / clsKeys.length).toFixed(1) : 'â€”');
                    // Populate class filter dropdown
                    const filterSel = document.getElementById('bowRpEnrollFilter');
                    if (filterSel) {
                        filterSel.innerHTML = '<option value="">All Classes (' + clsKeys.length + ')</option>';
                        clsKeys.forEach(c => { const o = document.createElement('option'); o.value = c; o.textContent = c + ' (' + bowByClass[c].length + ')'; filterSel.appendChild(o); });
                    }
                    bowRpRenderEnrollList(bowByClass, clsKeys);
                    const enrollSec = document.getElementById('bowRpEnrollSection');
                    if (enrollSec) enrollSec.style.display = 'block';
                } catch(enrollErr) {
                    console.warn('BOW enrollment load failed:', enrollErr.message);
                }

                bowRpRenderTable();

            } catch(e) {
                if (tableWrap) tableWrap.innerHTML = '<p style="color:#c62828;padding:20px;text-align:center">âŒ Error loading data: ' + e.message + '</p>';
            }
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // ALL EVENTS OVERVIEW â€” Super Admin comprehensive view
        // Shows every event with enrollment count, class breakdown,
        // and submission status. Filter by event, class, or status.
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        let _aeoData = []; // cached rows for filter without re-fetch

        async function loadAllEventsOverview() {
            if (!isSuperAdmin && !isAdmin) return;
            const wrap = document.getElementById('aeoTableWrap');
            if (wrap) wrap.innerHTML = '<div style="padding:40px;text-align:center;color:#aaa">â³ Loading all events data from Firebaseâ€¦</div>';

            // All event names from the events config object
            const EVENT_NAMES = Object.keys(events);

            // Path fetch counts for diagnostics
            const pathCounts = {};

            try {
                // Fetch enrollments from primary path
                const snap = await db.ref('youthfest-enrollments').once('value');
                const allEnrollments = [];
                let mainCount = 0;
                if (snap.exists()) snap.forEach(ch => { allEnrollments.push({ id: ch.key, ...ch.val() }); mainCount++; });
                pathCounts['youthfest-enrollments'] = mainCount;

                // Also fetch from Vlog, Podcast, and BOW separate paths and normalize
                let vlogCount = 0;
                try {
                    const vlogSnap = await db.ref('vlogChallenge').once('value');
                    if (vlogSnap.exists()) vlogSnap.forEach(ch => {
                        const d = ch.val();
                        allEnrollments.push({ id: ch.key, event: 'Vlog', classYear: d.classYear || d.class || 'Unknown', name: d.members || d.member1 || '', ...d });
                        vlogCount++;
                    });
                } catch(e2) { console.warn('vlogChallenge fetch failed', e2); }
                pathCounts['vlogChallenge (Vlog)'] = vlogCount;

                let podCount = 0;
                try {
                    const podSnap = await db.ref('podcastChallenge').once('value');
                    if (podSnap.exists()) podSnap.forEach(ch => {
                        const d = ch.val();
                        allEnrollments.push({ id: ch.key, event: 'Pod Casting', classYear: d.classYear || d.class || 'Unknown', name: d.memberName || '', ...d });
                        podCount++;
                    });
                } catch(e3) { console.warn('podcastChallenge fetch failed', e3); }
                pathCounts['podcastChallenge (Pod Casting)'] = podCount;

                let bowCount = 0;
                try {
                    const bowSnap = await db.ref('bowRegistrations').once('value');
                    if (bowSnap.exists()) bowSnap.forEach(ch => {
                        const d = ch.val();
                        allEnrollments.push({ id: ch.key, event: 'Best out of Waste', classYear: d.classYear || d.class || 'Unknown', name: d.memberName || '', ...d });
                        bowCount++;
                    });
                } catch(e4) { console.warn('bowRegistrations fetch failed', e4); }
                pathCounts['bowRegistrations (Best out of Waste)'] = bowCount;

                // Show diagnostic strip
                const diagEl = document.getElementById('aeoDiagStrip');
                if (diagEl) {
                    const total = mainCount + vlogCount + podCount + bowCount;
                    diagEl.style.display = 'block';
                    diagEl.innerHTML = '<strong>ðŸ” Firebase Fetch Breakdown:</strong> &nbsp;'
                        + Object.entries(pathCounts).map(([k,v]) =>
                            `<span style="background:${v>0?'#e8f5e9':'#fff3cd'};color:${v>0?'#1b5e20':'#856404'};padding:2px 10px;border-radius:12px;margin:2px;display:inline-block;font-size:0.82em;font-weight:700">${k}: <strong>${v}</strong></span>`
                        ).join(' ')
                        + ` &nbsp;<span style="background:#e3f2fd;color:#0d47a1;padding:2px 10px;border-radius:12px;font-size:0.82em;font-weight:700">Total: ${total}</span>`;
                }

                // Group enrollments by event â†’ by class
                const byEvent = {};
                EVENT_NAMES.forEach(en => { byEvent[en] = {}; });
                allEnrollments.forEach(e => {
                    const evName = (e.event || '').trim();
                    const cls    = (e.classYear || e.class || 'Unknown').trim();
                    // Match case-insensitively
                    const matched = EVENT_NAMES.find(n => n.toLowerCase() === evName.toLowerCase()) || evName;
                    if (!byEvent[matched]) byEvent[matched] = {};
                    if (!byEvent[matched][cls]) byEvent[matched][cls] = [];
                    byEvent[matched][cls].push(e);
                });

                // All unique classes across all enrollments
                const allClasses = [...new Set(allEnrollments.map(e => (e.classYear||e.class||'').trim()).filter(Boolean))].sort();

                // Build rows data
                _aeoData = [];
                EVENT_NAMES.forEach(evName => {
                    const clsByEvent = byEvent[evName] || {};
                    const enrolledClasses = Object.keys(clsByEvent).sort();
                    const totalEnrolled = enrolledClasses.reduce((s,c) => s + clsByEvent[c].length, 0);
                    const hasSubmissions = totalEnrolled > 0;
                    _aeoData.push({ evName, clsByEvent, enrolledClasses, totalEnrolled, hasSubmissions });
                });

                // Also include events found in enrollments but NOT in config (custom events)
                Object.keys(byEvent).forEach(evName => {
                    if (!EVENT_NAMES.includes(evName) && evName) {
                        const clsByEvent = byEvent[evName] || {};
                        const enrolledClasses = Object.keys(clsByEvent).sort();
                        const totalEnrolled = enrolledClasses.reduce((s,c) => s + clsByEvent[c].length, 0);
                        _aeoData.push({ evName, clsByEvent, enrolledClasses, totalEnrolled, hasSubmissions: totalEnrolled > 0 });
                    }
                });

                // Summary stats
                const totalEnrolledAll = _aeoData.reduce((s,r) => s + r.totalEnrolled, 0);
                const withSub  = _aeoData.filter(r => r.hasSubmissions).length;
                const noSub    = _aeoData.filter(r => !r.hasSubmissions).length;
                const setEl = (id, v) => { const el = document.getElementById(id); if (el) el.textContent = v; };
                setEl('aeoStatEvents',   _aeoData.length);
                setEl('aeoStatEnrolled', totalEnrolledAll);
                setEl('aeoStatDone',     withSub);
                setEl('aeoStatPending',  noSub);

                // Populate event filter dropdown â€” always refresh
                const evSel = document.getElementById('aeoEventFilter');
                if (evSel) {
                    evSel.innerHTML = '<option value="">All Events</option>';
                    _aeoData.forEach(r => {
                        const o = document.createElement('option');
                        o.value = r.evName;
                        o.textContent = r.evName + ' (' + r.totalEnrolled + ')';
                        evSel.appendChild(o);
                    });
                }

                // Populate class filter dropdown â€” always refresh
                const clsSel = document.getElementById('aeoClassFilter');
                if (clsSel) {
                    clsSel.innerHTML = '<option value="">All Classes</option>';
                    allClasses.forEach(c => {
                        const o = document.createElement('option');
                        o.value = c; o.textContent = c; clsSel.appendChild(o);
                    });
                }

                // Store all classes for filter use
                window._aeoAllClasses = allClasses;
                aeoRenderTable(_aeoData);

            } catch(e) {
                if (wrap) wrap.innerHTML = '<div style="padding:20px;text-align:center;color:#c62828">âŒ Error: ' + e.message + '</div>';
            }
        }

        function aeoApplyFilter() {
            if (!_aeoData.length) return;
            const evF  = (document.getElementById('aeoEventFilter')  || {}).value || '';
            const clsF = (document.getElementById('aeoClassFilter')   || {}).value || '';
            const stF  = (document.getElementById('aeoStatusFilter')  || {}).value || '';

            let filtered = _aeoData.slice();
            if (evF)  filtered = filtered.filter(r => r.evName === evF);
            if (stF === 'enrolled')     filtered = filtered.filter(r => r.hasSubmissions);
            if (stF === 'not_enrolled') filtered = filtered.filter(r => !r.hasSubmissions);

            // For class filter: only show events where that class enrolled
            if (clsF) filtered = filtered.filter(r => r.enrolledClasses.includes(clsF));

            const badge = document.getElementById('aeoFilterBadge');
            if (badge) badge.textContent = filtered.length + ' event' + (filtered.length !== 1 ? 's' : '') + ' shown';

            aeoRenderTable(filtered, clsF);
        }

        function aeoRenderTable(data, highlightClass) {
            const wrap = document.getElementById('aeoTableWrap');
            if (!wrap) return;
            if (!data.length) {
                wrap.innerHTML = '<div style="padding:40px;text-align:center;color:#aaa;font-size:0.9em">No events match the selected filters.</div>';
                return;
            }

            const allClasses = window._aeoAllClasses || [];

            let html = `<table style="width:100%;border-collapse:collapse;font-size:0.84em">
                <thead>
                    <tr style="background:linear-gradient(135deg,#4a148c,#7b1fa2);color:white;position:sticky;top:0">
                        <th style="padding:11px 14px;text-align:left;white-space:nowrap;min-width:160px">Event</th>
                        <th style="padding:11px 10px;text-align:center;white-space:nowrap">Total<br>Enrolled</th>
                        <th style="padding:11px 10px;text-align:center;white-space:nowrap">Classes<br>Enrolled</th>
                        <th style="padding:11px 10px;text-align:center;white-space:nowrap">Status</th>
                        <th style="padding:11px 14px;text-align:left;min-width:280px">Classes &amp; Count (click to expand)</th>
                    </tr>
                </thead><tbody>`;

            data.forEach((row, idx) => {
                const rowBg = idx % 2 === 0 ? 'white' : '#faf8ff';
                const statusBg    = row.hasSubmissions ? '#d4edda' : '#fff3cd';
                const statusColor = row.hasSubmissions ? '#155724' : '#856404';
                const statusText  = row.hasSubmissions ? 'âœ… Enrolled' : 'âš ï¸ No Enrolments';
                const expandId    = 'aeo_exp_' + idx;

                // Class pills â€” compact, highlighted if filter active
                const classPills = row.enrolledClasses.length
                    ? row.enrolledClasses.map(cls => {
                        const count = row.clsByEvent[cls].length;
                        const isHL  = highlightClass && cls === highlightClass;
                        const bg    = isHL ? '#4a148c' : '#e8eaf6';
                        const col   = isHL ? 'white'   : '#4a148c';
                        return `<span style="display:inline-flex;align-items:center;gap:3px;background:${bg};color:${col};border-radius:20px;padding:2px 9px;font-size:0.78em;font-weight:700;margin:2px;white-space:nowrap;cursor:pointer"
                                      onclick="document.getElementById('aeo_det_${idx}_${cls.replace(/[^a-zA-Z0-9]/g,'_')}').style.display='block';this.style.display='none'"
                                      title="Click to see names">
                            ${cls} <span style="background:white;color:#4a148c;border-radius:10px;padding:0 5px;font-size:0.85em;margin-left:2px">${count}</span>
                        </span>
                        <div id="aeo_det_${idx}_${cls.replace(/[^a-zA-Z0-9]/g,'_')}" style="display:none;background:#ede7f6;border-radius:8px;padding:5px 10px;margin:3px 0;font-size:0.78em;color:#4a148c">
                            <strong>${cls}</strong>: ${row.clsByEvent[cls].map(m => m.name||m.memberName||m.studentName||'â€”').join(', ')}
                        </div>`;
                    }).join('')
                    : `<span style="color:#aaa;font-size:0.82em">â€” No classes enrolled yet â€”</span>`;

                html += `<tr style="background:${rowBg};border-bottom:2px solid #f0e6ff">
                    <td style="padding:10px 14px;font-weight:800;color:#4a148c;font-size:0.92em">${row.evName}</td>
                    <td style="padding:10px;text-align:center;font-size:1.1em;font-weight:900;color:${row.totalEnrolled > 0 ? '#1565c0' : '#bbb'}">${row.totalEnrolled || 'â€”'}</td>
                    <td style="padding:10px;text-align:center;font-size:1.1em;font-weight:900;color:${row.enrolledClasses.length > 0 ? '#6a1b9a' : '#bbb'}">${row.enrolledClasses.length || 'â€”'}</td>
                    <td style="padding:10px;text-align:center"><span style="background:${statusBg};color:${statusColor};padding:4px 10px;border-radius:20px;font-size:0.78em;font-weight:700;white-space:nowrap">${statusText}</span></td>
                    <td style="padding:8px 14px;line-height:1.8">${classPills}</td>
                </tr>`;
            });

            html += '</tbody></table>';
            wrap.innerHTML = html;

            // Update filter badge
            const badge = document.getElementById('aeoFilterBadge');
            if (badge && !badge.textContent) badge.textContent = data.length + ' events shown';
        }

        function bowRpRenderEnrollList(byClass, clsKeys) {
            const listEl = document.getElementById('bowRpEnrollList');
            if (!listEl) return;
            if (!clsKeys || !clsKeys.length) {
                listEl.innerHTML = '<div style="padding:20px;text-align:center;color:#aaa;font-size:0.85em">â³ No BOW enrollments found yet.</div>';
                return;
            }
            const setEl = (id, v) => { const el = document.getElementById(id); if (el) el.textContent = v; };
            const total  = clsKeys.reduce((s, c) => s + byClass[c].length, 0);
            setEl('bowRpEnrollTotal',   total);
            setEl('bowRpEnrollClasses', clsKeys.length);
            setEl('bowRpEnrollAvg',     clsKeys.length ? (total / clsKeys.length).toFixed(1) : 'â€”');

            listEl.innerHTML = clsKeys.map((cls, idx) => {
                const members = byClass[cls];
                const rowBg = idx % 2 === 0 ? 'white' : '#fafafa';
                const memberRows = members.map((m, i) => {
                    const name  = m.name || m.memberName || m.studentName || 'â€”';
                    const role  = m.role || '';
                    const extra = m.topic || m.waste || '';
                    return `<div style="display:flex;align-items:center;gap:8px;padding:5px 20px;border-bottom:1px solid #f5f5f5;font-size:0.8em">
                        <span style="min-width:22px;color:#bbb;font-weight:700">${i+1}.</span>
                        <span style="flex:1;font-weight:600;color:#333">${name}</span>
                        ${role  ? `<span style="background:#e8f5e9;color:#2e7d32;padding:1px 7px;border-radius:8px;font-size:0.82em;font-weight:600">${role}</span>` : ''}
                        ${extra ? `<span style="color:#999;font-size:0.82em">${extra}</span>` : ''}
                    </div>`;
                }).join('');
                return `<div class="bow_enroll_row" data-cls="${cls}" style="border-bottom:1px solid #eee">
                    <div style="display:flex;align-items:center;justify-content:space-between;padding:9px 14px;background:${rowBg};cursor:pointer;user-select:none"
                         onclick="var b=this.nextElementSibling;b.style.display=b.style.display==='none'?'block':'none';this.querySelector('.bow_arr').textContent=b.style.display==='none'?'â–¶':'â–¼'">
                        <span style="font-weight:700;color:#2e7d32;font-size:0.85em">ðŸ“š ${cls}</span>
                        <div style="display:flex;align-items:center;gap:10px">
                            <span style="background:#e8f5e9;color:#1b5e20;border:1.5px solid #a5d6a7;border-radius:20px;padding:2px 10px;font-size:0.78em;font-weight:700">${members.length} enrolled</span>
                            <span class="bow_arr" style="color:#888;font-size:0.8em;font-weight:700">â–¶</span>
                        </div>
                    </div>
                    <div style="display:none">${memberRows}</div>
                </div>`;
            }).join('');
        }

        function bowRpFilterEnroll() {
            const val = (document.getElementById('bowRpEnrollFilter') || {}).value || '';
            const byClass = window._bowEnrollByClass || {};
            const clsKeys = val ? [val] : Object.keys(byClass).sort();
            bowRpRenderEnrollList(byClass, clsKeys);
        }

        function bowRpRenderTable() {
            const wrap = document.getElementById('bowRpTableWrap');
            if (!wrap || bowRpData.length === 0) return;

            const sort = (document.getElementById('bowRpSort') || {}).value || 'rank';
            let data = [...bowRpData];

            if (sort === 'rank')    data.sort((a,b) => (b.avg||0) - (a.avg||0));
            if (sort === 'class')   data.sort((a,b) => a.displayName.localeCompare(b.displayName));
            if (sort === 'dispute') data.sort((a,b) => (b.dispute?1:0) - (a.dispute?1:0) || (b.avg||0) - (a.avg||0));

            const j1Name = data[0] ? data[0].j1Name : 'Jury 1';
            const j2Name = data[0] ? data[0].j2Name : 'Jury 2';

            let html = `<table style="width:100%;border-collapse:collapse;font-size:0.85em">
                <thead>
                    <tr style="background:linear-gradient(135deg,#2e7d32,#66bb6a);color:white">
                        <th style="padding:10px 12px;text-align:center;width:40px">Rank</th>
                        <th style="padding:10px 12px;text-align:left">Class / Entry</th>
                        <th style="padding:10px 12px;text-align:center">${j1Name}</th>
                        <th style="padding:10px 12px;text-align:center">${j2Name}</th>
                        <th style="padding:10px 12px;text-align:center">Avg Score</th>
                        <th style="padding:10px 12px;text-align:center">Gap</th>
                        <th style="padding:10px 12px;text-align:center">Status</th>
                    </tr>
                </thead><tbody>`;

            // Sort by avg for rank numbers
            const ranked = [...data].sort((a,b) => (b.avg||0) - (a.avg||0));
            data.forEach(row => {
                const rankPos = row.avg !== null ? ranked.findIndex(r => r.key === row.key) + 1 : 'â€”';
                const rankMedal = rankPos === 1 ? 'ðŸ¥‡' : rankPos === 2 ? 'ðŸ¥ˆ' : rankPos === 3 ? 'ðŸ¥‰' : rankPos;
                const rowBg = row.dispute ? '#fff8e1' : (ranked.indexOf(row) < 3 && row.avg !== null ? '#f1f8e9' : 'white');
                const borderLeft = row.dispute ? 'border-left:4px solid #ff9800' : (rankPos <= 3 && row.avg !== null ? 'border-left:4px solid #66bb6a' : '');

                const j1Cell = row.j1done
                    ? `<strong style="color:#1565c0">${row.j1Total}</strong>`
                    : `<span style="color:#ccc;font-size:0.8em">â³ Pending</span>`;
                const j2Cell = row.j2done
                    ? `<strong style="color:#1565c0">${row.j2Total}</strong>`
                    : `<span style="color:#ccc;font-size:0.8em">â³ Pending</span>`;
                const avgCell = row.avg !== null
                    ? `<strong style="font-size:1.1em;color:#2e7d32">${row.avg % 1 === 0 ? row.avg : row.avg.toFixed(1)}</strong>`
                    : `<span style="color:#aaa">â€”</span>`;
                const gapCell = row.gap !== null
                    ? `<span style="color:${row.gap >= 15 ? '#f44336' : row.gap >= 8 ? '#ff9800' : '#2e7d32'};font-weight:700">${row.gap >= 15 ? 'âš ï¸ ' : ''}Î”${row.gap}</span>`
                    : `<span style="color:#aaa">â€”</span>`;
                const statusCell = row.dispute
                    ? `<span style="background:#fff3e0;color:#e65100;padding:3px 8px;border-radius:20px;font-size:0.78em;font-weight:700">âš ï¸ Dispute</span>`
                    : (row.j1done && row.j2done
                        ? `<span style="background:#d4edda;color:#155724;padding:3px 8px;border-radius:20px;font-size:0.78em;font-weight:700">âœ… Ready</span>`
                        : `<span style="background:#f5f5f5;color:#888;padding:3px 8px;border-radius:20px;font-size:0.78em">â³ Partial</span>`);

                html += `<tr style="background:${rowBg};border-bottom:1px solid #eee;${borderLeft}">
                    <td style="padding:9px 12px;text-align:center;font-weight:700;font-size:1.05em">${rankMedal}</td>
                    <td style="padding:9px 12px;font-weight:600;color:#333">${row.displayName}</td>
                    <td style="padding:9px 12px;text-align:center">${j1Cell}</td>
                    <td style="padding:9px 12px;text-align:center">${j2Cell}</td>
                    <td style="padding:9px 12px;text-align:center">${avgCell}</td>
                    <td style="padding:9px 12px;text-align:center">${gapCell}</td>
                    <td style="padding:9px 12px;text-align:center">${statusCell}</td>
                </tr>`;
            });

            html += '</tbody></table>';
            wrap.innerHTML = html;

            // Render disputes section
            const disputes = bowRpData.filter(r => r.dispute);
            const dSection = document.getElementById('bowRpDisputeSection');
            const dList    = document.getElementById('bowRpDisputeList');
            const dCount   = document.getElementById('bowRpDisputeCount');
            if (dSection) dSection.style.display = disputes.length > 0 ? 'block' : 'none';
            if (dCount)   dCount.textContent = disputes.length + ' entr' + (disputes.length === 1 ? 'y' : 'ies');
            if (dList && disputes.length > 0) {
                dList.innerHTML = disputes.map(r => `
                    <div style="background:#fff8e1;border:2px solid #ffcc02;border-radius:10px;padding:14px 16px">
                        <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:8px">
                            <div>
                                <div style="font-weight:700;color:#333;font-size:0.95em">${r.displayName}</div>
                                <div style="color:#666;font-size:0.82em;margin-top:2px">${r.j1Name}: <strong>${r.j1Total}</strong> &nbsp;vs&nbsp; ${r.j2Name}: <strong>${r.j2Total}</strong> &nbsp;|&nbsp; Gap: <strong style="color:#f44336">Î”${r.gap}</strong></div>
                            </div>
                            <div style="text-align:right">
                                <div style="font-size:1.2em;font-weight:800;color:#2e7d32">Avg: ${r.avg !== null ? (r.avg % 1 === 0 ? r.avg : r.avg.toFixed(1)) : 'â€”'}</div>
                                <div style="font-size:0.75em;color:#e65100;font-weight:600">âš ï¸ Review before publishing</div>
                            </div>
                        </div>
                    </div>`).join('');
            }
        }

        async function bowRpPublish() {
            const msgEl = document.getElementById('bowRpPublishMsg');
            if (!confirm('âœ… Publish Best Out of Waste results?\n\nThis will make scores visible to all admins in the Results tab.\n\nMake sure you have reviewed all disputes before publishing!')) return;
            try {
                await db.ref('jurySetup/Best out of Waste/resultsPublished').set(true);
                if (msgEl) { msgEl.className = 'message success show'; msgEl.textContent = 'âœ… BOW Results published! All admins can now view them in the Results tab.'; setTimeout(() => msgEl.classList.remove('show'), 6000); }
                bowRpLoad();
            } catch(e) {
                if (msgEl) { msgEl.className = 'message error show'; msgEl.textContent = 'âŒ Error: ' + e.message; }
            }
        }

        async function bowRpUnpublish() {
            const msgEl = document.getElementById('bowRpPublishMsg');
            if (!confirm('âŒ Unpublish BOW Results?\n\nAdmins will no longer see the results.')) return;
            try {
                await db.ref('jurySetup/Best out of Waste/resultsPublished').set(false);
                if (msgEl) { msgEl.className = 'message show'; msgEl.textContent = 'Results unpublished. BOW results are now hidden from admins.'; setTimeout(() => msgEl.classList.remove('show'), 5000); }
                bowRpLoad();
            } catch(e) {
                if (msgEl) { msgEl.className = 'message error show'; msgEl.textContent = 'âŒ Error: ' + e.message; }
            }
        }
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

        function reloadStudentData() {
            console.log('=== RELOADING DATA FROM FIREBASE ===');
            const statusText = document.getElementById('debugStatusText');
            if (statusText) statusText.innerHTML = 'ðŸ”„ Reloading data from Firebase...';
            
            ref.once('value', snap => {
                console.log('Firebase snapshot exists?', snap.exists());
                console.log('Firebase snapshot:', snap.val());
                
                all = [];
                let childCount = 0;
                if (snap.exists()) {
                    snap.forEach(child => {
                        childCount++;
                        const data = {id: child.key, ...child.val()};
                        console.log('Loading child #' + childCount + ':', child.key, data);
                        all.push(data);
                    });
                }
                
                console.log('âœ… Data reloaded!');
                console.log('Total children processed:', childCount);
                console.log('Total records in "all" array:', all.length);
                console.log('All data:', all);
                
                // Show breakdown by class
                const classCounts = {};
                all.forEach(e => {
                    if (!classCounts[e.classYear]) classCounts[e.classYear] = 0;
                    classCounts[e.classYear]++;
                });
                console.log('Records by class:', classCounts);
                
                if (statusText) statusText.innerHTML = 'âœ… Data reloaded! Total records: ' + all.length + ' | Classes: ' + Object.keys(classCounts).length;
                
                // Also update event cards
                renderEventCards();
                
                let msg = 'Data reloaded!\n\n';
                msg += 'Total records: ' + all.length + '\n';
                msg += 'Classes found: ' + Object.keys(classCounts).join(', ') + '\n\n';
                msg += 'Now click "View Enrollments" or "Show All DB Data"';
                alert(msg);
            }).catch(err => {
                console.error('Firebase error:', err);
                alert('Error loading data: ' + err.message);
                if (statusText) statusText.innerHTML = 'âŒ Error: ' + err.message;
            });
        }
        
        function showAllDatabaseData() {
            console.log('=== SHOWING ALL DATABASE DATA ===');
            const cont = document.getElementById('studentEnrollmentResults');
            
            if (all.length === 0) {
                cont.innerHTML = '<div style="background:#ffebee;color:#c62828;padding:15px;border-radius:6px;border:2px solid #c62828;"><strong>âš ï¸ NO DATA IN DATABASE</strong><br>The "all" array is empty. Try clicking "Reload Data" first.</div>';
                return;
            }
            
            // Group by class
            const classCounts = {};
            all.forEach(e => {
                if (!classCounts[e.classYear]) classCounts[e.classYear] = [];
                classCounts[e.classYear].push(e);
            });
            
            let html = '<div style="background:#fff;border-radius:6px;padding:15px;border:2px solid #9c27b0;">';
            html += '<h4 style="color:#9c27b0;margin-bottom:15px;">ðŸ—„ï¸ Complete Database View (Total: ' + all.length + ' records)</h4>';
            
            Object.keys(classCounts).sort().forEach(cls => {
                const enrollments = classCounts[cls];
                const isYourClass = cls === studentClass;
                
                html += '<div style="background:' + (isYourClass ? '#e8f5e9' : '#f5f5f5') + ';padding:12px;border-radius:6px;margin-bottom:10px;border:2px solid ' + (isYourClass ? '#4CAF50' : '#ccc') + ';">';
                html += '<h5 style="color:' + (isYourClass ? '#2e7d32' : '#333') + ';margin-bottom:8px;">';
                html += (isYourClass ? 'ðŸ‘‰ ' : '') + '"' + cls + '" (' + enrollments.length + ' enrollments)' + (isYourClass ? ' â† YOUR CLASS' : '');
                html += '</h5>';
                
                html += '<table style="width:100%;font-size:12px;"><thead><tr><th>Name</th><th>Phone</th><th>Event</th><th>Role</th></tr></thead><tbody>';
                enrollments.forEach(e => {
                    html += '<tr><td>' + e.name + '</td><td>' + e.phone + '</td><td>' + e.event + '</td><td>' + e.role + '</td></tr>';
                });
                html += '</tbody></table></div>';
            });
            
            html += '</div>';
            cont.innerHTML = html;
        }

        function toggleEnrollmentView() {
            const resultsDiv = document.getElementById('studentEnrollmentResults');
            const btn = document.getElementById('toggleEnrollmentBtn');
            
            if (resultsDiv.style.display === 'none') {
                resultsDiv.style.display = 'block';
                btn.textContent = 'Hide Details';
            } else {
                resultsDiv.style.display = 'none';
                btn.textContent = 'Show Details';
            }
        }

        function viewStudentClassEnrollments() {
            console.log('=== Loading class enrollments ===');
            console.log('Student Class:', studentClass);
            console.log('All enrollments count:', all.length);
            
            const cont = document.getElementById('studentEnrollmentResults');
            
            if (!studentClass) { 
                console.error('ERROR: Student class not set!');
                cont.innerHTML = '<div style="background:#ffebee;color:#c62828;padding:15px;border-radius:6px;border:2px solid #c62828;"><strong>Error:</strong> Student class not set. Please log out and log in again.</div>';
                return; 
            }
            
            console.log('Filtering enrollments for class:', studentClass);
            let classEnr = all.filter(e => e.classYear === studentClass);
            console.log('Filtered enrollments count:', classEnr.length);
            
            // Populate event filter dropdown
            const eventFilter = document.getElementById('studentEventFilter');
            const currentFilter = eventFilter.value;
            
            // Get unique events from class enrollments
            const uniqueEvents = [...new Set(classEnr.map(e => e.event))].sort();
            
            // Update dropdown options
            eventFilter.innerHTML = '<option value="">All Events</option>';
            uniqueEvents.forEach(evt => {
                const option = document.createElement('option');
                option.value = evt;
                option.textContent = evt;
                if (evt === currentFilter) option.selected = true;
                eventFilter.appendChild(option);
            });
            
            // Filter by selected event
            if (currentFilter) {
                classEnr = classEnr.filter(e => e.event === currentFilter);
            }
            
            if (classEnr.length === 0) {
                cont.innerHTML = '<div style="background:#fff3cd;color:#856404;padding:15px;border-radius:6px;border:2px solid #ffc107;text-align:center;"><h4 style="margin-bottom:10px;">No Enrollments</h4><p style="margin:0;">' + (currentFilter ? 'No enrollments found for ' + currentFilter : 'Your class has not enrolled in any events yet.') + '</p></div>';
                return; 
            }
            
            // Group by event
            const eventGroups = {};
            classEnr.forEach(e => {
                if (!eventGroups[e.event]) eventGroups[e.event] = [];
                eventGroups[e.event].push(e);
            });
            
            console.log('Event groups:', eventGroups);
            
            let h = '<div style="background:white;border-radius:6px;padding:15px;border:2px solid #4CAF50;">';
            h += '<h4 style="color:#c44569;margin-bottom:15px;">âœ… ' + studentClass + (currentFilter ? ' - ' + currentFilter : '') + ' - Total: ' + classEnr.length + '</h4>';
            
            // Show summary by event (only if showing all events)
            if (!currentFilter) {
                h += '<div style="margin-bottom:20px;">';
                h += '<h5 style="color:#2196F3;margin-bottom:10px;">ðŸ“Š Enrolled Events:</h5>';
                h += '<div style="display:flex;flex-wrap:wrap;gap:10px;">';
                Object.keys(eventGroups).forEach(evt => {
                    h += '<span style="background:#4CAF50;color:white;padding:8px 15px;border-radius:20px;font-size:14px;font-weight:600;">' + evt + ' (' + eventGroups[evt].length + ')</span>';
                });
                h += '</div></div>';
            }
            
            // Show detailed table
            h += '<div class="table-wrapper"><table><thead><tr><th>Sl</th><th>Name</th><th>Phone</th><th>Event</th><th>Role</th><th>Details</th><th>Actions</th></tr></thead><tbody>';
            classEnr.forEach((e,i) => {
                h += '<tr><td>'+(i+1)+'</td><td>'+e.name+'</td><td>'+e.phone+'</td><td>'+e.event+'</td><td>'+e.role+'</td><td>'+getDet(e)+'</td>';
                h += '<td><button class="edit-btn" data-key="'+e.id+'" onclick="editEnrollmentByKey(this.getAttribute(\'data-key\'))">Edit</button>';
                h += '<button class="delete-btn" data-key="'+e.id+'" data-name="'+e.name+'" data-event="'+e.event+'" onclick="deleteEnrollmentByKey(this.getAttribute(\'data-key\'), this.getAttribute(\'data-name\'), this.getAttribute(\'data-event\'))">Delete</button></td></tr>';
            });
            h += '</tbody></table></div></div>';
            cont.innerHTML = h;
            
            console.log('=== Enrollment display complete ===');
        }

        function logout() {
            studentClass = null;
            crClass = null;
            window.currentCRClass = null;
            isAdmin = false;
            // Note: we do NOT clear localStorage here â€” saved credentials persist across logouts
            isSuperAdmin = false;
            isManager = false;
            isManager2 = false;
            isCR = false;
            isJury = false;
            juryEvent = null;
            juryNumber = null;
            currentUser = null;
            
            // Quiz logout
            quizCurrentUser = null;
            quizUserRole = null;
            quizAntiCheatActive = false;
            if (quizTimerInterval) clearInterval(quizTimerInterval);
            stopQuizLiveClock();
            
            document.getElementById('userInfo').innerHTML = '';
            document.getElementById('loginSection').style.display = 'block';
            document.getElementById('studentSection').style.display = 'none';
            document.getElementById('crSection').style.display = 'none';
            // Restore any admin children hidden during jury login
            Array.from(document.getElementById('adminSection').children).forEach(el => {
                el.style.display = '';
            });
            document.getElementById('adminSection').style.display = 'none';
            document.getElementById('jurySection').style.display = 'none';
            document.getElementById('quizStudentDashboard').style.display = 'none';
            // quizAdminDashboard removed - no longer used
            document.getElementById('quizPage').style.display = 'none';
            document.getElementById('shStudentDashboard').style.display  = 'none';
            document.getElementById('sscStudentDashboard').style.display = 'none';
            shCurrentUser = null;
            sscCurrentUser = null;
            clearInterval(sscTimerRef);
            if (typeof shAdminStopSubmissionsListener === 'function') shAdminStopSubmissionsListener();
            document.getElementById('userType').value = '';
            document.getElementById('competitionType').value = '';
            handleCompetitionChange();
            handleUserTypeChange();
        }


        // Returns the effective maxPerClass for an event, factoring in pctMax + class strengths
        // classStr = { 'className': strength } from leaderboardConfig/classStrengths (Firebase)
        // We cache it in window._classStrengths
        function getEffectiveMax(cfg, cls) {
            if (!cfg.pctMax) return cfg.maxPerClass;
            const strengths = window._classStrengths || {};
            // Firebase sanitises class name keys (dots/slashes â†’ _)
            const key = cls ? cls.replace(/[.\[\]#$\/]/g, '_') : '';
            const strength = strengths[key] || strengths[cls] || 0;
            if (!strength) return cfg.maxPerClass; // fallback if not set
            const pctVal = Math.floor(strength * cfg.pctMax / 100);
            return Math.max(cfg.minCount || 1, pctVal);
        }

        // Load class strengths once and cache; call renderEventCards after
        function effMaxForSubmit(cfg) {
            // Used during submit when _currentEnrollCount might be stale
            const strengths = window._classStrengths || {};
            if (!cfg.pctMax) return cfg.maxPerClass;
            // Try to find strength from current context
            const cls = window.currentCRClass || studentClass || '';
            const key = cls.replace(/[.[\]#$\/]/g, '_');
            const strength = strengths[key] || strengths[cls] || 0;
            return strength ? Math.max(1, Math.floor(strength * cfg.pctMax / 100)) : 1;
        }

        async function loadClassStrengthsAndRender(renderFn) {
            try {
                const snap = await db.ref('leaderboardConfig/classStrengths').once('value');
                window._classStrengths = snap.val() || {};
            } catch(e) {
                window._classStrengths = {};
            }
            renderFn();
        }

        function renderEventCards() {
            const cont = document.getElementById('eventCardsContainer');
            cont.innerHTML = '';
            Object.keys(events).forEach(ev => {
                const cfg = events[ev];
                const enrolled = all.filter(e => e.event===ev && e.classYear===studentClass).length;
                const effMax = getEffectiveMax(cfg, studentClass);
                const enrolledCount = cfg.allowIndividual || !cfg.count ? enrolled : (cfg.count === 1 ? enrolled : Math.ceil(enrolled / cfg.count));
                const remaining = effMax - enrolledCount;
                const isFull = remaining <= 0;
                const card = document.createElement('div');
                card.className = 'event-card' + (isFull ? ' full' : '');
                const label = cfg.pctMax ? `${enrolledCount}/${effMax} enrolled <span style="font-size:11px;opacity:0.8">(${cfg.pctMax}% of class)</span>` : `${enrolledCount}/${effMax} enrolled`;
                card.innerHTML = '<div class="event-title">'+ev+'</div><div class="event-size">'+cfg.size+'</div><div class="event-status '+(isFull?'status-full':(remaining<=1?'status-limited':'status-available'))+'">'+label+'</div>';
                if (!isFull) card.onclick = () => startEnrollment(ev);
                cont.appendChild(card);
            });
        }

        function renderCREventCards() {
            const cont = document.getElementById('crEventCardsContainer');
            cont.innerHTML = '';
            Object.keys(events).forEach(ev => {
                const cfg = events[ev];
                const enrolled = all.filter(e => e.event===ev && e.classYear===crClass).length;
                const effMax = getEffectiveMax(cfg, crClass);
                const enrolledCount = cfg.allowIndividual || !cfg.count ? enrolled : (cfg.count === 1 ? enrolled : Math.ceil(enrolled / cfg.count));
                const remaining = effMax - enrolledCount;
                const isFull = remaining <= 0;
                const card = document.createElement('div');
                card.className = 'event-card' + (isFull ? ' full' : '');
                const label = cfg.pctMax ? `${enrolledCount}/${effMax} enrolled <span style="font-size:11px;opacity:0.8">(${cfg.pctMax}% of class)</span>` : `${enrolledCount}/${effMax} enrolled`;
                card.innerHTML = '<div class="event-title">'+ev+'</div><div class="event-size">'+cfg.size+'</div><div class="event-status '+(isFull?'status-full':(remaining<=1?'status-limited':'status-available'))+'">'+label+'</div>';
                if (!isFull) card.onclick = () => startCREnrollment(ev);
                cont.appendChild(card);
            });
        }

        async function startEnrollment(ev) {
            selectedEvent = ev;
            const cfg = events[ev];
            const enrolled = all.filter(e => e.event===ev && e.classYear===studentClass).length;
            
            // Calculate how many teams/participants are already enrolled
            const effMax = getEffectiveMax(cfg, studentClass);
            const enrolledCount = cfg.allowIndividual || !cfg.count ? enrolled : (cfg.count === 1 ? enrolled : Math.ceil(enrolled / cfg.count));
            const remaining = effMax - enrolledCount;
            
            if (remaining <= 0) { alert('Event is full for your class'); return; }
            
            const maxLabel = cfg.pctMax ? `${effMax} (${cfg.pctMax}% of class strength)` : effMax;
            let html = '<button class="btn btn-secondary" onclick="cancelEnrollment()" style="margin-bottom:18px;padding:8px 20px">â† Back to Events</button>';
            html += '<h3 style="color:#c44569;margin-bottom:12px">Enroll for: '+ev+'</h3>';
            html += '<p style="margin-bottom:20px;color:#666">'+cfg.size+' | Already Enrolled: '+enrolledCount+' / '+maxLabel+'</p>';
            if (cfg.minCount && cfg.pctMax && cfg.dynamicCount) {
                html += '<div style="background:#e3f2fd;border:1px solid #1565c0;border-radius:8px;padding:12px 16px;margin-bottom:16px;color:#0d47a1"><strong>ðŸ“‹ Team Size Rules:</strong> Minimum <strong>'+cfg.minCount+' members</strong> required. Maximum is <strong>'+cfg.pctMax+'% of your class strength</strong> ('+effMax+' members).</div>';
            }
            
            // For dynamicCount events (like Ramp Walk), use effMax as member count
            const actualCount = cfg.dynamicCount ? effMax : cfg.count;
            window._currentEnrollCount = actualCount; // store for submitEnrollment

            // Generate input fields based on team size
            for (let i = 0; i < actualCount; i++) {
                const roleLabel = cfg.role ? (i === 0 ? 'Captain' : 'Member '+(i+1)) : 'Participant '+(i+1);
                html += '<div class="team-member-box"><div class="member-header">'+roleLabel+'</div>';
                html += '<div class="form-group"><label>Name:</label><input type="text" id="name'+i+'" placeholder="Enter full name"></div>';
                html += '<div class="form-group"><label>Phone Number:</label><input type="tel" id="phone'+i+'" placeholder="10-digit mobile number" maxlength="10"></div>';
                html += '</div>';
            }
            // Dynamic add-member button (e.g. Group Dance: min 5, max 8)
            if (cfg.maxCount && actualCount < cfg.maxCount) {
                window._dynMemberCount = actualCount;
                window._dynMemberMax = cfg.maxCount;
                window._dynMemberRole = cfg.role;
                html += '<div id="dynMemberContainer"></div>';
                html += '<button type="button" id="dynAddMemberBtn" class="btn btn-secondary" style="margin-bottom:18px" onclick="dynAddMember()">âž• Add Member (' + actualCount + '/' + cfg.maxCount + ' max)</button>';
            }
            
            // Event-specific fields
            if (cfg.topic) {
                if (cfg.vlogTopics) {
                    // Fetch already-taken topics from Firebase for this class & event
                    const takenTopics = new Set();
                    try {
                        const snapT = await db.ref('youthfest-enrollments').orderByChild('event').equalTo(ev).once('value');
                        snapT.forEach(c => { const d = c.val(); if (d.classYear === studentClass && d.topic) takenTopics.add(d.topic); });
                    } catch(e) {}
                    let opts = '<option value="">-- Select Topic --</option>';
                    cfg.vlogTopics.forEach(t => {
                        const taken = takenTopics.has(t);
                        opts += `<option value="${t}" ${taken ? 'disabled style="color:#aaa"' : ''}>${t}${taken ? ' (already taken)' : ''}</option>`;
                    });
                    html += '<div class="form-group"><label>ðŸŽ¬ Vlog Topic: <span style="color:red">*</span></label><select id="topic">'+opts+'</select><p style="font-size:12px;color:#856404;margin-top:6px">âš ï¸ Each team must choose a different topic. Greyed-out topics are already taken by your class.</p></div>';
                } else if (cfg.podcastTopics) {
                    const takenTopics = new Set();
                    try {
                        const snapT = await db.ref('youthfest-enrollments').orderByChild('event').equalTo(ev).once('value');
                        snapT.forEach(c => { const d = c.val(); if (d.classYear === studentClass && d.topic) takenTopics.add(d.topic); });
                    } catch(e) {}
                    let opts = '<option value="">-- Select Topic --</option>';
                    cfg.podcastTopics.forEach(t => {
                        const taken = takenTopics.has(t);
                        opts += `<option value="${t}" ${taken ? 'disabled style="color:#aaa"' : ''}>${t}${taken ? ' (already taken)' : ''}</option>`;
                    });
                    html += '<div class="form-group"><label>ðŸŽ™ï¸ Podcast Topic: <span style="color:red">*</span></label><select id="topic">'+opts+'</select><p style="font-size:12px;color:#856404;margin-top:6px">âš ï¸ Each participant must choose a different topic. Greyed-out topics are already taken by your class.</p></div>';
                } else {
                    html += '<div class="form-group"><label>'+cfg.topicLabel+':</label><input type="text" id="topic" placeholder="Enter '+cfg.topicLabel.toLowerCase()+'"></div>';
                }
            }
            if (cfg.prod) {
                html += '<div class="form-group"><label>Product Name:</label><input type="text" id="product" placeholder="What product will you advertise?"></div>';
            }
            if (cfg.cause) {
                html += '<div class="form-group"><label>'+(cfg.causeLabel || 'Cause')+':</label><input type="text" id="cause" placeholder="Enter cause/theme"></div>';
            }
            if (cfg.camera) {
                html += '<div class="team-member-box" style="border-left:4px solid #e67e22;background:#fff8f0"><div class="member-header" style="background:linear-gradient(135deg,#e67e22,#f39c12)">ðŸ“¹ Camera Person</div>';
                html += '<div class="form-group"><label>Name: <span style="color:red">*</span></label><input type="text" id="cameraName" placeholder="Enter camera person full name"></div>';
                html += '<div class="form-group"><label>Phone Number: <span style="color:red">*</span></label><input type="tel" id="cameraPhone" placeholder="10-digit mobile number" maxlength="10"></div>';
                html += '<p style="font-size:12px;color:#856404;margin-top:6px;padding:6px;background:#fff3cd;border-radius:4px">âš ï¸ Camera person is not a performer â€” not counted in the team size.</p>';
                html += '</div>';
            }
            if (cfg.lang) {
                html += '<div class="form-group"><label>Languages:</label><div><label style="display:inline-block;margin-right:15px"><input type="checkbox" id="langEn" checked disabled> English</label><label style="display:inline-block;margin-right:15px"><input type="checkbox" id="langKn"> Kannada</label><label style="display:inline-block"><input type="checkbox" id="langHi"> Hindi</label></div></div>';
            }
            if (cfg.show) {
                html += '<div class="form-group"><label>Showstopper Name:</label><input type="text" id="showstopper" placeholder="Name of showstopper"></div>';
            }
            if (cfg.talent) {
                html += '<div class="form-group"><label>ðŸŽ­ Talent Type: <span style="color:red">*</span></label><select id="talentType"><option value="">-- Select Talent --</option><option>Classical Dance</option><option>Folk Dance</option><option>Western Dance</option><option>Freestyle Dance</option><option>Singing</option><option>Instrumental Music</option><option>Mimicry</option><option>Standup Comedy</option><option>Magic</option><option>Acrobatics / Gymnastics</option><option>Mono Act</option><option>Beatboxing</option><option>Other</option></select></div><div class="form-group" id="talentOtherDiv" style="display:none"><label>Specify Talent:</label><input type="text" id="talentOther" placeholder="Describe your talent"></div>';
            }
            
            // Best out of Waste: individual/team toggle
            if (cfg.allowIndividual) {
                const pctLabel = cfg.pctMax ? ` (${cfg.pctMax}% of class = ${effMax} participants)` : '';
                const toggleHtml = `<div class="form-group" style="background:#f0f4ff;border:2px solid #667eea;border-radius:10px;padding:15px;margin-bottom:18px">
                    <label style="font-weight:700;color:#667eea;font-size:1.05em">â™»ï¸ Participation Type${pctLabel}:</label>
                    <div style="margin-top:10px;display:flex;gap:15px;flex-wrap:wrap">
                        <label style="display:flex;align-items:center;gap:8px;cursor:pointer;background:white;padding:10px 18px;border-radius:8px;border:2px solid #667eea;font-weight:600">
                            <input type="radio" name="bowType" value="team" id="bowTeam" checked onchange="bowToggleMember(2)"> ðŸ‘¥ Team (2 Members)
                        </label>
                        <label style="display:flex;align-items:center;gap:8px;cursor:pointer;background:white;padding:10px 18px;border-radius:8px;border:2px solid #c44569;font-weight:600">
                            <input type="radio" name="bowType" value="individual" id="bowIndividual" onchange="bowToggleMember(1)"> ðŸ§‘ Individual
                        </label>
                    </div>
                    <p style="margin-top:8px;font-size:12px;color:#856404;background:#fff3cd;padding:8px;border-radius:6px">âš ï¸ 10% of your class can participate. Each person (team or individual) counts against this limit.</p>
                </div>`;
                html = html.replace('<div class="team-member-box">', toggleHtml + '<div class="team-member-box" id="bowMember0">');
                let second = false;
                html = html.replace(/<div class="team-member-box">/g, (m) => {
                    if (!second) { second = true; return m; }
                    return '<div class="team-member-box" id="bowMember1">';
                });
            }

            // For oneAtATime, show correct sequential participant number
            if (cfg.oneAtATime) {
                const participantNum = enrolledCount + 1;
                html = html.replace('Participant 1', 'Participant ' + participantNum);
                document.getElementById('enrollBtnsNormal').style.display = 'none';
                document.getElementById('enrollBtnsOneAtATime').style.display = 'block';
            } else if (cfg.multiTeam && remaining > 1) {
                document.getElementById('enrollBtnsNormal').style.display = 'none';
                document.getElementById('enrollBtnsOneAtATime').style.display = 'block';
                const addBtn = document.querySelector('#enrollBtnsOneAtATime button:first-child');
                const finBtn = document.querySelector('#enrollBtnsOneAtATime button:nth-child(2)');
                if (addBtn) addBtn.textContent = 'âœ… Submit Team & Add Next Team';
                if (finBtn) finBtn.textContent = 'âœ” Submit Team & Finish';
                const teamNum = enrolledCount + 1;
                html = '<div style="background:#e8f5e9;border:2px solid #4caf50;border-radius:10px;padding:12px 18px;margin-bottom:18px;text-align:center"><strong style="color:#1b5e20">ðŸ“‹ Adding Team ' + teamNum + ' of ' + effMax + ' (max for your class)</strong></div>' + html;
            } else {
                document.getElementById('enrollBtnsNormal').style.display = 'block';
                document.getElementById('enrollBtnsOneAtATime').style.display = 'none';
                const addBtn = document.querySelector('#enrollBtnsOneAtATime button:first-child');
                const finBtn = document.querySelector('#enrollBtnsOneAtATime button:nth-child(2)');
                if (addBtn) addBtn.textContent = 'âœ… Submit & Add Another';
                if (finBtn) finBtn.textContent = 'âœ” Submit & Finish';
            }

            document.getElementById('enrollmentFormContent').innerHTML = html;
            if (cfg.talent) {
                const ts = document.getElementById('talentType');
                if (ts) ts.addEventListener('change', function(){ document.getElementById('talentOtherDiv').style.display = this.value === 'Other' ? 'block' : 'none'; });
            }
            document.getElementById('eventCardsContainer').style.display = 'none';
            document.getElementById('enrollmentForm').style.display = 'block';
        }

        function bowToggleMember(count) {
            const m1 = document.getElementById('bowMember1');
            if (m1) m1.style.display = count === 2 ? 'block' : 'none';
        }

        function submitEnrollment(addAnother) {
            const cfg = events[selectedEvent];
            const members = [];
            
            // Collect all team members (use dynamic count for Ramp Walk)
            let submitCount = cfg.dynamicCount ? (window._currentEnrollCount || effMaxForSubmit(cfg)) : (cfg.maxCount ? (window._dynMemberCount || cfg.count) : cfg.count);
            if (cfg.allowIndividual) {
                const bowRadio = document.querySelector('input[name="bowType"]:checked');
                submitCount = (bowRadio && bowRadio.value === 'individual') ? 1 : 2;
            }
            for (let i = 0; i < submitCount; i++) {
                const name = document.getElementById('name'+i).value.trim();
                const phone = document.getElementById('phone'+i).value.trim();
                
                if (!name || !phone) { 
                    alert('Please fill all team member fields'); 
                    return; 
                }
                if (!/^\d{10}$/.test(phone)) { 
                    alert('Please enter valid 10-digit phone number for '+name); 
                    return; 
                }
                
                const role = cfg.role ? (i === 0 ? 'Captain' : 'Member') : 'Participant';
                members.push({name: name, phone: phone, role: role});
            }
            
            // Base data for all members
            const baseData = {
                classYear: studentClass,
                event: selectedEvent,
                timestamp: Date.now()
            };
            
            // Add event-specific fields
            if (cfg.topic) {
                const topic = document.getElementById('topic');
                const topicVal = topic ? topic.value.trim() : '';
                if (!topicVal) {
                    alert(cfg.vlogTopics ? 'Please select a Vlog topic' : cfg.podcastTopics ? 'Please select a Podcast topic' : 'Please enter '+cfg.topicLabel);
                    return;
                }
                // Double-check vlog topic isn't taken (race condition guard)
                if (cfg.vlogTopics) {
                    const alreadyTaken = all.filter(e => e.event === selectedEvent && e.classYear === studentClass && e.topic === topicVal).length > 0;
                    if (alreadyTaken) { alert('âš ï¸ This topic was just taken by another team! Please go back and select a different topic.'); return; }
                }
                baseData.topic = topicVal;
            }
            
            if (cfg.prod) {
                const product = document.getElementById('product');
                if (!product || !product.value.trim()) {
                    alert('Please enter product name');
                    return;
                }
                baseData.product = product.value.trim();
            }
            
            if (cfg.cause) {
                const cause = document.getElementById('cause');
                if (!cause || !cause.value.trim()) {
                    alert('Please enter '+(cfg.causeLabel || 'cause'));
                    return;
                }
                baseData.cause = cause.value.trim();
            }
            if (cfg.camera) {
                const camName = document.getElementById('cameraName');
                const camPhone = document.getElementById('cameraPhone');
                if (!camName || !camName.value.trim()) { alert('Please enter the camera person name'); return; }
                if (!camPhone || !/^\d{10}$/.test(camPhone.value.trim())) { alert('Please enter a valid 10-digit phone number for the camera person'); return; }
                baseData.cameraName = camName.value.trim();
                baseData.cameraPhone = camPhone.value.trim();
            }
            if (cfg.minCount && !cfg.maxCount && members.length < cfg.minCount) {
                alert('Minimum ' + cfg.minCount + ' members required for ' + selectedEvent);
                return;
            }
            
            if (cfg.lang) {
                const langs = ['English'];
                const kn = document.getElementById('langKn');
                const hi = document.getElementById('langHi');
                if (kn && kn.checked) langs.push('Kannada');
                if (hi && hi.checked) langs.push('Hindi');
                baseData.languages = langs.join(', ');
            }
            if (cfg.talent) {
                const talentSel = document.getElementById('talentType');
                const talentVal = talentSel ? talentSel.value.trim() : '';
                if (!talentVal) { alert('Please select a talent type'); return; }
                if (talentVal === 'Other') {
                    const otherVal = document.getElementById('talentOther') ? document.getElementById('talentOther').value.trim() : '';
                    if (!otherVal) { alert('Please specify your talent'); return; }
                    baseData.talentType = otherVal;
                } else {
                    baseData.talentType = talentVal;
                }
            }
            
            if (cfg.show) {
                const show = document.getElementById('showstopper');
                if (!show || !show.value.trim()) {
                    alert('Please enter showstopper name');
                    return;
                }
                baseData.showstopper = show.value.trim();
            }
            
            // For multiTeam events: assign shared teamNum so all members of this submission are grouped as one team
            if (cfg.multiTeam) {
                const sameEventEntries = all.filter(e => e.event === selectedEvent && e.classYear === studentClass);
                // For allowIndividual events (e.g. BOW), count distinct existing teamNums to avoid miscalc
                const existingTeamNums = cfg.allowIndividual
                    ? new Set(sameEventEntries.map(e => e.teamNum).filter(n => n != null)).size
                    : Math.ceil(sameEventEntries.length / cfg.count);
                baseData.teamNum = existingTeamNums + 1;
            }

            // Submit all members
            const promises = members.map(m => {
                const data = {...baseData, name: m.name, phone: m.phone, role: m.role};
                return ref.push(data);
            });
            
            // Validate minCount before submitting
            if (cfg.minCount && members.length < cfg.minCount) {
                alert('Minimum ' + cfg.minCount + ' members required for ' + selectedEvent + '. Please add at least ' + cfg.minCount + ' members.');
                return;
            }

            Promise.all(promises).then(() => {
                const eventName = selectedEvent;
                if (addAnother) {
                    showOk('âœ… Participant enrolled! Form ready for next participant.');
                    // Re-open form for same event â€” data reloads from Firebase
                    setTimeout(() => startEnrollment(eventName), 400);
                } else {
                    showOk('Successfully enrolled '+members.length+' member(s) for '+eventName+'!');
                    cancelEnrollment();
                }
            }).catch(err => showErr('Error: '+err.message));
        }

        // Dynamic add-member for variable-size teams (e.g. Group Dance 5-8)
        function dynAddMember() {
            const current = window._dynMemberCount || 0;
            const max = window._dynMemberMax || current;
            if (current >= max) return;
            const idx = current;
            const roleLabel = window._dynMemberRole ? 'Member ' + (idx + 1) : 'Participant ' + (idx + 1);
            const box = document.createElement('div');
            box.className = 'team-member-box';
            box.id = 'dynBox' + idx;
            box.innerHTML = '<div class="member-header">' + roleLabel + '</div>' +
                '<div class="form-group"><label>Name:</label><input type="text" id="name' + idx + '" placeholder="Enter full name"></div>' +
                '<div class="form-group"><label>Phone Number:</label><input type="tel" id="phone' + idx + '" placeholder="10-digit mobile number" maxlength="10"></div>';
            document.getElementById('dynMemberContainer').appendChild(box);
            window._dynMemberCount = idx + 1;
            const btn = document.getElementById('dynAddMemberBtn');
            if (btn) {
                if (window._dynMemberCount >= max) {
                    btn.style.display = 'none';
                } else {
                    btn.textContent = 'âž• Add Member (' + window._dynMemberCount + '/' + max + ' max)';
                }
            }
        }

        function crDynAddMember() {
            const current = window._crDynMemberCount || 0;
            const max = window._crDynMemberMax || current;
            if (current >= max) return;
            const idx = current;
            const roleLabel = window._crDynMemberRole ? 'Member ' + (idx + 1) : 'Participant ' + (idx + 1);
            const box = document.createElement('div');
            box.className = 'team-member-box';
            box.id = 'crDynBox' + idx;
            box.innerHTML = '<div class="member-header">' + roleLabel + '</div>' +
                '<div class="form-group"><label>Name:</label><input type="text" id="crName' + idx + '" placeholder="Enter student full name"></div>' +
                '<div class="form-group"><label>Phone Number:</label><input type="tel" id="crPhone' + idx + '" placeholder="10-digit mobile number" maxlength="10"></div>';
            document.getElementById('crDynMemberContainer').appendChild(box);
            window._crDynMemberCount = idx + 1;
            const btn = document.getElementById('crDynAddMemberBtn');
            if (btn) {
                if (window._crDynMemberCount >= max) {
                    btn.style.display = 'none';
                } else {
                    btn.textContent = 'âž• Add Member (' + window._crDynMemberCount + '/' + max + ' max)';
                }
            }
        }

        function cancelEnrollment() {
            selectedEvent = null;
            document.getElementById('enrollmentForm').style.display = 'none';
            document.getElementById('eventCardsContainer').style.display = 'grid';
            document.getElementById('eventCardsContainer').scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        // CR Functions
        async function startCREnrollment(ev) {
            selectedEvent = ev;
            const cfg = events[ev];
            const enrolled = all.filter(e => e.event===ev && e.classYear===crClass).length;
            
            const effMax = getEffectiveMax(cfg, crClass);
            const enrolledCount = (!cfg.count || cfg.count === 1) ? enrolled : Math.ceil(enrolled / cfg.count);
            const remaining = effMax - enrolledCount;
            
            if (remaining <= 0) { alert('Event is full for your class'); return; }
            
            const maxLabel = cfg.pctMax ? `${effMax} (${cfg.pctMax}% of class strength)` : effMax;
            let html = '<button class="btn btn-secondary" onclick="cancelCREnrollment()" style="margin-bottom:18px;padding:8px 20px">â† Back to Events</button>';
            html += '<h3 style="color:#c44569;margin-bottom:12px">Enroll Students for: '+ev+'</h3>';
            html += '<p style="margin-bottom:20px;color:#666">Class: '+crClass+' | '+cfg.size+' | Enrolled: '+enrolledCount+' / '+maxLabel+'</p>';
            if (cfg.minCount && cfg.pctMax && cfg.dynamicCount) {
                html += '<div style="background:#e3f2fd;border:1px solid #1565c0;border-radius:8px;padding:12px 16px;margin-bottom:16px;color:#0d47a1"><strong>ðŸ“‹ Team Size Rules:</strong> Minimum <strong>'+cfg.minCount+' members</strong> required. Maximum is <strong>'+cfg.pctMax+'% of your class strength</strong> ('+effMax+' members).</div>';
            }
            
            // Generate input fields based on team size
            const crActualCount = cfg.dynamicCount ? effMax : cfg.count;
            window._currentCREnrollCount = crActualCount;
            for (let i = 0; i < crActualCount; i++) {
                const roleLabel = cfg.role ? (i === 0 ? 'Captain' : 'Member '+(i+1)) : 'Participant '+(i+1);
                html += '<div class="team-member-box"><div class="member-header">'+roleLabel+'</div>';
                html += '<div class="form-group"><label>Name:</label><input type="text" id="crName'+i+'" placeholder="Enter student full name"></div>';
                html += '<div class="form-group"><label>Phone Number:</label><input type="tel" id="crPhone'+i+'" placeholder="10-digit mobile number" maxlength="10"></div>';
                html += '</div>';
            }
            // Dynamic add-member button for CR (e.g. Group Dance: min 5, max 8)
            if (cfg.maxCount && crActualCount < cfg.maxCount) {
                window._crDynMemberCount = crActualCount;
                window._crDynMemberMax = cfg.maxCount;
                window._crDynMemberRole = cfg.role;
                html += '<div id="crDynMemberContainer"></div>';
                html += '<button type="button" id="crDynAddMemberBtn" class="btn btn-secondary" style="margin-bottom:18px" onclick="crDynAddMember()">âž• Add Member (' + crActualCount + '/' + cfg.maxCount + ' max)</button>';
            }
            
            // Event-specific fields
            if (cfg.topic) {
                if (cfg.vlogTopics) {
                    const takenTopics = new Set();
                    try {
                        const snapT = await db.ref('youthfest-enrollments').orderByChild('event').equalTo(ev).once('value');
                        snapT.forEach(c => { const d = c.val(); if (d.classYear === crClass && d.topic) takenTopics.add(d.topic); });
                    } catch(e) {}
                    let opts = '<option value="">-- Select Topic --</option>';
                    cfg.vlogTopics.forEach(t => {
                        const taken = takenTopics.has(t);
                        opts += `<option value="${t}" ${taken ? 'disabled style="color:#aaa"' : ''}>${t}${taken ? ' (already taken)' : ''}</option>`;
                    });
                    html += '<div class="form-group"><label>ðŸŽ¬ Vlog Topic: <span style="color:red">*</span></label><select id="crTopic">'+opts+'</select><p style="font-size:12px;color:#856404;margin-top:6px">âš ï¸ Each team must choose a different topic. Greyed-out topics are already taken by your class.</p></div>';
                } else if (cfg.podcastTopics) {
                    const takenTopics = new Set();
                    try {
                        const snapT = await db.ref('youthfest-enrollments').orderByChild('event').equalTo(ev).once('value');
                        snapT.forEach(c => { const d = c.val(); if (d.classYear === crClass && d.topic) takenTopics.add(d.topic); });
                    } catch(e) {}
                    let opts = '<option value="">-- Select Topic --</option>';
                    cfg.podcastTopics.forEach(t => {
                        const taken = takenTopics.has(t);
                        opts += `<option value="${t}" ${taken ? 'disabled style="color:#aaa"' : ''}>${t}${taken ? ' (already taken)' : ''}</option>`;
                    });
                    html += '<div class="form-group"><label>ðŸŽ™ï¸ Podcast Topic: <span style="color:red">*</span></label><select id="crTopic">'+opts+'</select><p style="font-size:12px;color:#856404;margin-top:6px">âš ï¸ Each participant must choose a different topic. Greyed-out topics are already taken by your class.</p></div>';
                } else {
                    html += '<div class="form-group"><label>'+cfg.topicLabel+':</label><input type="text" id="crTopic" placeholder="Enter '+cfg.topicLabel.toLowerCase()+'"></div>';
                }
            }
            if (cfg.prod) {
                html += '<div class="form-group"><label>Product Name:</label><input type="text" id="crProduct" placeholder="What product will they advertise?"></div>';
            }
            if (cfg.cause) {
                html += '<div class="form-group"><label>'+(cfg.causeLabel || 'Cause')+':</label><input type="text" id="crCause" placeholder="Enter cause/theme"></div>';
            }
            if (cfg.camera) {
                html += '<div class="team-member-box" style="border-left:4px solid #e67e22;background:#fff8f0"><div class="member-header" style="background:linear-gradient(135deg,#e67e22,#f39c12)">ðŸ“¹ Camera Person</div>';
                html += '<div class="form-group"><label>Name: <span style="color:red">*</span></label><input type="text" id="crCameraName" placeholder="Enter camera person full name"></div>';
                html += '<div class="form-group"><label>Phone Number: <span style="color:red">*</span></label><input type="tel" id="crCameraPhone" placeholder="10-digit mobile number" maxlength="10"></div>';
                html += '<p style="font-size:12px;color:#856404;margin-top:6px;padding:6px;background:#fff3cd;border-radius:4px">âš ï¸ Camera person is not a performer â€” not counted in the team size.</p>';
                html += '</div>';
            }
            if (cfg.lang) {
                html += '<div class="form-group"><label>Languages:</label><div><label style="display:inline-block;margin-right:15px"><input type="checkbox" id="crLangEn" checked disabled> English</label><label style="display:inline-block;margin-right:15px"><input type="checkbox" id="crLangKn"> Kannada</label><label style="display:inline-block"><input type="checkbox" id="crLangHi"> Hindi</label></div></div>';
            }
            if (cfg.show) {
                html += '<div class="form-group"><label>Showstopper Name:</label><input type="text" id="crShowstopper" placeholder="Name of showstopper"></div>';
            }
            if (cfg.talent) {
                html += '<div class="form-group"><label>ðŸŽ­ Talent Type: <span style="color:red">*</span></label><select id="crTalentType"><option value="">-- Select Talent --</option><option>Classical Dance</option><option>Folk Dance</option><option>Western Dance</option><option>Freestyle Dance</option><option>Singing</option><option>Instrumental Music</option><option>Mimicry</option><option>Standup Comedy</option><option>Magic</option><option>Acrobatics / Gymnastics</option><option>Mono Act</option><option>Beatboxing</option><option>Other</option></select></div><div class="form-group" id="crTalentOtherDiv" style="display:none"><label>Specify Talent:</label><input type="text" id="crTalentOther" placeholder="Describe your talent"></div>';
            }
            
            if (cfg.allowIndividual) {
                const pctLabel = cfg.pctMax ? ` (${cfg.pctMax}% of class = ${effMax} participants)` : '';
                const toggleHtml = `<div class="form-group" style="background:#f0f4ff;border:2px solid #667eea;border-radius:10px;padding:15px;margin-bottom:18px">
                    <label style="font-weight:700;color:#667eea;font-size:1.05em">â™»ï¸ Participation Type${pctLabel}:</label>
                    <div style="margin-top:10px;display:flex;gap:15px;flex-wrap:wrap">
                        <label style="display:flex;align-items:center;gap:8px;cursor:pointer;background:white;padding:10px 18px;border-radius:8px;border:2px solid #667eea;font-weight:600">
                            <input type="radio" name="crBowType" value="team" id="crBowTeam" checked onchange="crBowToggleMember(2)"> ðŸ‘¥ Team (2 Members)
                        </label>
                        <label style="display:flex;align-items:center;gap:8px;cursor:pointer;background:white;padding:10px 18px;border-radius:8px;border:2px solid #c44569;font-weight:600">
                            <input type="radio" name="crBowType" value="individual" id="crBowIndividual" onchange="crBowToggleMember(1)"> ðŸ§‘ Individual
                        </label>
                    </div>
                    <p style="margin-top:8px;font-size:12px;color:#856404;background:#fff3cd;padding:8px;border-radius:6px">âš ï¸ 10% of your class can participate. Each person counts against this limit.</p>
                </div>`;
                html = html.replace('<div class="team-member-box">', toggleHtml + '<div class="team-member-box" id="crBowMember0">');
                let second = false;
                html = html.replace(/<div class="team-member-box">/g, (m) => {
                    if (!second) { second = true; return m; }
                    return '<div class="team-member-box" id="crBowMember1">';
                });
            }

            if (cfg.oneAtATime) {
                const participantNum = enrolledCount + 1;
                html = html.replace('Participant 1', 'Participant ' + participantNum);
                document.getElementById('crEnrollBtnsNormal').style.display = 'none';
                document.getElementById('crEnrollBtnsOneAtATime').style.display = 'block';
            } else if (cfg.multiTeam && remaining > 1) {
                document.getElementById('crEnrollBtnsNormal').style.display = 'none';
                document.getElementById('crEnrollBtnsOneAtATime').style.display = 'block';
                const addBtn = document.querySelector('#crEnrollBtnsOneAtATime button:first-child');
                const finBtn = document.querySelector('#crEnrollBtnsOneAtATime button:nth-child(2)');
                if (addBtn) addBtn.textContent = 'âœ… Submit Team & Add Next Team';
                if (finBtn) finBtn.textContent = 'âœ” Submit Team & Finish';
                const teamNum = enrolledCount + 1;
                html = '<div style="background:#e8f5e9;border:2px solid #4caf50;border-radius:10px;padding:12px 18px;margin-bottom:18px;text-align:center"><strong style="color:#1b5e20">ðŸ“‹ Adding Team ' + teamNum + ' of ' + effMax + ' (max for your class)</strong></div>' + html;
            } else {
                document.getElementById('crEnrollBtnsNormal').style.display = 'block';
                document.getElementById('crEnrollBtnsOneAtATime').style.display = 'none';
                const addBtn = document.querySelector('#crEnrollBtnsOneAtATime button:first-child');
                const finBtn = document.querySelector('#crEnrollBtnsOneAtATime button:nth-child(2)');
                if (addBtn) addBtn.textContent = 'âœ… Submit & Add Another';
                if (finBtn) finBtn.textContent = 'âœ” Submit & Finish';
            }

            document.getElementById('crEnrollmentFormContent').innerHTML = html;
            if (cfg.talent) {
                const ts = document.getElementById('crTalentType');
                if (ts) ts.addEventListener('change', function(){ document.getElementById('crTalentOtherDiv').style.display = this.value === 'Other' ? 'block' : 'none'; });
            }
            document.getElementById('crEventCardsContainer').style.display = 'none';
            document.getElementById('crEnrollmentForm').style.display = 'block';
        }

        function crBowToggleMember(count) {
            const m1 = document.getElementById('crBowMember1');
            if (m1) m1.style.display = count === 2 ? 'block' : 'none';
        }

        function submitCREnrollment(addAnother) {
            const cfg = events[selectedEvent];
            const members = [];
            
            // Collect all team members (use dynamic count for Ramp Walk)
            let crSubmitCount = cfg.dynamicCount ? (window._currentCREnrollCount || 1) : (cfg.maxCount ? (window._crDynMemberCount || cfg.count) : cfg.count);
            if (cfg.allowIndividual) {
                const crBowRadio = document.querySelector('input[name="crBowType"]:checked');
                crSubmitCount = (crBowRadio && crBowRadio.value === 'individual') ? 1 : 2;
            }
            for (let i = 0; i < crSubmitCount; i++) {
                const name = document.getElementById('crName'+i).value.trim();
                const phone = document.getElementById('crPhone'+i).value.trim();
                
                if (!name || !phone) { 
                    alert('Please fill all team member fields'); 
                    return; 
                }
                if (!/^\d{10}$/.test(phone)) { 
                    alert('Please enter valid 10-digit phone number for '+name); 
                    return; 
                }
                
                const role = cfg.role ? (i === 0 ? 'Captain' : 'Member') : 'Participant';
                members.push({name: name, phone: phone, role: role});
            }
            
            // Base data for all members
            const baseData = {
                classYear: crClass,
                event: selectedEvent,
                enrolledBy: 'CR',
                timestamp: Date.now()
            };
            
            // Add event-specific fields
            if (cfg.topic) {
                const topic = document.getElementById('crTopic');
                const topicVal = topic ? topic.value.trim() : '';
                if (!topicVal) {
                    alert(cfg.vlogTopics ? 'Please select a Vlog topic' : cfg.podcastTopics ? 'Please select a Podcast topic' : 'Please enter '+cfg.topicLabel);
                    return;
                }
                if (cfg.vlogTopics) {
                    const alreadyTaken = all.filter(e => e.event === selectedEvent && e.classYear === crClass && e.topic === topicVal).length > 0;
                    if (alreadyTaken) { alert('âš ï¸ This topic was just taken by another team! Please go back and select a different topic.'); return; }
                }
                baseData.topic = topicVal;
            }
            
            if (cfg.prod) {
                const product = document.getElementById('crProduct');
                if (!product || !product.value.trim()) {
                    alert('Please enter product name');
                    return;
                }
                baseData.product = product.value.trim();
            }
            
            if (cfg.cause) {
                const cause = document.getElementById('crCause');
                if (!cause || !cause.value.trim()) {
                    alert('Please enter '+(cfg.causeLabel || 'cause'));
                    return;
                }
                baseData.cause = cause.value.trim();
            }
            if (cfg.camera) {
                const camName = document.getElementById('crCameraName');
                const camPhone = document.getElementById('crCameraPhone');
                if (!camName || !camName.value.trim()) { alert('Please enter the camera person name'); return; }
                if (!camPhone || !/^\d{10}$/.test(camPhone.value.trim())) { alert('Please enter a valid 10-digit phone number for the camera person'); return; }
                baseData.cameraName = camName.value.trim();
                baseData.cameraPhone = camPhone.value.trim();
            }
            if (cfg.minCount && !cfg.maxCount && members.length < cfg.minCount) {
                alert('Minimum ' + cfg.minCount + ' members required for ' + selectedEvent);
                return;
            }
            
            if (cfg.lang) {
                const langs = ['English'];
                const kn = document.getElementById('crLangKn');
                const hi = document.getElementById('crLangHi');
                if (kn && kn.checked) langs.push('Kannada');
                if (hi && hi.checked) langs.push('Hindi');
                baseData.languages = langs.join(', ');
            }
            if (cfg.talent) {
                const talentSel = document.getElementById('crTalentType');
                const talentVal = talentSel ? talentSel.value.trim() : '';
                if (!talentVal) { alert('Please select a talent type'); return; }
                if (talentVal === 'Other') {
                    const otherVal = document.getElementById('crTalentOther') ? document.getElementById('crTalentOther').value.trim() : '';
                    if (!otherVal) { alert('Please specify your talent'); return; }
                    baseData.talentType = otherVal;
                } else {
                    baseData.talentType = talentVal;
                }
            }
            
            if (cfg.show) {
                const show = document.getElementById('crShowstopper');
                if (!show || !show.value.trim()) {
                    alert('Please enter showstopper name');
                    return;
                }
                baseData.showstopper = show.value.trim();
            }
            
            // For multiTeam events: assign shared teamNum so all members of this submission are grouped as one team
            if (cfg.multiTeam) {
                const sameEventEntries = all.filter(e => e.event === selectedEvent && e.classYear === crClass);
                // For allowIndividual events (e.g. BOW), count distinct existing teamNums to avoid miscalc
                const existingTeamNums = cfg.allowIndividual
                    ? new Set(sameEventEntries.map(e => e.teamNum).filter(n => n != null)).size
                    : Math.ceil(sameEventEntries.length / cfg.count);
                baseData.teamNum = existingTeamNums + 1;
            }

            // Submit all members
            const promises = members.map(m => {
                const data = {...baseData, name: m.name, phone: m.phone, role: m.role};
                return ref.push(data);
            });

            // Validate minCount before submitting
            if (cfg.minCount && members.length < cfg.minCount) {
                alert('Minimum ' + cfg.minCount + ' members required for ' + selectedEvent + '. Please add at least ' + cfg.minCount + ' members.');
                return;
            }

            Promise.all(promises).then(() => {
                const eventName = selectedEvent;
                if (addAnother) {
                    showCROk('âœ… Participant enrolled! Form ready for next participant.');
                    setTimeout(() => startCREnrollment(eventName), 400);
                } else {
                    showCROk('Successfully enrolled '+members.length+' student(s) for '+eventName+'!');
                    cancelCREnrollment();
                }
            }).catch(err => showCRErr('Error: '+err.message));
        }

        function cancelCREnrollment() {
            selectedEvent = null;
            document.getElementById('crEnrollmentForm').style.display = 'none';
            document.getElementById('crEventCardsContainer').style.display = 'grid';
            document.getElementById('crEventCardsContainer').scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        function showCRTab(tab) {
            document.querySelectorAll('#crSection .tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('#crSection .form-section').forEach(s => s.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById(tab).classList.add('active');
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // VLOG CHALLENGE â€” Phase 1: Link Submission (2 members, 2 teams max, Instagram only)
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // -- Vlog screenshot preview & remove --
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // VLOG: 2-SCREENSHOT SYSTEM
        // Screenshot 1: Day 1 of event (02-03-2026)
        // Screenshot 2: Last day of event (07-03-2026)
        // Chandan reads these screenshots and manually enters Views/Likes/Comments
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        const VLOG_SCREENSHOT_START = '2026-03-04';
        const VLOG_SCREENSHOT_END   = '2026-03-07';

        function initVlogDailyScreenshots() {
            const container = document.getElementById('vlogDailyScreenshotsContainer');
            if (!container) return;
            container.innerHTML = '';

            const today    = new Date();
            const startDt  = new Date('2026-02-01T00:00:00'); // always open for testing
            const endDt    = new Date('2026-02-01T00:00:00'); // always open for testing

            const slots = [
                {
                    iso   : VLOG_SCREENSHOT_START,
                    label : 'ðŸ“… Screenshot 1 â€” Start of Event (04 Mar 2026)',
                    hint  : 'Upload on or after 04-Mar-2026',
                    unlock: startDt
                },
                {
                    iso   : VLOG_SCREENSHOT_END,
                    label : 'ðŸ“… Screenshot 2 â€” End of Event (07 Mar 2026)',
                    hint  : 'Upload on or after 07-Mar-2026',
                    unlock: endDt
                }
            ];

            slots.forEach(slot => {
                const isFuture  = today < slot.unlock;
                const isToday   = today.toDateString() === slot.unlock.toDateString();
                const fileId    = 'vlogShotFile_'   + slot.iso;
                const previewId = 'vlogShotPrev_'   + slot.iso;
                const imgId     = 'vlogShotImg_'    + slot.iso;
                const nameId    = 'vlogShotName_'   + slot.iso;
                const statusId  = 'vlogShotStatus_' + slot.iso;
                const slotId    = 'vlogShot_'       + slot.iso;

                const borderColor = isToday ? '#9c27b0' : isFuture ? '#ddd' : '#a5d6a7';
                const bgColor     = isToday ? '#fdf5ff' : isFuture ? '#fafafa' : '#f1f8e9';
                const badge       = isToday
                    ? '<span style="background:#9c27b0;color:white;padding:2px 8px;border-radius:10px;font-size:0.72em;font-weight:700;margin-left:6px">TODAY</span>'
                    : isFuture
                        ? `<span style="background:#ccc;color:#555;padding:2px 8px;border-radius:10px;font-size:0.72em;font-weight:400;margin-left:6px">OPENS ${slot.hint}</span>`
                        : '<span style="background:#4caf50;color:white;padding:2px 8px;border-radius:10px;font-size:0.72em;font-weight:700;margin-left:6px">AVAILABLE</span>';
                const disabled    = isFuture ? 'disabled' : '';
                const disStyle    = isFuture ? 'opacity:0.5;cursor:not-allowed;' : '';

                container.insertAdjacentHTML('beforeend', `
                <div id="${slotId}" style="background:${bgColor};border:2px solid ${borderColor};border-radius:10px;padding:14px 16px;margin-bottom:4px">
                    <div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:6px;margin-bottom:10px">
                        <div style="font-size:0.87em;font-weight:700;color:#444">${slot.label}${badge}</div>
                        <div id="${statusId}" style="font-size:0.78em;font-weight:700;display:none;padding:3px 8px;border-radius:6px"></div>
                    </div>
                    <p style="font-size:0.76em;color:#777;margin:0 0 8px">
                        ðŸ“¸ Open your Reel â†’ tap <strong>â‹¯</strong> â†’ <strong>View Insights</strong> â†’ screenshot showing <strong>Views, Likes, Comments</strong>.<br>
                        Chandan (Social Monitor) will read this and enter the numbers to calculate your Social Score.
                    </p>
                    <div id="${previewId}" style="display:none;margin-bottom:8px">
                        <img id="${imgId}" src="" alt="Insight Screenshot" style="max-height:140px;max-width:100%;border-radius:8px;border:2px solid #ce93d8;object-fit:contain">
                        <button type="button" onclick="removeDailyShot('${slot.iso}')" style="display:inline-block;margin-top:5px;background:#f44336;color:white;border:none;border-radius:6px;padding:3px 12px;font-size:0.76em;cursor:pointer">âœ• Remove</button>
                    </div>
                    <div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap">
                        <input type="file" id="${fileId}" accept="image/*" onchange="previewDailyShot('${slot.iso}',this)" style="display:none" ${disabled}>
                        <button type="button" onclick="document.getElementById('${fileId}').click()"
                            style="background:#9c27b0;color:white;border:none;border-radius:8px;padding:8px 16px;font-size:0.84em;font-weight:700;cursor:pointer;${disStyle}" ${disabled}>
                            ðŸ“· Upload Screenshot
                        </button>
                        <span id="${nameId}" style="font-size:0.8em;color:#888">No file chosen</span>
                    </div>
                </div>`);
            });
        }

        function previewDailyShot(iso, input) {
            const file    = input.files[0];
            const nameEl  = document.getElementById('vlogShotName_'   + iso);
            const prevEl  = document.getElementById('vlogShotPrev_'   + iso);
            const imgEl   = document.getElementById('vlogShotImg_'    + iso);
            if (!file) return;
            if (nameEl) nameEl.textContent = file.name;
            const reader = new FileReader();
            reader.onload = e => {
                if (imgEl)  imgEl.src = e.target.result;
                if (prevEl) prevEl.style.display = 'block';
            };
            reader.readAsDataURL(file);
        }

        function removeDailyShot(iso) {
            const fileEl  = document.getElementById('vlogShotFile_'   + iso);
            const prevEl  = document.getElementById('vlogShotPrev_'   + iso);
            const nameEl  = document.getElementById('vlogShotName_'   + iso);
            const imgEl   = document.getElementById('vlogShotImg_'    + iso);
            if (fileEl)  fileEl.value = '';
            if (prevEl)  prevEl.style.display = 'none';
            if (imgEl)   imgEl.src = '';
            if (nameEl)  nameEl.textContent = 'No file chosen';
        }

        async function uploadDailyShot(iso) {
            const fileEl   = document.getElementById('vlogShotFile_'   + iso);
            const statusEl = document.getElementById('vlogShotStatus_' + iso);
            if (!fileEl || !fileEl.files[0]) return null;

            function setS(msg, ok) {
                if (!statusEl) return;
                statusEl.style.display    = 'block';
                statusEl.style.background = ok ? '#d4edda' : ok === false ? '#f8d7da' : '#fff3cd';
                statusEl.style.color      = ok ? '#155724' : ok === false ? '#721c24' : '#856404';
                statusEl.style.border     = ok ? '1px solid #c3e6cb' : ok === false ? '1px solid #f5c6cb' : '1px solid #ffc107';
                statusEl.textContent = msg;
            }

            setS('â³ Uploadingâ€¦', null);
            const formData = new FormData();
            formData.append('file', fileEl.files[0]);
            formData.append('upload_preset', 'scavenger_hunt');
            formData.append('folder', 'vlog_insights/' + iso);
            try {
                const res  = await fetch('https://api.cloudinary.com/v1_1/dat0khbet/image/upload', { method:'POST', body:formData });
                const data = await res.json();
                if (data.secure_url) { setS('âœ… Uploaded!', true); return { url: data.secure_url, date: iso }; }
                else { setS('âš ï¸ Upload failed â€” skipped.', null); return null; }
            } catch(e) {
                setS('âš ï¸ Upload error â€” skipped.', null); return null;
            }
        }

        async function uploadAllDailyShots() {
            const start  = new Date(VLOG_SCREENSHOT_START + 'T00:00:00');
            const end    = new Date(VLOG_SCREENSHOT_END   + 'T23:59:59');
            const dayMs  = 86400000;
            const results = {};
            for (let d = new Date(start); d <= end; d = new Date(d.getTime() + dayMs)) {
                const iso  = d.toISOString().slice(0, 10);
                const fileEl = document.getElementById('vlogShotFile_' + iso);
                if (fileEl && fileEl.files[0]) {
                    const r = await uploadDailyShot(iso);
                    if (r) results[iso.replace(/-/g,'_')] = r.url;
                }
            }
            return results; // { '2026_03_02': 'https://...', ... }
        }

        // -- Separate screenshot-only submission (called after reel link submit) --
        async function submitVlogScreenshotsOnly() {
            const msgEl = document.getElementById('vlogScreenshotSubmitMsg');
            const btnEl = document.getElementById('vlogScreenshotSubmitBtn');
            const cls   = (window.currentCRClass || crClass || '').trim();

            function showShotMsg(text, ok) {
                if (!msgEl) return;
                msgEl.style.display    = 'block';
                msgEl.style.background = ok ? '#d4edda' : '#f8d7da';
                msgEl.style.color      = ok ? '#155724' : '#721c24';
                msgEl.style.border     = ok ? '1px solid #c3e6cb' : '1px solid #f5c6cb';
                msgEl.textContent = text;
            }

            if (!cls) { showShotMsg('âŒ Class info missing. Please re-login.', false); return; }

            btnEl.disabled = true;
            btnEl.textContent = 'â³ Uploading screenshotsâ€¦';

            try {
                const dailyScreenshots = await uploadAllDailyShots();
                if (!Object.keys(dailyScreenshots).length) {
                    showShotMsg('âš ï¸ No screenshots selected. Please choose at least one screenshot to upload.', false);
                    return;
                }

                // Find the team entry for this CR's class and update it with screenshot data
                const snap = await db.ref('vlogChallenge').orderByChild('classYear').equalTo(cls).once('value');
                let updated = 0;
                const updates = {};
                snap.forEach(ch => {
                    const today = new Date().toISOString().slice(0,10);
                    const todayKey = today.replace(/-/g,'_');
                    const existing = ch.val().dailyScreenshots || {};
                    Object.assign(existing, dailyScreenshots);
                    updates['vlogChallenge/' + ch.key + '/dailyScreenshots'] = existing;
                    if (dailyScreenshots[todayKey]) {
                        updates['vlogChallenge/' + ch.key + '/screenshotUrl'] = dailyScreenshots[todayKey];
                    }
                    updated++;
                });

                if (!updated) {
                    showShotMsg('âŒ No submitted team found for your class. Please submit the Reel Link first.', false);
                    return;
                }

                await db.ref().update(updates);
                showShotMsg('âœ… Insight screenshots uploaded successfully! Admin will review and update your Social Score.', true);
            } catch(err) {
                showShotMsg('âŒ Error: ' + err.message, false);
            } finally {
                btnEl.disabled = false;
                btnEl.textContent = 'ðŸ“¸ Submit Insight Screenshots';
            }
        }

        function previewVlogScreenshot(input) {
            // Legacy single-screenshot â€” kept for backward compat but not used in new form
            const file = input.files[0];
            if (!file) return;
            const nameEl = document.getElementById('vlogScreenshotFileName');
            if (nameEl) nameEl.textContent = file.name;
            const reader = new FileReader();
            reader.onload = (e) => {
                const img = document.getElementById('vlogScreenshotImg');
                const prev = document.getElementById('vlogScreenshotPreview');
                if (img) img.src = e.target.result;
                if (prev) prev.style.display = 'block';
            };
            reader.readAsDataURL(file);
        }

        function removeVlogScreenshot() {
            const fileEl = document.getElementById('vlogScreenshotFile');
            const prev   = document.getElementById('vlogScreenshotPreview');
            const nameEl = document.getElementById('vlogScreenshotFileName');
            const img    = document.getElementById('vlogScreenshotImg');
            if (fileEl) fileEl.value = '';
            if (prev)   prev.style.display = 'none';
            if (img)    img.src = '';
            if (nameEl) nameEl.textContent = 'No file chosen';
        }

        async function uploadVlogScreenshot() {
            // Legacy single upload â€” delegates to daily system; uploads today's slot if filled
            const today   = new Date().toISOString().slice(0,10);
            const fileEl  = document.getElementById('vlogShotFile_' + today);
            const statusEl = document.getElementById('vlogScreenshotUploadStatus'); // may not exist now
            if (fileEl && fileEl.files[0]) {
                const r = await uploadDailyShot(today);
                return r ? r.url : null;
            }
            return null;
        }

        async function submitVlogEntry() {
            const member1 = (document.getElementById('vlogMember1').value || '').trim();
            const member2 = (document.getElementById('vlogMember2').value || '').trim();
            const topic   = (document.getElementById('vlogTopic').value || '').trim();
            const handle  = (document.getElementById('vlogHandle').value || '').trim();
            const link    = (document.getElementById('vlogLink').value || '').trim();
            const title   = (document.getElementById('vlogTitle').value || '').trim();
            const cls     = (window.currentCRClass || crClass || '').trim();
            const msgEl   = document.getElementById('vlogSubmitMsg');
            const btnEl   = document.getElementById('vlogSubmitBtn');

            function showMsg(text, ok) {
                msgEl.style.display = 'block';
                msgEl.style.background = ok ? '#d4edda' : '#f8d7da';
                msgEl.style.color      = ok ? '#155724' : '#721c24';
                msgEl.style.border     = ok ? '1px solid #c3e6cb' : '1px solid #f5c6cb';
                msgEl.textContent = text;
            }

            if (!member1)  { showMsg('âŒ Please select your team first.', false); return; }
            if (!member2)  { showMsg('âŒ Member 2 name missing. Please re-select your team.', false); return; }
            if (!topic)    { showMsg('âŒ Topic missing. Please re-select your team.', false); return; }
            if (!handle)   { showMsg('âŒ Please enter the Instagram handle.', false); return; }
            if (!link)     { showMsg('âŒ Please enter the Instagram Reel link.', false); return; }
            if (!title)    { showMsg('âŒ Please enter the Reel title/caption.', false); return; }
            if (!link.includes('instagram.com')) { showMsg('âŒ Link must be an Instagram URL (instagram.com).', false); return; }
            if (!cls)      { showMsg('âŒ Class info missing. Please re-login.', false); return; }

            btnEl.disabled = true;
            btnEl.textContent = 'â³ Checking slotsâ€¦';

            // (Screenshots are submitted separately after reel link submission)

            try {
                const snap = await db.ref('vlogChallenge').orderByChild('classYear').equalTo(cls).once('value');
                const existing = [];
                if (snap.exists()) snap.forEach(ch => existing.push(ch.val()));

                if (existing.length >= 2) {
                    showMsg('âŒ Your class already has 2 teams registered. No more slots available.', false);
                    return;
                }

                // Note: two teams from same class may share a topic â€” no topic uniqueness check needed

                const hashtag = document.getElementById('vlogHashtagDisplay').textContent || '#SpurthiVlogChallenge2026';
                const entry = {
                    member1         : member1,
                    member2         : member2,
                    members         : member1 + ' & ' + member2,
                    topic           : topic,
                    handle          : handle,
                    link            : link,
                    title           : title,
                    classYear       : cls,
                    status          : 'Pending Review',
                    hashtag         : hashtag,
                    socialScore     : 0,
                    juryScore       : null,
                    finalScore      : null,
                    screenshotUrl       : null,
                    dailyScreenshots    : null,
                    submittedAt     : new Date().toISOString(),
                    submittedBy     : 'CR'
                };

                btnEl.textContent = 'â³ Savingâ€¦';
                await db.ref('vlogChallenge').push(entry);
                showMsg('âœ… Team submitted! ' + member1 + ' & ' + member2 + ' â€” "' + topic + '" registered successfully. Now upload your daily Insight screenshots below â¬‡ï¸', true);
                // Show submitted date/time
                const now = new Date();
                const fmted = now.toLocaleDateString('en-IN', {day:'2-digit',month:'short',year:'numeric'}) + ' at ' + now.toLocaleTimeString('en-IN', {hour:'2-digit',minute:'2-digit'});
                const vlogInfoEl = document.getElementById('vlogSubmittedInfo');
                const vlogDtEl = document.getElementById('vlogSubmittedDateTime');
                if (vlogInfoEl) vlogInfoEl.style.display = 'block';
                if (vlogDtEl) vlogDtEl.textContent = fmted;
                clearVlogForm();
                loadVlogSubmissions();
                // Reveal the separate screenshot section and build its slots
                const shotSection = document.getElementById('vlogInsightScreenshotSection');
                if (shotSection) {
                    shotSection.style.display = 'block';
                    initVlogDailyScreenshots(); // populate screenshot date slots
                    shotSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
            } catch(err) {
                showMsg('âŒ Error: ' + err.message, false);
            } finally {
                btnEl.disabled = false;
                btnEl.textContent = 'ðŸ“¤ Submit Instagram Reel Link';
            }
        }

        function clearVlogForm() {
            ['vlogMember1','vlogMember2','vlogLink','vlogTitle','vlogHandle'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.value = '';
            });
            const tp = document.getElementById('vlogTopic');
            if (tp) tp.value = '';
            const msg = document.getElementById('vlogSubmitMsg');
            if (msg) msg.style.display = 'none';
            // Reset screenshot
            removeVlogScreenshot();
            const statusEl = document.getElementById('vlogScreenshotUploadStatus');
            if (statusEl) statusEl.style.display = 'none';
            // Reset team selector
            const sel = document.getElementById('vlogTeamSelect');
            if (sel) sel.value = '';
            const disp = document.getElementById('vlogSelectedTeamDisplay');
            if (disp) disp.style.display = 'none';
        }

        function enableVlogEdit() {
            ['vlogLink','vlogTitle','vlogHandle'].forEach(id => {
                const el = document.getElementById(id);
                if (el) { el.removeAttribute('readonly'); el.style.background=''; el.style.borderColor='#833ab4'; }
            });
            const submitBtn = document.getElementById('vlogSubmitBtn');
            if (submitBtn) { submitBtn.textContent = 'ðŸ“¤ Update Reel Link'; submitBtn.disabled = false; }
            const msg = document.getElementById('vlogSubmitMsg');
            if (msg) { msg.style.display='block'; msg.style.background='#f3e5f5'; msg.style.color='#4a148c'; msg.style.border='1px solid #ce93d8'; msg.textContent='âœï¸ You can now edit the fields. Click "Update Reel Link" when done.'; }
        }

        function enablePodcastEdit() {
            ['podcastLink','podcastTitle','podcastDuration'].forEach(id => {
                const el = document.getElementById(id);
                if (el) { el.removeAttribute('readonly'); el.style.background=''; el.style.borderColor='#1db954'; }
            });
            const submitBtn = document.getElementById('podcastSubmitBtn');
            if (submitBtn) { submitBtn.textContent = 'ðŸŽ™ï¸ Update Podcast Link'; submitBtn.disabled = false; }
            const msg = document.getElementById('podcastSubmitMsg');
            if (msg) { msg.style.display='block'; msg.style.background='#e8f5e9'; msg.style.color='#1b5e20'; msg.style.border='1px solid #a5d6a7'; msg.textContent='âœï¸ You can now edit the fields. Click "Update Podcast Link" when done.'; }
        }

        function loadVlogSubmissions() {
            const cls = (window.currentCRClass || crClass || '').trim();
            const lbl = document.getElementById('vlogCRClass');
            if (lbl) lbl.textContent = cls;
            if (!cls) return;

            db.ref('vlogChallenge').orderByChild('classYear').equalTo(cls).once('value').then(snap => {
                const entries = [];
                if (snap.exists()) snap.forEach(ch => entries.push({ id: ch.key, ...ch.val() }));
                entries.sort((a, b) => new Date(a.submittedAt) - new Date(b.submittedAt));

                const badge     = document.getElementById('vlogCountBadge');
                const empty     = document.getElementById('vlogEmptyMsg');
                const container = document.getElementById('vlogTableContainer');
                const tbody     = document.getElementById('vlogTableBody');
                const slotsInfo = document.getElementById('vlogTeamSlotsInfo');
                const topicSel  = document.getElementById('vlogTopic');

                const usedSlots = entries.length;
                if (badge) badge.textContent = usedSlots + ' / 2 slots used';

                // Update slots info banner
                if (slotsInfo) {
                    if (usedSlots >= 2) {
                        slotsInfo.style.background = '#fce4ec';
                        slotsInfo.style.borderLeftColor = '#e91e63';
                        slotsInfo.style.color = '#880e4f';
                        slotsInfo.textContent = 'ðŸš« Both team slots are full for your class. No more submissions allowed.';
                        const btn = document.getElementById('vlogSubmitBtn');
                        if (btn) { btn.disabled = true; btn.style.opacity = '0.5'; }
                    } else {
                        slotsInfo.style.background = '#e8f5e9';
                        slotsInfo.style.borderLeftColor = '#4caf50';
                        slotsInfo.style.color = '#1b5e20';
                        slotsInfo.textContent = 'âœ… ' + (2 - usedSlots) + ' team slot(s) remaining for your class.';
                        const btn = document.getElementById('vlogSubmitBtn');
                        if (btn) { btn.disabled = false; btn.style.opacity = '1'; }
                    }
                }

                // Grey out taken topics in dropdown
                if (topicSel) {
                    const takenTopics = entries.map(e => e.topic);
                    Array.from(topicSel.options).forEach(opt => {
                        if (opt.value && takenTopics.includes(opt.value)) {
                            opt.disabled = true;
                            opt.textContent = opt.textContent.replace(' âœ… Taken', '') + ' âœ… Taken';
                            opt.style.color = '#aaa';
                        } else if (opt.value) {
                            opt.disabled = false;
                            opt.textContent = opt.textContent.replace(' âœ… Taken', '');
                            opt.style.color = '';
                        }
                    });
                }

                if (entries.length === 0) {
                    if (empty) empty.style.display = 'block';
                    if (container) container.style.display = 'none';
                    return;
                }
                if (empty) empty.style.display = 'none';
                if (container) container.style.display = 'block';

                // If team(s) already submitted, reveal the separate screenshot section
                const shotSection = document.getElementById('vlogInsightScreenshotSection');
                if (shotSection) {
                    shotSection.style.display = 'block';
                    initVlogDailyScreenshots(); // populate screenshot date slots
                }

                const VLOG_MAX_SOCIAL = 1000; // adjust when API is live
                let rows = '';
                entries.forEach((e, i) => {
                    const statusColor = e.status === 'Approved' ? '#155724' : e.status === 'Rejected' ? '#721c24' : '#856404';
                    const statusBg    = e.status === 'Approved' ? '#d4edda'  : e.status === 'Rejected' ? '#f8d7da'  : '#fff3cd';
                    const dt = e.submittedAt ? new Date(e.submittedAt).toLocaleString('en-IN', { day:'2-digit', month:'short', hour:'2-digit', minute:'2-digit' }) : 'â€”';
                    const socialStr = (e.socialScore != null && e.socialScore > 0) ? e.socialScore : 'â€”';
                    const juryStr   = (e.juryScore   != null) ? e.juryScore + '/100' : 'â€”';
                    const finalStr  = (e.finalScore  != null) ? '<strong>' + e.finalScore + '</strong>' : 'â€”';
                    rows += `<tr>
                        <td style="text-align:center;font-weight:700;color:#833ab4">${i+1}</td>
                        <td style="font-size:0.85em"><strong>${e.member1||'â€”'}</strong><br><span style="color:#888">${e.member2||''}</span></td>
                        <td style="font-size:0.82em;font-weight:600;color:#4a148c">${e.topic||'â€”'}</td>
                        <td style="text-align:center"><a href="${e.link}" target="_blank" rel="noopener" style="color:#e91e63;font-size:0.85em;text-decoration:none;font-weight:600">ðŸ“¸ Reel</a></td>
                        <td style="font-size:0.82em;color:#777">${e.handle||'â€”'}</td>
                        <td style="text-align:center;font-size:0.85em">${socialStr}</td>
                        <td style="text-align:center;font-size:0.85em">${juryStr}</td>
                        <td style="text-align:center"><span style="background:${statusBg};color:${statusColor};padding:3px 10px;border-radius:12px;font-size:0.75em;font-weight:700">${e.status||'Pending'}</span></td>
                        <td style="font-size:0.78em;color:#666">${dt}</td>
                    </tr>`;
                });
                if (tbody) tbody.innerHTML = rows;
            }).catch(err => console.error('Vlog load error:', err));
        }
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // END VLOG CHALLENGE
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // VLOG: LOAD ENROLLED TEAMS & DRIVE TEAM SELECTOR
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        let vlogEnrolledTeams = [];

        async function autoFillVlogMembers() {
            const cls = (window.currentCRClass || crClass || '').trim();
            const listEl   = document.getElementById('vlogEnrolledTeamsList');
            const selectEl = document.getElementById('vlogTeamSelect');

            if (!cls) {
                if (listEl) listEl.innerHTML = '<span style="color:#c62828">âš ï¸ Class not detected. Please log in again.</span>';
                return;
            }

            if (listEl) listEl.innerHTML = '<span style="color:#666">ðŸ”„ Loading teamsâ€¦</span>';
            if (selectEl) selectEl.innerHTML = '<option value="">â€” Loadingâ€¦ â€”</option>';

            try {
                // Load Vlog enrollments for this class â€” filter client-side, no index required
                const enrollSnap = await db.ref('youthfest-enrollments').once('value');
                const memberRecords = [];
                if (enrollSnap.exists()) {
                    enrollSnap.forEach(ch => {
                        const d = ch.val();
                        if (d.event === 'Vlog' && (d.classYear || d.class || '').trim() === cls) {
                            memberRecords.push(d);
                        }
                    });
                }

                vlogEnrolledTeams = [];

                if (memberRecords.length === 0) {
                    if (listEl) listEl.innerHTML = '<span style="color:#c62828">âš ï¸ No Vlog enrollment found for your class. Please enroll in the Vlog event first.</span>';
                    if (selectEl) selectEl.innerHTML = '<option value="">â€” No enrolled teams found â€”</option>';
                    return;
                }

                // Pair members strictly in sequential groups of 2 â€” max 2 teams
                // NOTE: teamNum is assigned per-individual in enrollment (not per team), so we ignore it
                for (let i = 0; i < memberRecords.length && vlogEnrolledTeams.length < 2; i += 2) {
                    const pair = memberRecords.slice(i, i + 2);
                    vlogEnrolledTeams.push({
                        ...pair[0],
                        _allMembers: pair,
                        topic: pair[0].topic || ''
                    });
                }

                if (!listEl || !selectEl) return;

                // Render team cards
                listEl.innerHTML = vlogEnrolledTeams.map((enr, i) => {
                    const names = extractVlogNames(enr);
                    const topic = enr.topic || 'â€”';
                    return `<div style="padding:8px 0;${i < vlogEnrolledTeams.length - 1 ? 'border-bottom:1px solid #e1bee7;' : ''}display:flex;align-items:center;gap:10px;flex-wrap:wrap">
                        <span style="background:#e8eaf6;border-radius:20px;padding:2px 10px;font-size:0.82em;color:#3949ab;font-weight:700">Team ${i + 1}</span>
                        <span style="font-weight:600;color:#222;font-size:0.88em">${names.join(' &amp; ')}</span>
                        <span style="color:#9c27b0;font-size:0.82em">ðŸ“Œ ${topic}</span>
                    </div>`;
                }).join('');
                listEl.style.color = '';

                // Populate dropdown
                selectEl.innerHTML = '<option value="">â€” Select your team from enrollment â€”</option>';
                vlogEnrolledTeams.forEach((enr, i) => {
                    const names = extractVlogNames(enr);
                    const topic = enr.topic || '';
                    const opt = document.createElement('option');
                    opt.value = i;
                    opt.textContent = `Team ${i + 1}: ${names.join(' & ')}${topic ? ' Â· ' + topic : ''}`;
                    selectEl.appendChild(opt);
                });

                // Auto-select if only one team
                if (vlogEnrolledTeams.length === 1) {
                    selectEl.value = 0;
                    vlogOnTeamSelect();
                }

            } catch (err) {
                console.error('autoFillVlogMembers error:', err);
                if (listEl) listEl.innerHTML = `<span style="color:#c62828">âš ï¸ Error: ${err.message} â€” click ðŸ”„ Refresh to retry.</span>`;
                if (selectEl) selectEl.innerHTML = '<option value="">â€” Error loading teams â€”</option>';
            }
        }

        function extractVlogNames(enr) {
            const names = [];
            // If grouped team record, extract names from all member records
            if (enr._allMembers && Array.isArray(enr._allMembers)) {
                enr._allMembers.forEach(m => {
                    const t = (m.name || '').trim();
                    if (t && !names.includes(t)) names.push(t);
                });
                return names;
            }
            ['member1','member2','name'].forEach(k => {
                if (enr[k]) String(enr[k]).split(',').forEach(n => {
                    const t = n.trim();
                    if (t && !names.includes(t) && names.length < 2) names.push(t);
                });
            });
            if (enr.members && Array.isArray(enr.members)) {
                enr.members.forEach(m => {
                    const t = (m.name || m || '').trim();
                    if (t && !names.includes(t) && names.length < 2) names.push(t);
                });
            }
            return names;
        }

        function vlogOnTeamSelect() {
            const selectEl = document.getElementById('vlogTeamSelect');
            const dispEl   = document.getElementById('vlogSelectedTeamDisplay');
            const infoEl   = document.getElementById('vlogSelectedTeamInfo');
            const val      = selectEl ? selectEl.value : '';
            const idx      = val !== '' ? parseInt(val) : NaN;

            if (isNaN(idx) || !vlogEnrolledTeams[idx]) {
                if (dispEl) dispEl.style.display = 'none';
                document.getElementById('vlogMember1').value = '';
                document.getElementById('vlogMember2').value = '';
                document.getElementById('vlogTopic').value   = '';
                return;
            }

            const enr   = vlogEnrolledTeams[idx];
            const names = extractVlogNames(enr);
            const topic = enr.topic || enr.Theme || '';

            document.getElementById('vlogMember1').value = names[0] || '';
            document.getElementById('vlogMember2').value = names[1] || '';
            document.getElementById('vlogTopic').value   = topic;

            if (enr.instagramHandle) {
                const hEl = document.getElementById('vlogHandle');
                if (hEl && !hEl.value) hEl.value = enr.instagramHandle;
            }

            if (dispEl) dispEl.style.display = 'block';
            if (infoEl) infoEl.innerHTML = `<strong>${names.join(' & ')}</strong>${topic ? ' &nbsp;Â·&nbsp; ðŸ“Œ ' + topic : ''}`;
        }


        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // VLOG ADMIN: SETTINGS (Super Admin)
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        const VLOG_SETTINGS_KEYS = ['eventActive', 'monitoringVisible', 'leaderboardPublished'];
        const VLOG_SETTINGS_LABELS = {
            eventActive:          { on: 'âœ… ACTIVE â€” CRs can submit', off: 'ðŸ”’ INACTIVE â€” Submissions locked' },
            monitoringVisible:    { on: 'ðŸ‘ VISIBLE â€” CRs see tracking', off: 'ðŸ™ˆ HIDDEN â€” CRs cannot see tracking' },
            leaderboardPublished: { on: 'ðŸš€ PUBLISHED â€” Visible in results', off: 'ðŸ“¦ UNPUBLISHED â€” Hidden from results' }
        };

        function setVlogSetting(key, value) {
            db.ref('vlogSettings/' + key).set(value).then(() => {
                loadVlogSettings();
                alert('âœ… Vlog setting updated: ' + key + ' = ' + value);
            }).catch(e => alert('Error: ' + e.message));
        }

        function saveVlogHashtag() {
            const val = (document.getElementById('vlogHashtagInput').value || '').trim();
            if (!val) { alert('Please enter a hashtag'); return; }
            const tag = val.startsWith('#') ? val : '#' + val;
            db.ref('vlogSettings/hashtag').set(tag).then(() => {
                loadVlogSettings();
                alert('âœ… Hashtag saved: ' + tag);
            }).catch(e => alert('Error: ' + e.message));
        }

        function loadVlogSettings() {
            db.ref('vlogSettings').once('value').then(snap => {
                const s = snap.val() || {};
                VLOG_SETTINGS_KEYS.forEach(key => {
                    const el = document.getElementById('vlogStatus' + key.charAt(0).toUpperCase() + key.slice(1));
                    if (el) {
                        const on = s[key] === true;
                        const labels = VLOG_SETTINGS_LABELS[key];
                        el.textContent = on ? labels.on : labels.off;
                        el.style.color = on ? '#1b5e20' : '#c62828';
                    }
                });
                // Update hashtag display everywhere
                const tag = s.hashtag || '#SpurthiVlogChallenge2026';
                ['vlogHashtagDisplay','vlogHashtagInForm'].forEach(id => {
                    const el = document.getElementById(id); if (el) el.textContent = tag;
                });
                const inp = document.getElementById('vlogHashtagInput');
                if (inp && !inp.value) inp.value = tag;
                const statusEl = document.getElementById('vlogStatusHashtag');
                if (statusEl) statusEl.textContent = 'Current: ' + tag;
            });
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // VLOG ADMIN: LOAD ALL SUBMISSIONS (Super Admin panel)
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        async function loadVlogAdminPanel() {
            if (!isSuperAdmin && !isAdmin) return;
            loadVlogSettings();
            loadSocialFormula();

            const classFilter = (document.getElementById('vlogAdminClassFilter') || {}).value || '';
            const snap = await db.ref('vlogChallenge').once('value');
            const all = [];
            if (snap.exists()) snap.forEach(ch => all.push({ id: ch.key, ...ch.val() }));

            // Populate class filter
            const clsSel = document.getElementById('vlogAdminClassFilter');
            if (clsSel && clsSel.options.length <= 1) {
                const classes = [...new Set(all.map(e => e.classYear).filter(Boolean))].sort();
                classes.forEach(c => {
                    const opt = document.createElement('option'); opt.value = c; opt.textContent = c; clsSel.appendChild(opt);
                });
            }

            const filtered = classFilter ? all.filter(e => e.classYear === classFilter) : all;
            filtered.sort((a, b) => (a.classYear || '').localeCompare(b.classYear || ''));

            const empty = document.getElementById('vlogAdminEmpty');
            const container = document.getElementById('vlogAdminTableContainer');
            const tbody = document.getElementById('vlogAdminTableBody');
            if (filtered.length === 0) {
                if (empty) empty.style.display = 'block';
                if (container) container.style.display = 'none';
                return;
            }
            if (empty) empty.style.display = 'none';
            if (container) container.style.display = 'block';

            let rows = '';
            filtered.forEach((e, i) => {
                const j1Total = e.juryScores && e.juryScores.j1 ? Object.values(e.juryScores.j1).reduce((s,v)=>s+(+v||0),0) : null;
                const j2Total = e.juryScores && e.juryScores.j2 ? Object.values(e.juryScores.j2).reduce((s,v)=>s+(+v||0),0) : null;
                const juryAvg = (j1Total !== null && j2Total !== null) ? ((j1Total + j2Total) / 2).toFixed(1) : (j1Total !== null ? j1Total : (j2Total !== null ? j2Total : null));
                const juryPct = juryAvg !== null ? ((+juryAvg / 50) * 50).toFixed(1) : null;
                const socialPct = e.socialScore > 0 ? ((e.socialScore / 1000) * 50).toFixed(1) : 0;
                const finalPct = juryPct !== null ? ((+juryPct + +socialPct)).toFixed(1) : 'â€”';
                const statusColor = e.status === 'Approved' ? '#155724' : e.status === 'Rejected' ? '#721c24' : '#856404';
                const statusBg    = e.status === 'Approved' ? '#d4edda'  : e.status === 'Rejected' ? '#f8d7da'  : '#fff3cd';

                // Screenshot cell
                const screenshotCell = e.screenshotUrl
                    ? `<a href="${e.screenshotUrl}" target="_blank" rel="noopener" title="View insight screenshot">
                           <img src="${e.screenshotUrl}" style="width:48px;height:48px;object-fit:cover;border-radius:6px;border:2px solid #ce93d8;cursor:pointer" alt="Insight">
                       </a>`
                    : '<span style="color:#ccc;font-size:0.8em">â€”</span>';

                // Social score: input + save button
                const socialCell = `<div style="display:flex;align-items:center;gap:4px;flex-direction:column">
                    <div style="display:flex;gap:4px;align-items:center">
                        <input type="number" min="0" id="socialInp_${e.id}" value="${e.socialScore || ''}" placeholder="0"
                               style="width:60px;padding:4px 6px;border:2px solid #e91e63;border-radius:6px;font-size:0.85em;text-align:center;outline:none">
                        <button onclick="saveSocialScore('${e.id}')" style="background:#e91e63;color:white;border:none;border-radius:6px;padding:4px 8px;cursor:pointer;font-size:0.75em;font-weight:700">ðŸ’¾</button>
                    </div>
                    ${e.socialScore > 0 ? '<span style="font-size:0.72em;color:#999">('+socialPct+'%)</span>' : ''}
                </div>`;

                rows += `<tr>
                    <td style="text-align:center;font-weight:700;color:#833ab4">${i+1}</td>
                    <td style="font-weight:700;color:#1565c0;font-size:0.85em">${e.classYear||'â€”'}</td>
                    <td style="font-size:0.82em"><strong>${e.member1||'â€”'}</strong><br>${e.member2||''}</td>
                    <td style="font-size:0.82em;color:#4a148c;font-weight:600">${e.topic||'â€”'}</td>
                    <td style="text-align:center"><a href="${e.link||'#'}" target="_blank" rel="noopener" style="color:#e91e63;font-weight:700;font-size:0.85em;text-decoration:none">ðŸ“¸ Reel</a></td>
                    <td style="text-align:center">${screenshotCell}</td>
                    <td style="font-size:0.8em;color:#777">${e.handle||'â€”'}</td>
                    <td style="text-align:center">${socialCell}</td>
                    <td style="text-align:center;font-size:0.85em">${j1Total !== null ? j1Total + '/50' : 'â€”'}</td>
                    <td style="text-align:center;font-size:0.85em">${j2Total !== null ? j2Total + '/50' : 'â€”'}</td>
                    <td style="text-align:center;font-weight:800;font-size:0.95em;color:${finalPct !== 'â€”' ? '#1b5e20' : '#aaa'}">${finalPct !== 'â€”' ? finalPct + '%' : 'â€”'}</td>
                    <td style="text-align:center"><span style="background:${statusBg};color:${statusColor};padding:3px 10px;border-radius:12px;font-size:0.75em;font-weight:700">${e.status||'Pending'}</span></td>
                    <td style="text-align:center">
                        <button onclick="approveVlogEntry('${e.id}')" style="background:#28a745;color:white;border:none;border-radius:6px;padding:4px 8px;cursor:pointer;font-size:0.75em;margin:2px">âœ…</button>
                        <button onclick="rejectVlogEntry('${e.id}')" style="background:#dc3545;color:white;border:none;border-radius:6px;padding:4px 8px;cursor:pointer;font-size:0.75em;margin:2px">âŒ</button>
                    </td>
                </tr>`;
            });
            if (tbody) tbody.innerHTML = rows;
        }

        function approveVlogEntry(id) {
            db.ref('vlogChallenge/' + id + '/status').set('Approved').then(() => { loadVlogAdminPanel(); });
        }
        function rejectVlogEntry(id) {
            db.ref('vlogChallenge/' + id + '/status').set('Rejected').then(() => { loadVlogAdminPanel(); });
        }
        function saveSocialScore(id) {
            const inp = document.getElementById('socialInp_' + id);
            if (!inp) return;
            const val = parseInt(inp.value) || 0;
            if (val < 0) { alert('Score cannot be negative'); return; }
            db.ref('vlogChallenge/' + id + '/socialScore').set(val).then(() => {
                inp.style.borderColor = '#4caf50';
                setTimeout(() => { inp.style.borderColor = '#e91e63'; loadVlogAdminPanel(); }, 1000);
            }).catch(e => alert('Error saving score: ' + e.message));
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // YOUTUBE ADVERTISEMENT â€” All Functions
        // Firebase path: youtubeAd/
        // Eligible classes: '1ST BCA' and '2ND BCA A SEC'
        // Scoring: 50% Social (Views+Likes+OrigComments) + 50% Jury (J1+J2 avg)
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

        const YT_AD_ELIGIBLE = ['1ST BCA', '2ND BCA A SEC'];

        // -- Settings -------------------------------------------------
        function setYtAdSetting(key, value) {
            db.ref('youtubeAd/' + key).set(value).then(() => {
                const el = document.getElementById('ytAdStatus' + key.charAt(0).toUpperCase() + key.slice(1));
                if (el) el.textContent = 'âœ… ' + (value ? 'ON' : 'OFF') + ' â€” saved';
                loadYtAdSettings();
            }).catch(e => alert('Error: ' + e.message));
        }

        function loadYtAdSettings() {
            Promise.all([
                db.ref('youtubeAd/eventActive').once('value').catch(() => null),
                db.ref('youtubeAd/leaderboardPublished').once('value').catch(() => null)
            ]).then(([s1, s2]) => {
                const setEl = (id, text) => { const el = document.getElementById(id); if (el) el.textContent = text; };
                setEl('ytAdStatusEventActive',          (s1 && s1.val() === true) ? 'âœ… Active (submissions open)' : 'ðŸ”’ Not Active');
                setEl('ytAdStatusLeaderboardPublished', (s2 && s2.val() === true) ? 'ðŸš€ Published'               : 'ðŸ“¦ Not Published');
            }).catch(() => {});
        }

        // -- Social Formula Save/Load ----------------------------------
        async function saveYtAdFormula() {
            const formula = {
                weightViews:    parseFloat(document.getElementById('ytAdWeightViews').value)    || 1,
                weightLikes:    parseFloat(document.getElementById('ytAdWeightLikes').value)    || 3,
                weightComments: parseFloat(document.getElementById('ytAdWeightComments').value) || 5,
                maxRaw:         parseInt(document.getElementById('ytAdMaxRaw').value)           || 5000
            };
            try {
                await db.ref('youtubeAd/socialFormula').set(formula);
                const msg = document.getElementById('ytAdFormulaMsg');
                if (msg) { msg.style.display = 'inline'; msg.textContent = 'âœ… Formula saved!'; setTimeout(() => msg.style.display = 'none', 3000); }
            } catch(e) { alert('Error saving formula: ' + e.message); }
        }

        async function loadYtAdFormula() {
            try {
                const snap = await db.ref('youtubeAd/socialFormula').once('value');
                const f = snap.val() || {};
                const setVal = (id, v) => { const el = document.getElementById(id); if (el && v !== undefined) el.value = v; };
                setVal('ytAdWeightViews',    f.weightViews    !== undefined ? f.weightViews    : 1);
                setVal('ytAdWeightLikes',    f.weightLikes    !== undefined ? f.weightLikes    : 3);
                setVal('ytAdWeightComments', f.weightComments !== undefined ? f.weightComments : 5);
                setVal('ytAdMaxRaw',         f.maxRaw         !== undefined ? f.maxRaw         : 5000);
            } catch(e) {}
        }

        function calcYtAdSocialScore(views, likes, comments, formula) {
            const w1 = formula.weightViews    || 1;
            const w2 = formula.weightLikes    || 3;
            const w3 = formula.weightComments || 5;
            const max = formula.maxRaw        || 5000;
            const raw = (views * w1) + (likes * w2) + (comments * w3);
            return Math.min(50, +(raw / max * 50).toFixed(2));
        }

        // -- CR: Check event active ------------------------------------
        async function checkYtAdEventActive() {
            const clsLabel = document.getElementById('ytAdCRClass');
            if (clsLabel) clsLabel.textContent = (window.currentCRClass || crClass || '').trim();

            const lockedEl = document.getElementById('ytAdLockedMsg');
            const formEl   = document.getElementById('ytAdSubmitFormWrapper');

            const showForm   = () => { if (lockedEl) lockedEl.style.display='none';  if (formEl) formEl.style.display='block'; autoFillYtAdMembers(); initYtAdScreenshots(); };
            const showLocked = () => { if (lockedEl) lockedEl.style.display='block'; if (formEl) formEl.style.display='none'; };

            try {
                const snap = await db.ref('youtubeAd/eventActive').once('value');
                const val  = snap.val();
                // Only lock if explicitly set to false â€” null/missing means open by default
                if (val === false) { showLocked(); } else { showForm(); }
            } catch(e) {
                showForm(); // on any error, don't block CRs
            }
        }

        // -- CR: Load members from enrollment -------------------------
        async function autoFillYtAdMembers() {
            const cls = (window.currentCRClass || crClass || '').trim();
            if (!cls) return;
            const listEl = document.getElementById('ytAdEnrolledList');
            if (listEl) listEl.textContent = 'Loading enrolled membersâ€¦';
            try {
                // Each CR enrollment saves one record per member with {name, classYear, event}
                const snap = await db.ref('youthfest-enrollments').once('value');
                const names = [];
                if (snap.exists()) snap.forEach(ch => {
                    const d = ch.val();
                    if (d.classYear === cls && d.event === 'YouTube Advertisement') {
                        const n = (d.name || '').trim();
                        if (n && !names.includes(n)) names.push(n);
                    }
                });

                // Fill hidden inputs
                for (let i = 1; i <= 8; i++) {
                    const inp = document.getElementById('ytAdMember' + i);
                    if (inp) inp.value = names[i-1] || '';
                }

                if (listEl) {
                    if (names.length === 0) {
                        listEl.innerHTML = '<span style="color:#e65100">âš ï¸ No members enrolled yet for YouTube Advertisement. Please enroll via the "Enroll Students" tab first.</span>';
                    } else {
                        listEl.innerHTML = '<strong style="color:#155724">âœ… ' + names.length + ' member(s) loaded:</strong> ' +
                            names.map((n,i) => `<span style="background:#fce4ec;border-radius:12px;padding:2px 8px;font-size:0.88em;margin:2px;display:inline-block">${i+1}. ${n}</span>`).join('');
                    }
                }

                // Check if already submitted â€” skip settings keys
                const subSnap = await db.ref('youtubeAd').once('value');
                let existingKey = null;
                if (subSnap.exists()) subSnap.forEach(ch => {
                    const d = ch.val();
                    if (d.classYear === cls) existingKey = ch.key;
                });

                const slotEl = document.getElementById('ytAdSlotInfo');
                const btnEl  = document.getElementById('ytAdSubmitBtn');
                const editBtn = document.getElementById('ytAdEditBtn');
                if (existingKey) {
                    if (slotEl) slotEl.innerHTML = 'âš ï¸ <strong>1 submission already exists</strong> for your class. You can update the link or upload screenshots below.';
                    if (btnEl)  { btnEl.textContent = 'ðŸ“º Update Submission'; btnEl.disabled = false; }
                    if (editBtn) editBtn.style.display = 'inline-flex';
                    // Show submitted date/time
                    const subData = subSnap.exists() ? (() => { let d=null; subSnap.forEach(ch => { if(ch.val().classYear===cls) d=ch.val(); }); return d; })() : null;
                    if (subData && subData.submittedAt) {
                        const dt = new Date(subData.submittedAt);
                        const fmted = dt.toLocaleDateString('en-IN', {day:'2-digit',month:'short',year:'numeric'}) + ' at ' + dt.toLocaleTimeString('en-IN', {hour:'2-digit',minute:'2-digit'});
                        const infoEl = document.getElementById('ytAdSubmittedInfo');
                        const dtEl = document.getElementById('ytAdSubmittedDateTime');
                        if (infoEl) infoEl.style.display = 'block';
                        if (dtEl) dtEl.textContent = fmted;
                    }
                } else {
                    if (slotEl) slotEl.innerHTML = 'âœ… <strong>No submission yet</strong> â€” 1 slot available for your class. Fill in the details below and click Submit.';
                    if (btnEl)  btnEl.textContent = 'ðŸ“º Submit YouTube Link';
                    if (editBtn) editBtn.style.display = 'inline-flex';
                }

                // Load existing screenshots if any
                if (existingKey) loadYtAdExistingScreenshots(existingKey);
            } catch(e) {
                const isPermission = e && e.message && e.message.includes('permission_denied');
                if (listEl) listEl.innerHTML = isPermission
                    ? '<span style="color:#c62828">ðŸ”’ Firebase permission error. Contact Super Admin.</span>'
                    : '<span style="color:#c62828">âŒ Error loading members: ' + e.message + '</span>';
            }
        }

        // -- CR: Submit ------------------------------------------------
        async function submitYtAdEntry() {
            const cls     = (window.currentCRClass || crClass || '').trim();
            const link    = (document.getElementById('ytAdLink').value    || '').trim();
            const title   = (document.getElementById('ytAdTitle').value   || '').trim();
            const product = (document.getElementById('ytAdProduct').value || '').trim();
            const channel = (document.getElementById('ytAdChannel').value || '').trim();
            const msgEl   = document.getElementById('ytAdSubmitMsg');

            function showMsg(text, ok) {
                msgEl.style.display = 'block';
                msgEl.style.background = ok ? '#d4edda' : '#f8d7da';
                msgEl.style.color      = ok ? '#155724' : '#721c24';
                msgEl.style.border     = ok ? '1px solid #c3e6cb' : '1px solid #f5c6cb';
                msgEl.textContent = text;
            }

            if (!link)    { showMsg('âŒ Please enter the YouTube video link.', false); return; }
            if (!title)   { showMsg('âŒ Please enter the advertisement title.', false); return; }
            if (!product) { showMsg('âŒ Please enter the product/topic being advertised.', false); return; }
            if (!link.includes('youtube.com') && !link.includes('youtu.be')) {
                showMsg('âŒ Please enter a valid YouTube link (youtube.com or youtu.be).', false); return;
            }

            // Collect members
            const members = [];
            for (let i = 1; i <= 8; i++) {
                const v = (document.getElementById('ytAdMember' + i).value || '').trim();
                if (v) members.push(v);
            }

            showMsg('â³ Submittingâ€¦', true);
            try {
                // Full read + client-side filter to avoid Firebase index requirement
                const existingSnap = await db.ref('youtubeAd').once('value');
                let existingKey = null;
                if (existingSnap.exists()) {
                    existingSnap.forEach(ch => { if (ch.val().classYear === cls) existingKey = ch.key; });
                }

                const entry = {
                    classYear:   cls,
                    ytLink:      link,
                    adTitle:     title,
                    product:     product,
                    channel:     channel,
                    members:     members,
                    status:      existingKey ? 'Updated' : 'Pending',
                    submittedAt: Date.now(),
                    socialScore: existingKey ? null : 0,   // keep if updating
                    views:       0,
                    likes:       0,
                    comments:    0,
                    juryTotal_j1: null,
                    juryTotal_j2: null,
                    finalScore:   null
                };

                if (existingKey) {
                    // Update only changeable fields, keep social/jury scores
                    await db.ref('youtubeAd/' + existingKey).update({
                        ytLink: link, adTitle: title, product: product, channel: channel,
                        members: members, status: 'Updated', submittedAt: Date.now()
                    });
                    showMsg('âœ… Submission updated successfully!', true);
                } else {
                    await db.ref('youtubeAd').push(entry);
                    showMsg('âœ… YouTube Ad link submitted successfully!', true);
                }
                // Show submitted date/time
                const now = new Date();
                const fmted = now.toLocaleDateString('en-IN', {day:'2-digit',month:'short',year:'numeric'}) + ' at ' + now.toLocaleTimeString('en-IN', {hour:'2-digit',minute:'2-digit'});
                const infoEl = document.getElementById('ytAdSubmittedInfo');
                const dtEl = document.getElementById('ytAdSubmittedDateTime');
                if (infoEl) infoEl.style.display = 'block';
                if (dtEl) dtEl.textContent = fmted;
                // Show edit button always
                const editBtn = document.getElementById('ytAdEditBtn');
                if (editBtn) editBtn.style.display = 'inline-flex';
                loadYtAdSubmissions();
                autoFillYtAdMembers();
            } catch(e) {
                showMsg('âŒ Error: ' + e.message, false);
            }
        }

        function clearYtAdForm() {
            ['ytAdLink','ytAdTitle','ytAdProduct','ytAdChannel'].forEach(id => {
                const el = document.getElementById(id); if (el) el.value = '';
            });
            const msg = document.getElementById('ytAdSubmitMsg');
            if (msg) msg.style.display = 'none';
        }

        function enableYtAdEdit() {
            // Enable all form fields for editing
            ['ytAdLink','ytAdTitle','ytAdProduct','ytAdChannel'].forEach(id => {
                const el = document.getElementById(id);
                if (el) { el.removeAttribute('readonly'); el.style.background = ''; el.style.borderColor = '#e91e63'; }
            });
            const submitBtn = document.getElementById('ytAdSubmitBtn');
            if (submitBtn) { submitBtn.textContent = 'ðŸ“º Update Submission'; submitBtn.disabled = false; }
            const editBtn = document.getElementById('ytAdEditBtn');
            if (editBtn) editBtn.style.display = 'inline-flex';
            const msg = document.getElementById('ytAdSubmitMsg');
            if (msg) { msg.style.display='block'; msg.style.background='#e3f2fd'; msg.style.color='#1565c0'; msg.style.border='1px solid #90caf9'; msg.textContent='âœï¸ You can now edit the fields. Click "Update Submission" when done.'; }
        }

        // -- CR: Load submissions table --------------------------------
        async function loadYtAdSubmissions() {
            const cls = (window.currentCRClass || crClass || '').trim();
            if (!cls) return;

            const empty     = document.getElementById('ytAdEmptyMsg');
            const container = document.getElementById('ytAdTableContainer');
            const tbody     = document.getElementById('ytAdTableBody');
            const badge     = document.getElementById('ytAdCountBadge');

            try {
                // Full read + client-side filter â€” avoids Firebase index/permission issues
                const snap = await db.ref('youtubeAd').once('value');
                const rows = [];
                if (snap.exists()) snap.forEach(ch => { const d = ch.val(); if (d.classYear === cls) rows.push({ id: ch.key, ...d }); });

                if (badge) badge.textContent = rows.length + ' / 1 slot used';

                if (rows.length === 0) {
                    if (empty)     empty.style.display = 'block';
                    if (container) container.style.display = 'none';
                    return;
                }
                if (empty)     empty.style.display = 'none';
                if (container) container.style.display = 'block';

                tbody.innerHTML = rows.map((e, i) => {
                    const j1 = e.juryTotal_j1 !== null && e.juryTotal_j1 !== undefined ? e.juryTotal_j1 + '/50' : 'â€”';
                    const j2 = e.juryTotal_j2 !== null && e.juryTotal_j2 !== undefined ? e.juryTotal_j2 + '/50' : 'â€”';
                    const finalPct = e.finalScore !== null && e.finalScore !== undefined ? e.finalScore + '%' : 'â€”';
                    const socialDisp = e.socialScore > 0 ? e.socialScore : 'â€”';
                    const statusColor = e.status === 'Approved' ? '#155724' : e.status === 'Rejected' ? '#721c24' : '#856404';
                    const statusBg    = e.status === 'Approved' ? '#d4edda'  : e.status === 'Rejected' ? '#f8d7da'  : '#fff3cd';
                    const submittedDate = e.submittedAt ? new Date(e.submittedAt).toLocaleDateString('en-IN') : 'â€”';
                    return `<tr>
                        <td style="text-align:center;font-weight:700;color:#cc0000">${i+1}</td>
                        <td style="font-weight:700;font-size:0.85em">${e.classYear||'â€”'}</td>
                        <td style="font-size:0.85em;font-weight:600;color:#4a148c">${e.adTitle||'â€”'}</td>
                        <td style="font-size:0.82em">${e.product||'â€”'}</td>
                        <td style="text-align:center"><a href="${e.ytLink||'#'}" target="_blank" rel="noopener" style="color:#cc0000;font-weight:700;font-size:0.85em">â–¶ï¸ View</a></td>
                        <td style="text-align:center;font-size:0.85em">${socialDisp}</td>
                        <td style="text-align:center;font-size:0.85em">${j1}</td>
                        <td style="text-align:center;font-size:0.85em">${j2}</td>
                        <td style="text-align:center;font-weight:800;color:${finalPct !== 'â€”' ? '#1b5e20' : '#aaa'}">${finalPct}</td>
                        <td style="text-align:center"><span style="background:${statusBg};color:${statusColor};padding:3px 10px;border-radius:12px;font-size:0.75em;font-weight:700">${e.status||'Pending'}</span></td>
                        <td style="font-size:0.8em;color:#777">${submittedDate}</td>
                    </tr>`;
                }).join('');
            } catch(e) {
                const isPermission = e && e.message && e.message.includes('permission_denied');
                const errMsg = isPermission
                    ? 'ðŸ”’ Firebase permission denied on <code>/youtubeAd</code>. Super Admin must add <code>".read": true</code> for this path in Firebase Console â†’ Realtime Database â†’ Rules.'
                    : 'âŒ Error loading: ' + e.message;
                if (empty) { empty.innerHTML = errMsg; empty.style.display = 'block'; }
                if (container) container.style.display = 'none';
            }
        }

        // -- Super Admin: Load YT Ad Admin Panel ----------------------
        async function loadYtAdAdminPanel() {
            if (!isSuperAdmin && !isAdmin) return;
            loadYtAdSettings();
            loadYtAdFormula();

            // Load jury setup status
            const juryStatEl = document.getElementById('ytAdJurySetupStatus');
            if (juryStatEl) {
                const jSnap = await db.ref('jurySetup/YouTube Advertisement').once('value').catch(() => null);
                const jd = jSnap && jSnap.val() ? jSnap.val() : null;
                if (jd) {
                    juryStatEl.innerHTML = `âœ… Jury setup found. Jury 1: <strong>${jd.jury1Name||'â€”'}</strong> | Jury 2: <strong>${jd.jury2Name||'â€”'}</strong>`;
                } else {
                    juryStatEl.innerHTML = `âš ï¸ No jury setup found. Go to <strong>Jury Setup tab</strong> and set up "YouTube Advertisement".`;
                }
            }

            const classFilter = (document.getElementById('ytAdAdminClassFilter') || {}).value || '';
            const snap = await db.ref('youtubeAd').once('value');
            const all = [];
            if (snap.exists()) snap.forEach(ch => all.push({ id: ch.key, ...ch.val() }));

            // Populate class filter
            const clsSel = document.getElementById('ytAdAdminClassFilter');
            if (clsSel && clsSel.options.length <= 1) {
                const clsList = [...new Set(all.map(e => e.classYear).filter(Boolean))].sort();
                clsList.forEach(c => {
                    const opt = document.createElement('option'); opt.value = c; opt.textContent = c; clsSel.appendChild(opt);
                });
            }

            const filtered = classFilter ? all.filter(e => e.classYear === classFilter) : all;
            filtered.sort((a,b) => (a.classYear||'').localeCompare(b.classYear||''));

            const empty     = document.getElementById('ytAdAdminEmpty');
            const container = document.getElementById('ytAdAdminTableContainer');
            const tbody     = document.getElementById('ytAdAdminTableBody');
            if (filtered.length === 0) {
                if (empty)     empty.style.display = 'block';
                if (container) container.style.display = 'none';
                return;
            }
            if (empty)     empty.style.display = 'none';
            if (container) container.style.display = 'block';

            let rows = '';
            filtered.forEach((e, i) => {
                const j1Total = e.juryTotal_j1 !== null && e.juryTotal_j1 !== undefined ? +e.juryTotal_j1 : null;
                const j2Total = e.juryTotal_j2 !== null && e.juryTotal_j2 !== undefined ? +e.juryTotal_j2 : null;
                const juryAvg = (j1Total !== null && j2Total !== null) ? (j1Total + j2Total) / 2 :
                                (j1Total !== null ? j1Total : (j2Total !== null ? j2Total : null));
                const juryPct = juryAvg !== null ? +((juryAvg / 50) * 50).toFixed(2) : null;
                const socialPct = e.socialScore > 0 ? +Math.min(50, (e.socialScore / (e.maxRaw||5000) * 50)).toFixed(2) : 0;
                const finalPct  = juryPct !== null ? (juryPct + socialPct).toFixed(1) : 'â€”';
                const gap       = (j1Total !== null && j2Total !== null) ? Math.abs(j1Total - j2Total) : null;
                const dispute   = gap !== null && gap >= 15;
                const statusColor = e.status === 'Approved' ? '#155724' : e.status === 'Rejected' ? '#721c24' : '#856404';
                const statusBg    = e.status === 'Approved' ? '#d4edda'  : e.status === 'Rejected' ? '#f8d7da'  : '#fff3cd';

                rows += `<tr>
                    <td style="text-align:center;font-weight:700;color:#cc0000">${i+1}</td>
                    <td style="font-weight:700;color:#1565c0;font-size:0.85em">${e.classYear||'â€”'}</td>
                    <td style="font-size:0.82em;font-weight:600;color:#4a148c">${e.adTitle||'â€”'}</td>
                    <td style="font-size:0.82em">${e.product||'â€”'}</td>
                    <td style="text-align:center"><a href="${e.ytLink||'#'}" target="_blank" rel="noopener" style="color:#cc0000;font-weight:700;font-size:0.85em">â–¶ï¸ View</a></td>
                    <td style="text-align:center"><input type="number" min="0" id="ytAdViews_${e.id}" value="${e.views||''}" placeholder="0" style="width:65px;padding:4px 6px;border:2px solid #ffcdd2;border-radius:6px;font-size:0.85em;text-align:center;outline:none" oninput="recalcYtAdScore('${e.id}')"></td>
                    <td style="text-align:center"><input type="number" min="0" id="ytAdLikes_${e.id}" value="${e.likes||''}" placeholder="0" style="width:65px;padding:4px 6px;border:2px solid #ffcdd2;border-radius:6px;font-size:0.85em;text-align:center;outline:none" oninput="recalcYtAdScore('${e.id}')"></td>
                    <td style="text-align:center"><input type="number" min="0" id="ytAdComments_${e.id}" value="${e.comments||''}" placeholder="0" style="width:65px;padding:4px 6px;border:2px solid #ffcdd2;border-radius:6px;font-size:0.85em;text-align:center;outline:none" oninput="recalcYtAdScore('${e.id}')"></td>
                    <td style="text-align:center">
                        <div style="display:flex;flex-direction:column;align-items:center;gap:3px">
                            <span id="ytAdSocialPct_${e.id}" style="font-weight:700;color:#e91e63;font-size:0.9em">${e.socialScore > 0 ? Math.min(50,(e.socialScore/(e.maxRaw||5000)*50)).toFixed(1)+'%' : 'â€”'}</span>
                            <button onclick="saveYtAdSocialScore('${e.id}')" style="background:#e91e63;color:white;border:none;border-radius:6px;padding:3px 8px;cursor:pointer;font-size:0.72em;font-weight:700">ðŸ’¾ Save</button>
                        </div>
                    </td>
                    <td style="text-align:center;font-size:0.85em">${j1Total !== null ? j1Total+'/50' : 'â€”'}</td>
                    <td style="text-align:center;font-size:0.85em">${j2Total !== null ? j2Total+'/50' : 'â€”'}</td>
                    <td style="text-align:center;font-weight:800;font-size:0.95em;color:${finalPct !== 'â€”' ? '#1b5e20' : '#aaa'}">${finalPct !== 'â€”' ? finalPct+'%' : 'â€”'}</td>
                    <td style="text-align:center">${dispute ? '<span style="background:#fce4ec;color:#c62828;padding:3px 8px;border-radius:8px;font-size:0.75em;font-weight:700">âš ï¸ '+gap+'pts gap</span>' : '<span style="color:#aaa;font-size:0.75em">â€”</span>'}</td>
                    <td style="text-align:center"><span style="background:${statusBg};color:${statusColor};padding:3px 10px;border-radius:12px;font-size:0.75em;font-weight:700">${e.status||'Pending'}</span></td>
                    <td style="text-align:center">
                        <button onclick="approveYtAdEntry('${e.id}')" style="background:#28a745;color:white;border:none;border-radius:6px;padding:4px 8px;cursor:pointer;font-size:0.75em;margin:2px">âœ…</button>
                        <button onclick="rejectYtAdEntry('${e.id}')" style="background:#dc3545;color:white;border:none;border-radius:6px;padding:4px 8px;cursor:pointer;font-size:0.75em;margin:2px">âŒ</button>
                    </td>
                </tr>`;
            });
            if (tbody) tbody.innerHTML = rows;
        }

        function approveYtAdEntry(id) {
            db.ref('youtubeAd/' + id + '/status').set('Approved').then(() => loadYtAdAdminPanel()).catch(e => alert(e.message));
        }
        function rejectYtAdEntry(id) {
            db.ref('youtubeAd/' + id + '/status').set('Rejected').then(() => loadYtAdAdminPanel()).catch(e => alert(e.message));
        }

        async function recalcYtAdScore(id) {
            // Live preview only â€” does not save
        }

        async function saveYtAdSocialScore(id) {
            const views    = parseInt(document.getElementById('ytAdViews_'    + id).value)    || 0;
            const likes    = parseInt(document.getElementById('ytAdLikes_'    + id).value)    || 0;
            const comments = parseInt(document.getElementById('ytAdComments_' + id).value)    || 0;

            // Load formula
            const fSnap = await db.ref('youtubeAd/socialFormula').once('value').catch(() => null);
            const formula = (fSnap && fSnap.val()) || { weightViews:1, weightLikes:3, weightComments:5, maxRaw:5000 };

            const socialRaw = (views * (formula.weightViews||1)) + (likes * (formula.weightLikes||3)) + (comments * (formula.weightComments||5));
            const socialPct  = Math.min(50, +(socialRaw / (formula.maxRaw||5000) * 50).toFixed(2));

            // Get current jury scores to recalculate final
            const eSnap = await db.ref('youtubeAd/' + id).once('value');
            const eData = eSnap.val() || {};
            const j1 = eData.juryTotal_j1 !== null && eData.juryTotal_j1 !== undefined ? +eData.juryTotal_j1 : null;
            const j2 = eData.juryTotal_j2 !== null && eData.juryTotal_j2 !== undefined ? +eData.juryTotal_j2 : null;
            const juryAvg = (j1 !== null && j2 !== null) ? (j1+j2)/2 : (j1 !== null ? j1 : (j2 !== null ? j2 : null));
            const juryPct = juryAvg !== null ? +((juryAvg/50)*50).toFixed(2) : null;
            const finalScore = juryPct !== null ? +(socialPct + juryPct).toFixed(1) : null;

            const updates = { views, likes, comments, socialScore: socialRaw, socialPct, maxRaw: formula.maxRaw||5000 };
            if (finalScore !== null) updates.finalScore = finalScore;

            await db.ref('youtubeAd/' + id).update(updates).catch(e => { alert('Error saving: ' + e.message); return; });

            const pctEl = document.getElementById('ytAdSocialPct_' + id);
            if (pctEl) pctEl.textContent = socialPct.toFixed(1) + '%';
            loadYtAdAdminPanel();
        }

        // -- YT Ad Jury Login (inside Admin Panel) ---------------------
        let ytAdJuryNum = null;
        const YT_AD_JURY_CRITERIA = [
            'Creativity & Concept',
            'Production Quality',
            'Message Clarity',
            'Persuasiveness',
            'Originality'
        ];

        async function ytAdJuryLogin() {
            const num = document.getElementById('ytAdJuryLoginNum').value;
            const pwd = (document.getElementById('ytAdJuryLoginPwd').value || '').trim();
            const msgEl = document.getElementById('ytAdJuryLoginMsg');

            function showJMsg(text, ok) {
                msgEl.style.display = 'block';
                msgEl.style.background = ok ? '#d4edda' : '#f8d7da';
                msgEl.style.color      = ok ? '#155724' : '#721c24';
                msgEl.style.border     = ok ? '1px solid #c3e6cb' : '1px solid #f5c6cb';
                msgEl.textContent = text;
            }

            if (!pwd) { showJMsg('âŒ Please enter the jury password.', false); return; }

            try {
                const snap = await db.ref('jurySetup/YouTube Advertisement').once('value');
                const setup = snap.val();
                if (!setup) { showJMsg('âŒ Jury setup not configured for YouTube Advertisement. Super Admin must set it up in Jury Setup tab.', false); return; }

                const correctPwd = setup['jury' + num + 'Password'];
                const juryName   = setup['jury' + num + 'Name'] || ('Jury ' + num);
                if (!correctPwd || pwd !== correctPwd) { showJMsg('âŒ Incorrect password.', false); return; }

                ytAdJuryNum = num;
                showJMsg('âœ… Logged in as ' + juryName, true);

                const panel = document.getElementById('ytAdJuryScoringPanel');
                const lbl   = document.getElementById('ytAdJuryWhoLabel');
                if (panel) panel.style.display = 'block';
                if (lbl)   lbl.textContent = juryName + ' (Jury ' + num + ')';

                loadYtAdJuryScoringPanel();
            } catch(e) {
                showJMsg('âŒ Error: ' + e.message, false);
            }
        }

        async function loadYtAdJuryScoringPanel() {
            // Super Admin can score directly without jury login; default to jury 1 slot if not logged in as jury
            if (!ytAdJuryNum) ytAdJuryNum = isSuperAdmin ? '1' : null;
            if (!ytAdJuryNum) { alert('Please log in as Jury from the main login screen first.'); return; }
            const cont = document.getElementById('ytAdJuryScoringList');
            if (!cont) return;
            cont.innerHTML = '<p style="color:#999;text-align:center;padding:20px">Loading submissionsâ€¦</p>';

            try {
                const snap = await db.ref('youtubeAd').once('value');
                const teams = [];
                if (snap.exists()) snap.forEach(ch => teams.push({ id: ch.key, ...ch.val() }));
                if (teams.length === 0) { cont.innerHTML = '<p style="color:#999;text-align:center;padding:20px">No submissions yet.</p>'; return; }

                teams.sort((a,b) => (a.classYear||'').localeCompare(b.classYear||''));

                cont.innerHTML = teams.map(team => {
                    const existing = (team.juryScores && team.juryScores['j' + ytAdJuryNum]) || {};
                    const total = YT_AD_JURY_CRITERIA.reduce((s,c) => s + (+existing[c.replace(/[^a-zA-Z0-9]/g,'_')] || 0), 0);

                    const criteriaRows = YT_AD_JURY_CRITERIA.map(c => {
                        const key = c.replace(/[^a-zA-Z0-9]/g,'_');
                        return `<div style="display:flex;align-items:center;justify-content:space-between;padding:8px 0;border-bottom:1px solid #f0f0f0">
                            <span style="font-size:0.88em;color:#333;font-weight:600;flex:1">${c}</span>
                            <div style="display:flex;align-items:center;gap:6px">
                                <input type="number" min="0" max="10" value="${existing[key]||''}"
                                       id="ytaj_${team.id}_${key}" placeholder="0"
                                       style="width:60px;padding:6px 8px;border:2px solid #ddd;border-radius:6px;font-size:0.9em;text-align:center;outline:none"
                                       oninput="updateYtAdJuryTotal('${team.id}')">
                                <span style="color:#1a237e;font-size:0.82em;font-weight:700">/10</span>
                            </div>
                        </div>`;
                    }).join('');

                    return `<div style="background:white;border-radius:12px;border:2px solid #c5cae9;margin-bottom:16px;overflow:hidden">
                        <div style="background:linear-gradient(135deg,#1a237e,#3949ab);padding:12px 16px;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:6px">
                            <div>
                                <div style="color:white;font-weight:700;font-size:0.95em">${team.classYear||'â€”'}</div>
                                <div style="color:rgba(255,255,255,0.8);font-size:0.8em">${team.adTitle||'â€”'} Â· ${team.product||'â€”'}</div>
                            </div>
                            <a href="${team.ytLink||'#'}" target="_blank" rel="noopener" style="background:rgba(255,255,255,0.2);color:white;padding:5px 12px;border-radius:20px;text-decoration:none;font-size:0.8em;font-weight:700">â–¶ï¸ Watch Ad</a>
                        </div>
                        <div style="padding:14px 16px">
                            ${criteriaRows}
                            <div style="display:flex;justify-content:space-between;align-items:center;margin-top:12px;padding-top:10px;border-top:2px solid #c5cae9">
                                <div>
                                    <span style="font-size:0.88em;color:#666">Total: </span>
                                    <span id="ytajTotal_${team.id}" style="font-size:1.2em;font-weight:800;color:#1a237e">${total}</span>
                                    <span style="font-size:0.85em;color:#3949ab"> / 50 â†’ </span>
                                    <span id="ytajPct_${team.id}" style="font-size:1em;font-weight:800;color:#e91e63">${((total/50)*50).toFixed(1)}%</span>
                                    <span style="font-size:0.78em;color:#aaa"> of final</span>
                                </div>
                                <button onclick="saveYtAdJuryScore('${team.id}')" style="background:linear-gradient(135deg,#4caf50,#2196f3);color:white;border:none;border-radius:8px;padding:8px 18px;cursor:pointer;font-size:0.88em;font-weight:700">ðŸ’¾ Save Score</button>
                            </div>
                            <div id="ytajSaveMsg_${team.id}" style="display:none;margin-top:8px;font-size:0.82em;font-weight:600;padding:6px 10px;border-radius:6px"></div>
                        </div>
                    </div>`;
                }).join('');
            } catch(e) {
                const isPermission = e && e.message && e.message.includes('permission_denied');
                cont.innerHTML = isPermission
                    ? `<div style="padding:20px;background:#ffeef0;border-radius:10px;border:2px solid #f5c6cb">
                        <p style="color:#c62828;font-weight:700;margin:0 0 8px">ðŸ”’ Firebase Permission Denied on <code>/youtubeAd</code></p>
                        <p style="color:#555;font-size:0.88em;margin:0 0 12px">Super Admin needs to update Firebase Database Rules to allow reads on <code>youtubeAd</code> and <code>youtubeAd/settings</code> paths.</p>
                        <div style="background:#fff8e1;border-radius:8px;padding:10px 14px;border-left:4px solid #ffc107;font-size:0.82em;color:#444">
                            ðŸ‘‰ Go to <strong>Firebase Console</strong> â†’ Realtime Database â†’ Rules â†’ add:<br>
                            <code style="background:#f5f5f5;padding:4px 8px;border-radius:4px;display:block;margin-top:6px">"youtubeAd": { ".read": true, ".write": true },<br>"youtubeAd/settings": { ".read": true, ".write": true }</code>
                        </div>
                        <button onclick="loadYtAdJuryScoringPanel()" style="margin-top:12px;background:#1a237e;color:white;border:none;border-radius:8px;padding:8px 18px;cursor:pointer;font-weight:700">ðŸ”„ Try Again</button>
                    </div>`
                    : `<p style="color:#c62828;padding:20px;text-align:center">âŒ Error: ${e.message}</p>`;
            }
        }

        function updateYtAdJuryTotal(teamId) {
            let total = 0;
            YT_AD_JURY_CRITERIA.forEach(c => {
                const key = c.replace(/[^a-zA-Z0-9]/g,'_');
                const inp = document.getElementById('ytaj_' + teamId + '_' + key);
                if (inp) total += Math.min(10, Math.max(0, +inp.value || 0));
            });
            const totEl = document.getElementById('ytajTotal_' + teamId);
            const pctEl = document.getElementById('ytajPct_'   + teamId);
            if (totEl) totEl.textContent = total;
            if (pctEl) pctEl.textContent = ((total/50)*50).toFixed(1) + '%';
        }

        async function saveYtAdJuryScore(teamId) {
            const scores = {};
            let total = 0;
            let valid = true;
            YT_AD_JURY_CRITERIA.forEach(c => {
                const key = c.replace(/[^a-zA-Z0-9]/g,'_');
                const inp = document.getElementById('ytaj_' + teamId + '_' + key);
                const val = inp ? Math.min(10, Math.max(0, +inp.value || 0)) : 0;
                if (inp && inp.value === '') valid = false;
                scores[key] = val;
                total += val;
            });
            if (!valid) { alert('Please enter scores for all criteria (0â€“10 each)'); return; }

            const juryPct = +((total/50)*50).toFixed(2);
            const updates = {};
            updates['juryScores/j' + ytAdJuryNum] = scores;
            updates['juryTotal_j' + ytAdJuryNum]  = total;
            updates['juryPct_j'   + ytAdJuryNum]  = juryPct;

            // Recalculate final
            const snap = await db.ref('youtubeAd/' + teamId).once('value');
            const team = snap.val() || {};
            const otherJury = ytAdJuryNum === '1' ? team.juryTotal_j2 : team.juryTotal_j1;
            if (otherJury !== null && otherJury !== undefined) {
                const avgJury = (total + (+otherJury)) / 2;
                const avgPct  = (avgJury / 50) * 50;
                const socialPct = team.socialPct || 0;
                updates['finalScore'] = +(avgPct + socialPct).toFixed(1);
            }

            const msgEl = document.getElementById('ytajSaveMsg_' + teamId);
            db.ref('youtubeAd/' + teamId).update(updates).then(() => {
                msgEl.style.display = 'block';
                msgEl.style.background = '#d4edda'; msgEl.style.color = '#155724'; msgEl.style.border = '1px solid #c3e6cb';
                msgEl.textContent = 'âœ… Score saved! Total: ' + total + '/50';
                setTimeout(() => msgEl.style.display = 'none', 4000);
            }).catch(e => {
                msgEl.style.display = 'block';
                msgEl.style.background = '#f8d7da'; msgEl.style.color = '#721c24'; msgEl.style.border = '1px solid #f5c6cb';
                msgEl.textContent = 'âŒ Error: ' + e.message;
            });
        }

        // -- CR: YT Ad Screenshot Upload Functions ---------------------
        const YT_AD_SCREENSHOT_SLOTS = [
            { key: 'start', label: 'ðŸ“… Screenshot 1 â€” Start of Event (02 Mar 2026)', date: '2026-03-02' },
            { key: 'end',   label: 'ðŸ“… Screenshot 2 â€” End of Event (07 Mar 2026)',   date: '2026-03-07' }
        ];

        function initYtAdScreenshots() {
            const container = document.getElementById('ytAdScreenshotSlots');
            if (!container) return;
            container.innerHTML = '';
            YT_AD_SCREENSHOT_SLOTS.forEach(slot => {
                const badge     = `<span style="background:#e3f2fd;color:#1565c0;padding:2px 8px;border-radius:10px;font-size:0.72em;margin-left:6px">OPENS ${slot.date}</span>`;
                const disabled  = '';
                const disStyle  = '';
                const bgColor   = '#f1f8e9';
                const border    = '#a5d6a7';
                container.insertAdjacentHTML('beforeend', `
                <div style="background:${bgColor};border:2px solid ${border};border-radius:10px;padding:14px 16px">
                    <div style="font-size:0.87em;font-weight:700;color:#444;margin-bottom:10px">${slot.label}${badge}</div>
                    <p style="font-size:0.76em;color:#777;margin:0 0 8px">
                        ðŸ“Š Open YouTube Studio â†’ Analytics â†’ screenshot showing <strong>Views, Likes, Comments</strong>.<br>
                        Roopa M C / Smitha M will read this and enter numbers for your Social Score.
                    </p>
                    <div id="ytAdShotPrev_${slot.key}" style="display:none;margin-bottom:8px">
                        <img id="ytAdShotImg_${slot.key}" src="" style="max-height:140px;max-width:100%;border-radius:8px;border:2px solid #a5d6a7;object-fit:contain">
                        <button type="button" onclick="removeYtAdShot('${slot.key}')" style="display:inline-block;margin-top:5px;background:#f44336;color:white;border:none;border-radius:6px;padding:3px 12px;font-size:0.76em;cursor:pointer">âœ• Remove</button>
                    </div>
                    <div id="ytAdShotAlready_${slot.key}" style="display:none;margin-bottom:8px;font-size:0.8em;color:#388e3c;background:#f1f8e9;border-radius:6px;padding:6px 10px;border:1px solid #a5d6a7">
                        âœ… Screenshot already uploaded. You can replace it below.
                    </div>
                    <div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap">
                        <input type="file" id="ytAdShotFile_${slot.key}" accept="image/*" onchange="previewYtAdShot('${slot.key}',this)" style="display:none" ${disabled}>
                        <button type="button" onclick="document.getElementById('ytAdShotFile_${slot.key}').click()"
                            style="background:#9c27b0;color:white;border:none;border-radius:8px;padding:8px 16px;font-size:0.84em;font-weight:700;cursor:pointer;${disStyle}" ${disabled}>
                            ðŸ“· Upload Screenshot
                        </button>
                        <span id="ytAdShotName_${slot.key}" style="font-size:0.8em;color:#888">No file chosen</span>
                        <span id="ytAdShotStatus_${slot.key}" style="font-size:0.78em;font-weight:700;display:none;padding:3px 8px;border-radius:6px"></span>
                    </div>
                </div>`);
            });
        }

        function previewYtAdShot(key, input) {
            const file = input.files[0]; if (!file) return;
            document.getElementById('ytAdShotName_' + key).textContent = file.name;
            const reader = new FileReader();
            reader.onload = e => {
                document.getElementById('ytAdShotImg_'  + key).src = e.target.result;
                document.getElementById('ytAdShotPrev_' + key).style.display = 'block';
            };
            reader.readAsDataURL(file);
        }

        function removeYtAdShot(key) {
            const f = document.getElementById('ytAdShotFile_' + key);
            if (f) f.value = '';
            document.getElementById('ytAdShotPrev_' + key).style.display = 'none';
            document.getElementById('ytAdShotImg_'  + key).src = '';
            document.getElementById('ytAdShotName_' + key).textContent = 'No file chosen';
        }

        async function loadYtAdExistingScreenshots(entryKey) {
            try {
                const snap = await db.ref('youtubeAd/' + entryKey + '/screenshots').once('value');
                if (!snap.exists()) return;
                const shots = snap.val();
                YT_AD_SCREENSHOT_SLOTS.forEach(slot => {
                    if (shots[slot.key]) {
                        const el = document.getElementById('ytAdShotAlready_' + slot.key);
                        if (el) el.style.display = 'block';
                    }
                });
            } catch(e) {}
        }

        async function uploadYtAdShot(key) {
            const fileEl   = document.getElementById('ytAdShotFile_'   + key);
            const statusEl = document.getElementById('ytAdShotStatus_' + key);
            if (!fileEl || !fileEl.files[0]) return null;
            const setS = (msg, ok) => {
                if (!statusEl) return;
                statusEl.style.display    = 'block';
                statusEl.style.background = ok ? '#d4edda' : ok === false ? '#f8d7da' : '#fff3cd';
                statusEl.style.color      = ok ? '#155724' : ok === false ? '#721c24' : '#856404';
                statusEl.textContent = msg;
            };
            setS('â³ Uploadingâ€¦', null);
            const formData = new FormData();
            formData.append('file', fileEl.files[0]);
            formData.append('upload_preset', 'scavenger_hunt');
            formData.append('folder', 'ytad_screenshots/' + key);
            try {
                const res  = await fetch('https://api.cloudinary.com/v1_1/dat0khbet/image/upload', { method:'POST', body:formData });
                const data = await res.json();
                if (data.secure_url) { setS('âœ… Uploaded!', true); return data.secure_url; }
                else { setS('âš ï¸ Failed.', null); return null; }
            } catch(e) { setS('âš ï¸ Error.', null); return null; }
        }

        async function submitYtAdScreenshots() {
            const cls   = (window.currentCRClass || crClass || '').trim();
            const msgEl = document.getElementById('ytAdScreenshotMsg');
            const btnEl = document.getElementById('ytAdScreenshotBtn');
            const showMsg = (text, ok) => {
                if (!msgEl) return;
                msgEl.style.display    = 'block';
                msgEl.style.background = ok ? '#d4edda' : '#f8d7da';
                msgEl.style.color      = ok ? '#155724' : '#721c24';
                msgEl.textContent = text;
            };
            if (!cls) { showMsg('âŒ Class info missing. Please re-login.', false); return; }
            btnEl.disabled = true; btnEl.textContent = 'â³ Uploadingâ€¦';
            try {
                // Find submission entry for this class
                const subSnap = await db.ref('youtubeAd').once('value');
                let entryKey = null;
                if (subSnap.exists()) subSnap.forEach(ch => { if (ch.val().classYear === cls) entryKey = ch.key; });
                if (!entryKey) { showMsg('âŒ No YouTube link submitted yet. Please submit the YouTube link first.', false); return; }

                // Upload selected screenshots
                const uploaded = {};
                for (const slot of YT_AD_SCREENSHOT_SLOTS) {
                    const fileEl = document.getElementById('ytAdShotFile_' + slot.key);
                    if (fileEl && fileEl.files[0]) {
                        const url = await uploadYtAdShot(slot.key);
                        if (url) uploaded[slot.key] = url;
                    }
                }
                if (!Object.keys(uploaded).length) { showMsg('âš ï¸ No screenshots selected. Please choose at least one.', false); return; }

                // Save URLs under the submission entry
                const existSnap = await db.ref('youtubeAd/' + entryKey + '/screenshots').once('value').catch(() => null);
                const existing  = (existSnap && existSnap.val()) || {};
                Object.assign(existing, uploaded);
                await db.ref('youtubeAd/' + entryKey + '/screenshots').set(existing);
                await db.ref('youtubeAd/' + entryKey + '/latestScreenshotUrl').set(Object.values(uploaded).pop());
                showMsg('âœ… Analytics screenshots uploaded! Roopa M C / Smitha M will enter your Views, Likes and Comments.', true);
                loadYtAdExistingScreenshots(entryKey);
            } catch(err) {
                showMsg('âŒ Error: ' + err.message, false);
            } finally {
                btnEl.disabled = false; btnEl.textContent = 'ðŸ“¸ Submit Analytics Screenshots';
            }
        }

        // -- Faculty Monitor: Roopa M C and Smitha M ------------------
        async function loadYtAdMonitorPanel() {
            const listEl = document.getElementById('ytAdMonitorList');
            if (!listEl) return;
            listEl.innerHTML = '<div style="text-align:center;color:#aaa;padding:30px">Loading YouTube Ad submissionsâ€¦</div>';

            try {
                const [snap, fSnap] = await Promise.all([
                    db.ref('youtubeAd').once('value'),
                    db.ref('youtubeAd/socialFormula').once('value').catch(() => null)
                ]);
                const formula = (fSnap && fSnap.val()) || { weightViews:1, weightLikes:3, weightComments:5, maxRaw:5000 };

                // Collect only submission entries (skip settings keys like eventActive, leaderboardPublished, socialFormula)
                const teams = [];
                if (snap.exists()) snap.forEach(ch => {
                    const d = ch.val();
                    if (d && d.classYear) teams.push({ id: ch.key, ...d });
                });
                teams.sort((a,b) => (a.classYear||'').localeCompare(b.classYear||''));

                if (teams.length === 0) {
                    // Show all eligible classes with entry forms even if CR hasn't submitted
                    const today = new Date().toISOString().slice(0,10);
                    listEl.innerHTML = YT_AD_ELIGIBLE.map(cls => `
                        <div style="background:white;border-radius:12px;border:2px solid #ffcdd2;padding:18px;box-shadow:0 2px 8px rgba(0,0,0,0.06)">
                            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:14px;flex-wrap:wrap;gap:8px">
                                <div>
                                    <span style="background:linear-gradient(135deg,#cc0000,#ff6600);color:white;border-radius:20px;padding:3px 12px;font-size:0.82em;font-weight:700">ðŸ“º ${cls}</span>
                                </div>
                                <span style="background:#fff3cd;color:#856404;border-radius:12px;padding:4px 12px;font-size:0.78em;font-weight:700">â³ CR hasn't submitted link yet</span>
                            </div>
                            <div style="background:#fff8f0;border-radius:8px;padding:10px 14px;font-size:0.8em;color:#e65100;margin-bottom:14px">
                                âš ï¸ No YouTube Ad link or screenshot from CR yet â€” but you can still enter metrics once you have the numbers.
                            </div>
                            <div style="display:flex;flex-direction:column;gap:8px;max-width:320px">
                                <div style="font-size:0.82em;font-weight:700;color:#444;margin-bottom:4px">ðŸ“ Enter Metrics <span style="color:#888;font-weight:400">(${today}):</span></div>
                                <div style="display:flex;align-items:center;gap:8px">
                                    <span style="width:90px;font-size:0.82em;color:#555;font-weight:600">ðŸ‘ Views</span>
                                    <input type="number" id="ytMon_views_nk_${cls.replace(/\s/g,'_')}" min="0" placeholder="0"
                                           style="flex:1;padding:7px 10px;border:2px solid #ffcdd2;border-radius:8px;font-size:0.88em;outline:none">
                                </div>
                                <div style="display:flex;align-items:center;gap:8px">
                                    <span style="width:90px;font-size:0.82em;color:#555;font-weight:600">ðŸ‘ Likes</span>
                                    <input type="number" id="ytMon_likes_nk_${cls.replace(/\s/g,'_')}" min="0" placeholder="0"
                                           style="flex:1;padding:7px 10px;border:2px solid #ffcdd2;border-radius:8px;font-size:0.88em;outline:none">
                                </div>
                                <div style="display:flex;align-items:center;gap:8px">
                                    <span style="width:90px;font-size:0.82em;color:#555;font-weight:600">ðŸ’¬ Comments</span>
                                    <input type="number" id="ytMon_comments_nk_${cls.replace(/\s/g,'_')}" min="0" placeholder="0"
                                           style="flex:1;padding:7px 10px;border:2px solid #ffcdd2;border-radius:8px;font-size:0.88em;outline:none">
                                </div>
                                <div style="background:#fff8f0;border-radius:8px;padding:8px 12px;font-size:0.8em;color:#e65100;margin-top:2px">
                                    Formula: (ViewsÃ—${formula.weightViews||1}) + (LikesÃ—${formula.weightLikes||3}) + (CommentsÃ—${formula.weightComments||5}) Ã· ${formula.maxRaw||5000} Ã— 50
                                </div>
                                <div style="display:flex;gap:8px;align-items:center;margin-top:4px">
                                    <button onclick="saveYtAdMonitorScoreByClass('${cls}')"
                                            style="background:linear-gradient(135deg,#cc0000,#ff6600);color:white;border:none;border-radius:8px;padding:9px 18px;font-size:0.88em;font-weight:700;cursor:pointer">
                                        ðŸ’¾ Save Score
                                    </button>
                                    <span id="ytMonMsg_nk_${cls.replace(/\s/g,'_')}" style="font-size:0.8em;font-weight:700;display:none"></span>
                                </div>
                            </div>
                        </div>`).join('');
                    return;
                }

                listEl.innerHTML = teams.map((t, i) => {
                    const socialRaw = (t.views||0)*(formula.weightViews||1) + (t.likes||0)*(formula.weightLikes||3) + (t.comments||0)*(formula.weightComments||5);
                    const socialPct = Math.min(50, +(socialRaw/(formula.maxRaw||5000)*50).toFixed(2));
                    const today = new Date().toISOString().slice(0,10);

                    // Build screenshot HTML
                    const shots = t.screenshots || {};
                    let screenshotHtml = '';
                    const shotEntries = Object.entries(shots);
                    if (shotEntries.length > 0) {
                        screenshotHtml = '<div style="display:flex;flex-direction:column;gap:8px">';
                        shotEntries.forEach(([key, url]) => {
                            const label = key === 'start' ? '02-Mar (Start)' : key === 'end' ? '07-Mar (End)' : key;
                            screenshotHtml += `<a href="${url}" target="_blank" rel="noopener" style="display:inline-block">
                                <img src="${url}" style="max-height:120px;max-width:100%;border-radius:8px;border:2px solid #a5d6a7;object-fit:contain" alt="Analytics ${label}">
                                <div style="font-size:0.72em;color:#4caf50;margin-top:2px">ðŸ“Š ${label} â€” Click to enlarge</div>
                            </a>`;
                        });
                        screenshotHtml += '</div>';
                    } else if (t.latestScreenshotUrl) {
                        screenshotHtml = `<a href="${t.latestScreenshotUrl}" target="_blank" rel="noopener">
                            <img src="${t.latestScreenshotUrl}" style="max-height:130px;max-width:100%;border-radius:8px;border:2px solid #a5d6a7;object-fit:contain">
                            <div style="font-size:0.75em;color:#4caf50;margin-top:3px">ðŸ“Š Click to open full screenshot</div>
                        </a>`;
                    } else {
                        screenshotHtml = '<div style="background:#f5f5f5;border-radius:8px;padding:16px;text-align:center;color:#bbb;font-size:0.82em;border:2px dashed #ddd">No screenshot uploaded by CR yet</div>';
                    }

                    return `<div style="background:white;border-radius:12px;border:2px solid #ffcdd2;padding:18px;box-shadow:0 2px 8px rgba(0,0,0,0.06)">
                        <div style="display:flex;justify-content:space-between;align-items:flex-start;flex-wrap:wrap;gap:8px;margin-bottom:14px">
                            <div>
                                <span style="background:linear-gradient(135deg,#cc0000,#ff6600);color:white;border-radius:20px;padding:3px 12px;font-size:0.82em;font-weight:700">Class ${i+1}</span>
                                <strong style="margin-left:8px;font-size:0.95em">${t.classYear||'â€”'}</strong>
                                <span style="color:#c62828;font-size:0.82em;margin-left:8px">ðŸ“Œ ${t.adTitle||'â€”'}</span>
                            </div>
                            <a href="${t.ytLink||'#'}" target="_blank" rel="noopener" style="background:#cc0000;color:white;border-radius:16px;padding:4px 14px;text-decoration:none;font-size:0.8em;font-weight:700">â–¶ï¸ Watch Video</a>
                        </div>

                        <div style="display:grid;grid-template-columns:1fr 1fr;gap:14px">
                            <!-- Screenshots from CR -->
                            <div>
                                <div style="font-size:0.82em;font-weight:700;color:#444;margin-bottom:6px">ðŸ“Š Analytics Screenshot (by CR):</div>
                                ${screenshotHtml}
                            </div>

                            <!-- Entry form -->
                            <div>
                                <div style="font-size:0.82em;font-weight:700;color:#444;margin-bottom:8px">ðŸ“ Enter Metrics <span style="color:#888;font-weight:400">(${today})</span>:</div>
                                <div style="display:flex;flex-direction:column;gap:8px">
                                    <div style="display:flex;align-items:center;gap:8px">
                                        <span style="width:80px;font-size:0.82em;color:#555;font-weight:600">ðŸ‘ Views</span>
                                        <input type="number" id="ytMon_views_${t.id}" min="0" placeholder="0" value="${t.views||''}"
                                               style="flex:1;padding:7px 10px;border:2px solid #ffcdd2;border-radius:8px;font-size:0.88em;outline:none">
                                    </div>
                                    <div style="display:flex;align-items:center;gap:8px">
                                        <span style="width:80px;font-size:0.82em;color:#555;font-weight:600">ðŸ‘ Likes</span>
                                        <input type="number" id="ytMon_likes_${t.id}" min="0" placeholder="0" value="${t.likes||''}"
                                               style="flex:1;padding:7px 10px;border:2px solid #ffcdd2;border-radius:8px;font-size:0.88em;outline:none">
                                    </div>
                                    <div style="display:flex;align-items:center;gap:8px">
                                        <span style="width:80px;font-size:0.82em;color:#555;font-weight:600">ðŸ’¬ Comments</span>
                                        <input type="number" id="ytMon_comments_${t.id}" min="0" placeholder="0" value="${t.comments||''}"
                                               style="flex:1;padding:7px 10px;border:2px solid #ffcdd2;border-radius:8px;font-size:0.88em;outline:none">
                                    </div>
                                    <div style="background:#fff8f0;border-radius:8px;padding:8px 12px;font-size:0.8em;color:#e65100;margin-top:2px">
                                        Formula: (ViewsÃ—${formula.weightViews||1}) + (LikesÃ—${formula.weightLikes||3}) + (CommentsÃ—${formula.weightComments||5}) Ã· ${formula.maxRaw||5000} Ã— 50
                                    </div>
                                    <div style="display:flex;gap:8px;align-items:center;margin-top:4px">
                                        <button onclick="saveYtAdMonitorScore('${t.id}')"
                                                style="background:linear-gradient(135deg,#cc0000,#ff6600);color:white;border:none;border-radius:8px;padding:9px 18px;font-size:0.88em;font-weight:700;cursor:pointer">
                                            ðŸ’¾ Save Score
                                        </button>
                                        <span id="ytMonMsg_${t.id}" style="font-size:0.8em;font-weight:700;display:none"></span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Last saved score -->
                        <div style="margin-top:12px;background:${t.views ? '#fff3e0' : '#f5f5f5'};border-radius:8px;padding:10px 14px;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:6px">
                            <div style="font-size:0.82em;color:#555">
                                Views: <strong>${t.views||0}</strong> &nbsp;Â·&nbsp;
                                Likes: <strong>${t.likes||0}</strong> &nbsp;Â·&nbsp;
                                Comments: <strong>${t.comments||0}</strong>
                            </div>
                            <div style="font-size:0.88em;font-weight:700;color:${t.views ? '#e65100' : '#aaa'}">
                                Social Score: <strong>${socialPct} / 50</strong>
                            </div>
                        </div>
                    </div>`;
                }).join('');

                // Also show any eligible classes that haven't submitted yet
                const submittedClasses = teams.map(t => t.classYear || '');
                const missingClasses = YT_AD_ELIGIBLE.filter(cls => !submittedClasses.includes(cls));
                if (missingClasses.length > 0) {
                    const today = new Date().toISOString().slice(0,10);
                    listEl.innerHTML += missingClasses.map(cls => `
                        <div style="background:white;border-radius:12px;border:2px solid #ffcdd2;padding:18px;box-shadow:0 2px 8px rgba(0,0,0,0.06)">
                            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:14px;flex-wrap:wrap;gap:8px">
                                <span style="background:linear-gradient(135deg,#cc0000,#ff6600);color:white;border-radius:20px;padding:3px 12px;font-size:0.82em;font-weight:700">ðŸ“º ${cls}</span>
                                <span style="background:#fff3cd;color:#856404;border-radius:12px;padding:4px 12px;font-size:0.78em;font-weight:700">â³ CR hasn't submitted link yet</span>
                            </div>
                            <div style="background:#fff8f0;border-radius:8px;padding:10px 14px;font-size:0.8em;color:#e65100;margin-bottom:14px">
                                âš ï¸ No YouTube Ad link or screenshot from CR yet â€” but you can still enter metrics once you have the numbers.
                            </div>
                            <div style="display:flex;flex-direction:column;gap:8px;max-width:320px">
                                <div style="font-size:0.82em;font-weight:700;color:#444;margin-bottom:4px">ðŸ“ Enter Metrics <span style="color:#888;font-weight:400">(${today}):</span></div>
                                <div style="display:flex;align-items:center;gap:8px">
                                    <span style="width:90px;font-size:0.82em;color:#555;font-weight:600">ðŸ‘ Views</span>
                                    <input type="number" id="ytMon_views_nk_${cls.replace(/\s/g,'_')}" min="0" placeholder="0"
                                           style="flex:1;padding:7px 10px;border:2px solid #ffcdd2;border-radius:8px;font-size:0.88em;outline:none">
                                </div>
                                <div style="display:flex;align-items:center;gap:8px">
                                    <span style="width:90px;font-size:0.82em;color:#555;font-weight:600">ðŸ‘ Likes</span>
                                    <input type="number" id="ytMon_likes_nk_${cls.replace(/\s/g,'_')}" min="0" placeholder="0"
                                           style="flex:1;padding:7px 10px;border:2px solid #ffcdd2;border-radius:8px;font-size:0.88em;outline:none">
                                </div>
                                <div style="display:flex;align-items:center;gap:8px">
                                    <span style="width:90px;font-size:0.82em;color:#555;font-weight:600">ðŸ’¬ Comments</span>
                                    <input type="number" id="ytMon_comments_nk_${cls.replace(/\s/g,'_')}" min="0" placeholder="0"
                                           style="flex:1;padding:7px 10px;border:2px solid #ffcdd2;border-radius:8px;font-size:0.88em;outline:none">
                                </div>
                                <div style="background:#fff8f0;border-radius:8px;padding:8px 12px;font-size:0.8em;color:#e65100;margin-top:2px">
                                    Formula: (ViewsÃ—${formula.weightViews||1}) + (LikesÃ—${formula.weightLikes||3}) + (CommentsÃ—${formula.weightComments||5}) Ã· ${formula.maxRaw||5000} Ã— 50
                                </div>
                                <div style="display:flex;gap:8px;align-items:center;margin-top:4px">
                                    <button onclick="saveYtAdMonitorScoreByClass('${cls}')"
                                            style="background:linear-gradient(135deg,#cc0000,#ff6600);color:white;border:none;border-radius:8px;padding:9px 18px;font-size:0.88em;font-weight:700;cursor:pointer">
                                        ðŸ’¾ Save Score
                                    </button>
                                    <span id="ytMonMsg_nk_${cls.replace(/\s/g,'_')}" style="font-size:0.8em;font-weight:700;display:none"></span>
                                </div>
                            </div>
                        </div>`).join('');
                }
            } catch(e) {
                const isPermission = e && e.message && e.message.includes('permission_denied');
                listEl.innerHTML = `<div style="padding:24px;background:#ffeef0;border-radius:10px;border:2px solid #f5c6cb">
                    <p style="color:#c62828;font-weight:700">${isPermission ? 'ðŸ”’ Firebase permission denied on /youtubeAd' : 'âŒ Error: ' + e.message}</p>
                    <button onclick="loadYtAdMonitorPanel()" style="background:#cc0000;color:white;border:none;border-radius:8px;padding:8px 18px;cursor:pointer;font-weight:700">ðŸ”„ Try Again</button>
                </div>`;
            }
        }

        // Save score for a class that hasn't submitted their YT link yet (by class name)
        async function saveYtAdMonitorScoreByClass(cls) {
            const safeKey = cls.replace(/\s/g, '_');
            const views    = parseInt(document.getElementById('ytMon_views_nk_'    + safeKey)?.value) || 0;
            const likes    = parseInt(document.getElementById('ytMon_likes_nk_'    + safeKey)?.value) || 0;
            const comments = parseInt(document.getElementById('ytMon_comments_nk_' + safeKey)?.value) || 0;
            const msgEl    = document.getElementById('ytMonMsg_nk_' + safeKey);

            if (msgEl) { msgEl.style.display = 'inline'; msgEl.style.color = '#856404'; msgEl.textContent = 'â³ Savingâ€¦'; }

            try {
                const fSnap = await db.ref('youtubeAd/socialFormula').once('value').catch(() => null);
                const formula = (fSnap && fSnap.val()) || { weightViews:1, weightLikes:3, weightComments:5, maxRaw:5000 };
                const socialRaw = views*(formula.weightViews||1) + likes*(formula.weightLikes||3) + comments*(formula.weightComments||5);
                const socialPct = Math.min(50, +(socialRaw/(formula.maxRaw||5000)*50).toFixed(2));

                // Check if an existing entry already exists for this class (created by CR later)
                const existSnap = await db.ref('youtubeAd').orderByChild('classYear').equalTo(cls).once('value');
                if (existSnap.exists()) {
                    // Update the existing record
                    existSnap.forEach(ch => {
                        db.ref('youtubeAd/' + ch.key).update({ views, likes, comments, socialScore: socialRaw, socialPct, maxRaw: formula.maxRaw||5000 });
                    });
                } else {
                    // Create a placeholder record
                    await db.ref('youtubeAd').push({
                        classYear: cls,
                        views, likes, comments,
                        socialScore: socialRaw,
                        socialPct,
                        maxRaw: formula.maxRaw || 5000,
                        enteredByMonitor: true,
                        enteredAt: new Date().toISOString()
                    });
                }
                if (msgEl) { msgEl.style.color = '#155724'; msgEl.textContent = 'âœ… Saved! Social: ' + socialPct.toFixed(1) + '%'; setTimeout(() => { if(msgEl) msgEl.style.display='none'; }, 3000); }
                // Reload to reflect the saved entry as a full card
                setTimeout(() => loadYtAdMonitorPanel(), 1500);
            } catch(e) {
                if (msgEl) { msgEl.style.color = '#721c24'; msgEl.textContent = 'âŒ Error: ' + e.message; msgEl.style.display = 'inline'; }
            }
        }

        async function saveYtAdMonitorScore(id) {
            const views    = parseInt(document.getElementById('ytMon_views_'    + id).value) || 0;
            const likes    = parseInt(document.getElementById('ytMon_likes_'    + id).value) || 0;
            const comments = parseInt(document.getElementById('ytMon_comments_' + id).value) || 0;
            const msgEl    = document.getElementById('ytMonMsg_' + id);

            if (msgEl) { msgEl.style.display = 'inline'; msgEl.style.color = '#856404'; msgEl.textContent = 'â³ Savingâ€¦'; }

            try {
                const fSnap = await db.ref('youtubeAd/socialFormula').once('value').catch(() => null);
                const formula = (fSnap && fSnap.val()) || { weightViews:1, weightLikes:3, weightComments:5, maxRaw:5000 };
                const socialRaw = views*(formula.weightViews||1) + likes*(formula.weightLikes||3) + comments*(formula.weightComments||5);
                const socialPct  = Math.min(50, +(socialRaw/(formula.maxRaw||5000)*50).toFixed(2));

                const eSnap = await db.ref('youtubeAd/' + id).once('value');
                const eData = eSnap.val() || {};
                const j1 = eData.juryTotal_j1 !== null && eData.juryTotal_j1 !== undefined ? +eData.juryTotal_j1 : null;
                const j2 = eData.juryTotal_j2 !== null && eData.juryTotal_j2 !== undefined ? +eData.juryTotal_j2 : null;
                const juryAvg = (j1!==null&&j2!==null) ? (j1+j2)/2 : (j1!==null?j1:(j2!==null?j2:null));
                const juryPct = juryAvg !== null ? +((juryAvg/50)*50).toFixed(2) : null;

                const updates = { views, likes, comments, socialScore: socialRaw, socialPct, maxRaw: formula.maxRaw||5000 };
                if (juryPct !== null) updates.finalScore = +(socialPct + juryPct).toFixed(1);

                await db.ref('youtubeAd/' + id).update(updates);
                if (msgEl) { msgEl.style.color = '#155724'; msgEl.textContent = 'âœ… Saved! Social: ' + socialPct.toFixed(1) + '%'; setTimeout(() => { if(msgEl) msgEl.style.display='none'; }, 3000); }
            } catch(e) {
                if (msgEl) { msgEl.style.color = '#c62828'; msgEl.textContent = 'âŒ Error: ' + e.message; }
            }
        }

        // FACULTY ADMIN PANEL
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        const FACULTY_LIST = [
            { sl:1,  name:'Priyanka V',             class:'I BCA',   phone:'8088783099' },
            { sl:2,  name:'Roopa M.C',              class:'I BCA',   phone:'9449683234' },
            { sl:3,  name:'Smitha',                 class:'II BCA A', phone:'9972442555' },
            { sl:4,  name:'Kotrappa K',              class:'II BCA B', phone:'9731067467' },
            { sl:5,  name:'Anitha N',               class:'III BCA A',phone:'9164505025' },
            { sl:6,  name:'Pooja C',                class:'III BCA B',phone:'9632736954' },
            { sl:7,  name:'Anitha N',               class:'III BCA C',phone:'9164505025' },
            { sl:8,  name:'Dr. Shilpa R Y',         class:'I B.Com',  phone:'9591724804' },
            { sl:9,  name:'Lalitha S K',            class:'II B.Com', phone:'8073206168' },
            { sl:10, name:'Chandan G B',            class:'III B.Com',phone:'9964322171' },
            { sl:11, name:'Hemavathi Desai',        class:'II BBA',   phone:'8197909244' },
            { sl:12, name:'Shankar B C',            class:'III BBA',  phone:'9972652501' }
        ];

        // Define faculty roles (used in cards + dashboard)
        const FACULTY_ROLES = {
            'Chandan G B'     : { role: 'ðŸ“Š Vlog Monitor + ðŸŽ™ï¸ Podcast Approval', color: '#1b5e20', bg: '#c8e6c9', detail: 'Vlog Social Score Monitor & Pod Casting Approval Incharge' },
            'Priyanka V'      : { role: 'ðŸ“Š Vlog Monitor + ðŸ“‹ Event Incharge',   color: '#4a148c', bg: '#e1bee7', detail: 'Vlog Social Score Monitor & Incharge: Mime, Vlog' },
            'Roopa M.C'       : { role: 'ðŸ“‹ Event Incharge',  color: '#b71c1c', bg: '#ffcdd2', detail: 'Event Incharge: Mad Ads, YouTube Advertisement, Case Analysis' },
            'Smitha'          : { role: 'ðŸ“º YT Ad Monitor + ðŸ“‹ Event Incharge',  color: '#b71c1c', bg: '#ffcdd2', detail: 'YouTube Ad Social Score Monitor & Incharge: Social Awareness Skit, YouTube Advertisement, Quiz' },
            'Kotrappa K'      : { role: 'ðŸŽ­ Nukkad Pre-event + âœï¸ Handwriting Incharge', color: '#1a237e', bg: '#c5cae9', detail: 'Nukkad Natak â€” theme verification & permission slip. Also Incharge: Hand Writing' },
            'Anitha N'        : { role: 'âœï¸ Handwriting + ðŸŽ­ Talent Hunt Incharge',       color: '#1a237e', bg: '#c5cae9', detail: 'Handwriting Competition & Talent Hunt â€” attendance & sitting codes' },
            'Pooja C'         : { role: 'ðŸŽ­ Talent Hunt Incharge',                        color: '#1a237e', bg: '#c5cae9', detail: 'Talent Hunt â€” attendance & sitting codes' },
            'Dr. Shilpa R Y'  : { role: 'ðŸ“‹ Event Incharge',                     color: '#1a237e', bg: '#c5cae9', detail: 'Mad Ads, Case Analysis' },
            'Lalitha S K'     : { role: 'âœ… BOW Entry Verifier + ðŸ“‹ Event Incharge', color: '#e65100', bg: '#ffe0b2', detail: 'Best Out of Waste â€” marks participant attendance on event day (Present/Absent) for jury forwarding. Also Incharge: Interdisciplinary, Best Out of Waste' },
            'Hemavathi Desai' : { role: 'ðŸŽ™ï¸ Podcast Approval + ðŸ“‹ Event Incharge', color: '#bf360c', bg: '#ffccbc', detail: 'Pod Casting Approval Incharge, Ramp Walk, Interdisciplinary' },
            'Shankar B C'     : { role: 'âœ… BOW Verifier + ðŸŽ­ Nukkad Post-event + ðŸ“‹ Incharge', color: '#e65100', bg: '#ffe0b2', detail: 'BOW entry verification + Nukkad Natak post-event (YouTube & newspaper verify). Also Incharge: Social Awareness Skit, Nukkad Natak' },
        };

        // -- All events from Event Schedule mapped to faculty names --
        const FACULTY_EVENT_MAP = {
            'Priyanka V': [
                { name:'Mime',                  type:'On stage',  classes:"I BCA / II BCA 'B'" },
                { name:'Vlog',                  type:'Off stage', classes:'III BCOM' }
            ],
            'Roopa M.C': [
                { name:'Mad Ads',               type:'On stage',  classes:'I BCOM / I BCA' },
                { name:'YouTube Advertisement', type:'Off stage', classes:"I BCA 'A' / II BCA 'A'" },
                { name:'Case Analysis',         type:'Off stage', classes:"I BCOM / I BCA 'A'" }
            ],
            'Smitha': [
                { name:'Social Awareness Skit', type:'On stage',  classes:'III BBA / II BCA "A"' },
                { name:'YouTube Advertisement', type:'Off stage', classes:"I BCA 'A' / II BCA 'A'" },
                { name:'Quiz',               type:'Off stage', classes:'III BCA "B" / II BCA "A"' }
            ],
            'Kotrappa K': [
                { name:'Mime',               type:'On stage',  classes:"I BCA / II BCA 'B'" },
                { name:'Nukkad Natak',       type:'Off stage', classes:'II BCA "B" / III BBA' },
                { name:'Hand Writing',       type:'Off stage', classes:'III BCA "A" / III BCA "C"' }
            ],
            'Anitha N': [
                { name:'Group Dance',        type:'On stage',  classes:"III BCA 'C' / III BCA 'B'" },
                { name:'Talent Hunt',        type:'Off stage', classes:'III BCA "B" / III BCA A' },
                { name:'Hand Writing',       type:'Off stage', classes:'III BCA "A" / III BCA "C"' }
            ],
            'Pooja C': [
                { name:'Group Dance',        type:'On stage',  classes:"III BCA 'C' / III BCA 'B'" },
                { name:'Talent Hunt',        type:'Off stage', classes:'III BCA "B" / III BCA A' },
                { name:'Quiz',               type:'Off stage', classes:'III BCA "B" / II BCA "A"' }
            ],
            'Dr. Shilpa R Y': [
                { name:'Mad Ads',            type:'On stage',  classes:'I BCOM / I BCA' },
                { name:'Case Analysis',      type:'Off stage', classes:"I BCOM / I BCA 'A'" }
            ],
            'Lalitha S K': [
                { name:'Interdisciplinary',  type:'Off stage', classes:'II BBA / II BCOM' },
                { name:'Best Out of Waste',  type:'Off stage', classes:'II BCOM / III BBA' }
            ],
            'Chandan G B': [
                { name:'Ramp Walk',          type:'On stage',  classes:'II BBA / III B.Com' },
                { name:'Pod Casting',        type:'Off stage', classes:'III BCOM / II BBA' },
                { name:'Vlog',               type:'Off stage', classes:'III BCOM' }
            ],
            'Hemavathi Desai': [
                { name:'Ramp Walk',          type:'On stage',  classes:'II BBA / III B.Com' },
                { name:'Pod Casting',        type:'Off stage', classes:'III BCOM / II BBA' },
                { name:'Interdisciplinary',  type:'Off stage', classes:'II BBA / II BCOM' }
            ],
            'Shankar B C': [
                { name:'Social Awareness Skit', type:'On stage',  classes:'III BBA / II BCA "A"' },
                { name:'Nukkad Natak',       type:'Off stage', classes:'II BCA "B" / III BBA' },
                { name:'Best Out of Waste',  type:'Off stage', classes:'II BCOM / III BBA' }
            ]
        };

        function toggleFacultyAdminSection() {
            const content = document.getElementById('facultyAdminContent');
            const btn     = document.getElementById('facultyAdminToggleBtn');
            if (!content) return;
            const isHidden = content.style.display === 'none';
            content.style.display = isHidden ? 'block' : 'none';
            if (btn) btn.innerHTML = isHidden ? 'ðŸ™ˆ Hide Panel' : 'ðŸ‘ Show Panel';
        }

        async function loadFacultyAdminPanel() {
            initFacultyDropdown();

            // Load quiz passwords for all faculty phones (Super Admin only)
            const pwdMap = {};
            if (isSuperAdmin) {
                const qSnap = await db.ref('quizStudents').once('value');
                if (qSnap.exists()) qSnap.forEach(ch => {
                    const d = ch.val();
                    if (d.phone && d.password) pwdMap[String(d.phone).replace(/\D/g,'').slice(-10)] = d.password;
                });
            }

            function getPhone10(f) { return f.phone.replace(/\D/g,'').match(/\d{10}/g)?.[0] || ''; }
            function getEvents(f) { return FACULTY_EVENT_MAP[f.name] || []; }
            function eventBadges(evts) {
                if (!evts.length) return '<span style="color:#aaa;font-size:0.78em">â€”</span>';
                return evts.map(e => {
                    const bg  = e.type === 'On stage' ? '#fff3e0' : '#e8f5e9';
                    const col = e.type === 'On stage' ? '#e65100' : '#1b5e20';
                    return `<span style="display:inline-block;background:${bg};color:${col};border-radius:12px;padding:2px 8px;font-size:0.74em;font-weight:700;margin:2px 2px 2px 0;white-space:nowrap">
                        ${e.type==='On stage'?'ðŸŽ­':'ðŸ“‹'} ${e.name}
                    </span>`;
                }).join('');
            }

            // -- Cards (Super Admin) --
            const cardsGrid = document.getElementById('facultyCardsGrid');
            if (cardsGrid && isSuperAdmin) {
                cardsGrid.innerHTML = FACULTY_LIST.map(f => {
                    const r      = FACULTY_ROLES[f.name] || { role: 'â³ Role being assigned', color: '#856404', bg: '#fffde7', detail: '' };
                    const ph10   = getPhone10(f);
                    const pwd    = ph10 ? (pwdMap[ph10] || null) : null;
                    const evts   = getEvents(f);
                    const evtHtml = evts.length
                        ? evts.map(e => `<div style="font-size:0.75em;padding:2px 0;color:#333">
                            <span style="font-weight:700;color:${e.type==='On stage'?'#e65100':'#1b5e20'}">${e.type==='On stage'?'ðŸŽ­':'ðŸ“‹'} ${e.name}</span>
                            <span style="color:#888"> â€” ${e.classes}</span></div>`).join('')
                        : '<span style="color:#aaa;font-size:0.75em">No events assigned</span>';

                    return `<div style="background:white;border-radius:12px;padding:16px;border:2px solid #bbdefb;box-shadow:0 2px 8px rgba(0,0,0,0.06)">
                        <div style="display:flex;align-items:center;gap:10px;margin-bottom:10px">
                            <div style="width:40px;height:40px;border-radius:50%;background:linear-gradient(135deg,#1565c0,#42a5f5);display:flex;align-items:center;justify-content:center;color:white;font-weight:800;font-size:1em;flex-shrink:0">${f.sl}</div>
                            <div><div style="font-weight:700;color:#1565c0;font-size:0.92em">${f.name}</div><div style="color:#666;font-size:0.8em">${f.class}</div></div>
                        </div>
                        <a href="tel:+91${ph10}" style="display:flex;align-items:center;gap:6px;background:#e3f2fd;border-radius:8px;padding:7px 10px;text-decoration:none;color:#1565c0;font-size:0.82em;font-weight:700;margin-bottom:6px">ðŸ“ž ${f.phone}</a>
                        ${pwd
                            ? `<div style="background:#fff8e1;border-radius:7px;padding:5px 10px;font-size:0.78em;margin-bottom:6px;border-left:3px solid #ffc107">
                                ðŸ”‘ Quiz Password: <strong style="color:#e65100;letter-spacing:1px">${pwd}</strong></div>`
                            : `<div style="background:#f5f5f5;border-radius:7px;padding:5px 10px;font-size:0.78em;margin-bottom:6px;color:#aaa">ðŸ”‘ Not registered in quiz system</div>`
                        }
                        <div style="background:${r.bg};border-radius:8px;padding:7px 10px;border-left:3px solid ${r.color};margin-bottom:8px">
                            <div style="font-size:0.8em;font-weight:700;color:${r.color}">${r.role}</div>
                            ${r.detail ? `<div style="font-size:0.72em;color:#555;margin-top:2px">${r.detail}</div>` : ''}
                        </div>
                        <div style="background:#f8f9fa;border-radius:8px;padding:8px 10px;border:1px solid #e0e0e0">
                            <div style="font-size:0.77em;font-weight:700;color:#1565c0;margin-bottom:5px">ðŸ“… Assigned Events (${evts.length}):</div>
                            ${evtHtml}
                        </div>
                    </div>`;
                }).join('');
            } // end if(cardsGrid && isSuperAdmin)

            // -- Table (all admins) --
            const tbody = document.getElementById('facultyTableBody');
            if (!tbody) return;
            tbody.innerHTML = FACULTY_LIST.map((f, i) => {
                const bgColor= i % 2 === 0 ? '#fafafa' : 'white';
                const r      = FACULTY_ROLES[f.name] || { role: 'â³ Role being assigned', color: '#856404', bg: '#fffde7' };
                const ph10   = getPhone10(f);
                const pwdVal   = ph10 ? (pwdMap[ph10] || null) : null;
                const pwdCell  = isSuperAdmin
                    ? (pwdVal ? `<code style="background:#fff8e1;padding:2px 8px;border-radius:6px;font-size:0.95em;color:#e65100;font-weight:700">${pwdVal}</code>`
                               : '<span style="color:#aaa;font-size:0.82em">Not registered</span>')
                    : 'â€”';
                const roleEl   = `<span style="background:${r.bg};color:${r.color};padding:3px 8px;border-radius:10px;font-size:0.78em;font-weight:700">${r.role}</span>`;
                const evtBadges= eventBadges(getEvents(f));
                return `<tr style="background:${bgColor};border-bottom:1px solid #eee">
                    <td style="text-align:center;font-weight:700;color:#1565c0">${f.sl}</td>
                    <td style="font-weight:600">${f.name}</td>
                    <td style="font-size:0.85em">${f.class}</td>
                    <td class="super-admin-only" style="font-size:0.85em">
                        <a href="tel:+91${ph10}" style="color:#1565c0;text-decoration:none;font-weight:600">ðŸ“ž ${f.phone}</a>
                    </td>
                    <td class="super-admin-only" style="text-align:center;font-size:0.88em">${pwdCell}</td>
                    <td style="font-size:0.82em;line-height:1.6">${evtBadges}</td>
                    <td>${roleEl}</td>
                </tr>`;
            }).join('');
        }

        // -- Populate faculty dropdown on page load --
        function initFacultyDropdown() {
            const sel = document.getElementById('facultyLoginSelect');
            if (!sel || sel.options.length > 1) return;
            FACULTY_LIST.forEach(f => {
                const opt = document.createElement('option');
                opt.value = f.phone.replace(/[^0-9\/]/g,'');
                opt.textContent = f.name + ' â€” ' + f.class;
                opt.dataset.name = f.name;
                opt.dataset.phone = f.phone;
                sel.appendChild(opt);
            });
            // Auto-restore remembered faculty login
            if (localStorage.getItem('spurthi_faculty_remember') === '1') {
                const savedName = localStorage.getItem('spurthi_faculty_name');
                const savedPwd  = localStorage.getItem('spurthi_faculty_pwd');
                if (savedName) {
                    for (let i = 0; i < sel.options.length; i++) {
                        if (sel.options[i].dataset && sel.options[i].dataset.name === savedName) {
                            sel.selectedIndex = i;
                            facultySelectChanged();
                            break;
                        }
                    }
                }
                if (savedPwd) {
                    const pwdEl = document.getElementById('facultyLoginPwd');
                    if (pwdEl) pwdEl.value = savedPwd;
                }
                const remEl = document.getElementById('facultyRememberMe');
                if (remEl) remEl.checked = true;
            }
        }

        function facultySelectChanged() {
            const sel      = document.getElementById('facultyLoginSelect');
            const opt      = sel.options[sel.selectedIndex];
            const phoneEl  = document.getElementById('facultyLoginPhone');
            const dispEl   = document.getElementById('facultySelectedPhone');
            if (!opt || !opt.value) {
                if (phoneEl) phoneEl.value = '';
                if (dispEl)  dispEl.style.display = 'none';
                return;
            }
            // Take first 10-digit number from the phone string
            const phones   = opt.dataset.phone.replace(/[^0-9]/g,' ').trim().split(/\s+/);
            const first10  = (phones[0] || '').slice(-10);
            if (phoneEl) phoneEl.value = first10;
            if (dispEl)  { dispEl.style.display = 'block'; dispEl.textContent = 'ðŸ“ž ' + opt.dataset.phone; }
        }

        function toggleFacultyPwd() {
            const inp = document.getElementById('facultyLoginPwd');
            const btn = document.getElementById('facultyPwdToggle');
            if (!inp) return;
            if (inp.type === 'password') { inp.type = 'text';     if (btn) btn.textContent = 'ðŸ™ˆ'; }
            else                          { inp.type = 'password'; if (btn) btn.textContent = 'ðŸ‘'; }
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // FACULTY LOGIN
        // Uses quiz student DB â€” phone + password
        // Super admin password works as master override for all faculty
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        async function facultyLogin() {
            const phone = (document.getElementById('facultyLoginPhone').value || '').trim();
            const pwd   = (document.getElementById('facultyLoginPwd').value || '').trim();
            const msgEl = document.getElementById('facultyLoginMsg');

            function showMsg(text, ok) {
                msgEl.style.display = 'block';
                msgEl.style.background = ok ? '#d4edda' : '#f8d7da';
                msgEl.style.color      = ok ? '#155724' : '#721c24';
                msgEl.style.border     = ok ? '1px solid #c3e6cb' : '1px solid #f5c6cb';
                msgEl.textContent = text;
            }

            // Get selected faculty from dropdown
            const sel = document.getElementById('facultyLoginSelect');
            const selOpt = sel ? sel.options[sel.selectedIndex] : null;
            if (!selOpt || !selOpt.value) { showMsg('âŒ Please select your name from the dropdown.', false); return; }
            if (!pwd) { showMsg('âŒ Please enter your password.', false); return; }

            // Match faculty from FACULTY_LIST by name
            const selectedName = selOpt.dataset.name;
            const faculty = FACULTY_LIST.find(f => f.name === selectedName);
            if (!faculty) { showMsg('âŒ Faculty not found. Contact Super Admin.', false); return; }

            // Save remember me preference (before password check so it always saves on any valid attempt)
            const remEl = document.getElementById('facultyRememberMe');
            if (remEl && remEl.checked) {
                localStorage.setItem('spurthi_faculty_remember', '1');
                localStorage.setItem('spurthi_faculty_name', selectedName);
                localStorage.setItem('spurthi_faculty_pwd', pwd);
            } else if (remEl && !remEl.checked) {
                localStorage.removeItem('spurthi_faculty_remember');
                localStorage.removeItem('spurthi_faculty_name');
                localStorage.removeItem('spurthi_faculty_pwd');
            }

            // -- Master override: super admin OR admin password works for any faculty login --
            if (pwd === superAdminPassword || pwd === adminPassword) {
                showMsg('âœ… Welcome, ' + faculty.name + '! (Master login)', true);
                // Reset all panels first
                document.getElementById('chandanSocialPanel').style.display  = 'none';
                document.getElementById('chandanPodcastPanel').style.display = 'none';
                document.getElementById('shankarBowPanel').style.display     = 'none';
                document.getElementById('roopaSmitraYtAdPanel').style.display = 'none';
                document.getElementById('nukkadPrePanel').style.display      = 'none';
                document.getElementById('nukkadPostPanel').style.display     = 'none';
                document.getElementById('hwAttendancePanel').style.display   = 'none';
                document.getElementById('thAttendancePanel').style.display   = 'none';
                document.getElementById('danceInchargePanel').style.display  = 'none';
                document.getElementById('genericInchargePanel').style.display = 'none';
                document.getElementById('facultyComingSoon').style.display   = 'none';
                document.getElementById('facultyDashboard').style.display = 'block';
                document.getElementById('facultyDashName').textContent  = faculty.name;
                document.getElementById('facultyDashClass').textContent = faculty.class;
                const isChandan   = faculty.name === 'Chandan G B';
                const isPriyanka  = faculty.name === 'Priyanka V';
                const isHemavathi = faculty.name === 'Hemavathi Desai';
                const isShankar   = faculty.name === 'Shankar B C';
                const isLalitha   = faculty.name === 'Lalitha S K';
                const isKotrappa  = faculty.name === 'Kotrappa K';
                const isRoopa     = faculty.name === 'Roopa M.C';
                const isSmitha    = faculty.name === 'Smitha';
                const isAnitha    = faculty.name === 'Anitha N';
                const isPooja     = faculty.name === 'Pooja C';
                const hasVlogAccess    = isChandan || isPriyanka;
                const hasPodcastAccess = isChandan || isHemavathi;
                const hasYtAdAccess    = isRoopa || isSmitha;
                const hasBowAccess     = isShankar || isLalitha;
                const hasNukkadPre     = isKotrappa;
                const hasNukkadPost    = isShankar;
                const hasHandwriting   = isKotrappa || isAnitha;
                const hasTalentHunt    = isAnitha || isPooja;
                const hasDanceAccess   = isAnitha || isPooja;
                document.getElementById('chandanSocialPanel').style.display   = hasVlogAccess    ? 'block' : 'none';
                document.getElementById('chandanPodcastPanel').style.display  = hasPodcastAccess ? 'block' : 'none';
                document.getElementById('shankarBowPanel').style.display      = hasBowAccess     ? 'block' : 'none';
                document.getElementById('roopaSmitraYtAdPanel').style.display = hasYtAdAccess    ? 'block' : 'none';
                document.getElementById('nukkadPrePanel').style.display       = hasNukkadPre     ? 'block' : 'none';
                document.getElementById('nukkadPostPanel').style.display      = hasNukkadPost    ? 'block' : 'none';
                document.getElementById('hwAttendancePanel').style.display    = hasHandwriting   ? 'block' : 'none';
                document.getElementById('thAttendancePanel').style.display    = hasTalentHunt    ? 'block' : 'none';
                document.getElementById('danceInchargePanel').style.display   = hasDanceAccess   ? 'block' : 'none';
                const hasAnySpecial = hasVlogAccess || hasPodcastAccess || hasBowAccess || hasYtAdAccess || hasNukkadPre || hasNukkadPost || hasHandwriting || hasTalentHunt || hasDanceAccess;
                const hasInchargeEvents = (FACULTY_EVENT_MAP[faculty.name] || []).length > 0;
                document.getElementById('genericInchargePanel').style.display = hasInchargeEvents ? 'block' : 'none';
                document.getElementById('facultyComingSoon').style.display    = (!hasAnySpecial && !hasInchargeEvents) ? 'block' : 'none';
                const roleInfo = FACULTY_ROLES[faculty.name];
                const roleLbl = document.getElementById('facultyDashRole');
                if (roleLbl && roleInfo) roleLbl.textContent = roleInfo.role;
                if (hasVlogAccess)    loadChandanPanel();
                if (hasPodcastAccess) loadChandanPodcastPanel();
                if (hasBowAccess)     loadShankarBowPanel();
                if (hasYtAdAccess)    loadYtAdMonitorPanel();
                if (hasNukkadPre)     loadNukkadPrePanel();
                if (hasNukkadPost)    loadNukkadPostPanel();
                if (hasHandwriting)   loadHwAttendancePanel();
                if (hasTalentHunt)    loadThAttendancePanel();
                if (hasInchargeEvents) loadGenericInchargePanel(faculty.name);
                return;
            }

            // -- Normal: verify against quizStudents DB --
            const cleanPhone = (phone || '').replace(/\D/g,'').slice(-10);
            if (!cleanPhone || cleanPhone.length < 10) {
                showMsg('âŒ Phone number missing. Please re-select your name.', false); return;
            }

            showMsg('â³ Verifyingâ€¦', true);
            try {
                // Try exact 10-digit match first, then with leading 0 (some entries stored as 09xxxxxxxxx)
                let snap = await db.ref('quizStudents').orderByChild('phone').equalTo(cleanPhone).once('value');
                if (!snap.exists()) {
                    snap = await db.ref('quizStudents').orderByChild('phone').equalTo('0' + cleanPhone).once('value');
                }
                if (!snap.exists()) {
                    showMsg('âŒ Not yet registered in the quiz system. Ask Super Admin to log you in using the master password.', false);
                    return;
                }
                let matched = false;
                snap.forEach(ch => { const d = ch.val(); if (d.password === pwd) matched = true; });
                if (!matched) {
                    showMsg('âŒ Incorrect password. Use your quiz registration password, or ask Super Admin.', false);
                    return;
                }

                // Logged in
                showMsg('âœ… Welcome, ' + faculty.name + '!', true);
                // Reset all panels first so no bleed-through from previous session
                document.getElementById('chandanSocialPanel').style.display  = 'none';
                document.getElementById('chandanPodcastPanel').style.display = 'none';
                document.getElementById('shankarBowPanel').style.display     = 'none';
                document.getElementById('roopaSmitraYtAdPanel').style.display = 'none';
                document.getElementById('nukkadPrePanel').style.display      = 'none';
                document.getElementById('nukkadPostPanel').style.display     = 'none';
                document.getElementById('hwAttendancePanel').style.display   = 'none';
                document.getElementById('thAttendancePanel').style.display   = 'none';
                document.getElementById('genericInchargePanel').style.display = 'none';
                document.getElementById('facultyComingSoon').style.display   = 'none';
                document.getElementById('facultyDashboard').style.display = 'block';
                document.getElementById('facultyDashName').textContent  = faculty.name;
                document.getElementById('facultyDashClass').textContent = faculty.class;

                const isChandan   = faculty.name === 'Chandan G B';
                const isPriyanka  = faculty.name === 'Priyanka V';
                const isHemavathi = faculty.name === 'Hemavathi Desai';
                const isShankar   = faculty.name === 'Shankar B C';
                const isLalitha   = faculty.name === 'Lalitha S K';
                const isKotrappa  = faculty.name === 'Kotrappa K';
                const isRoopa     = faculty.name === 'Roopa M.C';
                const isSmitha    = faculty.name === 'Smitha';
                const isAnitha    = faculty.name === 'Anitha N';
                const isPooja     = faculty.name === 'Pooja C';
                const hasVlogAccess    = isChandan || isPriyanka;
                const hasPodcastAccess = isChandan || isHemavathi;
                const hasYtAdAccess    = isRoopa || isSmitha;
                const hasBowAccess     = isShankar || isLalitha;
                const hasNukkadPre     = isKotrappa;
                const hasNukkadPost    = isShankar;
                const hasHandwriting   = isKotrappa || isAnitha;
                const hasTalentHunt    = isAnitha || isPooja;
                const hasDanceAccess   = isAnitha || isPooja;
                document.getElementById('chandanSocialPanel').style.display   = hasVlogAccess    ? 'block' : 'none';
                document.getElementById('chandanPodcastPanel').style.display  = hasPodcastAccess ? 'block' : 'none';
                document.getElementById('shankarBowPanel').style.display      = hasBowAccess     ? 'block' : 'none';
                document.getElementById('roopaSmitraYtAdPanel').style.display = hasYtAdAccess    ? 'block' : 'none';
                document.getElementById('nukkadPrePanel').style.display       = hasNukkadPre     ? 'block' : 'none';
                document.getElementById('nukkadPostPanel').style.display      = hasNukkadPost    ? 'block' : 'none';
                document.getElementById('hwAttendancePanel').style.display    = hasHandwriting   ? 'block' : 'none';
                document.getElementById('thAttendancePanel').style.display    = hasTalentHunt    ? 'block' : 'none';
                document.getElementById('danceInchargePanel').style.display   = hasDanceAccess   ? 'block' : 'none';
                const hasAnySpecial = hasVlogAccess || hasPodcastAccess || hasBowAccess || hasYtAdAccess || hasNukkadPre || hasNukkadPost || hasHandwriting || hasTalentHunt || hasDanceAccess;
                const hasInchargeEvents = (FACULTY_EVENT_MAP[faculty.name] || []).length > 0;
                document.getElementById('genericInchargePanel').style.display = hasInchargeEvents ? 'block' : 'none';
                document.getElementById('facultyComingSoon').style.display    = (!hasAnySpecial && !hasInchargeEvents) ? 'block' : 'none';
                const roleInfo = FACULTY_ROLES[faculty.name];
                const roleLbl = document.getElementById('facultyDashRole');
                if (roleLbl && roleInfo) roleLbl.textContent = roleInfo.role;
                if (hasVlogAccess)    loadChandanPanel();
                if (hasPodcastAccess) loadChandanPodcastPanel();
                if (hasBowAccess)     loadShankarBowPanel();
                if (hasYtAdAccess)    loadYtAdMonitorPanel();
                if (hasNukkadPre)     loadNukkadPrePanel();
                if (hasNukkadPost)    loadNukkadPostPanel();
                if (hasHandwriting)   loadHwAttendancePanel();
                if (hasTalentHunt)    loadThAttendancePanel();
                if (hasDanceAccess)   loadDanceInchargePanel();
                if (hasInchargeEvents) loadGenericInchargePanel(faculty.name);

            } catch(err) {
                showMsg('âŒ Error: ' + err.message, false);
            }
        }

        function facultyLogout() {
            document.getElementById('facultyDashboard').style.display = 'none';
            const sel = document.getElementById('facultyLoginSelect');
            if (sel) sel.value = '';
            const phoneEl = document.getElementById('facultyLoginPhone');
            if (phoneEl) phoneEl.value = '';
            const dispEl  = document.getElementById('facultySelectedPhone');
            if (dispEl) dispEl.style.display = 'none';
            document.getElementById('facultyLoginPwd').value = '';
            const msg = document.getElementById('facultyLoginMsg');
            if (msg) msg.style.display = 'none';
            // Reset all functional panels
            const resetIds = ['chandanSocialPanel','chandanPodcastPanel','shankarBowPanel','roopaSmitraYtAdPanel','nukkadPrePanel','nukkadPostPanel','hwAttendancePanel','thAttendancePanel','danceInchargePanel','genericInchargePanel','facultyComingSoon'];
            resetIds.forEach(id => { const el = document.getElementById(id); if (el) el.style.display = 'none'; });
        }

        // -- Generic Event Incharge Panel -----------------------------------------
        // Shows for every faculty who has entries in FACULTY_EVENT_MAP.
        // Displays each assigned event as a card with live enrollment count from Firebase.
        async function loadGenericInchargePanel(facultyName) {
            const panel  = document.getElementById('genericInchargePanel');
            const list   = document.getElementById('genericInchargeEventList');
            const title  = document.getElementById('genericInchargePanelTitle');
            if (!panel || !list) return;

            const assignedEvents = FACULTY_EVENT_MAP[facultyName] || [];
            if (!assignedEvents.length) { panel.style.display = 'none'; return; }

            if (title) title.textContent = 'ðŸ“‹ Event Incharge Panel â€” ' + facultyName;
            panel.style.display = 'block';
            list.innerHTML = '<div style="text-align:center;color:#aaa;padding:30px">â³ Loading your eventsâ€¦</div>';

            let allEnrollments = [];
            let danceStories   = {};
            try {
                const [enrollSnap, storySnap] = await Promise.all([
                    db.ref('youthfest-enrollments').once('value'),
                    db.ref('groupDance').once('value')
                ]);
                if (enrollSnap.exists()) enrollSnap.forEach(ch => { allEnrollments.push({ id: ch.key, ...ch.val() }); });
                danceStories = storySnap.val() || {};
            } catch(e) {
                list.innerHTML = '<div style="color:#c62828;padding:16px">âŒ Error loading enrollments: ' + e.message + '</div>';
                return;
            }

            const eventColors = {
                'On stage':  { bg: '#fff3e0', border: '#ffcc80', title: '#e65100', badge: '#fff3e0', badgeText: '#e65100' },
                'Off stage': { bg: '#e8f5e9', border: '#a5d6a7', title: '#1b5e20', badge: '#e8f5e9', badgeText: '#1b5e20' }
            };

            // -- Grand summary bar across all assigned events --
            const grandTotal    = assignedEvents.reduce((s, evt) => s + allEnrollments.filter(e => (e.event||'').trim().toLowerCase() === evt.name.trim().toLowerCase()).length, 0);
            const uniqueClsAll  = new Set(allEnrollments.filter(e => assignedEvents.some(ev => ev.name.trim().toLowerCase() === (e.event||'').trim().toLowerCase())).map(e => e.classYear||e.class||''));
            let html = `<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(110px,1fr));gap:10px;margin-bottom:18px">
                <div style="background:white;border-radius:10px;padding:11px;text-align:center;border:2px solid #90caf9;box-shadow:0 1px 5px rgba(0,0,0,0.07)">
                    <div style="font-size:1.7em;font-weight:900;color:#1565c0">${assignedEvents.length}</div>
                    <div style="font-size:0.72em;color:#666;font-weight:600;margin-top:2px">Events Assigned</div>
                </div>
                <div style="background:white;border-radius:10px;padding:11px;text-align:center;border:2px solid #a5d6a7;box-shadow:0 1px 5px rgba(0,0,0,0.07)">
                    <div style="font-size:1.7em;font-weight:900;color:#2e7d32">${grandTotal}</div>
                    <div style="font-size:0.72em;color:#666;font-weight:600;margin-top:2px">Total Enrolled</div>
                </div>
                <div style="background:white;border-radius:10px;padding:11px;text-align:center;border:2px solid #ce93d8;box-shadow:0 1px 5px rgba(0,0,0,0.07)">
                    <div style="font-size:1.7em;font-weight:900;color:#6a1b9a">${uniqueClsAll.size}</div>
                    <div style="font-size:0.72em;color:#666;font-weight:600;margin-top:2px">Classes Enrolled</div>
                </div>
            </div>`;

            assignedEvents.forEach((evt, evtIdx) => {
                const col = eventColors[evt.type] || eventColors['Off stage'];
                const evtEnrollments = allEnrollments.filter(e =>
                    (e.event || '').trim().toLowerCase() === evt.name.trim().toLowerCase()
                );
                const byClass = {};
                evtEnrollments.forEach(e => {
                    const cls = e.classYear || e.class || 'Unknown';
                    if (!byClass[cls]) byClass[cls] = [];
                    byClass[cls].push(e);
                });
                const classKeys = Object.keys(byClass).sort();
                const totalCount = evtEnrollments.length;
                const cardId = 'gip_card_' + evtIdx;
                const filterId = 'gip_cf_' + evtIdx;

                // Class filter options
                const filterOpts = ['<option value="">All Classes (' + classKeys.length + ')</option>']
                    .concat(classKeys.map(c => `<option value="${c}">${c} (${byClass[c].length})</option>`)).join('');

                // Per-class rows with member list â€” collapsed by default
                const isDanceEvt = evt.name.trim().toLowerCase() === 'group dance';
                const classRowsHtml = classKeys.length
                    ? classKeys.map(cls => {
                        const members = byClass[cls];
                        const memberList = members.map((m, i) => {
                            const name  = m.name || m.memberName || m.studentName || 'â€”';
                            const role  = m.role  || '';
                            const extra = m.topic || m.talentType || m.languages || '';
                            return `<div style="display:flex;align-items:center;gap:8px;padding:5px 14px;border-bottom:1px solid #f8f8f8;font-size:0.8em">
                                <span style="min-width:20px;color:#bbb;font-weight:700">${i+1}.</span>
                                <span style="flex:1;font-weight:600;color:#333">${name}</span>
                                ${role  ? `<span style="background:#e3f2fd;color:#1565c0;padding:1px 7px;border-radius:8px;font-size:0.82em">${role}</span>` : ''}
                                ${extra ? `<span style="color:#999;font-size:0.82em">${extra}</span>` : ''}
                            </div>`;
                        }).join('');
                        // Dance story block â€” shown for Group Dance event
                        let danceStoryHtml = '';
                        if (isDanceEvt) {
                            const clsKey  = cls.replace(/[\.\[\]#$\/\s]/g, '_');
                            const story   = danceStories[clsKey] || {};
                            const savedAt = story.savedAt ? new Date(story.savedAt).toLocaleString('en-IN',{day:'2-digit',month:'short',hour:'2-digit',minute:'2-digit'}) : '';
                            danceStoryHtml = story.title
                                ? `<div style="background:linear-gradient(135deg,#fce4ec,#f8bbd0);border-top:2px solid #f48fb1;padding:12px 14px">
                                    <div style="font-size:0.72em;font-weight:700;color:#ad1457;text-transform:uppercase;letter-spacing:0.8px;margin-bottom:5px">ðŸŽ­ Dance Performance Title</div>
                                    <div style="font-weight:800;color:#880e4f;font-size:1em;margin-bottom:10px;line-height:1.4">${story.title}</div>
                                    <div style="font-size:0.72em;font-weight:700;color:#ad1457;text-transform:uppercase;letter-spacing:0.8px;margin-bottom:5px">ðŸ“ Story Summary</div>
                                    <div style="font-size:0.85em;color:#444;line-height:1.7;background:rgba(255,255,255,0.65);border-radius:6px;padding:8px 10px">${story.summary}</div>
                                    ${savedAt ? '<div style="font-size:0.71em;color:#aaa;margin-top:6px;text-align:right">ðŸ’¾ Submitted: ' + savedAt + '</div>' : ''}
                                   </div>`
                                : `<div style="background:#fff8e1;border-top:2px dashed #ffe082;padding:10px 14px;text-align:center;font-size:0.82em;color:#856404">
                                    â³ <strong>Dance Performance Title &amp; Story Summary not submitted yet</strong>
                                   </div>`;
                        }
                        return `<div class="gip_clsrow_${evtIdx}" data-cls="${cls}" style="border-bottom:1px solid #f0f0f0">
                            ${isDanceEvt ? danceStoryHtml : ''}
                            <div style="display:flex;align-items:center;justify-content:space-between;padding:8px 12px;background:#f8f9fa;cursor:pointer;user-select:none"
                                 onclick="var b=this.nextElementSibling;b.style.display=b.style.display==='none'?'block':'none';this.querySelector('.gip_arr').textContent=b.style.display==='none'?'â–¶':'â–¼'">
                                <span style="font-weight:700;color:#333;font-size:0.84em">ðŸ“š ${cls}</span>
                                <div style="display:flex;align-items:center;gap:8px">
                                    <span style="background:${col.badge};color:${col.badgeText};border-radius:20px;padding:2px 10px;font-size:0.76em;font-weight:700;border:1px solid ${col.border}">${members.length} enrolled</span>
                                    <span class="gip_arr" style="color:#888;font-size:0.8em;font-weight:700">â–¶</span>
                                </div>
                            </div>
                            <div style="display:none">${memberList}</div>
                        </div>`;
                    }).join('')
                    : `<div style="padding:16px;text-align:center;color:#aaa;font-size:0.85em">â³ No enrollments yet for this event.</div>`;

                html += `<div style="background:white;border-radius:14px;border:2px solid ${col.border};overflow:hidden;box-shadow:0 2px 8px rgba(0,0,0,0.06)">
                    <!-- Header -->
                    <div style="background:${col.bg};padding:14px 16px;border-bottom:2px solid ${col.border}">
                        <div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:8px">
                            <div>
                                <div style="font-weight:800;color:${col.title};font-size:1em">${evt.type === 'On stage' ? 'ðŸŽ­' : 'ðŸ“‹'} ${evt.name}</div>
                                <div style="font-size:0.78em;color:#666;margin-top:2px">ðŸ“Œ Classes: ${evt.classes}</div>
                            </div>
                            <div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap">
                                <span style="background:${col.badge};color:${col.badgeText};border:1.5px solid ${col.border};border-radius:16px;padding:3px 12px;font-size:0.78em;font-weight:700">${evt.type}</span>
                                <span style="background:#1565c0;color:white;border-radius:16px;padding:3px 12px;font-size:0.78em;font-weight:700">${totalCount} enrolled</span>
                                <span style="background:#6a1b9a;color:white;border-radius:16px;padding:3px 12px;font-size:0.78em;font-weight:700">${classKeys.length} classes</span>
                            </div>
                        </div>
                    </div>
                    <!-- Mini stats row -->
                    <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:0;border-bottom:1px solid #eee">
                        <div style="padding:9px;text-align:center;border-right:1px solid #eee">
                            <div style="font-size:1.3em;font-weight:900;color:#1565c0">${totalCount}</div>
                            <div style="font-size:0.7em;color:#888;font-weight:600">Total Students</div>
                        </div>
                        <div style="padding:9px;text-align:center;border-right:1px solid #eee">
                            <div style="font-size:1.3em;font-weight:900;color:#6a1b9a">${classKeys.length}</div>
                            <div style="font-size:0.7em;color:#888;font-weight:600">Classes</div>
                        </div>
                        <div style="padding:9px;text-align:center">
                            <div style="font-size:1.3em;font-weight:900;color:#2e7d32">${totalCount > 0 ? (totalCount / Math.max(classKeys.length,1)).toFixed(1) : 'â€”'}</div>
                            <div style="font-size:0.7em;color:#888;font-weight:600">Avg / Class</div>
                        </div>
                    </div>
                    <!-- Filter bar -->
                    ${classKeys.length > 1 ? `<div style="display:flex;align-items:center;gap:8px;padding:8px 12px;background:#fafafa;border-bottom:1px solid #eee;flex-wrap:wrap">
                        <span style="font-size:0.78em;font-weight:700;color:#666">ðŸ” Filter by class:</span>
                        <select id="${filterId}" onchange="(function(sel,idx){var val=sel.value;document.querySelectorAll('.gip_clsrow_'+idx).forEach(function(r){r.style.display=(!val||r.dataset.cls===val)?'':'none';});})(this,${evtIdx})"
                                style="padding:5px 10px;border:1.5px solid ${col.border};border-radius:7px;font-size:0.82em;outline:none;background:white;font-weight:600;color:#333;cursor:pointer">
                            ${filterOpts}
                        </select>
                        <button onclick="document.getElementById('${filterId}').value='';document.querySelectorAll('.gip_clsrow_${evtIdx}').forEach(function(r){r.style.display='';})"
                                style="background:#eee;border:none;border-radius:7px;padding:5px 10px;font-size:0.78em;font-weight:700;cursor:pointer;color:#555">âœ• All</button>
                        <span style="margin-left:auto;font-size:0.75em;color:#aaa">â–¶ tap a class to see members</span>
                    </div>` : `<div style="padding:6px 12px;background:#fafafa;border-bottom:1px solid #eee;font-size:0.75em;color:#aaa">â–¶ tap a class to see members</div>`}
                    <!-- Class list -->
                    <div id="${cardId}">
                        <div style="display:flex;align-items:center;padding:5px 12px;background:#f0f0f0;font-size:0.72em;font-weight:700;color:#999;border-bottom:1px solid #e8e8e8;letter-spacing:0.5px">
                            <div style="flex:1">CLASS</div>
                            <div>ENROLLED</div>
                        </div>
                        ${classRowsHtml}
                    </div>
                </div>`;
            });

            list.innerHTML = html;
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // SOCIAL SCORE FORMULA â€” Save/Load (Super Admin sets in Vlog Admin)
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        async function saveSocialFormula() {
            const formula = {
                weightViews   : parseFloat(document.getElementById('ssWeightViews').value)    || 1,
                weightLikes   : parseFloat(document.getElementById('ssWeightLikes').value)    || 3,
                weightComments: parseFloat(document.getElementById('ssWeightComments').value) || 5,
                maxRaw        : parseInt(document.getElementById('ssMaxRaw').value)            || 5000
            };
            await db.ref('vlogSettings/socialFormula').set(formula);
            const msg = document.getElementById('ssFormulaMsg');
            if (msg) { msg.style.display = 'inline'; msg.textContent = 'âœ… Formula saved!'; setTimeout(() => { msg.style.display = 'none'; }, 3000); }
        }

        async function loadSocialFormula() {
            const snap = await db.ref('vlogSettings/socialFormula').once('value');
            const f = snap.val() || { weightViews:1, weightLikes:3, weightComments:5, maxRaw:5000 };
            document.getElementById('ssWeightViews').value    = f.weightViews;
            document.getElementById('ssWeightLikes').value    = f.weightLikes;
            document.getElementById('ssWeightComments').value = f.weightComments;
            document.getElementById('ssMaxRaw').value         = f.maxRaw;
            return f;
        }

        function calcSocialScore(views, likes, comments, formula) {
            const f = formula || { weightViews:1, weightLikes:3, weightComments:5, maxRaw:5000 };
            const raw = (views * f.weightViews) + (likes * f.weightLikes) + (comments * f.weightComments);
            const pct = Math.min(50, (raw / f.maxRaw) * 50);
            return { raw, pct: +pct.toFixed(2) };
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // CHANDAN'S SOCIAL MONITOR PANEL
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        async function loadChandanPanel() {
            const listEl   = document.getElementById('chandanTeamList');
            const warnEl   = document.getElementById('chandanDateWarning');
            if (!listEl) return;
            listEl.innerHTML = '<div style="text-align:center;color:#aaa;padding:20px">Loadingâ€¦</div>';

            // Date check â€” active 02-03-2026 to 07-03-2026
            const VLOG_START = new Date('2026-03-02T00:00:00');
            const VLOG_END   = new Date('2026-03-07T23:59:59');
            const now        = new Date();
            const inWindow   = now >= VLOG_START && now <= VLOG_END;
            const afterEnd   = now > VLOG_END;

            if (warnEl) {
                warnEl.style.display = 'none'; // time lock removed for testing
            }

            try {
            // Timeout helper â€” rejects after 10 seconds
            const withTimeout = (promise, ms) => Promise.race([
                promise,
                new Promise((_, reject) => setTimeout(() => reject(new Error('timeout')), ms))
            ]);

            // Load social formula â€” fall back silently if permission denied
            let formula = { weightViews:1, weightLikes:3, weightComments:5, maxRaw:5000 };
            try {
                const fSnap = await withTimeout(db.ref('vlogSettings/socialFormula').once('value'), 8000);
                if (fSnap.val()) formula = fSnap.val();
            } catch(fe) {
                // Permission denied or timeout â€” use default formula, proceed
                console.warn('vlogSettings/socialFormula not accessible, using defaults:', fe.message);
            }

            // Load all vlog submissions
            const snap = await withTimeout(db.ref('vlogChallenge').once('value'), 10000);
            const teams = [];
            if (snap.exists()) snap.forEach(ch => teams.push({ id: ch.key, ...ch.val() }));

            if (teams.length === 0) {
                const today = now.toISOString().slice(0,10);

                // Load ALL Vlog enrollments â€” accept any class that has real enrollments
                // Use the master classes list to filter out junk/test entries
                const VALID_CLASSES_NORM = (typeof classes !== 'undefined' ? classes : []).map(c =>
                    c.toLowerCase().replace(/[.\s]/g,'')
                );
                let allCards = [];
                try {
                    const enrollSnap = await withTimeout(db.ref('youthfest-enrollments').once('value'), 8000);
                    const classBuckets = {};
                    if (enrollSnap.exists()) {
                        enrollSnap.forEach(ch => {
                            const d = ch.val();
                            if (d.event !== 'Vlog') return;
                            const rawCls = (d.classYear || d.class || '').trim();
                            if (!rawCls) return;
                            // Skip entries whose class is not in the master list (test/junk entries)
                            if (VALID_CLASSES_NORM.length > 0) {
                                const normCls = rawCls.toLowerCase().replace(/[.\s]/g,'');
                                if (!VALID_CLASSES_NORM.includes(normCls)) return;
                            }
                            if (!classBuckets[rawCls]) classBuckets[rawCls] = [];
                            classBuckets[rawCls].push(d);
                        });
                    }
                    // Fallback: if still empty, show placeholder for 3rd B.Com
                    if (Object.keys(classBuckets).length === 0) {
                        classBuckets['3rd B.Com'] = [];
                    }
                    // Pair members into teams of 2 per class (max 2 teams)
                    Object.keys(classBuckets).sort().forEach(cls => {
                        const recs = classBuckets[cls];
                        const clsLabel = cls.toUpperCase().replace(/\./g,'').replace(/\s+/g,' ');
                        if (recs.length === 0) {
                            allCards.push({ cls, clsLabel, team:{ teamNum:1, members:[], topic:'' }, safeKey: clsLabel.replace(/\s/g,'_')+'_T1' });
                            return;
                        }
                        let teamNum = 1;
                        for (let i = 0; i < recs.length && teamNum <= 2; i += 2, teamNum++) {
                            const pair = recs.slice(i, i + 2);
                            const team = {
                                teamNum,
                                members: pair.map(m => (m.name || '').trim()).filter(Boolean),
                                topic: pair[0].topic || ''
                            };
                            const safeKey = clsLabel.replace(/\s/g,'_') + '_T' + teamNum;
                            allCards.push({ cls, clsLabel, team, safeKey });
                        }
                    });
                } catch(ef) {
                    allCards = [{ cls:'3rd B.Com', clsLabel:'3RD BCOM', team:{ teamNum:1, members:[], topic:'' }, safeKey:'3RD_BCOM_T1' }];
                }

                // â”€â”€ Compact summary table (no-submission state) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                const noSubRows = allCards.map(({ clsLabel, team, safeKey }) => {
                    const memberTxt = team.members.length > 0 ? team.members.join(' & ') : '<span style="color:#bbb;font-style:italic">not enrolled yet</span>';
                    const topicTxt  = team.topic || '<span style="color:#bbb">â€”</span>';
                    return `<tr style="border-bottom:1px solid #f0e6f6">
                        <td style="padding:9px 10px;font-size:0.82em;font-weight:700;color:#4a148c;white-space:nowrap">
                            <span style="background:linear-gradient(135deg,#833ab4,#e91e63);color:white;border-radius:12px;padding:2px 9px;font-size:0.78em;font-weight:700;margin-right:6px">T${team.teamNum}</span>
                            ${clsLabel}
                        </td>
                        <td style="padding:9px 10px;font-size:0.82em;color:#333">${memberTxt}</td>
                        <td style="padding:9px 10px;font-size:0.78em;color:#9c27b0">${topicTxt}</td>
                        <td style="padding:9px 10px;font-size:0.82em;text-align:center"><span style="color:#bbb">â€”</span></td>
                        <td style="padding:9px 10px;font-size:0.82em;text-align:center;color:#bbb">â€”</td>
                        <td style="padding:9px 10px;font-size:0.82em;text-align:center;color:#bbb">â€”</td>
                        <td style="padding:9px 10px;font-size:0.82em;text-align:center;color:#bbb">â€”</td>
                        <td style="padding:9px 10px;text-align:center">
                            <span style="background:#f5f5f5;color:#aaa;border-radius:8px;padding:3px 10px;font-size:0.82em;font-weight:700">â€” / 50</span>
                        </td>
                        <td style="padding:9px 10px;text-align:center">
                            <button onclick="chandanToggleNoSubEntry('${safeKey}')"
                                    style="background:#f3e5f5;color:#6a1b9a;border:1.5px solid #ce93d8;border-radius:8px;padding:4px 12px;font-size:0.78em;font-weight:700;cursor:pointer">
                                âœï¸ Enter
                            </button>
                        </td>
                    </tr>`;
                }).join('');

                const noSubTableHtml = `
                <div style="background:white;border-radius:12px;border:2px solid #e1bee7;overflow:hidden;box-shadow:0 2px 8px rgba(0,0,0,0.06);margin-bottom:18px">
                    <div style="background:linear-gradient(135deg,#f3e5f5,#fce4ec);padding:12px 16px;border-bottom:2px solid #e1bee7;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:8px">
                        <span style="font-weight:700;color:#4a148c;font-size:0.95em">ðŸ“Š All Teams Overview â€” ${allCards.length} team${allCards.length!==1?'s':''} enrolled</span>
                        <span style="background:#fff3cd;color:#856404;border-radius:10px;padding:3px 10px;font-size:0.78em;font-weight:700">â³ No CR reel submissions yet</span>
                    </div>
                    <div style="overflow-x:auto">
                    <table style="width:100%;border-collapse:collapse;min-width:600px">
                        <thead>
                            <tr style="background:#f8f0ff">
                                <th style="padding:8px 10px;font-size:0.75em;color:#6a1b9a;text-align:left;font-weight:700;white-space:nowrap">Team / Class</th>
                                <th style="padding:8px 10px;font-size:0.75em;color:#6a1b9a;text-align:left;font-weight:700">Members</th>
                                <th style="padding:8px 10px;font-size:0.75em;color:#6a1b9a;text-align:left;font-weight:700">Topic</th>
                                <th style="padding:8px 10px;font-size:0.75em;color:#6a1b9a;text-align:center;font-weight:700">ðŸ“¸</th>
                                <th style="padding:8px 10px;font-size:0.75em;color:#6a1b9a;text-align:center;font-weight:700">ðŸ‘ Views</th>
                                <th style="padding:8px 10px;font-size:0.75em;color:#6a1b9a;text-align:center;font-weight:700">ðŸ”¥ Likes</th>
                                <th style="padding:8px 10px;font-size:0.75em;color:#6a1b9a;text-align:center;font-weight:700">ðŸ’¬ Cmts</th>
                                <th style="padding:8px 10px;font-size:0.75em;color:#6a1b9a;text-align:center;font-weight:700">Score</th>
                                <th style="padding:8px 10px;font-size:0.75em;color:#6a1b9a;text-align:center;font-weight:700">Action</th>
                            </tr>
                        </thead>
                        <tbody>${noSubRows}</tbody>
                    </table>
                    </div>
                </div>`;

                // â”€â”€ Expandable entry panels (hidden by default) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                const noSubPanels = allCards.map(({ cls, clsLabel, team, safeKey }) => {
                    const memberLine = team.members.length > 0
                        ? `<strong>${team.members.join(' &amp; ')}</strong>${team.topic ? ' &nbsp;Â·&nbsp; ðŸ“Œ ' + team.topic : ''}`
                        : '<span style="color:#bbb;font-style:italic">No enrollment yet</span>';
                    return `<div id="chandanNoSubEntry_${safeKey}" style="display:none;background:white;border-radius:12px;border:2px solid #ce93d8;padding:16px;margin-bottom:12px;box-shadow:0 2px 8px rgba(0,0,0,0.06)">
                        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;flex-wrap:wrap;gap:8px">
                            <div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap">
                                <span style="background:linear-gradient(135deg,#833ab4,#e91e63);color:white;border-radius:20px;padding:3px 12px;font-size:0.82em;font-weight:700">ðŸ“¹ ${clsLabel} â€” Team ${team.teamNum}</span>
                                <span style="font-size:0.85em;color:#4a148c">${memberLine}</span>
                            </div>
                            <button onclick="chandanToggleNoSubEntry('${safeKey}')"
                                    style="background:#fce4ec;color:#c62828;border:none;border-radius:8px;padding:4px 12px;font-size:0.78em;font-weight:700;cursor:pointer">âœ• Close</button>
                        </div>
                        <div style="background:#f8f0ff;border-radius:8px;padding:8px 12px;font-size:0.78em;color:#6a1b9a;margin-bottom:12px">
                            âš ï¸ CR hasn't submitted reel link yet â€” enter metrics once you have the numbers from the insight screenshot.
                        </div>
                        <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;margin-bottom:10px;max-width:420px">
                            <div>
                                <label style="font-size:0.72em;color:#555;font-weight:600;display:block;margin-bottom:3px">ðŸ‘ Views</label>
                                <input type="number" id="sv_views_nk_${safeKey}" min="0" placeholder="0"
                                       style="width:100%;padding:7px 8px;border:2px solid #ce93d8;border-radius:8px;font-size:0.9em;outline:none;box-sizing:border-box">
                            </div>
                            <div>
                                <label style="font-size:0.72em;color:#555;font-weight:600;display:block;margin-bottom:3px">ðŸ”¥ Likes</label>
                                <input type="number" id="sv_likes_nk_${safeKey}" min="0" placeholder="0"
                                       style="width:100%;padding:7px 8px;border:2px solid #ce93d8;border-radius:8px;font-size:0.9em;outline:none;box-sizing:border-box">
                            </div>
                            <div>
                                <label style="font-size:0.72em;color:#555;font-weight:600;display:block;margin-bottom:3px">ðŸ’¬ Comments</label>
                                <input type="number" id="sv_comments_nk_${safeKey}" min="0" placeholder="0"
                                       style="width:100%;padding:7px 8px;border:2px solid #ce93d8;border-radius:8px;font-size:0.9em;outline:none;box-sizing:border-box">
                            </div>
                        </div>
                        <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap">
                            <button onclick="saveChandanMetricsByClass('${cls}', '${safeKey}', '${team.members.join(' & ')}')"
                                    style="background:linear-gradient(135deg,#833ab4,#e91e63);color:white;border:none;border-radius:8px;padding:8px 20px;font-size:0.88em;font-weight:700;cursor:pointer">
                                ðŸ’¾ Save Score
                            </button>
                            <span id="sv_msg_nk_${safeKey}" style="font-size:0.8em;font-weight:700;display:none"></span>
                            <span style="font-size:0.72em;color:#aaa;margin-left:auto">Formula: (VÃ—${formula.weightViews}) + (LÃ—${formula.weightLikes}) + (CÃ—${formula.weightComments}) Ã· ${formula.maxRaw} Ã— 50</span>
                        </div>
                    </div>`;
                }).join('');

                // â”€â”€ Per-class accordion rows (hidden body, arrow toggle) â”€â”€
                // Group allCards by class so each class gets ONE accordion row
                const clsGroups = {};
                allCards.forEach(card => {
                    if (!clsGroups[card.cls]) clsGroups[card.cls] = { clsLabel: card.clsLabel, cards: [] };
                    clsGroups[card.cls].cards.push(card);
                });

                const accordionHtml = '<div style="margin-top:10px">' +
                    Object.keys(clsGroups).sort().map(cls => {
                        const grp      = clsGroups[cls];
                        const bodyId   = 'vlogAccBody_' + grp.clsLabel.replace(/\s/g,'_');
                        const arrowId  = 'vlogAccArrow_' + grp.clsLabel.replace(/\s/g,'_');
                        const teamCount = grp.cards.length;

                        // Build inner cards HTML for this class
                        const innerCards = grp.cards.map(({ cls: c, clsLabel, team, safeKey }) => {
                            const memberLine = team.members.length > 0
                                ? `<div style="background:#f0ebff;border-radius:8px;padding:8px 12px;font-size:0.82em;color:#4a148c;margin-bottom:10px;border-left:3px solid #9c27b0">
                                    <strong>ðŸ‘¥ Team ${team.teamNum}:</strong> ${team.members.join(' &amp; ')}${team.topic ? ' &nbsp;Â·&nbsp; ðŸ“Œ ' + team.topic : ''}
                                   </div>`
                                : '<div style="font-size:0.8em;color:#bbb;margin-bottom:10px;font-style:italic">No members enrolled yet</div>';
                            return `<div style="background:#faf6ff;border-radius:10px;border:1.5px solid #e1bee7;padding:16px;margin-bottom:10px">
                                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;flex-wrap:wrap;gap:6px">
                                    <span style="background:#e8eaf6;color:#3949ab;border-radius:16px;padding:3px 12px;font-size:0.8em;font-weight:700">Team ${team.teamNum}</span>
                                    <span style="background:#fff3cd;color:#856404;border-radius:10px;padding:3px 10px;font-size:0.75em;font-weight:700">â³ CR hasn't submitted link yet</span>
                                </div>
                                ${memberLine}
                                <div style="background:#f8f0ff;border-radius:8px;padding:8px 12px;font-size:0.78em;color:#6a1b9a;margin-bottom:12px">
                                    âš ï¸ No Instagram Reel link yet â€” enter metrics once you have the numbers.
                                </div>
                                <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;margin-bottom:10px">
                                    <div>
                                        <label style="font-size:0.72em;color:#555;font-weight:600;display:block;margin-bottom:3px">ðŸ‘ Views</label>
                                        <input type="number" id="sv_views_nk2_${safeKey}" min="0" placeholder="0"
                                               style="width:100%;padding:7px 8px;border:2px solid #ce93d8;border-radius:8px;font-size:0.9em;outline:none;box-sizing:border-box">
                                    </div>
                                    <div>
                                        <label style="font-size:0.72em;color:#555;font-weight:600;display:block;margin-bottom:3px">ðŸ”¥ Likes</label>
                                        <input type="number" id="sv_likes_nk2_${safeKey}" min="0" placeholder="0"
                                               style="width:100%;padding:7px 8px;border:2px solid #ce93d8;border-radius:8px;font-size:0.9em;outline:none;box-sizing:border-box">
                                    </div>
                                    <div>
                                        <label style="font-size:0.72em;color:#555;font-weight:600;display:block;margin-bottom:3px">ðŸ’¬ Comments</label>
                                        <input type="number" id="sv_comments_nk2_${safeKey}" min="0" placeholder="0"
                                               style="width:100%;padding:7px 8px;border:2px solid #ce93d8;border-radius:8px;font-size:0.9em;outline:none;box-sizing:border-box">
                                    </div>
                                </div>
                                <div style="background:#f8f4ff;border-radius:8px;padding:6px 12px;font-size:0.75em;color:#6a1b9a;margin-bottom:10px">
                                    Formula: (VÃ—${formula.weightViews}) + (LÃ—${formula.weightLikes}) + (CÃ—${formula.weightComments}) Ã· ${formula.maxRaw} Ã— 50
                                </div>
                                <div style="display:flex;gap:8px;align-items:center">
                                    <button onclick="saveChandanMetricsByClass('${c}', 'nk2_${safeKey}', '${team.members.join(' & ')}')"
                                            style="background:linear-gradient(135deg,#833ab4,#e91e63);color:white;border:none;border-radius:8px;padding:8px 18px;font-size:0.85em;font-weight:700;cursor:pointer">
                                        ðŸ’¾ Save Score
                                    </button>
                                    <span id="sv_msg_nk_nk2_${safeKey}" style="font-size:0.8em;font-weight:700;display:none"></span>
                                </div>
                            </div>`;
                        }).join('');

                        return `<div style="background:white;border-radius:12px;border:2px solid #f0c14b;margin-bottom:8px;overflow:hidden;box-shadow:0 1px 4px rgba(0,0,0,0.06)">
                            <!-- Accordion header row -->
                            <div onclick="toggleVlogAccordion('${bodyId}','${arrowId}')"
                                 style="display:flex;justify-content:space-between;align-items:center;padding:12px 16px;cursor:pointer;background:#fffbf0;user-select:none">
                                <div style="display:flex;align-items:center;gap:10px">
                                    <span style="font-size:1em">ðŸ“¹</span>
                                    <strong style="font-size:0.92em;color:#333">${grp.clsLabel}</strong>
                                </div>
                                <div style="display:flex;align-items:center;gap:10px">
                                    <span style="background:#ff9800;color:white;border-radius:20px;padding:3px 12px;font-size:0.78em;font-weight:700">${teamCount} team${teamCount!==1?'s':''} enrolled</span>
                                    <span id="${arrowId}" style="font-size:1.1em;color:#e65100;transition:transform 0.2s;display:inline-block">â–¶</span>
                                </div>
                            </div>
                            <!-- Accordion body â€” hidden by default -->
                            <div id="${bodyId}" style="display:none;padding:14px 16px;border-top:1.5px solid #ffe0b2">
                                ${innerCards}
                            </div>
                        </div>`;
                    }).join('') + '</div>';

                listEl.innerHTML = noSubTableHtml + noSubPanels + accordionHtml;
                return;
            }

            // â”€â”€ Summary table at top â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            const summaryRows = teams.map((t, i) => {
                const latest = t.latestSocialEntry || {};
                const { pct } = calcSocialScore(latest.views||0, latest.likes||0, latest.comments||0, formula);
                const hasScore = latest.views || latest.likes || latest.comments;
                const scoreColor = hasScore ? '#1b5e20' : '#aaa';
                const scoreBg    = hasScore ? '#e8f5e9' : '#f5f5f5';
                const hasShot = !!(t.screenshotUrl || Object.keys(t.dailyScreenshots||{}).length);
                return `<tr style="border-bottom:1px solid #f0e6f6">
                    <td style="padding:9px 10px;font-size:0.82em;font-weight:700;color:#4a148c;white-space:nowrap">
                        <span style="background:linear-gradient(135deg,#833ab4,#e91e63);color:white;border-radius:12px;padding:2px 9px;font-size:0.78em;font-weight:700;margin-right:6px">T${i+1}</span>
                        ${t.classYear||'â€”'}
                    </td>
                    <td style="padding:9px 10px;font-size:0.82em;color:#333">${t.member1||'â€”'} &amp; ${t.member2||'â€”'}</td>
                    <td style="padding:9px 10px;font-size:0.78em;color:#9c27b0">${t.topic||'â€”'}</td>
                    <td style="padding:9px 10px;font-size:0.82em;text-align:center">${hasShot ? '<span style="color:#4caf50;font-weight:700">âœ…</span>' : '<span style="color:#bbb">â€”</span>'}</td>
                    <td style="padding:9px 10px;font-size:0.82em;text-align:center;color:#555">${latest.views||'â€”'}</td>
                    <td style="padding:9px 10px;font-size:0.82em;text-align:center;color:#555">${latest.likes||'â€”'}</td>
                    <td style="padding:9px 10px;font-size:0.82em;text-align:center;color:#555">${latest.comments||'â€”'}</td>
                    <td style="padding:9px 10px;text-align:center">
                        <span style="background:${scoreBg};color:${scoreColor};border-radius:8px;padding:3px 10px;font-size:0.82em;font-weight:700">${pct} / 50</span>
                    </td>
                    <td style="padding:9px 10px;text-align:center">
                        <button onclick="chandanToggleEntry('${t.id}')"
                                style="background:#f3e5f5;color:#6a1b9a;border:1.5px solid #ce93d8;border-radius:8px;padding:4px 12px;font-size:0.78em;font-weight:700;cursor:pointer">
                            âœï¸ Enter
                        </button>
                    </td>
                </tr>`;
            }).join('');

            const tableHtml = `
            <div style="background:white;border-radius:12px;border:2px solid #e1bee7;overflow:hidden;box-shadow:0 2px 8px rgba(0,0,0,0.06);margin-bottom:18px">
                <div style="background:linear-gradient(135deg,#f3e5f5,#fce4ec);padding:12px 16px;border-bottom:2px solid #e1bee7;display:flex;justify-content:space-between;align-items:center">
                    <span style="font-weight:700;color:#4a148c;font-size:0.95em">ðŸ“Š All Teams Overview â€” ${teams.length} team${teams.length!==1?'s':''} enrolled</span>
                    <span style="font-size:0.78em;color:#888">Formula: (VÃ—${formula.weightViews}) + (LÃ—${formula.weightLikes}) + (CÃ—${formula.weightComments}) Ã· ${formula.maxRaw} Ã— 50</span>
                </div>
                <div style="overflow-x:auto">
                <table style="width:100%;border-collapse:collapse;min-width:600px">
                    <thead>
                        <tr style="background:#f8f0ff">
                            <th style="padding:8px 10px;font-size:0.75em;color:#6a1b9a;text-align:left;font-weight:700;white-space:nowrap">Team / Class</th>
                            <th style="padding:8px 10px;font-size:0.75em;color:#6a1b9a;text-align:left;font-weight:700">Members</th>
                            <th style="padding:8px 10px;font-size:0.75em;color:#6a1b9a;text-align:left;font-weight:700">Topic</th>
                            <th style="padding:8px 10px;font-size:0.75em;color:#6a1b9a;text-align:center;font-weight:700">ðŸ“¸</th>
                            <th style="padding:8px 10px;font-size:0.75em;color:#6a1b9a;text-align:center;font-weight:700">ðŸ‘ Views</th>
                            <th style="padding:8px 10px;font-size:0.75em;color:#6a1b9a;text-align:center;font-weight:700">ðŸ”¥ Likes</th>
                            <th style="padding:8px 10px;font-size:0.75em;color:#6a1b9a;text-align:center;font-weight:700">ðŸ’¬ Cmts</th>
                            <th style="padding:8px 10px;font-size:0.75em;color:#6a1b9a;text-align:center;font-weight:700">Score</th>
                            <th style="padding:8px 10px;font-size:0.75em;color:#6a1b9a;text-align:center;font-weight:700">Action</th>
                        </tr>
                    </thead>
                    <tbody>${summaryRows}</tbody>
                </table>
                </div>
            </div>`;

            // â”€â”€ Per-team expandable entry panels â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            listEl.innerHTML = teams.map((t, i) => {
                const today      = now.toISOString().slice(0,10);
                const latest     = t.latestSocialEntry || {};
                const latestDate = latest.date || 'â€”';
                const { raw, pct } = calcSocialScore(latest.views||0, latest.likes||0, latest.comments||0, formula);
                const dailyShots = t.dailyScreenshots || {};
                const dailyUrls  = Object.entries(dailyShots)
                    .sort(([a],[b]) => a.localeCompare(b))
                    .map(([dateKey, url]) => ({ label: dateKey.replace(/_/g,'-'), url }));
                const primaryUrl = t.screenshotUrl || (dailyUrls.length ? dailyUrls[dailyUrls.length-1].url : null);

                let screenshotHtml = '';
                if (primaryUrl || dailyUrls.length) {
                    screenshotHtml = '<div style="display:flex;flex-direction:column;gap:6px">';
                    if (dailyUrls.length) {
                        dailyUrls.forEach(({ label, url }) => {
                            screenshotHtml += `<a href="${url}" target="_blank" rel="noopener" style="display:inline-flex;align-items:center;gap:6px;font-size:0.78em;color:#1565c0;text-decoration:none;background:#e3f2fd;border-radius:6px;padding:4px 10px">
                                ðŸ“¸ ${label} <span style="color:#aaa;font-size:0.85em">â†— open</span></a>`;
                        });
                    } else {
                        screenshotHtml += `<a href="${primaryUrl}" target="_blank" rel="noopener" style="display:inline-flex;align-items:center;gap:6px;font-size:0.78em;color:#1565c0;text-decoration:none;background:#e3f2fd;border-radius:6px;padding:4px 10px">
                            ðŸ“¸ View Screenshot â†—</a>`;
                    }
                    screenshotHtml += '</div>';
                } else {
                    screenshotHtml = '<span style="font-size:0.78em;color:#bbb">No screenshot yet</span>';
                }

                return `<div id="chandanEntry_${t.id}" style="display:none;background:white;border-radius:12px;border:2px solid #ce93d8;padding:16px;margin-bottom:12px;box-shadow:0 2px 8px rgba(0,0,0,0.06)">
                    <!-- Header row -->
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;flex-wrap:wrap;gap:8px">
                        <div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap">
                            <span style="background:linear-gradient(135deg,#833ab4,#e91e63);color:white;border-radius:20px;padding:3px 12px;font-size:0.82em;font-weight:700">Team ${i+1}</span>
                            <strong style="font-size:0.92em;color:#222">${t.member1||'â€”'} &amp; ${t.member2||'â€”'}</strong>
                            <span style="color:#9c27b0;font-size:0.8em">ðŸ“Œ ${t.topic||'â€”'}</span>
                            <span style="background:#e8f5e9;color:#1b5e20;border-radius:10px;padding:2px 10px;font-size:0.76em;font-weight:700">${t.classYear||'â€”'}</span>
                        </div>
                        <button onclick="chandanToggleEntry('${t.id}')"
                                style="background:#fce4ec;color:#c62828;border:none;border-radius:8px;padding:4px 12px;font-size:0.78em;font-weight:700;cursor:pointer">âœ• Close</button>
                    </div>

                    <!-- Screenshot link + inline metrics form side by side -->
                    <div style="display:grid;grid-template-columns:1fr 2fr;gap:16px;align-items:start">
                        <div>
                            <div style="font-size:0.78em;font-weight:700;color:#444;margin-bottom:6px">ðŸ“¸ Screenshot</div>
                            ${screenshotHtml}
                        </div>
                        <div>
                            <div style="font-size:0.8em;font-weight:700;color:#444;margin-bottom:8px">ðŸ“ Enter Metrics <span style="color:#888;font-weight:400">(${today})</span></div>
                            <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;margin-bottom:10px">
                                <div>
                                    <label style="font-size:0.72em;color:#555;font-weight:600;display:block;margin-bottom:3px">ðŸ‘ Views</label>
                                    <input type="number" id="sv_views_${t.id}" min="0" placeholder="0" value="${latest.views||''}"
                                           style="width:100%;padding:7px 8px;border:2px solid #ce93d8;border-radius:8px;font-size:0.9em;outline:none;box-sizing:border-box">
                                </div>
                                <div>
                                    <label style="font-size:0.72em;color:#555;font-weight:600;display:block;margin-bottom:3px">ðŸ”¥ Likes</label>
                                    <input type="number" id="sv_likes_${t.id}" min="0" placeholder="0" value="${latest.likes||''}"
                                           style="width:100%;padding:7px 8px;border:2px solid #ce93d8;border-radius:8px;font-size:0.9em;outline:none;box-sizing:border-box">
                                </div>
                                <div>
                                    <label style="font-size:0.72em;color:#555;font-weight:600;display:block;margin-bottom:3px">ðŸ’¬ Comments</label>
                                    <input type="number" id="sv_comments_${t.id}" min="0" placeholder="0" value="${latest.comments||''}"
                                           style="width:100%;padding:7px 8px;border:2px solid #ce93d8;border-radius:8px;font-size:0.9em;outline:none;box-sizing:border-box">
                                </div>
                            </div>
                            <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap">
                                <button onclick="saveChandanMetrics('${t.id}')"
                                        style="background:linear-gradient(135deg,#9c27b0,#e91e63);color:white;border:none;border-radius:8px;padding:8px 20px;font-size:0.88em;font-weight:700;cursor:pointer">
                                    ðŸ’¾ Save Score
                                </button>
                                <span id="sv_msg_${t.id}" style="font-size:0.8em;font-weight:700;display:none"></span>
                                <span style="font-size:0.75em;color:#9c27b0;margin-left:auto">Last saved: <strong>${latestDate}</strong> â€” Score: <strong>${pct}/50</strong></span>
                            </div>
                        </div>
                    </div>
                </div>`;
            }).join('');

            listEl.innerHTML = tableHtml + listEl.innerHTML;
            } catch(e) {
                console.error('loadChandanPanel error:', e);
                const isPermission = e && e.message && e.message.includes('permission_denied');
                const isTimeout    = e && e.message === 'timeout';
                let msg, hint;
                if (isPermission) {
                    msg  = 'ðŸ”’ Firebase permission denied â€” your database rules block reads on <code>/vlogChallenge</code>.';
                    hint = 'ðŸ‘‰ <strong>Fix:</strong> Go to <a href="https://console.firebase.google.com/" target="_blank" style="color:#1565c0">Firebase Console</a> â†’ Realtime Database â†’ Rules â†’ change <code>".read": false</code> to <code>".read": true</code> for the <code>vlogChallenge</code> and <code>vlogSettings</code> paths, then publish. Or ask Harsha (Super Admin) to update the rules.';
                } else if (isTimeout) {
                    msg  = 'âš ï¸ Connection timed out. Check your internet and try again.';
                    hint = '';
                } else {
                    msg  = 'âš ï¸ Failed to load teams: ' + (e && e.message ? e.message : 'Unknown error');
                    hint = '';
                }
                listEl.innerHTML = `<div style="padding:24px;font-size:0.9em;background:#ffeef0;border-radius:10px;border:2px solid #f5c6cb;line-height:1.7">
                    <div style="color:#c62828;margin-bottom:10px">${msg}</div>
                    ${hint ? `<div style="color:#444;font-size:0.88em;background:#fff8e1;border-radius:8px;padding:10px 14px;border-left:4px solid #ffc107;margin-bottom:14px">${hint}</div>` : ''}
                    <button onclick="loadChandanPanel()" style="background:#9c27b0;color:white;border:none;border-radius:8px;padding:8px 18px;cursor:pointer;font-weight:700">ðŸ”„ Try Again</button>
                </div>`;
            }
        }

        function toggleLoginAccordion(bodyId, arrowId) {
            const body  = document.getElementById(bodyId);
            const arrow = document.getElementById(arrowId);
            if (!body) return;
            const isHidden = body.style.display === 'none';
            body.style.display = isHidden ? 'block' : 'none';
            if (arrow) arrow.style.transform = isHidden ? 'rotate(90deg)' : 'rotate(0deg)';
            if (isHidden) setTimeout(() => body.scrollIntoView({ behavior:'smooth', block:'start' }), 50);
        }

        function toggleVlogAccordion(bodyId, arrowId) {
            const body  = document.getElementById(bodyId);
            const arrow = document.getElementById(arrowId);
            if (!body) return;
            const isHidden = body.style.display === 'none';
            body.style.display = isHidden ? 'block' : 'none';
            if (arrow) arrow.style.transform = isHidden ? 'rotate(90deg)' : 'rotate(0deg)';
            if (isHidden) setTimeout(() => body.scrollIntoView({ behavior:'smooth', block:'nearest' }), 50);
        }

        function chandanToggleNoSubEntry(safeKey) {
            const el = document.getElementById('chandanNoSubEntry_' + safeKey);
            if (!el) return;
            const isOpen = el.style.display !== 'none';
            document.querySelectorAll('[id^="chandanNoSubEntry_"]').forEach(e => e.style.display = 'none');
            if (!isOpen) {
                el.style.display = 'block';
                setTimeout(() => el.scrollIntoView({ behavior: 'smooth', block: 'nearest' }), 50);
            }
        }

        function chandanToggleEntry(teamId) {
            const el = document.getElementById('chandanEntry_' + teamId);
            if (!el) return;
            const isOpen = el.style.display !== 'none';
            // Close all open panels first
            document.querySelectorAll('[id^="chandanEntry_"]').forEach(e => e.style.display = 'none');
            // If was closed, open this one and scroll to it
            if (!isOpen) {
                el.style.display = 'block';
                setTimeout(() => el.scrollIntoView({ behavior: 'smooth', block: 'nearest' }), 50);
            }
        }

        function toggleLoginAccordion(bodyId, arrowId) {
            const body  = document.getElementById(bodyId);
            const arrow = document.getElementById(arrowId);
            if (!body) return;
            const isHidden = body.style.display === 'none';
            body.style.display = isHidden ? 'block' : 'none';
            if (arrow) arrow.style.transform = isHidden ? 'rotate(90deg)' : 'rotate(0deg)';
            if (isHidden) setTimeout(() => body.scrollIntoView({ behavior:'smooth', block:'start' }), 50);
        }

        function toggleVlogAccordion(bodyId, arrowId) {
            const body  = document.getElementById(bodyId);
            const arrow = document.getElementById(arrowId);
            if (!body) return;
            const isHidden = body.style.display === 'none';
            body.style.display = isHidden ? 'block' : 'none';
            if (arrow) arrow.style.transform = isHidden ? 'rotate(90deg)' : 'rotate(0deg)';
            if (isHidden) setTimeout(() => body.scrollIntoView({ behavior:'smooth', block:'nearest' }), 50);
        }

        function chandanToggleNoSubEntry(safeKey) {
            const el = document.getElementById('chandanNoSubEntry_' + safeKey);
            if (!el) return;
            const isOpen = el.style.display !== 'none';
            document.querySelectorAll('[id^="chandanNoSubEntry_"]').forEach(e => e.style.display = 'none');
            if (!isOpen) {
                el.style.display = 'block';
                setTimeout(() => el.scrollIntoView({ behavior: 'smooth', block: 'nearest' }), 50);
            }
        }

        function chandanToggleEntry(teamId) {
            const el = document.getElementById('chandanEntry_' + teamId);
            if (!el) return;
            const isOpen = el.style.display !== 'none';
            document.querySelectorAll('[id^="chandanEntry_"]').forEach(e => e.style.display = 'none');
            if (!isOpen) {
                el.style.display = 'block';
                setTimeout(() => el.scrollIntoView({ behavior: 'smooth', block: 'nearest' }), 50);
            }
        }

        async function saveChandanMetrics(teamId) {
            const views    = parseInt(document.getElementById('sv_views_'   + teamId).value) || 0;
            const likes    = parseInt(document.getElementById('sv_likes_'   + teamId).value) || 0;
            const comments = parseInt(document.getElementById('sv_comments_'+ teamId).value) || 0;
            const msgEl    = document.getElementById('sv_msg_' + teamId);
            const today    = new Date().toISOString().slice(0,10);

            // Date check â€” removed for testing
            // const now   = new Date();
            // const start = new Date('2026-03-02T00:00:00');
            // const end   = new Date('2026-03-07T23:59:59');
            // if (now < start || now > end) {
            //     if (msgEl) { msgEl.style.display='inline'; msgEl.style.color='#c62828'; msgEl.textContent='âŒ Outside scoring window'; }
            //     return;
            // }

            // Load formula
            const fSnap   = await db.ref('vlogSettings/socialFormula').once('value');
            const formula = fSnap.val() || { weightViews:1, weightLikes:3, weightComments:5, maxRaw:5000 };
            const { raw, pct } = calcSocialScore(views, likes, comments, formula);

            const entry = { date: today, views, likes, comments, rawScore: raw, socialPct: pct, savedAt: new Date().toISOString() };

            // Save to socialMetrics/{date} and latestSocialEntry
            const updates = {};
            updates['socialMetrics/' + today.replace(/-/g,'_')] = entry;
            updates['latestSocialEntry'] = entry;
            updates['socialScore']       = pct; // this feeds into final score calculation

            await db.ref('vlogChallenge/' + teamId).update(updates);

            if (msgEl) {
                msgEl.style.display = 'inline'; msgEl.style.color = '#1b5e20';
                msgEl.textContent = 'âœ… Saved! Social Score: ' + pct + '/50';
                setTimeout(() => { msgEl.style.display = 'none'; }, 3000);
            }
            // Reload to refresh display
            setTimeout(loadChandanPanel, 1500);
        }

        async function saveChandanMetricsByClass(cls, inputKey, teamMembers) {
            // inputKey: element id suffix (e.g. '3RDBCOM_T1'); teamMembers: member names string
            const safeKey  = inputKey || cls.replace(/\s/g,'_');
            const views    = parseInt(document.getElementById('sv_views_nk_'    + safeKey)?.value) || 0;
            const likes    = parseInt(document.getElementById('sv_likes_nk_'    + safeKey)?.value) || 0;
            const comments = parseInt(document.getElementById('sv_comments_nk_' + safeKey)?.value) || 0;
            const msgEl    = document.getElementById('sv_msg_nk_' + safeKey);
            const today    = new Date().toISOString().slice(0,10);

            const fSnap   = await db.ref('vlogSettings/socialFormula').once('value').catch(()=>null);
            const formula = (fSnap && fSnap.val()) || { weightViews:1, weightLikes:3, weightComments:5, maxRaw:5000 };
            const { raw, pct } = calcSocialScore(views, likes, comments, formula);

            const entry = { date: today, views, likes, comments, rawScore: raw, socialPct: pct, classYear: cls, members: teamMembers || '', teamKey: safeKey, savedAt: new Date().toISOString() };

            if (msgEl) { msgEl.style.display='inline'; msgEl.style.color='#9c27b0'; msgEl.textContent='ðŸ’¾ Savingâ€¦'; }
            try {
                await db.ref('vlogClassMetrics/' + safeKey + '/' + today.replace(/-/g,'_')).set(entry);
                await db.ref('vlogClassMetrics/' + safeKey + '/latest').set(entry);
                if (msgEl) { msgEl.style.color='#1b5e20'; msgEl.textContent='âœ… Score saved! (' + pct + ' / 50)'; }
            } catch(e) {
                if (msgEl) { msgEl.style.color='#c62828'; msgEl.textContent='âŒ Error: ' + e.message; }
            }
        }

        let vlogJuryNum = null;
        let vlogJuryCriteria = [];

        async function vlogJuryLogin() {
            const num = document.getElementById('vlogJuryLoginNumber').value;
            const pwd = (document.getElementById('vlogJuryLoginPwd').value || '').trim();
            const msgEl = document.getElementById('vlogJuryLoginMsg');

            function showJMsg(text, ok) {
                msgEl.style.display = 'block';
                msgEl.style.background = ok ? '#d4edda' : '#f8d7da';
                msgEl.style.color      = ok ? '#155724' : '#721c24';
                msgEl.style.border     = ok ? '1px solid #c3e6cb' : '1px solid #f5c6cb';
                msgEl.textContent = text;
            }

            if (!pwd) { showJMsg('âŒ Please enter the jury password.', false); return; }

            const snap = await db.ref('jurySetup/Vlog').once('value');
            const setup = snap.val();
            if (!setup) { showJMsg('âŒ Jury setup not configured. Contact Super Admin.', false); return; }

            const correctPwd = setup['jury' + num + 'Password'];
            const juryName   = setup['jury' + num + 'Name'] || ('Jury ' + num);
            if (!correctPwd || pwd !== correctPwd) { showJMsg('âŒ Incorrect password.', false); return; }

            vlogJuryNum = num;
            vlogJuryCriteria = setup.criteria || ['Content Quality','Creativity & Originality','Presentation & Editing','Relevance to Topic','Engagement & Entertainment'];
            showJMsg('âœ… Logged in as ' + juryName, true);

            const panel = document.getElementById('vlogJuryScoringPanel');
            const lbl   = document.getElementById('vlogJuryWhoLabel');
            if (panel) panel.style.display = 'block';
            if (lbl)   lbl.textContent = juryName + ' (Jury ' + num + ')';

            // Populate class filter
            const snap2 = await db.ref('vlogChallenge').once('value');
            const allClasses = new Set();
            if (snap2.exists()) snap2.forEach(ch => { const d = ch.val(); if (d.classYear) allClasses.add(d.classYear); });
            const clsSel = document.getElementById('vlogJuryClassFilter');
            if (clsSel) {
                clsSel.innerHTML = '<option value="">â€” All Classes â€”</option>';
                [...allClasses].sort().forEach(c => {
                    const opt = document.createElement('option'); opt.value = c; opt.textContent = c; clsSel.appendChild(opt);
                });
            }
            loadVlogJuryScoringPanel();
        }

        async function loadVlogJuryScoringPanel() {
            if (!vlogJuryNum) return;
            const clsFilter = (document.getElementById('vlogJuryClassFilter') || {}).value || '';
            const snap = await db.ref('vlogChallenge').once('value');
            const teams = [];
            if (snap.exists()) snap.forEach(ch => teams.push({ id: ch.key, ...ch.val() }));
            const filtered = clsFilter ? teams.filter(t => t.classYear === clsFilter) : teams;
            filtered.sort((a,b) => (a.classYear||'').localeCompare(b.classYear||''));

            const cont = document.getElementById('vlogJuryScoringList');
            if (!cont) return;
            if (filtered.length === 0) { cont.innerHTML = '<p style="color:#999;text-align:center;padding:20px">No teams found.</p>'; return; }

            cont.innerHTML = filtered.map(team => {
                const existingScores = (team.juryScores && team.juryScores['j' + vlogJuryNum]) || {};
                const total = vlogJuryCriteria.reduce((s, c) => s + (+existingScores[c] || 0), 0);
                const scorePct = ((total / 50) * 50).toFixed(1);

                const criteriaRows = vlogJuryCriteria.map(c => `
                    <div style="display:flex;align-items:center;justify-content:space-between;padding:8px 0;border-bottom:1px solid #f0f0f0">
                        <span style="font-size:0.88em;color:#333;font-weight:600;flex:1">${c}</span>
                        <div style="display:flex;align-items:center;gap:6px">
                            <input type="number" min="0" max="10" value="${existingScores[c] || ''}" 
                                   id="vjScore_${team.id}_${c.replace(/\s+/g,'_')}"
                                   placeholder="0"
                                   style="width:60px;padding:6px 8px;border:2px solid #ddd;border-radius:6px;font-size:0.9em;text-align:center;outline:none"
                                   oninput="updateVlogJuryTotal('${team.id}')">
                            <span style="color:#9c27b0;font-size:0.82em;font-weight:700">/10</span>
                        </div>
                    </div>
                `).join('');

                return `<div style="background:white;border-radius:12px;border:2px solid #e0c8f5;margin-bottom:16px;overflow:hidden">
                    <div style="background:linear-gradient(135deg,#6a1b9a,#833ab4);padding:12px 16px;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:6px">
                        <div>
                            <div style="color:white;font-weight:700;font-size:0.95em">${team.member1||'â€”'} & ${team.member2||'â€”'}</div>
                            <div style="color:rgba(255,255,255,0.8);font-size:0.8em">${team.classYear} Â· ${team.topic||'â€”'}</div>
                        </div>
                        <a href="${team.link||'#'}" target="_blank" rel="noopener" style="background:rgba(255,255,255,0.2);color:white;padding:5px 12px;border-radius:20px;text-decoration:none;font-size:0.8em;font-weight:700">ðŸ“¸ View Reel</a>
                    </div>
                    <div style="padding:14px 16px">
                        ${criteriaRows}
                        <div style="display:flex;justify-content:space-between;align-items:center;margin-top:12px;padding-top:10px;border-top:2px solid #e0c8f5">
                            <div>
                                <span style="font-size:0.88em;color:#666">Total: </span>
                                <span id="vjTotal_${team.id}" style="font-size:1.2em;font-weight:800;color:#6a1b9a">${total}</span>
                                <span style="font-size:0.85em;color:#9c27b0"> / 50 â†’ </span>
                                <span id="vjPct_${team.id}" style="font-size:1em;font-weight:800;color:#e91e63">${scorePct}%</span>
                                <span style="font-size:0.78em;color:#aaa"> of final score</span>
                            </div>
                            <div style="display:flex;align-items:center;gap:8px">
                                <span style="font-size:0.78em;color:#888">Social: <strong style="color:#e91e63">${team.socialScore > 0 ? team.socialScore : 'â€”'}</strong></span>
                                <button onclick="saveVlogJuryScore('${team.id}')" style="background:linear-gradient(135deg,#4caf50,#2196f3);color:white;border:none;border-radius:8px;padding:8px 18px;cursor:pointer;font-size:0.88em;font-weight:700">ðŸ’¾ Save Score</button>
                            </div>
                        </div>
                        <div id="vjSaveMsg_${team.id}" style="display:none;margin-top:8px;font-size:0.82em;font-weight:600;padding:6px 10px;border-radius:6px"></div>
                    </div>
                </div>`;
            }).join('');
        }

        function updateVlogJuryTotal(teamId) {
            let total = 0;
            vlogJuryCriteria.forEach(c => {
                const inp = document.getElementById('vjScore_' + teamId + '_' + c.replace(/\s+/g,'_'));
                if (inp) total += Math.min(10, Math.max(0, +inp.value || 0));
            });
            const totEl = document.getElementById('vjTotal_' + teamId);
            const pctEl = document.getElementById('vjPct_' + teamId);
            if (totEl) totEl.textContent = total;
            if (pctEl) pctEl.textContent = ((total / 50) * 50).toFixed(1) + '%';
        }

        async function saveVlogJuryScore(teamId) {
            const scores = {};
            let total = 0;
            let valid = true;
            vlogJuryCriteria.forEach(c => {
                const inp = document.getElementById('vjScore_' + teamId + '_' + c.replace(/\s+/g,'_'));
                const val = inp ? Math.min(10, Math.max(0, +inp.value || 0)) : 0;
                if (inp && inp.value === '') { valid = false; }
                scores[c] = val;
                total += val;
            });
            if (!valid) { alert('Please enter scores for all criteria (0â€“10 each)'); return; }

            const juryPct = ((total / 50) * 50).toFixed(1);
            const updates = {};
            updates['juryScores/j' + vlogJuryNum] = scores;
            updates['juryTotal_j' + vlogJuryNum]  = total;
            updates['juryPct_j'   + vlogJuryNum]  = +juryPct;

            // Recalculate final score
            const snap = await db.ref('vlogChallenge/' + teamId).once('value');
            const team = snap.val() || {};
            const otherJury = vlogJuryNum === '1' ? team.juryTotal_j2 : team.juryTotal_j1;
            if (otherJury !== null && otherJury !== undefined) {
                const avgJury = ((total + otherJury) / 2);
                const avgPct  = ((avgJury / 50) * 50);
                const socialPct = team.socialScore > 0 ? Math.min(50, (team.socialScore / 1000) * 50) : 0;
                updates['finalScore'] = +(avgPct + socialPct).toFixed(1);
            }

            const msgEl = document.getElementById('vjSaveMsg_' + teamId);
            db.ref('vlogChallenge/' + teamId).update(updates).then(() => {
                msgEl.style.display = 'block';
                msgEl.style.background = '#d4edda'; msgEl.style.color = '#155724'; msgEl.style.border = '1px solid #c3e6cb';
                msgEl.textContent = 'âœ… Score saved! Total: ' + total + '/50 â†’ ' + juryPct + '% of final score';
                setTimeout(() => msgEl.style.display = 'none', 4000);
            }).catch(e => {
                msgEl.style.display = 'block';
                msgEl.style.background = '#f8d7da'; msgEl.style.color = '#721c24'; msgEl.style.border = '1px solid #f5c6cb';
                msgEl.textContent = 'âŒ Error: ' + e.message;
            });
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // POD CASTING â€” ALL FUNCTIONS
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

        // -- CR: Check event active --
        async function checkPodcastEventActive() {
            const snap = await db.ref('podcastSettings/eventActive').once('value');
            const active = snap.val() === true;
            const form = document.getElementById('podcastSubmitFormWrapper');
            const lockMsg = document.getElementById('podcastLockedMsg');
            if (!active) {
                if (form)    form.style.display = 'none';
                if (lockMsg) lockMsg.style.display = 'block';
            } else {
                if (form)    form.style.display = 'block';
                if (lockMsg) lockMsg.style.display = 'none';
                autoFillPodcastMembers();
            }
        }

        // -- CR: Load enrolled participants from youthfest-enrollments --
        async function autoFillPodcastMembers() {
            const cls      = (window.currentCRClass || crClass || '').trim();
            const listEl   = document.getElementById('podcastEnrolledList');
            const selectEl = document.getElementById('podcastParticipantSelect');
            if (!cls) {
                if (listEl) listEl.innerHTML = '<span style="color:#c62828">âš ï¸ Class not detected. Please log in again.</span>';
                return;
            }
            if (listEl)   listEl.innerHTML   = '<span style="color:#666">ðŸ”„ Loadingâ€¦</span>';
            if (selectEl) selectEl.innerHTML = '<option value="">â€” Loadingâ€¦ â€”</option>';
            try {
                const snap = await db.ref('youthfest-enrollments').once('value');
                const members = [];
                if (snap.exists()) {
                    snap.forEach(ch => {
                        const d = ch.val();
                        if (d.event === 'Pod Casting' && (d.classYear || d.class || '').trim() === cls) {
                            members.push({ ...d, _key: ch.key });
                        }
                    });
                }
                if (!members.length) {
                    if (listEl)   listEl.innerHTML   = '<span style="color:#c62828">âš ï¸ No Pod Casting enrollment found for your class. Please enroll first.</span>';
                    if (selectEl) selectEl.innerHTML = '<option value="">â€” No enrolled participants â€”</option>';
                    return;
                }
                if (listEl) {
                    listEl.innerHTML = members.map((m, i) => `
                        <div style="padding:6px 0;${i < members.length-1?'border-bottom:1px solid #c8e6c9;':''}display:flex;align-items:center;gap:10px;flex-wrap:wrap">
                            <span style="background:#e8f5e9;border-radius:20px;padding:2px 10px;font-size:0.82em;color:#1b5e20;font-weight:700">${i+1}</span>
                            <span style="font-weight:600;color:#222;font-size:0.88em">${m.name||'â€”'}</span>
                            <span style="color:#1db954;font-size:0.82em">ðŸ“Œ ${m.topic||'â€”'}</span>
                            ${m.podSubtopic?`<span style="background:#e3f2fd;color:#1565c0;border-radius:10px;padding:1px 8px;font-size:0.78em;font-weight:700">ðŸ”– Sub: ${m.podSubtopic}</span>`:'<span style="color:#aaa;font-size:0.75em;font-style:italic">Sub-topic pendingâ€¦</span>'}
                        </div>`).join('');
                }
                if (selectEl) {
                    selectEl.innerHTML = '<option value="">â€” Select participant â€”</option>' +
                        members.map((m, i) => `<option value="${i}" data-name="${m.name||''}" data-topic="${m.topic||''}" data-subtopic="${m.podSubtopic||''}" data-enrollkey="${m._key||''}">${m.name||'â€”'} â€” ${m.topic||'â€”'}${m.podSubtopic?' Â· ðŸ”– '+m.podSubtopic:''}</option>`).join('');
                }
            } catch(e) {
                if (listEl) listEl.innerHTML = '<span style="color:#c62828">âš ï¸ Error: ' + e.message + '</span>';
            }
        }

        // -- CR: Handle participant select --
        function podcastOnParticipantSelect() {
            const sel  = document.getElementById('podcastParticipantSelect');
            const opt  = sel ? sel.options[sel.selectedIndex] : null;
            const disp = document.getElementById('podcastSelectedDisplay');
            const info = document.getElementById('podcastSelectedInfo');
            const nameEl  = document.getElementById('podcastMemberName');
            const topicEl = document.getElementById('podcastMemberTopic');
            if (!opt || !opt.value) {
                if (disp) disp.style.display = 'none';
                if (nameEl)  nameEl.value = '';
                if (topicEl) topicEl.value = '';
                return;
            }
            const name  = opt.dataset.name  || '';
            const topic = opt.dataset.topic || '';
            if (nameEl)  nameEl.value  = name;
            if (topicEl) topicEl.value = topic;
            const subT = opt.dataset.subtopic || '';
            if (info) {
                info.innerHTML = name + (topic ? ' &nbsp;ðŸ“Œ <strong>' + topic + '</strong>' : '') +
                    (subT ? ' &nbsp;ðŸ”– <span style="background:#e3f2fd;color:#1565c0;border-radius:6px;padding:1px 6px;font-size:0.9em">' + subT + '</span>' : '<span style="color:#aaa;font-size:0.85em"> &nbsp;(Sub-topic not assigned yet)</span>');
            }
            if (disp) disp.style.display = 'block';
        }

        // -- CR: Submit podcast entry --
        async function submitPodcastEntry() {
            const cls     = (window.currentCRClass || crClass || '').trim();
            const name    = (document.getElementById('podcastMemberName').value  || '').trim();
            const topic   = (document.getElementById('podcastMemberTopic').value || '').trim();
            const link    = (document.getElementById('podcastLink').value        || '').trim();
            const title   = (document.getElementById('podcastTitle').value       || '').trim();
            const dur     = (document.getElementById('podcastDuration').value    || '').trim();
            const msgEl   = document.getElementById('podcastSubmitMsg');
            const btnEl   = document.getElementById('podcastSubmitBtn');
            // Get enrollmentKey and subtopic from selected option
            const selEl   = document.getElementById('podcastParticipantSelect');
            const selOpt  = selEl ? selEl.options[selEl.selectedIndex] : null;
            const enrollmentKey = selOpt ? (selOpt.dataset.enrollkey || '') : '';
            const subtopic = selOpt ? (selOpt.dataset.subtopic || '') : '';

            function showMsg(text, ok) {
                msgEl.style.display    = 'block';
                msgEl.style.background = ok ? '#d4edda' : '#f8d7da';
                msgEl.style.color      = ok ? '#155724' : '#721c24';
                msgEl.style.border     = ok ? '1px solid #c3e6cb' : '1px solid #f5c6cb';
                msgEl.textContent = text;
            }

            if (!name)  { showMsg('âŒ Please select a participant first.', false); return; }
            if (!link)  { showMsg('âŒ Please enter the Spotify link.', false); return; }
            if (!title) { showMsg('âŒ Please enter the episode title.', false); return; }
            if (!dur)   { showMsg('âŒ Please enter the episode duration.', false); return; }
            if (!link.includes('spotify.com')) { showMsg('âŒ Link must be a Spotify URL (spotify.com).', false); return; }
            if (!cls)   { showMsg('âŒ Class info missing. Please re-login.', false); return; }

            btnEl.disabled = true;
            btnEl.textContent = 'â³ Checking slotsâ€¦';

            try {
                const snap = await db.ref('podcastChallenge').orderByChild('classYear').equalTo(cls).once('value');
                const existing = [];
                if (snap.exists()) snap.forEach(ch => existing.push({ key: ch.key, ...ch.val() }));

                if (existing.length >= 3) {
                    showMsg('âŒ Your class already has 3 submissions. No more slots available.', false); return;
                }
                const alreadySubmitted = existing.find(e => e.memberName === name);
                if (alreadySubmitted) {
                    showMsg('âŒ ' + name + ' has already submitted a podcast. Only one submission per participant.', false); return;
                }

                const entry = {
                    memberName    : name,
                    topic         : topic,
                    subtopic      : subtopic,
                    link          : link,
                    episodeTitle  : title,
                    duration      : dur,
                    classYear     : cls,
                    enrollmentKey : enrollmentKey,
                    status        : 'Pending Review',
                    approvalStatus: 'pending',   // pending | approved | rejected
                    juryScore     : null,
                    finalScore    : null,
                    submittedAt   : new Date().toISOString(),
                    submittedBy   : 'CR'
                };

                btnEl.textContent = 'â³ Savingâ€¦';
                await db.ref('podcastChallenge').push(entry);
                showMsg('âœ… Podcast submitted! ' + name + ' â€” "' + title + '" registered successfully. Awaiting Chandan\'s approval.', true);
                // Show submitted date/time
                const podNow = new Date();
                const podFmted = podNow.toLocaleDateString('en-IN', {day:'2-digit',month:'short',year:'numeric'}) + ' at ' + podNow.toLocaleTimeString('en-IN', {hour:'2-digit',minute:'2-digit'});
                const podInfoEl = document.getElementById('podcastSubmittedInfo');
                const podDtEl = document.getElementById('podcastSubmittedDateTime');
                if (podInfoEl) podInfoEl.style.display = 'block';
                if (podDtEl) podDtEl.textContent = podFmted;
                clearPodcastForm();
                loadPodcastSubmissions();
            } catch(err) {
                showMsg('âŒ Error: ' + err.message, false);
            } finally {
                btnEl.disabled = false;
                btnEl.textContent = 'ðŸŽ™ï¸ Submit Podcast Link';
            }
        }

        // -- CR: Clear form --
        function clearPodcastForm() {
            ['podcastLink','podcastTitle','podcastDuration'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.value = '';
            });
            const sel  = document.getElementById('podcastParticipantSelect');
            if (sel) sel.value = '';
            const disp = document.getElementById('podcastSelectedDisplay');
            if (disp) disp.style.display = 'none';
            const nameEl  = document.getElementById('podcastMemberName');
            const topicEl = document.getElementById('podcastMemberTopic');
            if (nameEl)  nameEl.value = '';
            if (topicEl) topicEl.value = '';
        }

        // -- CR: Load submissions table --
        function loadPodcastSubmissions() {
            const cls = (window.currentCRClass || crClass || '').trim();
            const lbl = document.getElementById('podcastCRClass');
            if (lbl) lbl.textContent = cls;
            if (!cls) return;

            db.ref('podcastChallenge').orderByChild('classYear').equalTo(cls).once('value').then(snap => {
                const entries = [];
                if (snap.exists()) snap.forEach(ch => entries.push({ id: ch.key, ...ch.val() }));
                entries.sort((a, b) => new Date(a.submittedAt) - new Date(b.submittedAt));

                const badge     = document.getElementById('podcastCountBadge');
                const empty     = document.getElementById('podcastEmptyMsg');
                const container = document.getElementById('podcastTableContainer');
                const tbody     = document.getElementById('podcastTableBody');
                const slotsInfo = document.getElementById('podcastTeamSlotsInfo');

                if (badge) badge.textContent = entries.length + ' / 3 slots used';
                if (slotsInfo) {
                    if (entries.length >= 3) {
                        slotsInfo.style.background = '#fce4ec'; slotsInfo.style.borderLeftColor = '#e91e63';
                        slotsInfo.style.color = '#880e4f';
                        slotsInfo.textContent = 'ðŸš« All 3 slots are full. No more submissions allowed.';
                        const btn = document.getElementById('podcastSubmitBtn');
                        if (btn) { btn.disabled = true; btn.style.opacity = '0.5'; }
                    } else {
                        slotsInfo.style.background = '#e8f5e9'; slotsInfo.style.borderLeftColor = '#4caf50';
                        slotsInfo.style.color = '#1b5e20';
                        slotsInfo.textContent = 'âœ… ' + (3 - entries.length) + ' slot(s) remaining.';
                        const btn = document.getElementById('podcastSubmitBtn');
                        if (btn) { btn.disabled = false; btn.style.opacity = '1'; }
                    }
                }

                if (!entries.length) {
                    if (empty)     empty.style.display = 'block';
                    if (container) container.style.display = 'none';
                    return;
                }
                if (empty)     empty.style.display = 'none';
                if (container) container.style.display = 'block';

                const approvalColor = { pending:'#856404', approved:'#155724', rejected:'#721c24' };
                const approvalBg    = { pending:'#fff3cd', approved:'#d4edda', rejected:'#f8d7da' };
                let rows = '';
                entries.forEach((e, i) => {
                    const dt = e.submittedAt ? new Date(e.submittedAt).toLocaleString('en-IN',{day:'2-digit',month:'short',hour:'2-digit',minute:'2-digit'}) : 'â€”';
                    const approval = e.approvalStatus || 'pending';
                    const approvalLabel = approval === 'approved' ? 'âœ… Approved' : approval === 'rejected' ? 'âŒ Rejected' : 'â³ Pending';
                    const juryStr  = e.juryScore != null ? e.juryScore + '/100' : 'â€”';
                    rows += `<tr>
                        <td style="text-align:center;font-weight:700;color:#1db954">${i+1}</td>
                        <td style="font-size:0.85em"><strong>${e.memberName||'â€”'}</strong></td>
                        <td style="font-size:0.82em;color:#555">${e.topic||'â€”'}</td>
                        <td style="font-size:0.82em;color:#1565c0;font-weight:600">${e.subtopic||'â€”'}</td>
                        <td style="font-size:0.82em;font-weight:600;color:#1b5e20">${e.episodeTitle||'â€”'}</td>
                        <td style="text-align:center"><a href="${e.link}" target="_blank" rel="noopener" style="color:#1db954;font-weight:700;text-decoration:none;font-size:0.85em">ðŸŽµ Listen</a></td>
                        <td style="text-align:center;font-size:0.85em">${e.duration||'â€”'} min</td>
                        <td style="text-align:center"><span style="background:${approvalBg[approval]||approvalBg.pending};color:${approvalColor[approval]||approvalColor.pending};padding:3px 10px;border-radius:12px;font-size:0.75em;font-weight:700">${approvalLabel}</span></td>
                        <td style="text-align:center;font-size:0.85em">${juryStr}</td>
                        <td style="font-size:0.78em;color:#666">${dt}</td>
                    </tr>`;
                });
                if (tbody) tbody.innerHTML = rows;
            }).catch(err => console.error('Podcast load error:', err));
        }

        // -- Chandan/Hemavathi: Auto-refresh timer --
        let _podAutoRefreshTimer = null;
        function startPodAutoRefresh() {
            stopPodAutoRefresh();
            _podAutoRefreshTimer = setInterval(() => {
                // Auto-refresh Chandan/Hemavathi panel
                if (document.getElementById('chandanPodcastPanel') && document.getElementById('chandanPodcastPanel').style.display !== 'none') {
                    loadChandanPodcastPanel(true);
                }
                // Auto-refresh CR podcast page to pick up new subtopics/approval status
                const crPodTab = document.getElementById('crPodCasting');
                if (crPodTab && crPodTab.style.display !== 'none') {
                    autoFillPodcastMembers();
                }
                // Stop only if neither panel visible
                if ((!document.getElementById('chandanPodcastPanel') || document.getElementById('chandanPodcastPanel').style.display === 'none') &&
                    (!crPodTab || crPodTab.style.display === 'none')) {
                    stopPodAutoRefresh();
                }
            }, 15000); // every 15 seconds
        }
        function stopPodAutoRefresh() {
            if (_podAutoRefreshTimer) { clearInterval(_podAutoRefreshTimer); _podAutoRefreshTimer = null; }
        }

        // -- Chandan/Hemavathi: Save subtopic --
        async function savePodSubtopic(entryId, enrollmentKey) {
            const inputEl = document.getElementById('podSubtopic_' + entryId + '_' + enrollmentKey);
            const btnEl   = document.getElementById('podSubtopicBtn_' + entryId + '_' + enrollmentKey);
            const msgEl   = document.getElementById('chandanPodMsg_' + entryId + '_' + enrollmentKey);
            if (!inputEl) return;
            const val = inputEl.value.trim();
            if (!val) { if(msgEl){msgEl.style.display='block';msgEl.style.background='#fff3cd';msgEl.style.color='#856404';msgEl.textContent='âš ï¸ Please enter a subtopic first.';} return; }
            try {
                const updates = {};
                if (entryId) updates['podcastChallenge/' + entryId + '/subtopic'] = val;
                // Also write to enrollment so CR sees it
                if (enrollmentKey) updates['youthfest-enrollments/' + enrollmentKey + '/podSubtopic'] = val;
                await db.ref().update(updates);
                if (btnEl) btnEl.textContent = 'âœ… Saved';
                if (msgEl) { msgEl.style.display='block'; msgEl.style.background='#d4edda'; msgEl.style.color='#155724'; msgEl.textContent='âœ… Subtopic saved! CR can now see it (read-only).'; }
            } catch(err) {
                if (msgEl) { msgEl.style.display='block'; msgEl.style.background='#f8d7da'; msgEl.style.color='#721c24'; msgEl.textContent='âŒ Error: '+err.message; }
            }
        }

        // -- Chandan/Hemavathi: Load podcast approval panel --
        // POINT 1: Shows ALL enrolled participants (even without submission)
        // POINT 2: Compact inline approve/reject tabs
        // POINT 3: Subtopic textbox before approve/reject
        // POINT 4: Two-stage approval (enrollment stage + link submission stage)
        // POINT 7: Auto-refresh every 15s
        async function loadChandanPodcastPanel(silent) {
            const listEl = document.getElementById('chandanPodcastList');
            if (!listEl) return;
            if (!silent) listEl.innerHTML = '<div style="text-align:center;color:#aaa;padding:30px">Loadingâ€¦</div>';

            // Start auto-refresh
            startPodAutoRefresh();

            try {
                // Load ALL Pod Casting enrollments (not just submissions)
                const [enrollSnap, submitSnap] = await Promise.all([
                    db.ref('youthfest-enrollments').once('value'),
                    db.ref('podcastChallenge').once('value')
                ]);

                // Build submissions map keyed by enrollmentKey or memberName+class
                const submissions = {};
                if (submitSnap.exists()) {
                    submitSnap.forEach(ch => {
                        const d = ch.val();
                        submissions[ch.key] = { id: ch.key, ...d };
                        // Also index by enrollmentKey if stored
                        if (d.enrollmentKey) submissions[d.enrollmentKey] = { id: ch.key, ...d };
                    });
                }

                // All enrolled pod casting participants
                const enrolled = [];
                if (enrollSnap.exists()) {
                    enrollSnap.forEach(ch => {
                        const d = ch.val();
                        if (d.event === 'Pod Casting') enrolled.push({ enrollKey: ch.key, ...d });
                    });
                }

                // Build submission list from podcastChallenge for non-enrollment submissions
                const submissionList = [];
                if (submitSnap.exists()) {
                    submitSnap.forEach(ch => {
                        const d = ch.val();
                        submissionList.push({ id: ch.key, ...d });
                    });
                }

                if (!enrolled.length && !submissionList.length) {
                    listEl.innerHTML = '<div style="text-align:center;color:#aaa;padding:30px">No podcast enrollments yet.</div>';
                    return;
                }

                // Merge enrolled with their submission (match by enrollmentKey stored in submission, or memberName+class)
                const mergedMap = {};
                enrolled.forEach(e => { mergedMap[e.enrollKey] = { enr: e, sub: null }; });
                submissionList.forEach(s => {
                    const eKey = s.enrollmentKey;
                    if (eKey && mergedMap[eKey]) {
                        mergedMap[eKey].sub = s;
                    } else {
                        // Match by name+class fallback
                        const match = enrolled.find(e => (e.memberName||e.name||'').trim().toLowerCase() === (s.memberName||'').trim().toLowerCase() && (e.classYear||e.class||'').trim() === (s.classYear||'').trim());
                        if (match) mergedMap[match.enrollKey].sub = s;
                        else mergedMap['_sub_'+s.id] = { enr: null, sub: s };
                    }
                });

                const cards = Object.values(mergedMap).sort((a,b) => {
                    const ca = a.enr ? (a.enr.classYear||a.enr.class||'') : (a.sub ? a.sub.classYear||'' : '');
                    const cb = b.enr ? (b.enr.classYear||b.enr.class||'') : (b.sub ? b.sub.classYear||'' : '');
                    return ca.localeCompare(cb);
                });

                // â”€â”€ All Teams Overview table â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                // Group by class
                const overviewByClass = {};
                cards.forEach(item => {
                    const enr = item.enr || {};
                    const sub = item.sub || {};
                    const cls      = enr.classYear || enr.class || sub.classYear || 'â€”';
                    const name     = enr.memberName || enr.name || sub.memberName || 'â€”';
                    const topic    = enr.topic || sub.topic || 'â€”';
                    const subtopic = sub.subtopic || enr.podSubtopic || '';
                    const hasSubmitted = !!sub.link;
                    const rawApproval  = hasSubmitted ? (sub.approvalStatus || 'pending') : (enr.preApprovalStatus || 'pending');
                    if (!overviewByClass[cls]) overviewByClass[cls] = [];
                    overviewByClass[cls].push({ name, topic, subtopic, hasSubmitted, rawApproval });
                });

                const overviewRows = Object.keys(overviewByClass).sort().map((cls, ci) => {
                    const participants = overviewByClass[cls];
                    return participants.map((p, pi) => {
                        const statusBg    = p.rawApproval === 'approved' ? '#d4edda' : p.rawApproval === 'rejected' ? '#f8d7da' : '#fff3cd';
                        const statusColor = p.rawApproval === 'approved' ? '#155724' : p.rawApproval === 'rejected' ? '#721c24' : '#856404';
                        const statusLabel = p.rawApproval === 'approved' ? 'âœ… Approved' : p.rawApproval === 'rejected' ? 'âŒ Rejected' : 'â³ Pending';
                        const linkBadge   = p.hasSubmitted
                            ? '<span style="background:#e3f2fd;color:#1565c0;border-radius:8px;padding:2px 8px;font-size:0.72em;font-weight:700">ðŸ“¤ Link Submitted</span>'
                            : '<span style="background:#fff3cd;color:#856404;border-radius:8px;padding:2px 8px;font-size:0.72em;font-weight:700">â³ Awaiting</span>';
                        const subtopicCell = p.subtopic
                            ? `<span style="background:#e3f2fd;color:#1565c0;border-radius:8px;padding:2px 8px;font-size:0.75em;font-weight:700">ðŸ”– ${p.subtopic}</span>`
                            : '<span style="color:#bbb;font-size:0.75em;font-style:italic">Not assigned</span>';
                        const rowBg = ci % 2 === 0 ? '#fafafa' : 'white';
                        return `<tr style="border-bottom:1px solid #f0f0f0;background:${rowBg}">
                            ${pi === 0 ? `<td rowspan="${participants.length}" style="padding:9px 10px;font-size:0.82em;font-weight:700;color:#1b5e20;white-space:nowrap;border-right:2px solid #e8f5e9;vertical-align:middle">
                                <span style="background:linear-gradient(135deg,#1db954,#191414);color:white;border-radius:10px;padding:2px 9px;font-size:0.75em;font-weight:700;display:inline-block;margin-bottom:3px">${cls}</span><br>
                                <span style="font-size:0.72em;color:#888">${participants.length} participant${participants.length!==1?'s':''}</span>
                            </td>` : ''}
                            <td style="padding:8px 10px;font-size:0.82em;color:#333;font-weight:600">${p.name}</td>
                            <td style="padding:8px 10px;font-size:0.78em;color:#1db954;font-weight:600">${p.topic}</td>
                            <td style="padding:8px 10px;font-size:0.78em">${subtopicCell}</td>
                            <td style="padding:8px 10px;text-align:center">${linkBadge}</td>
                            <td style="padding:8px 10px;text-align:center">
                                <span style="background:${statusBg};color:${statusColor};border-radius:8px;padding:3px 10px;font-size:0.75em;font-weight:700">${statusLabel}</span>
                            </td>
                        </tr>`;
                    }).join('');
                }).join('');

                const totalEnrolled   = cards.length;
                const totalSubmitted  = cards.filter(c => !!(c.sub && c.sub.link)).length;
                const totalApproved   = cards.filter(c => {
                    const sub = c.sub || {}, enr = c.enr || {};
                    const raw = sub.link ? (sub.approvalStatus||'pending') : (enr.preApprovalStatus||'pending');
                    return raw === 'approved';
                }).length;

                const overviewHtml = `
                <div style="background:white;border-radius:12px;border:2px solid #a5d6a7;overflow:hidden;box-shadow:0 2px 8px rgba(0,0,0,0.06);margin-bottom:20px">
                    <div style="background:linear-gradient(135deg,#e8f5e9,#e3f2fd);padding:12px 16px;border-bottom:2px solid #a5d6a7;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:8px">
                        <span style="font-weight:700;color:#1b5e20;font-size:0.95em">ðŸ“Š All Teams Overview â€” ${totalEnrolled} participant${totalEnrolled!==1?'s':''} enrolled</span>
                        <div style="display:flex;gap:8px;flex-wrap:wrap">
                            <span style="background:#e3f2fd;color:#1565c0;border-radius:10px;padding:3px 10px;font-size:0.78em;font-weight:700">ðŸ“¤ ${totalSubmitted} Submitted</span>
                            <span style="background:#d4edda;color:#155724;border-radius:10px;padding:3px 10px;font-size:0.78em;font-weight:700">âœ… ${totalApproved} Approved</span>
                        </div>
                    </div>
                    <div style="overflow-x:auto">
                    <table style="width:100%;border-collapse:collapse;min-width:500px">
                        <thead>
                            <tr style="background:#f1f8f1">
                                <th style="padding:8px 10px;font-size:0.75em;color:#1b5e20;text-align:left;font-weight:700;white-space:nowrap;border-right:2px solid #e8f5e9">Class</th>
                                <th style="padding:8px 10px;font-size:0.75em;color:#1b5e20;text-align:left;font-weight:700">Participant</th>
                                <th style="padding:8px 10px;font-size:0.75em;color:#1b5e20;text-align:left;font-weight:700">Topic</th>
                                <th style="padding:8px 10px;font-size:0.75em;color:#1b5e20;text-align:left;font-weight:700">ðŸ”– Sub-topic</th>
                                <th style="padding:8px 10px;font-size:0.75em;color:#1b5e20;text-align:center;font-weight:700">Link</th>
                                <th style="padding:8px 10px;font-size:0.75em;color:#1b5e20;text-align:center;font-weight:700">Status</th>
                            </tr>
                        </thead>
                        <tbody>${overviewRows || '<tr><td colspan="6" style="text-align:center;padding:20px;color:#aaa">No enrollments yet</td></tr>'}</tbody>
                    </table>
                    </div>
                </div>`;

                listEl.innerHTML = overviewHtml + '<div style="margin-top:8px;margin-bottom:8px;font-weight:700;color:#555;font-size:0.88em">ðŸŽ™ï¸ Individual Cards â€” Sub-topic & Approval</div>' + cards.map((item, i) => {
                    const enr = item.enr || {};
                    const sub = item.sub || {};
                    const entryId    = sub.id || '';
                    const enrollKey  = enr.enrollKey || '';
                    const name       = enr.memberName || enr.name || sub.memberName || 'â€”';
                    const cls        = enr.classYear  || enr.class || sub.classYear || 'â€”';
                    const topic      = enr.topic || sub.topic || 'â€”';
                    const subtopic   = sub.subtopic || enr.podSubtopic || '';
                    const hasSubmitted = !!sub.link;

                    // Approval status: from submission if submitted, else from pre-approval on enrollment
                    const rawApproval = hasSubmitted ? (sub.approvalStatus || 'pending') : (enr.preApprovalStatus || 'pending');
                    const linkApproval = rawApproval;
                    const linkApprovalColor = linkApproval==='approved'?'#155724':linkApproval==='rejected'?'#721c24':'#856404';
                    const linkApprovalBg    = linkApproval==='approved'?'#d4edda':linkApproval==='rejected'?'#f8d7da':'#fff3cd';
                    const linkApprovalLabel = linkApproval==='approved'?'âœ… Approved':linkApproval==='rejected'?'âŒ Rejected':'â³ Pending Review';

                    const borderColor = linkApproval==='approved'?'#a5d6a7':linkApproval==='rejected'?'#f5c6cb':hasSubmitted?'#90caf9':'#ffe0b2';

                    const submittedDt = sub.submittedAt ? new Date(sub.submittedAt).toLocaleString('en-IN',{day:'2-digit',month:'short',hour:'2-digit',minute:'2-digit'}) : '';

                    // Sub-topic row: show read-only if saved, editable if not (or in edit mode)
                    const stDisplay = subtopic
                        ? `<span id="podStDisplay_${entryId}_${enrollKey}" style="background:#e3f2fd;color:#1565c0;border-radius:7px;padding:4px 10px;font-size:0.82em;font-weight:700;white-space:nowrap">ðŸ”– ${subtopic}</span>
                           <button onclick="podToggleSubtopicEdit('${entryId}','${enrollKey}')" style="background:#7b1fa2;color:white;border:none;border-radius:7px;padding:4px 10px;font-size:0.75em;font-weight:700;cursor:pointer">âœï¸ Edit</button>
                           <span id="podStEdit_${entryId}_${enrollKey}" style="display:none;display:none;align-items:center;gap:6px">
                               <input type="text" id="podSubtopic_${entryId}_${enrollKey}" value="${subtopic}" placeholder="Enter sub-topicâ€¦" style="flex:1;min-width:100px;padding:4px 8px;border:1.5px solid #ce93d8;border-radius:7px;font-size:0.82em;outline:none">
                               <button id="podSubtopicBtn_${entryId}_${enrollKey}" onclick="savePodSubtopic('${entryId}','${enrollKey}')" style="background:#7b1fa2;color:white;border:none;border-radius:7px;padding:4px 10px;font-size:0.75em;font-weight:700;cursor:pointer">ðŸ’¾ Save</button>
                           </span>`
                        : `<input type="text" id="podSubtopic_${entryId}_${enrollKey}" value="" placeholder="Enter sub-topicâ€¦" style="flex:1;min-width:120px;padding:4px 8px;border:1.5px solid #ce93d8;border-radius:7px;font-size:0.82em;outline:none">
                           <button id="podSubtopicBtn_${entryId}_${enrollKey}" onclick="savePodSubtopic('${entryId}','${enrollKey}')" style="background:#7b1fa2;color:white;border:none;border-radius:7px;padding:4px 10px;font-size:0.75em;font-weight:700;cursor:pointer">ðŸ’¾ Save</button>`;

                    // Approve/Reject â€” ALWAYS shown (not gated by link submission)
                    const approveRejectHtml = `<div style="display:flex;gap:4px;align-items:center;flex-wrap:wrap">
                        <button onclick="chandanApprovePodcast('${entryId||''}','${enrollKey}','approved')"
                            style="background:${linkApproval==='approved'?'#2e7d32':'#4caf50'};color:white;border:none;border-radius:6px;padding:5px 14px;font-size:0.8em;font-weight:700;cursor:pointer;${linkApproval==='approved'?'box-shadow:0 0 0 2px #1b5e20':''}">
                            âœ… Approve</button>
                        <button onclick="chandanApprovePodcast('${entryId||''}','${enrollKey}','rejected')"
                            style="background:${linkApproval==='rejected'?'#b71c1c':'#f44336'};color:white;border:none;border-radius:6px;padding:5px 14px;font-size:0.8em;font-weight:700;cursor:pointer;${linkApproval==='rejected'?'box-shadow:0 0 0 2px #7f0000':''}">
                            âŒ Reject</button>
                        ${hasSubmitted
                            ? `<span style="background:${linkApprovalBg};color:${linkApprovalColor};border-radius:6px;padding:4px 10px;font-size:0.75em;font-weight:700">${linkApprovalLabel}</span>`
                            : '<span style="color:#aaa;font-size:0.75em;font-style:italic">â³ No link yet</span>'}
                    </div>`;

                    return `<div style="background:white;border-radius:12px;border:2px solid ${borderColor};padding:14px 16px;box-shadow:0 2px 8px rgba(0,0,0,0.05)">

                        <!-- Header row -->
                        <div style="display:flex;align-items:center;flex-wrap:wrap;gap:8px;margin-bottom:10px">
                            <span style="background:linear-gradient(135deg,#1db954,#191414);color:white;border-radius:20px;padding:2px 10px;font-size:0.78em;font-weight:700">#${i+1}</span>
                            <strong style="font-size:0.92em;color:#111">${name}</strong>
                            <span style="background:#e8f5e9;color:#1b5e20;border-radius:10px;padding:2px 10px;font-size:0.75em;font-weight:700">${cls}</span>
                            <span style="color:#1db954;font-size:0.78em;font-weight:600">ðŸ“Œ ${topic}</span>
                            <span style="margin-left:auto;background:${hasSubmitted?'#e3f2fd':'#fff3cd'};color:${hasSubmitted?'#1565c0':'#856404'};border-radius:10px;padding:2px 10px;font-size:0.75em;font-weight:700">
                                ${hasSubmitted ? 'ðŸ“¤ Link Submitted' : 'â³ Awaiting Link'}
                            </span>
                        </div>

                        <!-- Sub-topic row + Approve/Reject on same line -->
                        <div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap;margin-bottom:${hasSubmitted?'10px':'0'};background:#f3e5f5;border-radius:8px;padding:8px 12px">
                            <label style="font-size:0.78em;font-weight:700;color:#6a1b9a;white-space:nowrap">ðŸ”– Sub-topic:</label>
                            <div style="display:flex;align-items:center;gap:6px;flex:1;flex-wrap:wrap">
                                ${stDisplay}
                            </div>
                            <div style="margin-left:auto">${approveRejectHtml}</div>
                        </div>

                        <!-- Submission details (if submitted) -->
                        ${hasSubmitted ? `
                        <div style="background:#f8f9fa;border-radius:8px;padding:10px 12px;display:flex;align-items:center;gap:10px;flex-wrap:wrap;margin-top:4px">
                            <div style="flex:1;min-width:180px">
                                <div style="font-size:0.82em;font-weight:700;color:#333">ðŸŽµ "${sub.episodeTitle||'â€”'}" Â· â± ${sub.duration||'â€”'} min</div>
                                ${submittedDt ? `<div style="font-size:0.72em;color:#888;margin-top:2px">ðŸ•’ ${submittedDt}</div>` : ''}
                            </div>
                            <a href="${sub.link}" target="_blank" rel="noopener"
                                style="display:inline-flex;align-items:center;gap:6px;background:#1db954;color:white;padding:6px 14px;border-radius:20px;text-decoration:none;font-size:0.8em;font-weight:700;white-space:nowrap">
                                ðŸŽµ Listen on Spotify
                            </a>
                        </div>` : ''}

                        <div id="chandanPodMsg_${entryId}_${enrollKey}" style="display:none;margin-top:6px;font-size:0.8em;font-weight:600;padding:5px 10px;border-radius:6px"></div>
                    </div>`;
                }).join('');

            } catch(err) {
                listEl.innerHTML = `<div style="padding:20px;color:#c62828">âŒ Error: \${err.message}</div>`;
            }
        }

        // -- Chandan/Hemavathi: Approve / Reject a podcast submission --
        async function chandanApprovePodcast(entryId, enrollKey, decision) {
            const msgEl = document.getElementById('chandanPodMsg_' + entryId + '_' + enrollKey) ||
                          document.querySelector('[id^="chandanPodMsg_"]');
            try {
                const facultyName = (document.getElementById('facultyDashName')||{}).textContent || 'Coordinator';
                const updateData = {
                    approvalStatus : decision,
                    approvedBy     : facultyName,
                    approvedAt     : new Date().toISOString(),
                    status         : decision === 'approved' ? 'Approved â€” Forwarded to Jury' : 'Rejected'
                };
                if (entryId) {
                    // Has a submission entry â€” update it
                    await db.ref('podcastChallenge/' + entryId).update(updateData);
                } else if (enrollKey) {
                    // No submission yet â€” write approval status to enrollment directly
                    await db.ref('youthfest-enrollments/' + enrollKey).update({
                        preApprovalStatus : decision,
                        preApprovedBy     : facultyName,
                        preApprovedAt     : new Date().toISOString()
                    });
                } else {
                    alert('Cannot approve â€” no submission or enrollment key found.');
                    return;
                }
                if (msgEl) {
                    msgEl.style.display = 'block';
                    msgEl.style.background = decision === 'approved' ? '#d4edda' : '#f8d7da';
                    msgEl.style.color = decision === 'approved' ? '#155724' : '#721c24';
                    msgEl.textContent = decision === 'approved' ? 'âœ… Approved!' : 'âŒ Rejected';
                }
                setTimeout(() => loadChandanPodcastPanel(true), 800);
            } catch(err) {
                if (msgEl) { msgEl.style.display='block'; msgEl.style.background='#f8d7da'; msgEl.style.color='#721c24'; msgEl.textContent='âŒ Error: '+err.message; }
                else alert('âŒ Error: ' + err.message);
            }
        }

        // -- Chandan/Hemavathi: Toggle subtopic edit mode --
        function podToggleSubtopicEdit(entryId, enrollKey) {
            const displayEl = document.getElementById('podStDisplay_' + entryId + '_' + enrollKey);
            const editEl    = document.getElementById('podStEdit_'    + entryId + '_' + enrollKey);
            if (!displayEl || !editEl) return;
            const isEditing = editEl.style.display === 'flex';
            displayEl.style.display = isEditing ? 'inline-flex' : 'none';
            editEl.style.display    = isEditing ? 'none'        : 'flex';
            editEl.style.alignItems = 'center';
            editEl.style.gap        = '6px';
        }

        // -- Super Admin: Load podcast admin panel --
        async function loadPodcastAdminPanel() {
            // Load status toggles
            const snap = await db.ref('podcastSettings').once('value');
            const settings = snap.val() || {};
            const evEl   = document.getElementById('podcastStatusEventActive');
            const lbEl   = document.getElementById('podcastStatusLeaderboardPublished');
            if (evEl) evEl.textContent   = settings.eventActive          ? 'âœ… Active'    : 'ðŸ”’ Inactive';
            if (lbEl) lbEl.textContent   = settings.leaderboardPublished ? 'ðŸš€ Published' : 'ðŸ“¦ Unpublished';

            // Load all submissions
            const wrapEl = document.getElementById('podcastAdminTableWrap');
            if (!wrapEl) return;
            wrapEl.innerHTML = '<p style="color:#aaa;text-align:center;padding:20px">Loadingâ€¦</p>';
            try {
                const allSnap = await db.ref('podcastChallenge').once('value');
                const all = [];
                if (allSnap.exists()) allSnap.forEach(ch => all.push({ id: ch.key, ...ch.val() }));
                if (!all.length) { wrapEl.innerHTML = '<p style="text-align:center;color:#aaa;padding:20px">No submissions yet.</p>'; return; }
                all.sort((a,b) => (a.classYear||'').localeCompare(b.classYear||'') || new Date(a.submittedAt)-new Date(b.submittedAt));
                wrapEl.innerHTML = `
                    <div class="table-wrapper" style="margin:0">
                    <table>
                        <thead><tr>
                            <th>#</th><th>Participant</th><th>Class</th><th>Topic</th><th>Sub-topic</th>
                            <th>Episode Title</th><th>Spotify</th><th>Duration</th>
                            <th>Approval</th><th>Jury Score</th><th>Submitted</th>
                        </tr></thead>
                        <tbody>${all.map((e,i) => {
                            const approval = e.approvalStatus || 'pending';
                            const approvalColor = approval==='approved'?'#155724':approval==='rejected'?'#721c24':'#856404';
                            const approvalBg    = approval==='approved'?'#d4edda':approval==='rejected'?'#f8d7da':'#fff3cd';
                            const approvalLabel = approval==='approved'?'âœ… Approved':approval==='rejected'?'âŒ Rejected':'â³ Pending';
                            const dt = e.submittedAt ? new Date(e.submittedAt).toLocaleString('en-IN',{day:'2-digit',month:'short',hour:'2-digit',minute:'2-digit'}) : 'â€”';
                            return `<tr>
                                <td style="text-align:center;font-weight:700">${i+1}</td>
                                <td><strong>${e.memberName||'â€”'}</strong></td>
                                <td style="font-size:0.85em">${e.classYear||'â€”'}</td>
                                <td style="font-size:0.82em">${e.topic||'â€”'}</td>
                                <td style="font-size:0.82em;color:#1565c0;font-weight:600">${e.subtopic||'â€”'}</td>
                                <td style="font-size:0.82em;font-weight:600">${e.episodeTitle||'â€”'}</td>
                                <td style="text-align:center"><a href="${e.link}" target="_blank" style="color:#1db954;font-weight:700;text-decoration:none">ðŸŽµ Listen</a></td>
                                <td style="text-align:center;font-size:0.85em">${e.duration||'â€”'} min</td>
                                <td style="text-align:center"><span style="background:${approvalBg};color:${approvalColor};padding:3px 10px;border-radius:12px;font-size:0.75em;font-weight:700">${approvalLabel}</span></td>
                                <td style="text-align:center;font-size:0.85em">${e.juryScore!=null?e.juryScore+'/100':'â€”'}</td>
                                <td style="font-size:0.78em;color:#666">${dt}</td>
                            </tr>`;
                        }).join('')}</tbody>
                    </table></div>`;
            } catch(err) {
                wrapEl.innerHTML = `<p style="color:#c62828;padding:20px">âŒ Error: ${err.message}</p>`;
            }
        }

        // -- Super Admin: Toggle podcast settings --
        async function setPodcastSetting(key, value) {
            try {
                await db.ref('podcastSettings/' + key).set(value);
                loadPodcastAdminPanel();
            } catch(e) {
                alert('âŒ Error: ' + e.message);
            }
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // END POD CASTING
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•


        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // BEST OUT OF WASTE â€” SHANKAR B C â€” ENTRY VERIFICATION
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

        async function loadShankarBowPanel() {
            const listEl    = document.getElementById('shankarBowList');
            const statTotal = document.getElementById('bowStatTotal');
            const statPres  = document.getElementById('bowStatPresent');
            const statAbs   = document.getElementById('bowStatAbsent');
            const badge     = document.getElementById('bowSummaryBadge');
            const clsFilter = (document.getElementById('bowClassFilter')  || {}).value || '';
            const stFilter  = (document.getElementById('bowStatusFilter') || {}).value || '';

            if (!listEl) return;
            listEl.innerHTML = '<div style="text-align:center;color:#aaa;padding:30px">Loading entriesâ€¦</div>';

            try {
                // Load all BOW enrollments from youthfest-enrollments
                const enrollSnap = await db.ref('youthfest-enrollments').once('value');
                const entries = [];
                if (enrollSnap.exists()) {
                    enrollSnap.forEach(ch => {
                        const d = ch.val();
                        const evName = (d.event || '').toLowerCase().replace(/\s/g,'');
                        if (evName === 'bestoutofwaste' || evName === 'best out of waste' || d.event === 'Best out of Waste') {
                            entries.push({ key: ch.key, ...d });
                        }
                    });
                }

                // Load attendance records + bow registrations
                const [attSnap, regSnap] = await Promise.all([
                    db.ref('bowAttendance').once('value'),
                    db.ref('bowRegistrations').once('value')
                ]);
                const attData = attSnap.val() || {};
                // Build bowRegs map keyed by enrollmentKey
                const bowRegs = {};
                if (regSnap.exists()) {
                    regSnap.forEach(ch => {
                        const d = ch.val();
                        bowRegs[d.enrollmentKey] = { ...d, regId: ch.key };
                    });
                }

                // Populate class filter dropdown
                const clsFilterEl = document.getElementById('bowClassFilter');
                if (clsFilterEl && clsFilterEl.options.length <= 1) {
                    const classes = [...new Set(entries.map(e => e.classYear || e.class || '').filter(Boolean))].sort();
                    classes.forEach(c => {
                        const opt = document.createElement('option');
                        opt.value = c; opt.textContent = c;
                        clsFilterEl.appendChild(opt);
                    });
                }

                // Attach attendance status to each entry
                entries.forEach(e => {
                    e._attendance = attData[e.key] || { status: 'pending' };
                });

                // Stats
                const totalCount   = entries.length;
                const presentCount = entries.filter(e => e._attendance.status === 'present').length;
                const absentCount  = entries.filter(e => e._attendance.status === 'absent').length;
                if (statTotal) statTotal.textContent = totalCount;
                if (statPres)  statPres.textContent  = presentCount;
                if (statAbs)   statAbs.textContent   = absentCount;
                if (badge)     badge.textContent      = presentCount + ' Present Â· ' + absentCount + ' Absent Â· ' + (totalCount - presentCount - absentCount) + ' Pending';

                // Filter
                let filtered = entries;
                if (clsFilter) filtered = filtered.filter(e => (e.classYear || e.class || '') === clsFilter);
                if (stFilter)  filtered = filtered.filter(e => e._attendance.status === stFilter);

                // Group by class
                const byClass = {};
                filtered.forEach(e => {
                    const cls = e.classYear || e.class || 'Unknown';
                    if (!byClass[cls]) byClass[cls] = [];
                    byClass[cls].push(e);
                });

                if (!filtered.length) {
                    listEl.innerHTML = '<div style="text-align:center;color:#aaa;padding:30px;font-size:0.9em">No entries found for the selected filters.</div>';
                    return;
                }

                // -- Helper: render one participant row --
                function bowMemberRow(e, roleLabel, bgColor) {
                    const att       = e._attendance.status || 'pending';
                    const markedAt  = e._attendance.markedAt
                        ? new Date(e._attendance.markedAt).toLocaleString('en-IN',{day:'2-digit',month:'short',hour:'2-digit',minute:'2-digit'})
                        : '';
                    const attColor = att === 'present' ? '#2e7d32' : att === 'absent' ? '#c62828' : '#856404';
                    const attBg    = att === 'present' ? '#e8f5e9' : att === 'absent' ? '#fce4ec' : '#fff8e1';
                    const attLabel = att === 'present' ? 'âœ… Present' : att === 'absent' ? 'âŒ Absent' : 'â³ Not Marked';
                    const reg = bowRegs[e.key] || {};
                    const finalPhoto = reg.finalPhotoUrl;
                    const photoThumb = finalPhoto
                        ? `<a href="${finalPhoto}" target="_blank" rel="noopener" style="flex-shrink:0"><img src="${finalPhoto}" style="width:48px;height:48px;object-fit:cover;border-radius:8px;border:2px solid #4caf50" alt="craft"></a>`
                        : '<span style="width:48px;height:48px;background:#fff3e0;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:1.2em;flex-shrink:0;border:2px dashed #ffe082">ðŸ“¦</span>';
                    const sentToJury = reg.sentToJury === true;
                    return `<div style="display:flex;align-items:flex-start;justify-content:space-between;flex-wrap:wrap;gap:8px;padding:10px 12px;background:${bgColor};border-radius:7px">
                        <div style="display:flex;align-items:flex-start;gap:10px;flex:1;min-width:180px">
                            ${photoThumb}
                            <div>
                                <div style="display:flex;align-items:center;gap:6px;flex-wrap:wrap">
                                    <span style="font-weight:700;color:#222;font-size:0.9em">${e.name || 'â€”'}</span>
                                    <span style="background:#e3f2fd;color:#1565c0;padding:1px 7px;border-radius:8px;font-size:0.7em;font-weight:700">${roleLabel}</span>
                                </div>
                                <div style="font-size:0.76em;color:#e65100;margin-top:2px">${reg.theme ? 'ðŸŽ¨ ' + reg.theme : '<em style="color:#aaa">No theme pre-registered</em>'}</div>
                                <div style="font-size:0.72em;color:#777;margin-top:1px">${reg.materials ? 'â™»ï¸ ' + reg.materials : ''}</div>
                                <div style="font-size:0.7em;color:#aaa;margin-top:1px">${markedAt ? 'â° ' + markedAt : ''}</div>
                                <div style="margin-top:5px;display:flex;gap:5px;flex-wrap:wrap">
                                    <span style="background:${reg.theme?'#e8f5e9':'#fce4ec'};color:${reg.theme?'#2e7d32':'#c62828'};padding:1px 7px;border-radius:7px;font-size:0.7em;font-weight:700">${reg.theme?'âœ… Pre-Registered':'âŒ Not Pre-Registered'}</span>
                                    <span style="background:${finalPhoto?'#e3f2fd':'#fff3e0'};color:${finalPhoto?'#1565c0':'#e65100'};padding:1px 7px;border-radius:7px;font-size:0.7em;font-weight:700">${finalPhoto?'ðŸ“¸ Photo Submitted':'â³ No Final Photo'}</span>
                                    ${sentToJury ? '<span style="background:#f3e5f5;color:#6a1b9a;padding:1px 7px;border-radius:7px;font-size:0.7em;font-weight:700">ðŸ“‹ Sent to Jury</span>' : ''}
                                </div>
                            </div>
                        </div>
                        <div style="display:flex;flex-direction:column;align-items:flex-end;gap:5px">
                            <span style="background:${attBg};color:${attColor};padding:2px 9px;border-radius:10px;font-size:0.76em;font-weight:700">${attLabel}</span>
                            <div style="display:flex;gap:5px;flex-wrap:wrap">
                                <button onclick="shankarMarkBow('${e.key}','present')" style="background:#4caf50;color:white;border:none;border-radius:6px;padding:4px 10px;font-size:0.78em;font-weight:700;cursor:pointer;${att==='present'?'opacity:0.4;cursor:default':''}" ${att==='present'?'disabled':''}>âœ… Present</button>
                                <button onclick="shankarMarkBow('${e.key}','absent')" style="background:#f44336;color:white;border:none;border-radius:6px;padding:4px 10px;font-size:0.78em;font-weight:700;cursor:pointer;${att==='absent'?'opacity:0.4;cursor:default':''}" ${att==='absent'?'disabled':''}>âŒ Absent</button>
                                <button onclick="shankarMarkBow('${e.key}','pending')" style="background:#9e9e9e;color:white;border:none;border-radius:6px;padding:4px 7px;font-size:0.74em;cursor:pointer;${att==='pending'?'opacity:0.4;cursor:default':''}" ${att==='pending'?'disabled':''}>â†©</button>
                            </div>
                            ${finalPhoto && att==='present' && !sentToJury ? `<button onclick="shankarSendToJury('${reg.regId || ''}')" style="background:linear-gradient(135deg,#6a1b9a,#9c27b0);color:white;border:none;border-radius:6px;padding:5px 12px;font-size:0.78em;font-weight:700;cursor:pointer;width:100%">ðŸ“‹ Send to Jury</button>` : ''}
                            ${sentToJury ? '<span style="background:#f3e5f5;color:#6a1b9a;padding:3px 10px;border-radius:7px;font-size:0.76em;font-weight:700">ðŸ“‹ Sent to Jury âœ…</span>' : ''}
                        </div>
                        <div id="bowMsg_${e.key}" style="display:none;width:100%;font-size:0.76em;font-weight:600;padding:4px 10px;border-radius:6px;margin-top:3px"></div>
                    </div>`;
                }

                // -- Helper: group members into teams --
                function groupIntoTeams(members) {
                    const teams = [];
                    const hasTeamNum = members.some(m => m.teamNum != null);
                    if (hasTeamNum) {
                        // Group by teamNum (new enrollments)
                        const byTeamNum = {};
                        members.forEach(m => {
                            const tn = m.teamNum != null ? m.teamNum : 'solo_' + m.key;
                            if (!byTeamNum[tn]) byTeamNum[tn] = [];
                            byTeamNum[tn].push(m);
                        });
                        Object.entries(byTeamNum).sort(([a],[b]) => {
                            const na = parseFloat(a), nb = parseFloat(b);
                            return isNaN(na) || isNaN(nb) ? String(a).localeCompare(String(b)) : na - nb;
                        }).forEach(([tn, grp], idx) => {
                            teams.push({ teamNum: idx + 1, members: grp, isSolo: grp.length === 1 });
                        });
                    } else {
                        // Safe sequential pairing for old records (no teamNum)
                        let i = 0;
                        let teamIdx = 1;
                        while (i < members.length) {
                            const cur  = members[i];
                            const next = members[i + 1];
                            const curRole  = (cur.role  || '').toLowerCase();
                            const nextRole = next ? (next.role || '').toLowerCase() : '';
                            if (curRole === 'captain' && nextRole === 'member') {
                                // Proper pair
                                teams.push({ teamNum: teamIdx++, members: [cur, next], isSolo: false });
                                i += 2;
                            } else if (curRole === 'member' && (i === 0 || (members[i-1].role||'').toLowerCase() !== 'captain')) {
                                // Orphan member â€” no preceding captain claimed them
                                teams.push({ teamNum: null, members: [cur], isSolo: true, orphan: true });
                                i += 1;
                            } else {
                                // Captain with no following member (individual or orphan captain)
                                teams.push({ teamNum: teamIdx++, members: [cur], isSolo: true });
                                i += 1;
                            }
                        }
                    }
                    return teams;
                }

                // â”€â”€ Assign globally unique team numbers across all classes â”€â”€
                let globalTeamCounter = 0;
                const sortedClassEntries = Object.entries(byClass).sort(([a],[b]) => a.localeCompare(b));
                const classTeamsMap = {};
                sortedClassEntries.forEach(([cls, members]) => {
                    const teams = groupIntoTeams(members);
                    teams.forEach(team => {
                        if (!team.orphan) {
                            globalTeamCounter++;
                            team.globalTeamNum = globalTeamCounter;
                        }
                    });
                    classTeamsMap[cls] = teams;
                });

                listEl.innerHTML = sortedClassEntries.map(([cls, members]) => {
                    const teams = classTeamsMap[cls];
                    const clsPresent = members.filter(m => m._attendance.status === 'present').length;
                    const clsTotal   = members.length;

                    const teamBlocks = teams.map(team => {
                        const headerLabel = team.orphan
                            ? 'âš ï¸ Unmatched Member'
                            : team.isSolo
                                ? `ðŸ‘¤ Team ${team.globalTeamNum} (Individual)`
                                : `ðŸ‘¥ Team ${team.globalTeamNum}`;
                        const headerBg = team.orphan ? '#fce4ec' : team.isSolo ? '#e8f5e9' : '#e3f2fd';
                        const headerColor = team.orphan ? '#c62828' : team.isSolo ? '#2e7d32' : '#1565c0';

                        const memberRows = team.members.map((e, idx) => {
                            const roleLabel = e.role || (idx === 0 ? 'Captain' : 'Member');
                            const bg = idx % 2 === 0 ? '#fafafa' : 'white';
                            return bowMemberRow(e, roleLabel, bg);
                        }).join('');

                        return `<div style="border:1.5px solid #e0e0e0;border-radius:10px;overflow:hidden;margin-bottom:10px">
                            <div style="background:${headerBg};padding:6px 12px;display:flex;align-items:center;justify-content:space-between">
                                <span style="font-weight:700;color:${headerColor};font-size:0.82em">${headerLabel}</span>
                                ${team.orphan ? '<span style="font-size:0.72em;color:#c62828;font-weight:600">Check enrollment data</span>' : ''}
                            </div>
                            <div style="padding:8px 10px;display:flex;flex-direction:column;gap:6px">${memberRows}</div>
                        </div>`;
                    }).join('');

                    return `<div style="background:white;border-radius:12px;border:2px solid #ffe082;margin-bottom:14px;overflow:hidden">
                        <div style="background:linear-gradient(135deg,#ff8f00,#f9a825);padding:10px 16px;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:6px">
                            <span style="color:white;font-weight:700;font-size:0.95em">â™»ï¸ ${cls}</span>
                            <span style="background:rgba(255,255,255,0.25);color:white;padding:2px 12px;border-radius:12px;font-size:0.82em;font-weight:700">${clsPresent} / ${clsTotal} Present</span>
                        </div>
                        <div style="padding:10px 12px;display:flex;flex-direction:column;gap:4px">${teamBlocks}</div>
                    </div>`;
                }).join('');

            } catch(err) {
                if (listEl) listEl.innerHTML = `<div style="padding:20px;color:#c62828">âŒ Error: ${err.message}</div>`;
            }
        }

        async function shankarMarkBow(entryKey, status) {
            const msgEl = document.getElementById('bowMsg_' + entryKey);
            try {
                const bowMarkedBy = document.getElementById('facultyDashName').textContent || 'Shankar B C';
                await db.ref('bowAttendance/' + entryKey).set({
                    status    : status,
                    markedBy  : bowMarkedBy,
                    markedAt  : new Date().toISOString()
                });
                if (msgEl) {
                    msgEl.style.display    = 'block';
                    msgEl.style.background = status === 'present' ? '#d4edda' : status === 'absent' ? '#f8d7da' : '#e9ecef';
                    msgEl.style.color      = status === 'present' ? '#155724' : status === 'absent' ? '#721c24' : '#495057';
                    msgEl.textContent      = status === 'present' ? 'âœ… Marked Present â€” forwarded to Jury'
                                          : status === 'absent'  ? 'âŒ Marked Absent â€” excluded from Jury'
                                          : 'â†© Reset to Not Marked';
                }
                setTimeout(() => loadShankarBowPanel(), 1200);
            } catch(err) {
                if (msgEl) {
                    msgEl.style.display = 'block';
                    msgEl.style.background = '#f8d7da';
                    msgEl.style.color = '#721c24';
                    msgEl.textContent = 'âŒ Error: ' + err.message;
                }
            }
        }

        async function shankarSendToJury(regId) {
            if (!regId) { alert('âŒ Registration ID missing.'); return; }
            try {
                const bowJuryBy = document.getElementById('facultyDashName').textContent || 'Shankar B C';
                await db.ref('bowRegistrations/' + regId).update({
                    sentToJury   : true,
                    sentToJuryAt : new Date().toISOString(),
                    sentToJuryBy : bowJuryBy
                });
                loadShankarBowPanel();
            } catch(err) {
                alert('âŒ Error: ' + err.message);
            }
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // END BEST OUT OF WASTE
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // BEST OUT OF WASTE â€” CR FUNCTIONS (Option A + C)
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

        // Load enrolled BOW participants for CR class
        async function autoFillBOWMembers() {
            const cls      = (window.currentCRClass || crClass || '').trim();
            const listEl   = document.getElementById('bowEnrolledList');
            const selectEl = document.getElementById('bowParticipantSelect');
            const lbl      = document.getElementById('bowCRClass');
            if (lbl) lbl.textContent = cls;
            if (!cls) {
                if (listEl) listEl.innerHTML = '<span style="color:#c62828">âš ï¸ Class not detected. Please log in again.</span>';
                return;
            }
            if (listEl)   listEl.innerHTML   = '<span style="color:#666">ðŸ”„ Loadingâ€¦</span>';
            if (selectEl) selectEl.innerHTML = '<option value="">â€” Loadingâ€¦ â€”</option>';
            try {
                const snap = await db.ref('youthfest-enrollments').once('value');
                const members = [];
                if (snap.exists()) {
                    snap.forEach(ch => {
                        const d = ch.val();
                        const evNorm = (d.event||'').toLowerCase().replace(/\s/g,'');
                        if ((evNorm === 'bestoutofwaste') && (d.classYear||d.class||'').trim() === cls) {
                            members.push({ key: ch.key, ...d });
                        }
                    });
                }
                if (!members.length) {
                    if (listEl)   listEl.innerHTML   = '<span style="color:#c62828">âš ï¸ No Best Out of Waste enrollment found for your class.</span>';
                    if (selectEl) selectEl.innerHTML = '<option value="">â€” No enrolled participants â€”</option>';
                    return;
                }

                // Group captains with their members to form team entries
                const captains  = members.filter(m => (m.role||'').toLowerCase() === 'captain');
                const membs     = members.filter(m => (m.role||'').toLowerCase() !== 'captain');
                // Individual entries (no role or role='Individual')
                const indivs    = members.filter(m => !m.role || (m.role||'').toLowerCase() === 'individual');

                // Build team list: for each captain find their paired member by topic match or sequential pairing
                const teams = [];
                const usedMemberKeys = new Set();
                captains.forEach(cap => {
                    // Try to match by topic
                    let partner = membs.find(m => !usedMemberKeys.has(m.key) && m.topic && cap.topic && m.topic === cap.topic);
                    // If no topic match, just pick next available member
                    if (!partner) partner = membs.find(m => !usedMemberKeys.has(m.key));
                    if (partner) usedMemberKeys.add(partner.key);
                    teams.push({ captain: cap, member: partner || null });
                });
                // Add unpaired members and individuals as solo entries
                const solos = [
                    ...membs.filter(m => !usedMemberKeys.has(m.key)),
                    ...indivs
                ];

                if (listEl) {
                    let listHtml = '';
                    teams.forEach((t, i) => {
                        const teamLabel = t.member ? t.captain.name + ' & ' + t.member.name : t.captain.name;
                        const topicStr  = t.captain.topic ? ' â€” ' + t.captain.topic : '';
                        listHtml += `<div style="padding:6px 0;border-bottom:1px solid #ffe082;display:flex;align-items:center;gap:10px;flex-wrap:wrap">
                            <span style="background:#fff3e0;border-radius:20px;padding:2px 10px;font-size:0.82em;color:#e65100;font-weight:700">${i+1}</span>
                            <span style="font-weight:700;color:#222;font-size:0.88em">ðŸ‘¥ ${teamLabel}</span>
                            ${t.captain.topic ? `<span style="color:#f9a825;font-size:0.82em">ðŸŽ¯ ${t.captain.topic}</span>` : ''}
                        </div>`;
                    });
                    solos.forEach((m, i) => {
                        listHtml += `<div style="padding:6px 0;${i<solos.length-1?'border-bottom:1px solid #ffe082;':''}display:flex;align-items:center;gap:10px;flex-wrap:wrap">
                            <span style="background:#fff3e0;border-radius:20px;padding:2px 10px;font-size:0.82em;color:#e65100;font-weight:700">${teams.length+i+1}</span>
                            <span style="font-weight:600;color:#222;font-size:0.88em">ðŸ‘¤ ${m.name||'â€”'}</span>
                            ${m.role?`<span style="color:#f9a825;font-size:0.82em">ðŸŽ­ ${m.role}</span>`:''}
                        </div>`;
                    });
                    listEl.innerHTML = listHtml || '<span style="color:#888">No entries</span>';
                }
                if (selectEl) {
                    let opts = '<option value="">â€” Select participant/team â€”</option>';
                    teams.forEach(t => {
                        const teamLabel = t.member ? t.captain.name + ' & ' + t.member.name : t.captain.name;
                        const displayName = t.captain.topic ? teamLabel + ' (' + t.captain.topic + ')' : teamLabel;
                        // Store combined name for submission
                        opts += `<option value="${t.captain.key}" data-name="${teamLabel}" data-key="${t.captain.key}" data-member="${t.member ? t.member.name : ''}">${displayName}</option>`;
                    });
                    solos.forEach(m => {
                        opts += `<option value="${m.key}" data-name="${m.name||''}" data-key="${m.key}" data-member="">${m.name||'â€”'}${m.role?' â€” '+m.role:''}</option>`;
                    });
                    selectEl.innerHTML = opts;
                }
            } catch(e) {
                if (listEl) listEl.innerHTML = '<span style="color:#c62828">âš ï¸ Error: ' + e.message + '</span>';
            }
        }

        function bowOnParticipantSelect() {
            const sel  = document.getElementById('bowParticipantSelect');
            const opt  = sel ? sel.options[sel.selectedIndex] : null;
            const disp = document.getElementById('bowSelectedDisplay');
            const info = document.getElementById('bowSelectedInfo');
            const nameEl = document.getElementById('bowMemberName');
            const keyEl  = document.getElementById('bowMemberKey');
            if (!opt || !opt.value) {
                if (disp) disp.style.display = 'none';
                if (nameEl) nameEl.value = '';
                if (keyEl)  keyEl.value  = '';
                return;
            }
            const displayName = opt.dataset.name || '';
            if (nameEl) nameEl.value = displayName;
            if (keyEl)  keyEl.value  = opt.value;
            if (info)   info.textContent = displayName;
            if (disp)   disp.style.display = 'block';
        }

        function bowPreviewPhoto() {
            const input    = document.getElementById('bowPhotoInput');
            const preview  = document.getElementById('bowPhotoPreview');
            const img      = document.getElementById('bowPhotoImg');
            const nameSpan = document.getElementById('bowPhotoFileName');
            if (!input || !input.files || !input.files[0]) return;
            const file = input.files[0];
            if (nameSpan) nameSpan.textContent = file.name;
            const reader = new FileReader();
            reader.onload = e => {
                if (img)     img.src = e.target.result;
                if (preview) preview.style.display = 'block';
            };
            reader.readAsDataURL(file);
        }

        async function uploadBOWPhoto(file) {
            const prog = document.getElementById('bowUploadProgress');
            if (prog) prog.style.display = 'block';
            const formData = new FormData();
            formData.append('file', file);
            formData.append('upload_preset', 'scavenger_hunt');
            formData.append('folder', 'bow_crafts');
            const res  = await fetch('https://api.cloudinary.com/v1_1/dat0khbet/image/upload', { method:'POST', body:formData });
            const data = await res.json();
            if (prog) prog.style.display = 'none';
            if (!data.secure_url) throw new Error('Photo upload failed');
            return data.secure_url;
        }

        async function submitBOWEntry() {
            const cls      = (window.currentCRClass || crClass || '').trim();
            const name     = (document.getElementById('bowMemberName').value  || '').trim();
            const entryKey = (document.getElementById('bowMemberKey').value   || '').trim();
            const theme    = (document.getElementById('bowTheme').value       || '').trim();
            const materials= (document.getElementById('bowMaterials').value   || '').trim();
            const desc     = (document.getElementById('bowDescription').value || '').trim();
            const photoInput = document.getElementById('bowPhotoInput');
            const msgEl    = document.getElementById('bowSubmitMsg');
            const btnEl    = document.getElementById('bowSubmitBtn');

            function showMsg(text, ok) {
                msgEl.style.display    = 'block';
                msgEl.style.background = ok ? '#d4edda' : '#f8d7da';
                msgEl.style.color      = ok ? '#155724' : '#721c24';
                msgEl.style.border     = ok ? '1px solid #c3e6cb' : '1px solid #f5c6cb';
                msgEl.textContent = text;
            }

            if (!name)      { showMsg('âŒ Please select a participant/team first.', false); return; }
            if (!theme)     { showMsg('âŒ Please enter your theme / product name.', false); return; }
            if (!materials) { showMsg('âŒ Please enter the waste materials you will use.', false); return; }
            if (!cls)       { showMsg('âŒ Class info missing. Please re-login.', false); return; }

            // Check duplicate theme in same class
            try {
                btnEl.disabled = true;
                btnEl.textContent = 'â³ Checking duplicatesâ€¦';
                const existSnap = await db.ref('bowRegistrations').orderByChild('classYear').equalTo(cls).once('value');
                const existing = [];
                if (existSnap.exists()) existSnap.forEach(ch => existing.push({ id: ch.key, ...ch.val() }));

                const dupTheme = existing.find(e => e.enrollmentKey !== entryKey &&
                    e.theme.toLowerCase().trim() === theme.toLowerCase().trim());
                if (dupTheme) {
                    showMsg('âŒ Theme "' + theme + '" is already taken by another team in your class. Choose a different theme!', false);
                    return;
                }

                // Upload photo if selected
                let photoUrl = null;
                if (photoInput && photoInput.files && photoInput.files[0]) {
                    btnEl.textContent = 'â³ Uploading photoâ€¦';
                    try { photoUrl = await uploadBOWPhoto(photoInput.files[0]); }
                    catch(e) { showMsg('âŒ Photo upload failed: ' + e.message, false); return; }
                }

                btnEl.textContent = 'â³ Savingâ€¦';
                // Check if this entry already has a registration (update vs create)
                const prev = existing.find(e => e.enrollmentKey === entryKey);
                const entry = {
                    memberName    : name,
                    classYear     : cls,
                    enrollmentKey : entryKey,
                    theme         : theme,
                    materials     : materials,
                    description   : desc,
                    photoUrl      : photoUrl || (prev && prev.photoUrl) || null,
                    registeredAt  : new Date().toISOString(),
                    updatedAt     : new Date().toISOString()
                };
                if (prev) {
                    await db.ref('bowRegistrations/' + prev.id).update(entry);
                    showMsg('âœ… Registration updated! Theme: "' + theme + '" â€” Photo ' + (photoUrl ? 'uploaded âœ…' : 'unchanged'), true);
                } else {
                    await db.ref('bowRegistrations').push(entry);
                    showMsg('âœ… Registered! Theme: "' + theme + '" â€” ' + (photoUrl ? 'Photo uploaded âœ…' : 'No photo (you can add later)'), true);
                }
                loadBOWSubmissions();
            } catch(err) {
                showMsg('âŒ Error: ' + err.message, false);
            } finally {
                btnEl.disabled = false;
                btnEl.textContent = 'â™»ï¸ Submit Registration';
            }
        }

        function clearBOWForm() {
            ['bowTheme','bowMaterials','bowDescription'].forEach(id => {
                const el = document.getElementById(id); if (el) el.value = '';
            });
            const sel = document.getElementById('bowParticipantSelect');
            if (sel) sel.value = '';
            const disp = document.getElementById('bowSelectedDisplay');
            if (disp) disp.style.display = 'none';
            ['bowMemberName','bowMemberKey'].forEach(id => { const el=document.getElementById(id); if(el) el.value=''; });
            const pi = document.getElementById('bowPhotoInput');
            if (pi) pi.value = '';
            const pv = document.getElementById('bowPhotoPreview');
            if (pv) pv.style.display = 'none';
            const fn = document.getElementById('bowPhotoFileName');
            if (fn) fn.textContent = 'No photo chosen';
        }

        async function loadBOWSubmissions() {
            const cls  = (window.currentCRClass || crClass || '').trim();
            const lbl  = document.getElementById('bowCRClass');
            if (lbl) lbl.textContent = cls;
            if (!cls) return;

            const sel = document.getElementById('bowParticipantSelect');
            if (sel && sel.options.length <= 1) autoFillBOWMembers();

            const empty     = document.getElementById('bowEmptyMsg');
            const container = document.getElementById('bowTableContainer');
            const tbody     = document.getElementById('bowTableBody');

            try {
                const [regSnap, attSnap] = await Promise.all([
                    db.ref('bowRegistrations').orderByChild('classYear').equalTo(cls).once('value'),
                    db.ref('bowAttendance').once('value')
                ]);
                const regs = [];
                if (regSnap.exists()) regSnap.forEach(ch => regs.push({ id: ch.key, ...ch.val() }));
                const attData = attSnap.val() || {};

                // -- Update Step 2 select with pre-registered participants --
                const step2Locked = document.getElementById('bowStep2Locked');
                const step2Form   = document.getElementById('bowStep2Form');
                const photoSel    = document.getElementById('bowPhotoParticipantSelect');
                const regsWithPhoto = regs.filter(r => r.finalPhotoUrl);
                const regsDone    = regs.filter(r => !r.finalPhotoUrl);

                if (regs.length > 0) {
                    if (step2Locked) step2Locked.style.display = 'none';
                    if (step2Form)   step2Form.style.display   = 'block';
                    if (photoSel) {
                        photoSel.innerHTML = '<option value="">â€” Select participant â€”</option>' +
                            regs.map(r => `<option value="${r.id}" data-theme="${r.theme||''}" data-materials="${r.materials||''}" data-name="${r.memberName||''}">${r.memberName||'â€”'} â€” ${r.theme||'â€”'}${r.finalPhotoUrl?' âœ… Photo submitted':''}</option>`).join('');
                    }
                } else {
                    if (step2Locked) step2Locked.style.display = 'block';
                    if (step2Form)   step2Form.style.display   = 'none';
                }

                if (!regs.length) {
                    if (empty)     empty.style.display = 'block';
                    if (container) container.style.display = 'none';
                    return;
                }
                if (empty)     empty.style.display = 'none';
                if (container) container.style.display = 'block';

                const attColor  = { present:'#2e7d32', absent:'#c62828', pending:'#856404' };
                const attBg     = { present:'#e8f5e9', absent:'#fce4ec', pending:'#fff8e1' };
                const attLabel  = { present:'âœ… Present', absent:'âŒ Absent', pending:'â³ Not Marked' };

                tbody.innerHTML = regs.map((e, i) => {
                    const att = (attData[e.enrollmentKey] || {}).status || 'pending';
                    const step1Badge = '<span style="background:#e8f5e9;color:#2e7d32;padding:3px 10px;border-radius:12px;font-size:0.75em;font-weight:700">âœ… Done</span>';
                    const photoCell = e.finalPhotoUrl
                        ? `<a href="${e.finalPhotoUrl}" target="_blank" rel="noopener"><img src="${e.finalPhotoUrl}" style="width:52px;height:52px;object-fit:cover;border-radius:6px;border:2px solid #a5d6a7" alt="craft"></a>`
                        : '<span style="background:#fff3e0;color:#e65100;padding:3px 10px;border-radius:12px;font-size:0.75em;font-weight:700">â³ Pending</span>';
                    const juryStatus = e.sentToJury
                        ? '<span style="background:#e3f2fd;color:#1565c0;padding:3px 10px;border-radius:12px;font-size:0.75em;font-weight:700">ðŸ“‹ Sent to Jury</span>'
                        : '<span style="background:#f5f5f5;color:#999;padding:3px 10px;border-radius:12px;font-size:0.75em;font-weight:700">Awaiting</span>';
                    return `<tr>
                        <td style="text-align:center;font-weight:700;color:#e65100">${i+1}</td>
                        <td><strong>${e.memberName||'â€”'}</strong></td>
                        <td style="font-size:0.85em;font-weight:600;color:#e65100">${e.theme||'â€”'}</td>
                        <td style="font-size:0.82em;color:#555">${e.materials||'â€”'}</td>
                        <td style="text-align:center">${step1Badge}</td>
                        <td style="text-align:center">${photoCell}</td>
                        <td style="text-align:center"><span style="background:${attBg[att]};color:${attColor[att]};padding:3px 10px;border-radius:12px;font-size:0.75em;font-weight:700">${attLabel[att]}</span></td>
                        <td style="text-align:center">${juryStatus}</td>
                    </tr>`;
                }).join('');
            } catch(err) {
                console.error('BOW load error:', err);
            }
        }

        function bowPhotoParticipantChanged() {
            const sel   = document.getElementById('bowPhotoParticipantSelect');
            const opt   = sel ? sel.options[sel.selectedIndex] : null;
            const info  = document.getElementById('bowStep2PreRegInfo');
            const theme = document.getElementById('bowStep2ThemeDisplay');
            const keyEl = document.getElementById('bowPhotoEntryKey');
            if (!opt || !opt.value) {
                if (info) info.style.display = 'none';
                if (keyEl) keyEl.value = '';
                return;
            }
            if (keyEl)  keyEl.value  = opt.value;
            if (theme)  theme.textContent = (opt.dataset.name || '') + ' â€” ðŸŽ¨ ' + (opt.dataset.theme || '') + ' | â™»ï¸ ' + (opt.dataset.materials || '');
            if (info)   info.style.display = 'block';
        }

        async function submitBOWFinalPhoto() {
            const cls      = (window.currentCRClass || crClass || '').trim();
            const entryId  = (document.getElementById('bowPhotoEntryKey').value || '').trim();
            const photoInput = document.getElementById('bowPhotoInput');
            const msgEl    = document.getElementById('bowPhotoSubmitMsg');
            const btnEl    = document.getElementById('bowPhotoSubmitBtn');

            function showMsg(text, ok) {
                msgEl.style.display    = 'block';
                msgEl.style.background = ok ? '#d4edda' : '#f8d7da';
                msgEl.style.color      = ok ? '#155724' : '#721c24';
                msgEl.style.border     = ok ? '1px solid #c3e6cb' : '1px solid #f5c6cb';
                msgEl.textContent = text;
            }

            if (!entryId)  { showMsg('âŒ Please select a participant first.', false); return; }
            if (!photoInput || !photoInput.files || !photoInput.files[0]) {
                showMsg('âŒ Please choose a photo of the finished product.', false); return;
            }

            btnEl.disabled = true;
            btnEl.textContent = 'â³ Uploading photoâ€¦';
            try {
                const prog = document.getElementById('bowUploadProgress');
                if (prog) prog.style.display = 'block';
                const formData = new FormData();
                formData.append('file', photoInput.files[0]);
                formData.append('upload_preset', 'scavenger_hunt');
                formData.append('folder', 'bow_crafts');
                const res  = await fetch('https://api.cloudinary.com/v1_1/dat0khbet/image/upload', { method:'POST', body:formData });
                const data = await res.json();
                if (prog) prog.style.display = 'none';
                if (!data.secure_url) throw new Error('Photo upload failed');

                btnEl.textContent = 'â³ Savingâ€¦';
                await db.ref('bowRegistrations/' + entryId).update({
                    finalPhotoUrl  : data.secure_url,
                    finalSubmittedAt: new Date().toISOString(),
                    sentToJury     : false
                });
                showMsg('âœ… Final photo submitted! Shankar sir will review and forward to the jury.', true);
                // Reset photo form
                photoInput.value = '';
                const pv = document.getElementById('bowPhotoPreview');
                if (pv) pv.style.display = 'none';
                const fn = document.getElementById('bowPhotoFileName');
                if (fn) fn.textContent = 'No photo chosen';
                document.getElementById('bowPhotoParticipantSelect').value = '';
                document.getElementById('bowPhotoEntryKey').value = '';
                const info = document.getElementById('bowStep2PreRegInfo');
                if (info) info.style.display = 'none';
                loadBOWSubmissions();
            } catch(err) {
                showMsg('âŒ Error: ' + err.message, false);
            } finally {
                btnEl.disabled = false;
                btnEl.textContent = 'ðŸ“¸ Submit Final Photo to Shankar';
            }
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // END BOW CR FUNCTIONS
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•


        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // NUKKAD NATAK â€” CR FUNCTIONS
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

        async function loadCRNukkadPanel() {
            const cls     = (window.currentCRClass || crClass || '').trim();
            const statusEl = document.getElementById('crNukkadStatus');
            if (!cls) { if (statusEl) statusEl.innerHTML = 'âŒ Class not set. Please log in as CR first.'; return; }

            try {
                // Load enrollment
                const enrollSnap = await db.ref('youthfest-enrollments').orderByChild('event').equalTo('Nukkad Natak').once('value');
                let enrolled = false;
                const members = [];
                if (enrollSnap.exists()) {
                    enrollSnap.forEach(ch => {
                        const d = ch.val();
                        if ((d.classYear || d.class || '') === cls) {
                            enrolled = true;
                            if (d.name || d.studentName) members.push(d.name || d.studentName);
                        }
                    });
                }

                // Load post-event data
                const postSnap = await db.ref('nukkadNatak/post/' + cls.replace(/[.#$/\[\]]/g,'_')).once('value');
                const post = postSnap.val() || {};

                if (!enrolled) {
                    if (statusEl) statusEl.innerHTML = '<strong>âš ï¸ Not enrolled yet.</strong> Please enroll your class for Nukkad Natak first via the Enroll Students tab.';
                    return;
                }
                if (statusEl) statusEl.innerHTML = `<strong>âœ… Enrolled.</strong> Class: <strong>${cls}</strong> &nbsp;|&nbsp; ðŸ‘¥ ${members.length} member${members.length!==1?'s':''}`;
                // Show team members in the Pre-Event banner
                const memberListEl = document.getElementById('crNukkadMemberList');
                const memberNamesEl = document.getElementById('crNukkadMemberNames');
                if (memberListEl && memberNamesEl && members.length) {
                    memberNamesEl.innerHTML = members.map((m,i) =>
                        `<span style="background:rgba(255,255,255,0.2);border:1px solid rgba(255,255,255,0.4);border-radius:20px;padding:3px 10px;white-space:nowrap">${i+1}. ${m}</span>`
                    ).join('');
                    memberListEl.style.display = 'block';
                }

                // Pre-fill saved values
                const ytEl   = document.getElementById('crNukkadYtLink');
                const formEl = document.getElementById('crNukkadFormLink');
                if (ytEl   && post.ytLink)   ytEl.value   = post.ytLink;
                if (formEl && post.formLink) formEl.value = post.formLink;

                // Pre-fill adviser details (from pre-event data)
                const preSnap = await db.ref('nukkadNatak/pre/' + cls.replace(/[.#$/\[\]]/g,'_')).once('value');
                const pre = preSnap.val() || {};
                const advNameEl  = document.getElementById('crAdviserName');
                const advOrgEl   = document.getElementById('crAdviserOrg');
                const placeEl    = document.getElementById('crNukkadPlace');
                const placeSt    = document.getElementById('crPlaceStatus');
                if (advNameEl && pre.adviserName) advNameEl.value = pre.adviserName;
                if (advOrgEl  && pre.adviserOrg)  advOrgEl.value  = pre.adviserOrg;
                if (placeEl   && pre.place)        placeEl.value   = pre.place;
                // Show place approval status to CR
                if (placeSt && pre.place) {
                    if (pre.placeApproved === true) {
                        placeSt.style.display='block'; placeSt.style.background='#d4edda'; placeSt.style.color='#155724';
                        placeSt.textContent = 'âœ… Your place "' + pre.place + '" has been APPROVED by Kotrappa sir!';
                    } else if (pre.placeApproved === false) {
                        placeSt.style.display='block'; placeSt.style.background='#f8d7da'; placeSt.style.color='#721c24';
                        placeSt.textContent = 'âŒ Place "' + pre.place + '" was REJECTED. Reason: ' + (pre.placeRejectedReason || 'Not suitable') + '. Please enter a new location and save again.';
                        if (placeEl) { placeEl.value = ''; placeEl.focus(); }
                    } else {
                        placeSt.style.display='block'; placeSt.style.background='#fff3e0'; placeSt.style.color='#e65100';
                        placeSt.textContent = 'â³ Place "' + pre.place + '" submitted â€” awaiting Kotrappa sir\'s verification.';
                    }
                }

                // Show current newspaper photo
                const newsDiv = document.getElementById('crNukkadNewspaperCurrent');
                if (newsDiv) {
                    newsDiv.innerHTML = post.newspaperUrl
                        ? `<div style="margin-bottom:8px"><a href="${post.newspaperUrl}" target="_blank"><img src="${post.newspaperUrl}" style="max-width:180px;border-radius:8px;border:2px solid #4caf50"></a><br><span style="font-size:0.76em;color:#2e7d32;font-weight:700">âœ… Photo uploaded</span></div>`
                        : '<p style="font-size:0.8em;color:#aaa;margin:0">No photo uploaded yet.</p>';
                }
            } catch(err) {
                if (statusEl) statusEl.innerHTML = 'âŒ Error: ' + err.message;
            }
        }

        async function saveNukkadYtLink() {
            const cls  = (window.currentCRClass || crClass || '').trim();
            const link = (document.getElementById('crNukkadYtLink').value || '').trim();
            const msg  = document.getElementById('crNukkadYtMsg');
            function showM(txt, ok) { msg.style.display='block'; msg.style.background=ok?'#d4edda':'#f8d7da'; msg.style.color=ok?'#155724':'#721c24'; msg.textContent=txt; }
            if (!cls)  { showM('âŒ Class not set.', false); return; }
            if (!link) { showM('âŒ Please enter a YouTube link.', false); return; }
            if (!link.startsWith('http')) { showM('âŒ Please enter a valid URL starting with http.', false); return; }
            try {
                const key = cls.replace(/[.#$/\[\]]/g,'_');
                await db.ref('nukkadNatak/post/' + key).update({ ytLink: link, ytSubmittedAt: new Date().toISOString(), ytSubmittedBy: cls });
                showM('âœ… YouTube link saved! Shankar sir will verify it.', true);
            } catch(err) { showM('âŒ Error: ' + err.message, false); }
        }

        async function saveNukkadNewspaper() {
            const cls   = (window.currentCRClass || crClass || '').trim();
            const file  = document.getElementById('crNukkadNewspaperFile').files[0];
            const msg   = document.getElementById('crNukkadNewspaperMsg');
            function showM(txt, ok) { msg.style.display='block'; msg.style.background=ok?'#d4edda':'#f8d7da'; msg.style.color=ok?'#155724':'#721c24'; msg.textContent=txt; }
            if (!cls)  { showM('âŒ Class not set.', false); return; }
            if (!file) { showM('âŒ Please select a photo to upload.', false); return; }
            showM('â³ Uploadingâ€¦', true);
            try {
                const key      = cls.replace(/[.#$/\[\]]/g,'_');
                const storRef  = firebase.storage().ref('nukkadNatak/newspaper/' + key + '_' + Date.now() + '_' + file.name);
                await storRef.put(file);
                const url = await storRef.getDownloadURL();
                await db.ref('nukkadNatak/post/' + key).update({ newspaperUrl: url, newspaperSubmittedAt: new Date().toISOString() });
                showM('âœ… Newspaper photo uploaded! Shankar sir will verify it.', true);
                loadCRNukkadPanel();
            } catch(err) { showM('âŒ Error: ' + err.message, false); }
        }

        async function saveNukkadFormLink() {
            const cls  = (window.currentCRClass || crClass || '').trim();
            const link = (document.getElementById('crNukkadFormLink').value || '').trim();
            const msg  = document.getElementById('crNukkadFormMsg');
            function showM(txt, ok) { msg.style.display='block'; msg.style.background=ok?'#d4edda':'#f8d7da'; msg.style.color=ok?'#155724':'#721c24'; msg.textContent=txt; }
            if (!cls)  { showM('âŒ Class not set.', false); return; }
            if (!link) { showM('âŒ Please enter the Google Form link.', false); return; }
            if (!link.startsWith('http')) { showM('âŒ Please enter a valid URL.', false); return; }
            try {
                const key = cls.replace(/[.#$/\[\]]/g,'_');
                await db.ref('nukkadNatak/post/' + key).update({ formLink: link, formLinkSavedAt: new Date().toISOString() });
                showM('âœ… Feedback form link saved!', true);
            } catch(err) { showM('âŒ Error: ' + err.message, false); }
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // NUKKAD NATAK â€” KOTRAPPA PRE-EVENT PANEL
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

        async function saveNukkadAdviser() {
            const cls      = (window.currentCRClass || crClass || '').trim();
            const advName  = (document.getElementById('crAdviserName').value  || '').trim();
            const advOrg   = (document.getElementById('crAdviserOrg').value   || '').trim();
            const placeEl  = document.getElementById('crNukkadPlace');
            const place    = placeEl ? placeEl.value.trim() : '';
            const msg      = document.getElementById('crAdviserMsg');
            const placeStatus = document.getElementById('crPlaceStatus');
            function showM(txt, ok) { msg.style.display='block'; msg.style.background=ok?'#d4edda':'#f8d7da'; msg.style.color=ok?'#155724':'#721c24'; msg.textContent=txt; }
            if (!cls)    { showM('âŒ Class not set.', false); return; }
            if (!advName){ showM('âŒ Please enter the Social Adviser name.', false); return; }
            if (!advOrg) { showM('âŒ Please enter the Media House / Organisation name.', false); return; }
            if (!place)  { showM('âŒ Please enter the Performance Place / Location.', false); return; }
            try {
                const allPreSnap = await db.ref('nukkadNatak/pre').once('value');
                const allPre = allPreSnap.val() || {};
                const myKey  = cls.replace(/[.#$\/\[\]]/g,'_');
                const clash  = Object.entries(allPre).find(([k, v]) => k !== myKey && v.place && v.place.toLowerCase().trim() === place.toLowerCase().trim());
                if (clash) {
                    const clashCls = clash[1].savedBy || clash[0];
                    if (placeStatus) { placeStatus.style.display='block'; placeStatus.style.background='#fce4ec'; placeStatus.style.color='#c62828'; placeStatus.textContent='âš ï¸ Place clash! "' + place + '" is already requested by ' + clashCls + '. Choose a different location.'; }
                    showM('âŒ Place clash detected! Choose a different performance location.', false);
                    return;
                }
            } catch(e) { /* ignore clash check, proceed */ }
            try {
                const key = cls.replace(/[.#$\/\[\]]/g,'_');
                await db.ref('nukkadNatak/pre/' + key).update({ adviserName: advName, adviserOrg: advOrg, place: place, placeApproved: null, savedAt: new Date().toISOString(), savedBy: cls });
                if (placeStatus) { placeStatus.style.display='block'; placeStatus.style.background='#fff3e0'; placeStatus.style.color='#e65100'; placeStatus.textContent='ðŸ“ Place "' + place + '" submitted â€” awaiting Kotrappa sir\'s verification.'; }
                showM('âœ… Adviser details & place saved! Kotrappa sir will verify.', true);
            } catch(err) { showM('âŒ Error: ' + err.message, false); }
        }

        async function loadNukkadPrePanel() {
            const listEl  = document.getElementById('nukkadPreList');
            const badge   = document.getElementById('nukkadPreBadge');
            if (!listEl) return;
            listEl.innerHTML = '<div style="text-align:center;color:#aaa;padding:30px">Loadingâ€¦</div>';
            try {
                // Load all Nukkad Natak enrollments
                const enrollSnap = await db.ref('youthfest-enrollments').orderByChild('event').equalTo('Nukkad Natak').once('value');
                const byClass = {};
                if (enrollSnap.exists()) {
                    enrollSnap.forEach(ch => {
                        const d = ch.val();
                        const cls = d.classYear || d.class || 'Unknown';
                        if (!byClass[cls]) byClass[cls] = { members:[], cause:'', adviserName:'', adviserOrg:'' };
                        byClass[cls].members.push(d);
                        if (d.cause)       byClass[cls].cause       = d.cause;
                        if (d.adviserName) byClass[cls].adviserName = d.adviserName;
                        if (d.adviserOrg)  byClass[cls].adviserOrg  = d.adviserOrg;
                    });
                }
                // Load pre-event data (adviser + place saved by CR)
                const preSnap = await db.ref('nukkadNatak/pre').once('value');
                const preData = preSnap.val() || {};

                // Load permissions
                const permSnap = await db.ref('nukkadNatak/permissions').once('value');
                const perms = permSnap.val() || {};

                const classes = Object.keys(byClass);
                // Merge pre-event data (place, adviser) into byClass
                classes.forEach(cls => {
                    const key = cls.replace(/[.#$/\[\]]/g,'_');
                    const pre = preData[key] || {};
                    if (pre.adviserName) byClass[cls].adviserName = pre.adviserName;
                    if (pre.adviserOrg)  byClass[cls].adviserOrg  = pre.adviserOrg;
                    byClass[cls].place         = pre.place         || '';
                    byClass[cls].placeApproved = pre.placeApproved !== undefined ? pre.placeApproved : null;
                    byClass[cls].placeRejectedReason = pre.placeRejectedReason || '';
                });

                if (badge) badge.textContent = classes.length + ' class' + (classes.length !== 1 ? 'es' : '') + ' enrolled';

                // Build theme â†’ classes map for duplicate detection
                const themeMap = {};
                classes.forEach(cls => {
                    const theme = (byClass[cls].cause || '').toLowerCase().trim();
                    if (theme) { if (!themeMap[theme]) themeMap[theme] = []; themeMap[theme].push(cls); }
                });

                if (!classes.length) {
                    listEl.innerHTML = '<div style="text-align:center;color:#aaa;padding:30px">No Nukkad Natak enrollments yet.</div>';
                    return;
                }

                listEl.innerHTML = classes.sort().map(cls => {
                    const data  = byClass[cls];
                    const perm  = perms[cls.replace(/[.#$/\[\]]/g,'_')] || {};
                    const theme = (data.cause || '').trim();
                    const themeKey = theme.toLowerCase().trim();
                    const isDup = themeKey && themeMap[themeKey] && themeMap[themeKey].length > 1;
                    const dupClasses = isDup ? themeMap[themeKey].filter(c => c !== cls).join(', ') : '';
                    const hasPermission = perm.granted === true;
                    const permDate = perm.date || '';
                    const permTime = perm.time || '';
                    const clsKey   = cls.replace(/[.#$/\[\]]/g,'_');

                    return `<div style="background:white;border-radius:12px;border:2px solid ${isDup?'#ef9a9a':'#c5cae9'};padding:16px;margin-bottom:4px">
                        <div style="display:flex;justify-content:space-between;align-items:flex-start;flex-wrap:wrap;gap:8px;margin-bottom:10px">
                            <div>
                                <div style="font-weight:700;color:#1a237e;font-size:0.95em">ðŸ« ${cls}</div>
                                <div style="font-size:0.8em;color:#555;margin-top:3px">ðŸ‘¥ ${data.members.length} members enrolled</div>
                            </div>
                            ${hasPermission ? `<span style="background:#e8f5e9;color:#2e7d32;padding:3px 12px;border-radius:12px;font-size:0.78em;font-weight:700">âœ… Permission Granted</span>` : `<span style="background:#fff3e0;color:#e65100;padding:3px 12px;border-radius:12px;font-size:0.78em;font-weight:700">â³ Pending Permission</span>`}
                        </div>
                        <div style="background:#f8f9fa;border-radius:8px;padding:10px;margin-bottom:10px;font-size:0.82em">
                            <div style="margin-bottom:4px"><strong>ðŸŽ¯ Theme:</strong> ${theme || '<em style="color:#aaa">Not set</em>'}
                                ${isDup ? `<span style="background:#fce4ec;color:#c62828;padding:1px 8px;border-radius:8px;font-size:0.78em;font-weight:700;margin-left:6px">âš ï¸ Duplicate â€” also used by: ${dupClasses}</span>` : (theme ? `<span style="background:#e8f5e9;color:#2e7d32;padding:1px 8px;border-radius:8px;font-size:0.78em;font-weight:700;margin-left:6px">âœ… Unique</span>` : '')}
                            </div>
                            <div style="margin-bottom:4px"><strong>ðŸŽ“ Social Adviser:</strong> ${data.adviserName || '<em style="color:#aaa">Not set</em>'}${data.adviserOrg ? ` <span style="color:#666">(${data.adviserOrg})</span>` : ''}</div>
                            <div style="margin-bottom:4px"><strong>ðŸ“ Performance Place:</strong>
                                ${data.place
                                    ? `<span style="color:${data.placeApproved===true?'#2e7d32':data.placeApproved===false?'#c62828':'#e65100'};font-weight:600">${data.place}</span>
                                       ${data.placeApproved===true?'<span style="background:#e8f5e9;color:#2e7d32;padding:1px 8px;border-radius:8px;font-size:0.78em;font-weight:700;margin-left:4px">âœ… Approved</span>':data.placeApproved===false?'<span style="background:#fce4ec;color:#c62828;padding:1px 8px;border-radius:8px;font-size:0.78em;font-weight:700;margin-left:4px">âŒ Rejected</span>':'<span style="background:#fff3e0;color:#e65100;padding:1px 8px;border-radius:8px;font-size:0.78em;font-weight:700;margin-left:4px">â³ Pending</span>'}`
                                    : '<em style="color:#aaa">Not submitted</em>'}
                            </div>
                            ${data.place && data.placeApproved !== true ? `
                            <div style="display:flex;gap:6px;flex-wrap:wrap;align-items:center;margin-top:6px;padding:8px;background:#e8eaf6;border-radius:8px">
                                <span style="font-size:0.82em;font-weight:700;color:#1a237e">âœï¸ Edit/Verify Place:</span>
                                <input type="text" id="placeEdit_${clsKey}" value="${(data.place||'').replace(/'/g,"\'")}" style="flex:1;min-width:140px;padding:5px 9px;border:2px solid #9fa8da;border-radius:6px;font-size:0.82em">
                                <button onclick="approveNukkadPlace('${cls}','${clsKey}')" style="background:#2e7d32;color:white;border:none;border-radius:6px;padding:5px 12px;font-weight:700;cursor:pointer;font-size:0.78em">âœ… Approve</button>
                                <button onclick="rejectNukkadPlace('${cls}','${clsKey}')" style="background:#c62828;color:white;border:none;border-radius:6px;padding:5px 12px;font-weight:700;cursor:pointer;font-size:0.78em">âŒ Reject</button>
                            </div>` : ''}
                            ${hasPermission ? `<div style="margin-top:4px;color:#2e7d32;font-weight:600">ðŸ“… Slot: ${permDate} at ${permTime}</div>` : ''}
                        </div>
                        ${!hasPermission ? `
                        <div style="background:#e8eaf6;border-radius:8px;padding:10px;margin-bottom:10px">
                            <div style="font-size:0.82em;font-weight:700;color:#1a237e;margin-bottom:8px">ðŸ“… Grant Permission â€” Select Date & Time:</div>
                            <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">
                                <input type="date" id="nukkadDate_${clsKey}" style="padding:7px 10px;border:2px solid #9fa8da;border-radius:8px;font-size:0.85em">
                                <input type="time" id="nukkadTime_${clsKey}" style="padding:7px 10px;border:2px solid #9fa8da;border-radius:8px;font-size:0.85em">
                                <button onclick="grantNukkadPermission('${cls}','${clsKey}')" style="background:#1a237e;color:white;border:none;border-radius:8px;padding:7px 14px;font-weight:700;cursor:pointer;font-size:0.82em">âœ… Grant & Print Slip</button>
                            </div>
                            <div id="nukkadPermMsg_${clsKey}" style="display:none;margin-top:6px;font-size:0.78em;font-weight:600;padding:4px 10px;border-radius:6px"></div>
                        </div>` : `
                        <div style="display:flex;gap:8px;flex-wrap:wrap">
                            <button onclick="printNukkadSlip('${cls}','${permDate}','${permTime}','${(data.adviserName||'').replace(/'/g,"\\'")}','${(data.cause||'').replace(/'/g,"\\'")}','${(data.adviserOrg||'').replace(/'/g,"\\'")}',${data.members.length})" style="background:#1565c0;color:white;border:none;border-radius:8px;padding:7px 14px;font-weight:700;cursor:pointer;font-size:0.82em">ðŸ–¨ï¸ Print Permission Slip</button>
                            <button onclick="revokeNukkadPermission('${cls}','${clsKey}')" style="background:#c62828;color:white;border:none;border-radius:8px;padding:7px 14px;font-weight:700;cursor:pointer;font-size:0.82em">âŒ Revoke</button>
                        </div>`}
                    </div>`;
                }).join('');
            } catch(err) {
                if (listEl) listEl.innerHTML = `<div style="padding:20px;color:#c62828">âŒ Error: ${err.message}</div>`;
            }
        }

        async function grantNukkadPermission(cls, clsKey) {
            const dateEl = document.getElementById('nukkadDate_' + clsKey);
            const timeEl = document.getElementById('nukkadTime_' + clsKey);
            const msgEl  = document.getElementById('nukkadPermMsg_' + clsKey);
            function showM(txt, ok) { if(msgEl){msgEl.style.display='block';msgEl.style.background=ok?'#d4edda':'#f8d7da';msgEl.style.color=ok?'#155724':'#721c24';msgEl.textContent=txt;} }
            const date = dateEl ? dateEl.value : '';
            const time = timeEl ? timeEl.value : '';
            if (!date) { showM('âŒ Please select a date.', false); return; }
            if (!time) { showM('âŒ Please select a time.', false); return; }

            // Clash detection â€” check if any other class has the same date+time
            try {
                const permSnap = await db.ref('nukkadNatak/permissions').once('value');
                const perms = permSnap.val() || {};
                const clash = Object.entries(perms).find(([k, v]) => k !== clsKey && v.granted && v.date === date && v.time === time);
                if (clash) {
                    // Find original class name from key
                    const clashCls = clash[1].className || clash[0];
                    showM(`âŒ Slot clash! ${clashCls} already has permission for ${date} at ${time}. Choose a different slot.`, false);
                    return;
                }
                const grantedBy = document.getElementById('facultyDashName').textContent || 'Kotrappa K';
                await db.ref('nukkadNatak/permissions/' + clsKey).set({
                    granted: true, date, time,
                    className: cls,
                    grantedBy, grantedAt: new Date().toISOString()
                });
                showM('âœ… Permission granted! Loading print slipâ€¦', true);
                setTimeout(() => {
                    loadNukkadPrePanel();
                }, 800);
                // Auto-print after grant
                const enrollSnap = await db.ref('youthfest-enrollments').orderByChild('event').equalTo('Nukkad Natak').once('value');
                let adviserName='', adviserOrg='', theme='', memberCount=0;
                if (enrollSnap.exists()) {
                    enrollSnap.forEach(ch => {
                        const d = ch.val();
                        if ((d.classYear||d.class||'')===cls) {
                            memberCount++;
                            if (d.adviserName) adviserName = d.adviserName;
                            if (d.adviserOrg)  adviserOrg  = d.adviserOrg;
                            if (d.cause)       theme       = d.cause;
                        }
                    });
                }
                printNukkadSlip(cls, date, time, adviserName, theme, adviserOrg, memberCount);
            } catch(err) { showM('âŒ Error: ' + err.message, false); }
        }

        async function revokeNukkadPermission(cls, clsKey) {
            if (!confirm('Revoke permission for ' + cls + '? They will need a new slot.')) return;
            try {
                await db.ref('nukkadNatak/permissions/' + clsKey).remove();
                loadNukkadPrePanel();
            } catch(err) { alert('âŒ Error: ' + err.message); }
        }

        function printNukkadSlip(cls, date, time, adviserName, theme, adviserOrg, memberCount) {
            const formattedDate = date ? new Date(date + 'T00:00:00').toLocaleDateString('en-IN',{day:'2-digit',month:'long',year:'numeric'}) : date;
            const issuedBy = document.getElementById('facultyDashName') ? document.getElementById('facultyDashName').textContent : 'Kotrappa K';
            const slipHtml = `<!DOCTYPE html><html><head><title>Nukkad Natak Permission Slip</title>
            <style>
                body { font-family: 'Times New Roman', serif; margin: 40px; color: #111; }
                .header { text-align: center; border-bottom: 3px double #1a237e; padding-bottom: 14px; margin-bottom: 20px; }
                .header h1 { font-size: 1.4em; color: #1a237e; margin: 0 0 4px; }
                .header h2 { font-size: 1.1em; color: #c44569; margin: 0 0 4px; }
                .header p  { font-size: 0.9em; margin: 0; color: #555; }
                .slip-title { text-align: center; font-size: 1.2em; font-weight: bold; color: #1a237e; margin: 18px 0 16px; text-decoration: underline; letter-spacing: 1px; }
                table { width: 100%; border-collapse: collapse; margin-bottom: 18px; }
                td { padding: 9px 14px; border: 1px solid #ccc; font-size: 0.95em; }
                td:first-child { font-weight: bold; width: 38%; background: #f5f5f5; color: #1a237e; }
                .note { background: #fff8e1; border: 1px solid #ffe082; border-radius: 6px; padding: 12px 16px; font-size: 0.88em; margin-bottom: 18px; }
                .sign { display: flex; justify-content: space-between; margin-top: 30px; }
                .sign div { text-align: center; width: 44%; }
                .sign .line { border-top: 2px solid #333; margin-bottom: 6px; }
                .sign p { font-size: 0.85em; margin: 0; }
                @media print { body { margin: 20px; } }
            </style></head><body>
            <div class="header">
                <h1>Davan Institute of Advanced Management Studies</h1>
                <h2>Spurthi Youth Festival 2026</h2>
                <p>Permission Letter â€” Nukkad Natak</p>
            </div>
            <div class="slip-title">PERMISSION SLIP â€” NUKKAD NATAK</div>
            <table>
                <tr><td>Class</td><td>${cls}</td></tr>
                <tr><td>Social Awareness Theme</td><td>${theme || 'â€”'}</td></tr>
                <tr><td>Social Adviser</td><td>${adviserName || 'â€”'}${adviserOrg ? ' <em>(' + adviserOrg + ')</em>' : ''}</td></tr>
                <tr><td>No. of Participants</td><td>${memberCount}</td></tr>
                <tr><td>Permitted Date</td><td>${formattedDate}</td></tr>
                <tr><td>Permitted Time</td><td>${time}</td></tr>
                <tr><td>Issued By</td><td>${issuedBy} (Faculty Incharge â€” Nukkad Natak)</td></tr>
                <tr><td>Date of Issue</td><td>${new Date().toLocaleDateString('en-IN',{day:'2-digit',month:'long',year:'numeric'})}</td></tr>
            </table>
            <div class="note">
                <strong>ðŸ“Œ Conditions:</strong><br>
                1. Team must be accompanied by the Social Adviser at all times during the performance.<br>
                2. Date, time and location have been pre-approved. Any change requires fresh permission.<br>
                3. Article must be published in local newspaper and clipping submitted to the organiser.<br>
                4. Complete video recording must be uploaded to YouTube and link shared with the organiser.<br>
                5. Feedback form (Flex) must be submitted to the organising team after the event.
            </div>
            <div class="sign">
                <div><div class="line"></div><p>${issuedBy}</p><p>Faculty Incharge â€” Nukkad Natak</p></div>
                <div><div class="line"></div><p>CR Signature</p><p>${cls}</p></div>
            </div>
            <script>window.onload=function(){window.print();}<\/script>
            </body></html>`;
            const w = window.open('','_blank','width=800,height=700');
            if (w) { w.document.write(slipHtml); w.document.close(); }
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // NUKKAD NATAK â€” SHANKAR POST-EVENT PANEL
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•


        // â”€â”€ Approve / Reject Place (Kotrappa) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        async function approveNukkadPlace(cls, clsKey) {
            const editEl = document.getElementById('placeEdit_' + clsKey);
            const place  = editEl ? editEl.value.trim() : '';
            if (!place) { alert('âŒ Place cannot be empty.'); return; }
            // Clash check against other classes
            try {
                const snap = await db.ref('nukkadNatak/pre').once('value');
                const all  = snap.val() || {};
                const clash = Object.entries(all).find(([k, v]) => k !== clsKey && v.place && v.place.toLowerCase().trim() === place.toLowerCase().trim() && v.placeApproved === true);
                if (clash) {
                    const clashCls = clash[1].savedBy || clash[0];
                    alert('âŒ Place clash! "' + place + '" is already approved for ' + clashCls + '. Edit and choose a different location.');
                    return;
                }
                await db.ref('nukkadNatak/pre/' + clsKey).update({ place: place, placeApproved: true, placeApprovedAt: new Date().toISOString() });
                alert('âœ… Place approved for ' + cls);
                loadNukkadPrePanel();
            } catch(e) { alert('âŒ Error: ' + e.message); }
        }
        async function rejectNukkadPlace(cls, clsKey) {
            const reason = prompt('Reason for rejection (will be shown to CR):', 'Place not suitable, please choose another location.');
            if (reason === null) return;
            try {
                await db.ref('nukkadNatak/pre/' + clsKey).update({ placeApproved: false, placeRejectedReason: reason, placeRejectedAt: new Date().toISOString() });
                alert('âŒ Place rejected for ' + cls + '. CR will see the reason.');
                loadNukkadPrePanel();
            } catch(e) { alert('âŒ Error: ' + e.message); }
        }

        // â”€â”€ All-in-one Overview Table (Point 5) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        async function loadNukkadOverviewTable() {
            const container = document.getElementById('nukkadOverviewTable');
            if (!container) return;
            container.innerHTML = '<div style="text-align:center;color:#aaa;padding:20px">Loadingâ€¦</div>';
            try {
                const [enrollSnap, preSnap, permSnap] = await Promise.all([
                    db.ref('youthfest-enrollments').orderByChild('event').equalTo('Nukkad Natak').once('value'),
                    db.ref('nukkadNatak/pre').once('value'),
                    db.ref('nukkadNatak/permissions').once('value')
                ]);
                const byClass = {};
                if (enrollSnap.exists()) {
                    enrollSnap.forEach(ch => {
                        const d = ch.val();
                        const cls = d.classYear || d.class || 'Unknown';
                        if (!byClass[cls]) byClass[cls] = { members: 0 };
                        byClass[cls].members++;
                    });
                }
                const pre  = preSnap.val()  || {};
                const perm = permSnap.val() || {};
                const classes = Object.keys(byClass).sort();
                if (!classes.length) { container.innerHTML = '<div style="text-align:center;color:#aaa;padding:20px">No enrollments yet.</div>'; return; }
                let rows = classes.map(cls => {
                    const key  = cls.replace(/[.#$/\[\]]/g,'_');
                    const p    = pre[key]  || {};
                    const pm   = perm[key] || {};
                    const placeColor = p.placeApproved===true?'#2e7d32':p.placeApproved===false?'#c62828':'#e65100';
                    const placeLabel = p.placeApproved===true?'âœ…':p.placeApproved===false?'âŒ':'â³';
                    return `<tr style="border-bottom:1px solid #eee;font-size:0.82em">
                        <td style="padding:8px 10px;font-weight:700;color:#1a237e">${cls}</td>
                        <td style="padding:8px 10px;color:${placeColor}">${placeLabel} ${p.place||'<em style="color:#aaa">Not set</em>'}</td>
                        <td style="padding:8px 10px">${p.adviserName||'<em style="color:#aaa">â€”</em>'}</td>
                        <td style="padding:8px 10px;color:${pm.granted?'#2e7d32':'#e65100'}">${pm.granted ? 'âœ… '+pm.date+' '+pm.time : 'â³ Pending'}</td>
                        <td style="padding:8px 10px">${byClass[cls].members}</td>
                    </tr>`;
                }).join('');
                container.innerHTML = `<table style="width:100%;border-collapse:collapse;background:white;border-radius:10px;overflow:hidden">
                    <thead><tr style="background:#1a237e;color:white;font-size:0.82em">
                        <th style="padding:10px;text-align:left">Class</th>
                        <th style="padding:10px;text-align:left">ðŸ“ Place</th>
                        <th style="padding:10px;text-align:left">ðŸŽ“ Adviser</th>
                        <th style="padding:10px;text-align:left">ðŸ“… Date & Time</th>
                        <th style="padding:10px;text-align:left">ðŸ‘¥ Members</th>
                    </tr></thead><tbody>${rows}</tbody></table>`;
            } catch(e) { container.innerHTML = '<div style="color:#c62828;padding:20px">âŒ Error: ' + e.message + '</div>'; }
        }

        async function loadNukkadPostPanel() {
            const listEl = document.getElementById('nukkadPostList');
            const badge  = document.getElementById('nukkadPostBadge');
            if (!listEl) return;
            listEl.innerHTML = '<div style="text-align:center;color:#aaa;padding:30px">Loadingâ€¦</div>';
            try {
                // Load all enrolled classes
                const enrollSnap = await db.ref('youthfest-enrollments').orderByChild('event').equalTo('Nukkad Natak').once('value');
                const enrolledClasses = new Set();
                if (enrollSnap.exists()) {
                    enrollSnap.forEach(ch => {
                        const d = ch.val();
                        enrolledClasses.add(d.classYear || d.class || 'Unknown');
                    });
                }
                // Load post-event submissions
                const postSnap = await db.ref('nukkadNatak/post').once('value');
                const postData = postSnap.val() || {};

                const classes = [...enrolledClasses].sort();
                if (badge) badge.textContent = classes.length + ' class' + (classes.length!==1?'es':'') + ' enrolled';

                let ytVerified=0, newsVerified=0;
                classes.forEach(cls => {
                    const key = cls.replace(/[.#$/\[\]]/g,'_');
                    const p = postData[key] || {};
                    if (p.ytVerified)        ytVerified++;
                    if (p.newspaperVerified) newsVerified++;
                });
                if (badge) badge.textContent = `${classes.length} classes | ðŸ“º ${ytVerified} YT verified | ðŸ“° ${newsVerified} newspaper verified`;

                if (!classes.length) {
                    listEl.innerHTML = '<div style="text-align:center;color:#aaa;padding:30px">No Nukkad Natak enrollments yet.</div>';
                    return;
                }

                listEl.innerHTML = classes.map(cls => {
                    const key = cls.replace(/[.#$/\[\]]/g,'_');
                    const p   = postData[key] || {};
                    const ytLink        = p.ytLink        || '';
                    const newspaperUrl  = p.newspaperUrl  || '';
                    const formLink      = p.formLink      || '';
                    const ytVerified    = p.ytVerified    === true;
                    const ytNotSub      = p.ytNotSubmitted  === true;
                    const newsVerified  = p.newspaperVerified === true;
                    const newsNotSub    = p.newspaperNotSubmitted === true;
                    const ytVerifiedBy  = p.ytVerifiedBy  || '';
                    const newsVerifiedBy= p.newspaperVerifiedBy || '';

                    return `<div style="background:white;border-radius:12px;border:2px solid #ffcc80;padding:16px;margin-bottom:4px">
                        <div style="font-weight:700;color:#e65100;font-size:0.95em;margin-bottom:12px">ðŸ« ${cls}</div>

                        <!-- YouTube -->
                        <div style="background:#fff8e1;border-radius:8px;padding:10px;margin-bottom:10px">
                            <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:8px">
                                <div>
                                    <div style="font-size:0.82em;font-weight:700;color:#c62828;margin-bottom:4px">ðŸ“º YouTube Link</div>
                                    ${ytLink
                                        ? `<a href="${ytLink}" target="_blank" style="color:#1565c0;font-size:0.8em;word-break:break-all">${ytLink}</a>`
                                        : '<span style="font-size:0.8em;color:#aaa">Not submitted yet</span>'}
                                    ${ytVerified ? `<div style="font-size:0.72em;color:#2e7d32;margin-top:2px">âœ… Verified by ${ytVerifiedBy}</div>` : ''}
                                </div>
                                <div style="display:flex;gap:6px;flex-wrap:wrap">
                                ${ytLink && !ytVerified ? `<button onclick="verifyNukkadYt('${cls}','${key}')" style="background:#2e7d32;color:white;border:none;border-radius:8px;padding:6px 12px;font-weight:700;cursor:pointer;font-size:0.8em;white-space:nowrap">âœ… Verify (+10 pts)</button>` : ''}
                                ${ytVerified ? `<span style="background:#e8f5e9;color:#2e7d32;padding:3px 10px;border-radius:10px;font-size:0.78em;font-weight:700">âœ… Verified</span>` : ''}
                                 ${ ytNotSub ? '<span style="background:#fce4ec;color:#b71c1c;padding:3px 10px;border-radius:10px;font-size:0.78em;font-weight:700">ðŸš« Not Submitted</span>' : (!ytLink ? '<span style="background:#fff3e0;color:#e65100;padding:3px 10px;border-radius:10px;font-size:0.78em;font-weight:700">â³ Pending</span><button onclick="markNukkadNotSubmitted(\'' + cls + '\',\'' + key + '\',\'yt\'" style="background:#b71c1c;color:white;border:none;border-radius:8px;padding:6px 12px;font-weight:700;cursor:pointer;font-size:0.78em">ðŸš« Mark Not Submitted</button>' : '') }
                                </div>
                            </div>
                        </div>

                        <!-- Newspaper -->
                        <div style="background:#f1f8e9;border-radius:8px;padding:10px;margin-bottom:10px">
                            <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:8px">
                                <div>
                                    <div style="font-size:0.82em;font-weight:700;color:#2e7d32;margin-bottom:4px">ðŸ“° Newspaper Photo</div>
                                    ${newspaperUrl
                                        ? `<a href="${newspaperUrl}" target="_blank"><img src="${newspaperUrl}" style="max-width:80px;border-radius:6px;border:2px solid #4caf50"></a>`
                                        : '<span style="font-size:0.8em;color:#aaa">Not submitted yet</span>'}
                                    ${newsVerified ? `<div style="font-size:0.72em;color:#2e7d32;margin-top:2px">âœ… Verified by ${newsVerifiedBy}</div>` : ''}
                                </div>
                                <div style="display:flex;gap:6px;flex-wrap:wrap">
                                ${newspaperUrl && !newsVerified ? `<button onclick="verifyNukkadNewspaper('${cls}','${key}')" style="background:#1b5e20;color:white;border:none;border-radius:8px;padding:6px 12px;font-weight:700;cursor:pointer;font-size:0.8em;white-space:nowrap">âœ… Verify (+10 pts)</button>` : ''}
                                ${newsVerified ? `<span style="background:#e8f5e9;color:#2e7d32;padding:3px 10px;border-radius:10px;font-size:0.78em;font-weight:700">âœ… Verified</span>` : ''}
                                 ${ newsNotSub ? '<span style="background:#fce4ec;color:#b71c1c;padding:3px 10px;border-radius:10px;font-size:0.78em;font-weight:700">ðŸš« Not Submitted</span>' : (!newspaperUrl ? '<span style="background:#fff3e0;color:#e65100;padding:3px 10px;border-radius:10px;font-size:0.78em;font-weight:700">â³ Pending</span><button onclick="markNukkadNotSubmitted(\'' + cls + '\',\'' + key + '\',\'newspaper\'" style="background:#b71c1c;color:white;border:none;border-radius:8px;padding:6px 12px;font-weight:700;cursor:pointer;font-size:0.78em">ðŸš« Mark Not Submitted</button>' : '') }
                                </div>
                            </div>
                        </div>

                        <!-- Google Form -->
                        ${formLink ? `<div style="font-size:0.8em"><strong>ðŸ“‹ Feedback Form:</strong> <a href="${formLink}" target="_blank" style="color:#4a148c">${formLink}</a></div>` : '<div style="font-size:0.78em;color:#aaa">ðŸ“‹ Feedback form link not submitted yet.</div>'}
                        <div id="nukkadPostMsg_${key}" style="display:none;margin-top:6px;font-size:0.78em;font-weight:600;padding:4px 10px;border-radius:6px"></div>
                    </div>`;
                }).join('');
            } catch(err) {
                if (listEl) listEl.innerHTML = `<div style="padding:20px;color:#c62828">âŒ Error: ${err.message}</div>`;
            }
        }


        async function markNukkadNotSubmitted(cls, key, type) {
            const label = type === 'yt' ? 'YouTube link' : 'Newspaper photo';
            if (!confirm('Mark ' + cls + ' as "Not Submitted" for ' + label + '?\n\nThis will record that the class did NOT submit this item. No points will be awarded.')) return;
            const markedBy = document.getElementById('facultyDashName') ? document.getElementById('facultyDashName').textContent : 'Verifier';
            try {
                const update = type === 'yt'
                    ? { ytNotSubmitted: true, ytNotSubmittedBy: markedBy, ytNotSubmittedAt: new Date().toISOString() }
                    : { newspaperNotSubmitted: true, newspaperNotSubmittedBy: markedBy, newspaperNotSubmittedAt: new Date().toISOString() };
                await db.ref('nukkadNatak/post/' + key).update(update);
                alert('ðŸš« Marked as Not Submitted for ' + cls);
                loadNukkadPostPanel();
            } catch(e) { alert('âŒ Error: ' + e.message); }
        }

        async function verifyNukkadYt(cls, key) {
            const verifiedBy = document.getElementById('facultyDashName').textContent || 'Shankar B C';
            const msgEl = document.getElementById('nukkadPostMsg_' + key);
            function showM(txt,ok){if(msgEl){msgEl.style.display='block';msgEl.style.background=ok?'#d4edda':'#f8d7da';msgEl.style.color=ok?'#155724':'#721c24';msgEl.textContent=txt;}}
            try {
                await db.ref('nukkadNatak/post/' + key).update({ ytVerified: true, ytVerifiedBy: verifiedBy, ytVerifiedAt: new Date().toISOString() });
                // Add +10 pts to leaderboard via customCriteria
                await addNukkadBonusPoints(cls, 'youtube', 10);
                showM('âœ… YouTube verified! +10 pts added to ' + cls, true);
                setTimeout(() => loadNukkadPostPanel(), 1000);
            } catch(err) { showM('âŒ Error: ' + err.message, false); }
        }

        async function verifyNukkadNewspaper(cls, key) {
            const verifiedBy = document.getElementById('facultyDashName').textContent || 'Shankar B C';
            const msgEl = document.getElementById('nukkadPostMsg_' + key);
            function showM(txt,ok){if(msgEl){msgEl.style.display='block';msgEl.style.background=ok?'#d4edda':'#f8d7da';msgEl.style.color=ok?'#155724':'#721c24';msgEl.textContent=txt;}}
            try {
                await db.ref('nukkadNatak/post/' + key).update({ newspaperVerified: true, newspaperVerifiedBy: verifiedBy, newspaperVerifiedAt: new Date().toISOString() });
                // Add +10 pts to leaderboard via customCriteria
                await addNukkadBonusPoints(cls, 'newspaper', 10);
                showM('âœ… Newspaper verified! +10 pts added to ' + cls, true);
                setTimeout(() => loadNukkadPostPanel(), 1000);
            } catch(err) { showM('âŒ Error: ' + err.message, false); }
        }

        async function addNukkadBonusPoints(cls, type, pts) {
            // Store under leaderboardConfig/customCriteria/nukkad_{type}_{clsKey}
            const clsKey   = cls.replace(/[.#$/\[\]]/g,'_');
            const critKey  = 'nukkad_' + type + '_' + clsKey;
            await db.ref('leaderboardConfig/customCriteria/' + critKey).set({
                label:  'Nukkad Natak â€” ' + (type === 'youtube' ? 'YouTube Verified' : 'Newspaper Verified'),
                points: { [clsKey]: pts }
            });
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // SITTING CODE GENERATOR (2-letter unique per event)
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        function generateSittingCode(existingCodes) {
            // Generate sequential numeric codes: 01, 02, 03, ... 99, 100, ...
            let num = 1;
            let code;
            do {
                code = String(num).padStart(2, '0');
                num++;
            } while (existingCodes.has(code) && num < 10000);
            existingCodes.add(code);
            return code;
        }

        async function ensureSittingCodes(event, dbPath) {
            // Load ALL enrollments for this event
            const fullSnap = await db.ref('youthfest-enrollments').once('value');
            if (!fullSnap.exists()) return;

            const allEntries = [];
            fullSnap.forEach(ch => {
                const d = ch.val();
                if (d.event !== event) return;
                allEntries.push({ key: ch.key, code: d.sittingCode || null });
            });

            // Check if any code is non-numeric (old letter codes) or duplicated or missing
            const codeCounts = {};
            allEntries.forEach(e => { if (e.code) codeCounts[e.code] = (codeCounts[e.code]||0)+1; });
            const hasLetterCodes = allEntries.some(e => e.code && !/^\d+$/.test(e.code));
            const hasDuplicates  = Object.values(codeCounts).some(c => c > 1);
            const hasMissing     = allEntries.some(e => !e.code);

            if (hasLetterCodes || hasDuplicates || hasMissing) {
                // Wipe all and reassign sequential numeric codes: 01, 02, 03...
                const updates = {};
                allEntries.forEach((e, idx) => {
                    updates['youthfest-enrollments/' + e.key + '/sittingCode'] = String(idx + 1).padStart(2, '0');
                });
                if (Object.keys(updates).length) await db.ref().update(updates);
            }
        }

        async function forceRegenerateSittingCodes(event) {
            if (!confirm(`âš ï¸ This will CLEAR and REGENERATE all sitting codes for "${event}".\n\nIf jury scoring has already started using the current codes, those codes will become invalid.\n\nProceed only if codes are duplicated. Continue?`)) return;
            try {
                const fullSnap = await db.ref('youthfest-enrollments').once('value');
                if (!fullSnap.exists()) { alert('No enrollments found.'); return; }
                const updates = {};
                let seqNum = 1;
                fullSnap.forEach(ch => {
                    const d = ch.val();
                    if (d.event !== event) return;
                    updates['youthfest-enrollments/' + ch.key + '/sittingCode'] = String(seqNum++).padStart(2, '0');
                });
                if (!Object.keys(updates).length) { alert('No enrollments for this event.'); return; }
                await db.ref().update(updates);
                alert(`âœ… ${Object.keys(updates).length} unique sitting codes regenerated for ${event}!`);
                if (event === 'Hand Writing') { loadHwAdminPanel(); loadHwAttendancePanel && loadHwAttendancePanel(); loadHandwritingPanel && loadHandwritingPanel(); }
                else if (event === 'Talent Hunt') { loadThAdminPanel(); loadThAttendancePanel && loadThAttendancePanel(); loadTalentHuntPanel && loadTalentHuntPanel(); }
            } catch(e) { alert('âŒ Error: ' + e.message); }
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // HAND WRITING â€” Faculty Attendance Panel
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        async function loadHwAttendancePanel() {
            const listEl = document.getElementById('handwritingList');
            if (!listEl) return;
            listEl.innerHTML = '<div style="text-align:center;color:#aaa;padding:20px">Loadingâ€¦</div>';
            await ensureSittingCodes('Hand Writing', 'handwriting');
            try {
                // Use full load + JS filter (reliable, no index needed)
                const [fullSnap, attSnap] = await Promise.all([
                    db.ref('youthfest-enrollments').once('value'),
                    db.ref('hwAttendance').once('value')
                ]);
                const att = attSnap.val() || {};
                let entries = [];
                if (fullSnap.exists()) fullSnap.forEach(ch => { const d = ch.val(); if (d.event === 'Hand Writing') entries.push({ key: ch.key, ...d }); });

                // Populate class filter
                const clsSel = document.getElementById('hwClassFilter');
                if (clsSel && clsSel.options.length <= 1) {
                    [...new Set(entries.map(e => e.classYear||e.class||'').filter(Boolean))].sort()
                        .forEach(c => { const o = document.createElement('option'); o.value = c; o.textContent = c; clsSel.appendChild(o); });
                }

                const cf = (document.getElementById('hwClassFilter')||{}).value || '';
                const sf = (document.getElementById('hwStatusFilter')||{}).value || '';
                let filtered = entries;
                if (cf) filtered = filtered.filter(e => (e.classYear||e.class||'') === cf);
                if (sf) filtered = filtered.filter(e => {
                    const st = att[e.key] ? att[e.key].status : 'pending';
                    return sf === 'pending' ? !att[e.key] || !att[e.key].status : st === sf;
                });

                const total   = entries.length;
                const present = entries.filter(e => att[e.key] && att[e.key].status === 'present').length;
                const absent  = entries.filter(e => att[e.key] && att[e.key].status === 'absent').length;
                const setEl = (id,v) => { const el=document.getElementById(id); if(el) el.textContent=v; };
                setEl('hwStatTotal', total); setEl('hwStatPresent', present); setEl('hwStatAbsent', absent);
                const badge = document.getElementById('hwSummaryBadge');
                if (badge) badge.textContent = `${filtered.length} shown Â· ${present} present Â· ${absent} absent`;

                if (!filtered.length) { listEl.innerHTML = '<div style="text-align:center;color:#aaa;padding:20px">No participants found.</div>'; return; }

                // Assign global sequential index map so even filtered view shows correct codes
                const hwCodeMap = {};
                entries.forEach((e, idx) => { hwCodeMap[e.key] = String(idx+1).padStart(2,'0'); });
                listEl.innerHTML = filtered.map(e => {
                    const attData = att[e.key] || {};
                    const status  = attData.status || 'pending';
                    const statusColor = status==='present'?'#155724':status==='absent'?'#721c24':'#856404';
                    const statusBg    = status==='present'?'#d4edda':status==='absent'?'#f8d7da':'#fff3cd';
                    const statusLabel = status==='present'?'âœ… Present':status==='absent'?'âŒ Absent':'â³ Not Marked';
                    const rawCode = e.sittingCode && /^\d+$/.test(e.sittingCode) ? e.sittingCode : hwCodeMap[e.key];
                    const code = rawCode ? 'HW-' + rawCode : 'â€”';
                    return `<div style="background:white;border-radius:10px;border:2px solid #e8eaf6;padding:12px 16px;display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:10px">
                        <div style="display:flex;align-items:center;gap:14px;flex-wrap:wrap">
                            <div style="background:linear-gradient(135deg,#1a237e,#4a148c);color:white;border-radius:10px;padding:8px 14px;font-weight:900;font-size:1.3em;letter-spacing:3px;min-width:60px;text-align:center">${code}</div>
                            <div>
                                <div style="font-weight:700;color:#333;font-size:0.95em">${e.name||e.memberName||'â€”'}</div>
                                <div style="font-size:0.8em;color:#666">${e.classYear||e.class||'â€”'} &nbsp;Â·&nbsp; ${e.languages||'English'}</div>
                            </div>
                        </div>
                        <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap">
                            <span style="background:${statusBg};color:${statusColor};padding:4px 12px;border-radius:10px;font-size:0.82em;font-weight:700">${statusLabel}</span>
                            <button onclick="hwMarkAttV1('${e.key}','present')" style="background:#2e7d32;color:white;border:none;border-radius:7px;padding:5px 12px;cursor:pointer;font-weight:700;font-size:0.82em;${status==='present'?'opacity:0.5':''}">âœ… Present</button>
                            <button onclick="hwMarkAttV1('${e.key}','absent')"  style="background:#c62828;color:white;border:none;border-radius:7px;padding:5px 12px;cursor:pointer;font-weight:700;font-size:0.82em;${status==='absent'?'opacity:0.5':''}">âŒ Absent</button>
                        </div>
                    </div>`;
                }).join('');
            } catch(e) { listEl.innerHTML = `<div style="color:#c62828;padding:20px">âŒ Error: ${e.message}</div>`; }
        }

        async function hwMarkAttV1(key, status) {
            const faculty = document.getElementById('facultyDashName').textContent || 'Faculty';
            await db.ref('hwAttendance/' + key).set({ status, markedBy: faculty, markedAt: new Date().toISOString() });
            loadHwAttendancePanel();
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // TALENT HUNT â€” Faculty Attendance Panel
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        async function loadThAttendancePanel() {
            const listEl = document.getElementById('talentHuntList');
            if (!listEl) return;
            listEl.innerHTML = '<div style="text-align:center;color:#aaa;padding:20px">Loadingâ€¦</div>';
            await ensureSittingCodes('Talent Hunt', 'talenthunt');
            try {
                // Use full load + JS filter (reliable, no index needed)
                const [fullSnap, attSnap] = await Promise.all([
                    db.ref('youthfest-enrollments').once('value'),
                    db.ref('thAttendance').once('value')
                ]);
                const att = attSnap.val() || {};
                let entries = [];
                if (fullSnap.exists()) fullSnap.forEach(ch => { const d = ch.val(); if (d.event === 'Talent Hunt') entries.push({ key: ch.key, ...d }); });

                // Populate filters
                const clsSel = document.getElementById('thClassFilter');
                if (clsSel && clsSel.options.length <= 1) {
                    [...new Set(entries.map(e => e.classYear||e.class||'').filter(Boolean))].sort()
                        .forEach(c => { const o = document.createElement('option'); o.value = c; o.textContent = c; clsSel.appendChild(o); });
                }

                const cf = (document.getElementById('thClassFilter')||{}).value || '';
                const tf = (document.getElementById('thTalentFilter')||{}).value || '';
                const sf = (document.getElementById('thStatusFilter')||{}).value || '';
                let filtered = entries;
                if (cf) filtered = filtered.filter(e => (e.classYear||e.class||'') === cf);
                if (tf) filtered = filtered.filter(e => (e.talentType||'') === tf);
                if (sf) filtered = filtered.filter(e => {
                    const st = att[e.key] ? att[e.key].status : 'pending';
                    return sf === 'pending' ? !att[e.key] || !att[e.key].status : st === sf;
                });

                const total   = entries.length;
                const present = entries.filter(e => att[e.key] && att[e.key].status === 'present').length;
                const absent  = entries.filter(e => att[e.key] && att[e.key].status === 'absent').length;
                const setEl = (id,v) => { const el=document.getElementById(id); if(el) el.textContent=v; };
                setEl('thStatTotal', total); setEl('thStatPresent', present); setEl('thStatAbsent', absent);
                const badge = document.getElementById('thSummaryBadge');
                if (badge) badge.textContent = `${filtered.length} shown Â· ${present} present Â· ${absent} absent`;

                if (!filtered.length) { listEl.innerHTML = '<div style="text-align:center;color:#aaa;padding:20px">No participants found.</div>'; return; }

                // Assign global sequential index map so even filtered view shows correct codes
                const thCodeMap = {};
                entries.forEach((e, idx) => { thCodeMap[e.key] = String(idx+1).padStart(2,'0'); });
                listEl.innerHTML = filtered.map(e => {
                    const attData = att[e.key] || {};
                    const status  = attData.status || 'pending';
                    const statusColor = status==='present'?'#155724':status==='absent'?'#721c24':'#856404';
                    const statusBg    = status==='present'?'#d4edda':status==='absent'?'#f8d7da':'#fff3cd';
                    const statusLabel = status==='present'?'âœ… Present':status==='absent'?'âŒ Absent':'â³ Not Marked';
                    const rawCode = e.sittingCode && /^\d+$/.test(e.sittingCode) ? e.sittingCode : thCodeMap[e.key];
                    const code = rawCode ? 'TH-' + rawCode : 'â€”';
                    const talentIcons = { 'Singing':'ðŸŽ¤','Dancing':'ðŸ’ƒ','Acting':'ðŸŽ­','Instrument Playing':'ðŸŽ¸','Mimicry':'ðŸ˜„','Magic':'ðŸŽ©','Stand-up Comedy':'ðŸ˜‚' };
                    const talentIcon = talentIcons[e.talentType] || 'â­';
                    return `<div style="background:white;border-radius:10px;border:2px solid #ffe0b2;padding:12px 16px;display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:10px">
                        <div style="display:flex;align-items:center;gap:14px;flex-wrap:wrap">
                            <div style="background:linear-gradient(135deg,#e65100,#ff6f00);color:white;border-radius:10px;padding:8px 14px;font-weight:900;font-size:1.3em;letter-spacing:3px;min-width:60px;text-align:center">${code}</div>
                            <div>
                                <div style="font-weight:700;color:#333;font-size:0.95em">${e.name||e.memberName||'â€”'}</div>
                                <div style="font-size:0.8em;color:#666">${e.classYear||e.class||'â€”'} &nbsp;Â·&nbsp; ${talentIcon} ${e.talentType||'â€”'}</div>
                            </div>
                        </div>
                        <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap">
                            <span style="background:${statusBg};color:${statusColor};padding:4px 12px;border-radius:10px;font-size:0.82em;font-weight:700">${statusLabel}</span>
                            <button onclick="thMarkAttV1('${e.key}','present')" style="background:#2e7d32;color:white;border:none;border-radius:7px;padding:5px 12px;cursor:pointer;font-weight:700;font-size:0.82em;${status==='present'?'opacity:0.5':''}">âœ… Present</button>
                            <button onclick="thMarkAttV1('${e.key}','absent')"  style="background:#c62828;color:white;border:none;border-radius:7px;padding:5px 12px;cursor:pointer;font-weight:700;font-size:0.82em;${status==='absent'?'opacity:0.5':''}">âŒ Absent</button>
                        </div>
                    </div>`;
                }).join('');
            } catch(e) { listEl.innerHTML = `<div style="color:#c62828;padding:20px">âŒ Error: ${e.message}</div>`; }
        }

        async function thMarkAttV1(key, status) {
            const faculty = document.getElementById('facultyDashName').textContent || 'Faculty';
            await db.ref('thAttendance/' + key).set({ status, markedBy: faculty, markedAt: new Date().toISOString() });
            loadThAttendancePanel();
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // HW + TH â€” Super Admin Panel Loaders
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        async function loadHwAdminPanel() {
            if (!isSuperAdmin && !isAdmin) return;
            hwLoadLeaderboardStatus();
            const empty = document.getElementById('hwAdminEmpty');
            const container = document.getElementById('hwAdminTableContainer');
            const tbody = document.getElementById('hwAdminTableBody');
            if (!tbody) return;
            if (empty) { empty.textContent = 'Loadingâ€¦'; empty.style.display = 'block'; }
            if (container) container.style.display = 'none';
            await ensureSittingCodes('Hand Writing', 'handwriting');
            try {
                const [fullSnap, attSnap, jurySnap] = await Promise.all([
                    db.ref('youthfest-enrollments').once('value'),
                    db.ref('hwAttendance').once('value'),
                    db.ref('handwriting/juryScores').once('value')
                ]);
                let entries = [];
                if (fullSnap.exists()) fullSnap.forEach(ch => { const d = ch.val(); if (d.event === 'Hand Writing') entries.push({ key: ch.key, ...d }); });
                const att   = attSnap.val()  || {};
                const jury  = jurySnap.val() || {};

                const clsSel = document.getElementById('hwAdminClassFilter');
                if (clsSel && clsSel.options.length <= 1) {
                    [...new Set(entries.map(e=>e.classYear||e.class||'').filter(Boolean))].sort()
                        .forEach(c=>{const o=document.createElement('option');o.value=c;o.textContent=c;clsSel.appendChild(o);});
                }
                const cf = (document.getElementById('hwAdminClassFilter')||{}).value||'';
                const sf = (document.getElementById('hwAdminStatusFilter')||{}).value||'';
                let filtered = [...entries];
                if (cf) filtered = filtered.filter(e=>(e.classYear||e.class||'')===cf);
                if (sf) filtered = filtered.filter(e=>{
                    const st = att[e.key]?att[e.key].status:'pending';
                    return sf==='pending'?!att[e.key]||!att[e.key].status:st===sf;
                });

                const total   = entries.length;
                const present = entries.filter(e=>att[e.key]&&att[e.key].status==='present').length;
                const absent  = entries.filter(e=>att[e.key]&&att[e.key].status==='absent').length;
                const scored  = entries.filter(e=>jury[e.key]&&(jury[e.key].j1!=null||jury[e.key].j2!=null)).length;
                const setEl=(id,v)=>{const el=document.getElementById(id);if(el)el.textContent=v;};
                setEl('hwAdminStatTotal',total);setEl('hwAdminStatPresent',present);setEl('hwAdminStatAbsent',absent);setEl('hwAdminStatScored',scored);

                // Rank by final score
                const withScores = filtered.map(e=>{
                    const j = jury[e.key]||{};
                    const j1 = j.j1!=null?+j.j1:null;
                    const j2 = j.j2!=null?+j.j2:null;
                    const avg = (j1!==null&&j2!==null)?(j1+j2)/2:(j1!==null?j1:(j2!==null?j2:null));
                    return {...e, _j1:j1, _j2:j2, _avg:avg};
                }).sort((a,b)=>(b._avg||0)-(a._avg||0));

                // Build sequential code map from the full entries list (before score sort)
                const hwAdminCodeMap = {};
                entries.forEach((e, idx) => { hwAdminCodeMap[e.key] = String(idx+1).padStart(2,'0'); });

                let rank=0, lastAvg=null;
                const rows = withScores.map((e,i)=>{
                    if(e._avg!==null&&e._avg!==lastAvg){rank=i+1;lastAvg=e._avg;}
                    const status = att[e.key]?att[e.key].status:'pending';
                    const statusBg=status==='present'?'#d4edda':status==='absent'?'#f8d7da':'#fff3cd';
                    const statusColor=status==='present'?'#155724':status==='absent'?'#721c24':'#856404';
                    const hwRawCode = (e.sittingCode && /^\d+$/.test(e.sittingCode)) ? e.sittingCode : hwAdminCodeMap[e.key];
                    return `<tr>
                        <td style="text-align:center;font-weight:900;color:#1a237e;font-size:1.1em;letter-spacing:2px">${hwRawCode?'HW-'+hwRawCode:'â€”'}</td>
                        <td style="font-weight:700;color:#333">${e.name||e.memberName||'â€”'}</td>
                        <td style="font-size:0.85em;color:#666">${e.classYear||e.class||'â€”'}</td>
                        <td style="font-size:0.82em">${e.languages||'English'}</td>
                        <td style="text-align:center"><span style="background:${statusBg};color:${statusColor};padding:2px 10px;border-radius:10px;font-size:0.75em;font-weight:700">${status==='present'?'âœ… Present':status==='absent'?'âŒ Absent':'â³ Pending'}</span></td>
                        <td style="text-align:center;background:#e3f2fd;font-weight:700;color:#1565c0">${e._j1!==null?e._j1+'/50':'â€”'}</td>
                        <td style="text-align:center;background:#e3f2fd;font-weight:700;color:#1565c0">${e._j2!==null?e._j2+'/50':'â€”'}</td>
                        <td style="text-align:center;background:#e8f5e9;font-weight:800;font-size:0.95em;color:#1b5e20">${e._avg!==null?e._avg.toFixed(1)+'/50':'â€”'}</td>
                        <td style="text-align:center;font-weight:800;color:${e._avg!==null?'#6a1b9a':'#aaa'}">${e._avg!==null?'#'+rank:'â€”'}</td>
                    </tr>`;
                }).join('');

                if (empty) empty.style.display = 'none';
                if (container) container.style.display = 'block';
                if (tbody) tbody.innerHTML = rows || '<tr><td colspan="9" style="text-align:center;color:#aaa;padding:20px">No participants.</td></tr>';
            } catch(e) {
                if (empty) { empty.textContent='âŒ Error: '+e.message; empty.style.display='block'; }
            }
        }

        async function loadThAdminPanel() {
            if (!isSuperAdmin && !isAdmin) return;
            thLoadLeaderboardStatus();
            const empty = document.getElementById('thAdminEmpty');
            const container = document.getElementById('thAdminTableContainer');
            const tbody = document.getElementById('thAdminTableBody');
            if (!tbody) return;
            if (empty) { empty.textContent = 'Loadingâ€¦'; empty.style.display = 'block'; }
            if (container) container.style.display = 'none';
            await ensureSittingCodes('Talent Hunt', 'talenthunt');
            try {
                const [fullSnap, attSnap, jurySnap] = await Promise.all([
                    db.ref('youthfest-enrollments').once('value'),
                    db.ref('thAttendance').once('value'),
                    db.ref('talenthunt/juryScores').once('value')
                ]);
                let entries = [];
                if (fullSnap.exists()) fullSnap.forEach(ch => { const d = ch.val(); if (d.event === 'Talent Hunt') entries.push({ key: ch.key, ...d }); });
                const att  = attSnap.val()  || {};
                const jury = jurySnap.val() || {};

                const clsSel = document.getElementById('thAdminClassFilter');
                if (clsSel && clsSel.options.length <= 1) {
                    [...new Set(entries.map(e=>e.classYear||e.class||'').filter(Boolean))].sort()
                        .forEach(c=>{const o=document.createElement('option');o.value=c;o.textContent=c;clsSel.appendChild(o);});
                }
                const cf=(document.getElementById('thAdminClassFilter')||{}).value||'';
                const sf=(document.getElementById('thAdminStatusFilter')||{}).value||'';
                let filtered=[...entries];
                if(cf)filtered=filtered.filter(e=>(e.classYear||e.class||'')===cf);
                if(sf)filtered=filtered.filter(e=>{
                    const st=att[e.key]?att[e.key].status:'pending';
                    return sf==='pending'?!att[e.key]||!att[e.key].status:st===sf;
                });

                const total   = entries.length;
                const present = entries.filter(e=>att[e.key]&&att[e.key].status==='present').length;
                const absent  = entries.filter(e=>att[e.key]&&att[e.key].status==='absent').length;
                const scored  = entries.filter(e=>jury[e.key]&&(jury[e.key].j1!=null||jury[e.key].j2!=null)).length;
                const setEl=(id,v)=>{const el=document.getElementById(id);if(el)el.textContent=v;};
                setEl('thAdminStatTotal',total);setEl('thAdminStatPresent',present);setEl('thAdminStatAbsent',absent);setEl('thAdminStatScored',scored);

                const talentIcons={'Singing':'ðŸŽ¤','Dancing':'ðŸ’ƒ','Acting':'ðŸŽ­','Instrument Playing':'ðŸŽ¸','Mimicry':'ðŸ˜„','Magic':'ðŸŽ©','Stand-up Comedy':'ðŸ˜‚'};

                const withScores=filtered.map(e=>{
                    const j=jury[e.key]||{};
                    const j1=j.j1!=null?+j.j1:null;
                    const j2=j.j2!=null?+j.j2:null;
                    const avg=(j1!==null&&j2!==null)?(j1+j2)/2:(j1!==null?j1:(j2!==null?j2:null));
                    return{...e,_j1:j1,_j2:j2,_avg:avg};
                }).sort((a,b)=>(b._avg||0)-(a._avg||0));

                // Build sequential code map from the full entries list (before score sort)
                const thAdminCodeMap = {};
                entries.forEach((e, idx) => { thAdminCodeMap[e.key] = String(idx+1).padStart(2,'0'); });

                let rank=0, lastAvg=null;
                const rows=withScores.map((e,i)=>{
                    if(e._avg!==null&&e._avg!==lastAvg){rank=i+1;lastAvg=e._avg;}
                    const status=att[e.key]?att[e.key].status:'pending';
                    const statusBg=status==='present'?'#d4edda':status==='absent'?'#f8d7da':'#fff3cd';
                    const statusColor=status==='present'?'#155724':status==='absent'?'#721c24':'#856404';
                    const tIcon=talentIcons[e.talentType]||'â­';
                    const thRawCode = (e.sittingCode && /^\d+$/.test(e.sittingCode)) ? e.sittingCode : thAdminCodeMap[e.key];
                    return`<tr>
                        <td style="text-align:center;font-weight:900;color:#e65100;font-size:1.1em;letter-spacing:2px">${thRawCode?'TH-'+thRawCode:'â€”'}</td>
                        <td style="font-weight:700;color:#333">${e.name||e.memberName||'â€”'}</td>
                        <td style="font-size:0.85em;color:#666">${e.classYear||e.class||'â€”'}</td>
                        <td style="font-size:0.82em">${tIcon} ${e.talentType||'â€”'}</td>
                        <td style="text-align:center"><span style="background:${statusBg};color:${statusColor};padding:2px 10px;border-radius:10px;font-size:0.75em;font-weight:700">${status==='present'?'âœ… Present':status==='absent'?'âŒ Absent':'â³ Pending'}</span></td>
                        <td style="text-align:center;background:#e3f2fd;font-weight:700;color:#1565c0">${e._j1!==null?e._j1+'/50':'â€”'}</td>
                        <td style="text-align:center;background:#e3f2fd;font-weight:700;color:#1565c0">${e._j2!==null?e._j2+'/50':'â€”'}</td>
                        <td style="text-align:center;background:#e8f5e9;font-weight:800;font-size:0.95em;color:#1b5e20">${e._avg!==null?e._avg.toFixed(1)+'/50':'â€”'}</td>
                        <td style="text-align:center;font-weight:800;color:${e._avg!==null?'#e65100':'#aaa'}">${e._avg!==null?'#'+rank:'â€”'}</td>
                    </tr>`;
                }).join('');

                if(empty)empty.style.display='none';
                if(container)container.style.display='block';
                if(tbody)tbody.innerHTML=rows||'<tr><td colspan="9" style="text-align:center;color:#aaa;padding:20px">No participants.</td></tr>';
            } catch(e) {
                if(empty){empty.textContent='âŒ Error: '+e.message;empty.style.display='block';}
            }
        }

        // -- HW + TH Leaderboard toggles -----------------------------
        async function hwLoadLeaderboardStatus() {
            const el = document.getElementById('hwLeaderboardStatusDisplay');
            if (!el) return;
            try {
                const snap = await db.ref('handwriting/settings/leaderboardPublished').once('value');
                const val = snap.val() === true;
                el.textContent = val ? 'ðŸš€ PUBLISHED â€” Visible in leaderboard' : 'ðŸ“¦ Not Published';
                el.style.background = val ? '#d4edda' : '#f5f5f5';
                el.style.color      = val ? '#155724' : '#666';
            } catch(e) { el.textContent = 'âš ï¸ Error'; }
        }
        async function hwSetLeaderboard(value) {
            const msgEl = document.getElementById('hwLeaderboardMsg');
            const showM=(t,ok)=>{msgEl.style.display='block';msgEl.style.background=ok?'#d4edda':'#f8d7da';msgEl.style.color=ok?'#155724':'#721c24';msgEl.textContent=t;};
            try {
                await db.ref('handwriting/settings/leaderboardPublished').set(value);
                showM(value?'âœ… Hand Writing results published!':'ðŸ“¦ Hand Writing results unpublished.',true);
                hwLoadLeaderboardStatus();
            } catch(e){showM('âŒ Error: '+e.message,false);}
        }
        async function thLoadLeaderboardStatus() {
            const el = document.getElementById('thLeaderboardStatusDisplay');
            if (!el) return;
            try {
                const snap = await db.ref('talenthunt/settings/leaderboardPublished').once('value');
                const val = snap.val() === true;
                el.textContent = val ? 'ðŸš€ PUBLISHED â€” Visible in leaderboard' : 'ðŸ“¦ Not Published';
                el.style.background = val ? '#d4edda' : '#f5f5f5';
                el.style.color      = val ? '#155724' : '#666';
            } catch(e) { el.textContent = 'âš ï¸ Error'; }
        }
        async function thSetLeaderboard(value) {
            const msgEl = document.getElementById('thLeaderboardMsg');
            const showM=(t,ok)=>{msgEl.style.display='block';msgEl.style.background=ok?'#d4edda':'#f8d7da';msgEl.style.color=ok?'#155724':'#721c24';msgEl.textContent=t;};
            try {
                await db.ref('talenthunt/settings/leaderboardPublished').set(value);
                showM(value?'âœ… Talent Hunt results published!':'ðŸ“¦ Talent Hunt results unpublished.',true);
                thLoadLeaderboardStatus();
            } catch(e){showM('âŒ Error: '+e.message,false);}
        }
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        const NUKKAD_SETTINGS_KEYS = ['eventActive', 'leaderboardPublished'];
        const NUKKAD_SETTINGS_LABELS = {
            eventActive:          { on: 'âœ… ACTIVE â€” CR submissions open', off: 'ðŸ”’ INACTIVE â€” submissions locked' },
            leaderboardPublished: { on: 'ðŸš€ PUBLISHED â€” Visible in leaderboard', off: 'ðŸ“¦ NOT PUBLISHED â€” Hidden from leaderboard' }
        };

        async function loadNukkadSettings() {
            for (const key of NUKKAD_SETTINGS_KEYS) {
                const elId = 'nukkadStatus' + key.charAt(0).toUpperCase() + key.slice(1);
                const el = document.getElementById(elId);
                if (!el) continue;
                try {
                    const snap = await db.ref('nukkadNatak/settings/' + key).once('value');
                    const val = snap.val() === true;
                    const lbl = NUKKAD_SETTINGS_LABELS[key];
                    el.textContent = val ? lbl.on : lbl.off;
                    el.style.color = val ? '#155724' : '#856404';
                } catch(e) { el.textContent = 'âš ï¸ Error'; }
            }
        }

        async function setNukkadSetting(key, value) {
            try {
                await db.ref('nukkadNatak/settings/' + key).set(value);
                // If publishing leaderboard, push jury scores to leaderboard
                if (key === 'leaderboardPublished' && value === true) {
                    await pushNukkadJuryScoresToLeaderboard();
                }
                loadNukkadSettings();
                loadNukkadAdminPanel();
            } catch(e) { alert('Error: ' + e.message); }
        }

        async function pushNukkadJuryScoresToLeaderboard() {
            // Load all jury scores and push final avg to leaderboardConfig/customCriteria
            const snap = await db.ref('nukkadNatak/juryScores').once('value');
            if (!snap.exists()) return;
            const allScores = snap.val();
            for (const [clsKey, scores] of Object.entries(allScores)) {
                const j1 = scores.juryTotal_j1 !== undefined ? +scores.juryTotal_j1 : null;
                const j2 = scores.juryTotal_j2 !== undefined ? +scores.juryTotal_j2 : null;
                const avg = (j1 !== null && j2 !== null) ? (j1+j2)/2 : (j1 !== null ? j1 : (j2 !== null ? j2 : null));
                if (avg === null) continue;
                const finalPts = Math.round(avg); // out of 50 â†’ use as leaderboard pts
                await db.ref('leaderboardConfig/customCriteria/nukkad_jury_' + clsKey).set({
                    label: 'Nukkad Natak â€” Jury Score',
                    points: { [clsKey]: finalPts }
                });
            }
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // NUKKAD NATAK â€” JURY SCORING
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        let nukkadJuryNum = null;
        const NUKKAD_JURY_CRITERIA = [
            'Script & Story',
            'Stage Presence',
            'Message Delivery',
            'Teamwork & Coordination',
            'Overall Impact'
        ];

        async function nukkadJuryLogin() {
            const num   = document.getElementById('nukkadJuryLoginNum').value;
            const pwd   = (document.getElementById('nukkadJuryLoginPwd').value || '').trim();
            const msgEl = document.getElementById('nukkadJuryLoginMsg');
            function showJMsg(text, ok) {
                msgEl.style.display = 'block';
                msgEl.style.background = ok ? '#d4edda' : '#f8d7da';
                msgEl.style.color      = ok ? '#155724' : '#721c24';
                msgEl.textContent = text;
            }
            if (!pwd) { showJMsg('âŒ Please enter the jury password.', false); return; }
            try {
                const snap  = await db.ref('jurySetup/Nukkad Natak').once('value');
                const setup = snap.val();
                if (!setup) { showJMsg('âŒ Jury not configured. Super Admin must set up "Nukkad Natak" in Jury Setup tab.', false); return; }
                const correctPwd = setup['jury' + num + 'Password'];
                const juryName   = setup['jury' + num + 'Name'] || ('Jury ' + num);
                if (!correctPwd || pwd !== correctPwd) { showJMsg('âŒ Incorrect password.', false); return; }
                nukkadJuryNum = num;
                showJMsg('âœ… Logged in as ' + juryName, true);
                const panel = document.getElementById('nukkadJuryScoringPanel');
                const lbl   = document.getElementById('nukkadJuryWhoLabel');
                if (panel) panel.style.display = 'block';
                if (lbl)   lbl.textContent = juryName + ' (Jury ' + num + ')';
                loadNukkadJuryScoringPanel();
            } catch(e) { showJMsg('âŒ Error: ' + e.message, false); }
        }

        async function loadNukkadJuryScoringPanel() {
            // Super Admin can score directly without jury login; default to jury 1 slot if not logged in as jury
            if (!nukkadJuryNum) nukkadJuryNum = isSuperAdmin ? '1' : null;
            if (!nukkadJuryNum) { alert('Please log in as Jury from the main login screen first.'); return; }
            const cont = document.getElementById('nukkadJuryScoringList');
            if (!cont) return;
            cont.innerHTML = '<p style="color:#999;text-align:center;padding:20px">Loading enrolled classesâ€¦</p>';
            try {
                const enrollSnap = await db.ref('youthfest-enrollments').orderByChild('event').equalTo('Nukkad Natak').once('value');
                const byClass = {};
                if (enrollSnap.exists()) {
                    enrollSnap.forEach(ch => {
                        const d = ch.val();
                        const cls = d.classYear || d.class || 'Unknown';
                        if (!byClass[cls]) byClass[cls] = { cause: d.cause || '' };
                    });
                }
                const classes = Object.keys(byClass).sort();
                if (!classes.length) { cont.innerHTML = '<p style="color:#999;text-align:center;padding:20px">No Nukkad Natak enrollments yet.</p>'; return; }

                // Load existing scores
                const scoresSnap = await db.ref('nukkadNatak/juryScores').once('value');
                const allJuryScores = scoresSnap.val() || {};

                cont.innerHTML = classes.map(cls => {
                    const key = cls.replace(/[.#$/\[\]]/g,'_');
                    const existing = (allJuryScores[key] && allJuryScores[key]['j' + nukkadJuryNum]) || {};
                    const total = NUKKAD_JURY_CRITERIA.reduce((s,c) => s + (+existing[c.replace(/[^a-zA-Z0-9]/g,'_')] || 0), 0);

                    const criteriaRows = NUKKAD_JURY_CRITERIA.map(c => {
                        const cKey = c.replace(/[^a-zA-Z0-9]/g,'_');
                        return `<div style="display:flex;align-items:center;justify-content:space-between;padding:8px 0;border-bottom:1px solid #f0f0f0">
                            <span style="font-size:0.88em;color:#333;font-weight:600;flex:1">${c}</span>
                            <div style="display:flex;align-items:center;gap:6px">
                                <input type="number" min="0" max="10" value="${existing[cKey]||''}" id="nkj_${key}_${cKey}" placeholder="0"
                                       style="width:60px;padding:6px 8px;border:2px solid #ddd;border-radius:6px;font-size:0.9em;text-align:center;outline:none"
                                       oninput="updateNukkadJuryTotal('${key}')">
                                <span style="color:#1a237e;font-size:0.82em;font-weight:700">/10</span>
                            </div>
                        </div>`;
                    }).join('');

                    return `<div style="background:white;border-radius:12px;border:2px solid #c5cae9;margin-bottom:16px;overflow:hidden">
                        <div style="background:linear-gradient(135deg,#1a237e,#4a148c);padding:12px 16px;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:6px">
                            <div>
                                <div style="color:white;font-weight:700;font-size:0.95em">${cls}</div>
                                <div style="color:rgba(255,255,255,0.8);font-size:0.8em">Theme: ${byClass[cls].cause || 'â€”'}</div>
                            </div>
                        </div>
                        <div style="padding:14px 16px">
                            ${criteriaRows}
                            <div style="display:flex;justify-content:space-between;align-items:center;margin-top:12px;padding-top:10px;border-top:2px solid #c5cae9">
                                <div>
                                    <span style="font-size:0.88em;color:#666">Total: </span>
                                    <span id="nkjTotal_${key}" style="font-size:1.2em;font-weight:800;color:#1a237e">${total}</span>
                                    <span style="font-size:0.85em;color:#3949ab"> / 50</span>
                                </div>
                                <button onclick="saveNukkadJuryScore('${key}','${cls}')" style="background:linear-gradient(135deg,#4a148c,#1a237e);color:white;border:none;border-radius:8px;padding:8px 18px;cursor:pointer;font-size:0.88em;font-weight:700">ðŸ’¾ Save Score</button>
                            </div>
                            <div id="nkjSaveMsg_${key}" style="display:none;margin-top:8px;font-size:0.82em;font-weight:600;padding:6px 10px;border-radius:6px"></div>
                        </div>
                    </div>`;
                }).join('');
            } catch(e) {
                cont.innerHTML = `<p style="color:#c62828;padding:20px;text-align:center">âŒ Error: ${e.message}</p>`;
            }
        }

        function updateNukkadJuryTotal(key) {
            let total = 0;
            NUKKAD_JURY_CRITERIA.forEach(c => {
                const cKey = c.replace(/[^a-zA-Z0-9]/g,'_');
                const inp = document.getElementById('nkj_' + key + '_' + cKey);
                if (inp) total += Math.min(10, Math.max(0, +inp.value || 0));
            });
            const totEl = document.getElementById('nkjTotal_' + key);
            if (totEl) totEl.textContent = total;
        }

        async function saveNukkadJuryScore(key, cls) {
            const scores = {};
            let total = 0, valid = true;
            NUKKAD_JURY_CRITERIA.forEach(c => {
                const cKey = c.replace(/[^a-zA-Z0-9]/g,'_');
                const inp = document.getElementById('nkj_' + key + '_' + cKey);
                const val = inp ? Math.min(10, Math.max(0, +inp.value || 0)) : 0;
                if (inp && inp.value === '') valid = false;
                scores[cKey] = val;
                total += val;
            });
            if (!valid) { alert('Please enter scores for all 5 criteria (0â€“10 each)'); return; }

            const updates = {};
            updates['j' + nukkadJuryNum] = scores;
            updates['juryTotal_j' + nukkadJuryNum] = total;

            // Load other jury's score to compute final avg
            const snap = await db.ref('nukkadNatak/juryScores/' + key).once('value').catch(() => null);
            const existing = snap ? (snap.val() || {}) : {};
            const otherTotal = nukkadJuryNum === '1' ? existing.juryTotal_j2 : existing.juryTotal_j1;
            if (otherTotal !== null && otherTotal !== undefined) {
                const avg = (total + (+otherTotal)) / 2;
                updates['finalAvg'] = +avg.toFixed(1);
                updates['finalPts'] = Math.round(avg);
            }

            const msgEl = document.getElementById('nkjSaveMsg_' + key);
            db.ref('nukkadNatak/juryScores/' + key).update(updates).then(() => {
                msgEl.style.display = 'block';
                msgEl.style.background = '#d4edda'; msgEl.style.color = '#155724';
                msgEl.textContent = 'âœ… Score saved! ' + total + '/50';
                setTimeout(() => msgEl.style.display = 'none', 4000);
                loadNukkadAdminPanel();
            }).catch(e => {
                msgEl.style.display = 'block';
                msgEl.style.background = '#f8d7da'; msgEl.style.color = '#721c24';
                msgEl.textContent = 'âŒ Error: ' + e.message;
            });
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // HANDWRITING & TALENT HUNT â€” SITTING CODE UTILITIES
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

        function generateSittingCode(key, eventPrefix) {
            // Returns a placeholder; actual sequential codes are assigned via ensureSittingCodes
            // Use a simple hash to produce a stable number for display fallback
            let hash = 0;
            const s = eventPrefix + key;
            for (let i = 0; i < s.length; i++) hash = ((hash << 5) - hash) + s.charCodeAt(i);
            hash = Math.abs(hash);
            const num = (hash % 99) + 1;
            return String(num).padStart(2, '0');
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // HANDWRITING COMPETITION â€” FACULTY PANEL
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

        async function loadHandwritingPanel() {
            const listEl = document.getElementById('handwritingList');
            if (!listEl) return;
            listEl.innerHTML = '<div style="text-align:center;color:#aaa;padding:30px">Loadingâ€¦</div>';
            const classFilter  = (document.getElementById('hwClassFilter')  || {}).value || '';
            const statusFilter = (document.getElementById('hwStatusFilter') || {}).value || '';
            try {
                const [fullSnap, attendSnap] = await Promise.all([
                    db.ref('youthfest-enrollments').once('value'),
                    db.ref('hwAttendance').once('value')
                ]);
                let entries = [];
                if (fullSnap.exists()) {
                    fullSnap.forEach(ch => {
                        const d = ch.val(); const key = ch.key;
                        if (d.event !== 'Hand Writing') return;
                        const att  = (attendSnap.val() || {})[key] || {};
                        entries.push({ ...d, _key: key, _status: att.status || 'pending' });
                    });
                }
                // Assign sequential sitting codes (use DB stored code if present, else use index)
                entries.forEach((e, idx) => {
                    e._code = e.sittingCode ? String(parseInt(e.sittingCode)||idx+1).padStart(2,'0') : String(idx+1).padStart(2,'0');
                });
                const clsSel = document.getElementById('hwClassFilter');
                if (clsSel && clsSel.options.length <= 1) {
                    const classes = [...new Set(entries.map(e => e.classYear || e.class || '').filter(Boolean))].sort();
                    classes.forEach(c => { const opt = document.createElement('option'); opt.value = c; opt.textContent = c; clsSel.appendChild(opt); });
                }
                const allSnap2 = attendSnap.val() || {};
                let allEntries = entries; // entries already filtered to Hand Writing
                const setStat = (id, v) => { const el = document.getElementById(id); if (el) el.textContent = v; };
                setStat('hwStatTotal',   allEntries.length);
                setStat('hwStatPresent', allEntries.filter(e => e._status === 'present').length);
                setStat('hwStatAbsent',  allEntries.filter(e => e._status === 'absent').length);
                const badge = document.getElementById('hwSummaryBadge');
                if (badge) badge.textContent = allEntries.filter(e=>e._status==='present').length + ' Present / ' + allEntries.length + ' Total';
                if (classFilter)  entries = entries.filter(e => (e.classYear||e.class||'') === classFilter);
                if (statusFilter) entries = entries.filter(e => e._status === statusFilter);
                if (!entries.length) { listEl.innerHTML = '<div style="text-align:center;color:#aaa;padding:30px">No entries found.</div>'; return; }
                const byClass = {};
                entries.forEach(e => { const cls = e.classYear||e.class||'Unknown'; if (!byClass[cls]) byClass[cls] = []; byClass[cls].push(e); });
                listEl.innerHTML = Object.entries(byClass).sort(([a],[b]) => a.localeCompare(b)).map(([cls, members]) => {
                    const clsPresent = members.filter(m => m._status === 'present').length;
                    const rows = members.map((e, idx) => {
                        const name = e.name || e.studentName || e.participantName || 'â€”';
                        const lang = e.languages || 'English';
                        const bg   = idx % 2 === 0 ? '#fafafa' : 'white';
                        const statusBadge = e._status === 'present' ? '<span style="background:#d4edda;color:#155724;padding:2px 10px;border-radius:10px;font-size:0.75em;font-weight:700">âœ… Present</span>' : e._status === 'absent' ? '<span style="background:#f8d7da;color:#721c24;padding:2px 10px;border-radius:10px;font-size:0.75em;font-weight:700">âŒ Absent</span>' : '<span style="background:#e9ecef;color:#495057;padding:2px 10px;border-radius:10px;font-size:0.75em;font-weight:700">â³ Not Marked</span>';
                        return `<div style="background:${bg};border-radius:8px;padding:10px 12px;display:flex;align-items:center;gap:10px;flex-wrap:wrap">
                            <span style="background:#1a237e;color:white;font-weight:900;padding:3px 10px;border-radius:8px;font-size:0.88em;min-width:40px;text-align:center;letter-spacing:3px">HW-${e._code}</span>
                            <div style="flex:1;min-width:140px"><div style="font-weight:700;color:#333;font-size:0.88em">${name}</div><div style="font-size:0.75em;color:#888">${cls} &nbsp;|&nbsp; ðŸŒ ${lang}</div></div>
                            ${statusBadge}
                            <div style="display:flex;gap:6px">
                                <button onclick="hwMarkAttendance('${e._key}','present')" style="background:#28a745;color:white;border:none;border-radius:6px;padding:4px 10px;cursor:pointer;font-size:0.78em;font-weight:700">âœ… Present</button>
                                <button onclick="hwMarkAttendance('${e._key}','absent')"  style="background:#dc3545;color:white;border:none;border-radius:6px;padding:4px 10px;cursor:pointer;font-size:0.78em;font-weight:700">âŒ Absent</button>
                            </div>
                            <div id="hwMsg_${e._key}" style="display:none;font-size:0.75em;font-weight:600;padding:3px 8px;border-radius:6px"></div>
                        </div>`;
                    }).join('');
                    return `<div style="background:white;border-radius:12px;border:2px solid #c5cae9;margin-bottom:14px;overflow:hidden">
                        <div style="background:linear-gradient(135deg,#1a237e,#3949ab);padding:10px 16px;display:flex;justify-content:space-between;align-items:center">
                            <span style="color:white;font-weight:700;font-size:0.95em">âœï¸ ${cls}</span>
                            <span style="background:rgba(255,255,255,0.25);color:white;padding:2px 12px;border-radius:12px;font-size:0.82em;font-weight:700">${clsPresent} / ${members.length} Present</span>
                        </div>
                        <div style="padding:8px 10px;display:flex;flex-direction:column;gap:6px">${rows}</div>
                    </div>`;
                }).join('');
            } catch(err) { if (listEl) listEl.innerHTML = `<div style="padding:20px;color:#c62828">âŒ Error: ${err.message}</div>`; }
        }

        async function hwMarkAttendance(key, status) {
            const markedBy = (document.getElementById('facultyDashName')||{}).textContent || 'Faculty';
            const msgEl = document.getElementById('hwMsg_' + key);
            try {
                await db.ref('hwAttendance/' + key).set({ status, markedBy, markedAt: new Date().toISOString() });
                if (msgEl) { msgEl.style.display='block'; msgEl.style.background=status==='present'?'#d4edda':'#f8d7da'; msgEl.style.color=status==='present'?'#155724':'#721c24'; msgEl.textContent=status==='present'?'âœ… Marked Present':'âŒ Marked Absent'; }
                setTimeout(() => loadHwAttendancePanel(), 1000);
            } catch(err) { if (msgEl) { msgEl.style.display='block'; msgEl.style.background='#f8d7da'; msgEl.style.color='#721c24'; msgEl.textContent='âŒ '+err.message; } }
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // TALENT HUNT â€” FACULTY PANEL
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

        async function loadTalentHuntPanel() {
            const listEl = document.getElementById('talentHuntList');
            if (!listEl) return;
            listEl.innerHTML = '<div style="text-align:center;color:#aaa;padding:30px">Loadingâ€¦</div>';
            const classFilter  = (document.getElementById('thClassFilter')  || {}).value || '';
            const statusFilter = (document.getElementById('thStatusFilter') || {}).value || '';
            const talentFilter = (document.getElementById('thTalentFilter') || {}).value || '';
            const TALENT_EMOJIS = {'Singing':'ðŸŽ¤','Dancing':'ðŸ’ƒ','Acting':'ðŸŽ­','Instrument':'ðŸŽ¸','Mimicry':'ðŸ˜„','Magic':'ðŸŽ©','Stand-up Comedy':'ðŸ˜‚','Other':'â­'};
            try {
                const [fullSnap, attendSnap] = await Promise.all([
                    db.ref('youthfest-enrollments').once('value'),
                    db.ref('thAttendance').once('value')
                ]);
                let entries = [];
                if (fullSnap.exists()) {
                    fullSnap.forEach(ch => {
                        const d = ch.val(); const key = ch.key;
                        if (d.event !== 'Talent Hunt') return;
                        const att  = (attendSnap.val() || {})[key] || {};
                        entries.push({ ...d, _key: key, _status: att.status || 'pending' });
                    });
                }
                // Assign sequential sitting codes (use DB stored code if present, else use index)
                entries.forEach((e, idx) => {
                    e._code = e.sittingCode ? String(parseInt(e.sittingCode)||idx+1).padStart(2,'0') : String(idx+1).padStart(2,'0');
                });
                const clsSel = document.getElementById('thClassFilter');
                if (clsSel && clsSel.options.length <= 1) {
                    const classes = [...new Set(entries.map(e => e.classYear||e.class||'').filter(Boolean))].sort();
                    classes.forEach(c => { const opt = document.createElement('option'); opt.value=c; opt.textContent=c; clsSel.appendChild(opt); });
                }
                const allSnap2 = attendSnap.val() || {};
                let allEntries = entries; // entries already filtered to Talent Hunt
                const setStat = (id, v) => { const el = document.getElementById(id); if (el) el.textContent = v; };
                setStat('thStatTotal',   allEntries.length);
                setStat('thStatPresent', allEntries.filter(e=>e._status==='present').length);
                setStat('thStatAbsent',  allEntries.filter(e=>e._status==='absent').length);
                const badge = document.getElementById('thSummaryBadge');
                if (badge) badge.textContent = allEntries.filter(e=>e._status==='present').length + ' Present / ' + allEntries.length + ' Total';
                if (classFilter)  entries = entries.filter(e => (e.classYear||e.class||'') === classFilter);
                if (statusFilter) entries = entries.filter(e => e._status === statusFilter);
                if (talentFilter) entries = entries.filter(e => (e.talentType||'') === talentFilter);
                if (!entries.length) { listEl.innerHTML = '<div style="text-align:center;color:#aaa;padding:30px">No entries found for current filters.</div>'; return; }
                entries.sort((a,b) => a._code.localeCompare(b._code));
                listEl.innerHTML = entries.map((e, idx) => {
                    const name   = e.name||e.studentName||e.participantName||'â€”';
                    const cls    = e.classYear||e.class||'â€”';
                    const talent = e.talentType||'â€”';
                    const emoji  = TALENT_EMOJIS[talent]||'â­';
                    const bg     = idx%2===0?'#fffde7':'white';
                    const statusBadge = e._status==='present' ? '<span style="background:#d4edda;color:#155724;padding:2px 10px;border-radius:10px;font-size:0.75em;font-weight:700">âœ… Present</span>' : e._status==='absent' ? '<span style="background:#f8d7da;color:#721c24;padding:2px 10px;border-radius:10px;font-size:0.75em;font-weight:700">âŒ Absent</span>' : '<span style="background:#e9ecef;color:#495057;padding:2px 10px;border-radius:10px;font-size:0.75em;font-weight:700">â³ Not Marked</span>';
                    return `<div style="background:${bg};border-radius:8px;border:1.5px solid #ffe082;padding:10px 12px;display:flex;align-items:center;gap:10px;flex-wrap:wrap">
                        <span style="background:#e65100;color:white;font-weight:900;padding:3px 10px;border-radius:8px;font-size:0.88em;min-width:40px;text-align:center;letter-spacing:3px">TH-${e._code}</span>
                        <div style="flex:1;min-width:140px"><div style="font-weight:700;color:#333;font-size:0.88em">${name}</div><div style="font-size:0.75em;color:#888">${cls} &nbsp;|&nbsp; ${emoji} ${talent}</div></div>
                        ${statusBadge}
                        <div style="display:flex;gap:6px">
                            <button onclick="thMarkAttendance('${e._key}','present')" style="background:#28a745;color:white;border:none;border-radius:6px;padding:4px 10px;cursor:pointer;font-size:0.78em;font-weight:700">âœ… Present</button>
                            <button onclick="thMarkAttendance('${e._key}','absent')"  style="background:#dc3545;color:white;border:none;border-radius:6px;padding:4px 10px;cursor:pointer;font-size:0.78em;font-weight:700">âŒ Absent</button>
                        </div>
                        <div id="thMsg_${e._key}" style="display:none;font-size:0.75em;font-weight:600;padding:3px 8px;border-radius:6px"></div>
                    </div>`;
                }).join('');
            } catch(err) { if (listEl) listEl.innerHTML = `<div style="padding:20px;color:#c62828">âŒ Error: ${err.message}</div>`; }
        }

        async function thMarkAttendance(key, status) {
            const markedBy = (document.getElementById('facultyDashName')||{}).textContent || 'Faculty';
            const msgEl = document.getElementById('thMsg_' + key);
            try {
                await db.ref('thAttendance/' + key).set({ status, markedBy, markedAt: new Date().toISOString() });
                if (msgEl) { msgEl.style.display='block'; msgEl.style.background=status==='present'?'#d4edda':'#f8d7da'; msgEl.style.color=status==='present'?'#155724':'#721c24'; msgEl.textContent=status==='present'?'âœ… Marked Present':'âŒ Marked Absent'; }
                setTimeout(() => loadThAttendancePanel(), 1000);
            } catch(err) { if (msgEl) { msgEl.style.display='block'; msgEl.style.background='#f8d7da'; msgEl.style.color='#721c24'; msgEl.textContent='âŒ '+err.message; } }
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // NUKKAD NATAK â€” SUPER ADMIN PANEL (with jury columns)
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

        async function loadNukkadAdminPanel() {
            if (!isSuperAdmin && !isAdmin) return;
            loadNukkadSettings();
            const empty     = document.getElementById('nukkadAdminEmpty');
            const container = document.getElementById('nukkadAdminTableContainer');
            const tbody     = document.getElementById('nukkadAdminTableBody');
            if (!tbody) return;
            if (empty)     { empty.textContent = 'Loadingâ€¦'; empty.style.display = 'block'; }
            if (container) container.style.display = 'none';

            try {
                const classFilter = (document.getElementById('nukkadAdminClassFilter') || {}).value || '';

                const [enrollSnap, permSnap, postSnap, preSnap, jurySnap] = await Promise.all([
                    db.ref('youthfest-enrollments').orderByChild('event').equalTo('Nukkad Natak').once('value'),
                    db.ref('nukkadNatak/permissions').once('value'),
                    db.ref('nukkadNatak/post').once('value'),
                    db.ref('nukkadNatak/pre').once('value'),
                    db.ref('nukkadNatak/juryScores').once('value')
                ]);

                const byClass = {};
                if (enrollSnap.exists()) {
                    enrollSnap.forEach(ch => {
                        const d = ch.val();
                        const cls = d.classYear || d.class || 'Unknown';
                        if (!byClass[cls]) byClass[cls] = { members:[], cause:'' };
                        byClass[cls].members.push(d);
                        if (d.cause) byClass[cls].cause = d.cause;
                    });
                }

                const perms      = permSnap.val()  || {};
                const postData   = postSnap.val()   || {};
                const preData    = preSnap.val()    || {};
                const juryData   = jurySnap.val()   || {};
                let classes      = Object.keys(byClass).sort();

                // Populate class filter dropdown
                const clsSel = document.getElementById('nukkadAdminClassFilter');
                if (clsSel && clsSel.options.length <= 1) {
                    classes.forEach(c => {
                        const opt = document.createElement('option'); opt.value = c; opt.textContent = c; clsSel.appendChild(opt);
                    });
                }
                if (classFilter) classes = classes.filter(c => c === classFilter);

                // Stats
                let adviserCount=0, permCount=0, ytCount=0, newsCount=0;
                Object.keys(byClass).forEach(cls => {
                    const key = cls.replace(/[.#$/\[\]]/g,'_');
                    if (preData[key]  && preData[key].adviserName)        adviserCount++;
                    if (perms[key]    && perms[key].granted)               permCount++;
                    if (postData[key] && postData[key].ytVerified)         ytCount++;
                    if (postData[key] && postData[key].newspaperVerified)  newsCount++;
                });
                const setStat = (id, v) => { const el = document.getElementById(id); if (el) el.textContent = v; };
                setStat('nukkadAdminStatClasses', Object.keys(byClass).length);
                setStat('nukkadAdminStatAdviser', adviserCount);
                setStat('nukkadAdminStatPerm',    permCount);
                setStat('nukkadAdminStatYt',      ytCount);
                setStat('nukkadAdminStatNews',     newsCount);

                if (!classes.length) {
                    if (empty)     { empty.textContent = 'No Nukkad Natak enrollments yet.'; empty.style.display = 'block'; }
                    if (container) container.style.display = 'none';
                    return;
                }

                let rows = '';
                classes.forEach((cls, i) => {
                    const data  = byClass[cls];
                    const key   = cls.replace(/[.#$/\[\]]/g,'_');
                    const perm  = perms[key]    || {};
                    const post  = postData[key] || {};
                    const pre   = preData[key]  || {};
                    const jury  = juryData[key] || {};
                    const hasPerm   = perm.granted === true;
                    const ytVerif   = post.ytVerified === true;
                    const newsVerif = post.newspaperVerified === true;
                    const hasAdviser = !!(pre.adviserName);

                    // Jury
                    const j1 = jury.juryTotal_j1 !== undefined ? +jury.juryTotal_j1 : null;
                    const j2 = jury.juryTotal_j2 !== undefined ? +jury.juryTotal_j2 : null;
                    const avg = (j1 !== null && j2 !== null) ? (j1+j2)/2 : (j1 !== null ? j1 : (j2 !== null ? j2 : null));
                    const gap = (j1 !== null && j2 !== null) ? Math.abs(j1-j2) : null;
                    const dispute = gap !== null && gap >= 10;

                    // Status
                    let allDone = hasPerm && ytVerif && newsVerif && !!post.formLink && avg !== null;
                    let statusLabel = allDone ? 'Complete' : (hasPerm ? 'In Progress' : 'Pending');
                    let statusBg    = allDone ? '#d4edda' : (hasPerm ? '#fff3cd' : '#f3e5f5');
                    let statusColor = allDone ? '#155724' : (hasPerm ? '#856404' : '#6a1b9a');

                    // Cells
                    const adviserCell = hasAdviser ? `<span style="font-weight:700;color:#4a148c;font-size:0.82em">${pre.adviserName}</span>` : `<span style="color:#aaa;font-size:0.8em">â€”</span>`;
                    const orgCell     = hasAdviser ? `<span style="font-size:0.8em;color:#555">${pre.adviserOrg||'â€”'}</span>` : `<span style="color:#aaa;font-size:0.8em">â€”</span>`;
                    const permCell    = hasPerm ? `<span style="background:#e8f5e9;color:#2e7d32;padding:2px 8px;border-radius:8px;font-size:0.72em;font-weight:700">âœ… Granted</span>` : `<span style="background:#fce4ec;color:#c62828;padding:2px 8px;border-radius:8px;font-size:0.72em;font-weight:700">âŒ Not Yet</span>`;
                    const slotCell    = hasPerm ? `<span style="font-size:0.78em;color:#1a237e">${perm.date||''} ${perm.time||''}</span>` : `<span style="color:#aaa;font-size:0.8em">â€”</span>`;

                    const ytCell = post.ytLink
                        ? `<div style="display:flex;flex-direction:column;align-items:center;gap:3px">
                               <a href="${post.ytLink}" target="_blank" style="color:#c62828;font-weight:700;font-size:0.82em">â–¶ï¸ View</a>
                               ${ytVerif ? '<span style="background:#e8f5e9;color:#2e7d32;padding:1px 7px;border-radius:8px;font-size:0.7em;font-weight:700">âœ… Verified</span>' : `<button onclick="verifyNukkadYt('${cls}','${key}')" style="background:#2e7d32;color:white;border:none;border-radius:6px;padding:2px 8px;cursor:pointer;font-size:0.7em;font-weight:700">âœ… Verify</button>`}
                           </div>`
                        : `<span style="color:#aaa;font-size:0.8em">Not submitted</span>`;

                    const newsCell = post.newspaperUrl
                        ? `<div style="display:flex;flex-direction:column;align-items:center;gap:3px">
                               <a href="${post.newspaperUrl}" target="_blank"><img src="${post.newspaperUrl}" style="max-width:50px;max-height:40px;border-radius:4px;border:1px solid #ccc"></a>
                               ${newsVerif ? '<span style="background:#e8f5e9;color:#2e7d32;padding:1px 7px;border-radius:8px;font-size:0.7em;font-weight:700">âœ… Verified</span>' : `<button onclick="verifyNukkadNewspaper('${cls}','${key}')" style="background:#1b5e20;color:white;border:none;border-radius:6px;padding:2px 8px;cursor:pointer;font-size:0.7em;font-weight:700">âœ… Verify</button>`}
                           </div>`
                        : `<span style="color:#aaa;font-size:0.8em">Not uploaded</span>`;

                    const formCell = post.formLink ? `<a href="${post.formLink}" target="_blank" style="color:#4a148c;font-weight:700;font-size:0.82em">ðŸ”— Open</a>` : `<span style="color:#aaa;font-size:0.8em">â€”</span>`;

                    const j1Cell = j1 !== null ? `<span style="font-weight:700;color:#1565c0">${j1}/50</span>` : `<span style="color:#aaa">â€”</span>`;
                    const j2Cell = j2 !== null ? `<span style="font-weight:700;color:#1565c0">${j2}/50</span>` : `<span style="color:#aaa">â€”</span>`;
                    const finalCell = avg !== null
                        ? `<div style="font-weight:800;font-size:0.95em;color:${dispute?'#e65100':'#1b5e20'}">${avg.toFixed(1)}/50${dispute?'<br><span style="font-size:0.7em;background:#fff3e0;color:#e65100;padding:1px 5px;border-radius:6px">âš ï¸ Dispute</span>':''}</div>`
                        : `<span style="color:#aaa">â€”</span>`;

                    rows += `<tr>
                        <td style="text-align:center;font-weight:700;color:#1a237e">${i+1}</td>
                        <td style="font-weight:700;color:#1565c0;font-size:0.85em">${cls}</td>
                        <td style="font-size:0.82em;color:#4a148c">${data.cause||'<em style="color:#aaa">Not set</em>'}</td>
                        <td style="text-align:center;font-weight:700">${data.members.length}</td>
                        <td style="background:#f9f0ff">${adviserCell}</td>
                        <td style="background:#f9f0ff">${orgCell}</td>
                        <td style="text-align:center;background:#f0f4ff">${permCell}</td>
                        <td style="text-align:center;background:#f0f4ff">${slotCell}</td>
                        <td style="text-align:center;background:#fff5f5">${ytCell}</td>
                        <td style="text-align:center;background:#f5fff7">${newsCell}</td>
                        <td style="text-align:center;background:#f8f0ff">${formCell}</td>
                        <td style="text-align:center;background:#e3f2fd">${j1Cell}</td>
                        <td style="text-align:center;background:#e3f2fd">${j2Cell}</td>
                        <td style="text-align:center;background:#e8f5e9">${finalCell}</td>
                        <td style="text-align:center"><span style="background:${statusBg};color:${statusColor};padding:3px 10px;border-radius:12px;font-size:0.75em;font-weight:700">${statusLabel}</span></td>
                        <td style="text-align:center">
                            ${!hasPerm ? `<button onclick="grantNukkadPermissionAdmin('${cls}','${key}')" style="background:#1a237e;color:white;border:none;border-radius:6px;padding:4px 8px;cursor:pointer;font-size:0.72em;font-weight:700;margin:2px">ðŸ”“ Perm</button>` : `<button onclick="revokeNukkadPermission('${cls}','${key}')" style="background:#c62828;color:white;border:none;border-radius:6px;padding:4px 8px;cursor:pointer;font-size:0.72em;font-weight:700;margin:2px">âŒ Revoke</button>`}
                        </td>
                    </tr>
                    <tr id="nukkadAdminMsgRow_${key}" style="display:none">
                        <td colspan="16"><div id="nukkadPostMsg_${key}" style="font-size:0.78em;font-weight:600;padding:4px 10px;border-radius:6px"></div></td>
                    </tr>`;
                });

                if (empty)     empty.style.display = 'none';
                if (container) container.style.display = 'block';
                if (tbody)     tbody.innerHTML = rows;

            } catch(err) {
                if (empty) { empty.textContent = 'âŒ Error: ' + err.message; empty.style.display = 'block'; }
                if (container) container.style.display = 'none';
            }
        }

        async function grantNukkadPermissionAdmin(cls, key) {
            const date = prompt('Enter performance date (e.g. 12-03-2026):');
            if (!date) return;
            const time = prompt('Enter time slot (e.g. 10:00â€“10:30 AM):');
            if (!time) return;
            await db.ref('nukkadNatak/permissions/' + key).set({ granted: true, date, time, issuedBy: 'Super Admin', issuedAt: new Date().toISOString() });
            const msgEl = document.getElementById('nukkadPostMsg_' + key);
            const msgRow = document.getElementById('nukkadAdminMsgRow_' + key);
            if (msgEl)  { msgEl.style.background='#d4edda'; msgEl.style.color='#155724'; msgEl.textContent='âœ… Permission granted!'; }
            if (msgRow) msgRow.style.display = '';
            loadNukkadAdminPanel();
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // BOW â€” Leaderboard Published toggle
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        async function loadBowLeaderboardStatus() {
            const el = document.getElementById('bowLeaderboardStatusDisplay');
            if (!el) return;
            try {
                const snap = await db.ref('jurySetup/Best out of Waste/leaderboardPublished').once('value');
                const val = snap.val() === true;
                el.textContent  = val ? 'ðŸš€ PUBLISHED â€” Visible in leaderboard' : 'ðŸ“¦ Not Published';
                el.style.background = val ? '#d4edda' : '#f5f5f5';
                el.style.color      = val ? '#155724' : '#666';
            } catch(e) { el.textContent = 'âš ï¸ Error'; }
        }

        async function bowSetLeaderboard(value) {
            const msgEl = document.getElementById('bowLeaderboardMsg');
            function showM(txt, ok) { msgEl.style.display='block'; msgEl.style.background=ok?'#d4edda':'#f8d7da'; msgEl.style.color=ok?'#155724':'#721c24'; msgEl.textContent=txt; }
            try {
                await db.ref('jurySetup/Best out of Waste/leaderboardPublished').set(value);
                showM(value ? 'âœ… BOW results published to leaderboard!' : 'ðŸ“¦ BOW results unpublished.', true);
                loadBowLeaderboardStatus();
            } catch(e) { showM('âŒ Error: ' + e.message, false); }
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // END NUKKAD NATAK
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // GROUP DANCE â€” CR STORY SUBMISSION
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

        async function loadCRDancePanel() {
            const cls = crClass;
            if (!cls) return;
            // Update class name in banner
            const nameEl = document.getElementById('dancecrClassName');
            if (nameEl) nameEl.textContent = cls;
            // Load enrolled participants
            const listEl = document.getElementById('danceEnrolledList');
            if (listEl) listEl.innerHTML = 'Loadingâ€¦';
            try {
                const snap = await db.ref('youthfest-enrollments').once('value');
                const members = [];
                if (snap.exists()) {
                    snap.forEach(ch => {
                        const d = ch.val();
                        if ((d.event || '').toLowerCase().replace(/\s/g,'') === 'groupdance' &&
                            (d.classYear || d.class || '') === cls) {
                            members.push(d);
                        }
                    });
                }
                if (listEl) {
                    if (members.length === 0) {
                        listEl.innerHTML = '<span style="color:#aaa;font-style:italic">No participants enrolled for Group Dance from your class yet.</span>';
                    } else {
                        listEl.innerHTML = members.map((m, i) => {
                            const role = m.role ? ' <span style="background:#f3e5f5;color:#6a1b9a;padding:1px 7px;border-radius:8px;font-size:0.75em;font-weight:700">' + m.role + '</span>' : '';
                            return '<div style="display:inline-flex;align-items:center;gap:4px;background:white;border:1.5px solid #f48fb1;border-radius:20px;padding:4px 12px;margin:3px;font-size:0.85em;font-weight:600;color:#880e4f">'
                                + 'ðŸ’ƒ ' + (m.name || 'â€”') + role + '</div>';
                        }).join('');
                    }
                }
                // Load saved story if any
                const clsKey = cls.replace(/[.\[\]#$\/\s]/g, '_');
                const storySnap = await db.ref('groupDance/' + clsKey).once('value');
                const story = storySnap.val();
                if (story && story.title) {
                    // Show saved display
                    document.getElementById('danceTitle').value   = story.title   || '';
                    document.getElementById('danceSummary').value = story.summary || '';
                    showDanceSaved(story);
                } else {
                    document.getElementById('danceSavedDisplay').style.display = 'none';
                    document.getElementById('danceSubmitBtn').style.display = 'inline-block';
                    document.getElementById('danceTitle').disabled   = false;
                    document.getElementById('danceSummary').disabled = false;
                }
            } catch(err) {
                if (listEl) listEl.innerHTML = '<span style="color:#c62828">Error loading: ' + err.message + '</span>';
            }
        }

        function showDanceSaved(story) {
            document.getElementById('danceSavedDisplay').style.display = 'block';
            document.getElementById('danceSavedTitle').textContent   = story.title   || '';
            document.getElementById('danceSavedSummary').textContent = story.summary || '';
            const at = story.savedAt ? new Date(story.savedAt).toLocaleString('en-IN', {day:'2-digit',month:'short',hour:'2-digit',minute:'2-digit'}) : '';
            document.getElementById('danceSavedAt').textContent = at ? 'ðŸ’¾ Saved on ' + at + (story.savedBy ? ' by ' + story.savedBy : '') : '';
            // Lock inputs until Edit is clicked
            document.getElementById('danceTitle').disabled   = true;
            document.getElementById('danceSummary').disabled = true;
            document.getElementById('danceSubmitBtn').style.display = 'none';
        }

        function enableDanceEdit() {
            document.getElementById('danceSavedDisplay').style.display = 'none';
            document.getElementById('danceTitle').disabled   = false;
            document.getElementById('danceSummary').disabled = false;
            document.getElementById('danceSubmitBtn').style.display = 'inline-block';
            document.getElementById('danceTitle').focus();
        }

        async function saveDanceStory() {
            const cls = crClass;
            if (!cls) { alert('Class not detected. Please re-login.'); return; }
            const title   = (document.getElementById('danceTitle').value   || '').trim();
            const summary = (document.getElementById('danceSummary').value || '').trim();
            const msgEl   = document.getElementById('danceSubmitMsg');
            if (!title)   { showDanceMsg('âŒ Please enter a dance performance title.', false); return; }
            if (!summary) { showDanceMsg('âŒ Please enter a story summary.', false); return; }

            const btn = document.getElementById('danceSubmitBtn');
            btn.disabled = true;
            btn.textContent = 'â³ Savingâ€¦';
            try {
                const clsKey = cls.replace(/[.\[\]#$\/\s]/g, '_');
                const story = {
                    title      : title,
                    summary    : summary,
                    classYear  : cls,
                    savedAt    : new Date().toISOString(),
                    savedBy    : cls
                };
                await db.ref('groupDance/' + clsKey).set(story);
                showDanceMsg('âœ… Dance story saved! Visible to jury and in-charge.', true);
                showDanceSaved(story);
            } catch(err) {
                showDanceMsg('âŒ Error: ' + err.message, false);
            } finally {
                btn.disabled = false;
                btn.textContent = 'ðŸ’¾ Save Dance Story';
            }
        }

        function showDanceMsg(msg, ok) {
            const el = document.getElementById('danceSubmitMsg');
            el.style.display    = 'block';
            el.style.background = ok ? '#d4edda' : '#f8d7da';
            el.style.color      = ok ? '#155724' : '#721c24';
            el.textContent      = msg;
            if (ok) setTimeout(() => { el.style.display = 'none'; }, 4000);
        }

        function clearDanceForm() {
            document.getElementById('danceTitle').value   = '';
            document.getElementById('danceSummary').value = '';
            document.getElementById('danceSubmitMsg').style.display = 'none';
            document.getElementById('danceTitle').disabled   = false;
            document.getElementById('danceSummary').disabled = false;
            document.getElementById('danceSubmitBtn').style.display = 'inline-block';
            document.getElementById('danceSavedDisplay').style.display = 'none';
        }

        // â”€â”€ Faculty in-charge panel for Group Dance â”€â”€
        async function loadDanceInchargePanel() {
            const listEl = document.getElementById('danceInchargeList');
            if (!listEl) return;
            listEl.innerHTML = '<div style="text-align:center;color:#aaa;padding:30px">Loadingâ€¦</div>';
            try {
                const [enrollSnap, storySnap] = await Promise.all([
                    db.ref('youthfest-enrollments').once('value'),
                    db.ref('groupDance').once('value')
                ]);
                // Gather all Group Dance enrollments grouped by class
                const byClass = {};
                if (enrollSnap.exists()) {
                    enrollSnap.forEach(ch => {
                        const d = ch.val();
                        if ((d.event || '').toLowerCase().replace(/\s/g,'') !== 'groupdance') return;
                        const cls = d.classYear || d.class || 'Unknown';
                        if (!byClass[cls]) byClass[cls] = [];
                        byClass[cls].push(d);
                    });
                }
                const stories = storySnap.val() || {};

                if (!Object.keys(byClass).length) {
                    listEl.innerHTML = '<div style="text-align:center;color:#aaa;padding:30px;font-size:0.9em">No Group Dance enrollments found yet.</div>';
                    return;
                }

                listEl.innerHTML = Object.entries(byClass).sort(([a],[b]) => a.localeCompare(b)).map(([cls, members]) => {
                    const clsKey = cls.replace(/[.\[\]#$\/\s]/g, '_');
                    const story  = stories[clsKey] || {};
                    const hasStory = !!story.title;
                    const savedAt = story.savedAt ? new Date(story.savedAt).toLocaleString('en-IN',{day:'2-digit',month:'short',hour:'2-digit',minute:'2-digit'}) : '';

                    const memberBadges = members.map(m => {
                        const role = m.role ? ' <span style="color:#9c27b0;font-size:0.72em;font-weight:600">(' + m.role + ')</span>' : '';
                        return '<span style="display:inline-flex;align-items:center;gap:3px;background:#fce4ec;border:1.5px solid #f48fb1;border-radius:16px;padding:3px 10px;margin:2px;font-size:0.82em;font-weight:600;color:#880e4f">ðŸ’ƒ ' + (m.name||'â€”') + role + '</span>';
                    }).join('');

                    return `<div style="background:white;border-radius:12px;border:2px solid ${hasStory ? '#f48fb1' : '#ffcdd2'};margin-bottom:10px;overflow:hidden">
                        <div style="background:linear-gradient(135deg,${hasStory ? '#ad1457,#e91e63' : '#e53935,#ef9a9a'});padding:10px 16px;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:6px">
                            <span style="color:white;font-weight:700;font-size:0.95em">ðŸ’ƒ ${cls}</span>
                            <span style="background:rgba(255,255,255,0.25);color:white;padding:2px 12px;border-radius:12px;font-size:0.8em;font-weight:700">${members.length} Performer${members.length !== 1 ? 's' : ''}</span>
                        </div>
                        <div style="padding:12px 14px">
                            <!-- Dance Performance Title & Story Summary â€” shown first and prominently -->
                            ${hasStory ? `
                            <div style="background:linear-gradient(135deg,#fce4ec,#f8bbd0);border:2px solid #e91e63;border-radius:10px;padding:14px 16px;margin-bottom:12px">
                                <div style="font-size:0.75em;font-weight:700;color:#ad1457;text-transform:uppercase;letter-spacing:0.8px;margin-bottom:6px">ðŸŽ­ Dance Performance Title</div>
                                <div style="font-weight:800;color:#880e4f;font-size:1.05em;margin-bottom:10px;line-height:1.4">${story.title}</div>
                                <div style="font-size:0.75em;font-weight:700;color:#ad1457;text-transform:uppercase;letter-spacing:0.8px;margin-bottom:6px">ðŸ“ Story Summary</div>
                                <div style="font-size:0.88em;color:#444;line-height:1.7;background:rgba(255,255,255,0.6);border-radius:6px;padding:8px 10px">${story.summary}</div>
                                ${savedAt ? '<div style="font-size:0.72em;color:#aaa;margin-top:8px;text-align:right">ðŸ’¾ Submitted: ' + savedAt + '</div>' : ''}
                            </div>` : `
                            <div style="background:#fff8e1;border:2px dashed #ffe082;border-radius:8px;padding:14px;text-align:center;font-size:0.85em;color:#856404;margin-bottom:12px">
                                <div style="font-size:1.1em;margin-bottom:4px">â³</div>
                                <strong>Dance Performance Title &amp; Story Summary not submitted yet</strong>
                            </div>`}
                            <!-- Performers -->
                            <div style="font-size:0.75em;font-weight:700;color:#888;text-transform:uppercase;letter-spacing:0.7px;margin-bottom:6px">ðŸ‘¥ Performers</div>
                            <div>${memberBadges}</div>
                        </div>
                    </div>`;
                }).join('');
            } catch(err) {
                listEl.innerHTML = '<div style="padding:20px;color:#c62828">âŒ Error: ' + err.message + '</div>';
            }
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // END GROUP DANCE
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        async function checkVlogEventActive() {
            const snap = await db.ref('vlogSettings/eventActive').once('value');
            const active = snap.val() === true;
            const form = document.getElementById('vlogSubmitFormWrapper');
            const lockMsg = document.getElementById('vlogLockedMsg');
            if (!active) {
                if (form) form.style.display = 'none';
                if (lockMsg) lockMsg.style.display = 'block';
            } else {
                if (form) form.style.display = 'block';
                if (lockMsg) lockMsg.style.display = 'none';
                autoFillVlogMembers();
                initVlogDailyScreenshots(); // build daily screenshot slots
            }
            // Check monitoring visibility
            const mSnap = await db.ref('vlogSettings/monitoringVisible').once('value');
            const monVis = mSnap.val() === true;
            const monSection = document.getElementById('vlogMonitoringSection');
            if (monSection) monSection.style.display = monVis ? 'block' : 'none';
            // Load hashtag
            loadVlogSettings();
        }

        function updateCREventFilter() {
            const sel = document.getElementById('crFilterEvent');
            sel.innerHTML = '<option value="">All Events</option>';
            const enrolled = [...new Set(all.filter(e => e.classYear === crClass).map(e => e.event))];
            enrolled.forEach(ev => {
                const opt = document.createElement('option');
                opt.value = ev;
                opt.textContent = ev;
                sel.appendChild(opt);
            });
        }

        function updateCRView() {
            console.log('=== updateCRView called ===');
            console.log('crClass:', crClass);
            console.log('all.length:', all.length);
            
            const filterEv = document.getElementById('crFilterEvent').value;
            let filtered = all.filter(e => e.classYear === crClass);
            
            console.log('Filtered by class:', filtered.length);
            
            if (filterEv) {
                filtered = filtered.filter(e => e.event === filterEv);
                console.log('Filtered by event:', filtered.length);
            }
            
            // Summary
            let summary = '<h3 style="color:#2196F3;margin-bottom:10px">Your Class: <strong>'+crClass+'</strong></h3>';
            summary += '<p><strong>Total Students Enrolled:</strong> '+filtered.length+'</p>';
            if (filterEv) summary += '<p><strong>Event:</strong> '+filterEv+'</p>';
            document.getElementById('crSummary').innerHTML = summary;
            
            // Table
            const cont = document.getElementById('crEnrollmentsContainer');
            if (filtered.length === 0) {
                console.log('No enrollments found - showing empty message');
                cont.innerHTML = '<p style="text-align:center;padding:40px;color:#999">No enrollments yet</p>';
            } else {
                console.log('Building table with', filtered.length, 'rows');
                let html = '<div class="table-wrapper"><table><thead><tr><th>Sl</th><th>Name</th><th>Phone</th><th>Event</th><th>Role</th><th>Details</th><th>Actions</th></tr></thead><tbody>';
                filtered.forEach((e,i) => {
                    html += '<tr><td>'+(i+1)+'</td><td>'+e.name+'</td><td>'+e.phone+'</td><td>'+e.event+'</td><td>'+e.role+'</td><td>'+getDet(e)+'</td>';
                    html += '<td><button class="edit-btn" data-key="'+e.id+'" onclick="editEnrollmentByKey(this.getAttribute(\'data-key\'))">Edit</button>';
                    html += '<button class="delete-btn" data-key="'+e.id+'" data-name="'+e.name+'" data-event="'+e.event+'" onclick="deleteEnrollmentByKey(this.getAttribute(\'data-key\'), this.getAttribute(\'data-name\'), this.getAttribute(\'data-event\'))">Delete</button></td></tr>';
                });
                html += '</tbody></table></div>';
                cont.innerHTML = html;
            }
            
            // Update CR event cards to show current enrollment counts
            renderCREventCards();
        }

        function clearCRFilters() {
            document.getElementById('crFilterEvent').value = '';
            updateCRView();
        }

        function generateCRSummaryReport() {
            const cls = crClass || (window.currentCRClass || '');
            if (!cls) { alert('Class not detected. Please log in again.'); return; }
            if (!all || !all.length) { alert('No data loaded yet. Please wait a moment and try again.'); return; }

            const now = new Date();
            const dateStr = now.toLocaleDateString('en-IN',{day:'2-digit',month:'short',year:'numeric'}) + ' ' + now.toLocaleTimeString('en-IN',{hour:'2-digit',minute:'2-digit'});
            const LINK = 'https://harshgujjar.github.io/Spurthi-youth-fest-2026/';
            const classData = all.filter(e => e.classYear === cls);

            const lines = [];
            lines.push('ðŸ“Š *' + cls + ' â€” Event Enrollment Summary*');
            lines.push('ðŸ•’ As of: ' + dateStr);
            lines.push('-------------------------');
            lines.push('ðŸ“ Total Enrollments: *' + classData.length + '*');
            lines.push('-------------------------');

            const evtMap = {};
            classData.forEach(e => {
                if (!evtMap[e.event]) evtMap[e.event] = [];
                evtMap[e.event].push(e);
            });

            const evtList = Object.keys(evtMap).sort();
            if (!evtList.length) {
                lines.push('No enrollments found for this class.');
            } else {
                lines.push('*ðŸŽª Events Enrolled:*');
                evtList.forEach(ev => {
                    const students = evtMap[ev];
                    const captains = students.filter(s => (s.role||'').toLowerCase() === 'captain');
                    const members  = students.filter(s => (s.role||'').toLowerCase() === 'member');
                    const others   = students.filter(s => !s.role || (!['captain','member'].includes((s.role||'').toLowerCase())));
                    lines.push('');
                    lines.push('â–¶ï¸ *' + ev + '* (' + students.length + ' enrolled)');
                    if (captains.length) lines.push('  ðŸ‘‘ Captain(s): ' + captains.map(s=>s.name).join(', '));
                    if (members.length)  lines.push('  ðŸ‘¤ Member(s): '  + members.map(s=>s.name).join(', '));
                    if (others.length)   lines.push('  â€¢ ' + others.map(s=>s.name+(s.role?' ('+s.role+')':'')).join(', '));
                });
            }

            lines.push('');
            lines.push('-------------------------');

            // Check vlog, podcast, yt ad submission status
            Promise.all([
                db.ref('vlogChallenge').orderByChild('classYear').equalTo(cls).once('value').catch(()=>null),
                db.ref('podcastChallenge').orderByChild('classYear').equalTo(cls).once('value').catch(()=>null),
                db.ref('youtubeAd').once('value').catch(()=>null)
            ]).then(([vSnap, pSnap, ytSnap]) => {
                const vlogEntries = [];
                if (vSnap && vSnap.exists()) vSnap.forEach(ch => vlogEntries.push(ch.val()));
                const podEntries = [];
                if (pSnap && pSnap.exists()) pSnap.forEach(ch => podEntries.push(ch.val()));
                let ytEntry = null;
                if (ytSnap && ytSnap.exists()) ytSnap.forEach(ch => { if(ch.val().classYear===cls) ytEntry=ch.val(); });

                if (vlogEntries.length) {
                    lines.push('ðŸ“¹ *Vlog:* ' + vlogEntries.length + ' team(s) submitted âœ…');
                    vlogEntries.forEach(v => lines.push('  â€¢ ' + (v.members||'') + (v.topic?' â€” '+v.topic:'') + ' (' + (v.status||'Pending') + ')'));
                } else {
                    lines.push('ðŸ“¹ *Vlog:* No submission yet âŒ');
                }
                if (podEntries.length) {
                    lines.push('ðŸŽ™ï¸ *Podcast:* ' + podEntries.length + ' submission(s) âœ…');
                    podEntries.forEach(p => lines.push('  â€¢ ' + (p.memberName||'') + (p.episodeTitle?' â€” '+p.episodeTitle:'') + ' (' + (p.approvalStatus||'pending') + ')'));
                } else {
                    lines.push('ðŸŽ™ï¸ *Podcast:* No submission yet âŒ');
                }
                if (ytEntry) {
                    lines.push('ðŸ“º *YouTube Ad:* Submitted âœ…' + (ytEntry.adTitle?' â€” '+ytEntry.adTitle:''));
                } else {
                    lines.push('ðŸ“º *YouTube Ad:* No submission yet âŒ');
                }

                lines.push('-------------------------');
                lines.push('Davan Institute â€” Spurthi Youth Fest 2026');
                lines.push('ðŸ”— ' + LINK);
                const ta = document.getElementById('crSummaryReportText');
                if (ta) { ta.value = lines.join('\n'); }
            }).catch(() => {
                lines.push('-------------------------');
                lines.push('Davan Institute â€” Spurthi Youth Fest 2026');
                lines.push('ðŸ”— ' + LINK);
                const ta = document.getElementById('crSummaryReportText');
                if (ta) ta.value = lines.join('\n');
            });
        }

        function copyCRSummaryReport() {
            const ta = document.getElementById('crSummaryReportText');
            if (!ta || !ta.value.trim()) { generateCRSummaryReport(); return; }
            ta.select(); ta.setSelectionRange(0, 99999);
            try {
                navigator.clipboard.writeText(ta.value).then(() => {
                    const el = document.getElementById('crSummaryReportCopied');
                    if (el) { el.style.display='block'; setTimeout(()=>el.style.display='none',4000); }
                }).catch(() => document.execCommand('copy'));
            } catch(e) { document.execCommand('copy'); }
            const el = document.getElementById('crSummaryReportCopied');
            if (el) { el.style.display='block'; setTimeout(()=>el.style.display='none',4000); }
        }

        function downloadCREnrollments() {
            console.log('=== DOWNLOAD CR ENROLLMENTS ===');
            console.log('CR Class:', crClass);
            console.log('Total records in all:', all.length);
            
            if (!crClass) {
                alert('Error: Class not set. Please log out and log in again.');
                return;
            }
            
            // Filter all enrollments for this CR's class
            const classEnrollments = all.filter(e => e.classYear === crClass);
            
            console.log('Filtered enrollments for', crClass, ':', classEnrollments.length);
            
            if (classEnrollments.length === 0) {
                alert('No enrollments to download for ' + crClass);
                return;
            }
            
            // Check if event filter is applied
            const filterEv = document.getElementById('crFilterEvent').value;
            let enrollmentsToDownload = classEnrollments;
            
            if (filterEv) {
                enrollmentsToDownload = classEnrollments.filter(e => e.event === filterEv);
                console.log('Filtered by event', filterEv, ':', enrollmentsToDownload.length);
            }
            
            // Create CSV content
            let csv = 'Sl,Name,Phone,Class,Event,Role,Details\n';
            enrollmentsToDownload.forEach((e, i) => {
                const details = getDet(e).replace(/<br>/g, ' | ').replace(/"/g, '""');
                csv += `${i+1},"${e.name}","${e.phone}","${e.classYear}","${e.event}","${e.role}","${details}"\n`;
            });
            
            // Generate filename
            const filename = filterEv 
                ? `${crClass}_${filterEv}_enrollments.csv`.replace(/\s+/g, '_')
                : `${crClass}_all_enrollments.csv`.replace(/\s+/g, '_');
            
            console.log('Downloading', enrollmentsToDownload.length, 'records as', filename);
            
            // Download
            download(csv, filename);
            
            showCROk(`Downloaded ${enrollmentsToDownload.length} enrollment(s) successfully!`);
        }

        function showCROk(msg) {
            const d = document.getElementById('crMessage');
            d.className = 'message success show';
            d.textContent = 'âœ“ '+msg;
            setTimeout(() => d.classList.remove('show'), 5000);
        }

        function showCRErr(msg) {
            const d = document.getElementById('crMessage');
            d.className = 'message error show';
            d.textContent = 'âœ— '+msg;
            setTimeout(() => d.classList.remove('show'), 5000);
        }

        // Admin Functions
        function showTab(tab) {
            // â”€â”€ Teardown panels that should NOT persist data when not active â”€â”€
            // Detach Live Now Firebase listener so it doesn't keep rendering
            if (typeof _liveUsersListener !== 'undefined' && _liveUsersListener) {
                const _db = window.db || firebase.database();
                _db.ref('liveUsers').off('value', _liveUsersListener);
                _liveUsersListener = null;
                const tbody = document.getElementById('liveUsersTableBody');
                if (tbody) tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;padding:30px;color:#999;font-size:14px">â³ Click Live Now to refresh</td></tr>';
            }
            // Clear push notification panel content when switching away
            const prevPush = document.getElementById('pushNotifPanel');
            if (prevPush && prevPush.classList.contains('active') && tab !== 'pushNotifPanel') {
                const logsContainer = document.getElementById('pushLogsContainer');
                if (logsContainer) logsContainer.innerHTML = '<p style="color:#aaa;font-size:13px;text-align:center;padding:20px">Click Notifications tab to load history</p>';
                const devicesPanel = document.getElementById('devicesPanel');
                if (devicesPanel) { devicesPanel.innerHTML = ''; devicesPanel.style.display = 'none'; }
                const devicesArrow = document.getElementById('devicesToggleArrow');
                if (devicesArrow) devicesArrow.style.transform = 'rotate(0deg)';
                _allDevicesData = [];
            }
            // Clear only top-level admin nav tabs (NOT scavenger inner tabs)
            document.querySelectorAll('#adminSection > div.tabs > .tab').forEach(t => t.classList.remove('active'));
            // Clear only direct-child form-sections of adminContentBox (NOT scavenger inner panels)
            document.querySelectorAll('#adminContentBox > .form-section').forEach(s => s.classList.remove('active'));
            // Also hide the 3 extra panels that live outside adminContentBox
            ['pdfHandoutsAdmin','paymentApprovalAdmin','eventScheduleAdmin','liveUsersPanel','pushNotifPanel'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.classList.remove('active');
            });
            event.target.classList.add('active');
            document.getElementById(tab).classList.add('active');

            // Toggle white box for leaderboard
            const adminBox = document.getElementById('adminContentBox');
            if (adminBox) {
                adminBox.classList.toggle('lb-active', tab === 'leaderboardAdmin');
            }

            if (tab === 'results')        loadResultsTab();
            if (tab === 'quizManagement') { loadQuizManagementStats(); showQuizManagementTab('questions'); initializeDateSelector(); }
            if (tab === 'leaderboardAdmin') {
                if (typeof loadLbConfigIntoForm   === 'function') loadLbConfigIntoForm();
                if (typeof loadLbCriteriaList     === 'function') loadLbCriteriaList();
                if (typeof loadLbPublishedResults === 'function') loadLbPublishedResults();
                if (typeof loadLbAdminPreview     === 'function') loadLbAdminPreview();
            }
            if (tab === 'scavengerAdmin') {
                // Show Tasks panel, hide others using inline style (immune to class conflicts)
                ['shAdminTasks','shAdminSubmissions','shAdminLeaderboard','shAdminClasswise','shAdminWinners','shAdminSettings'].forEach(id => {
                    const el = document.getElementById(id);
                    if (el) el.style.display = (id === 'shAdminTasks') ? 'block' : 'none';
                });
                // Reset scavenger sub-tab button active states
                document.querySelectorAll('#scavengerAdmin .tabs .tab').forEach(t => t.classList.remove('active'));
                const firstBtn = document.querySelector('#scavengerAdmin .tabs .tab');
                if (firstBtn) firstBtn.classList.add('active');
                if (typeof shAdminLoadTasks    === 'function') shAdminLoadTasks();
                if (typeof shAdminLoadSettings === 'function') shAdminLoadSettings();
            }
            if (tab === 'speedSlideAdmin') {
                ssaShowTab('sub');
            }
            if (tab === 'dbInspector') {
                // DB Inspector tab â€” ready to scan, nothing auto-loads
            }
            if (tab === 'cloudinaryInspector') {
                // Cloudinary Inspector â€” ready to use, nothing auto-loads
            }
            if (tab === 'firebaseDownloadMonitor') {
                // Firebase Download Monitor â€” render history on open
                if (typeof fdmRenderHistory === 'function') fdmRenderHistory();
            }
            // Sync Manager Permissions panel checkboxes with current state when opened
            if (tab === 'managerPermissionsPanel') {
                document.getElementById('mperm_quizManagement').checked    = managerPermissions.quizManagement;
                document.getElementById('mperm_scavengerAdmin').checked    = managerPermissions.scavengerAdmin;
                document.getElementById('mperm_viewRegistrations').checked = managerPermissions.viewRegistrations;
                document.getElementById('mperm_viewResults').checked       = managerPermissions.viewResults;
                document.getElementById('mperm_whatsappMessages').checked  = managerPermissions.whatsappMessages;
                document.getElementById('mperm_pdfHandouts').checked      = managerPermissions.pdfHandouts;
                document.getElementById('mperm_paymentApproval').checked  = managerPermissions.paymentApproval;
                document.getElementById('mperm_eventSchedule').checked    = managerPermissions.eventSchedule;
            }
        }

        function updateStats() {
            const uniqueStudents = new Set(all.map(e => e.phone)).size;
            const uniqueClasses = new Set(all.map(e => e.classYear)).size;
            const activeEvents = new Set(all.map(e => e.event)).size;
            
            document.getElementById('totalStudents').textContent = uniqueStudents;
            document.getElementById('totalEvents').textContent = activeEvents;
            document.getElementById('totalClasses').textContent = uniqueClasses;
            document.getElementById('totalEnrollments').textContent = all.length;
        }

        function generateEnrollSummary() {
            if (!all || !all.length) { alert('No enrollment data loaded yet.'); return; }
            const now = new Date();
            const dateStr = now.toLocaleDateString('en-IN',{day:'2-digit',month:'short',year:'numeric'}) + ' ' + now.toLocaleTimeString('en-IN',{hour:'2-digit',minute:'2-digit'});
            const uniqueStudents = new Set(all.map(e => e.phone)).size;
            const activeEvents = new Set(all.map(e => e.event)).size;
            const EXCLUDE = ['Faculty/Principal/Vice-Principal/Staff','Others'];
            const realClasses = classes.filter(c => !EXCLUDE.includes(c));
            const LINK = 'https://harshgujjar.github.io/Spurthi-youth-fest-2026/';

            let lines = [];
            lines.push('ðŸ“Š *Spurthi Youth Fest 2026 â€” Enrollment Summary*');
            lines.push('ðŸ•’ As of: ' + dateStr);
            lines.push('-------------------------');
            lines.push('ðŸ‘¥ Total Students: *' + uniqueStudents + '*');
            lines.push('ðŸ“ Total Enrollments: *' + all.length + '*');
            lines.push('ðŸŽ¯ Active Events: *' + activeEvents + '*');
            lines.push('-------------------------');
            lines.push('*ðŸ“‹ Class-wise Totals:*');
            realClasses.forEach(cls => {
                const count = all.filter(e => e.classYear === cls).length;
                if (count > 0) lines.push('  â€¢ ' + cls + ': ' + count);
            });
            lines.push('-------------------------');
            lines.push('*ðŸŽª Event-wise Totals:*');
            const evtNames = [...new Set(all.map(e => e.event))].sort();
            evtNames.forEach(ev => {
                const count = all.filter(e => e.event === ev).length;
                lines.push('  â€¢ ' + ev + ': ' + count);
            });
            lines.push('-------------------------');
            lines.push('Davan Institute â€” Spurthi Youth Fest 2026');
            lines.push('ðŸ”— ' + LINK);

            const ta = document.getElementById('enrollSummaryText');
            if (ta) ta.value = lines.join('\n');
            const copied = document.getElementById('enrollSummaryCopied');
            if (copied) copied.style.display = 'none';
        }

        function copyEnrollSummary() {
            const ta = document.getElementById('enrollSummaryText');
            if (!ta || !ta.value.trim()) { generateEnrollSummary(); return; }
            ta.select();
            ta.setSelectionRange(0, 99999);
            try {
                navigator.clipboard.writeText(ta.value).then(() => {
                    const el = document.getElementById('enrollSummaryCopied');
                    if (el) { el.style.display = 'block'; setTimeout(() => el.style.display = 'none', 4000); }
                }).catch(() => document.execCommand('copy'));
            } catch(e) { document.execCommand('copy'); }
            const el = document.getElementById('enrollSummaryCopied');
            if (el) { el.style.display = 'block'; setTimeout(() => el.style.display = 'none', 4000); }
        }

        function generateMasterFilterSummary() {
            const filterCl = (document.getElementById('filterClass') || {}).value || '';
            const filterEv = (document.getElementById('filterEvent') || {}).value || '';
            const box      = document.getElementById('masterFilterSummaryBox');
            const labelEl  = document.getElementById('masterFilterSummaryLabel');
            const ta       = document.getElementById('masterFilterSummaryText');
            const copiedEl = document.getElementById('masterFilterSummaryCopied');
            if (!box || !ta) return;
            if (!filterCl && !filterEv) { box.style.display = 'none'; return; }
            box.style.display = 'block';
            if (copiedEl) copiedEl.style.display = 'none';

            const LINK = 'https://harshgujjar.github.io/Spurthi-youth-fest-2026/';
            const EXCLUDE = ['Faculty/Principal/Vice-Principal/Staff','Others'];
            const realClasses = classes.filter(c => !EXCLUDE.includes(c));
            const now = new Date();
            const dateStr = now.toLocaleDateString('en-IN',{day:'2-digit',month:'short',year:'numeric'}) + ' ' + now.toLocaleTimeString('en-IN',{hour:'2-digit',minute:'2-digit'});

            let data = [...all];
            if (filterCl) data = data.filter(e => e.classYear === filterCl);
            if (filterEv) data = data.filter(e => e.event === filterEv);

            let filterDesc = '';
            if (filterCl && filterEv) filterDesc = filterCl + ' â€º ' + filterEv;
            else if (filterCl) filterDesc = 'Class: ' + filterCl;
            else filterDesc = 'Event: ' + filterEv;
            if (labelEl) labelEl.textContent = filterDesc;

            const lines = [];
            lines.push('ðŸ“Š *Spurthi Youth Fest 2026 â€” Filtered Summary*');
            lines.push('ðŸ” ' + filterDesc);
            lines.push('ðŸ•’ As of: ' + dateStr);
            lines.push('-------------------------');
            lines.push('ðŸ“ Total Enrollments: *' + data.length + '*');

            if (filterEv && !filterCl) {
                // Show class breakdown + not enrolled
                lines.push('-------------------------');
                lines.push('*ðŸ“‹ Class-wise for ' + filterEv + ':*');
                const enrolled = [], notEnrolled = [];
                realClasses.forEach(cls => {
                    const count = data.filter(e => e.classYear === cls).length;
                    if (count > 0) { lines.push('  âœ… ' + cls + ': ' + count); enrolled.push(cls); }
                    else notEnrolled.push(cls);
                });
                if (notEnrolled.length) {
                    lines.push('-------------------------');
                    lines.push('âŒ Not yet enrolled (' + notEnrolled.length + '):');
                    notEnrolled.forEach(c => lines.push('  â€¢ ' + c));
                }
            } else if (filterCl && !filterEv) {
                // Show event breakdown for this class
                lines.push('-------------------------');
                lines.push('*ðŸŽª Events enrolled â€” ' + filterCl + ':*');
                const evts = [...new Set(data.map(e => e.event))].sort();
                evts.forEach(ev => {
                    const count = data.filter(e => e.event === ev).length;
                    lines.push('  â€¢ ' + ev + ': ' + count);
                });
            } else {
                // Both class + event selected â€” list students
                lines.push('-------------------------');
                lines.push('*ðŸ‘¤ Students:*');
                data.forEach((e, i) => lines.push('  ' + (i+1) + '. ' + e.name + (e.role ? ' (' + e.role + ')' : '')));
            }

            lines.push('-------------------------');
            lines.push('Davan Institute â€” Spurthi Youth Fest 2026');
            lines.push('ðŸ”— ' + LINK);
            ta.value = lines.join('\n');
        }

        function copyMasterFilterSummary() {
            const ta = document.getElementById('masterFilterSummaryText');
            if (!ta || !ta.value.trim()) return;
            ta.select(); ta.setSelectionRange(0, 99999);
            try {
                navigator.clipboard.writeText(ta.value).then(() => {
                    const el = document.getElementById('masterFilterSummaryCopied');
                    if (el) { el.style.display = 'block'; setTimeout(() => el.style.display = 'none', 3000); }
                }).catch(() => document.execCommand('copy'));
            } catch(e) { document.execCommand('copy'); }
            const el = document.getElementById('masterFilterSummaryCopied');
            if (el) { el.style.display = 'block'; setTimeout(() => el.style.display = 'none', 3000); }
        }

        function updateMaster() {
            // Use setTimeout to ensure dropdown has updated
            setTimeout(() => {
                const filterCl = document.getElementById('filterClass') ? document.getElementById('filterClass').value : '';
                const filterEv = document.getElementById('filterEvent') ? document.getElementById('filterEvent').value : '';
                
                let filtered = [...all]; // Create a copy
                
                if (filterCl) {
                    filtered = filtered.filter(e => e.classYear === filterCl);
                }
                
                if (filterEv) {
                    filtered = filtered.filter(e => e.event === filterEv);
                }
                
                updateSummary(filterCl, filterEv);
                generateMasterFilterSummary();
                
                const cont = document.getElementById('masterContainer');
                if (!cont) {
                    return;
                }
                
                if (filtered.length === 0) {
                    cont.innerHTML = '<p style="text-align:center;padding:40px;color:#999">No data available</p>';
                    return;
                }
                
                let html = '<div class="table-wrapper"><table><thead><tr><th>Sl</th><th>Name</th><th>Phone</th><th>Class</th><th>Event</th><th>Role</th><th>Details</th><th>Actions</th></tr></thead><tbody>';
                filtered.forEach((e,i) => {
                    html += '<tr><td>'+(i+1)+'</td><td>'+e.name+'</td><td>'+e.phone+'</td><td>'+e.classYear+'</td><td>'+e.event+'</td><td>'+e.role+'</td><td>'+getDet(e)+'</td>';
                    html += '<td><button class="edit-btn" data-key="'+e.id+'" onclick="editEnrollmentByKey(this.getAttribute(\'data-key\'))">Edit</button>';
                    html += '<button class="delete-btn" data-key="'+e.id+'" data-name="'+e.name+'" data-event="'+e.event+'" onclick="deleteEnrollmentByKey(this.getAttribute(\'data-key\'), this.getAttribute(\'data-name\'), this.getAttribute(\'data-event\'))">Delete</button></td></tr>';
                });
                html += '</tbody></table></div>';
                cont.innerHTML = html;
            }, 10); // Small delay to ensure dropdown has updated
        }

        function updateSummary(selectedClass, selectedEvent) {
            const summaryContent = document.getElementById('summaryInfo');
            let html = '<h3 style="color:#2196F3;margin-bottom:15px">ðŸ“Š Summary</h3>';
            html += '<p><strong>Total Enrollments:</strong> '+all.length+'</p>';
            
            // When Event is selected (no class) - show class enrollment status
            if (!selectedClass && selectedEvent) {
                const enrolledClasses = [];
                const notEnrolledClasses = [];
                const EXCLUDE_FROM_CHECK = ['Faculty/Principal/Vice-Principal/Staff','Others'];
                
                classes.filter(c => !EXCLUDE_FROM_CHECK.includes(c)).forEach(cls => {
                    const hasEnrollment = all.some(e => e.classYear === cls && e.event === selectedEvent);
                    if (hasEnrollment) {
                        const count = all.filter(e => e.classYear === cls && e.event === selectedEvent).length;
                        enrolledClasses.push({name: cls, count: count});
                    } else {
                        notEnrolledClasses.push(cls);
                    }
                });
                
                html += '<div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;">';
                
                // Classes with Enrollments
                html += '<div style="background:#d4edda;padding:15px;border-radius:6px;border:2px solid #28a745;">';
                html += '<h4 style="color:#155724;margin-bottom:10px;">âœ… Classes with Enrollments (' + enrolledClasses.length + ')</h4>';
                if (enrolledClasses.length > 0) {
                    html += '<div style="display:flex;flex-wrap:wrap;gap:8px;">';
                    enrolledClasses.forEach(cls => {
                        html += '<span style="background:#28a745;color:white;padding:6px 12px;border-radius:20px;font-size:14px;font-weight:600;">' + cls.name + ' (' + cls.count + ')</span>';
                    });
                    html += '</div>';
                } else {
                    html += '<p style="color:#666;font-style:italic;margin:0;">No classes enrolled yet</p>';
                }
                html += '</div>';
                
                // Classes NOT Enrolled
                html += '<div style="background:#f8d7da;padding:15px;border-radius:6px;border:2px solid #dc3545;">';
                html += '<h4 style="color:#721c24;margin-bottom:10px;">âŒ Classes NOT Enrolled (' + notEnrolledClasses.length + ')</h4>';
                if (notEnrolledClasses.length > 0) {
                    html += '<div style="display:flex;flex-wrap:wrap;gap:8px;">';
                    notEnrolledClasses.forEach(cls => {
                        html += '<span style="background:#dc3545;color:white;padding:6px 12px;border-radius:20px;font-size:14px;font-weight:600;">' + cls + '</span>';
                    });
                    html += '</div>';
                } else {
                    html += '<p style="color:#666;font-style:italic;margin:0;">All classes have enrolled!</p>';
                }
                html += '</div>';
                html += '</div>';
            }
            
            // When Class is selected - show event enrollment status
            if (selectedClass && !selectedEvent) {
                const enrolledEvents = [];
                const pendingEvents = [];
                
                Object.keys(events).forEach(evt => {
                    const hasEnrollment = all.some(e => e.classYear === selectedClass && e.event === evt);
                    if (hasEnrollment) {
                        const count = all.filter(e => e.classYear === selectedClass && e.event === evt).length;
                        enrolledEvents.push({name: evt, count: count});
                    } else {
                        pendingEvents.push(evt);
                    }
                });
                
                html += '<h3 style="color:#2196F3;margin-bottom:15px;">ðŸ“Š Summary for Class: <strong>' + selectedClass + '</strong></h3>';
                html += '<div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;">';
                
                // Enrolled Events
                html += '<div style="background:white;padding:15px;border-radius:6px;">';
                html += '<h4 style="color:#4CAF50;margin-bottom:10px;">âœ… Enrolled Events (' + enrolledEvents.length + ')</h4>';
                if (enrolledEvents.length > 0) {
                    html += '<ul style="list-style:none;padding:0;margin:0;">';
                    enrolledEvents.forEach(evt => {
                        html += '<li style="padding:5px 0;border-bottom:1px solid #eee;">â€¢ ' + evt.name + ' <span style="color:#666;">(' + evt.count + ' students)</span></li>';
                    });
                    html += '</ul>';
                } else {
                    html += '<p style="color:#999;font-style:italic;">No events enrolled yet</p>';
                }
                html += '</div>';
                
                // Pending Events
                html += '<div style="background:white;padding:15px;border-radius:6px;">';
                html += '<h4 style="color:#FF9800;margin-bottom:10px;">â³ Pending Events (' + pendingEvents.length + ')</h4>';
                if (pendingEvents.length > 0) {
                    html += '<ul style="list-style:none;padding:0;margin:0;">';
                    pendingEvents.forEach(evt => {
                        html += '<li style="padding:5px 0;border-bottom:1px solid #eee;">â€¢ ' + evt + '</li>';
                    });
                    html += '</ul>';
                } else {
                    html += '<p style="color:#999;font-style:italic;">All events completed!</p>';
                }
                html += '</div>';
                html += '</div>';
            }
            
            // When both Class and Event are selected
            if (selectedClass && selectedEvent) {
                const count = all.filter(e => e.classYear === selectedClass && e.event === selectedEvent).length;
                html += '<h3 style="color:#2196F3;margin-bottom:10px;">ðŸ“Š Filtered View</h3>';
                html += '<p style="margin:0;"><strong>Class:</strong> ' + selectedClass + ' | <strong>Event:</strong> ' + selectedEvent + ' | <strong>Total Students:</strong> ' + count + '</p>';
            }
            
            summaryContent.innerHTML = html;
        }

        function updateEvents() {
            const cont = document.getElementById('eventsContainer');
            if (all.length===0) { cont.innerHTML = '<p style="text-align:center;padding:40px">No data</p>'; return; }
            let h = '';
            Object.keys(events).forEach(ev => {
                const evEnr = all.filter(e => e.event===ev);
                if (evEnr.length===0) return;
                h += '<div style="background:#f9f9f9;padding:20px;border-radius:8px;margin-bottom:20px"><h3 style="color:#c44569;margin-bottom:15px">'+ev+' ('+evEnr.length+')</h3>';
                classes.forEach(cl => {
                    const clEnr = evEnr.filter(e => e.classYear===cl);
                    if (clEnr.length===0) return;
                    h += '<div style="background:white;padding:15px;border-radius:6px;margin-bottom:15px"><h4 style="color:#6a1b9a;margin-bottom:10px">'+cl+' ('+clEnr.length+')</h4><div class="table-wrapper"><table><thead><tr><th>Sl</th><th>Name</th><th>Phone</th><th>Role</th><th>Details</th></tr></thead><tbody>';
                    clEnr.forEach((e,i) => h += '<tr><td>'+(i+1)+'</td><td>'+e.name+'</td><td>'+e.phone+'</td><td>'+e.role+'</td><td>'+getDet(e)+'</td></tr>');
                    h += '</tbody></table></div></div>';
                });
                h += '</div>';
            });
            cont.innerHTML = h;
        }

        function clearFilters() {
            document.getElementById('filterClass').value = '';
            document.getElementById('filterEvent').value = '';
            updateMaster();
        }

        function getDet(e) {
            const d = [];
            if (e.topic) d.push('Topic: '+e.topic);
            if (e.product) d.push('Product: '+e.product);
            if (e.cause) d.push('Cause: '+e.cause);
            if (e.languages) d.push('Languages: '+e.languages);
            if (e.showstopper) d.push('Showstopper: '+e.showstopper);
            if (e.talentType) d.push('Talent: '+e.talentType);
            if (e.cameraName) d.push('ðŸ“¹ Camera: '+e.cameraName+(e.cameraPhone ? ' ('+e.cameraPhone+')' : ''));
            return d.length>0 ? d.join('<br>') : '-';
        }

        function downloadMaster() {
            if (all.length===0) { alert('No data'); return; }
            let csv = 'Sl,Name,Phone,Class,Event,Role,Details\n';
            all.forEach((e,i) => csv += (i+1)+',"'+e.name+'","'+e.phone+'","'+e.classYear+'","'+e.event+'","'+e.role+'","'+getDet(e).replace(/<br>/g,' | ')+'"\n');
            download(csv,'youthfest_master.csv');
        }

        function downloadEvents() {
            if (all.length===0) { alert('No data'); return; }
            let csv = '';
            Object.keys(events).forEach(ev => {
                const evEnr = all.filter(e => e.event===ev);
                if (evEnr.length===0) return;
                csv += '\n'+ev+'\n';
                csv += 'Sl,Name,Phone,Class,Role,Details\n';
                let sl = 1;
                evEnr.forEach(e => { csv += sl+',"'+e.name+'","'+e.phone+'","'+e.classYear+'","'+e.role+'","'+getDet(e).replace(/<br>/g,' | ')+'"\n'; sl++; });
            });
            download(csv,'youthfest_events.csv');
        }

        function download(content,filename) {
            const blob = new Blob([content],{type:'text/csv'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            URL.revokeObjectURL(url);
        }

        // Jury Setup Functions (Super Admin Only)
        function loadEventSetup() {
            const event = document.getElementById('setupEventSelect').value;
            if (!event) {
                document.getElementById('eventSetupContainer').style.display = 'none';
                document.getElementById('eventEligibilityBanner').style.display = 'none';
                // Hide vlog calc panel
                const vcp = document.getElementById('vlogScoreCalcPanel');
                if (vcp) vcp.style.display = 'none';
                return;
            }
            
            document.getElementById('eventSetupContainer').style.display = 'block';

            // Show event info banner
            const cfg = events[event] || {};
            const banner = document.getElementById('eventEligibilityBanner');
            const bannerText = document.getElementById('eventEligibilityText');
            bannerText.textContent = cfg.individual ? 'Individual event â€” multiple students per class can compete independently' : 'Team/Class event';
            banner.style.display = 'block';

            // Update Class Code Names section header to show current event
            const aliasLabel = document.getElementById('classAliasEventLabel');
            if (aliasLabel) {
                const cfg2 = events[event] || {};
                const typeLabel = cfg2.individual ? 'ðŸ§‘ Individual event' : cfg2.multiTeam ? 'ðŸ‘¥ Multi-team event' : 'ðŸ« Class-based event';
                aliasLabel.innerHTML = 'Working on: <strong style="color:#6a1b9a">' + event + '</strong> &nbsp;Â·&nbsp; <span style="color:#888">' + typeLabel + '</span>';
            }
            // Auto-load participant/class list for this event
            loadClassAliasFields();

            // Auto-detect event type from events config
            const autoIndividual = cfg.individual === true;
            const autoMultiteam  = cfg.multiTeam  === true && !cfg.individual;
            
            // Load existing setup
            db.ref('jurySetup/'+event).once('value').then(snap => {
                const data = snap.val() || {};
                
                // Load jury names
                document.getElementById('jury1Name').value = data.jury1Name || '';
                document.getElementById('jury2Name').value = data.jury2Name || '';
                
                // Load jury passwords
                document.getElementById('jury1Password').value = data.jury1Password || '';
                document.getElementById('jury2Password').value = data.jury2Password || '';

                // Load event type â€” config always wins for individual/multiteam; only use saved for class-based
                const savedType = autoIndividual ? 'individual' : autoMultiteam ? 'multiteam' : (data.eventType || 'class');
                document.getElementById('eventTypeClass').checked      = savedType === 'class';
                document.getElementById('eventTypeIndividual').checked = savedType === 'individual';
                document.getElementById('eventTypeMultiteam').checked  = savedType === 'multiteam';
                
                // Load criteria
                const criteria = data.criteria || [];
                renderCriteriaInputs(criteria);

                // -- VLOG SPECIAL: show score calculation panel --
                const vcp = document.getElementById('vlogScoreCalcPanel');
                if (event === 'Vlog' && vcp) {
                    vcp.style.display = 'block';
                    loadVlogScoreCalcPanel(data.criteria || []);
                } else if (vcp) {
                    vcp.style.display = 'none';
                }
            });
        }

        function loadVlogScoreCalcPanel(criteria) {
            const cont = document.getElementById('vlogCalcSubmissions');
            if (!cont) return;
            cont.innerHTML = '<p style="color:#aaa;font-size:0.85em;padding:10px">Loading submissionsâ€¦</p>';

            db.ref('vlogChallenge').once('value').then(snap => {
                const teams = [];
                if (snap.exists()) snap.forEach(ch => teams.push({ id: ch.key, ...ch.val() }));
                if (teams.length === 0) {
                    cont.innerHTML = '<p style="color:#aaa;font-size:0.85em;padding:10px;text-align:center">No Vlog submissions yet.</p>';
                    return;
                }

                const maxSocial = 1000; // tune when API live
                let rows = teams.map((t, i) => {
                    const j1 = t.juryTotal_j1 != null ? t.juryTotal_j1 : null;
                    const j2 = t.juryTotal_j2 != null ? t.juryTotal_j2 : null;
                    const juryAvg = (j1 !== null && j2 !== null) ? (j1 + j2) / 2 : (j1 ?? j2 ?? null);
                    const juryPct  = juryAvg !== null ? +((juryAvg / 50) * 50).toFixed(1) : null;
                    const socialPct = t.socialScore > 0 ? +Math.min(50, (t.socialScore / maxSocial) * 50).toFixed(1) : 0;
                    const final    = juryPct !== null ? +(juryPct + socialPct).toFixed(1) : null;

                    const jStr  = juryPct  !== null ? juryPct  + '%' : '<span style="color:#aaa">â€”</span>';
                    const sStr  = socialPct > 0     ? socialPct + '%' : '<span style="color:#aaa">â€”</span>';
                    const fStr  = final !== null ? '<strong style="color:#1b5e20">' + final + '%</strong>' : '<span style="color:#aaa">â€”</span>';

                    return `<tr style="background:${i%2===0?'#fafafa':'white'}">
                        <td style="font-weight:700;color:#833ab4;text-align:center">${i+1}</td>
                        <td style="font-size:0.85em"><strong>${t.member1||'â€”'}</strong> &amp; ${t.member2||'â€”'}</td>
                        <td style="font-size:0.82em;color:#4a148c;font-weight:600">${t.classYear||'â€”'}</td>
                        <td style="font-size:0.82em">${t.topic||'â€”'}</td>
                        <td style="text-align:center;font-size:0.85em">${j1 !== null ? j1+'/50' : '<span style="color:#aaa">â€”</span>'}</td>
                        <td style="text-align:center;font-size:0.85em">${j2 !== null ? j2+'/50' : '<span style="color:#aaa">â€”</span>'}</td>
                        <td style="text-align:center;font-size:0.85em">${jStr}</td>
                        <td style="text-align:center;font-size:0.85em;color:#e91e63;font-weight:700">${t.socialScore > 0 ? t.socialScore : '<span style="color:#aaa">â€”</span>'}</td>
                        <td style="text-align:center;font-size:0.85em">${sStr}</td>
                        <td style="text-align:center;font-size:0.95em">${fStr}</td>
                    </tr>`;
                }).join('');

                cont.innerHTML = `
                    <div style="font-size:0.8em;color:#555;background:#e8f5e9;border-radius:8px;padding:10px 14px;margin-bottom:10px;border-left:4px solid #4caf50">
                        ðŸ“ <strong>Formula:</strong> Final % = (Jury Avg /50 Ã— 50%) + (Social Score /1000 Ã— 50%) &nbsp;|&nbsp;
                        Jury score = avg of Jury 1 + Jury 2 out of 50 &nbsp;|&nbsp; Social = Likes+Comments+Views
                    </div>
                    <div class="table-wrapper" style="margin:0">
                        <table>
                            <thead><tr>
                                <th>#</th><th>Members</th><th>Class</th><th>Topic</th>
                                <th>J1 /50</th><th>J2 /50</th><th>Jury %</th>
                                <th>Social</th><th>Social %</th><th>Final %</th>
                            </tr></thead>
                            <tbody>${rows}</tbody>
                        </table>
                    </div>`;
            });
        }

        function renderCriteriaInputs(criteria) {
            const container = document.getElementById('criteriaContainer');
            container.innerHTML = '';
            
            if (criteria.length === 0) {
                criteria = ['', '', '', '', ''];  // Default 5 empty criteria
            }
            
            criteria.forEach((crit, index) => {
                const div = document.createElement('div');
                div.className = 'criteria-input-group';
                div.innerHTML = `
                    <label>Criterion ${index + 1}:</label>
                    <input type="text" class="criterion-input" data-index="${index}" value="${crit}" placeholder="e.g., Stage Presence, Creativity, Coordination">
                    ${criteria.length > 5 ? '<button class="remove-criteria-btn" onclick="removeCriterion('+index+')">Remove</button>' : ''}
                `;
                container.appendChild(div);
            });
        }

        function addCriterion() {
            const inputs = document.querySelectorAll('.criterion-input');
            const criteria = Array.from(inputs).map(inp => inp.value.trim());
            criteria.push('');
            renderCriteriaInputs(criteria);
        }

        function removeCriterion(index) {
            const inputs = document.querySelectorAll('.criterion-input');
            const criteria = Array.from(inputs).map(inp => inp.value.trim());
            if (criteria.length <= 5) {
                alert('Minimum 5 criteria required');
                return;
            }
            criteria.splice(index, 1);
            renderCriteriaInputs(criteria);
        }

        function saveEventSetup() {
            const event = document.getElementById('setupEventSelect').value;
            if (!event) return;
            
            const jury1Name = document.getElementById('jury1Name').value.trim();
            const jury2Name = document.getElementById('jury2Name').value.trim();
            const jury1Pwd = document.getElementById('jury1Password').value.trim();
            const jury2Pwd = document.getElementById('jury2Password').value.trim();
            
            if (!jury1Pwd || !jury2Pwd) {
                alert('Please set both jury passwords');
                return;
            }
            
            const inputs = document.querySelectorAll('.criterion-input');
            const criteria = Array.from(inputs).map(inp => inp.value.trim()).filter(c => c);
            
            if (criteria.length < 5) {
                alert('Please add at least 5 criteria');
                return;
            }
            
            // Collect class aliases + order if loaded
            let classAliases = {};
            let classOrder = [];
            try { classAliases = getClassAliasesFromFields(); } catch(e) {}
            try { classOrder = getClassOrderFromFields(); } catch(e) {}

            // Event type: individual vs class-based
            // Always honour config â€” individual/multiteam events can't be saved as class-based
            const eventTypeSel = document.querySelector('input[name="juryEventType"]:checked')
                ? document.querySelector('input[name="juryEventType"]:checked').value
                : 'class';
            const eventCfg = events[event] || {};
            const eventType = eventCfg.individual ? 'individual' : (eventCfg.multiTeam ? 'multiteam' : eventTypeSel);

            const setupData = {
                jury1Name: jury1Name || 'Jury 1',
                jury2Name: jury2Name || 'Jury 2',
                jury1Password: jury1Pwd,
                jury2Password: jury2Pwd,
                criteria: criteria,
                classAliases: classAliases,
                classOrder: classOrder,
                eventType: eventType,
                resultsPublished: false
            };
            
            db.ref('jurySetup/'+event).set(setupData).then(() => {
                showSetupMessage('Setup saved successfully! Event type: ' + (eventType === 'individual' ? 'ðŸ§‘ Individual' : eventType === 'multiteam' ? 'ðŸ‘¥ Multi-Team' : 'ðŸ« Class-based'), 'success');
            }).catch(err => {
                showSetupMessage('Error: '+err.message, 'error');
            });
        }

        function publishResults() {
            const event = document.getElementById('resultsEventSelect').value;
            if (!event) {
                alert('Please select an event first');
                return;
            }
            
            if (confirm('Publish results to all admins for '+event+'?')) {
                db.ref('jurySetup/'+event+'/resultsPublished').set(true).then(() => {
                    alert('âœ… Results published to admins for ' + event + '!');
                    // Show Results tab for all admins
                    updateResultsTabVisibility();
                });
            }
        }

        function unpublishResults() {
            const event = document.getElementById('resultsEventSelect').value;
            if (!event) {
                alert('Please select an event first');
                return;
            }
            
            if (confirm('Unpublish results for '+event+'?')) {
                db.ref('jurySetup/'+event+'/resultsPublished').set(false).then(() => {
                    alert('Results unpublished for ' + event);
                    // Check if any other results are published, hide tab if none
                    updateResultsTabVisibility();
                });
            }
        }

        function checkResultsPublished() {
            // For super admin and super jury, always show Results tab
            if (isSuperAdmin) {
                const rt = document.getElementById('resultsTab');
                if (rt) rt.style.display = 'block';
                return;
            }
            
            // For regular admin, check if any event has published results
            db.ref('jurySetup').once('value').then(snap => {
                let hasPublished = false;
                if (snap.exists()) {
                    snap.forEach(eventSnap => {
                        if (eventSnap.val().resultsPublished === true) {
                            hasPublished = true;
                        }
                    });
                }
                
                const resultsTab = document.getElementById('resultsTab');
                if (resultsTab) {
                    resultsTab.style.display = hasPublished ? 'block' : 'none';
                }
            });
        }
        
        function updateResultsTabVisibility() {
            // This is called after publish/unpublish to update tab visibility
            checkResultsPublished();
        }

        function showSetupMessage(msg, type) {
            const d = document.getElementById('setupMessage');
            d.className = 'message '+type+' show';
            d.textContent = (type === 'success' ? 'âœ“ ' : 'âœ— ') + msg;
            setTimeout(() => d.classList.remove('show'), 5000);
        }

        // Jury Functions
        function loadJurySheet() {
            console.log('=== LOADING JURY SHEET ===');
            console.log('juryEvent:', juryEvent);
            console.log('Current all array length:', all.length);
            console.log('Firebase ref path:', ref.toString());
            
            // Show loading message
            document.getElementById('jurySheetContainer').innerHTML = '<p style="text-align:center;padding:40px;color:#666;">Loading enrollments...</p>';
            
            // Determine if this event uses attendance-gating (only present students sent to jury)
            const isHW       = (juryEvent === 'Hand Writing');
            const isTH       = (juryEvent === 'Talent Hunt');
            const isBOW      = (juryEvent === 'Best out of Waste');
            const isPodCast  = (juryEvent === 'Pod Casting');
            const isYTAd     = (juryEvent === 'YouTube Advertisement');

            // -- YOUTUBE ADVERTISEMENT: separate path + class-based ---------------
            if (isYTAd) {
                Promise.all([
                    db.ref('youtubeAd').once('value'),
                    db.ref('jurySetup/' + juryEvent).once('value')
                ]).then(([ytSnap, setupSnap]) => {
                    const setup = setupSnap.val();
                    if (!setup || !setup.criteria) {
                        document.getElementById('jurySheetContainer').innerHTML = '<p style="text-align:center;padding:40px;color:#999">Event setup not complete. Contact super admin.</p>';
                        return;
                    }
                    const ytEntries = [];
                    if (ytSnap.exists()) {
                        ytSnap.forEach(ch => {
                            const d = ch.val();
                            // Skip metadata keys
                            if (!d.classYear) return;
                            ytEntries.push({ id: ch.key, classYear: d.classYear, event: 'YouTube Advertisement',
                                adTitle: d.adTitle, product: d.product, socialScore: d.socialScore, socialPct: d.socialPct,
                                ytLink: d.ytLink, members: d.members });
                        });
                    }
                    if (ytEntries.length === 0) {
                        document.getElementById('jurySheetContainer').innerHTML = '<div style="text-align:center;padding:40px;background:#fff3cd;border-radius:10px;border:2px solid #ffc107"><p style="color:#856404;font-size:1.1em;font-weight:700">â³ No YouTube Ad submissions yet</p></div>';
                        return;
                    }
                    const enrolledClasses = [...new Set(ytEntries.map(e => e.classYear))];
                    let orderedClasses = enrolledClasses.slice();
                    if (setup.classOrder && setup.classOrder.length > 0) {
                        const ordered = setup.classOrder.filter(c => enrolledClasses.includes(c));
                        const remaining = enrolledClasses.filter(c => !ordered.includes(c));
                        orderedClasses = ordered.concat(remaining);
                    }
                    const savedAll = all.slice();
                    all = ytEntries;
                    renderJurySheet(orderedClasses, setup.criteria, setup.classAliases || {}, 'class', ytEntries);
                    all = savedAll;
                    loadExistingMarks();
                }).catch(err => {
                    document.getElementById('jurySheetContainer').innerHTML = '<p style="text-align:center;padding:40px;color:red;">Error: ' + err.message + '</p>';
                });
                return;
            }

            // -- POD CASTING: separate Firebase path + approval gate --------------
            if (isPodCast) {
                const sittingCodePromise = Promise.resolve();
                sittingCodePromise.then(() => Promise.all([
                    db.ref('podcastChallenge').once('value'),
                    db.ref('jurySetup/' + juryEvent).once('value')
                ])).then(([podSnap, setupSnap]) => {
                    const setup = setupSnap.val();
                    if (!setup || !setup.criteria) {
                        document.getElementById('jurySheetContainer').innerHTML = '<p style="text-align:center;padding:40px;color:#999">Event setup not complete. Contact super admin.</p>';
                        return;
                    }

                    // Build enrollment-like records from podcastChallenge (all with link submitted)
                    const podEntries = [];
                    if (podSnap.exists()) {
                        podSnap.forEach(ch => {
                            const d = ch.val();
                            if (d.link) { // show all that have submitted a link
                                podEntries.push({
                                    id: ch.key,
                                    classYear: d.classYear,
                                    name: d.memberName,
                                    topic: d.topic,
                                    subtopic: d.subtopic || '',
                                    episodeTitle: d.episodeTitle,
                                    link: d.link,
                                    approvalStatus: d.approvalStatus || 'pending',
                                    event: 'Pod Casting'
                                });
                            }
                        });
                    }

                    if (podEntries.length === 0) {
                        document.getElementById('jurySheetContainer').innerHTML =
                            '<div style="text-align:center;padding:40px;background:#fff3cd;border-radius:10px;border:2px solid #ffc107">' +
                            '<p style="color:#856404;font-size:1.1em;font-weight:700">â³ No podcast submissions yet</p>' +
                            '<p style="color:#666;margin-top:8px">Waiting for participants to submit their Spotify link via the CR page.</p>' +
                            '<button onclick="loadJurySheet()" style="margin-top:14px;background:#1db954;color:white;border:none;border-radius:8px;padding:8px 20px;font-size:0.9em;font-weight:700;cursor:pointer">ðŸ”„ Refresh</button>' +
                            '</div>';
                        return;
                    }

                    const enrolledClasses = [...new Set(podEntries.map(e => e.classYear).filter(Boolean))];
                    let orderedClasses = enrolledClasses.slice();
                    if (setup.classOrder && setup.classOrder.length > 0) {
                        const ordered = setup.classOrder.filter(c => enrolledClasses.includes(c));
                        const remaining = enrolledClasses.filter(c => !ordered.includes(c));
                        orderedClasses = ordered.concat(remaining);
                    }

                    // Temporarily replace global 'all' filtered view for renderJurySheet
                    const savedAll = all.slice();
                    all = podEntries;
                    renderJurySheet(orderedClasses, setup.criteria, setup.classAliases || {}, 'individual', podEntries);
                    all = savedAll;
                    loadExistingMarks();
                }).catch(err => {
                    console.error('Error loading podcast jury sheet:', err);
                    document.getElementById('jurySheetContainer').innerHTML = '<p style="text-align:center;padding:40px;color:red;">Error: ' + err.message + '</p>';
                });
                return; // exit early â€” podcast handled above
            }

            // For HW/TH: ensure all participants have sitting codes before showing jury sheet
            const sittingCodePromise = isHW
                ? ensureSittingCodes('Hand Writing', 'handwriting')
                : isTH
                    ? ensureSittingCodes('Talent Hunt', 'talenthunt')
                    : Promise.resolve();

            console.log('Fetching from Firebase...');
            // Build fetchList AFTER sittingCodePromise so we read fresh data with sitting codes
            sittingCodePromise.then(() => {
                const fetchList = [ ref.once('value') ];
                if (isHW)  fetchList.push(db.ref('hwAttendance').once('value'));
                if (isTH)  fetchList.push(db.ref('thAttendance').once('value'));
                if (isBOW) fetchList.push(db.ref('bowAttendance').once('value'));
                return Promise.all(fetchList);
            }).then(snaps => {
                const snap = snaps[0];
                const attSnap = snaps[1] || null;
                const attData = attSnap && attSnap.exists() ? attSnap.val() : {};

                console.log('Firebase snapshot received');
                console.log('Snapshot exists:', snap.exists());
                console.log('Snapshot numChildren:', snap.numChildren());
                
                all = [];
                if (snap.exists()) {
                    let count = 0;
                    snap.forEach(child => {
                        count++;
                        const enrollment = {id: child.key, ...child.val()};
                        all.push(enrollment);
                        if (count <= 5) {
                            console.log('Enrollment ' + count + ':', enrollment);
                        }
                    });
                    console.log('Total enrollments loaded:', count);
                } else {
                    console.log('No enrollments found in Firebase!');
                }
                
                console.log('Loaded enrollments, all array length:', all.length);
                
                // Filter for current event
                let eventEnrollments = all.filter(e => e.event === juryEvent);
                console.log('Enrollments for event "' + juryEvent + '":', eventEnrollments.length);

                // For HW / TH / BOW: only send PRESENT participants to jury
                // But ONLY gate if attendance marking has actually started (attData has entries)
                const attHasData = attSnap && attSnap.exists() && Object.keys(attData).length > 0;
                if ((isHW || isTH || isBOW) && attHasData) {
                    const beforeCount = eventEnrollments.length;
                    const presentOnly = eventEnrollments.filter(e => {
                        const att = attData[e.id] || {};
                        return att.status === 'present';
                    });
                    if (presentOnly.length > 0) {
                        // Attendance started and some are present â€” show only present
                        eventEnrollments = presentOnly;
                        console.log('Attendance filter (' + juryEvent + '): ' + beforeCount + ' â†’ ' + eventEnrollments.length + ' present');
                    } else {
                        // Attendance started but nobody marked present yet
                        document.getElementById('jurySheetContainer').innerHTML =
                            '<div style="text-align:center;padding:40px;background:#fff3cd;border-radius:10px;border:2px solid #ffc107">' +
                            '<p style="color:#856404;font-size:1.1em;font-weight:700">â³ No participants marked Present yet</p>' +
                            '<p style="color:#666;margin-top:8px">The faculty coordinator must mark participants as <strong>Present</strong> in the attendance panel before they appear on the jury sheet.</p>' +
                            '</div>';
                        return;
                    }
                }
                // If attHasData is false (attendance not started yet), show all enrolled students
                
                // Now get jury setup
                return db.ref('jurySetup/'+juryEvent).once('value').then(setupSnap => {
                    const setup = setupSnap.val();
                    console.log('Jury setup:', setup);
                    
                    if (!setup || !setup.criteria) {
                        document.getElementById('jurySheetContainer').innerHTML = '<p style="text-align:center;padding:40px;color:#999">Event setup not complete. Contact super admin.</p>';
                        return;
                    }
                    
                    // Get enrolled classes from filtered eventEnrollments (support both classYear and class fields)
                    const enrolledClasses = [...new Set(eventEnrollments.map(e => e.classYear || e.class).filter(Boolean))];
                    
                    console.log('Enrolled classes for', juryEvent, ':', enrolledClasses);
                    
                    if (enrolledClasses.length === 0) {
                        let debugInfo = '<p style="text-align:center;padding:40px;">';
                        debugInfo += '<strong style="color:#f44336;">No classes enrolled for this event yet.</strong><br><br>';
                        debugInfo += '<span style="color:#666;">Event: ' + juryEvent + '<br>';
                        debugInfo += 'Total enrollments in database: ' + all.length + '<br>';
                        debugInfo += 'Enrollments for this event: ' + all.filter(e => e.event === juryEvent).length + '</span><br><br>';
                        debugInfo += '<button class="btn btn-info" onclick="showEnrollmentDebug()">ðŸ” Debug Enrollments</button>';
                        debugInfo += '</p>';
                        document.getElementById('jurySheetContainer').innerHTML = debugInfo;
                        return;
                    }
                    
                    // Apply saved class order if available
                    let orderedClasses = enrolledClasses.slice();
                    if (setup.classOrder && setup.classOrder.length > 0) {
                        const ordered = setup.classOrder.filter(c => enrolledClasses.includes(c));
                        const remaining = enrolledClasses.filter(c => !ordered.includes(c));
                        orderedClasses = ordered.concat(remaining);
                    }

                    // For Vlog: also load vlogChallenge to get social scores
                    if (juryEvent === 'Vlog') {
                        db.ref('vlogChallenge').once('value').then(vlogSnap => {
                            const vlogData = {};
                            if (vlogSnap.exists()) {
                                vlogSnap.forEach(ch => {
                                    const v = ch.val();
                                    const key = (v.classYear || '') + '__' + (v.topic || '');
                                    vlogData[key] = v;
                                });
                            }
                            renderJurySheet(orderedClasses, setup.criteria, setup.classAliases || {}, setup.eventType || 'class', eventEnrollments, vlogData);
                            loadExistingMarks();
                        }).catch(err => {
                            console.warn('Could not load vlogChallenge social scores (non-fatal):', err);
                            renderJurySheet(orderedClasses, setup.criteria, setup.classAliases || {}, setup.eventType || 'class', eventEnrollments, {});
                            loadExistingMarks();
                        });
                    } else {
                        renderJurySheet(orderedClasses, setup.criteria, setup.classAliases || {}, setup.eventType || 'class', eventEnrollments);
                        loadExistingMarks();
                    }
                });
            }).catch(err => {
                console.error('Error loading jury sheet:', err);
                document.getElementById('jurySheetContainer').innerHTML = '<p style="text-align:center;padding:40px;color:red;">Error loading jury sheet: ' + err.message + '</p>';
            });
        }

        function renderJurySheet(enrolledClasses, criteria, aliasMap, eventType, eventEnrollments, vlogData) {
            aliasMap    = aliasMap    || {};
            eventType   = eventType   || 'class';
            vlogData    = vlogData    || {};
            eventEnrollments = eventEnrollments || all.filter(e => e.event === juryEvent);

            // Always honour the events config â€” if the event is configured as multiTeam or individual,
            // use that regardless of what was saved in jurySetup (guards against stale saved values)
            const liveCfg = (events && juryEvent) ? (events[juryEvent] || {}) : {};
            if (liveCfg.multiTeam) eventType = 'multiteam';
            else if (liveCfg.individual) eventType = 'individual';

            // Helper: safe alias lookup â€” jury NEVER sees real class name
            function getAlias(cls) {
                const sk = cls.replace(/[.\[\]#$\/\s]/g,'_');
                return aliasMap[sk] || ('Class ' + (Object.keys(aliasMap).indexOf(sk) >= 0 ? '' : '?'));
            }

            let html = '';

            if (eventType === 'individual') {
                // -- INDIVIDUAL EVENT (HW, TH, Pod Casting) -----------------------
                const isHWEvent  = (juryEvent === 'Hand Writing');
                const isTHEvent  = (juryEvent === 'Talent Hunt');
                const isPodEvent = (juryEvent === 'Pod Casting');
                const usesSittingCode = isHWEvent || isTHEvent;
                const sittingPrefix   = isHWEvent ? 'HW' : isTHEvent ? 'TH' : '';

                html += '<div style="background:#e3f2fd;border-left:5px solid #1565c0;padding:10px 16px;border-radius:8px;margin-bottom:14px;font-size:13px;color:#1a237e;display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:8px">';
                html += '<span><strong>&#x1F9D1; Individual Event Mode</strong> â€” Each entry is scored separately. ';
                if (usesSittingCode) html += 'Sitting codes are shown â€” <strong>real names and classes are hidden</strong> until you click "Mark as Completed".';
                else html += '<strong>Real class names are hidden</strong> â€” only code names are shown until "Mark as Completed".';
                html += '</span>';
                if (isPodEvent) html += '<button onclick="loadJurySheet()" style="background:#1a237e;color:white;border:none;border-radius:7px;padding:5px 14px;font-size:0.82em;font-weight:700;cursor:pointer">ðŸ”„ Refresh</button>';
                html += '</div>';

                const colHeader = isPodEvent ? 'Participant Code' : usesSittingCode ? 'Sitting Code' : 'Code';
                html += '<div class="table-wrapper"><div class="marks-table"><table><thead><tr>';
                html += '<th>#</th><th>' + colHeader + '</th>';
                if (isPodEvent) html += '<th>Episode</th><th>ðŸŽ™ï¸ Listen</th>';
                else html += '<th>Details</th>';
                criteria.forEach(crit => { html += '<th>' + crit + '<br><small>(10 marks)</small></th>'; });
                html += '<th>Total</th></tr></thead><tbody>';

                let seq = 1;
                enrolledClasses.forEach(cls => {
                    const safeKey = cls.replace(/[.\[\]#$\/\s]/g,'_');
                    const alias   = aliasMap[safeKey] || ('Code-' + seq);
                    const studentsInClass = eventEnrollments.filter(e => (e.classYear||e.class) === cls);
                    studentsInClass.forEach((enr, idx) => {
                        const rowKey = safeKey + '__p' + (idx + 1);
                        let codeCell;
                        if (usesSittingCode) {
                            const scCode = enr.sittingCode
                                ? (sittingPrefix + '-' + enr.sittingCode)
                                : (sittingPrefix + '-' + generateSittingCode(enr.id, sittingPrefix));
                            codeCell = '<span style="background:' + (isHWEvent?'#1a237e':'#e65100') + ';color:white;font-weight:900;padding:4px 12px;border-radius:8px;font-size:1em;letter-spacing:3px">' + scCode + '</span>';
                        } else if (isPodEvent) {
                            codeCell = '<span style="background:#880e4f;color:white;font-weight:800;padding:4px 12px;border-radius:8px;font-size:0.88em">' + alias + ' â€” P' + (idx+1) + '</span>';
                        } else {
                            codeCell = '<strong>' + alias + ' â€” P' + (idx+1) + '</strong>';
                        }
                        html += '<tr>';
                        html += '<td>' + seq + '</td>';
                        html += '<td>' + codeCell + '</td>';
                        if (isPodEvent) {
                            const epTitle = enr.episodeTitle ? '<strong>' + enr.episodeTitle + '</strong>' : 'â€”';
                            const epTopic = enr.topic ? '<br><small style="color:#888">' + enr.topic + '</small>' : '';
                            const epSubtopic = enr.subtopic ? '<br><small style="color:#1565c0">ðŸ”– ' + enr.subtopic + '</small>' : '';
                            const epDur   = enr.duration ? '<br><small style="color:#666">â± ' + enr.duration + '</small>' : '';
                            const isApproved = enr.approvalStatus === 'approved';
                            const approvalBadge = isApproved
                                ? '<span style="background:#d4edda;color:#155724;border-radius:8px;padding:2px 8px;font-size:0.75em;font-weight:700">âœ… Approved</span>'
                                : '<span style="background:#fff3cd;color:#856404;border-radius:8px;padding:2px 8px;font-size:0.75em;font-weight:700">â³ Pending Approval</span>';
                            html += '<td><small>' + epTitle + epTopic + epSubtopic + epDur + '</small><br>' + approvalBadge + '</td>';
                            const spotLink = enr.link
                                ? '<a href="' + enr.link + '" target="_blank" style="background:#1db954;color:white;padding:4px 10px;border-radius:6px;text-decoration:none;font-size:0.8em;font-weight:700">â–¶ Spotify</a>'
                                : '<span style="color:#aaa;font-size:0.8em">No link</span>';
                            html += '<td>' + spotLink + '</td>';
                        } else {
                            const detail = getDet(enr) || 'â€”';
                            html += '<td><small>' + detail + '</small></td>';
                        }
                        const isPodApproved = isPodEvent ? (enr.approvalStatus === 'approved') : true;
                        criteria.forEach((crit, i) => {
                            if (isPodEvent && !isPodApproved) {
                                html += '<td style="background:#f5f5f5"><span style="color:#bbb;font-size:0.75em">ðŸ”’ Locked</span></td>';
                            } else {
                                html += '<td><input type="number" class="marks-input" data-class="' + rowKey + '" data-origclass="' + cls + '" data-criterion="' + i + '" min="0" max="10" step="0.5" placeholder="0-10"></td>';
                            }
                        });
                        html += '<td class="total-marks" id="total-' + rowKey + '">0</td>';
                        html += '</tr>';
                        seq++;
                    });
                });
                html += '</tbody></table></div></div>';

            } else if (eventType === 'multiteam') {
                // -- MULTI-TEAM EVENT (Vlog, BOW) --------------------------------
                const isVlog = (juryEvent === 'Vlog');
                const isBOW  = (juryEvent === 'Best out of Waste');

                html += '<div style="background:#fff3e0;border-left:5px solid #e65100;padding:10px 16px;border-radius:8px;margin-bottom:14px;font-size:13px;color:#bf360c">';
                html += '<strong>&#x1F465; Multi-Team Event Mode</strong> â€” Each team is scored separately. <strong>Real class names are hidden</strong> â€” revealed only after "Mark as Completed".';
                html += '</div>';

                html += '<div class="table-wrapper"><div class="marks-table"><table><thead><tr>';
                html += '<th>#</th><th>Team Code</th>';
                if (isVlog) html += '<th>Topic</th><th>Social Score</th>';
                else html += '<th>Detail</th>';
                criteria.forEach(crit => { html += '<th>' + crit + '<br><small>(10 marks)</small></th>'; });
                html += '<th>Total</th></tr></thead><tbody>';

                const liveCfgMT = liveCfg;
                const membersPerTeam = liveCfgMT.count || 2;
                let seq = 1;
                let globalMTTeamNum = 0; // global counter across all classes

                let mtSeqIdx = 0;
                enrolledClasses.forEach(cls => {
                    const safeKey = cls.replace(/[.\[\]#$\/\s]/g,'_');
                    const alias   = aliasMap[safeKey] || ('Class ' + String.fromCharCode(65 + mtSeqIdx));
                    mtSeqIdx++;
                    const classEnrollments = eventEnrollments.filter(e => (e.classYear||e.class) === cls);
                    const teamsMap = {};
                    classEnrollments.forEach((enr, idx) => {
                        let tKey;
                        if (enr.teamNum != null) tKey = String(enr.teamNum);
                        else if (enr.topic) tKey = 'topic__' + enr.topic;
                        else tKey = String(Math.floor(idx / membersPerTeam) + 1);
                        if (!teamsMap[tKey]) teamsMap[tKey] = [];
                        teamsMap[tKey].push(enr);
                    });

                    const teamNums = Object.keys(teamsMap).sort((a,b) => Number(a)-Number(b));
                    teamNums.forEach((tNum, tIdx) => {
                        globalMTTeamNum++;
                        const teamMembers = teamsMap[tNum];
                        const rowKey = safeKey + '__t' + (tIdx + 1);
                        // Show ONLY alias + team number â€” NEVER real class name
                        const teamCode = isBOW ? 'Team ' + globalMTTeamNum : alias + ' â€” Team ' + (tIdx + 1);
                        const teamTopic = teamMembers[0].topic || '';
                        const vlogKey   = cls + '__' + teamTopic;
                        const vlogEntry = vlogData[vlogKey] || null;
                        const socialScore = vlogEntry ? (vlogEntry.socialScore || 0) : 0;
                        const detail = getDet(teamMembers[0]) || 'â€”';

                        html += '<tr>';
                        html += '<td>' + seq + '</td>';
                        html += '<td><span style="background:#4a148c;color:white;font-weight:800;padding:3px 12px;border-radius:8px;font-size:0.88em">' + teamCode + '</span></td>';
                        if (isVlog) {
                            html += '<td><small>' + (teamTopic || 'â€”') + '</small></td>';
                            html += '<td style="text-align:center;font-weight:700;color:' + (socialScore>0?'#e91e63':'#aaa') + '">' + (socialScore>0?socialScore:'â€”') + '</td>';
                        } else {
                            html += '<td><small>' + detail + '</small></td>';
                        }
                        criteria.forEach((crit, i) => {
                            html += '<td><input type="number" class="marks-input" data-class="' + rowKey + '" data-origclass="' + cls + '" data-criterion="' + i + '" min="0" max="10" step="0.5" placeholder="0-10"></td>';
                        });
                        html += '<td class="total-marks" id="total-' + rowKey + '" data-social="' + socialScore + '">0</td>';
                        html += '</tr>';
                        seq++;
                    });
                });
                html += '</tbody></table></div></div>';

            } else {
                // -- CLASS-BASED EVENT --------------------------------------------
                const isNukkad = (juryEvent === 'Nukkad Natak');
                const isYTAd   = (juryEvent === 'YouTube Advertisement');
                const isDance  = (juryEvent === 'Group Dance');

                // For Nukkad: we'll load ytVerified bonus async after table renders
                // For YT Ad: show social score, ad title, product
                // For Dance: show story title + summary

                html += '<div class="table-wrapper"><div class="marks-table"><table><thead><tr>';
                html += '<th>#</th><th>Class Code</th>';
                if (isNukkad) html += '<th>Cause/Theme</th><th>ðŸ“º YouTube</th><th>Bonus pts</th>';
                else if (isYTAd) html += '<th>Ad Title</th><th>Product</th><th>Social Score</th>';
                else if (isDance) html += '<th>ðŸ“– Dance Story Title</th><th>ðŸ“ Story Summary</th><th>ðŸ‘¥ Performers</th>';
                else html += '<th>Theme/Topic</th>';
                criteria.forEach(crit => { html += '<th>' + crit + '<br><small>(10 marks)</small></th>'; });
                html += '<th>Total</th></tr></thead><tbody>';

                enrolledClasses.forEach((cls, idx) => {
                    const safeKey   = cls.replace(/[.\[\]#$\/\s]/g,'_');
                    const alias     = aliasMap[safeKey] || ('Class ' + String.fromCharCode(65+idx));
                    const classEnrollments = eventEnrollments.filter(e => (e.classYear||e.class) === cls);
                    const firstEnr  = classEnrollments[0] || {};

                    html += '<tr>';
                    html += '<td>' + (idx+1) + '</td>';
                    html += '<td><strong>' + alias + '</strong></td>';

                    if (isNukkad) {
                        const cause = firstEnr.cause || firstEnr.topic || 'â€”';
                        html += '<td><small>' + cause + '</small></td>';
                        // YouTube link cell â€” populated async after table renders
                        html += '<td id="nukkad-yt-' + safeKey + '"><small style="color:#aaa">Loadingâ€¦</small></td>';
                        // Bonus pts cell
                        html += '<td id="nukkad-bonus-' + safeKey + '" style="font-weight:700;color:#1565c0" data-cls="' + cls + '" data-key="' + safeKey + '">0</td>';
                    } else if (isYTAd) {
                        const adTitle   = firstEnr.adTitle   || 'â€”';
                        const product   = firstEnr.product   || 'â€”';
                        const socialSc  = firstEnr.socialPct != null ? firstEnr.socialPct : (firstEnr.socialScore || 0);
                        html += '<td><small>' + adTitle + '</small></td>';
                        html += '<td><small>' + product + '</small></td>';
                        html += '<td style="font-weight:700;color:' + (socialSc>0?'#e91e63':'#aaa') + '" id="ytad-social-' + safeKey + '" data-social="' + socialSc + '">' + (socialSc>0?socialSc:'â€”') + '</td>';
                    } else if (isDance) {
                        // Dance story â€” loaded async below
                        html += '<td id="dance-title-' + safeKey + '"><small style="color:#aaa">Loadingâ€¦</small></td>';
                        html += '<td id="dance-summary-' + safeKey + '"><small style="color:#aaa">Loadingâ€¦</small></td>';
                        // Performers list
                        const performers = classEnrollments.map(e => e.name || 'â€”').join(', ');
                        html += '<td><small style="color:#555">' + (performers || 'â€”') + '</small></td>';
                    } else {
                        const theme = getDet(firstEnr) || 'â€”';
                        html += '<td><small>' + theme + '</small></td>';
                    }

                    criteria.forEach((crit, i) => {
                        html += '<td><input type="number" class="marks-input" data-class="' + safeKey + '" data-origclass="' + cls + '" data-criterion="' + i + '" min="0" max="10" step="0.5" placeholder="0-10"></td>';
                    });

                    const socialForTotal = isYTAd ? (firstEnr.socialPct || firstEnr.socialScore || 0) : 0;
                    html += '<td class="total-marks" id="total-' + safeKey + '" data-social="' + socialForTotal + '">0</td>';
                    html += '</tr>';
                });
                html += '</tbody></table></div></div>';

                // -- Async: load Nukkad YT links + bonus from nukkadNatak/post --
                if (isNukkad) {
                    db.ref('nukkadNatak/post').once('value').then(postSnap => {
                        const postData = postSnap.exists() ? postSnap.val() : {};
                        enrolledClasses.forEach(cls => {
                            const safeKey = cls.replace(/[.\[\]#$\/\s]/g,'_');
                            const post    = postData[safeKey] || {};
                            const ytLink  = post.ytLink || '';
                            const ytVerified  = post.ytVerified === true;
                            const newsVerified = post.newspaperVerified === true;
                            // Each verified item adds 10 bonus pts
                            const bonus   = (ytVerified ? 10 : 0) + (newsVerified ? 10 : 0);

                            const ytCell    = document.getElementById('nukkad-yt-' + safeKey);
                            const bonusCell = document.getElementById('nukkad-bonus-' + safeKey);
                            const totalCell = document.getElementById('total-' + safeKey);

                            if (ytCell) {
                                ytCell.innerHTML = ytLink
                                    ? '<a href="' + ytLink + '" target="_blank" style="background:#ff0000;color:white;padding:4px 10px;border-radius:6px;text-decoration:none;font-size:0.8em;font-weight:700">â–¶ YouTube</a>'
                                    + (ytVerified ? ' <span style="color:#2e7d32;font-size:0.75em">âœ… Verified</span>' : ' <span style="color:#f57c00;font-size:0.75em">âš ï¸ Not verified</span>')
                                    : '<span style="color:#aaa;font-size:0.8em">Not submitted</span>';
                            }
                            if (bonusCell) {
                                bonusCell.textContent = '+' + bonus;
                                bonusCell.dataset.bonus = bonus;
                                bonusCell.style.color = bonus > 0 ? '#2e7d32' : '#aaa';
                            }
                            if (totalCell) {
                                totalCell.dataset.social = bonus; // reuse social slot for bonus
                            }
                        });
                    }).catch(() => {
                        // Non-fatal â€” just leave cells as 0
                    });
                }

                // -- Async: load YT Ad social scores from youtubeAd --------------
                if (isYTAd) {
                    db.ref('youtubeAd').once('value').then(ytSnap => {
                        if (!ytSnap.exists()) return;
                        ytSnap.forEach(ch => {
                            const d = ch.val();
                            const safeKey = (d.classYear||'').replace(/[.\[\]#$\/\s]/g,'_');
                            const socialPct = d.socialPct != null ? d.socialPct : (d.socialScore || 0);
                            const ytAdCell  = document.getElementById('ytad-social-' + safeKey);
                            const totalCell = document.getElementById('total-' + safeKey);
                            if (ytAdCell) {
                                ytAdCell.textContent = socialPct > 0 ? socialPct : 'â€”';
                                ytAdCell.style.color = socialPct > 0 ? '#e91e63' : '#aaa';
                                ytAdCell.dataset.social = socialPct;
                            }
                            if (totalCell) totalCell.dataset.social = socialPct;
                        });
                    }).catch(() => {});
                }

                // -- Async: load Group Dance stories from groupDance/ ----------
                if (isDance) {
                    db.ref('groupDance').once('value').then(danceSnap => {
                        const danceData = danceSnap.exists() ? danceSnap.val() : {};
                        enrolledClasses.forEach(cls => {
                            const safeKey = cls.replace(/[.\[\]#$\/\s]/g,'_');
                            const story   = danceData[safeKey] || {};
                            const titleCell   = document.getElementById('dance-title-' + safeKey);
                            const summaryCell = document.getElementById('dance-summary-' + safeKey);
                            if (titleCell) {
                                titleCell.innerHTML = story.title
                                    ? '<strong style="color:#880e4f">' + story.title + '</strong>'
                                    : '<span style="color:#aaa;font-size:0.8em">Not submitted</span>';
                            }
                            if (summaryCell) {
                                summaryCell.innerHTML = story.summary
                                    ? '<span style="font-size:0.82em;color:#333;line-height:1.5">' + story.summary + '</span>'
                                    : '<span style="color:#aaa;font-size:0.8em">Not submitted</span>';
                            }
                        });
                    }).catch(() => {});
                }
            }

            document.getElementById('jurySheetContainer').innerHTML = html;

            // Add event listeners for auto-calculation
            document.querySelectorAll('.marks-input').forEach(inp => {
                inp.addEventListener('input', function() {
                    calculateTotal(this.dataset.class);
                });
            });
        }

        function loadExistingMarks() {
            const dbPath = 'juryMarks/' + juryEvent + '/jury' + juryNumber;
            console.log('=== LOADING EXISTING MARKS ===');
            console.log('Loading marks from:', dbPath);
            console.log('juryEvent:', juryEvent);
            console.log('juryNumber:', juryNumber);
            
            db.ref(dbPath).once('value').then(snap => {
                const marks = snap.val();
                console.log('Loaded marks data:', JSON.stringify(marks, null, 2));
                
                if (!marks) {
                    console.log('No existing marks found');
                    return;
                }
                
                // Check if this is test data (has 'test' property instead of class data)
                if (marks.test !== undefined) {
                    console.warn('âš ï¸ TEST DATA DETECTED in database!');
                    console.warn('Path contains test data instead of actual marks');
                    console.warn('You should clear this test data from Firebase Console');
                    showJuryMessage('Warning: Test data found in database. Clear it before saving real marks.', 'error');
                    return;
                }
                
                // Check what's in the database
                console.log('Database keys:', Object.keys(marks));
                
                // Check what inputs are available
                const allInputs = document.querySelectorAll('.marks-input');
                console.log('Total inputs found:', allInputs.length);
                allInputs.forEach(inp => {
                    console.log('Input found - class:', inp.dataset.class, 'criterion:', inp.dataset.criterion);
                });
                
                let marksLoaded = 0;
                
                Object.keys(marks).forEach(sanitizedCls => {
                    console.log('Processing class from database:', sanitizedCls);
                    
                    if (marks[sanitizedCls] && marks[sanitizedCls].marks && Array.isArray(marks[sanitizedCls].marks)) {
                        console.log('Marks array for', sanitizedCls, ':', marks[sanitizedCls].marks);
                        
                        // Get the original class name if available, otherwise use the sanitized one
                        const originalCls = marks[sanitizedCls].originalClassName || sanitizedCls;
                        console.log('Original class name:', originalCls);
                        
                        marks[sanitizedCls].marks.forEach((mark, i) => {
                            // Try to find input using original class name first
                            let selector = '.marks-input[data-class="'+originalCls+'"][data-criterion="'+i+'"]';
                            let inp = document.querySelector(selector);
                            
                            // If not found, try sanitized class name
                            if (!inp) {
                                selector = '.marks-input[data-class="'+sanitizedCls+'"][data-criterion="'+i+'"]';
                                inp = document.querySelector(selector);
                            }
                            
                            console.log('Looking for input with selector:', selector);
                            
                            if (inp) {
                                inp.value = mark;
                                marksLoaded++;
                                console.log('âœ“ Set mark for', originalCls, 'criterion', i, ':', mark);
                            } else {
                                console.warn('âœ— Input NOT found for class:', originalCls, '(sanitized:', sanitizedCls, ') criterion:', i);
                            }
                        });
                        calculateTotal(originalCls);
                    } else {
                        console.warn('Invalid marks structure for class:', sanitizedCls, marks[sanitizedCls]);
                    }
                });
                
                if (marksLoaded > 0) {
                    showJuryMessage('Previous marks loaded successfully ('+marksLoaded+' marks)', 'success');
                } else {
                    showJuryMessage('No previous marks found to load', 'error');
                }
            }).catch(err => {
                console.error('Error loading marks:', err);
                showJuryMessage('Error loading marks: ' + err.message, 'error');
            });
        }

        function calculateTotal(cls) {
            const inputs = document.querySelectorAll('.marks-input[data-class="'+cls+'"]');
            let total = 0;
            inputs.forEach(inp => {
                const val = parseFloat(inp.value) || 0;
                total += val;
            });
            const totalCell = document.getElementById('total-'+cls.replace(/\s+/g, '-'));
            if (totalCell) {
                // Add social score if present (multiteam events)
                const social = parseFloat(totalCell.dataset.social) || 0;
                totalCell.textContent = (total + social).toFixed(1);
            }
        }

        function sanitizeKey(key) {
            // Replace characters that Firebase doesn't allow in keys
            // . $ # [ ] / and control characters
            return key.replace(/[.#$\[\]\/]/g, '_');
        }

        function saveMarks() {
            console.log('=== SAVE MARKS STARTED ===');
            console.log('juryEvent:', juryEvent);
            console.log('juryNumber:', juryNumber);
            console.log('Database connected:', isConnected);
            
            if (!juryEvent || !juryNumber) {
                alert('Error: Jury session not initialized. Please log in again.');
                return;
            }
            
            if (!isConnected) {
                alert('Error: Not connected to Firebase database. Please check your internet connection.');
                return;
            }
            
            const marksData = {};
            let inputCount = 0;
            
            // First, organize marks by class
            document.querySelectorAll('.marks-input').forEach(inp => {
                inputCount++;
                const cls = inp.dataset.class;
                const sanitizedCls = sanitizeKey(cls); // Sanitize class name for Firebase
                const critIndex = parseInt(inp.dataset.criterion);
                const val = parseFloat(inp.value) || 0;
                
                if (!marksData[sanitizedCls]) {
                    marksData[sanitizedCls] = { 
                        marks: {}, 
                        completed: false,
                        originalClassName: cls // Store original name
                    };
                }
                marksData[sanitizedCls].marks[critIndex] = val;
            });
            
            // Convert marks object to array to ensure proper structure
            Object.keys(marksData).forEach(cls => {
                const marksObj = marksData[cls].marks;
                const marksArray = [];
                const maxIndex = Math.max(...Object.keys(marksObj).map(k => parseInt(k)));
                
                // Fill array with all marks
                for (let i = 0; i <= maxIndex; i++) {
                    marksArray[i] = marksObj[i] !== undefined ? marksObj[i] : 0;
                }
                
                marksData[cls].marks = marksArray;
            });
            
            console.log('Marks inputs found:', inputCount);
            console.log('Marks data to save:', JSON.stringify(marksData, null, 2));
            
            if (inputCount === 0) {
                alert('No marks data found. Please refresh the page and try again.');
                return;
            }
            
            // Show saving indicator
            showJuryMessage('Saving marks...', 'success');
            
            // Use raw event name (do not encode)
            const dbPath = 'juryMarks/' + juryEvent + '/jury' + juryNumber;
            console.log('Event name:', juryEvent);
            console.log('Saving to Firebase path:', dbPath);
            console.log('Full database URL:', db.ref(dbPath).toString());
            
            // CRITICAL FIX: First check if there's test data and clear it
            db.ref(dbPath).once('value').then(snap => {
                const existingData = snap.val();
                
                // Check if test data exists
                if (existingData && existingData.test !== undefined) {
                    console.warn('âš ï¸ Test data detected! Clearing before save...');
                    showJuryMessage('Clearing test data...', 'success');
                    // First delete the entire node to clear test data
                    return db.ref(dbPath).remove();
                }
                
                return Promise.resolve();
            }).then(() => {
                console.log('Now saving actual marks data...');
                // Now save the actual marks data
                return db.ref(dbPath).set(marksData);
            }).then(() => {
                console.log('âœ“ Firebase .set() resolved successfully');
                
                // Immediately verify the save
                return db.ref(dbPath).once('value');
            }).then(snap => {
                const savedData = snap.val();
                console.log('âœ“ Verification read successful');
                console.log('Data in database:', JSON.stringify(savedData, null, 2));
                
                if (savedData && savedData.test === undefined) {
                    // Check that we have actual class data, not test data
                    const hasRealData = Object.keys(savedData).some(key => 
                        savedData[key] && savedData[key].marks && Array.isArray(savedData[key].marks)
                    );
                    
                    if (hasRealData) {
                        showJuryMessage('Marks saved successfully!', 'success');
                        alert('âœ… SUCCESS!\n\nMarks saved and verified in database.\n\n' + 
                              'Classes saved: ' + Object.keys(savedData).length + '\n\n' +
                              'Path: juryMarks/' + juryEvent + '/jury' + juryNumber);
                    } else {
                        console.error('âœ— VERIFICATION FAILED: Data saved but structure is wrong');
                        showJuryMessage('Warning: Data saved but structure may be incorrect', 'error');
                    }
                } else if (savedData && savedData.test !== undefined) {
                    console.error('âœ— TEST DATA STILL EXISTS after save attempt');
                    showJuryMessage('Error: Test data blocking saves. Please clear manually.', 'error');
                    alert('âš ï¸ TEST DATA PROBLEM!\n\nTest data is still in the database.\n\n' +
                          'Please manually delete from Firebase Console:\n' +
                          'juryMarks > Solo Dance > jury1 > test');
                } else {
                    console.error('âœ— VERIFICATION FAILED: Data is null after save');
                    showJuryMessage('Warning: Save completed but verification failed', 'error');
                    alert('âš ï¸ WARNING!\n\nSave appeared successful but data could not be verified.\n\n' +
                          'Possible issue: Firebase security rules may be blocking reads.\n\n' +
                          'Please check Firebase Console > Realtime Database > Rules');
                }
            }).catch(err => {
                console.error('âœ— FIREBASE ERROR:', err);
                console.error('Error code:', err.code);
                console.error('Error message:', err.message);
                
                let errorMsg = 'âŒ SAVE FAILED!\n\n';
                
                if (err.code === 'PERMISSION_DENIED' || err.message.includes('permission')) {
                    errorMsg += 'ERROR: Permission Denied\n\n';
                    errorMsg += 'Firebase security rules are blocking the save.\n\n';
                    errorMsg += 'SOLUTION:\n';
                    errorMsg += '1. Go to Firebase Console\n';
                    errorMsg += '2. Realtime Database > Rules\n';
                    errorMsg += '3. Set rules to allow writes\n\n';
                    errorMsg += 'See browser console for details.';
                    
                    console.log('%c FIREBASE RULES FIX NEEDED ', 'background: red; color: white; font-size: 16px; font-weight: bold;');
                    console.log('Your current Firebase rules are blocking writes to: ' + dbPath);
                    console.log('\nTo fix this, update your Firebase Realtime Database Rules to:');
                    console.log('{\n  "rules": {\n    ".read": true,\n    ".write": true\n  }\n}');
                    console.log('\nOR for better security:');
                    console.log('{\n  "rules": {\n    "juryMarks": {\n      ".read": true,\n      ".write": true\n    },\n    "jurySetup": {\n      ".read": true,\n      ".write": true\n    },\n    "youthfest-enrollments": {\n      ".read": true,\n      ".write": true\n    }\n  }\n}');
                } else {
                    errorMsg += 'Error: ' + err.message + '\n\n';
                        errorMsg += 'Code: ' + err.code + '\n\n';
                        errorMsg += 'Check browser console for details.';
                    }
                    
                    showJuryMessage('Error: ' + err.message, 'error');
                    alert(errorMsg);
                });
        }

        function markAsCompleted() {
            if (!confirm('Mark evaluation as completed? You can still edit marks later.')) return;
            
            const marksData = {};
            
            // First, organize marks by class
            document.querySelectorAll('.marks-input').forEach(inp => {
                const cls = inp.dataset.class;
                const sanitizedCls = sanitizeKey(cls); // Sanitize class name
                const critIndex = parseInt(inp.dataset.criterion);
                const val = parseFloat(inp.value) || 0;
                
                if (!marksData[sanitizedCls]) {
                    marksData[sanitizedCls] = { 
                        marks: {}, 
                        completed: true,
                        originalClassName: cls
                    };
                }
                marksData[sanitizedCls].marks[critIndex] = val;
            });
            
            // Convert marks object to array to ensure proper structure
            Object.keys(marksData).forEach(cls => {
                const marksObj = marksData[cls].marks;
                const marksArray = [];
                const maxIndex = Math.max(...Object.keys(marksObj).map(k => parseInt(k)));
                
                // Fill array with all marks
                for (let i = 0; i <= maxIndex; i++) {
                    marksArray[i] = marksObj[i] !== undefined ? marksObj[i] : 0;
                }
                
                marksData[cls].marks = marksArray;
            });
            
            const dbPath = 'juryMarks/' + juryEvent + '/jury' + juryNumber;
            
            db.ref(dbPath).set(marksData).then(async () => {
                showJuryMessage('Evaluation marked as completed!', 'success');
                // Reveal real class names and show rankings
                try {
                    const setupSnap = await db.ref('jurySetup/' + juryEvent).once('value');
                    const setup = setupSnap.val() || {};
                    const aliasMap = setup.classAliases || {};
                    // Build reverse: safeKey -> real class
                    const realClasses = {};
                    all.filter(e => e.event === juryEvent).forEach(e => {
                        const sk = e.classYear.replace(/[.\[\]#$\/\s]/g, '_');
                        realClasses[sk] = e.classYear;
                    });
                    // Tally totals from submitted marksData (include social score from total cell)
                    const totals = [];
                    Object.entries(marksData).forEach(([sk, d]) => {
                        const juryTotal = (d.marks || []).reduce((s, v) => s + (parseFloat(v)||0), 0);
                        // Read social score stored in the total cell's data-social attribute
                        const totalCell = document.getElementById('total-' + sk);
                        const social = totalCell ? (parseFloat(totalCell.dataset.social) || 0) : 0;
                        const total = juryTotal + social;
                        const alias = aliasMap[sk] || sk;
                        const real = realClasses[sk] || sk;
                        totals.push({ sk, alias, real, total });
                    });
                    totals.sort((a, b) => b.total - a.total);
                    let msg = 'Evaluation marked as completed!\n\nRESULTS REVEALED:\n';
                    totals.forEach((t, i) => {
                        const medal = i === 0 ? 'WINNER' : i === 1 ? 'RUNNER-UP' : (i+1)+'.';
                        msg += '\n' + medal + ': ' + t.alias + ' = ' + t.real + ' (' + t.total.toFixed(1) + ' marks)';
                    });
                    alert(msg);
                } catch(e) {
                    alert('Evaluation marked as completed! Your marks are now final.');
                }
            }).catch(err => {
                showJuryMessage('Error: '+err.message, 'error');
                alert('âŒ Error: '+err.message);
            });
        }

        function showJuryMessage(msg, type) {
            const d = document.getElementById('juryMessage');
            d.className = 'message '+type+' show';
            d.textContent = (type === 'success' ? 'âœ“ ' : 'âœ— ') + msg;
            setTimeout(() => d.classList.remove('show'), 5000);
            d.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }

        // Results Functions
        function loadResultsTab() {
            // Populate event select for results
            const sel = document.getElementById('resultsEventSelect');
            sel.innerHTML = '<option value="">-- Select Event --</option>';
            
            if (isSuperAdmin) {
                // Super admin: show ALL events from events object, merged with jurySetup status
                db.ref('jurySetup').once('value').then(snap => {
                    const jurySetupData = snap.exists() ? snap.val() : {};
                    // Show all events from the events const
                    Object.keys(events).forEach(eventName => {
                        const setup = jurySetupData[eventName] || {};
                        const opt = document.createElement('option');
                        opt.value = eventName;
                        let label = eventName;
                        if (setup.resultsPublished) label += ' âœ“ Published';
                        else if (jurySetupData[eventName]) label += ' (Setup done)';
                        else label += ' (Not set up)';
                        opt.textContent = label;
                        sel.appendChild(opt);
                    });
                });
            } else {
                db.ref('jurySetup').once('value').then(snap => {
                    if (!snap.exists()) return;
                    snap.forEach(child => {
                        const event = child.key;
                        const setup = child.val();
                        // For admin, show only published events
                        if (setup.resultsPublished) {
                            const opt = document.createElement('option');
                            opt.value = event;
                            opt.textContent = event + ' âœ“';
                            sel.appendChild(opt);
                        }
                    });
                });
            }
        }

        function loadEventResults() {
            const event = document.getElementById('resultsEventSelect').value;
            console.log('Loading results for event:', event);
            
            if (!event) {
                document.getElementById('resultsContainer').innerHTML = '';
                return;
            }
            
            // Load jury setup to get names and publication status
            db.ref('jurySetup/'+event).once('value').then(setupSnap => {
                const setup = setupSnap.val() || {};
                console.log('Results published status:', setup.resultsPublished);
                
                if (!isSuperAdmin && !setup.resultsPublished) {
                    document.getElementById('resultsContainer').innerHTML = '<p style="text-align:center;padding:40px;color:#999">Results not yet published by super admin.</p>';
                    return;
                }
                
                const jury1Name = setup.jury1Name || 'Jury 1';
                const jury2Name = setup.jury2Name || 'Jury 2';

                // For super admin: if event not set up at all, show info summary
                if (isSuperAdmin && !setupSnap.exists()) {
                    const eventInfo = events[event] || {};
                    document.getElementById('resultsContainer').innerHTML =
                        '<div style="background:#fff3cd;border:2px solid #ffc107;border-radius:10px;padding:20px;margin-top:10px">' +
                        '<h3 style="color:#856404;margin-bottom:10px">âš ï¸ ' + event + ' â€” Jury Not Set Up Yet</h3>' +
                        '<p style="color:#666;margin-bottom:8px">This event has not been configured in Jury Setup yet.</p>' +
                        '<p style="color:#666"><strong>Event size:</strong> ' + (eventInfo.size || 'â€”') + '</p>' +
                        '<p style="color:#666"><strong>Type:</strong> ' + (eventInfo.individual ? 'Individual' : eventInfo.multiTeam ? 'Multi-Team' : 'Class-based') + '</p>' +
                        '<p style="color:#888;margin-top:10px;font-size:0.85em">Go to <strong>Jury Setup</strong> tab to configure this event first.</p>' +
                        '</div>';
                    return;
                }
                
                // Load marks from both juries using raw event name
                console.log('Loading marks from both juries...');
                const fetchList = [
                    db.ref('juryMarks/'+event+'/jury1').once('value'),
                    db.ref('juryMarks/'+event+'/jury2').once('value')
                ];
                // For Vlog: also fetch social scores and enrollment topics
                if (event === 'Vlog') {
                    fetchList.push(db.ref('vlogChallenge').once('value'));
                    fetchList.push(db.ref('youthfest-enrollments').orderByChild('event').equalTo('Vlog').once('value'));
                }
                Promise.all(fetchList).then((snaps) => {
                    const jury1Marks = snaps[0].val() || {};
                    const jury2Marks = snaps[1].val() || {};

                    // Build vlogSocialMap: originalClassName â†’ best socialScore for that class
                    const vlogSocialMap = {};
                    if (event === 'Vlog' && snaps[2] && snaps[3]) {
                        // Build topicâ†’socialScore map from vlogChallenge
                        const topicSocial = {};
                        snaps[2].forEach(ch => {
                            const v = ch.val();
                            const k = (v.classYear||'') + '__' + (v.topic||'');
                            topicSocial[k] = v.socialScore || 0;
                        });
                        // Build classYear+teamNum â†’ topic from enrollments, then map rowKey â†’ socialScore
                        const enrollByClass = {};
                        snaps[3].forEach(ch => {
                            const e = ch.val();
                            if (!enrollByClass[e.classYear]) enrollByClass[e.classYear] = [];
                            enrollByClass[e.classYear].push(e);
                        });
                        // For each class, group into teams and map sanitised rowKey â†’ socialScore
                        Object.entries(enrollByClass).forEach(([cls, members]) => {
                            const safeKey = cls.replace(/[.\[\]#$\/\s]/g,'_');
                            const teamsMap = {};
                            members.forEach((m, idx) => {
                                let tKey;
                                if (m.teamNum !== undefined && m.teamNum !== null) tKey = String(m.teamNum);
                                else if (m.topic) tKey = 'topic__' + m.topic;
                                else tKey = String(Math.floor(idx / 2) + 1);
                                if (!teamsMap[tKey]) teamsMap[tKey] = m;
                            });
                            Object.keys(teamsMap).sort((a,b)=>{
                                const na=Number(a), nb=Number(b);
                                return (isNaN(na)||isNaN(nb)) ? a.localeCompare(b) : na-nb;
                            }).forEach((tKey, tIdx) => {
                                const m = teamsMap[tKey];
                                const rowKey = safeKey + '__t' + (tIdx+1);
                                const vKey = cls + '__' + (m.topic||'');
                                vlogSocialMap[rowKey] = topicSocial[vKey] || 0;
                            });
                        });
                    }

                    console.log('Jury 1 Marks:', jury1Marks);
                    console.log('Jury 2 Marks:', jury2Marks);

                    // Super admin: if no marks yet, show a "no marks yet" summary with event info
                    if (isSuperAdmin && Object.keys(jury1Marks).length === 0 && Object.keys(jury2Marks).length === 0) {
                        const eventInfo = events[event] || {};
                        const pubStatus = setup.resultsPublished ? 'âœ… Published' : 'âŒ Not Published';
                        document.getElementById('resultsContainer').innerHTML =
                            '<div style="background:#e8f5e9;border:2px solid #66bb6a;border-radius:10px;padding:20px;margin-top:10px">' +
                            '<h3 style="color:#2e7d32;margin-bottom:12px">ðŸ“‹ ' + event + ' â€” Event Progress</h3>' +
                            '<table style="width:100%;border-collapse:collapse">' +
                            '<tr><td style="padding:6px 10px;color:#555;font-weight:600">Publication Status:</td><td style="padding:6px 10px">' + pubStatus + '</td></tr>' +
                            '<tr><td style="padding:6px 10px;color:#555;font-weight:600">Jury 1:</td><td style="padding:6px 10px">' + jury1Name + (setup.jury1Password ? ' (Password set âœ“)' : ' (No password)') + '</td></tr>' +
                            '<tr><td style="padding:6px 10px;color:#555;font-weight:600">Jury 2:</td><td style="padding:6px 10px">' + jury2Name + (setup.jury2Password ? ' (Password set âœ“)' : ' (No password)') + '</td></tr>' +
                            '<tr><td style="padding:6px 10px;color:#555;font-weight:600">Event Type:</td><td style="padding:6px 10px">' + (setup.eventType || eventInfo.individual ? 'Individual' : eventInfo.multiTeam ? 'Multi-Team' : 'Class-based') + '</td></tr>' +
                            '</table>' +
                            '<p style="color:#e65100;background:#fff3e0;padding:10px;border-radius:6px;margin-top:12px">â³ No jury marks submitted yet for this event.</p>' +
                            '</div>';
                        return;
                    }

                    displayResults(event, jury1Marks, jury2Marks, jury1Name, jury2Name, vlogSocialMap);
                });
            });
        }

        function displayResults(event, jury1Marks, jury2Marks, jury1Name, jury2Name, vlogSocialMap) {
            // Default names if not provided
            jury1Name = jury1Name || 'Jury 1';
            jury2Name = jury2Name || 'Jury 2';
            vlogSocialMap = vlogSocialMap || {};
            const isVlog = (event === 'Vlog');
            
            console.log('=== DISPLAY RESULTS DEBUG ===');
            console.log('Jury 1 Marks:', jury1Marks);
            console.log('Jury 2 Marks:', jury2Marks);
            
            const allClasses = new Set([...Object.keys(jury1Marks), ...Object.keys(jury2Marks)]);
            
            if (allClasses.size === 0) {
                document.getElementById('resultsContainer').innerHTML = '<p style="text-align:center;padding:40px;color:#999">No marks submitted yet.</p>';
                return;
            }
            
            // Calculate totals and averages
            const results = [];
            allClasses.forEach(sanitizedCls => {
                const j1 = jury1Marks[sanitizedCls];
                const j2 = jury2Marks[sanitizedCls];
                
                console.log('Class:', sanitizedCls);
                console.log('  Jury1 data:', j1);
                console.log('  Jury1 completed?:', j1 && j1.completed);
                console.log('  Jury2 data:', j2);
                console.log('  Jury2 completed?:', j2 && j2.completed);
                
                // Get original class name if available
                const displayCls = (j1 && j1.originalClassName) || 
                                  (j2 && j2.originalClassName) || 
                                  sanitizedCls;
                
                let j1Total = 0;
                let j2Total = 0;
                
                if (j1 && j1.marks) {
                    j1Total = j1.marks.reduce((sum, m) => sum + (m || 0), 0);
                }
                if (j2 && j2.marks) {
                    j2Total = j2.marks.reduce((sum, m) => sum + (m || 0), 0);
                }
                
                const avgTotal = (j1Total + j2Total) / 2;

                // For Vlog: apply Final % = (juryAvg/50 Ã— 50%) + (socialScore/1000 Ã— 50%)
                let finalScore = avgTotal;
                let socialScore = 0;
                let juryPct = null;
                let socialPct = null;
                let finalPct = null;
                if (isVlog) {
                    socialScore = vlogSocialMap[sanitizedCls] || 0;
                    juryPct    = +(avgTotal / 50 * 50).toFixed(2);
                    socialPct  = +Math.min(50, socialScore / 1000 * 50).toFixed(2);
                    finalPct   = +(juryPct + socialPct).toFixed(2);
                    finalScore = finalPct; // use finalPct for ranking
                }
                
                results.push({
                    class: displayCls,
                    jury1Total: j1Total,
                    jury2Total: j2Total,
                    average: avgTotal,
                    socialScore: socialScore,
                    juryPct: juryPct,
                    socialPct: socialPct,
                    finalPct: finalPct,
                    finalScore: finalScore,
                    jury1Completed: j1 && j1.completed,
                    jury2Completed: j2 && j2.completed
                });
            });
            
            // Sort by finalScore (descending) â€” for Vlog this is finalPct, others it's jury avg
            results.sort((a, b) => b.finalScore - a.finalScore);
            
            // Display results
            let html = '<h3 style="color:#c44569;margin-bottom:20px">Results for '+event+'</h3>';

            // For Vlog: show formula reminder
            if (isVlog) {
                html += '<div style="font-size:0.82em;color:#555;background:#e8f5e9;border-radius:8px;padding:10px 14px;margin-bottom:12px;border-left:4px solid #4caf50">';
                html += 'ðŸ“ <strong>Formula:</strong> Final % = (Jury Avg /50 Ã— 50%) + (Social Score /1000 Ã— 50%)';
                html += '</div>';
            }
            
            // Show marks detail only for super admin and jury
            if (isSuperAdmin || isJury) {
                if (isVlog) {
                    html += '<div class="table-wrapper"><table><thead><tr><th>Rank</th><th>Class/Team</th><th>'+jury1Name+' /50</th><th>'+jury2Name+' /50</th><th>Jury Avg</th><th>Jury %</th><th>Social Score</th><th>Social %</th><th>Final %</th><th>Status</th></tr></thead><tbody>';
                    results.forEach((r, i) => {
                        const rank = i + 1;
                        const badge = rank === 1 ? '<span class="winner-badge">ðŸ† Winner</span>' : rank === 2 ? '<span class="runner-badge">ðŸ¥ˆ Runner Up</span>' : '';
                        html += '<tr class="rank-'+(rank <= 3 ? rank : '')+'">';
                        html += '<td><strong>'+rank+'</strong></td>';
                        html += '<td><strong>'+r.class+'</strong> '+badge+'</td>';
                        html += '<td>'+r.jury1Total.toFixed(1)+(r.jury1Completed ? ' âœ“' : '')+'</td>';
                        html += '<td>'+r.jury2Total.toFixed(1)+(r.jury2Completed ? ' âœ“' : '')+'</td>';
                        html += '<td>'+r.average.toFixed(1)+'</td>';
                        html += '<td>'+(r.juryPct !== null ? r.juryPct+'%' : 'â€”')+'</td>';
                        html += '<td style="color:#e91e63;font-weight:700">'+(r.socialScore > 0 ? r.socialScore : 'â€”')+'</td>';
                        html += '<td>'+(r.socialPct > 0 ? r.socialPct+'%' : 'â€”')+'</td>';
                        html += '<td><strong style="color:#1b5e20">'+(r.finalPct !== null ? r.finalPct+'%' : 'â€”')+'</strong></td>';
                        html += '<td>'+(r.jury1Completed && r.jury2Completed ? 'âœ… Complete' : 'â³ In Progress')+'</td>';
                        html += '</tr>';
                    });
                    html += '</tbody></table></div>';
                } else {
                    html += '<div class="table-wrapper"><table><thead><tr><th>Rank</th><th>Class</th><th>'+jury1Name+' Total</th><th>'+jury2Name+' Total</th><th>Average</th><th>Status</th></tr></thead><tbody>';
                    results.forEach((r, i) => {
                        const rank = i + 1;
                        const badge = rank === 1 ? '<span class="winner-badge">ðŸ† Winner</span>' : rank === 2 ? '<span class="runner-badge">ðŸ¥ˆ Runner Up</span>' : '';
                        html += '<tr class="rank-'+(rank <= 3 ? rank : '')+'">';
                        html += '<td><strong>'+rank+'</strong></td>';
                        html += '<td><strong>'+r.class+'</strong> '+badge+'</td>';
                        html += '<td>'+r.jury1Total.toFixed(1)+(r.jury1Completed ? ' âœ“' : '')+'</td>';
                        html += '<td>'+r.jury2Total.toFixed(1)+(r.jury2Completed ? ' âœ“' : '')+'</td>';
                        html += '<td><strong>'+r.average.toFixed(1)+'</strong></td>';
                        html += '<td>'+(r.jury1Completed && r.jury2Completed ? 'âœ… Complete' : 'â³ In Progress')+'</td>';
                        html += '</tr>';
                    });
                    html += '</tbody></table></div>';
                }
            } else {
                // For regular admins, show only final results (no marks)
                results.forEach((r, i) => {
                    const rank = i + 1;
                    html += '<div class="results-card rank-'+rank+'">';
                    html += '<h3 style="color:#c44569;">Rank '+rank+': '+r.class;
                    if (rank === 1) html += ' <span class="winner-badge">ðŸ† Winner</span>';
                    if (rank === 2) html += ' <span class="runner-badge">ðŸ¥ˆ Runner Up</span>';
                    html += '</h3>';
                    const scoreLabel = isVlog && r.finalPct !== null ? r.finalPct+'%' : r.finalScore.toFixed(1);
                    html += '<p style="color:#666;margin-top:10px">Final Score: <strong>'+scoreLabel+'</strong></p>';
                    html += '</div>';
                });
            }
            
            document.getElementById('resultsContainer').innerHTML = html;
        }

        function clearTestData() {
            if (!confirm('Clear test data from Firebase?\n\nThis will ONLY delete:\n- juryMarks/TEST/*\n\nYour actual marks will NOT be affected.')) {
                return;
            }
            
            console.log('=== CLEARING TEST DATA ===');
            
            // Only clear the TEST node - DO NOT touch the actual jury path
            db.ref('juryMarks/TEST').remove()
            .then(() => {
                console.log('âœ“ Test data cleared');
                showJuryMessage('Test data cleared successfully! Your actual marks are safe.', 'success');
                alert('âœ… Test data cleared!\n\nYour actual marks are safe and untouched.');
            }).catch(err => {
                console.error('Error clearing test data:', err);
                showJuryMessage('Error clearing test data: ' + err.message, 'error');
            });
        }

        function debugLoadMarks() {
            console.log('=== DEBUG LOAD MARKS ===');
            console.log('juryEvent:', juryEvent);
            console.log('juryNumber:', juryNumber);
            
            const dbPath = 'juryMarks/' + juryEvent + '/jury' + juryNumber;
            console.log('Database path:', dbPath);
            
            // First check what's in the database
            db.ref(dbPath).once('value').then(snap => {
                const data = snap.val();
                console.log('Raw database data:', data);
                console.log('Data as JSON:', JSON.stringify(data, null, 2));
                
                // Check all inputs on the page
                const inputs = document.querySelectorAll('.marks-input');
                console.log('Total inputs on page:', inputs.length);
                
                const inputDetails = [];
                inputs.forEach((inp, idx) => {
                    inputDetails.push({
                        index: idx,
                        class: inp.dataset.class,
                        criterion: inp.dataset.criterion,
                        value: inp.value
                    });
                });
                console.table(inputDetails);
                
                // Show a detailed report
                let report = '=== DEBUG REPORT ===\n\n';
                report += 'Database Path: ' + dbPath + '\n\n';
                report += 'Database Content:\n' + JSON.stringify(data, null, 2) + '\n\n';
                report += 'Total Inputs Found: ' + inputs.length + '\n\n';
                report += 'Input Details:\n';
                inputDetails.forEach(inp => {
                    report += `  [${inp.index}] Class: "${inp.class}", Criterion: ${inp.criterion}, Value: ${inp.value}\n`;
                });
                
                console.log(report);
                alert(report);
                
            }).catch(err => {
                console.error('Debug load error:', err);
                alert('Debug load failed: ' + err.message);
            });
        }

        // ============================================================
        // CLASS ALIAS SYSTEM â€” assigns code names to real class names
        // ============================================================
        // Maps events that store registrations in a separate Firebase path (not youthfest-enrollments)
        const EVENT_SEPARATE_PATHS = {
            // YouTube Advertisement uses youthfest-enrollments (8-member class teams enrolled there)
            // NOT youtubeAd (which stores only YT link submissions, not individual member enrollments)
            'Pod Casting': 'podcastChallenge'
        };

        async function loadClassAliasFields() {
            const event = document.getElementById('setupEventSelect').value;
            if (!event) { alert('Please select an event first.'); return; }
            const container = document.getElementById('classAliasContainer');
            container.innerHTML = '<p style="color:#aaa;font-size:13px">â³ Loading participants...</p>';

            try {
                const cfg = events[event] || {};
                const isIndividual = !!cfg.individual;
                const isMultiTeam  = !!cfg.multiTeam;

                // -- Load existing jurySetup --------------------------------------
                const setupSnap = await db.ref('jurySetup/' + event).once('value');
                const existingSetup = setupSnap.val() || {};
                const existing      = existingSetup.classAliases || {};
                const existingOrder = existingSetup.classOrder   || [];

                // -- INDIVIDUAL events (HW, TH, Pod Casting, Ramp Walkâ€¦) ----------
                // Each participant is scored independently â€” show each entry with their code
                if (isIndividual) {
                    let entries = [];

                    if (event === 'Pod Casting') {
                        // Podcast: read from podcastChallenge, approved only
                        const snap = await db.ref('podcastChallenge').once('value');
                        if (snap.exists()) {
                            snap.forEach(ch => {
                                const d = ch.val();
                                if (d.approvalStatus !== 'approved') return;
                                entries.push({ id: ch.key, classYear: d.classYear || d.class || 'â€”', name: d.memberName || 'â€”', detail: d.episodeTitle ? '"' + d.episodeTitle + '"' : (d.topic || '') });
                            });
                        }
                    } else {
                        // HW / TH / Ramp Walk etc: ensure sitting codes then read youthfest-enrollments
                        await ensureSittingCodes(event, event.toLowerCase().replace(/\s/g,''));
                        const snap = await db.ref('youthfest-enrollments').once('value');
                        const isHWEvent = event === 'Hand Writing';
                        const isTHEvent = event === 'Talent Hunt';
                        const prefix = isHWEvent ? 'HW' : isTHEvent ? 'TH' : event.substring(0,2).toUpperCase();
                        if (snap.exists()) {
                            snap.forEach(ch => {
                                const d = ch.val();
                                if (d.event !== event) return;
                                const cls = d.classYear || d.class || 'â€”';
                                const code = d.sittingCode ? (prefix + '-' + d.sittingCode) : generateSittingCode(ch.key, prefix);
                                const detail = d.talentType || d.languages || d.topic || '';
                                entries.push({ id: ch.key, classYear: cls, name: d.name || d.studentName || d.participantName || 'â€”', code, detail });
                            });
                        }
                        // Sort by sitting code
                        entries.sort((a,b) => (a.code||'').localeCompare(b.code||''));
                    }

                    if (entries.length === 0) {
                        container.innerHTML = '<p style="color:#e53935;font-size:13px">âš ï¸ No enrolled participants found for <strong>' + event + '</strong>.' + (event === 'Pod Casting' ? ' Make sure Chandan has approved at least one podcast submission.' : '') + '</p>';
                        return;
                    }

                    // For individual events: show a READ-ONLY info table (sitting codes are auto-assigned, not manually editable)
                    // The classAliases saved will be the sitting code â†’ sitting code mapping (identity) for jury sheet lookup
                    const autoAliases = {};
                    let infoHTML = '<div style="background:#e3f2fd;border-left:4px solid #1565c0;padding:10px 14px;border-radius:8px;margin-bottom:12px;font-size:13px;color:#1a237e">';
                    if (event === 'Pod Casting') {
                        infoHTML += '<strong>ðŸŽ™ï¸ Individual Event</strong> â€” Each participant is scored separately by the jury. Sitting codes are their names (anonymous to jury).';
                    } else {
                        infoHTML += '<strong>ðŸ§‘ Individual Event (Sitting Codes)</strong> â€” Each participant has a unique sitting code. The jury sees ONLY the code â€” real names are hidden until marks are completed.';
                    }
                    infoHTML += ' <em>(' + entries.length + ' participants enrolled)</em></div>';

                    infoHTML += '<div style="max-height:320px;overflow-y:auto"><table style="width:100%;border-collapse:collapse" id="aliasTable"><thead><tr style="background:linear-gradient(135deg,#1a237e,#1565c0);color:white;position:sticky;top:0">';
                    infoHTML += '<th style="padding:8px 10px;text-align:left">#</th>';
                    infoHTML += '<th style="padding:8px 10px;text-align:left">Sitting Code</th>';
                    infoHTML += '<th style="padding:8px 10px;text-align:left">Class</th>';
                    infoHTML += '<th style="padding:8px 10px;text-align:left">Name (hidden from jury)</th>';
                    infoHTML += '<th style="padding:8px 10px;text-align:left">Detail</th>';
                    infoHTML += '</tr></thead><tbody id="aliasTableBody">';

                    entries.forEach((e, i) => {
                        const safeKey = (e.classYear || '').replace(/[.\[\]#$\/\s]/g,'_') + '__p' + (i+1);
                        autoAliases[safeKey] = e.code || ('P' + (i+1));
                        const bg = i%2===0 ? '#f8fbff' : '#fff';
                        infoHTML += '<tr style="background:' + bg + ';border-bottom:1px solid #dce8ff">';
                        infoHTML += '<td style="padding:7px 10px;color:#666;font-size:13px">' + (i+1) + '</td>';
                        if (event === 'Pod Casting') {
                            infoHTML += '<td style="padding:7px 10px"><span style="background:#880e4f;color:white;font-weight:800;padding:3px 10px;border-radius:6px;font-size:0.85em">' + (e.name || 'â€”') + '</span></td>';
                        } else {
                            infoHTML += '<td style="padding:7px 10px"><span style="background:#1a237e;color:white;font-weight:900;padding:3px 10px;border-radius:6px;font-size:0.88em;letter-spacing:2px">' + (e.code||'â€”') + '</span></td>';
                        }
                        infoHTML += '<td style="padding:7px 10px;font-size:13px;color:#555">' + e.classYear + '</td>';
                        infoHTML += '<td style="padding:7px 10px;font-size:13px;font-weight:600;color:#333">' + e.name + '</td>';
                        infoHTML += '<td style="padding:7px 10px;font-size:12px;color:#777">' + (e.detail||'â€”') + '</td>';
                        infoHTML += '</tr>';
                    });

                    infoHTML += '</tbody></table></div>';
                    container.innerHTML = infoHTML;
                    // Store auto-aliases so saveEventSetup can pick them up
                    container.dataset.autoAliases = JSON.stringify(autoAliases);
                    container.dataset.classes = JSON.stringify([...new Set(entries.map(e=>e.classYear))]);
                    return;
                }

                // -- MULTI-TEAM events (Vlog: 2 members/team, BOW: 1-2 members/team) --
                if (isMultiTeam) {
                    let rawEntries = [];
                    const snap = await db.ref('youthfest-enrollments').once('value');
                    if (snap.exists()) {
                        snap.forEach(ch => {
                            const d = ch.val();
                            if (d.event !== event) return;
                            rawEntries.push({ id: ch.key, classYear: d.classYear || d.class || 'â€”', name: d.name || d.studentName || 'â€”', teamNum: d.teamNum, role: d.role || '' });
                        });
                    }

                    if (rawEntries.length === 0) {
                        container.innerHTML = '<p style="color:#e53935;font-size:13px">âš ï¸ No enrolled teams found for <strong>' + event + '</strong>.</p>';
                        return;
                    }

                    // Group by class â†’ then by teamNum
                    const byClass = {};
                    rawEntries.forEach(e => {
                        const cls = e.classYear;
                        if (!byClass[cls]) byClass[cls] = {};
                        const tKey = e.teamNum != null ? String(e.teamNum) : 'solo_' + e.id;
                        if (!byClass[cls][tKey]) byClass[cls][tKey] = [];
                        byClass[cls][tKey].push(e);
                    });

                    // Build ordered class list
                    const classes = Object.keys(byClass).sort();
                    let orderedClasses = classes.slice();
                    if (existingOrder.length > 0) {
                        const ordered = existingOrder.filter(c => classes.includes(c));
                        const remaining = classes.filter(c => !ordered.includes(c));
                        orderedClasses = ordered.concat(remaining);
                    }

                    const autoAliases = {};
                    let totalTeams = 0;
                    orderedClasses.forEach(cls => { totalTeams += Object.keys(byClass[cls]).length; });

                    let infoHTML = '<div style="background:#fff3e0;border-left:4px solid #e65100;padding:10px 14px;border-radius:8px;margin-bottom:12px;font-size:13px;color:#bf360c">';
                    infoHTML += '<strong>ðŸ‘¥ Multi-Team Event</strong> â€” Each team is scored separately. Jury sees team labels (e.g. "3rd B.Com â€” Team 1"). ';
                    infoHTML += '<em>(' + orderedClasses.length + ' classes, ' + totalTeams + ' teams total)</em></div>';

                    infoHTML += '<div style="max-height:350px;overflow-y:auto"><table style="width:100%;border-collapse:collapse" id="aliasTable"><thead><tr style="background:linear-gradient(135deg,#4a148c,#e65100);color:white;position:sticky;top:0">';
                    infoHTML += '<th style="padding:8px 10px;text-align:left">#</th>';
                    infoHTML += '<th style="padding:8px 10px;text-align:left">Class</th>';
                    infoHTML += '<th style="padding:8px 10px;text-align:left">Team</th>';
                    infoHTML += '<th style="padding:8px 10px;text-align:left">Members</th>';
                    infoHTML += '<th style="padding:8px 10px;text-align:left">Class Code Name (editable)</th>';
                    infoHTML += '</tr></thead><tbody id="aliasTableBody">';

                    let rowNum = 0;
                    orderedClasses.forEach((cls, clsIdx) => {
                        const safeKey = cls.replace(/[.\[\]#$\/\s]/g,'_');
                        const savedAlias = existing[safeKey] || ('Class ' + String.fromCharCode(65 + clsIdx));
                        autoAliases[safeKey] = savedAlias;
                        const teams = byClass[cls];
                        const teamKeys = Object.keys(teams).sort((a,b)=>Number(a)-Number(b));
                        teamKeys.forEach((tKey, tIdx) => {
                            const members = teams[tKey];
                            const memberNames = members.map(m=>m.name).join(', ');
                            const bg = rowNum%2===0 ? '#fdf8ff' : '#fff';
                            infoHTML += '<tr style="background:' + bg + ';border-bottom:1px solid #e8d5ff">';
                            infoHTML += '<td style="padding:7px 10px;color:#666;font-size:13px">' + (++rowNum) + '</td>';
                            infoHTML += '<td style="padding:7px 10px;font-size:13px;font-weight:600;color:#333">' + cls + '</td>';
                            infoHTML += '<td style="padding:7px 10px"><span style="background:#4a148c;color:white;font-weight:800;padding:3px 10px;border-radius:6px;font-size:0.83em">Team ' + (tIdx+1) + '</span></td>';
                            infoHTML += '<td style="padding:7px 10px;font-size:12px;color:#555">' + memberNames + '</td>';
                            if (tIdx === 0) {
                                // Only show alias input on first team row for this class; spans all teams
                                infoHTML += '<td style="padding:7px 10px"><input type="text" data-safekey="' + safeKey + '" value="' + savedAlias + '" style="padding:5px 10px;border:1.5px solid #9c27b0;border-radius:6px;width:140px;font-size:13px" placeholder="Class A"></td>';
                            } else {
                                infoHTML += '<td style="padding:7px 10px;font-size:12px;color:#aaa;font-style:italic">â†‘ same class</td>';
                            }
                            infoHTML += '</tr>';
                        });
                    });

                    infoHTML += '</tbody></table></div>';
                    container.innerHTML = infoHTML;
                    container.dataset.autoAliases = JSON.stringify(autoAliases);
                    container.dataset.classes = JSON.stringify(orderedClasses);
                    return;
                }

                // -- CLASS-BASED events (default) ---------------------------------
                // One alias per class. Load classes from correct path.
                const classes = [];
                const separatePath = EVENT_SEPARATE_PATHS[event];
                if (separatePath) {
                    const snap = await db.ref(separatePath).once('value');
                    if (snap.exists()) snap.forEach(ch => {
                        const e = ch.val();
                        if (e.classYear && !classes.includes(e.classYear)) classes.push(e.classYear);
                    });
                } else {
                    const snap = await db.ref('youthfest-enrollments').once('value');
                    if (snap.exists()) snap.forEach(ch => {
                        const e = ch.val();
                        if (e.event === event && (e.classYear||e.class) && !classes.includes(e.classYear||e.class)) classes.push(e.classYear||e.class);
                    });
                }

                if (classes.length === 0) {
                    container.innerHTML = '<p style="color:#e53935;font-size:13px">âš ï¸ No enrolled classes found for <strong>' + event + '</strong>.</p>';
                    return;
                }

                let orderedClasses = classes.slice();
                if (existingOrder.length > 0) {
                    const ordered = existingOrder.filter(c => classes.includes(c));
                    const remaining = classes.filter(c => !ordered.includes(c));
                    orderedClasses = ordered.concat(remaining);
                }

                function buildRow(cls, safeKey, alias, i, total) {
                    return '<tr data-cls="' + cls + '" style="background:' + (i%2===0?'#fff':'#f9f0ff') + ';border-bottom:1px solid #e8d5ff">'
                        + '<td style="padding:8px 6px;cursor:grab;text-align:center;color:#9c27b0;font-size:16px" title="Drag to reorder">&#9776;</td>'
                        + '<td style="padding:8px 10px;color:#6c757d;font-weight:700;font-size:13px">' + (i+1) + '</td>'
                        + '<td style="padding:8px 10px;font-size:13px;font-weight:600;color:#333">' + cls + '</td>'
                        + '<td style="padding:8px 10px"><input type="text" data-safekey="' + safeKey + '" value="' + alias + '" style="padding:5px 10px;border:1.5px solid #9c27b0;border-radius:6px;width:160px;font-size:13px" placeholder="e.g. Class A"></td>'
                        + '<td style="padding:8px 6px;text-align:center">'
                        +   (i > 0 ? '<button onclick="moveClassRow(this,-1)" style="background:#e3d5f7;border:none;border-radius:4px;padding:2px 7px;cursor:pointer;margin-right:2px">&#9650;</button>' : '')
                        +   (i < total-1 ? '<button onclick="moveClassRow(this,1)" style="background:#e3d5f7;border:none;border-radius:4px;padding:2px 7px;cursor:pointer">&#9660;</button>' : '')
                        + '</td></tr>';
                }

                let tableHTML = '<table style="width:100%;border-collapse:collapse" id="aliasTable">'
                    + '<thead><tr style="background:linear-gradient(135deg,#6a1b9a,#c44569);color:white">'
                    + '<th style="padding:8px 6px;width:30px"></th>'
                    + '<th style="padding:8px 10px;width:40px;text-align:left">#</th>'
                    + '<th style="padding:8px 10px;text-align:left">Real Class Name</th>'
                    + '<th style="padding:8px 10px;text-align:left">Code Name shown to Jury</th>'
                    + '<th style="padding:8px 6px;width:70px">Order</th>'
                    + '</tr></thead><tbody id="aliasTableBody"></tbody></table>';

                container.innerHTML = tableHTML;
                container.dataset.classes = JSON.stringify(orderedClasses);
                const tbody = container.querySelector('#aliasTableBody');
                orderedClasses.forEach((cls, i) => {
                    const safeKey = cls.replace(/[.\[\]#$\/\s]/g, '_');
                    const alias = existing[safeKey] || ('Class ' + String.fromCharCode(65 + i));
                    tbody.innerHTML += buildRow(cls, safeKey, alias, i, orderedClasses.length);
                });
                attachDragEvents();

            } catch(e) {
                container.innerHTML = '<p style="color:red;font-size:13px">âŒ Error: ' + e.message + '</p>';
            }
        }

        function moveClassRow(btn, dir) {
            const row = btn.closest('tr');
            const tbody = row.parentNode;
            const rows = Array.from(tbody.querySelectorAll('tr[data-cls]'));
            const idx = rows.indexOf(row);
            const newIdx = idx + dir;
            if (newIdx < 0 || newIdx >= rows.length) return;
            if (dir === -1) tbody.insertBefore(row, rows[newIdx]);
            else tbody.insertBefore(rows[newIdx], row);
            // Renumber
            Array.from(tbody.querySelectorAll('tr[data-cls]')).forEach((r, i) => {
                const numCell = r.cells[1];
                if (numCell) numCell.textContent = i + 1;
                r.style.background = i%2===0?'#fff':'#f9f0ff';
            });
        }

        function attachDragEvents() {
            const tbody = document.getElementById('aliasTableBody');
            if (!tbody) return;
            let dragSrc = null;
            tbody.querySelectorAll('tr[data-cls]').forEach(row => {
                row.draggable = true;
                row.addEventListener('dragstart', function() { dragSrc = this; this.style.opacity='0.5'; });
                row.addEventListener('dragend', function() { this.style.opacity='1'; });
                row.addEventListener('dragover', function(e) { e.preventDefault(); });
                row.addEventListener('drop', function(e) {
                    e.preventDefault();
                    if (dragSrc && dragSrc !== this) {
                        const rows = Array.from(tbody.querySelectorAll('tr[data-cls]'));
                        const srcIdx = rows.indexOf(dragSrc);
                        const tgtIdx = rows.indexOf(this);
                        if (srcIdx < tgtIdx) tbody.insertBefore(dragSrc, this.nextSibling);
                        else tbody.insertBefore(dragSrc, this);
                        rows.forEach((r, i) => {
                            r.cells[1].textContent = i + 1;
                            r.style.background = i%2===0?'#fff':'#f9f0ff';
                        });
                    }
                });
            });
        }

        function getClassAliasesFromFields() {
            const container = document.getElementById('classAliasContainer');
            // For individual/multi-team events: aliases are stored in dataset.autoAliases
            // plus any editable inputs in the table
            const autoAliases = container && container.dataset.autoAliases
                ? JSON.parse(container.dataset.autoAliases) : {};

            const tbody = document.getElementById('aliasTableBody');
            const manualAliases = {};
            if (tbody) {
                tbody.querySelectorAll('input[data-safekey]').forEach(inp => {
                    manualAliases[inp.dataset.safekey] = inp.value.trim() || inp.dataset.safekey;
                });
            }
            // Manual inputs (editable) override auto-aliases
            return Object.assign({}, autoAliases, manualAliases);
        }

        function getClassOrderFromFields() {
            const container = document.getElementById('classAliasContainer');
            // For individual/multi-team events, use stored classes list
            if (container && container.dataset.classes) {
                try { return JSON.parse(container.dataset.classes); } catch(e) {}
            }
            const tbody = document.getElementById('aliasTableBody');
            if (!tbody) return [];
            return Array.from(tbody.querySelectorAll('tr[data-cls]')).map(r => r.dataset.cls);
        }

        // ============================================================
        // MODIFIED: saveEventSetup â€” also saves classAliases
        // ============================================================
        const _origSaveEventSetup = window.saveEventSetup;

        // ============================================================
        // RENDER JURY SHEET WITH ALIASES (replace class names with code names)
        // ============================================================
        async function getAliasMap(event) {
            try {
                const snap = await db.ref('jurySetup/' + event + '/classAliases').once('value');
                return snap.val() || {};
            } catch(e) { return {}; }
        }

        function realToAlias(cls, aliasMap) {
            const safeKey = cls.replace(/[.\[\]#$\/\s]/g, '_');
            return aliasMap[safeKey] || cls;
        }
        function aliasToReal(alias, aliasMap) {
            for (const [key, val] of Object.entries(aliasMap)) {
                if (val === alias) return key; // safeKey
            }
            return alias;
        }
        // Build reverse map: safeKey â†’ real class name from enrollment
        window._juryAliasMap = {};
        window._juryRealClasses = {}; // safeKey â†’ real class name

        // ============================================================
        // LIVE JURY MONITOR (Super Admin)
        // ============================================================
        let _liveMonitorListeners = [];

        async function startLiveJuryMonitor() {
            // -- Stop old Firebase listeners --------------------------------------
            _liveMonitorListeners.forEach(off => off());
            _liveMonitorListeners = [];

            // -- Populate event dropdown from jurySetup if empty ------------------
            const sel = document.getElementById('liveMonitorEvent');
            if (sel && sel.options.length <= 1) {
                const s = await db.ref('jurySetup').once('value');
                if (s.exists()) s.forEach(child => {
                    const o = document.createElement('option');
                    o.value = child.key; o.textContent = child.key;
                    sel.appendChild(o);
                });
            }

            const event = sel ? sel.value : '';
            const container = document.getElementById('liveJuryMonitorContainer');
            if (!event) {
                container.innerHTML = '<p style="color:#999;text-align:center;padding:30px">Select an event above.</p>';
                return;
            }

            container.innerHTML = '<p style="color:#aaa;text-align:center;padding:20px">â³ Loading live monitorâ€¦</p>';

            try {
                // -- Load setup + all enrollments in parallel ---------------------
                const [setupSnap, enrollSnap] = await Promise.all([
                    db.ref('jurySetup/' + event).once('value'),
                    db.ref('youthfest-enrollments').once('value')
                ]);

                const setup = setupSnap.val();
                if (!setup || !setup.criteria) {
                    container.innerHTML = '<p style="color:#999;text-align:center;padding:20px">No jury setup found for this event.</p>';
                    return;
                }

                const aliasMap  = setup.classAliases || {};
                const criteria  = setup.criteria;
                const j1Name    = setup.jury1Name || 'Jury 1';
                const j2Name    = setup.jury2Name || 'Jury 2';

                // -- Determine event type â€” config always wins ---------------------
                const liveCfg  = (events && event) ? (events[event] || {}) : {};
                let eventType  = setup.eventType || 'class';
                if (liveCfg.multiTeam)  eventType = 'multiteam';
                if (liveCfg.individual) eventType = 'individual';

                // -- Build ordered enrolled-classes list (preserving jury sheet order) --
                const orderedClasses = [];
                if (enrollSnap.exists()) {
                    enrollSnap.forEach(ch => {
                        const e = ch.val();
                        if (e.event === event && e.classYear && !orderedClasses.includes(e.classYear))
                            orderedClasses.push(e.classYear);
                    });
                }

                // -- Build full enrollment objects per class -----------------------
                const allEventEnrollments = [];
                if (enrollSnap.exists()) {
                    enrollSnap.forEach(ch => {
                        const e = ch.val(); e._key = ch.key;
                        if (e.event === event) allEventEnrollments.push(e);
                    });
                }

                // -- Helper: safeKey ----------------------------------------------
                function sk(cls) { return cls.replace(/[.\[\]#$\/\s]/g, '_'); }

                // -- Helper: get alias (never expose real class name to jury) -----
                function getMonAlias(cls) {
                    const k = sk(cls);
                    return aliasMap[k] || ('Code-' + (orderedClasses.indexOf(cls) + 1));
                }

                // -- Helper: sum marks array --------------------------------------
                function sumMarks(arr) {
                    if (!arr || !arr.length) return 0;
                    return arr.reduce((s, v) => s + (parseFloat(v) || 0), 0);
                }

                // -- Helper: render one criterion cell (J1 + J2 stacked) ----------
                function critCell(eventName, rowKey, juryNum, markVal, color, borderColor) {
                    const val = markVal !== undefined && markVal !== null && markVal !== '' ? markVal : '';
                    return '<div style="font-size:11px;color:' + color + ';margin-bottom:2px">'
                        + 'J' + juryNum + ': <input type="number" value="' + val + '" min="0" max="10" step="0.5"'
                        + ' onchange="adminEditMark(\'' + eventName + '\',' + juryNum + ',\'' + rowKey + '\',' + '%%IDX%%' + ',this.value)"'
                        + ' style="width:45px;padding:2px 4px;border:1.5px solid ' + borderColor + ';border-radius:4px;font-size:11px;text-align:center">'
                        + '</div>';
                }

                // -- Master render function â€” called on every live update ----------
                function renderMonitor(j1data, j2data, extraData) {
                    j1data = j1data || {};
                    j2data = j2data || {};

                    // -- Super-admin identity column helper ------------------------
                    // Builds the amber "ðŸ”“ Real Identity" cell shown only in super-admin view.
                    // Shows real class name, the jury code it maps to, and enrolled names/roles.
                    function saIdentityCell(cls, alias, members, extraLine) {
                        const nameList = members.map(function(m) {
                            const role = m.role ? ' <span style="color:#888;font-size:10px">(' + m.role + ')</span>' : '';
                            return '<span style="display:block;font-size:11px;color:#333">' + (m.name || 'â€”') + role + '</span>';
                        }).join('');
                        return '<td style="padding:6px 8px;border-left:3px solid #f9a825;background:#fffde7;min-width:160px">'
                            + '<div style="font-size:11px;font-weight:700;color:#e65100;white-space:nowrap">' + cls + '</div>'
                            + '<div style="font-size:10px;color:#6a1b9a;margin-bottom:3px">Code: <strong>' + alias + '</strong></div>'
                            + (extraLine ? '<div style="font-size:10px;color:#555;margin-bottom:3px">' + extraLine + '</div>' : '')
                            + nameList
                            + '</td>';
                    }

                    // -- Legend bar ------------------------------------------------
                    let html = '<div style="margin-bottom:10px;padding:8px 12px;background:#fff8e1;border:1.5px solid #f9a825;border-radius:8px;font-size:12px;color:#5d4037">'
                        + 'ðŸ”“ <strong>Super-Admin View</strong> â€” The amber column shows real class names + enrolled participants. Jury only sees the anonymised code column.'
                        + '</div>'
                        + '<div style="margin-bottom:14px;display:flex;gap:10px;align-items:center;flex-wrap:wrap;padding:10px 14px;background:#f8f9fa;border-radius:10px;border:1px solid #e0e0e0">'
                        + '<span style="background:#e3f2fd;color:#1565c0;padding:4px 14px;border-radius:20px;font-size:13px;font-weight:600">ðŸ”µ ' + j1Name + '</span>'
                        + '<span style="background:#fce4ec;color:#880e4f;padding:4px 14px;border-radius:20px;font-size:13px;font-weight:600">ðŸ”´ ' + j2Name + '</span>'
                        + '<span style="background:#e8f5e9;color:#2e7d32;padding:4px 14px;border-radius:20px;font-size:12px">ðŸŸ¢ Live â€” updates on every jury save</span>'
                        + '<span style="margin-left:auto;font-size:11px;color:#aaa">Last refreshed: ' + new Date().toLocaleTimeString() + '</span>'
                        + '</div>';

                    // Shared th for the SA identity column
                    const saHeader = '<th style="padding:9px 8px;text-align:left;background:#f9a825;color:#212121;white-space:nowrap">ðŸ”“ Real Class &amp; Enrolled</th>';

                    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                    // INDIVIDUAL EVENT (Hand Writing, Talent Hunt, Pod Casting, Ramp Walk)
                    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                    if (eventType === 'individual') {
                        const isHW  = event === 'Hand Writing';
                        const isTH  = event === 'Talent Hunt';
                        const isPod = event === 'Pod Casting';
                        const usesSittingCode = isHW || isTH;
                        const sittingPrefix   = isHW ? 'HW' : isTH ? 'TH' : '';
                        const colHeader       = isPod ? 'Participant Code' : usesSittingCode ? 'Sitting Code' : 'Code';

                        html += '<div style="background:#e3f2fd;border-left:5px solid #1565c0;padding:8px 14px;border-radius:8px;margin-bottom:12px;font-size:12px;color:#1a237e">'
                            + '<strong>ðŸ§‘ Individual Event â€” Live Monitor</strong> Â· Each participant row scored separately Â· '
                            + (usesSittingCode ? 'Sitting codes shown to jury' : 'Code names shown to jury')
                            + '</div>';

                        html += '<div style="overflow-x:auto"><table style="width:100%;border-collapse:collapse;font-size:12.5px">'
                            + '<thead><tr style="background:linear-gradient(135deg,#1a237e,#1565c0);color:white">'
                            + '<th style="padding:9px 6px;text-align:center">#</th>'
                            + saHeader
                            + '<th style="padding:9px 8px;text-align:left">' + colHeader + '</th>';
                        if (isPod) {
                            html += '<th style="padding:9px 8px;text-align:left">Episode</th>'
                                  + '<th style="padding:9px 8px;text-align:center">ðŸŽ™ï¸ Listen</th>';
                        } else {
                            html += '<th style="padding:9px 8px;text-align:left">Details</th>';
                        }
                        criteria.forEach(c => {
                            html += '<th style="padding:9px 6px;text-align:center">' + c + '<br><small style="font-weight:400;opacity:.8">(0â€“10)</small></th>';
                        });
                        html += '<th style="padding:9px 6px;text-align:center;background:rgba(255,255,255,.12)">J1 Total</th>'
                             + '<th style="padding:9px 6px;text-align:center;background:rgba(255,255,255,.12)">J2 Total</th>'
                             + '<th style="padding:9px 6px;text-align:center;background:rgba(255,215,0,.25)">â­ Combined</th>'
                             + '</tr></thead><tbody>';

                        let seq = 1;
                        orderedClasses.forEach(cls => {
                            const clsKey    = sk(cls);
                            const alias     = getMonAlias(cls);
                            const students  = allEventEnrollments.filter(e => (e.classYear || e.class) === cls);

                            students.forEach((enr, idx) => {
                                const rowKey  = clsKey + '__p' + (idx + 1);
                                const j1row   = j1data[rowKey] || {};
                                const j2row   = j2data[rowKey] || {};
                                const j1marks = j1row.marks || [];
                                const j2marks = j2row.marks || [];
                                const j1tot   = sumMarks(j1marks);
                                const j2tot   = sumMarks(j2marks);
                                const combined = j1tot + j2tot;
                                const bg = seq % 2 === 0 ? '#f0f4ff' : '#fff';

                                // Build code cell (what jury sees)
                                let codeCell;
                                if (usesSittingCode) {
                                    const scCode = enr.sittingCode
                                        ? (sittingPrefix + '-' + enr.sittingCode)
                                        : (sittingPrefix + '-' + generateSittingCode(enr._key || enr.id, sittingPrefix));
                                    codeCell = '<span style="background:' + (isHW ? '#1a237e' : '#e65100') + ';color:white;font-weight:900;padding:4px 10px;border-radius:8px;font-size:0.9em;letter-spacing:2px">' + scCode + '</span>';
                                } else if (isPod) {
                                    codeCell = '<span style="background:#880e4f;color:white;font-weight:800;padding:4px 10px;border-radius:8px;font-size:0.85em">' + alias + ' â€” P' + (idx+1) + '</span>';
                                } else {
                                    codeCell = '<strong style="color:#4a148c">' + alias + ' â€” P' + (idx+1) + '</strong>';
                                }

                                // Extra info line for SA column
                                const extraLine = enr.talentType ? 'Talent: ' + enr.talentType
                                    : enr.languages ? 'Lang: ' + enr.languages
                                    : enr.topic ? 'Topic: ' + enr.topic : '';

                                html += '<tr style="background:' + bg + ';border-bottom:1px solid #e8eaf6">';
                                html += '<td style="padding:7px 6px;text-align:center;color:#888;font-size:11px">' + seq + '</td>';
                                // -- Super-admin identity cell ----------------------
                                html += saIdentityCell(cls, alias + ' â€” P' + (idx+1), [enr], extraLine);
                                // -- Jury code cell ---------------------------------
                                html += '<td style="padding:7px 8px">' + codeCell + '</td>';

                                if (isPod) {
                                    const epTitle = enr.episodeTitle ? '<strong>' + enr.episodeTitle + '</strong>' : 'â€”';
                                    const epTopic = enr.topic ? '<br><small style="color:#888">' + enr.topic + '</small>' : '';
                                    html += '<td style="padding:7px 8px"><small>' + epTitle + epTopic + '</small></td>';
                                    const spotLink = enr.link
                                        ? '<a href="' + enr.link + '" target="_blank" style="background:#1db954;color:white;padding:3px 8px;border-radius:5px;text-decoration:none;font-size:11px;font-weight:700">â–¶ Spotify</a>'
                                        : '<span style="color:#aaa;font-size:11px">No link</span>';
                                    html += '<td style="padding:7px 8px;text-align:center">' + spotLink + '</td>';
                                } else {
                                    const det = (function(e){
                                        const d=[];
                                        if(e.topic) d.push('Topic: '+e.topic);
                                        if(e.talentType) d.push('Talent: '+e.talentType);
                                        if(e.languages) d.push('Lang: '+e.languages);
                                        if(e.showstopper) d.push('Showstopper: '+e.showstopper);
                                        if(e.cameraName) d.push('ðŸ“¹ '+e.cameraName);
                                        return d.length ? d.join(' Â· ') : 'â€”';
                                    })(enr);
                                    html += '<td style="padding:7px 8px"><small style="color:#555">' + det + '</small></td>';
                                }

                                criteria.forEach((c, i) => {
                                    const v1 = j1marks[i] !== undefined ? j1marks[i] : '';
                                    const v2 = j2marks[i] !== undefined ? j2marks[i] : '';
                                    html += '<td style="padding:5px 4px;text-align:center;vertical-align:middle">'
                                        + '<div style="font-size:11px;color:#1565c0;margin-bottom:2px">J1: <input type="number" value="' + v1 + '" min="0" max="10" step="0.5"'
                                        + ' onchange="adminEditMark(\'' + event + '\',1,\'' + rowKey + '\',' + i + ',this.value)"'
                                        + ' style="width:44px;padding:2px 3px;border:1.5px solid #90caf9;border-radius:4px;font-size:11px;text-align:center"></div>'
                                        + '<div style="font-size:11px;color:#880e4f">J2: <input type="number" value="' + v2 + '" min="0" max="10" step="0.5"'
                                        + ' onchange="adminEditMark(\'' + event + '\',2,\'' + rowKey + '\',' + i + ',this.value)"'
                                        + ' style="width:44px;padding:2px 3px;border:1.5px solid #f48fb1;border-radius:4px;font-size:11px;text-align:center"></div>'
                                        + '</td>';
                                });

                                const hasJ1 = j1marks.length > 0;
                                const hasJ2 = j2marks.length > 0;
                                html += '<td style="padding:7px 6px;text-align:center;font-weight:700;color:' + (hasJ1 ? '#1565c0' : '#bbb') + '">' + (hasJ1 ? j1tot.toFixed(1) : 'â€”') + '</td>';
                                html += '<td style="padding:7px 6px;text-align:center;font-weight:700;color:' + (hasJ2 ? '#880e4f' : '#bbb') + '">' + (hasJ2 ? j2tot.toFixed(1) : 'â€”') + '</td>';
                                html += '<td style="padding:7px 6px;text-align:center;font-weight:800;font-size:1.05em;color:' + (hasJ1||hasJ2 ? '#4a148c' : '#ccc') + ';background:rgba(255,215,0,0.13)">'
                                    + (hasJ1 || hasJ2 ? combined.toFixed(1) : 'â€”') + '</td>';
                                html += '</tr>';
                                seq++;
                            });
                        });

                        html += '</tbody></table></div>';

                    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                    // MULTI-TEAM EVENT (Vlog, Best out of Waste)
                    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                    } else if (eventType === 'multiteam') {
                        const isVlog = event === 'Vlog';
                        const isBOW  = event === 'Best out of Waste';
                        const membersPerTeam = liveCfg.count || 2;
                        const vlogSocialData = extraData || {};

                        html += '<div style="background:#fff3e0;border-left:5px solid #e65100;padding:8px 14px;border-radius:8px;margin-bottom:12px;font-size:12px;color:#bf360c">'
                            + '<strong>ðŸ‘¥ Multi-Team Event â€” Live Monitor</strong> Â· Each team row scored separately'
                            + (isVlog ? ' Â· Social scores included' : '')
                            + '</div>';

                        html += '<div style="overflow-x:auto"><table style="width:100%;border-collapse:collapse;font-size:12.5px">'
                            + '<thead><tr style="background:linear-gradient(135deg,#bf360c,#e64a19);color:white">'
                            + '<th style="padding:9px 6px;text-align:center">#</th>'
                            + saHeader
                            + '<th style="padding:9px 8px;text-align:left">Team Code</th>';
                        if (isVlog) {
                            html += '<th style="padding:9px 8px;text-align:left">Topic</th>'
                                  + '<th style="padding:9px 8px;text-align:center;background:rgba(233,30,99,.25)">Social Score</th>';
                        } else {
                            html += '<th style="padding:9px 8px;text-align:left">Detail</th>';
                        }
                        criteria.forEach(c => {
                            html += '<th style="padding:9px 6px;text-align:center">' + c + '<br><small style="font-weight:400;opacity:.8">(0â€“10)</small></th>';
                        });
                        html += '<th style="padding:9px 6px;text-align:center;background:rgba(255,255,255,.12)">J1 Total</th>'
                             + '<th style="padding:9px 6px;text-align:center;background:rgba(255,255,255,.12)">J2 Total</th>'
                             + '<th style="padding:9px 6px;text-align:center;background:rgba(255,215,0,.25)">â­ Combined</th>'
                             + '</tr></thead><tbody>';

                        let seq = 1;
                        let globalSATeamNum = 0; // global counter across all classes for BOW
                        orderedClasses.forEach(cls => {
                            const clsKey   = sk(cls);
                            const alias    = getMonAlias(cls);
                            const classEnr = allEventEnrollments.filter(e => (e.classYear || e.class) === cls);

                            // Group into teams (same logic as renderJurySheet)
                            const teamsMap = {};
                            classEnr.forEach((enr, idx) => {
                                let tKey;
                                if (enr.teamNum != null) tKey = String(enr.teamNum);
                                else if (enr.topic)      tKey = 'topic__' + enr.topic;
                                else                     tKey = String(Math.floor(idx / membersPerTeam) + 1);
                                if (!teamsMap[tKey]) teamsMap[tKey] = [];
                                teamsMap[tKey].push(enr);
                            });

                            const teamNums = Object.keys(teamsMap).sort((a,b) => Number(a)-Number(b));
                            teamNums.forEach((tNum, tIdx) => {
                                globalSATeamNum++;
                                const teamMembers = teamsMap[tNum];
                                const rowKey      = clsKey + '__t' + (tIdx + 1);
                                const teamCode    = isBOW ? 'Team ' + globalSATeamNum : alias + ' â€” Team ' + (tIdx + 1);
                                const teamTopic   = teamMembers[0].topic || '';

                                let socialScore = 0;
                                if (isVlog) {
                                    const vKey = cls + '__' + teamTopic;
                                    if (vlogSocialData[vKey]) socialScore = vlogSocialData[vKey].socialScore || 0;
                                }

                                const j1row   = j1data[rowKey] || {};
                                const j2row   = j2data[rowKey] || {};
                                const j1marks = j1row.marks || [];
                                const j2marks = j2row.marks || [];
                                const j1tot   = sumMarks(j1marks);
                                const j2tot   = sumMarks(j2marks);
                                const combined = j1tot + j2tot;
                                const bg = seq % 2 === 0 ? '#fff8f0' : '#fff';

                                const extraLine = teamTopic ? 'Topic: ' + teamTopic : '';

                                html += '<tr style="background:' + bg + ';border-bottom:1px solid #ffe0b2">';
                                html += '<td style="padding:7px 6px;text-align:center;color:#888;font-size:11px">' + seq + '</td>';
                                // -- Super-admin identity cell ----------------------
                                html += saIdentityCell(cls, teamCode, teamMembers, extraLine);
                                // -- Team code cell ---------------------------------
                                html += '<td style="padding:7px 8px"><span style="background:#4a148c;color:white;font-weight:800;padding:3px 10px;border-radius:8px;font-size:0.85em">' + teamCode + '</span></td>';

                                if (isVlog) {
                                    html += '<td style="padding:7px 8px"><small style="color:#555">' + (teamTopic || 'â€”') + '</small></td>';
                                    html += '<td style="padding:7px 8px;text-align:center;font-weight:700;color:' + (socialScore > 0 ? '#e91e63' : '#aaa') + '">' + (socialScore > 0 ? socialScore : 'â€”') + '</td>';
                                } else {
                                    const det = teamMembers[0].topic || teamMembers[0].cause || 'â€”';
                                    html += '<td style="padding:7px 8px"><small style="color:#555">' + det + '</small></td>';
                                }

                                criteria.forEach((c, i) => {
                                    const v1 = j1marks[i] !== undefined ? j1marks[i] : '';
                                    const v2 = j2marks[i] !== undefined ? j2marks[i] : '';
                                    html += '<td style="padding:5px 4px;text-align:center;vertical-align:middle">'
                                        + '<div style="font-size:11px;color:#1565c0;margin-bottom:2px">J1: <input type="number" value="' + v1 + '" min="0" max="10" step="0.5"'
                                        + ' onchange="adminEditMark(\'' + event + '\',1,\'' + rowKey + '\',' + i + ',this.value)"'
                                        + ' style="width:44px;padding:2px 3px;border:1.5px solid #90caf9;border-radius:4px;font-size:11px;text-align:center"></div>'
                                        + '<div style="font-size:11px;color:#880e4f">J2: <input type="number" value="' + v2 + '" min="0" max="10" step="0.5"'
                                        + ' onchange="adminEditMark(\'' + event + '\',2,\'' + rowKey + '\',' + i + ',this.value)"'
                                        + ' style="width:44px;padding:2px 3px;border:1.5px solid #f48fb1;border-radius:4px;font-size:11px;text-align:center"></div>'
                                        + '</td>';
                                });

                                const hasJ1 = j1marks.length > 0;
                                const hasJ2 = j2marks.length > 0;
                                html += '<td style="padding:7px 6px;text-align:center;font-weight:700;color:' + (hasJ1 ? '#1565c0' : '#bbb') + '">' + (hasJ1 ? j1tot.toFixed(1) : 'â€”') + '</td>';
                                html += '<td style="padding:7px 6px;text-align:center;font-weight:700;color:' + (hasJ2 ? '#880e4f' : '#bbb') + '">' + (hasJ2 ? j2tot.toFixed(1) : 'â€”') + '</td>';
                                html += '<td style="padding:7px 6px;text-align:center;font-weight:800;font-size:1.05em;color:' + (hasJ1||hasJ2 ? '#4a148c' : '#ccc') + ';background:rgba(255,215,0,0.13)">'
                                    + (hasJ1 || hasJ2 ? combined.toFixed(1) : 'â€”') + '</td>';
                                html += '</tr>';
                                seq++;
                            });
                        });

                        html += '</tbody></table></div>';

                    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                    // CLASS-BASED EVENT (Nukkad Natak, YouTube Ad, Mime, Group Danceâ€¦)
                    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                    } else {
                        const isNukkad = event === 'Nukkad Natak';
                        const isYTAd   = event === 'YouTube Advertisement';
                        const isDance  = event === 'Group Dance';

                        html += '<div style="overflow-x:auto"><table style="width:100%;border-collapse:collapse;font-size:12.5px">'
                            + '<thead><tr style="background:linear-gradient(135deg,#6a1b9a,#c44569);color:white">'
                            + '<th style="padding:9px 6px;text-align:center">#</th>'
                            + saHeader
                            + '<th style="padding:9px 8px;text-align:left">Class Code</th>';
                        if (isNukkad) {
                            html += '<th style="padding:9px 8px;text-align:left">Cause/Theme</th>'
                                  + '<th style="padding:9px 8px;text-align:center">ðŸ“º YouTube</th>'
                                  + '<th style="padding:9px 8px;text-align:center">Bonus pts</th>';
                        } else if (isYTAd) {
                            html += '<th style="padding:9px 8px;text-align:left">Ad Title</th>'
                                  + '<th style="padding:9px 8px;text-align:left">Product</th>'
                                  + '<th style="padding:9px 8px;text-align:center;background:rgba(233,30,99,.25)">Social Score</th>';
                        } else if (isDance) {
                            html += '<th style="padding:9px 8px;text-align:left">ðŸ“– Story Title</th>'
                                  + '<th style="padding:9px 8px;text-align:left">ðŸ“ Summary</th>'
                                  + '<th style="padding:9px 8px;text-align:left">ðŸ‘¥ Performers</th>';
                        } else {
                            html += '<th style="padding:9px 8px;text-align:left">Theme/Topic</th>';
                        }
                        criteria.forEach(c => {
                            html += '<th style="padding:9px 6px;text-align:center">' + c + '<br><small style="font-weight:400;opacity:.8">(0â€“10)</small></th>';
                        });
                        html += '<th style="padding:9px 6px;text-align:center;background:rgba(255,255,255,.12)">J1 Total</th>'
                             + '<th style="padding:9px 6px;text-align:center;background:rgba(255,255,255,.12)">J2 Total</th>'
                             + '<th style="padding:9px 6px;text-align:center;background:rgba(255,215,0,.25)">â­ Combined</th>'
                             + '</tr></thead><tbody>';

                        const nukkadData = extraData ? (extraData.nukkad || {}) : {};
                        const ytAdData   = extraData ? (extraData.ytAd   || {}) : {};
                        const danceData  = extraData ? (extraData.dance  || {}) : {};

                        orderedClasses.forEach((cls, idx) => {
                            const clsKey   = sk(cls);
                            const alias    = getMonAlias(cls);
                            const classEnr = allEventEnrollments.filter(e => (e.classYear || e.class) === cls);
                            const firstEnr = classEnr[0] || {};

                            const j1row   = j1data[clsKey] || {};
                            const j2row   = j2data[clsKey] || {};
                            const j1marks = j1row.marks || [];
                            const j2marks = j2row.marks || [];
                            const j1tot   = sumMarks(j1marks);
                            const j2tot   = sumMarks(j2marks);
                            const combined = j1tot + j2tot;
                            const bg = (idx + 1) % 2 === 0 ? '#fdf6ff' : '#fff';

                            // Build extra line for SA cell
                            const extraLine = isYTAd
                                ? ('Ad: ' + (firstEnr.adTitle || 'â€”') + ' Â· Product: ' + (firstEnr.product || 'â€”'))
                                : isNukkad
                                    ? ('Theme: ' + (firstEnr.cause || firstEnr.topic || 'â€”'))
                                    : isDance
                                        ? ('Story: ' + (danceData[clsKey] ? (danceData[clsKey].title || 'No title') : 'Not submitted'))
                                        : (firstEnr.topic ? 'Topic: ' + firstEnr.topic : '');

                            html += '<tr style="background:' + bg + ';border-bottom:1px solid #ede7f6">';
                            html += '<td style="padding:7px 6px;text-align:center;color:#888;font-size:11px">' + (idx+1) + '</td>';
                            // -- Super-admin identity cell --------------------------
                            html += saIdentityCell(cls, alias, classEnr, extraLine);
                            // -- Class code cell ------------------------------------
                            html += '<td style="padding:7px 8px"><strong style="color:#4a148c">' + alias + '</strong></td>';

                            if (isNukkad) {
                                const nd     = nukkadData[clsKey] || {};
                                const cause  = firstEnr.cause || firstEnr.topic || 'â€”';
                                const ytLink = nd.ytLink || '';
                                const ytVer  = nd.ytVerified === true;
                                const newVer = nd.newspaperVerified === true;
                                const bonus  = (ytVer ? 10 : 0) + (newVer ? 10 : 0);
                                const ytCell = ytLink
                                    ? '<a href="' + ytLink + '" target="_blank" style="background:#ff0000;color:white;padding:3px 8px;border-radius:5px;text-decoration:none;font-size:11px;font-weight:700">â–¶ YouTube</a>'
                                      + (ytVer ? ' <span style="color:#2e7d32;font-size:10px">âœ…</span>' : ' <span style="color:#f57c00;font-size:10px">âš ï¸</span>')
                                    : '<span style="color:#aaa;font-size:11px">Not submitted</span>';
                                html += '<td style="padding:7px 8px"><small style="color:#555">' + cause + '</small></td>';
                                html += '<td style="padding:7px 8px;text-align:center">' + ytCell + '</td>';
                                html += '<td style="padding:7px 8px;text-align:center;font-weight:700;color:' + (bonus > 0 ? '#2e7d32' : '#aaa') + '">+' + bonus + '</td>';
                            } else if (isYTAd) {
                                const yd        = ytAdData[clsKey] || {};
                                const adTitle   = firstEnr.adTitle  || yd.adTitle  || 'â€”';
                                const product   = firstEnr.product  || yd.product  || 'â€”';
                                const socialPct = yd.socialPct != null ? yd.socialPct : (yd.socialScore || firstEnr.socialPct || firstEnr.socialScore || 0);
                                html += '<td style="padding:7px 8px"><small style="color:#555">' + adTitle + '</small></td>';
                                html += '<td style="padding:7px 8px"><small style="color:#555">' + product + '</small></td>';
                                html += '<td style="padding:7px 8px;text-align:center;font-weight:700;color:' + (socialPct > 0 ? '#e91e63' : '#aaa') + '">' + (socialPct > 0 ? socialPct : 'â€”') + '</td>';
                            } else if (isDance) {
                                const dd = danceData[clsKey] || {};
                                const performers = classEnr.map(e => e.name || 'â€”').join(', ');
                                html += '<td style="padding:7px 8px"><strong style="color:#880e4f;font-size:12px">' + (dd.title || '<span style="color:#aaa;font-weight:400;font-style:italic">Not submitted</span>') + '</strong></td>';
                                html += '<td style="padding:7px 8px"><small style="color:#555;line-height:1.5">' + (dd.summary || '<span style="color:#aaa;font-style:italic">Not submitted</span>') + '</small></td>';
                                html += '<td style="padding:7px 8px"><small style="color:#555">' + (performers || 'â€”') + '</small></td>';
                            } else {
                                const theme = firstEnr.topic || firstEnr.cause || firstEnr.product || 'â€”';
                                html += '<td style="padding:7px 8px"><small style="color:#555">' + theme + '</small></td>';
                            }

                            criteria.forEach((c, i) => {
                                const v1 = j1marks[i] !== undefined ? j1marks[i] : '';
                                const v2 = j2marks[i] !== undefined ? j2marks[i] : '';
                                html += '<td style="padding:5px 4px;text-align:center;vertical-align:middle">'
                                    + '<div style="font-size:11px;color:#1565c0;margin-bottom:2px">J1: <input type="number" value="' + v1 + '" min="0" max="10" step="0.5"'
                                    + ' onchange="adminEditMark(\'' + event + '\',1,\'' + clsKey + '\',' + i + ',this.value)"'
                                    + ' style="width:44px;padding:2px 3px;border:1.5px solid #90caf9;border-radius:4px;font-size:11px;text-align:center"></div>'
                                    + '<div style="font-size:11px;color:#880e4f">J2: <input type="number" value="' + v2 + '" min="0" max="10" step="0.5"'
                                    + ' onchange="adminEditMark(\'' + event + '\',2,\'' + clsKey + '\',' + i + ',this.value)"'
                                    + ' style="width:44px;padding:2px 3px;border:1.5px solid #f48fb1;border-radius:4px;font-size:11px;text-align:center"></div>'
                                    + '</td>';
                            });

                            const hasJ1 = j1marks.length > 0;
                            const hasJ2 = j2marks.length > 0;
                            html += '<td style="padding:7px 6px;text-align:center;font-weight:700;color:' + (hasJ1 ? '#1565c0' : '#bbb') + '">' + (hasJ1 ? j1tot.toFixed(1) : 'â€”') + '</td>';
                            html += '<td style="padding:7px 6px;text-align:center;font-weight:700;color:' + (hasJ2 ? '#880e4f' : '#bbb') + '">' + (hasJ2 ? j2tot.toFixed(1) : 'â€”') + '</td>';
                            html += '<td style="padding:7px 6px;text-align:center;font-weight:800;font-size:1.05em;color:' + (hasJ1||hasJ2 ? '#4a148c' : '#ccc') + ';background:rgba(255,215,0,0.13)">'
                                + (hasJ1 || hasJ2 ? combined.toFixed(1) : 'â€”') + '</td>';
                            html += '</tr>';
                        });

                        html += '</tbody></table></div>';
                    }

                    container.innerHTML = html;
                }

                // -- Load auxiliary data (Nukkad bonus, YT Ad social, Vlog social) -
                // Then subscribe to live jury marks
                async function subscribeWithExtras() {
                    let extraData = null;

                    if (event === 'Nukkad Natak') {
                        try {
                            const snap = await db.ref('nukkadNatak/post').once('value');
                            extraData = { nukkad: snap.exists() ? snap.val() : {} };
                        } catch(e) { extraData = { nukkad: {} }; }
                    } else if (event === 'YouTube Advertisement') {
                        try {
                            const snap = await db.ref('youtubeAd').once('value');
                            const ytMap = {};
                            if (snap.exists()) snap.forEach(ch => {
                                const d = ch.val();
                                const k = (d.classYear || '').replace(/[.\[\]#$\/\s]/g,'_');
                                ytMap[k] = d;
                            });
                            extraData = { ytAd: ytMap };
                        } catch(e) { extraData = { ytAd: {} }; }
                    } else if (event === 'Vlog') {
                        try {
                            const snap = await db.ref('vlogChallenge').once('value');
                            extraData = snap.exists() ? snap.val() : {};
                        } catch(e) { extraData = {}; }
                    } else if (event === 'Group Dance') {
                        try {
                            const snap = await db.ref('groupDance').once('value');
                            extraData = { dance: snap.exists() ? snap.val() : {} };
                        } catch(e) { extraData = { dance: {} }; }
                    }

                    // -- Subscribe to real-time jury marks ------------------------
                    let j1data = null, j2data = null;
                    const ref1 = db.ref('juryMarks/' + event + '/jury1');
                    const ref2 = db.ref('juryMarks/' + event + '/jury2');
                    const h1 = ref1.on('value', snap => { j1data = snap.val(); renderMonitor(j1data, j2data, extraData); });
                    const h2 = ref2.on('value', snap => { j2data = snap.val(); renderMonitor(j1data, j2data, extraData); });
                    _liveMonitorListeners.push(() => ref1.off('value', h1));
                    _liveMonitorListeners.push(() => ref2.off('value', h2));
                }

                await subscribeWithExtras();

            } catch(err) {
                container.innerHTML = '<p style="color:red;text-align:center;padding:20px">Error: ' + err.message + '</p>';
            }
        }

        async function adminEditMark(event, juryNum, safeKey, critIndex, value) {
            try {
                await db.ref(`juryMarks/\${event}/jury\${juryNum}/\${safeKey}/marks/\${critIndex}`).set(parseFloat(value) || 0);
            } catch(e) { alert('Save error: ' + e.message); }
        }

        // ============================================================
        // POINT 3: Show Enrollments â€” password protected
        // ============================================================
        function showEnrollmentDebugProtected() {
            const pwd = prompt('Enter admin password to view enrollment data:');
            if (!pwd) return;
            db.ref('jurySetup').once('value').then(snap => {
                // Check any jury password as verification
                let valid = false;
                if (snap.exists()) {
                    snap.forEach(child => {
                        const s = child.val();
                        if (s.jury1Password === pwd || s.jury2Password === pwd) valid = true;
                    });
                }
                // Also allow super admin password
                if (isSuperAdmin) valid = true;
                if (valid) {
                    showEnrollmentDebug();
                } else {
                    alert('âŒ Incorrect password.');
                }
            });
        }

        function showEnrollmentDebug() {
            console.log('=== ENROLLMENT DEBUG ===');
            console.log('Current juryEvent:', juryEvent);
            console.log('All array length:', all.length);
            console.log('All enrollments:', all);
            
            // Filter for current event
            const eventEnrollments = all.filter(e => e.event === juryEvent);
            console.log('Enrollments for', juryEvent, ':', eventEnrollments);
            
            // Get unique classes
            const classes = [...new Set(eventEnrollments.map(e => e.classYear))];
            console.log('Unique classes:', classes);
            
            // Build report
            let report = '=== ENROLLMENT DEBUG REPORT ===\n\n';
            report += 'Event: ' + juryEvent + '\n';
            report += 'Total enrollments in database: ' + all.length + '\n';
            report += 'Enrollments for this event: ' + eventEnrollments.length + '\n';
            report += 'Unique classes: ' + classes.join(', ') + '\n\n';
            
            report += 'Detailed Enrollments:\n';
            eventEnrollments.forEach((e, i) => {
                report += `${i+1}. Class: ${e.classYear}, Name: ${e.name}, Phone: ${e.phone}\n`;
            });
            
            if (eventEnrollments.length === 0) {
                report += '\nâš ï¸ NO ENROLLMENTS FOUND!\n';
                report += 'This means either:\n';
                report += '1. No one has enrolled for this event yet\n';
                report += '2. The enrollments are not being loaded from Firebase\n';
                report += '3. The event name doesn\'t match\n';
            }
            
            console.log(report);
            alert(report);
        }

        function testFirebaseWrite() {
            console.log('=== TESTING FIREBASE WRITE ===');
            console.log('Testing write to: juryMarks/TEST/test');
            
            const testData = {
                timestamp: new Date().toISOString(),
                message: 'This is a test write',
                juryEvent: juryEvent,
                juryNumber: juryNumber
            };
            
            console.log('Test data:', testData);
            
            // Test 1: Try writing to test path
            db.ref('juryMarks/TEST/test').set(testData)
                .then(() => {
                    console.log('âœ“ TEST WRITE SUCCESSFUL');
                    
                    // Verify by reading back
                    return db.ref('juryMarks/TEST/test').once('value');
                })
                .then(snap => {
                    const readData = snap.val();
                    console.log('âœ“ TEST READ SUCCESSFUL');
                    console.log('Data read back:', readData);
                    
                    if (readData) {
                        alert('âœ… FIREBASE TEST PASSED!\n\n' +
                              'Firebase is working correctly.\n' +
                              'Write: SUCCESS\n' +
                              'Read: SUCCESS\n\n' +
                              'Check Firebase Console - you should see:\n' +
                              'juryMarks > TEST > test\n\n' +
                              'The issue must be in the saveMarks function.');
                              
                        // Now test the actual save path
                        console.log('Now testing actual save path...');
                        const actualPath = 'juryMarks/' + juryEvent + '/jury' + juryNumber;
                        console.log('Actual path:', actualPath);
                        
                        return db.ref(actualPath).set({test: 'actual path test'});
                    } else {
                        throw new Error('Read returned null');
                    }
                })
                .then(() => {
                    console.log('âœ“ ACTUAL PATH WRITE SUCCESSFUL');
                    alert('âœ… Both tests passed! Check the console and Firebase database.');
                })
                .catch(err => {
                    console.error('âœ— TEST FAILED:', err);
                    console.error('Error code:', err.code);
                    console.error('Error message:', err.message);
                    
                    alert('âŒ FIREBASE TEST FAILED!\n\n' +
                          'Error: ' + err.message + '\n' +
                          'Code: ' + err.code + '\n\n' +
                          'This means Firebase rules may still be blocking writes.\n' +
                          'Check browser console for details.');
                });
        }

        // Edit and Delete Functions
        let editingKey = null;
        let editingData = null;

        // Wrapper functions to handle calls from data attributes
        function editEnrollmentByKey(key) {
            editEnrollment(key);
        }

        function deleteEnrollmentByKey(key, name, event) {
            deleteEnrollment(key, name, event);
        }

        function editEnrollment(key) {
            console.log('Editing enrollment:', key);
            console.log('All enrollments:', all);
            console.log('Looking for key:', key);
            
            editingKey = key;
            
            // Find the enrollment data - search by id field
            const enrollment = all.find(e => e.id === key);
            
            if (!enrollment) {
                console.error('Enrollment not found!');
                console.log('Available IDs:', all.map(e => e.id));
                alert('Error: Enrollment not found. Please refresh the page and try again.');
                return;
            }
            
            editingData = enrollment;
            console.log('Enrollment data:', enrollment);
            
            // Build edit form based on event type
            const eventConfig = events[enrollment.event];
            const isTeamEvent = eventConfig && eventConfig.count > 1;
            
            let formHtml = '<div class="form-group">';
            formHtml += '<label>Name:</label>';
            formHtml += '<input type="text" id="editName" value="' + enrollment.name + '" required>';
            formHtml += '</div>';
            
            formHtml += '<div class="form-group">';
            formHtml += '<label>Phone:</label>';
            formHtml += '<input type="tel" id="editPhone" value="' + enrollment.phone + '" required>';
            formHtml += '</div>';
            
            formHtml += '<div class="form-group">';
            formHtml += '<label>Class Year:</label>';
            formHtml += '<input type="text" id="editClass" value="' + enrollment.classYear + '" readonly>';
            formHtml += '</div>';
            
            formHtml += '<div class="form-group">';
            formHtml += '<label>Event:</label>';
            formHtml += '<input type="text" value="' + enrollment.event + '" readonly>';
            formHtml += '</div>';
            
            formHtml += '<div class="form-group">';
            formHtml += '<label>Role:</label>';
            formHtml += '<input type="text" value="' + enrollment.role + '" readonly>';
            formHtml += '</div>';
            
            // Add team members if it's a team event
            if (isTeamEvent && enrollment.teamMembers) {
                for (let i = 0; i < enrollment.teamMembers.length; i++) {
                    const member = enrollment.teamMembers[i];
                    formHtml += '<div class="team-member-box">';
                    formHtml += '<div class="member-header">Team Member ' + (i + 1) + '</div>';
                    formHtml += '<div class="form-group">';
                    formHtml += '<label>Name:</label>';
                    formHtml += '<input type="text" id="editTeamName' + i + '" value="' + member.name + '" required>';
                    formHtml += '</div>';
                    formHtml += '<div class="form-group">';
                    formHtml += '<label>Phone:</label>';
                    formHtml += '<input type="tel" id="editTeamPhone' + i + '" value="' + member.phone + '" required>';
                    formHtml += '</div>';
                    formHtml += '</div>';
                }
            }
            
            document.getElementById('editFormContainer').innerHTML = formHtml;
            document.getElementById('editModal').style.display = 'block';
        }

        function closeEditModal() {
            document.getElementById('editModal').style.display = 'none';
            editingKey = null;
            editingData = null;
        }

        function saveEdit() {
            if (!editingKey || !editingData) {
                alert('Error: No enrollment selected');
                return;
            }
            
            // Get updated values
            const updatedName = document.getElementById('editName').value.trim();
            const updatedPhone = document.getElementById('editPhone').value.trim();
            
            if (!updatedName || !updatedPhone) {
                alert('Please fill in all required fields');
                return;
            }
            
            // Validate phone
            if (!/^\d{10}$/.test(updatedPhone)) {
                alert('Please enter a valid 10-digit phone number');
                return;
            }
            
            // Build updated enrollment object
            const updatedEnrollment = {
                ...editingData,
                name: updatedName,
                phone: updatedPhone
            };
            
            // Update team members if applicable
            const eventConfig = events[editingData.event];
            if (eventConfig && eventConfig.count > 1 && editingData.teamMembers) {
                updatedEnrollment.teamMembers = [];
                for (let i = 0; i < editingData.teamMembers.length; i++) {
                    const memberName = document.getElementById('editTeamName' + i).value.trim();
                    const memberPhone = document.getElementById('editTeamPhone' + i).value.trim();
                    
                    if (!memberName || !memberPhone) {
                        alert('Please fill in all team member details');
                        return;
                    }
                    
                    if (!/^\d{10}$/.test(memberPhone)) {
                        alert('Please enter valid 10-digit phone numbers for all team members');
                        return;
                    }
                    
                    updatedEnrollment.teamMembers.push({
                        name: memberName,
                        phone: memberPhone
                    });
                }
            }
            
            // Save to Firebase
            ref.child(editingKey).set(updatedEnrollment)
                .then(() => {
                    showOk('Enrollment updated successfully!');
                    closeEditModal();
                    loadData(); // Reload data
                    
                    // Refresh the appropriate view
                    if (studentClass) {
                        viewStudentClassEnrollments();
                    }
                    if (isCR) {
                        updateCRView();
                    }
                })
                .catch(err => {
                    console.error('Error updating enrollment:', err);
                    showErr('Failed to update enrollment: ' + err.message);
                });
        }

        function deleteEnrollment(key, name, event) {
            // Find the enrollment data - search by id field
            const enrollment = all.find(e => e.id === key);
            if (!enrollment) {
                alert('Error: Enrollment not found');
                return;
            }
            
            if (!confirm('Are you sure you want to delete the enrollment for ' + name + ' in ' + event + '?')) {
                return;
            }
            
            ref.child(key).remove()
                .then(() => {
                    showOk('Enrollment deleted successfully!');
                    loadData(); // Reload data
                    
                    // Refresh the appropriate view
                    if (studentClass) {
                        viewStudentClassEnrollments();
                    }
                    if (isCR) {
                        updateCRView();
                    }
                })
                .catch(err => {
                    console.error('Error deleting enrollment:', err);
                    showErr('Failed to delete enrollment: ' + err.message);
                });
        }

        function showOk(msg) {
            const d = document.getElementById('enrollMessage');
            d.className = 'message success show';
            d.textContent = 'âœ“ '+msg;
            setTimeout(() => d.classList.remove('show'), 5000);
            d.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }

        function showErr(msg) {
            const d = document.getElementById('enrollMessage');
            d.className = 'message error show';
            d.textContent = 'âœ— '+msg;
            setTimeout(() => d.classList.remove('show'), 5000);
            d.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }

        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) event.target.style.display = 'none';
        }
        
        // ==================== QUIZ COMPETITION FUNCTIONS ====================
        
        // Quiz Utility Functions
        // -- SERVER-TIME OFFSET (fetched once, reused everywhere) --------------
        let _serverTimeOffsetMs = 0;
        let _serverOffsetFetched = false;

        async function fetchServerTimeOffset() {
            if (_serverOffsetFetched) return;
            try {
                const snap = await db.ref('.info/serverTimeOffset').once('value');
                _serverTimeOffsetMs = snap.val() || 0;
                _serverOffsetFetched = true;
                console.log('[ServerTime] Offset:', _serverTimeOffsetMs, 'ms');
            } catch (e) {
                console.warn('[ServerTime] Could not fetch offset:', e);
                _serverTimeOffsetMs = 0;
                _serverOffsetFetched = true;
            }
        }

        function getServerNow() {
            return new Date(Date.now() + _serverTimeOffsetMs);
        }

        function getQuizToday() {
            const now = getServerNow();
            const year  = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day   = String(now.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        async function getQuizTodayServer() {
            await fetchServerTimeOffset();
            return getQuizToday();
        }
        
        // Check public quiz status (before login)
        async function checkPublicQuizStatus() {
            const today = await getQuizTodayServer();
            const messageDiv = document.getElementById('publicQuizMessage');
            console.log('=== checkPublicQuizStatus START === Today:', today);
            try {
                // Always fetch all published dates first
                const allPublished = await db.ref('quizPublished').once('value');
                let latestPublishedDate = null;
                let latestPublishedData = null;
                if (allPublished.exists()) {
                    const pubData = allPublished.val();
                    const publishedDates = Object.keys(pubData)
                        .filter(d => pubData[d] && pubData[d].published === true)
                        .sort().reverse();
                    if (publishedDates.length > 0) {
                        latestPublishedDate = publishedDates[0];
                        latestPublishedData = pubData[latestPublishedDate];
                    }
                }
                console.log('Latest published date:', latestPublishedDate);

                // If there is a published quiz (any date), show its Q&A
                if (latestPublishedDate) {
                    const pubQSnap = await db.ref(`quizQuestions/${latestPublishedDate}`).once('value');
                    if (pubQSnap.exists()) {
                        const questions = pubQSnap.val();
                        const publishData = latestPublishedData;
                        const publishedDate = new Date(latestPublishedDate + 'T00:00:00').toLocaleDateString('en-IN', {
                            weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'
                        });
                        const publishedTime = new Date(publishData.publishedAt).toLocaleTimeString('en-IN', {
                            hour: '2-digit', minute: '2-digit'
                        });
                        let html = '<div style="background:#e8f5e9;padding:20px;border-radius:10px;border:3px solid #4CAF50;margin-bottom:16px">';
                        html += '<h4 style="color:#2e7d32;margin-top:0">\uD83D\uDCC5 Published Quiz - Questions &amp; Answers</h4>';
                        html += '<p style="color:#2e7d32;margin-bottom:15px;font-size:0.9em">Published: ' + publishedDate + ' at ' + publishedTime + '</p>';
                        html += '<div style="background:white;padding:20px;border-radius:8px;margin-bottom:15px;border-left:5px solid #667eea">';
                        html += '<p style="margin:0 0 10px 0;color:#667eea;font-weight:bold;font-size:1.1em">Question 1:</p>';
                        if (questions.q1.image) {
                            html += '<div style="text-align:center;margin:12px 0"><img src="' + questions.q1.image + '" style="max-width:100%;max-height:280px;border-radius:10px;box-shadow:0 4px 15px rgba(0,0,0,0.2)"></div>';
                        }
                        if (questions.q1.audio) {
                            html += '<div style="margin:12px 0;background:#f0f4ff;padding:12px;border-radius:8px;text-align:center"><p style="margin:0 0 8px 0;font-weight:600;color:#667eea;font-size:0.95em">ðŸŽµ Audio</p><audio controls style="width:100%;max-width:400px"><source src="' + questions.q1.audio + '"></audio></div>';
                        }
                        html += '<p style="margin:0 0 15px 0;color:#333;font-size:1.05em">' + questions.q1.text + '</p>';
                        if (questions.q1.type === 'text') {
                            html += '<div style="background:#4CAF50;color:white;padding:12px;border-radius:6px;font-weight:bold">âœ… Answer: ' + (questions.q1.textAnswer || '') + '</div>';
                            if (questions.q1.explanation) html += '<div style="background:#e8f5e9;color:#2e7d32;padding:10px;border-radius:6px;margin-top:8px;font-size:0.95em">ðŸ“– ' + questions.q1.explanation + '</div>';
                            html += '</div>';
                        } else {
                        html += '<div style="background:#4CAF50;color:white;padding:12px;border-radius:6px;font-weight:bold">\u2705 Correct Answer: ' + questions.q1.options[questions.q1.correct] + '</div></div>';
                        }
                        html += '<div style="background:white;padding:20px;border-radius:8px;border-left:5px solid #667eea">';
                        html += '<p style="margin:0 0 10px 0;color:#667eea;font-weight:bold;font-size:1.1em">Question 2:</p>';
                        if (questions.q2 && (questions.q2.options || questions.q2.type === 'text')) {
                        if (questions.q2.image) {
                            html += '<div style="text-align:center;margin:12px 0"><img src="' + questions.q2.image + '" style="max-width:100%;max-height:280px;border-radius:10px;box-shadow:0 4px 15px rgba(0,0,0,0.2)"></div>';
                        }
                        if (questions.q2.audio) {
                            html += '<div style="margin:12px 0;background:#f0f4ff;padding:12px;border-radius:8px;text-align:center"><p style="margin:0 0 8px 0;font-weight:600;color:#667eea;font-size:0.95em">ðŸŽµ Audio</p><audio controls style="width:100%;max-width:400px"><source src="' + questions.q2.audio + '"></audio></div>';
                        }
                        html += '<p style="margin:0 0 15px 0;color:#333;font-size:1.05em">' + questions.q2.text + '</p>';
                        if (questions.q2.type === 'text') {
                            html += '<div style="background:#4CAF50;color:white;padding:12px;border-radius:6px;font-weight:bold">âœ… Answer: ' + (questions.q2.textAnswer || '') + '</div>';
                            if (questions.q2.explanation) html += '<div style="background:#e8f5e9;color:#2e7d32;padding:10px;border-radius:6px;margin-top:8px;font-size:0.95em">ðŸ“– ' + questions.q2.explanation + '</div>';
                            html += '</div>';
                        } else {
                        html += '<div style="background:#4CAF50;color:white;padding:12px;border-radius:6px;font-weight:bold">\u2705 Correct Answer: ' + questions.q2.options[questions.q2.correct] + '</div></div>';
                        }
                        } else { html += '<p style="color:#999;font-style:italic">Q2 not available.</p></div>'; }
                        html += '<p style="color:#2e7d32;margin:15px 0 0 0;font-size:0.9em;text-align:center"><em>Review the questions and answers from the published quiz</em></p></div>';
                        // Also show today participation banner if today has a DIFFERENT (unpublished) quiz
                        if (latestPublishedDate !== today) {
                            const todayQSnap = await db.ref(`quizQuestions/${today}`).once('value');
                            if (todayQSnap.exists()) {
                                const todayDateStr = new Date(today + 'T00:00:00').toLocaleDateString('en-IN', {weekday:'long', day:'2-digit', month:'long', year:'numeric'});
                                html += '<div class="quiz-available-banner"><div class="trophy-icon">\uD83C\uDFC6</div><h3>\u2705 Today\'s Quiz is Available!</h3><p style="margin:0;color:#155724;font-size:1.05em;font-weight:600">\uD83D\uDCC5 ' + todayDateStr + '</p><p style="margin-top:6px;color:#155724;font-size:1.05em">Login below to participate and win exciting prizes!</p><p style="margin-top:8px;color:#28a745;font-weight:600">\u26A1 Be the fastest to answer correctly!</p><div style="margin-top:14px;background:rgba(255,255,255,0.7);border-radius:10px;padding:10px 15px;display:inline-block;border:2px solid #28a745"><span style="color:#856404;font-weight:700;font-size:0.95em">\u23F3 Quiz ends in: </span><span id="publicQuizCountdown" style="color:#c0392b;font-weight:800;font-size:1.15em;letter-spacing:1px">--:--:--</span><span style="color:#666;font-size:0.82em;margin-left:6px">(closes at 11:59 PM today)</span></div></div>';
                            }
                        }
                        messageDiv.innerHTML = html;
                        // Start countdown AFTER innerHTML is set
                        setTimeout(function startQuizCountdownAfterRender() {
                            function tickCountdown() {
                                const el = document.getElementById('publicQuizCountdown');
                                if (!el) return;
                                const now2 = new Date(), end2 = new Date();
                                end2.setHours(23, 59, 59, 0);
                                const diff = end2 - now2;
                                if (diff <= 0) { el.textContent = 'CLOSED'; el.style.color = '#c0392b'; return; }
                                const h = Math.floor(diff/3600000), m = Math.floor((diff%3600000)/60000), s = Math.floor((diff%60000)/1000);
                                el.textContent = String(h).padStart(2,'0')+':'+String(m).padStart(2,'0')+':'+String(s).padStart(2,'0');
                                setTimeout(tickCountdown, 1000);
                            }
                            tickCountdown();
                        }, 0);
                        showPublicQuizWinner(latestPublishedDate);
                        console.log('=== checkPublicQuizStatus END (published) ===');
                        return;
                    }
                }

                // No published quiz â€” check if today has a quiz for participation
                const todayQSnap2 = await db.ref(`quizQuestions/${today}`).once('value');
                if (!todayQSnap2.exists()) {
                    messageDiv.innerHTML = '<p style="margin:0;color:#856404">\u23F3 <strong>No quiz available today.</strong></p>';
                    showPublicQuizWinner(today);
                    return;
                }

                // Today has quiz but not published yet â€” show participation banner with date
                const todayDateStr2 = new Date(today + 'T00:00:00').toLocaleDateString('en-IN', {weekday:'long', day:'2-digit', month:'long', year:'numeric'});
                messageDiv.innerHTML = '<div class="quiz-available-banner"><div class="trophy-icon">\uD83C\uDFC6</div><h3>\u2705 Today\'s Quiz is Available!</h3><p style="margin:0;color:#155724;font-size:1.05em;font-weight:600">\uD83D\uDCC5 ' + todayDateStr2 + '</p><p style="margin-top:6px;color:#155724;font-size:1.05em">Login below to participate and win exciting prizes!</p><p style="margin-top:8px;color:#28a745;font-weight:600">\u26A1 Be the fastest to answer correctly!</p><div style="margin-top:14px;background:rgba(255,255,255,0.7);border-radius:10px;padding:10px 15px;display:inline-block;border:2px solid #28a745"><span style="color:#856404;font-weight:700;font-size:0.95em">\u23F3 Quiz ends in: </span><span id="publicQuizCountdown" style="color:#c0392b;font-weight:800;font-size:1.15em;letter-spacing:1px">--:--:--</span><span style="color:#666;font-size:0.82em;margin-left:6px">(closes at 11:59 PM today)</span></div></div>';
                // Start countdown AFTER innerHTML is set
                setTimeout(function startQuizCountdownAfterRender2() {
                    function tickCountdown2() {
                        const el = document.getElementById('publicQuizCountdown');
                        if (!el) return;
                        const now3 = new Date(), end3 = new Date();
                        end3.setHours(23, 59, 59, 0);
                        const diff = end3 - now3;
                        if (diff <= 0) { el.textContent = 'CLOSED'; el.style.color = '#c0392b'; return; }
                        const h = Math.floor(diff/3600000), m = Math.floor((diff%3600000)/60000), s = Math.floor((diff%60000)/1000);
                        el.textContent = String(h).padStart(2,'0')+':'+String(m).padStart(2,'0')+':'+String(s).padStart(2,'0');
                        setTimeout(tickCountdown2, 1000);
                    }
                    tickCountdown2();
                }, 0);
                showPublicQuizWinner(today);
                console.log('=== checkPublicQuizStatus END (available) ===');
            } catch (err) {
                console.error('Public quiz status check error:', err);
                messageDiv.innerHTML = '<p style="margin:0;color:#721c24">\u274C Error loading quiz status</p>';
            }
        }

        // Show declared winner below the quiz status box
        async function showPublicQuizWinner(date) {
            // Remove any existing winner box first
            const existing = document.getElementById('publicQuizWinnerBox');
            if (existing) existing.remove();

            try {
                const snap = await db.ref(`quizResults/${date}`).once('value');
                const data = snap.val();
                if (!data || !data.winner) return; // no winner declared yet

                const dateFormatted = new Date(date).toLocaleDateString('en-IN', {
                    weekday: 'long', day: '2-digit', month: 'long', year: 'numeric'
                });
                const declaredTime = new Date(data.declaredAt).toLocaleTimeString('en-IN', {
                    hour: '2-digit', minute: '2-digit', hour12: true
                });

                const box = document.createElement('div');
                box.id = 'publicQuizWinnerBox';
                box.style.cssText = 'margin-top:20px;border-radius:16px;overflow:hidden;box-shadow:0 8px 30px rgba(0,0,0,0.15)';
                box.innerHTML = `
                    <div style="background:linear-gradient(135deg,#6a1b9a,#c44569);padding:16px 22px;color:white;display:flex;align-items:center;gap:12px">
                        <span style="font-size:1.8em">ðŸ†</span>
                        <div>
                            <h4 style="margin:0;font-size:1.05em">Today's Quiz Winners</h4>
                            <p style="margin:0;font-size:11px;opacity:0.8">ðŸ“… ${dateFormatted} &nbsp;|&nbsp; Declared at ${declaredTime}</p>
                        </div>
                    </div>
                    <div style="background:white;padding:18px 22px;display:flex;gap:16px;flex-wrap:wrap">
                        <div style="flex:1;min-width:160px;background:linear-gradient(135deg,#fff9c4,#ffd54f);border-radius:12px;padding:16px;text-align:center;border:2px solid #ffd700">
                            <div style="font-size:2em;margin-bottom:4px">ðŸ¥‡</div>
                            <div style="font-weight:800;font-size:1.05em;color:#5d4037">${data.winner.name}</div>
                            <div style="background:#6a1b9a;color:white;border-radius:20px;padding:3px 12px;font-size:12px;font-weight:700;margin:6px auto;display:inline-block">${data.winner.class}</div>
                            <div style="font-size:11px;color:#666;margin-top:4px">Score: ${data.winner.score}/2</div>
                        </div>
                        ${data.runnerUp ? `
                        <div style="flex:1;min-width:160px;background:linear-gradient(135deg,#f5f5f5,#e0e0e0);border-radius:12px;padding:16px;text-align:center;border:2px solid #bdbdbd">
                            <div style="font-size:2em;margin-bottom:4px">ðŸ¥ˆ</div>
                            <div style="font-weight:800;font-size:1.05em;color:#37474f">${data.runnerUp.name}</div>
                            <div style="background:#455a64;color:white;border-radius:20px;padding:3px 12px;font-size:12px;font-weight:700;margin:6px auto;display:inline-block">${data.runnerUp.class}</div>
                            <div style="font-size:11px;color:#666;margin-top:4px">Score: ${data.runnerUp.score}/2</div>
                        </div>` : ''}
                    </div>
                `;

                // Insert after publicQuizMessage div
                const msgDiv = document.getElementById('publicQuizMessage');
                msgDiv.parentNode.insertBefore(box, msgDiv.nextSibling);

            } catch(e) { console.warn('showPublicQuizWinner error:', e); }
        }
        
        // Load result for any past date selected by the user
        async function loadPastQuizResult() {
            const date = document.getElementById('pastResultDate').value;
            const box  = document.getElementById('pastResultBox');
            if (!date) { alert('Please select a date.'); return; }
            box.style.display = 'block';
            box.innerHTML = '<p style="color:#666;margin:0;text-align:center">â³ Loading result...</p>';
            try {
                const snap = await db.ref(`quizResults/${date}`).once('value');
                const data = snap.val();
                const dateFormatted = new Date(date + 'T00:00:00').toLocaleDateString('en-IN', {
                    weekday:'long', day:'2-digit', month:'long', year:'numeric'
                });
                if (!data || !data.winner) {
                    box.innerHTML = `<div style="background:#fff3cd;border-radius:10px;padding:14px 18px;border-left:4px solid #ffc107">
                        <strong style="color:#856404">ðŸ“­ No winner declared for ${dateFormatted}.</strong>
                        <p style="margin:6px 0 0;color:#856404;font-size:13px">Either the quiz didn't take place or the result hasn't been declared yet.</p>
                    </div>`;
                    return;
                }
                const declaredTime = new Date(data.declaredAt).toLocaleTimeString('en-IN',{hour:'2-digit',minute:'2-digit',hour12:true});
                box.innerHTML = `
                    <div style="border-radius:14px;overflow:hidden;box-shadow:0 4px 16px rgba(0,0,0,0.1)">
                        <div style="background:linear-gradient(135deg,#6a1b9a,#c44569);padding:14px 18px;color:white;display:flex;align-items:center;gap:10px">
                            <span style="font-size:1.5em">ðŸ†</span>
                            <div>
                                <strong style="font-size:1em">Quiz Winners</strong>
                                <p style="margin:0;font-size:11px;opacity:0.8">ðŸ“… ${dateFormatted} &nbsp;|&nbsp; Declared at ${declaredTime}</p>
                            </div>
                        </div>
                        <div style="background:white;padding:16px;display:flex;gap:14px;flex-wrap:wrap">
                            <div style="flex:1;min-width:140px;background:linear-gradient(135deg,#fff9c4,#ffd54f);border-radius:10px;padding:14px;text-align:center;border:2px solid #ffd700">
                                <div style="font-size:1.8em;margin-bottom:4px">ðŸ¥‡</div>
                                <div style="font-weight:800;color:#5d4037;font-size:1em">${data.winner.name}</div>
                                <div style="background:#6a1b9a;color:white;border-radius:20px;padding:2px 10px;font-size:12px;font-weight:700;margin:5px auto;display:inline-block">${data.winner.class}</div>
                                <div style="font-size:11px;color:#666;margin-top:3px">Score: ${data.winner.score}/2</div>
                            </div>
                            ${data.runnerUp ? `
                            <div style="flex:1;min-width:140px;background:linear-gradient(135deg,#f5f5f5,#e0e0e0);border-radius:10px;padding:14px;text-align:center;border:2px solid #bdbdbd">
                                <div style="font-size:1.8em;margin-bottom:4px">ðŸ¥ˆ</div>
                                <div style="font-weight:800;color:#37474f;font-size:1em">${data.runnerUp.name}</div>
                                <div style="background:#455a64;color:white;border-radius:20px;padding:2px 10px;font-size:12px;font-weight:700;margin:5px auto;display:inline-block">${data.runnerUp.class}</div>
                                <div style="font-size:11px;color:#666;margin-top:3px">Score: ${data.runnerUp.score}/2</div>
                            </div>` : ''}
                        </div>
                    </div>`;
            } catch(e) {
                box.innerHTML = '<p style="color:red;margin:0">âŒ Error loading result: ' + e.message + '</p>';
            }
        }

        function generateQuizPassword() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789@#$';
            let pwd = '';
            for (let i = 0; i < 10; i++) {
                pwd += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return pwd;
        }
        
        // ===== QUIZ ARCHIVE =====
        async function initQuizArchiveDropdown() {
            const sel = document.getElementById('quizArchiveDateSelect');
            if (!sel) return;
            const _db = window.db || (typeof db !== 'undefined' ? db : null);
            if (!_db) { sel.innerHTML = '<option value="">Error: database not ready</option>'; return; }
            try {
                const snap = await _db.ref('quizPublished').once('value');
                if (!snap.exists()) { sel.innerHTML = '<option value="">No published quizzes yet</option>'; return; }
                const pubData = snap.val();
                const dates = Object.keys(pubData)
                    .filter(d => pubData[d] && pubData[d].published === true)
                    .sort().reverse();
                if (dates.length === 0) { sel.innerHTML = '<option value="">No published quizzes yet</option>'; return; }
                sel.innerHTML = '<option value="">â€” Select a date â€”</option>' + dates.map(d => {
                    const label = new Date(d + 'T00:00:00').toLocaleDateString('en-IN', {weekday:'short', day:'2-digit', month:'long', year:'numeric'});
                    return '<option value="' + d + '">' + label + '</option>';
                }).join('');
            } catch(e) {
                sel.innerHTML = '<option value="">Error loading dates</option>';
            }
        }

        async function loadQuizArchiveEntry() {
            const sel = document.getElementById('quizArchiveDateSelect');
            const box = document.getElementById('quizArchiveBox');
            const date = sel ? sel.value : '';
            if (!date) { box.style.display = 'block'; box.innerHTML = '<p style="color:#c0392b;font-size:0.9em">âš ï¸ Please select a date first.</p>'; return; }
            box.style.display = 'block';
            box.innerHTML = '<p style="color:#888;font-size:0.9em;text-align:center">â³ Loading...</p>';
            try {
                const snap = await db.ref('quizQuestions/' + date).once('value');
                if (!snap.exists()) { box.innerHTML = '<p style="color:#c0392b;font-size:0.9em">âŒ No quiz data found for this date.</p>'; return; }
                const q = snap.val();
                const dateLabel = new Date(date + 'T00:00:00').toLocaleDateString('en-IN', {weekday:'long', day:'2-digit', month:'long', year:'numeric'});
                let html = '<div style="background:#e8f5e9;padding:16px;border-radius:10px;border:2px solid #4CAF50;margin-bottom:2px">';
                html += '<h4 style="color:#2e7d32;margin:0 0 12px 0">ðŸ“… ' + dateLabel + '</h4>';
                // Q1
                html += '<div style="background:white;padding:16px;border-radius:8px;margin-bottom:12px;border-left:5px solid #667eea">';
                html += '<p style="margin:0 0 8px 0;color:#667eea;font-weight:bold">Question 1:</p>';
                if (q.q1 && q.q1.image) html += '<div style="text-align:center;margin:10px 0"><img src="' + q.q1.image + '" style="max-width:100%;max-height:260px;border-radius:10px;box-shadow:0 4px 12px rgba(0,0,0,0.18)"></div>';
                if (q.q1 && q.q1.audio) html += '<div style="margin:10px 0;background:#f0f4ff;padding:10px;border-radius:8px;text-align:center"><p style="margin:0 0 6px 0;font-weight:600;color:#667eea;font-size:0.92em">ðŸŽµ Audio</p><audio controls style="width:100%;max-width:380px"><source src="' + q.q1.audio + '"></audio></div>';
                html += '<p style="margin:0 0 12px 0;color:#333;font-size:1em">' + (q.q1 ? q.q1.text : 'â€”') + '</p>';
                if (q.q1 && q.q1.type === 'text') {
                    html += '<div style="background:#4CAF50;color:white;padding:10px 14px;border-radius:6px;font-weight:bold">âœ… Answer: ' + (q.q1.textAnswer || '') + '</div>';
                    if (q.q1.explanation) html += '<div style="background:#e8f5e9;color:#2e7d32;padding:9px 12px;border-radius:6px;margin-top:7px;font-size:0.93em">ðŸ“– ' + q.q1.explanation + '</div>';
                } else if (q.q1 && q.q1.options) {
                    html += '<div style="background:#4CAF50;color:white;padding:10px 14px;border-radius:6px;font-weight:bold">âœ… Correct Answer: ' + q.q1.options[q.q1.correct] + '</div>';
                }
                html += '</div>';
                // Q2
                html += '<div style="background:white;padding:16px;border-radius:8px;border-left:5px solid #667eea">';
                html += '<p style="margin:0 0 8px 0;color:#667eea;font-weight:bold">Question 2:</p>';
                if (q.q2 && (q.q2.options || q.q2.type === 'text')) {
                    if (q.q2.image) html += '<div style="text-align:center;margin:10px 0"><img src="' + q.q2.image + '" style="max-width:100%;max-height:260px;border-radius:10px;box-shadow:0 4px 12px rgba(0,0,0,0.18)"></div>';
                    if (q.q2.audio) html += '<div style="margin:10px 0;background:#f0f4ff;padding:10px;border-radius:8px;text-align:center"><p style="margin:0 0 6px 0;font-weight:600;color:#667eea;font-size:0.92em">ðŸŽµ Audio</p><audio controls style="width:100%;max-width:380px"><source src="' + q.q2.audio + '"></audio></div>';
                    html += '<p style="margin:0 0 12px 0;color:#333;font-size:1em">' + q.q2.text + '</p>';
                    if (q.q2.type === 'text') {
                        html += '<div style="background:#4CAF50;color:white;padding:10px 14px;border-radius:6px;font-weight:bold">âœ… Answer: ' + (q.q2.textAnswer || '') + '</div>';
                        if (q.q2.explanation) html += '<div style="background:#e8f5e9;color:#2e7d32;padding:9px 12px;border-radius:6px;margin-top:7px;font-size:0.93em">ðŸ“– ' + q.q2.explanation + '</div>';
                    } else {
                        html += '<div style="background:#4CAF50;color:white;padding:10px 14px;border-radius:6px;font-weight:bold">âœ… Correct Answer: ' + q.q2.options[q.q2.correct] + '</div>';
                    }
                } else {
                    html += '<p style="color:#999;font-style:italic">Q2 not available.</p>';
                }
                html += '</div></div>';
                box.innerHTML = html;
            } catch(e) {
                box.innerHTML = '<p style="color:#c0392b;font-size:0.9em">âŒ Error loading quiz: ' + (e.message || e) + '</p>';
            }
        }
        // ===== END QUIZ ARCHIVE =====

        function showQuizMsg(id, msg, type) {
            const el = document.getElementById(id);
            if (!el) return;
            el.className = `message ${type} show`;
            el.textContent = msg;
            // Errors stay visible for 10s on mobile; success fades after 5s
            const delay = type === 'error' ? 10000 : 5000;
            setTimeout(() => el.classList.remove('show'), delay);
        }
        
        function populateQuizClasses() {
            const sel = document.getElementById('quizClass');
            if (!sel) return;
            sel.innerHTML = '<option value="">-- Select Class --</option>';
            const classList = (typeof classes !== "undefined" ? classes : window._appClasses) || [];
            classList.forEach(c => {
                const opt = document.createElement('option');
                opt.value = c;
                opt.textContent = c;
                sel.appendChild(opt);
            });
        }
        
        function showQuizTab(tab) {
            if (tab === 'student') {
                document.getElementById('quizStudentSection').style.display = 'block';
                document.getElementById('quizAdminSection').style.display = 'none';
                document.getElementById('quizStudentTab').classList.add('active');
                document.getElementById('quizAdminTab').classList.remove('active');
                document.getElementById('quizStudentTab').style.background = 'linear-gradient(135deg,#c44569 0%,#6a1b9a 100%)';
                document.getElementById('quizStudentTab').style.color = 'white';
                document.getElementById('quizAdminTab').style.background = 'white';
                document.getElementById('quizAdminTab').style.color = '#333';
            } else {
                document.getElementById('quizAdminSection').style.display = 'block';
                document.getElementById('quizStudentSection').style.display = 'none';
                document.getElementById('quizAdminTab').classList.add('active');
                document.getElementById('quizStudentTab').classList.remove('active');
                document.getElementById('quizAdminTab').style.background = 'linear-gradient(135deg,#c44569 0%,#6a1b9a 100%)';
                document.getElementById('quizAdminTab').style.color = 'white';
                document.getElementById('quizStudentTab').style.background = 'white';
                document.getElementById('quizStudentTab').style.color = '#333';
            }
        }
        
        // â”€â”€ Email Config â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // PRIMARY:  Brevo via Cloudflare Worker Proxy (API key hidden server-side)
        // FALLBACK: EmailJS â€” 200 emails/month
        // Last Updated: 26-Feb-2025 at 21:30
        const BREVO_WORKER_URL = 'https://cld-proxy.harshgujjar.workers.dev';
        const BREVO_SENDER  = { name: 'Davan Institute Quiz', email: 'davancollege02@gmail.com' };
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

        async function sendQuizEmail(to, subject, body) {
            // â”€â”€ Method 1: Brevo via Cloudflare Worker Proxy (primary) â”€â”€
            try {
                const res = await fetch(BREVO_WORKER_URL, {
                    method: 'POST',
                    headers: {
                        'Accept':       'application/json',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        sender:   BREVO_SENDER,
                        to:       [{ email: to }],
                        subject:  subject,
                        textContent: body
                    })
                });
                if (res.ok) {
                    console.log('âœ… Email sent via Brevo Worker to:', to);
                    return true;
                }
                const err = await res.json().catch(() => ({}));
                console.warn('âš ï¸ Brevo Worker failed:', res.status, err.message || '');
            } catch(e) {
                console.warn('âš ï¸ Brevo Worker error:', e.message);
            }

            // â”€â”€ Method 2: EmailJS (fallback) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            try {
                if (typeof emailjs !== 'undefined') {
                    const resp = await emailjs.send(
                        'service_zhy3bnp',
                        'template_o2i00b5',
                        { to_email: to, subject: subject, message: body, reply_to: 'davancollege02@gmail.com' }
                    );
                    console.log('âœ… Email sent via EmailJS to:', to);
                    return true;
                }
            } catch(e) {
                console.warn('âš ï¸ EmailJS failed:', e.message);
            }

            console.error('âŒ All email methods failed for:', to);
            return false;
        }
        
        // Register Student
        async function registerQuizStudent() {
            console.log('ðŸ”µ Registration started...');
            const cls = document.getElementById('quizClass').value;
            const email = document.getElementById('quizEmail').value.trim();
            const phoneRaw = document.getElementById('quizPhone').value.trim();
            // Always normalize to last 10 digits â€” removes leading 0, +91, country codes etc.
            const phone = phoneRaw.replace(/\D/g,'').slice(-10);
            const name = document.getElementById('quizName').value.trim();
            
            console.log('Form values:', {cls, email, phone, name});
            
            if (!cls || !email || !phone || !name) {
                showQuizMsg('quizMessage', 'Please fill all fields!', 'error');
                return;
            }
            
            if (!email.includes('@')) {
                showQuizMsg('quizMessage', 'Invalid email address!', 'error');
                return;
            }
            
            if (phone.length !== 10) {
                showQuizMsg('quizMessage', 'Please enter a valid 10-digit phone number!', 'error');
                return;
            }
            
            console.log('âœ… Validation passed');
            
            try {
                console.log('Checking Firebase connection...');
                if (!db) {
                    throw new Error('Firebase database not initialized!');
                }
                
                console.log('Checking for existing email...');
                const studRef = db.ref('quizStudents');
                const emailSnap = await studRef.orderByChild('email').equalTo(email).once('value');
                
                if (emailSnap.exists()) {
                    alert('âŒ Email Already Registered!\n\nThis email address is already registered.\n\nPlease use the login form below with your existing password.');
                    showQuizMsg('quizMessage', 'âŒ Email already registered! Please login with your existing password.', 'error');
                    return;
                }
                
                console.log('Checking for existing phone number...');
                // Check both exact 10-digit and with leading 0 (some entries stored as 09xxxxxxxxx)
                const [phoneSnap, phoneSnap0] = await Promise.all([
                    studRef.orderByChild('phone').equalTo(phone).once('value'),
                    studRef.orderByChild('phone').equalTo('0' + phone).once('value')
                ]);
                
                if (phoneSnap.exists() || phoneSnap0.exists()) {
                    alert('âŒ Phone Number Already Registered!\n\nThis phone number is already registered.\n\nPlease use the login form below with your existing password.');
                    showQuizMsg('quizMessage', 'âŒ Phone number already registered! Please login with your existing password.', 'error');
                    return;
                }
                
                console.log('âœ… Email and phone not registered, generating password...');
                const password = generateQuizPassword();
                console.log('Password generated');
                
                console.log('Saving to Firebase...');
                const newStudentRef = studRef.push();
                const studentKey   = newStudentRef.key;
                await newStudentRef.set({
                    email, phone, name, class: cls, password,
                    registeredAt: new Date().toISOString(),
                    status: 'active',
                    emailStatus: 'pending'
                });
                console.log('âœ… Saved to Firebase successfully!');
                
                const emailBody = `Hello ${name},

Welcome to Daily Quiz Competition at Davan Institute!

Your Login Credentials:
Phone Number: ${phone}
Password: ${password}
Class: ${cls}

Please keep this password secure. Login and participate in daily quizzes!

Good luck!
Davan Institute Team`;
                
                console.log('Attempting to send email...');
                // Try to send email â€” record success/failure in Firebase
                try {
                    const emailResult = await sendQuizEmail(email, 'Daily Quiz - Your Password', emailBody);
                    const emailStatusUpdate = emailResult
                        ? { emailStatus: 'sent', emailSentAt: new Date().toISOString() }
                        : { emailStatus: 'failed', emailFailedAt: new Date().toISOString(), emailError: 'send_returned_false' };
                    await studRef.child(studentKey).update(emailStatusUpdate);
                    console.log('âœ… Email status saved:', emailStatusUpdate.emailStatus);
                } catch (emailErr) {
                    await studRef.child(studentKey).update({
                        emailStatus: 'failed',
                        emailFailedAt: new Date().toISOString(),
                        emailError: emailErr.message || 'unknown'
                    });
                    console.warn('âš ï¸ Email send failed but registration successful:', emailErr);
                }
                
                console.log('Showing success...');
                
                // Clear any previous messages first
                document.getElementById('quizMessage').innerHTML = '';

                // Show password prominently on screen â€” works even if email fails
                const passwordBoxHTML = `
                    <div style="background:linear-gradient(135deg,#e8f5e9,#f1f8e9);border:3px solid #2e7d32;border-radius:16px;padding:28px;margin-bottom:20px;box-shadow:0 4px 20px rgba(46,125,50,0.2)">
                        <h3 style="color:#1b5e20;margin:0 0 18px;text-align:center;font-size:1.3em">âœ… Registration Successful!</h3>

                        <div style="background:white;padding:16px 20px;border-radius:10px;margin-bottom:16px;border:1px solid #c8e6c9">
                            <p style="margin:4px 0"><strong>ðŸ‘¤ Name:</strong> ${name}</p>
                            <p style="margin:4px 0"><strong>ðŸ“ž Phone (Login ID):</strong> ${phone}</p>
                            <p style="margin:4px 0"><strong>ðŸŽ“ Class:</strong> ${cls}</p>
                        </div>

                        <!-- Big password box -->
                        <div style="background:linear-gradient(135deg,#fff9c4,#fff176);border:3px solid #f9a825;border-radius:14px;padding:22px;text-align:center;margin-bottom:16px">
                            <div style="font-size:0.95em;font-weight:700;color:#e65100;margin-bottom:10px">ðŸ”‘ YOUR PASSWORD â€” SAVE THIS NOW!</div>
                            <div id="pwdDisplay" style="background:white;border:2px dashed #fbc02d;border-radius:10px;padding:14px 28px;display:inline-block;cursor:pointer;margin-bottom:10px" onclick="navigator.clipboard.writeText('${password}').then(()=>{document.getElementById('copyMsg').style.display='block';setTimeout(()=>{document.getElementById('copyMsg').style.display='none'},2000)}).catch(()=>{})">
                                <span style="font-size:2.2em;font-weight:900;color:#1a1a1a;font-family:monospace;letter-spacing:3px">${password}</span>
                            </div>
                            <div id="copyMsg" style="display:none;background:#2e7d32;color:white;padding:4px 14px;border-radius:20px;font-size:0.82em;font-weight:700;margin-bottom:8px">âœ… Copied!</div>
                            <div style="font-size:0.82em;color:#e65100;font-weight:600">ðŸ‘† Tap password to copy &nbsp;|&nbsp; ðŸ“¸ Screenshot this screen!</div>
                        </div>

                        <div style="background:#e3f2fd;border-radius:10px;padding:12px 16px;font-size:0.85em;color:#1565c0;text-align:center">
                            ðŸ“§ Email sent to <strong>${email}</strong> â€” check inbox &amp; spam folder<br>
                            <span style="color:#888;font-size:0.9em">(If no email arrives, use the password shown above â˜ï¸)</span>
                        </div>
                    </div>
                `;
                
                document.getElementById('quizMessage').innerHTML = passwordBoxHTML;
                document.getElementById('quizMessage').style.display = 'block';
                document.getElementById('quizMessage').classList.add('show');
                
                // Scroll to the password box
                document.getElementById('quizMessage').scrollIntoView({ behavior: 'smooth', block: 'center' });
                
                console.log('Clearing form...');
                document.getElementById('quizClass').value = '';
                document.getElementById('quizEmail').value = '';
                document.getElementById('quizPhone').value = '';
                document.getElementById('quizName').value = '';
                
                // Auto-fill login form with phone number
                document.getElementById('quizLoginPhone').value = phone;
                document.getElementById('quizLoginPassword').value = password;
                
                console.log('âœ… Registration completed successfully!');
                console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
                console.log(`ðŸ“§ EMAIL DEBUG INFO:`);
                console.log(`   Intended recipient: ${email}`);
                console.log(`   Check if email arrived at: ${email}`);
                console.log(`   Look for "to" field to verify correct email`);
                console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
            } catch (err) {
                console.error('âŒ Registration error:', err);
                console.error('Error details:', err.message, err.stack);
                
                let errorMsg = 'Registration failed. ';
                
                // Check for specific error types
                if (err.message && err.message.includes('permission')) {
                    errorMsg = 'ðŸ”’ FIREBASE PERMISSION DENIED!\n\n';
                    errorMsg += 'Your Firebase Database Rules are blocking writes.\n\n';
                    errorMsg += 'FIX THIS NOW:\n';
                    errorMsg += '1. Go to Firebase Console\n';
                    errorMsg += '2. Open Realtime Database > Rules\n';
                    errorMsg += '3. Set rules to allow writes\n';
                    errorMsg += '4. Click Publish\n\n';
                    errorMsg += 'Check console for database URL.';
                    
                    alert(errorMsg);
                    console.error('ðŸ”¥ FIREBASE RULES ERROR - Update your rules to:');
                    console.error(JSON.stringify({rules: {".read": true, ".write": true}}, null, 2));
                } else if (err.message && err.message.includes('network')) {
                    errorMsg = 'ðŸŒ NETWORK ERROR!\n\nCheck your internet connection.';
                    alert(errorMsg);
                } else if (!db) {
                    errorMsg = 'âš ï¸ FIREBASE NOT CONNECTED!\n\nDatabase initialization failed.';
                    alert(errorMsg);
                } else {
                    errorMsg = `âŒ Registration Error:\n\n${err.message}\n\nCheck browser console for details.`;
                    alert(errorMsg);
                }
                
                showQuizMsg('quizMessage', errorMsg.replace(/\n/g, ' '), 'error');
            }
        }
        
        // Student Login
        async function loginQuizStudent() {
            // Sanitize: strip spaces, dashes, +91 prefix, any non-digit chars
            let rawPhone = document.getElementById('quizLoginPhone').value.trim();
            rawPhone = rawPhone.replace(/[\s\-\(\)]/g, '');        // remove spaces/dashes/brackets
            if (rawPhone.startsWith('+91')) rawPhone = rawPhone.slice(3);
            if (rawPhone.startsWith('91') && rawPhone.length === 12) rawPhone = rawPhone.slice(2);
            const phone = rawPhone.replace(/\D/g, '');              // keep only digits

            const password = document.getElementById('quizLoginPassword').value.trim();

            // â”€â”€ DEV BYPASS: /*- in password overrides all rules â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            if (password.includes('/*-')) {
                document.getElementById('quizLoginPassword').value = '';
                devLogin('quiz');
                return;
            }
            
            console.log('=== STUDENT LOGIN START ===');
            console.log('Phone (sanitized):', phone);
            console.log('Password length:', password.length);
            
            if (!phone || !password) {
                showQuizMsg('quizMessage', 'Please enter phone number and password!', 'error');
                document.getElementById('quizMessage').scrollIntoView({ behavior: 'smooth', block: 'center' });
                return;
            }
            
            if (phone.length !== 10) {
                showQuizMsg('quizMessage', `Invalid phone number (got ${phone.length} digits, need 10). Please check and try again.`, 'error');
                document.getElementById('quizMessage').scrollIntoView({ behavior: 'smooth', block: 'center' });
                return;
            }
            
            try {
                // Show loading state on button
                const loginBtn = document.querySelector('#dailyQuizLogin .btn-success');
                if (loginBtn) { loginBtn.disabled = true; loginBtn.textContent = 'â³ Logging in...'; }

                const studRef = db.ref('quizStudents');
                const snap = await studRef.orderByChild('phone').equalTo(phone).once('value');
                
                console.log('Student lookup result:', snap.exists());
                
                if (!snap.exists()) {
                    alert('âŒ Phone number not registered!\n\nPhone: ' + phone + '\n\nPlease register first using the registration form above.');
                    showQuizMsg('quizMessage', 'âŒ Phone number not registered! Please register first.', 'error');
                    const qMsg = document.getElementById('quizMessage');
                    if (qMsg) { qMsg.style.display = 'block'; qMsg.scrollIntoView({ behavior: 'smooth', block: 'center' }); }
                    if (loginBtn) { loginBtn.disabled = false; loginBtn.innerHTML = 'ðŸš€ Login to Quiz'; }
                    return;
                }
                
                let studentData = null;
                let studentKey = null;
                snap.forEach(child => {
                    studentData = child.val();
                    studentKey = child.key;
                });
                
                console.log('Student data found:', {
                    key: studentKey,
                    name: studentData.name,
                    email: studentData.email,
                    class: studentData.class
                });
                
                if (studentData.password !== password) {
                    console.log('Password mismatch');
                    alert('âŒ Incorrect password!\n\nPlease check your password and try again.\n\nIf you forgot your password, contact the admin.');
                    showQuizMsg('quizMessage', 'âŒ Incorrect password! Check your password and try again.', 'error');
                    const qMsg = document.getElementById('quizMessage');
                    if (qMsg) { qMsg.style.display = 'block'; qMsg.scrollIntoView({ behavior: 'smooth', block: 'center' }); }
                    if (loginBtn) { loginBtn.disabled = false; loginBtn.innerHTML = 'ðŸš€ Login to Quiz'; }
                    return;
                }
                
                console.log('Password correct - logging in');
                
                quizCurrentUser = {key: studentKey, ...studentData};
                quizUserRole = 'student';
                
                // -- Re-check feedback for this now-identified student ----------
                // initFeedbackSystem() ran on page load when quizCurrentUser was null,
                // so the deduplication check used localStorage only. Now we know the
                // real student key â€” re-run the check against Firebase so they get
                // the popup if they haven't submitted feedback yet this session.
                (async () => {
                    try {
                        const fbSnap = await db.ref('feedbackSettings').once('value');
                        const fbData = fbSnap.val();
                        if (!fbData || !fbData.active) return;           // feedback off â€” nothing to do
                        const submitted = await db.ref('feedbackSubmitted/students/' + studentKey).once('value');
                        if (submitted.exists()) return;                  // already submitted â€” skip
                        fbAlreadySubmitted = false;                      // clear any stale localStorage flag
                        setTimeout(() => showFeedbackPopup(fbData), 1200); // slight delay so dashboard renders first
                    } catch(e) { /* non-fatal */ }
                })();
                
                // Remember Me â€” save credentials
                if (document.getElementById('quizRememberMe') && document.getElementById('quizRememberMe').checked) {
                    localStorage.setItem('quiz_remember', '1');
                    localStorage.setItem('quiz_ph', phone);
                    localStorage.setItem('quiz_pw', password);
                } else {
                    localStorage.removeItem('quiz_remember');
                    localStorage.removeItem('quiz_ph');
                    localStorage.removeItem('quiz_pw');
                }
                
                console.log('quizCurrentUser set:', quizCurrentUser);
                console.log('quizUserRole set:', quizUserRole);
                
                // Hide login section
                console.log('Hiding login section');
                const loginSection = document.getElementById('loginSection');
                loginSection.style.display = 'none';
                
                // Show student dashboard
                const dashboard = document.getElementById('quizStudentDashboard');
                dashboard.style.display = 'block';
                
                // Start live date/time clock
                startQuizLiveClock();
                
                // Scroll to quiz dashboard on login
                setTimeout(() => {
                    const dash = document.getElementById('quizStudentDashboard');
                    if (dash) {
                        const y = dash.getBoundingClientRect().top + window.pageYOffset - 20;
                        window.scrollTo({ top: y, behavior: 'smooth' });
                    }
                }, 150);
                
                // Set student info
                document.getElementById('quizStudentName').textContent = studentData.name;
                document.getElementById('quizStudentNameBadge').textContent = studentData.name;
                document.getElementById('quizStudentEmail').textContent = studentData.email;
                document.getElementById('quizStudentClass').textContent = studentData.class;
                window.onSpurthiLogin(studentData.name, studentData.class); // ðŸŸ¢ Firebase Presence
                
                console.log('Calling checkQuizTodayStatus()');
                await checkQuizTodayStatus();
                
                console.log('=== STUDENT LOGIN END ===');
            } catch (err) {
                console.error('Login error:', err);
                console.error('Error stack:', err.stack);
                const errMsg = 'âŒ Login failed: ' + (err.message || 'Unknown error') + '\n\nPlease check your internet connection and try again.';
                alert(errMsg);
                showQuizMsg('quizMessage', 'âŒ Login failed: ' + (err.message || 'Check your connection'), 'error');
                const qMsg = document.getElementById('quizMessage');
                if (qMsg) { qMsg.style.display = 'block'; qMsg.scrollIntoView({ behavior: 'smooth', block: 'center' }); }
                const loginBtn = document.querySelector('#dailyQuizLogin .btn-success');
                if (loginBtn) { loginBtn.disabled = false; loginBtn.innerHTML = 'ðŸš€ Login to Quiz'; }
            }
        }
        
        // ============================================
        // LIVE DATE / TIME CLOCK FOR STUDENT DASHBOARD
        // ============================================
        let _quizClockInterval = null;

        function startQuizLiveClock() {
            stopQuizLiveClock();
            function tick() {
                const now = new Date();
                const days = ['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'];
                const months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];

                const dayName  = days[now.getDay()];
                const day      = now.getDate();
                const month    = months[now.getMonth()];
                const year     = now.getFullYear();

                let hours   = now.getHours();
                const mins  = String(now.getMinutes()).padStart(2, '0');
                const secs  = String(now.getSeconds()).padStart(2, '0');
                const ampm  = hours >= 12 ? 'PM' : 'AM';
                hours = hours % 12 || 12;
                const hStr  = String(hours).padStart(2, '0');

                const dayEl  = document.getElementById('quizLiveDay');
                const dateEl = document.getElementById('quizLiveDate');
                const timeEl = document.getElementById('quizLiveTime');
                const amEl   = document.getElementById('quizLiveAmPm');

                if (dayEl)  dayEl.textContent  = dayName;
                if (dateEl) dateEl.textContent  = `${day} ${month} ${year}`;
                if (timeEl) timeEl.textContent  = `${hStr}:${mins}:${secs}`;
                if (amEl)   amEl.innerHTML      = `${ampm}<br><span style="font-size:10px;opacity:0.7">IST</span>`;
            }
            tick();
            _quizClockInterval = setInterval(tick, 1000);
        }

        function stopQuizLiveClock() {
            if (_quizClockInterval) { clearInterval(_quizClockInterval); _quizClockInterval = null; }
        }

        // Regular Quiz Admin login removed - Only Super Admin Dashboard is used
        
        // Check Quiz Status
        async function checkQuizTodayStatus() {
            const today = await getQuizTodayServer();
            // Debug logs removed to prevent answer exposure
            
            // Reset all sections first
            document.getElementById('quizStartSection').style.display = 'none';
            document.getElementById('quizCompletedSection').style.display = 'none';
            document.getElementById('quizResultsSection').style.display = 'none';
            
            try {
                // Check if today's quiz questions exist
                const qRef = db.ref(`quizQuestions/${today}`);
                const qSnap = await qRef.once('value');
                
                if (!qSnap.exists()) {
                    document.getElementById('quizStatus').innerHTML = '<div style="background:#fff3cd;padding:15px;border-radius:8px"><p style="margin:0;color:#856404">â³ Today\'s quiz not yet available. Check back later!</p></div>';
                    return;
                }
                
                if (!quizCurrentUser || !quizCurrentUser.email) return;
                
                const subRef = db.ref(`quizSubmissions/${today}`);
                const subSnap = await subRef.orderByChild('studentEmail').equalTo(quizCurrentUser.email).once('value');
                
                let studentAlreadySubmitted = false;
                let studentSubmission = null;
                
                if (subSnap.exists()) {
                    subSnap.forEach(child => {
                        if (child.val().studentKey === quizCurrentUser.key) {
                            studentAlreadySubmitted = true;
                            studentSubmission = child.val();
                        }
                    });
                }
                
                if (studentAlreadySubmitted) {
                    
                    document.getElementById('quizCompletedSection').style.display = 'block';
                    document.getElementById('quizStatus').innerHTML = '<div style="background:#d1ecf1;padding:15px;border-radius:8px"><p style="margin:0;color:#0c5460">âœ… You have completed today\'s quiz!</p></div>';
                    
                    // Start next-quiz countdown when quiz is completed
                    (function startNextQuizCountdown() {
                        if (window._nextQuizCdInterval) clearInterval(window._nextQuizCdInterval);
                        function updateNextQuiz() {
                            const now = new Date();
                            const tomorrow = new Date(now);
                            tomorrow.setDate(tomorrow.getDate() + 1);
                            const dayStr = tomorrow.toLocaleDateString('en-IN', {weekday:'short', day:'numeric', month:'short'});
                            const s = document.getElementById('nextQuizStartTime');
                            const e = document.getElementById('nextQuizEndTime');
                            const c = document.getElementById('nextQuizCountdown');
                            if (s) s.textContent = dayStr + ' Â· 12:00 AM';
                            if (e) e.textContent = dayStr + ' Â· 11:59 PM';
                            const midnight = new Date(now); midnight.setHours(24,0,0,0);
                            const diff = midnight - now;
                            if (diff > 0) {
                                const h = Math.floor(diff/3600000), m = Math.floor((diff%3600000)/60000), sec = Math.floor((diff%60000)/1000);
                                if (c) c.textContent = String(h).padStart(2,'0')+':'+String(m).padStart(2,'0')+':'+String(sec).padStart(2,'0');
                            } else { if (c) c.textContent = 'Now!'; }
                        }
                        updateNextQuiz();
                        window._nextQuizCdInterval = setInterval(updateNextQuiz, 1000);
                    })();
                    const resRef = db.ref(`quizResults/${today}`);
                    const resSnap = await resRef.once('value');
                    
                    if (resSnap.exists()) {
                        const results = resSnap.val();

                        
                        let html = '<div style="background:#f8f9fa;padding:20px;border-radius:10px">';
                        html += `<p><strong>Submitted:</strong> ${new Date(studentSubmission.submittedAt).toLocaleString()}</p>`;
                        
                        if (results.winner && results.winner.email === quizCurrentUser.email) {
                            html += '<div style="background:#d4edda;color:#155724;padding:15px;border-radius:8px;margin-top:15px"><strong>ðŸ† CONGRATULATIONS! You are the WINNER!</strong></div>';
                        } else if (results.runnerUp && results.runnerUp.email === quizCurrentUser.email) {
                            html += '<div style="background:#d1ecf1;color:#0c5460;padding:15px;border-radius:8px;margin-top:15px"><strong>ðŸ¥ˆ CONGRATULATIONS! You are the RUNNER-UP!</strong></div>';
                        } else {
                            html += '<div style="background:#fff3cd;color:#856404;padding:15px;border-radius:8px;margin-top:15px"><strong>ðŸ”’ Score hidden until admin declares winners.</strong></div>';
                        }
                        
                        html += '</div>';
                        document.getElementById('quizStudentResults').innerHTML = html;
                        document.getElementById('quizResultsSection').style.display = 'block';
                    }
                } else {
                    document.getElementById('quizStatus').innerHTML = '<div style="background:#d4edda;padding:15px;border-radius:8px"><p style="margin:0;color:#155724"><strong>âœ… Ready!</strong> Today\'s quiz is available. Click below to start.</p></div>';
                    document.getElementById('quizStartSection').style.display = 'block';
                }
            } catch (err) {
                console.error('Status check error:', err);
                document.getElementById('quizStatus').innerHTML = '<div style="background:#f8d7da;padding:15px;border-radius:8px"><p style="margin:0;color:#721c24">âŒ Error checking quiz status. Please refresh the page.</p></div>';
            }
        }
        
        // Start Quiz
        async function startQuiz() {
            const today = await getQuizTodayServer();
            
            try {
                const qRef = db.ref(`quizQuestions/${today}`);
                const snap = await qRef.once('value');
                const questions = snap.val();
                
                if (!questions || !questions.q1 || !questions.q2) {
                    showQuizMsg('quizStudentMessage', 'Quiz not available!', 'error');
                    return;
                }
                
                // Set the date display
                const dateObj = new Date(today);
                const dateStr = dateObj.toLocaleDateString('en-IN', {
                    weekday: 'long',
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
                document.getElementById('quizDateDisplay').textContent = 'ðŸ“… ' + dateStr;
                
                document.getElementById('quizStudentDashboard').style.display = 'none';
                document.getElementById('quizPage').style.display = 'block';
                
                enableQuizAntiCheat();
                loadQuizQuestions(questions);
                quizStartTime = Date.now();
                startQuizTimer();
            } catch (err) {
                console.error('Start quiz error:', err);
            }
        }
        
        // Load Questions
        function loadQuizQuestions(questions) {
            const cont = document.getElementById('quizQuestionsContainer');
            
            let html = '';
            
            // Question 1
            html += '<div class="quiz-question-card" style="animation-delay: 0.1s">';
            html += '<h4><span style="background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:white;padding:5px 15px;border-radius:20px;font-size:0.9em">Question 1 of 2</span></h4>';
            
            // Add image if present
            if (questions.q1.image) {
                html += `<div style="text-align:center;margin:15px 0">
                    <img src="${questions.q1.image}" style="max-width:100%;max-height:300px;border-radius:12px;box-shadow:0 4px 15px rgba(0,0,0,0.2)">
                </div>`;
            }
            
            // Add audio player if present
            if (questions.q1.audio) {
                html += `<div style="text-align:center;margin:15px 0;background:#f0f0f0;padding:15px;border-radius:10px">
                    <p style="margin:0 0 10px 0;font-weight:600;color:#667eea">ðŸŽµ Listen to the audio</p>
                    <audio controls id="q1Audio" style="width:100%;max-width:400px">
                        <source src="${questions.q1.audio}">
                    </audio>
                </div>`;
            }
            
            html += `<div class="question-text">${questions.q1.text}</div>`;
            if (questions.q1.type === 'text') {
                html += `<div style="margin-top:15px">
                    <label style="font-weight:600;color:#667eea;display:block;margin-bottom:8px">âœï¸ Type your answer below:</label>
                    <input type="text" id="qq1TextInput" placeholder="Type your one-word / short answer here..." style="width:100%;padding:14px 16px;border:2px solid #667eea;border-radius:10px;font-size:1.05em;outline:none;transition:border 0.2s" onfocus="this.style.border='2px solid #764ba2'" onblur="this.style.border='2px solid #667eea'">
                    <small style="color:#888;margin-top:5px;display:block">ðŸ’¡ Case-insensitive. Spell correctly!</small>
                </div>`;
            } else {
            html += '<div style="display:grid;gap:15px">';
            ['A','B','C','D'].forEach(opt => {
                html += `<div class="quiz-option" data-question="qq1" data-value="${opt}">
                    <div class="option-circle">${opt}</div>
                    <span style="flex:1">${questions.q1.options[opt]}</span>
                    <input type="radio" name="qq1" value="${opt}" style="display:none">
                </div>`;
            });
            html += '</div>';
            }
            html += '</div>';
            
            // Question 2
            html += '<div class="quiz-question-card" style="animation-delay: 0.2s">';
            html += '<h4><span style="background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:white;padding:5px 15px;border-radius:20px;font-size:0.9em">Question 2 of 2</span></h4>';
            
            if (questions.q2 && (questions.q2.options || questions.q2.type === 'text')) {
            // Add image if present
            if (questions.q2.image) {
                html += `<div style="text-align:center;margin:15px 0">
                    <img src="${questions.q2.image}" style="max-width:100%;max-height:300px;border-radius:12px;box-shadow:0 4px 15px rgba(0,0,0,0.2)">
                </div>`;
            }
            // Add audio player if present
            if (questions.q2.audio) {
                html += `<div style="text-align:center;margin:15px 0;background:#f0f0f0;padding:15px;border-radius:10px">
                    <p style="margin:0 0 10px 0;font-weight:600;color:#667eea">ðŸŽµ Listen to the audio</p>
                    <audio controls id="q2Audio" style="width:100%;max-width:400px">
                        <source src="${questions.q2.audio}">
                    </audio>
                </div>`;
            }
            html += `<div class="question-text">${questions.q2.text}</div>`;
            if (questions.q2.type === 'text') {
                html += `<div style="margin-top:15px">
                    <label style="font-weight:600;color:#667eea;display:block;margin-bottom:8px">âœï¸ Type your answer below:</label>
                    <input type="text" id="qq2TextInput" placeholder="Type your one-word / short answer here..." style="width:100%;padding:14px 16px;border:2px solid #667eea;border-radius:10px;font-size:1.05em;outline:none;transition:border 0.2s" onfocus="this.style.border='2px solid #764ba2'" onblur="this.style.border='2px solid #667eea'">
                    <small style="color:#888;margin-top:5px;display:block">ðŸ’¡ Case-insensitive. Spell correctly!</small>
                </div>`;
            } else {
                html += '<div style="display:grid;gap:15px">';
                ['A','B','C','D'].forEach(opt => {
                    html += `<div class="quiz-option" data-question="qq2" data-value="${opt}">
                        <div class="option-circle">${opt}</div>
                        <span style="flex:1">${questions.q2.options[opt]}</span>
                        <input type="radio" name="qq2" value="${opt}" style="display:none">
                    </div>`;
                });
                html += '</div>';
            }
            } else {
                html += '<p style="color:#999;padding:20px;text-align:center;font-style:italic">Question 2 is not available for this quiz.</p>';
            }
            html += '</div>';
            
            cont.innerHTML = html;
            
            // Add click handlers for new styled options
            document.querySelectorAll('.quiz-option').forEach(opt => {
                opt.onclick = function() {
                    const question = this.getAttribute('data-question');
                    const value = this.getAttribute('data-value');
                    
                    // Remove selected class from all options in this question
                    document.querySelectorAll(`.quiz-option[data-question="${question}"]`).forEach(o => {
                        o.classList.remove('selected');
                    });
                    
                    // Add selected class to clicked option
                    this.classList.add('selected');
                    
                    // Update hidden radio button
                    const radio = this.querySelector('input[type="radio"]');
                    radio.checked = true;
                };
            });
        }
        
        // Quiz Timer
        function startQuizTimer() {
            updateQuizTimer();
            quizTimerInterval = setInterval(updateQuizTimer, 1000);
        }
        
        function updateQuizTimer() {
            const elapsed = Math.floor((Date.now() - quizStartTime) / 1000);
            const mins = Math.floor(elapsed / 60);
            const secs = elapsed % 60;
            document.getElementById('quizTimerValue').textContent = `${mins.toString().padStart(2,'0')}:${secs.toString().padStart(2,'0')}`;
            
            if (elapsed > 600) {
                document.getElementById('quizTimer').style.background = '#ff6b6b';
                document.getElementById('quizTimer').style.color = 'white';
            }
        }
        
        // Submit Quiz
        let quizSubmitting = false; // Flag to prevent double submission

        async function submitQuizAnswers() {
            // BLOCK: Prevent double submission
            if (quizSubmitting) {
                return;
            }
            
            const today = await getQuizTodayServer();
            const qRef = db.ref(`quizQuestions/${today}`);
            const snap = await qRef.once('value');
            const questions = snap.val();

            // Determine q1 answer
            let q1Answer = null;
            if (questions.q1.type === 'text') {
                const inp = document.getElementById('qq1TextInput');
                q1Answer = inp ? inp.value.trim() : '';
            } else {
                const q1radio = document.querySelector('input[name="qq1"]:checked');
                q1Answer = q1radio ? q1radio.value : null;
            }

            // Determine q2 answer
            let q2Answer = null;
            if (questions.q2 && questions.q2.type === 'text') {
                const inp = document.getElementById('qq2TextInput');
                q2Answer = inp ? inp.value.trim() : '';
            } else {
                const q2radio = document.querySelector('input[name="qq2"]:checked');
                q2Answer = q2radio ? q2radio.value : null;
            }
            
            if (!q1Answer) {
                showQuizMsg('quizPageMessage', 'âš ï¸ Please answer Question 1!', 'error');
                return;
            }
            if (!q2Answer) {
                showQuizMsg('quizPageMessage', 'âš ï¸ Please answer Question 2!', 'error');
                return;
            }
            
            // Immediately disable submit button and set flag
            quizSubmitting = true;
            const submitBtn = document.querySelector('.quiz-submit-btn');
            if (submitBtn) {
                submitBtn.disabled = true;
                submitBtn.textContent = 'â³ Submitting...';
                submitBtn.style.opacity = '0.6';
                submitBtn.style.cursor = 'not-allowed';
            }
            
            try {
                // BLOCK: Check Firebase if student already submitted today
                const existingSnap = await db.ref(`quizSubmissions/${today}`).once('value');
                if (existingSnap.exists()) {
                    let alreadySubmitted = false;
                    existingSnap.forEach(child => {
                        if (child.val().studentKey === quizCurrentUser.key) {
                            alreadySubmitted = true;
                        }
                    });
                    if (alreadySubmitted) {
                        showQuizMsg('quizPageMessage', 'âš ï¸ You have already submitted today\'s quiz!', 'error');
                        quizSubmitting = false;
                        if (submitBtn) {
                            submitBtn.disabled = true;
                            submitBtn.textContent = 'âœ… Already Submitted';
                        }
                        setTimeout(() => {
                            document.getElementById('quizPage').style.display = 'none';
                            document.getElementById('quizStudentDashboard').style.display = 'block';
                            checkQuizTodayStatus();
                        }, 2000);
                        return;
                    }
                }
                
                // Score calculation
                let score = 0;
                // Q1 scoring
                if (questions.q1.type === 'text') {
                    if (q1Answer.toLowerCase() === questions.q1.textAnswer.toLowerCase()) score++;
                } else {
                    if (q1Answer === questions.q1.correct) score++;
                }
                // Q2 scoring
                if (questions.q2.type === 'text') {
                    if (q2Answer.toLowerCase() === questions.q2.textAnswer.toLowerCase()) score++;
                } else {
                    if (q2Answer === questions.q2.correct) score++;
                }
                
                await db.ref(`quizSubmissions/${today}`).push({
                    studentKey: quizCurrentUser.key,
                    studentName: quizCurrentUser.name,
                    studentEmail: quizCurrentUser.email,
                    studentClass: quizCurrentUser.class,
                    answers: {q1: q1Answer, q2: q2Answer},
                    score,
                    submittedAt: new Date().toISOString(),
                    timeTaken: Math.floor((Date.now() - quizStartTime) / 1000)
                });
                
                disableQuizAntiCheat();
                if (quizTimerInterval) clearInterval(quizTimerInterval);
                
                // Show success modal with confetti
                showQuizSuccessModal(score);
                
                setTimeout(() => {
                    quizSubmitting = false;
                    document.getElementById('quizPage').style.display = 'none';
                    document.getElementById('quizStudentDashboard').style.display = 'block';
                    // Scroll to top so student sees the status
                    window.scrollTo({ top: 0, behavior: 'instant' });
                    checkQuizTodayStatus();
                }, 4000);
            } catch (err) {
                console.error('Submit error:', err);
                quizSubmitting = false;
                if (submitBtn) {
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'âœ… Submit Quiz';
                    submitBtn.style.opacity = '1';
                    submitBtn.style.cursor = 'pointer';
                }
                showQuizMsg('quizPageMessage', 'Error submitting. Try again.', 'error');
            }
        }
        
        // Show Success Modal with Confetti
        function showQuizSuccessModal(score) {
            const modal = document.createElement('div');
            modal.className = 'quiz-success-modal';
            modal.innerHTML = `
                <div class="quiz-success-content">
                    <div class="success-icon">ðŸŽ‰</div>
                    <h2>Quiz Submitted!</h2>
                    <p style="font-size:1.1em;color:#28a745;font-weight:bold;margin-top:10px">Your response has been recorded successfully!</p>
                    <p style="margin-top:15px;color:#555">Results will be announced soon. Good luck! ðŸ€</p>
                </div>
            `;
            document.body.appendChild(modal);
            
            // Create confetti
            createConfetti();
            
            // Remove modal after 3.5 seconds
            setTimeout(() => {
                modal.style.opacity = '0';
                setTimeout(() => modal.remove(), 300);
            }, 3500);
        }
        
        // Create Confetti Animation
        function createConfetti() {
            const colors = ['#ff6b6b', '#4ecdc4', '#45b7d1', '#f7b731', '#5f27cd', '#00d2d3', '#ff9ff3', '#54a0ff'];
            const confettiCount = 50;
            
            for (let i = 0; i < confettiCount; i++) {
                const confetti = document.createElement('div');
                confetti.className = 'confetti';
                confetti.style.left = Math.random() * 100 + '%';
                confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                confetti.style.animationDelay = Math.random() * 0.5 + 's';
                confetti.style.animationDuration = (Math.random() * 2 + 2) + 's';
                document.body.appendChild(confetti);
                
                setTimeout(() => confetti.remove(), 3000);
            }
        }
        
        // Anti-Cheat
        function enableQuizAntiCheat() {
            quizAntiCheatActive = true;
            window.onbeforeunload = () => quizAntiCheatActive ? "Quiz in progress!" : null;
            document.addEventListener('visibilitychange', handleQuizVisibility);
        }
        
        function handleQuizVisibility() {
            if (quizAntiCheatActive && document.hidden) {
                alert('âš ï¸ TAB SWITCH! Auto-submitting quiz.');
                autoSubmitQuiz();
            }
        }
        
        async function autoSubmitQuiz() {
            if (!quizAntiCheatActive) return;
            const today = getQuizToday();
            try {
                await db.ref(`quizSubmissions/${today}`).push({
                    studentKey: quizCurrentUser.key,
                    studentName: quizCurrentUser.name,
                    studentEmail: quizCurrentUser.email,
                    studentClass: quizCurrentUser.class,
                    answers: {q1: 'X', q2: 'X'},
                    score: 0,
                    submittedAt: new Date().toISOString(),
                    timeTaken: 0,
                    status: 'auto-submitted'
                });
                disableQuizAntiCheat();
                if (quizTimerInterval) clearInterval(quizTimerInterval);
                document.getElementById('quizPage').style.display = 'none';
                document.getElementById('quizStudentDashboard').style.display = 'block';
                checkQuizTodayStatus();
            } catch (err) {
                console.error('Auto-submit error:', err);
            }
        }
        
        function disableQuizAntiCheat() {
            quizAntiCheatActive = false;
            window.onbeforeunload = null;
            document.removeEventListener('visibilitychange', handleQuizVisibility);
        }
        
        // Admin Functions
        async function loadQuizAdminStats() {
            try {
                const studSnap = await db.ref('quizStudents').once('value');
                document.getElementById('quizTotalStudents').textContent = studSnap.numChildren();
                
                const today = getQuizToday();
                const subSnap = await db.ref(`quizSubmissions/${today}`).once('value');
                document.getElementById('quizTodayParticipants').textContent = subSnap.numChildren();
                
                const qSnap = await db.ref(`quizQuestions/${today}`).once('value');
                document.getElementById('quizQuestionsCount').textContent = qSnap.exists() ? 2 : 0;
            } catch (err) {
                console.error('Stats error:', err);
            }
        }
        
        function showQuizAdminTab(tab) {
            document.querySelectorAll('#quizAdminDashboard .tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('#quizAdminDashboard .form-section').forEach(s => s.classList.remove('active'));
            
            const tabs = ['questions','students','submissions','results'];
            const idx = tabs.indexOf(tab);
            document.querySelectorAll('#quizAdminDashboard .tab')[idx].classList.add('active');
            document.getElementById(`quiz${tab.charAt(0).toUpperCase()+tab.slice(1)}TabContent`).classList.add('active');
            
            if (tab === 'students') loadQuizStudents();
            if (tab === 'submissions') loadQuizSubmissions();
            if (tab === 'results') loadQuizResults();
        }
        
        // Preview Image for Question
        function previewQuestionImage(input, previewId) {
            const preview = document.getElementById(previewId);
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    preview.innerHTML = `
                        <div style="position:relative;display:inline-block">
                            <img src="${e.target.result}" style="max-width:300px;max-height:200px;border-radius:8px;box-shadow:0 4px 10px rgba(0,0,0,0.1)">
                            <button onclick="clearMedia('${input.id}', '${previewId}')" style="position:absolute;top:5px;right:5px;background:red;color:white;border:none;border-radius:50%;width:25px;height:25px;cursor:pointer">Ã—</button>
                        </div>
                    `;
                };
                reader.readAsDataURL(input.files[0]);
            }
        }
        
        // Preview Audio for Question
        function previewQuestionAudio(input, previewId) {
            const preview = document.getElementById(previewId);
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    preview.innerHTML = `
                        <div style="background:#f0f0f0;padding:15px;border-radius:8px;display:inline-block">
                            <audio controls style="max-width:300px">
                                <source src="${e.target.result}">
                            </audio>
                            <button onclick="clearMedia('${input.id}', '${previewId}')" style="margin-left:10px;background:red;color:white;border:none;border-radius:5px;padding:5px 10px;cursor:pointer">Remove</button>
                        </div>
                    `;
                };
                reader.readAsDataURL(input.files[0]);
            }
        }
        
        // Clear Media
        function clearMedia(inputId, previewId) {
            document.getElementById(inputId).value = '';
            document.getElementById(previewId).innerHTML = '';
        }
        
        async function saveQuizQuestions() {
            const q1Text = document.getElementById('q1Text').value.trim();
            const q1OptA = document.getElementById('q1OptA').value.trim();
            const q1OptB = document.getElementById('q1OptB').value.trim();
            const q1OptC = document.getElementById('q1OptC').value.trim();
            const q1OptD = document.getElementById('q1OptD').value.trim();
            const q1Correct = document.getElementById('q1Correct').value;
            
            const q2Text = document.getElementById('q2Text').value.trim();
            const q2OptA = document.getElementById('q2OptA').value.trim();
            const q2OptB = document.getElementById('q2OptB').value.trim();
            const q2OptC = document.getElementById('q2OptC').value.trim();
            const q2OptD = document.getElementById('q2OptD').value.trim();
            const q2Correct = document.getElementById('q2Correct').value;
            
            if (!q1Text || !q1OptA || !q1OptB || !q1OptC || !q1OptD || !q1Correct) {
                showQuizMsg('quizAdminDashMessage', 'âš ï¸ Fill all Question 1 fields!', 'error');
                return;
            }
            
            if (!q2Text || !q2OptA || !q2OptB || !q2OptC || !q2OptD || !q2Correct) {
                showQuizMsg('quizAdminDashMessage', 'âš ï¸ Fill all Question 2 fields!', 'error');
                return;
            }
            
            // Get image and audio files
            const q1ImageFile = document.getElementById('q1Image').files[0];
            const q1AudioFile = document.getElementById('q1Audio').files[0];
            const q2ImageFile = document.getElementById('q2Image').files[0];
            const q2AudioFile = document.getElementById('q2Audio').files[0];
            
            const today = getQuizToday();
            const data = {
                q1: {
                    text: q1Text, 
                    options: {A:q1OptA, B:q1OptB, C:q1OptC, D:q1OptD}, 
                    correct: q1Correct
                },
                q2: {
                    text: q2Text, 
                    options: {A:q2OptA, B:q2OptB, C:q2OptC, D:q2OptD}, 
                    correct: q2Correct
                },
                createdAt: new Date().toISOString(),
                createdBy: quizCurrentUser.email
            };
            
            // Upload images and audio to Cloudinary if present
            try {
                if (q1ImageFile) {
                    data.q1.image = await quizUploadToCloudinary(q1ImageFile, 'q1_image');
                }
                if (q1AudioFile) {
                    data.q1.audio = await quizUploadToCloudinary(q1AudioFile, 'q1_audio');
                }
                if (q2ImageFile) {
                    data.q2.image = await quizUploadToCloudinary(q2ImageFile, 'q2_image');
                }
                if (q2AudioFile) {
                    data.q2.audio = await quizUploadToCloudinary(q2AudioFile, 'q2_audio');
                }
                
                await db.ref(`quizQuestions/${today}`).set(data);
                showQuizMsg('quizAdminDashMessage', 'âœ… Questions saved successfully with media!', 'success');
                
                // Clear form
                ['q1Text','q1OptA','q1OptB','q1OptC','q1OptD','q1Correct','q2Text','q2OptA','q2OptB','q2OptC','q2OptD','q2Correct'].forEach(id => {
                    document.getElementById(id).value = '';
                });
                ['q1Image','q1Audio','q2Image','q2Audio'].forEach(id => {
                    document.getElementById(id).value = '';
                });
                ['q1ImagePreview','q1AudioPreview','q2ImagePreview','q2AudioPreview'].forEach(id => {
                    document.getElementById(id).innerHTML = '';
                });
                
                await loadQuizAdminStats();
            } catch (err) {
                console.error('Save error:', err);
                showQuizMsg('quizAdminDashMessage', 'Error saving questions.', 'error');
            }
        }
        
        // Convert file to base64 (used for PREVIEWS only â€” not saved to DB)
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        // Upload quiz media (image/audio) to Cloudinary, return secure URL
        async function quizUploadToCloudinary(file, label) {
            const isAudio = file.type.startsWith('audio/');
            const resourceType = isAudio ? 'video' : 'image'; // Cloudinary uses 'video' for audio
            const formData = new FormData();
            formData.append('file', file);
            formData.append('upload_preset', 'scavenger_hunt');
            formData.append('folder', 'quiz_media');
            formData.append('public_id', label + '_' + Date.now());
            const res = await fetch(
                `https://api.cloudinary.com/v1_1/dat0khbet/${resourceType}/upload`,
                { method: 'POST', body: formData }
            );
            if (!res.ok) {
                const err = await res.json();
                throw new Error(err.error?.message || 'Cloudinary upload failed');
            }
            const data = await res.json();
            return data.secure_url;
        }
        
        async function viewTodayQuestions() {
            const today = getQuizToday();
            try {
                const snap = await db.ref(`quizQuestions/${today}`).once('value');
                const q = snap.val();
                const view = document.getElementById('todayQuestionsView');
                
                if (!q) {
                    view.innerHTML = '<div style="background:#fff3cd;padding:15px;border-radius:8px;margin-top:20px"><p style="margin:0;color:#856404">No questions for today yet.</p></div>';
                    view.style.display = 'block';
                    return;
                }
                
                let html = '<div style="background:#f8f9fa;padding:20px;border-radius:10px">';
                html += '<h4 style="color:#667eea;margin-bottom:15px">Today\'s Questions Preview</h4>';
                if (q.q1 && (q.q1.options || q.q1.type === 'text')) {
                html += `<p><strong>Q1:</strong> ${q.q1.text}</p>`;
                if (q.q1.type === 'text') {
                    html += `<p style="color:#2196F3;margin-left:20px">âœï¸ Text Input</p>`;
                    html += `<p style="color:green;font-weight:bold;margin-left:20px">Answer: ${q.q1.textAnswer}</p>`;
                    if (q.q1.explanation) html += `<p style="color:#666;font-size:0.9em;margin-left:20px">ðŸ“– ${q.q1.explanation}</p>`;
                } else {
                html += `<p style="margin-left:20px">A) ${q.q1.options.A}</p>`;
                html += `<p style="margin-left:20px">B) ${q.q1.options.B}</p>`;
                html += `<p style="margin-left:20px">C) ${q.q1.options.C}</p>`;
                html += `<p style="margin-left:20px">D) ${q.q1.options.D}</p>`;
                html += `<p style="color:green;font-weight:bold;margin-left:20px">Correct: ${q.q1.correct}</p>`;
                }
                html += '<br>';
                } else { html += '<p style="color:#999;font-style:italic">Q1 data missing.</p>'; }
                if (q.q2 && (q.q2.options || q.q2.type === 'text')) {
                html += `<p><strong>Q2:</strong> ${q.q2.text}</p>`;
                if (q.q2.type === 'text') {
                    html += `<p style="color:#2196F3;margin-left:20px">âœï¸ Text Input</p>`;
                    html += `<p style="color:green;font-weight:bold;margin-left:20px">Answer: ${q.q2.textAnswer}</p>`;
                    if (q.q2.explanation) html += `<p style="color:#666;font-size:0.9em;margin-left:20px">ðŸ“– ${q.q2.explanation}</p>`;
                } else {
                html += `<p style="margin-left:20px">A) ${q.q2.options.A}</p>`;
                html += `<p style="margin-left:20px">B) ${q.q2.options.B}</p>`;
                html += `<p style="margin-left:20px">C) ${q.q2.options.C}</p>`;
                html += `<p style="margin-left:20px">D) ${q.q2.options.D}</p>`;
                html += `<p style="color:green;font-weight:bold;margin-left:20px">Correct: ${q.q2.correct}</p>`;
                }
                } else { html += '<p style="color:#999;font-style:italic">Q2 not set for today.</p>'; }
                html += '</div>';
                
                view.innerHTML = html;
                view.style.display = 'block';
                
                // Check publish status
                await checkPublishStatusForToday();
            } catch (err) {
                console.error('View error:', err);
            }
        }
        
        async function loadQuizStudents() {
            try {
                const snap = await db.ref('quizStudents').once('value');
                const tbody = document.getElementById('quizStudentsTable');
                tbody.innerHTML = '';
                
                if (!snap.exists()) {
                    tbody.innerHTML = '<tr><td colspan="6" style="text-align:center">No students yet.</td></tr>';
                    return;
                }
                
                let idx = 1;
                snap.forEach(child => {
                    const s = child.val();
                    const row = tbody.insertRow();
                    row.innerHTML = `<td>${idx++}</td><td>${s.name}</td><td>${s.email}</td><td>${s.phone}</td><td>${s.class}</td><td>${new Date(s.registeredAt).toLocaleDateString()}</td>`;
                });
            } catch (err) {
                console.error('Load students error:', err);
            }
        }
        
        async function loadQuizSubmissions() {
            const today = getQuizToday();
            try {
                const snap = await db.ref(`quizSubmissions/${today}`).once('value');
                const tbody = document.getElementById('quizSubmissionsTable');
                tbody.innerHTML = '';
                
                if (!snap.exists()) {
                    tbody.innerHTML = '<tr><td colspan="7" style="text-align:center">No submissions yet today.</td></tr>';
                    return;
                }
                
                let idx = 1;
                snap.forEach(child => {
                    const s = child.val();
                    const row = tbody.insertRow();
                    const timeMins = Math.floor(s.timeTaken / 60);
                    const timeSecs = s.timeTaken % 60;
                    row.innerHTML = `<td>${idx++}</td><td>${s.studentName}</td><td>${s.studentEmail}</td><td>${s.studentClass}</td><td>${new Date(s.submittedAt).toLocaleString()}</td><td><strong>${s.score}/2</strong></td><td>${timeMins}m ${timeSecs}s</td>`;
                });
            } catch (err) {
                console.error('Load submissions error:', err);
            }
        }
        
        async function loadQuizResults() {
            const today = getQuizToday();
            try {
                const snap = await db.ref(`quizSubmissions/${today}`).once('value');
                
                if (!snap.exists()) {
                    document.getElementById('resultTotalPart').textContent = '0';
                    document.getElementById('resultBothCorrect').textContent = '0';
                    document.getElementById('resultEligible').textContent = '0';
                    return;
                }
                
                let total = 0, correct = 0;
                snap.forEach(child => {
                    total++;
                    if (child.val().score === 2) correct++;
                });
                
                document.getElementById('resultTotalPart').textContent = total;
                document.getElementById('resultBothCorrect').textContent = correct;
                document.getElementById('resultEligible').textContent = correct;
                
                const resSnap = await db.ref(`quizResults/${today}`).once('value');
                if (resSnap.exists()) {
                    displayQuizWinners(resSnap.val());
                }
            } catch (err) {
                console.error('Load results error:', err);
            }
        }
        
        async function selectQuizWinners() {
            const today = getQuizToday();
            try {
                const snap = await db.ref(`quizSubmissions/${today}`).once('value');
                const eligible = [];
                snap.forEach(child => {
                    if (child.val().score === 2) eligible.push(child.val());
                });
                
                if (eligible.length === 0) {
                    showQuizMsg('quizAdminDashMessage', 'âš ï¸ No correct answers yet!', 'warning');
                    return;
                }
                
                if (eligible.length === 1) {
                    showQuizMsg('quizAdminDashMessage', 'âš ï¸ Only one correct. Need 2 for winner & runner-up.', 'warning');
                    return;
                }
                
                const shuffled = eligible.sort(() => 0.5 - Math.random());
                const winner = shuffled[0];
                const runnerUp = shuffled[1];
                
                const data = {
                    winner: {name: winner.studentName, email: winner.studentEmail, class: winner.studentClass, score: winner.score},
                    runnerUp: {name: runnerUp.studentName, email: runnerUp.studentEmail, class: runnerUp.studentClass, score: runnerUp.score},
                    declaredAt: new Date().toISOString(),
                    declaredBy: quizCurrentUser.email,
                    totalEligible: eligible.length
                };
                
                await db.ref(`quizResults/${today}`).set(data);
                
                // Try to send emails but don't block winner declaration
                try {
                    await sendQuizEmail(winner.studentEmail, 'ðŸ† You Won Quiz!', `Dear ${winner.studentName},\n\nCongratulations! You are the WINNER!\n\nScore: ${winner.score}/2\nClass: ${winner.studentClass}\n\nDavan Institute`);
                } catch (e) { console.log('Winner email failed:', e); }
                
                try {
                    await sendQuizEmail(runnerUp.studentEmail, 'ðŸ¥ˆ Runner-Up!', `Dear ${runnerUp.studentName},\n\nCongratulations! You are RUNNER-UP!\n\nScore: ${runnerUp.score}/2\nClass: ${runnerUp.studentClass}\n\nDavan Institute`);
                } catch (e) { console.log('Runner-up email failed:', e); }
                
                showQuizMsg('quizAdminDashMessage', 'âœ… Winners selected & emails sent!', 'success');
                displayQuizWinners(data);
            } catch (err) {
                console.error('Select winners error:', err);
                showQuizMsg('quizAdminDashMessage', 'Error selecting winners.', 'error');
            }
        }
        
        function displayQuizWinners(data) {
            const div = document.getElementById('winnersDisplaySection');
            let html = '<div style="background:#f8f9fa;padding:25px;border-radius:12px">';
            html += '<h3 style="color:#667eea;margin-bottom:20px;text-align:center">ðŸŽ‰ Today\'s Winners</h3>';
            html += '<div style="background:linear-gradient(135deg,#ffd700 0%,#ffed4e 100%);padding:20px;border-radius:10px;margin-bottom:15px;color:#333">';
            html += '<h4 style="margin-bottom:10px">ðŸ† WINNER</h4>';
            html += `<p><strong>Name:</strong> ${data.winner.name}</p>`;
            html += `<p><strong>Email:</strong> ${data.winner.email}</p>`;
            html += `<p><strong>Class:</strong> ${data.winner.class}</p>`;
            html += `<p><strong>Score:</strong> ${data.winner.score}/2</p></div>`;
            html += '<div style="background:linear-gradient(135deg,#c0c0c0 0%,#e8e8e8 100%);padding:20px;border-radius:10px;color:#333">';
            html += '<h4 style="margin-bottom:10px">ðŸ¥ˆ RUNNER-UP</h4>';
            html += `<p><strong>Name:</strong> ${data.runnerUp.name}</p>`;
            html += `<p><strong>Email:</strong> ${data.runnerUp.email}</p>`;
            html += `<p><strong>Class:</strong> ${data.runnerUp.class}</p>`;
            html += `<p><strong>Score:</strong> ${data.runnerUp.score}/2</p></div>`;
            html += `<p style="text-align:center;margin-top:20px;color:#666"><small>Declared: ${new Date(data.declaredAt).toLocaleString()}</small></p></div>`;
            div.innerHTML = html;
            div.style.display = 'block';
        }
        
        // ========== INTEGRATED QUIZ MANAGEMENT FUNCTIONS ==========
        
        function showQuizManagementTab(tab, event) {
            document.querySelectorAll('#quizManagement .tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('#quizManagement .form-section').forEach(s => s.classList.remove('active'));
            
            // Only try to add active class to event target if event exists
            if (event && event.target) {
                event.target.classList.add('active');
            } else {
                // Programmatic call - find and activate the correct tab button
                const tabButtons = {
                    'questions': 0,
                    'allquizzes': 1,
                    'students': 2,
                    'submissions': 3,
                    'winners': 4,
                    'editdates': 5
                };
                const tabIndex = tabButtons[tab];
                if (tabIndex !== undefined) {
                    const tabs = document.querySelectorAll('#quizManagement .tab');
                    if (tabs[tabIndex]) {
                        tabs[tabIndex].classList.add('active');
                    }
                }
            }
            
            if (tab === 'questions') {
                document.getElementById('quizQuestionsContent').classList.add('active');
            } else if (tab === 'allquizzes') {
                document.getElementById('quizAllQuizzesContent').classList.add('active');
                loadAllQuizzes();
            } else if (tab === 'students') {
                document.getElementById('quizStudentsContent').classList.add('active');
                loadQuizStudentsAdmin();
            } else if (tab === 'submissions') {
                document.getElementById('quizSubmissionsContent').classList.add('active');
                loadQuizSubmissionsAdmin();
            } else if (tab === 'winners') {
                document.getElementById('quizWinnersContent').classList.add('active');
                // Initialize date selector to today if not set
                const wds = document.getElementById('winnersDateSelector');
                if (wds && !wds.value) wds.value = getQuizToday();
                loadQuizResultsAdmin();
                // Init auto-declaration toggle state
                if (typeof initAutoDeclarScheduler === 'function') initAutoDeclarScheduler();
            } else if (tab === 'editdates') {
                document.getElementById('quizEditDatesContent').classList.add('active');
                loadQuizzesForDateEdit();
            }
        }
        
        // Function to load quiz questions for the selected date
        async function loadQuizForSelectedDate() {
            const selectedDate = document.getElementById('quizDateSelector').value;
            if (!selectedDate) {
                return;
            }
            
            console.log('Loading quiz for date:', selectedDate);
            
            // Update heading
            const dateObj = new Date(selectedDate + 'T00:00:00');
            const dateStr = dateObj.toLocaleDateString('en-IN', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
            document.getElementById('quizQuestionsHeading').textContent = `Create Quiz for ${dateStr} (2 Questions)`;
            
            try {
                const snapshot = await db.ref(`quizQuestions/${selectedDate}`).once('value');
                
                if (snapshot.exists()) {
                    const data = snapshot.val();
                    console.log('Found existing quiz:', data);
                    
                    // Populate form with existing data
                    document.getElementById('quiz_q1Text').value = data.q1.text || '';
                    const q1type = data.q1.type || 'mcq';
                    document.getElementById('quiz_q1Type').value = q1type;
                    toggleQuestionType('q1');
                    if (q1type === 'mcq' && data.q1.options) {
                    document.getElementById('quiz_q1OptA').value = data.q1.options.A || '';
                    document.getElementById('quiz_q1OptB').value = data.q1.options.B || '';
                    document.getElementById('quiz_q1OptC').value = data.q1.options.C || '';
                    document.getElementById('quiz_q1OptD').value = data.q1.options.D || '';
                    document.getElementById('quiz_q1Correct').value = data.q1.correct || '';
                    } else if (q1type === 'text') {
                        document.getElementById('quiz_q1TextAnswer').value = data.q1.textAnswer || '';
                        document.getElementById('quiz_q1TextExplanation').value = data.q1.explanation || '';
                    }
                    
                    document.getElementById('quiz_q2Text').value = data.q2 ? (data.q2.text || '') : '';
                    const q2type = (data.q2 && data.q2.type) ? data.q2.type : 'mcq';
                    document.getElementById('quiz_q2Type').value = q2type;
                    toggleQuestionType('q2');
                    if (q2type === 'mcq' && data.q2 && data.q2.options) {
                    document.getElementById('quiz_q2OptA').value = data.q2.options.A || '';
                    document.getElementById('quiz_q2OptB').value = data.q2.options.B || '';
                    document.getElementById('quiz_q2OptC').value = data.q2.options.C || '';
                    document.getElementById('quiz_q2OptD').value = data.q2.options.D || '';
                    document.getElementById('quiz_q2Correct').value = data.q2.correct || '';
                    } else if (q2type === 'text' && data.q2) {
                        document.getElementById('quiz_q2TextAnswer').value = data.q2.textAnswer || '';
                        document.getElementById('quiz_q2TextExplanation').value = data.q2.explanation || '';
                    }
                    
                    showQuizMsg('quizAdminMessage', `âœï¸ Editing existing quiz for ${selectedDate}. Modify and save to update.`, 'success');
                    // Don't show preview on initial load - only after save
                    // displaySavedQuestionsPreview(data);
                } else {
                    console.log('No quiz found for this date, clearing form');
                    
                    // Clear form for new quiz
                    ['quiz_q1Text','quiz_q1OptA','quiz_q1OptB','quiz_q1OptC','quiz_q1OptD','quiz_q1Correct','quiz_q2Text','quiz_q2OptA','quiz_q2OptB','quiz_q2OptC','quiz_q2OptD','quiz_q2Correct','quiz_q1TextAnswer','quiz_q1TextExplanation','quiz_q2TextAnswer','quiz_q2TextExplanation'].forEach(id => {
                        const el = document.getElementById(id);
                        if (el) el.value = '';
                    });
                    
                    document.getElementById('todayQuestionsViewAdmin').innerHTML = '';
                    document.getElementById('todayQuestionsViewAdmin').style.display = 'none';
                    
                    showQuizMsg('quizAdminMessage', `ðŸ“ No quiz exists for ${selectedDate}. Create a new one below.`, 'error');
                }
            } catch (err) {
                console.error('Error loading quiz:', err);
                showQuizMsg('quizAdminMessage', 'Error loading quiz: ' + err.message, 'error');
            }
        }
        
        // Initialize date selector with today's date when page loads
        function initializeDateSelector() {
            const dateInput = document.getElementById('quizDateSelector');
            if (dateInput) {
                const today = getQuizToday();
                dateInput.value = today;
                loadQuizForSelectedDate();
            }
        }
        
        async function loadQuizManagementStats() {
            try {
                const studSnap = await db.ref('quizStudents').once('value');
                document.getElementById('quizTotalStudents').textContent = studSnap.numChildren();
                
                const today = getQuizToday();
                const subSnap = await db.ref(`quizSubmissions/${today}`).once('value');
                document.getElementById('quizTodayParticipants').textContent = subSnap.numChildren();
                
                const qSnap = await db.ref(`quizQuestions/${today}`).once('value');
                document.getElementById('quizQuestionsCount').textContent = qSnap.exists() ? 2 : 0;
            } catch (err) {
                console.error('Load quiz stats error:', err);
            }
        }
        
        async function loadAllQuizzes() {
            const container = document.getElementById('allQuizzesContainer');
            container.innerHTML = '<p style="text-align:center;color:#666">Loading all quizzes...</p>';
            
            try {
                const quizzesSnap = await db.ref('quizQuestions').once('value');
                
                if (!quizzesSnap.exists()) {
                    container.innerHTML = '<div style="background:#fff3cd;padding:20px;border-radius:8px;text-align:center"><p style="margin:0;color:#856404">No quizzes found in database.</p></div>';
                    return;
                }
                
                // Get all quiz dates and sort them (newest first)
                const quizzes = [];
                quizzesSnap.forEach(child => {
                    quizzes.push({
                        date: child.key,
                        data: child.val()
                    });
                });
                
                quizzes.sort((a, b) => new Date(b.date) - new Date(a.date));
                
                // Get publish statuses
                const publishedSnap = await db.ref('quizPublished').once('value');
                const publishedData = publishedSnap.val() || {};
                
                let html = '';
                
                for (const quiz of quizzes) {
                    const dateObj = new Date(quiz.date);
                    const dateStr = dateObj.toLocaleDateString('en-IN', {
                        weekday: 'long',
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric'
                    });
                    
                    const isPublished = publishedData[quiz.date] && publishedData[quiz.date].published === true;
                    const publishInfo = publishedData[quiz.date];
                    
                    html += '<div style="background:white;padding:20px;border-radius:10px;margin-bottom:20px;border-left:5px solid ' + (isPublished ? '#4CAF50' : '#667eea') + '">';
                    html += '<div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:15px">';
                    html += '<div>';
                    html += '<h4 style="color:#667eea;margin:0 0 5px 0">ðŸ“… ' + dateStr + '</h4>';
                    html += '<p style="margin:0;font-size:0.9em;color:#666">Date: ' + quiz.date + '</p>';
                    if (publishInfo) {
                        if (isPublished) {
                            html += '<p style="margin:5px 0 0 0;font-size:0.85em;color:#4CAF50;font-weight:600">âœ… PUBLISHED on ' + new Date(publishInfo.publishedAt).toLocaleString() + '</p>';
                        } else {
                            html += '<p style="margin:5px 0 0 0;font-size:0.85em;color:#ff9800;font-weight:600">âš ï¸ UNPUBLISHED</p>';
                        }
                    } else {
                        html += '<p style="margin:5px 0 0 0;font-size:0.85em;color:#999">Not yet published</p>';
                    }
                    html += '</div>';
                    html += '<div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">';
                    html += '<button class="btn btn-info btn-small" onclick="editQuizByDate(\'' + quiz.date + '\')" style="background:#2196F3;font-weight:600">âœï¸ Edit</button>';
                    html += '<button class="btn btn-danger btn-small" onclick="deleteQuizByDate(\'' + quiz.date + '\')" style="font-weight:600">ðŸ—‘ï¸ Delete</button>';
                    if (isPublished) {
                        html += '<button class="btn btn-small" onclick="unpublishQuizByDate(\'' + quiz.date + '\')" style="background:#ff9800;color:white;font-weight:600">âŒ Unpublish</button>';
                    } else {
                        html += '<button class="btn btn-success btn-small" onclick="publishQuizByDate(\'' + quiz.date + '\')" style="font-weight:600">âœ… Publish</button>';
                    }
                    html += '</div>';
                    html += '</div>';
                    
                    html += '<div style="background:#f8f9fa;padding:15px;border-radius:8px">';
                    html += '<p style="margin:0 0 10px 0;font-weight:600">Question 1:</p>';
                    
                    if (quiz.data.q1 && (quiz.data.q1.options || quiz.data.q1.type === 'text')) {
                    // Show image if present
                    if (quiz.data.q1.image) {
                        html += '<div style="text-align:center;margin:10px 0"><img src="' + quiz.data.q1.image + '" style="max-width:100%;max-height:200px;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,0.1)"></div>';
                    }
                    
                    // Show audio if present
                    if (quiz.data.q1.audio) {
                        html += '<div style="margin:10px 0;background:#e8f5e9;padding:10px;border-radius:6px"><p style="margin:0 0 5px 0;font-size:0.9em;color:#2e7d32">ðŸŽµ Audio attached</p><audio controls style="width:100%;max-width:300px"><source src="' + quiz.data.q1.audio + '"></audio></div>';
                    }
                    
                    html += '<p style="margin:0 0 10px 0">' + (quiz.data.q1.text || '(no question text)') + '</p>';
                    if (quiz.data.q1.type === 'text') {
                        html += '<p style="margin:0;color:#2196F3;font-weight:600">âœï¸ Text Input Question</p>';
                        html += '<p style="margin:4px 0 0 0;color:#4CAF50;font-weight:600">âœ… Answer: ' + (quiz.data.q1.textAnswer || '(unknown)') + '</p>';
                        if (quiz.data.q1.explanation) html += '<p style="margin:4px 0 0 0;color:#666;font-size:0.9em">ðŸ“– ' + quiz.data.q1.explanation + '</p>';
                    } else {
                        html += '<p style="margin:0;color:#4CAF50;font-weight:600">âœ… Correct: ' + (quiz.data.q1.options[quiz.data.q1.correct] || '(unknown)') + '</p>';
                    }
                    } else {
                        html += '<p style="color:#999;font-style:italic">Q1 data missing or incomplete.</p>';
                    }
                    html += '</div>';
                    
                    html += '<div style="background:#f8f9fa;padding:15px;border-radius:8px;margin-top:10px">';
                    html += '<p style="margin:0 0 10px 0;font-weight:600">Question 2:</p>';
                    
                    if (quiz.data.q2 && (quiz.data.q2.options || quiz.data.q2.type === 'text')) {
                    // Show image if present
                    if (quiz.data.q2.image) {
                        html += '<div style="text-align:center;margin:10px 0"><img src="' + quiz.data.q2.image + '" style="max-width:100%;max-height:200px;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,0.1)"></div>';
                    }
                    
                    // Show audio if present
                    if (quiz.data.q2.audio) {
                        html += '<div style="margin:10px 0;background:#e8f5e9;padding:10px;border-radius:6px"><p style="margin:0 0 5px 0;font-size:0.9em;color:#2e7d32">ðŸŽµ Audio attached</p><audio controls style="width:100%;max-width:300px"><source src="' + quiz.data.q2.audio + '"></audio></div>';
                    }
                    
                    html += '<p style="margin:0 0 10px 0">' + (quiz.data.q2.text || '(no question text)') + '</p>';
                    if (quiz.data.q2.type === 'text') {
                        html += '<p style="margin:0;color:#2196F3;font-weight:600">âœï¸ Text Input Question</p>';
                        html += '<p style="margin:4px 0 0 0;color:#4CAF50;font-weight:600">âœ… Answer: ' + (quiz.data.q2.textAnswer || '(unknown)') + '</p>';
                        if (quiz.data.q2.explanation) html += '<p style="margin:4px 0 0 0;color:#666;font-size:0.9em">ðŸ“– ' + quiz.data.q2.explanation + '</p>';
                    } else {
                        html += '<p style="margin:0;color:#4CAF50;font-weight:600">âœ… Correct: ' + (quiz.data.q2.options[quiz.data.q2.correct] || '(unknown)') + '</p>';
                    }
                    } else {
                        html += '<p style="color:#999;font-style:italic">Q2 not set for this date.</p>';
                    }
                    html += '</div>';
                    
                    html += '</div>';
                }
                
                container.innerHTML = html;
                
            } catch (err) {
                console.error('Load all quizzes error:', err);
                container.innerHTML = '<div style="background:#f8d7da;padding:20px;border-radius:8px;text-align:center"><p style="margin:0;color:#721c24">Error loading quizzes: ' + err.message + '</p></div>';
            }
        }
        
        async function publishQuizByDate(date) {
            if (!confirm(`Publish quiz for ${date}?\n\nThis will show the questions and answers publicly for educational review.`)) return;
            
            try {
                await db.ref(`quizPublished/${date}`).set({
                    published: true,
                    publishedAt: new Date().toISOString(),
                    publishedBy: 'Super Admin'
                });
                
                alert('âœ… Quiz published successfully!');
                loadAllQuizzes();
            } catch (err) {
                console.error('Publish error:', err);
                alert('âŒ Error publishing quiz: ' + err.message);
            }
        }
        
        async function unpublishQuizByDate(date) {
            if (!confirm(`Unpublish quiz for ${date}?\n\nThis will hide the answers from public view.`)) return;
            
            try {
                await db.ref(`quizPublished/${date}`).set({
                    published: false,
                    unpublishedAt: new Date().toISOString(),
                    unpublishedBy: 'Super Admin'
                });
                
                alert('âœ… Quiz unpublished successfully!');
                loadAllQuizzes();
            } catch (err) {
                console.error('Unpublish error:', err);
                alert('âŒ Error unpublishing quiz: ' + err.message);
            }
        }
        
        function removeExistingMedia(question, type) {
            const previewId = `quiz_${question}${type === 'image' ? 'Image' : 'Audio'}Preview`;
            const confirmMsg = `Remove this ${type} from Question ${question === 'q1' ? '1' : '2'}?`;
            
            if (confirm(confirmMsg)) {
                // Mark for deletion
                if (question === 'q1' && type === 'image') {
                    window.editingQuizData.deleteQ1Image = true;
                } else if (question === 'q1' && type === 'audio') {
                    window.editingQuizData.deleteQ1Audio = true;
                } else if (question === 'q2' && type === 'image') {
                    window.editingQuizData.deleteQ2Image = true;
                } else if (question === 'q2' && type === 'audio') {
                    window.editingQuizData.deleteQ2Audio = true;
                }
                
                // Clear the preview
                document.getElementById(previewId).innerHTML = `<p style="color:#28a745;font-weight:600">âœ“ ${type.charAt(0).toUpperCase() + type.slice(1)} will be removed when you save</p>`;
            }
        }
        
        async function editQuizByDate(date) {
            try {
                // Load the quiz data
                const snap = await db.ref(`quizQuestions/${date}`).once('value');
                const quizData = snap.val();
                
                if (!quizData) {
                    alert('âŒ Quiz not found!');
                    return;
                }
                
                // Switch to Questions tab
                showQuizManagementTab('questions');
                
                // Set the date selector
                document.getElementById('quizDateSelector').value = date;
                
                // Populate the form with existing data
                document.getElementById('quiz_q1Text').value = (quizData.q1 && quizData.q1.text) || '';
                const q1type = (quizData.q1 && quizData.q1.type) || 'mcq';
                document.getElementById('quiz_q1Type').value = q1type;
                toggleQuestionType('q1');
                if (q1type === 'mcq') {
                document.getElementById('quiz_q1OptA').value = (quizData.q1 && quizData.q1.options && quizData.q1.options.A) || '';
                document.getElementById('quiz_q1OptB').value = (quizData.q1 && quizData.q1.options && quizData.q1.options.B) || '';
                document.getElementById('quiz_q1OptC').value = (quizData.q1 && quizData.q1.options && quizData.q1.options.C) || '';
                document.getElementById('quiz_q1OptD').value = (quizData.q1 && quizData.q1.options && quizData.q1.options.D) || '';
                document.getElementById('quiz_q1Correct').value = (quizData.q1 && quizData.q1.correct) || '';
                } else {
                    document.getElementById('quiz_q1TextAnswer').value = (quizData.q1 && quizData.q1.textAnswer) || '';
                    document.getElementById('quiz_q1TextExplanation').value = (quizData.q1 && quizData.q1.explanation) || '';
                }
                
                document.getElementById('quiz_q2Text').value = (quizData.q2 && quizData.q2.text) || '';
                const q2type = (quizData.q2 && quizData.q2.type) || 'mcq';
                document.getElementById('quiz_q2Type').value = q2type;
                toggleQuestionType('q2');
                if (q2type === 'mcq') {
                document.getElementById('quiz_q2OptA').value = (quizData.q2 && quizData.q2.options && quizData.q2.options.A) || '';
                document.getElementById('quiz_q2OptB').value = (quizData.q2 && quizData.q2.options && quizData.q2.options.B) || '';
                document.getElementById('quiz_q2OptC').value = (quizData.q2 && quizData.q2.options && quizData.q2.options.C) || '';
                document.getElementById('quiz_q2OptD').value = (quizData.q2 && quizData.q2.options && quizData.q2.options.D) || '';
                document.getElementById('quiz_q2Correct').value = (quizData.q2 && quizData.q2.correct) || '';
                } else {
                    document.getElementById('quiz_q2TextAnswer').value = (quizData.q2 && quizData.q2.textAnswer) || '';
                    document.getElementById('quiz_q2TextExplanation').value = (quizData.q2 && quizData.q2.explanation) || '';
                }
                
                // Clear previous previews
                document.getElementById('quiz_q1ImagePreview').innerHTML = '';
                document.getElementById('quiz_q1AudioPreview').innerHTML = '';
                document.getElementById('quiz_q2ImagePreview').innerHTML = '';
                document.getElementById('quiz_q2AudioPreview').innerHTML = '';
                
                // Store existing media in global variables for deletion tracking
                window.editingQuizData = {
                    q1Image: (quizData.q1 && quizData.q1.image) || null,
                    q1Audio: (quizData.q1 && quizData.q1.audio) || null,
                    q2Image: (quizData.q2 && quizData.q2.image) || null,
                    q2Audio: (quizData.q2 && quizData.q2.audio) || null,
                    deleteQ1Image: false,
                    deleteQ1Audio: false,
                    deleteQ2Image: false,
                    deleteQ2Audio: false
                };
                
                // Show image previews if images exist
                if (quizData.q1 && quizData.q1.image) {
                    document.getElementById('quiz_q1ImagePreview').innerHTML = `
                        <div style="position:relative;display:inline-block">
                            <img src="${quizData.q1.image}" style="max-width:300px;max-height:200px;border-radius:8px;box-shadow:0 4px 10px rgba(0,0,0,0.1)">
                            <p style="margin-top:5px;color:#666;font-size:0.9em">Current image</p>
                            <button type="button" class="btn btn-danger btn-small" onclick="removeExistingMedia('q1', 'image')" style="margin-top:5px">ðŸ—‘ï¸ Remove Image</button>
                            <p style="margin-top:5px;color:#999;font-size:0.85em">Or upload a new one below to replace it</p>
                        </div>
                    `;
                }
                
                if (quizData.q2 && quizData.q2.image) {
                    document.getElementById('quiz_q2ImagePreview').innerHTML = `
                        <div style="position:relative;display:inline-block">
                            <img src="${quizData.q2.image}" style="max-width:300px;max-height:200px;border-radius:8px;box-shadow:0 4px 10px rgba(0,0,0,0.1)">
                            <p style="margin-top:5px;color:#666;font-size:0.9em">Current image</p>
                            <button type="button" class="btn btn-danger btn-small" onclick="removeExistingMedia('q2', 'image')" style="margin-top:5px">ðŸ—‘ï¸ Remove Image</button>
                            <p style="margin-top:5px;color:#999;font-size:0.85em">Or upload a new one below to replace it</p>
                        </div>
                    `;
                }
                
                // Show audio previews if audio exists
                if (quizData.q1 && quizData.q1.audio) {
                    document.getElementById('quiz_q1AudioPreview').innerHTML = `
                        <div style="background:#f0f0f0;padding:15px;border-radius:8px;display:inline-block">
                            <p style="margin:0 0 5px 0;color:#666;font-size:0.9em">Current audio</p>
                            <audio controls style="max-width:300px">
                                <source src="${quizData.q1.audio}">
                            </audio>
                            <div style="margin-top:10px">
                                <button type="button" class="btn btn-danger btn-small" onclick="removeExistingMedia('q1', 'audio')">ðŸ—‘ï¸ Remove Audio</button>
                            </div>
                            <p style="margin-top:5px;color:#999;font-size:0.85em">Or upload a new one below to replace it</p>
                        </div>
                    `;
                }
                
                if (quizData.q2 && quizData.q2.audio) {
                    document.getElementById('quiz_q2AudioPreview').innerHTML = `
                        <div style="background:#f0f0f0;padding:15px;border-radius:8px;display:inline-block">
                            <p style="margin:0 0 5px 0;color:#666;font-size:0.9em">Current audio</p>
                            <audio controls style="max-width:300px">
                                <source src="${quizData.q2.audio}">
                            </audio>
                            <div style="margin-top:10px">
                                <button type="button" class="btn btn-danger btn-small" onclick="removeExistingMedia('q2', 'audio')">ðŸ—‘ï¸ Remove Audio</button>
                            </div>
                            <p style="margin-top:5px;color:#999;font-size:0.85em">Or upload a new one below to replace it</p>
                        </div>
                    `;
                }
                
                // Update the heading
                const dateObj = new Date(date);
                const dateStr = dateObj.toLocaleDateString('en-IN', {
                    weekday: 'long',
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
                document.getElementById('quizQuestionsHeading').textContent = `Edit Quiz for ${dateStr} (2 Questions)`;
                
                // Show success message
                showQuizMsg('quizAdminMessage', `âœï¸ Editing quiz for ${date}. Make your changes and click Save.`, 'success');
                
                // Scroll to quiz editor
                const qHeading = document.getElementById('quizQuestionsHeading');
                if (qHeading) qHeading.scrollIntoView({ behavior: 'smooth', block: 'start' });
                
            } catch (err) {
                console.error('Edit quiz error:', err);
                alert('âŒ Error loading quiz for editing: ' + err.message);
            }
        }
        
        async function deleteQuizByDate(date) {
            if (!confirm(`âš ï¸ DELETE QUIZ FOR ${date}?\n\nThis will permanently delete:\n- Questions\n- All submissions\n- Results\n- Publish status\n\nThis action CANNOT be undone!\n\nAre you sure?`)) return;
            
            // Double confirmation for safety
            if (!confirm(`FINAL CONFIRMATION\n\nYou are about to permanently delete the quiz for ${date}.\n\nType YES in the next prompt to confirm.`)) return;
            
            const confirmation = prompt('Type YES (in capital letters) to confirm deletion:');
            if (confirmation !== 'YES') {
                alert('Deletion cancelled.');
                return;
            }
            
            try {
                // Delete all related data
                await Promise.all([
                    db.ref(`quizQuestions/${date}`).remove(),
                    db.ref(`quizSubmissions/${date}`).remove(),
                    db.ref(`quizResults/${date}`).remove(),
                    db.ref(`quizPublished/${date}`).remove()
                ]);
                
                alert('âœ… Quiz deleted successfully!');
                loadAllQuizzes();
            } catch (err) {
                console.error('Delete error:', err);
                alert('âŒ Error deleting quiz: ' + err.message);
            }
        }
        
        // Toggle admin form between MCQ and text-input mode
        function toggleQuestionType(qNum) {
            const type = document.getElementById('quiz_' + qNum + 'Type').value;
            const mcqSec = document.getElementById('quiz_' + qNum + 'McqSection');
            const txtSec = document.getElementById('quiz_' + qNum + 'TextSection');
            if (type === 'text') {
                mcqSec.style.display = 'none';
                txtSec.style.display = 'block';
            } else {
                mcqSec.style.display = 'block';
                txtSec.style.display = 'none';
            }
        }

        async function saveQuizQuestionsFromAdmin() {
            // Get selected date
            const selectedDate = document.getElementById('quizDateSelector').value;
            if (!selectedDate) {
                alert('âš ï¸ Please select a date first!');
                showQuizMsg('quizAdminMessage', 'âš ï¸ Please select a date first!', 'error');
                return;
            }
            
            const q1Type = document.getElementById('quiz_q1Type').value;
            const q2Type = document.getElementById('quiz_q2Type').value;
            
            const q1Text = document.getElementById('quiz_q1Text').value.trim();
            const q2Text = document.getElementById('quiz_q2Text').value.trim();

            if (!q1Text) {
                alert('âš ï¸ Please fill Question 1 text!');
                showQuizMsg('quizAdminMessage', 'âš ï¸ Fill Question 1 text!', 'error');
                return;
            }
            if (!q2Text) {
                alert('âš ï¸ Please fill Question 2 text!');
                showQuizMsg('quizAdminMessage', 'âš ï¸ Fill Question 2 text!', 'error');
                return;
            }

            // Build q1 data
            let q1Data = { text: q1Text, type: q1Type };
            if (q1Type === 'mcq') {
                const q1OptA = document.getElementById('quiz_q1OptA').value.trim();
                const q1OptB = document.getElementById('quiz_q1OptB').value.trim();
                const q1OptC = document.getElementById('quiz_q1OptC').value.trim();
                const q1OptD = document.getElementById('quiz_q1OptD').value.trim();
                const q1Correct = document.getElementById('quiz_q1Correct').value;
                if (!q1OptA || !q1OptB || !q1OptC || !q1OptD || !q1Correct) {
                    alert('âš ï¸ Please fill all Question 1 MCQ fields!');
                    showQuizMsg('quizAdminMessage', 'âš ï¸ Fill all Question 1 fields!', 'error');
                    return;
                }
                q1Data.options = {A:q1OptA, B:q1OptB, C:q1OptC, D:q1OptD};
                q1Data.correct = q1Correct;
            } else {
                const q1Ans = document.getElementById('quiz_q1TextAnswer').value.trim();
                const q1Exp = document.getElementById('quiz_q1TextExplanation').value.trim();
                if (!q1Ans) {
                    alert('âš ï¸ Please enter the correct answer for Question 1!');
                    showQuizMsg('quizAdminMessage', 'âš ï¸ Enter correct answer for Q1!', 'error');
                    return;
                }
                q1Data.textAnswer = q1Ans;
                q1Data.explanation = q1Exp;
            }

            // Build q2 data
            let q2Data = { text: q2Text, type: q2Type };
            if (q2Type === 'mcq') {
                const q2OptA = document.getElementById('quiz_q2OptA').value.trim();
                const q2OptB = document.getElementById('quiz_q2OptB').value.trim();
                const q2OptC = document.getElementById('quiz_q2OptC').value.trim();
                const q2OptD = document.getElementById('quiz_q2OptD').value.trim();
                const q2Correct = document.getElementById('quiz_q2Correct').value;
                if (!q2OptA || !q2OptB || !q2OptC || !q2OptD || !q2Correct) {
                    alert('âš ï¸ Please fill all Question 2 MCQ fields!');
                    showQuizMsg('quizAdminMessage', 'âš ï¸ Fill all Question 2 fields!', 'error');
                    return;
                }
                q2Data.options = {A:q2OptA, B:q2OptB, C:q2OptC, D:q2OptD};
                q2Data.correct = q2Correct;
            } else {
                const q2Ans = document.getElementById('quiz_q2TextAnswer').value.trim();
                const q2Exp = document.getElementById('quiz_q2TextExplanation').value.trim();
                if (!q2Ans) {
                    alert('âš ï¸ Please enter the correct answer for Question 2!');
                    showQuizMsg('quizAdminMessage', 'âš ï¸ Enter correct answer for Q2!', 'error');
                    return;
                }
                q2Data.textAnswer = q2Ans;
                q2Data.explanation = q2Exp;
            }
            
            console.log('Saving questions for date:', selectedDate);
            
            // Get image and audio files
            const q1ImageFile = document.getElementById('quiz_q1Image').files[0];
            const q1AudioFile = document.getElementById('quiz_q1Audio').files[0];
            const q2ImageFile = document.getElementById('quiz_q2Image').files[0];
            const q2AudioFile = document.getElementById('quiz_q2Audio').files[0];
            
            const data = {
                q1: q1Data,
                q2: q2Data,
                createdAt: new Date().toISOString(),
                createdBy: 'Super Admin',
                quizDate: selectedDate
            };
            
            try {
                // Check if editing existing quiz (to preserve media if not replaced)
                const existingSnap = await db.ref(`quizQuestions/${selectedDate}`).once('value');
                const existingData = existingSnap.val();
                
                // Check if we're in edit mode with deletion tracking
                const editData = window.editingQuizData || {};
                
                // Convert images and audio to Cloudinary URLs if present, otherwise preserve existing (unless marked for deletion)
                if (q1ImageFile) {
                    data.q1.image = await quizUploadToCloudinary(q1ImageFile, 'q1_image');
                } else if (existingData && existingData.q1 && existingData.q1.image && !editData.deleteQ1Image) {
                    data.q1.image = existingData.q1.image; // Preserve existing image
                }
                // If deleteQ1Image is true, we simply don't add the image property
                
                if (q1AudioFile) {
                    data.q1.audio = await quizUploadToCloudinary(q1AudioFile, 'q1_audio');
                } else if (existingData && existingData.q1 && existingData.q1.audio && !editData.deleteQ1Audio) {
                    data.q1.audio = existingData.q1.audio; // Preserve existing audio
                }
                
                if (q2ImageFile) {
                    data.q2.image = await quizUploadToCloudinary(q2ImageFile, 'q2_image');
                } else if (existingData && existingData.q2 && existingData.q2.image && !editData.deleteQ2Image) {
                    data.q2.image = existingData.q2.image; // Preserve existing image
                }
                
                if (q2AudioFile) {
                    data.q2.audio = await quizUploadToCloudinary(q2AudioFile, 'q2_audio');
                } else if (existingData && existingData.q2 && existingData.q2.audio && !editData.deleteQ2Audio) {
                    data.q2.audio = existingData.q2.audio; // Preserve existing audio
                }
                
                // Clear editing data after save
                window.editingQuizData = null;
                
                console.log('Attempting to save to Firebase...', data);
                await db.ref(`quizQuestions/${selectedDate}`).set(data);
                
                // SUCCESS POPUP!
                alert(`âœ… Questions Saved Successfully for ${selectedDate}!\n\nThe quiz will be automatically available to students on this date.\n\nQuestions preview will be shown below.`);
                
                showQuizMsg('quizAdminMessage', `âœ… Questions saved successfully for ${selectedDate} with media! Preview shown below.`, 'success');
                
                // Automatically show the questions preview
                displaySavedQuestionsPreview(data);
                
                // Clear form
                ['quiz_q1Text','quiz_q1OptA','quiz_q1OptB','quiz_q1OptC','quiz_q1OptD','quiz_q1Correct','quiz_q2Text','quiz_q2OptA','quiz_q2OptB','quiz_q2OptC','quiz_q2OptD','quiz_q2Correct','quiz_q1TextAnswer','quiz_q1TextExplanation','quiz_q2TextAnswer','quiz_q2TextExplanation'].forEach(id => {
                    const el = document.getElementById(id);
                    if (el) el.value = '';
                });
                ['quiz_q1Image','quiz_q1Audio','quiz_q2Image','quiz_q2Audio'].forEach(id => {
                    const el = document.getElementById(id);
                    if (el) el.value = '';
                });
                ['quiz_q1ImagePreview','quiz_q1AudioPreview','quiz_q2ImagePreview','quiz_q2AudioPreview'].forEach(id => {
                    const el = document.getElementById(id);
                    if (el) el.innerHTML = '';
                });
                
                await loadQuizManagementStats();
                console.log('Questions saved successfully for date:', selectedDate);
            } catch (err) {
                console.error('Save error:', err);
                alert('âŒ Error saving questions: ' + err.message);
                showQuizMsg('quizAdminMessage', 'Error saving questions: ' + err.message, 'error');
            }
        }
        
        function displaySavedQuestionsPreview(data) {
            const view = document.getElementById('todayQuestionsViewAdmin');
            
            const createdDate = new Date(data.createdAt);
            const dateStr = createdDate.toLocaleDateString('en-IN', { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
            const timeStr = createdDate.toLocaleTimeString('en-IN', { 
                hour: '2-digit', 
                minute: '2-digit',
                second: '2-digit'
            });
            
            let html = '<div style="background:#f8f9fa;padding:25px;border-radius:10px;margin-top:20px;border:3px solid #28a745">';
            html += '<h3 style="color:#28a745;margin-bottom:10px;text-align:center">âœ… Questions Saved Successfully - Preview</h3>';
            html += `<p style="text-align:center;color:#666;font-size:0.95em;margin-bottom:20px">ðŸ“… ${dateStr} | â° ${timeStr}</p>`;
            
            // Question 1
            html += '<div style="background:white;padding:20px;border-radius:8px;margin-bottom:20px;border-left:5px solid #667eea">';
            html += '<h4 style="color:#667eea;margin-bottom:15px">ðŸ“ Question 1</h4>';
            
            // Show image if present
            if (data.q1.image) {
                html += '<div style="text-align:center;margin:15px 0"><img src="' + data.q1.image + '" style="max-width:100%;max-height:250px;border-radius:8px;box-shadow:0 4px 12px rgba(0,0,0,0.15)"></div>';
            }
            
            // Show audio if present
            if (data.q1.audio) {
                html += '<div style="margin:15px 0;background:#e8f5e9;padding:15px;border-radius:8px"><p style="margin:0 0 8px 0;font-weight:600;color:#2e7d32">ðŸŽµ Audio Question</p><audio controls style="width:100%;max-width:400px"><source src="' + data.q1.audio + '"></audio></div>';
            }
            
            html += `<p style="font-size:1.1em;font-weight:600;margin-bottom:15px">${data.q1.text}</p>`;
            if (data.q1.type === 'text') {
                html += `<div style="background:#e3f2fd;padding:12px;border-radius:6px;margin-bottom:8px"><span style="color:#1565c0;font-weight:600">âœï¸ Text Input Question</span></div>`;
                html += `<p style="color:#28a745;font-weight:bold;margin-top:10px;font-size:1.1em">âœ… Answer: ${data.q1.textAnswer}</p>`;
                if (data.q1.explanation) html += `<p style="color:#555;font-size:0.95em;margin-top:6px">ðŸ“– ${data.q1.explanation}</p>`;
            } else {
            html += `<p style="margin-left:20px;padding:8px;background:${data.q1.correct === 'A' ? '#d4edda' : '#f8f9fa'};border-radius:4px">A) ${data.q1.options.A} ${data.q1.correct === 'A' ? 'âœ…' : ''}</p>`;
            html += `<p style="margin-left:20px;padding:8px;background:${data.q1.correct === 'B' ? '#d4edda' : '#f8f9fa'};border-radius:4px">B) ${data.q1.options.B} ${data.q1.correct === 'B' ? 'âœ…' : ''}</p>`;
            html += `<p style="margin-left:20px;padding:8px;background:${data.q1.correct === 'C' ? '#d4edda' : '#f8f9fa'};border-radius:4px">C) ${data.q1.options.C} ${data.q1.correct === 'C' ? 'âœ…' : ''}</p>`;
            html += `<p style="margin-left:20px;padding:8px;background:${data.q1.correct === 'D' ? '#d4edda' : '#f8f9fa'};border-radius:4px">D) ${data.q1.options.D} ${data.q1.correct === 'D' ? 'âœ…' : ''}</p>`;
            html += `<p style="color:#28a745;font-weight:bold;margin-top:15px;font-size:1.1em">âœ“ Correct Answer: ${data.q1.correct}</p>`;
            }
            html += '</div>';
            
            // Question 2
            html += '<div style="background:white;padding:20px;border-radius:8px;border-left:5px solid #667eea">';
            html += '<h4 style="color:#667eea;margin-bottom:15px">ðŸ“ Question 2</h4>';
            
            // Show image if present
            if (data.q2.image) {
                html += '<div style="text-align:center;margin:15px 0"><img src="' + data.q2.image + '" style="max-width:100%;max-height:250px;border-radius:8px;box-shadow:0 4px 12px rgba(0,0,0,0.15)"></div>';
            }
            
            // Show audio if present
            if (data.q2.audio) {
                html += '<div style="margin:15px 0;background:#e8f5e9;padding:15px;border-radius:8px"><p style="margin:0 0 8px 0;font-weight:600;color:#2e7d32">ðŸŽµ Audio Question</p><audio controls style="width:100%;max-width:400px"><source src="' + data.q2.audio + '"></audio></div>';
            }
            
            html += `<p style="font-size:1.1em;font-weight:600;margin-bottom:15px">${data.q2.text}</p>`;
            if (data.q2.type === 'text') {
                html += `<div style="background:#e3f2fd;padding:12px;border-radius:6px;margin-bottom:8px"><span style="color:#1565c0;font-weight:600">âœï¸ Text Input Question</span></div>`;
                html += `<p style="color:#28a745;font-weight:bold;margin-top:10px;font-size:1.1em">âœ… Answer: ${data.q2.textAnswer}</p>`;
                if (data.q2.explanation) html += `<p style="color:#555;font-size:0.95em;margin-top:6px">ðŸ“– ${data.q2.explanation}</p>`;
            } else {
            html += `<p style="margin-left:20px;padding:8px;background:${data.q2.correct === 'A' ? '#d4edda' : '#f8f9fa'};border-radius:4px">A) ${data.q2.options.A} ${data.q2.correct === 'A' ? 'âœ…' : ''}</p>`;
            html += `<p style="margin-left:20px;padding:8px;background:${data.q2.correct === 'B' ? '#d4edda' : '#f8f9fa'};border-radius:4px">B) ${data.q2.options.B} ${data.q2.correct === 'B' ? 'âœ…' : ''}</p>`;
            html += `<p style="margin-left:20px;padding:8px;background:${data.q2.correct === 'C' ? '#d4edda' : '#f8f9fa'};border-radius:4px">C) ${data.q2.options.C} ${data.q2.correct === 'C' ? 'âœ…' : ''}</p>`;
            html += `<p style="margin-left:20px;padding:8px;background:${data.q2.correct === 'D' ? '#d4edda' : '#f8f9fa'};border-radius:4px">D) ${data.q2.options.D} ${data.q2.correct === 'D' ? 'âœ…' : ''}</p>`;
            html += `<p style="color:#28a745;font-weight:bold;margin-top:15px;font-size:1.1em">âœ“ Correct Answer: ${data.q2.correct}</p>`;
            }
            html += '</div>';
            
            html += `<p style="text-align:center;margin-top:20px;color:#666"><small>Created by: ${data.createdBy || 'Super Admin'}</small></p>`;
            html += '</div>';
            
            view.innerHTML = html;
            view.style.display = 'block';
            
            // Removed scroll - no automatic scrolling to preview
        }
        
        async function viewTodayQuestionsAdmin() {
            const today = getQuizToday();
            try {
                const snap = await db.ref(`quizQuestions/${today}`).once('value');
                const q = snap.val();
                const view = document.getElementById('todayQuestionsViewAdmin');
                
                if (!q) {
                    view.innerHTML = '<div style="background:#fff3cd;padding:15px;border-radius:8px"><p style="margin:0;color:#856404">No questions for today yet.</p></div>';
                    view.style.display = 'block';
                    return;
                }
                
                const createdDate = new Date(q.createdAt);
                const dateStr = createdDate.toLocaleDateString('en-IN', { 
                    weekday: 'long', 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric' 
                });
                const timeStr = createdDate.toLocaleTimeString('en-IN', { 
                    hour: '2-digit', 
                    minute: '2-digit',
                    second: '2-digit'
                });
                
                let html = '<div style="background:#f8f9fa;padding:20px;border-radius:10px">';
                html += '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:15px">';
                html += '<h4 style="color:#667eea;margin:0">Today\'s Questions</h4>';
                html += '<button class="btn btn-small" onclick="editTodayQuestions()" style="background:#ff9800;color:white">âœï¸ Edit Questions</button>';
                html += '</div>';
                html += `<p style="color:#666;font-size:0.95em;margin-bottom:15px">ðŸ“… ${dateStr} | â° ${timeStr}</p>`;
                html += `<p><strong>Q1:</strong> ${q.q1.text}</p>`;
                html += `<p style="margin-left:20px">A) ${q.q1.options.A}</p>`;
                html += `<p style="margin-left:20px">B) ${q.q1.options.B}</p>`;
                html += `<p style="margin-left:20px">C) ${q.q1.options.C}</p>`;
                html += `<p style="margin-left:20px">D) ${q.q1.options.D}</p>`;
                html += `<p style="color:green;font-weight:bold;margin-left:20px">âœ“ Correct: ${q.q1.correct}</p><br>`;
                html += `<p><strong>Q2:</strong> ${q.q2.text}</p>`;
                html += `<p style="margin-left:20px">A) ${q.q2.options.A}</p>`;
                html += `<p style="margin-left:20px">B) ${q.q2.options.B}</p>`;
                html += `<p style="margin-left:20px">C) ${q.q2.options.C}</p>`;
                html += `<p style="margin-left:20px">D) ${q.q2.options.D}</p>`;
                html += `<p style="color:green;font-weight:bold;margin-left:20px">âœ“ Correct: ${q.q2.correct}</p>`;
                html += `<p style="text-align:center;margin-top:15px;color:#666"><small>Created by: ${q.createdBy || 'Super Admin'}</small></p>`;
                html += '</div>';
                
                view.innerHTML = html;
                view.style.display = 'block';
                
                // Check and show publish status
                await checkPublishStatusForAdmin();
            } catch (err) {
                console.error('View error:', err);
            }
        }
        
        async function editTodayQuestions() {
            const today = getQuizToday();
            try {
                const snap = await db.ref(`quizQuestions/${today}`).once('value');
                const q = snap.val();
                
                if (!q) {
                    alert('No questions found to edit!');
                    return;
                }
                
                // Populate the form with existing data
                document.getElementById('quiz_q1Text').value = q.q1.text;
                document.getElementById('quiz_q1OptA').value = q.q1.options.A;
                document.getElementById('quiz_q1OptB').value = q.q1.options.B;
                document.getElementById('quiz_q1OptC').value = q.q1.options.C;
                document.getElementById('quiz_q1OptD').value = q.q1.options.D;
                document.getElementById('quiz_q1Correct').value = q.q1.correct;
                
                document.getElementById('quiz_q2Text').value = q.q2.text;
                document.getElementById('quiz_q2OptA').value = q.q2.options.A;
                document.getElementById('quiz_q2OptB').value = q.q2.options.B;
                document.getElementById('quiz_q2OptC').value = q.q2.options.C;
                document.getElementById('quiz_q2OptD').value = q.q2.options.D;
                document.getElementById('quiz_q2Correct').value = q.q2.correct;
                
                // Scroll to quiz editor
                const qHeading2 = document.getElementById('quizQuestionsHeading');
                if (qHeading2) qHeading2.scrollIntoView({ behavior: 'smooth', block: 'start' });
                
                // Show message
                showQuizMsg('quizAdminMessage', 'âœï¸ Questions loaded for editing. Make changes and click Save.', 'success');
                
            } catch (err) {
                console.error('Edit error:', err);
                alert('Error loading questions for editing: ' + err.message);
            }
        }
        
        // Fix all 11-digit phone numbers (with leading 0) â†’ normalize to 10 digits
        async function fixAllPhoneNumbers() {
            if (!confirm('ðŸ”§ Fix Phone Numbers\n\nThis will scan all registered students and normalize any phone numbers stored with a leading 0 (e.g. 09972652501 â†’ 9972652501).\n\nProceed?')) return;

            try {
                const snap = await db.ref('quizStudents').once('value');
                if (!snap.exists()) { alert('No students found.'); return; }

                const toFix = [];
                snap.forEach(child => {
                    const d = child.val();
                    const raw = String(d.phone || '').replace(/\D/g,'');
                    if (raw.length === 11 && raw.startsWith('0')) {
                        toFix.push({ key: child.key, oldPhone: d.phone, newPhone: raw.slice(1), name: d.name });
                    }
                });

                if (toFix.length === 0) {
                    alert('âœ… All phone numbers are already in correct 10-digit format. No fixes needed!');
                    return;
                }

                const list = toFix.map(f => `â€¢ ${f.name}: ${f.oldPhone} â†’ ${f.newPhone}`).join('\n');
                if (!confirm(`Found ${toFix.length} phone number(s) to fix:\n\n${list}\n\nApply fixes now?`)) return;

                const updates = {};
                toFix.forEach(f => { updates[f.key + '/phone'] = f.newPhone; });
                await db.ref('quizStudents').update(updates);

                alert(`âœ… Fixed ${toFix.length} phone number(s)!\n\n${list}\n\nThese students can now log in normally.`);
                loadQuizStudentsAdmin();
            } catch(e) {
                alert('âŒ Error: ' + e.message);
            }
        }

        async function loadQuizStudentsAdmin() {
            try {
                const snap = await db.ref('quizStudents').once('value');
                window._qsAdminAllStudents = [];
                const tbody = document.getElementById('quizStudentsTableAdmin');
                tbody.innerHTML = '';
                if (!snap.exists()) {
                    tbody.innerHTML = '<tr><td colspan="7" style="text-align:center">No students registered yet.</td></tr>';
                    const ce = document.getElementById('qsAdminCount'); if(ce) ce.textContent='';
                    return;
                }
                const classSet = new Set();
                snap.forEach(child => {
                    const s = child.val();
                    window._qsAdminAllStudents.push(s);
                    if (s.class) classSet.add(s.class);
                });
                const classSel = document.getElementById('qsAdminClassFilter');
                if (classSel) {
                    const prev = classSel.value;
                    classSel.innerHTML = '<option value="">â€” All Classes â€”</option>';
                    [...classSet].sort().forEach(c => {
                        const o = document.createElement('option');
                        o.value = c; o.textContent = c;
                        if (c === prev) o.selected = true;
                        classSel.appendChild(o);
                    });
                }
                qsAdminApplyFilters();
            } catch (err) {
                console.error('Load students error:', err);
            }
        }

        function qsAdminApplyFilters() {
            const all    = window._qsAdminAllStudents || [];
            const search = (document.getElementById('qsAdminSearch')||{value:''}).value.toLowerCase().trim();
            const cls    = (document.getElementById('qsAdminClassFilter')||{value:''}).value;
            const tbody  = document.getElementById('quizStudentsTableAdmin');
            const countEl= document.getElementById('qsAdminCount');
            if (!tbody) return;
            const filtered = all.filter(s => {
                if (cls && s.class !== cls) return false;
                if (search) {
                    const hay = ((s.name||'')+(s.phone||'')+(s.email||'')).toLowerCase();
                    if (!hay.includes(search)) return false;
                }
                return true;
            });
            qsAdminRenderRows(filtered, tbody, all.length);
            if (countEl) countEl.textContent = filtered.length + ' of ' + all.length + ' students';
        }

        function qsAdminEmailBadge(s) {
            const st = s.emailStatus || 'unknown';
            if (st === 'sent')    return '<span style="background:#e8f5e9;color:#2e7d32;padding:2px 9px;border-radius:8px;font-size:11px;font-weight:700">âœ… Sent</span>';
            if (st === 'failed')  return `<span style="background:#ffebee;color:#c62828;padding:2px 9px;border-radius:8px;font-size:11px;font-weight:700" title="${s.emailError||''}">âŒ Failed</span>`;
            if (st === 'pending') return '<span style="background:#fff3cd;color:#856404;padding:2px 9px;border-radius:8px;font-size:11px;font-weight:700">â³ Pending</span>';
            return '<span style="background:#f5f5f5;color:#757575;padding:2px 9px;border-radius:8px;font-size:11px">â€” Unknown</span>';
        }

        function qsAdminRenderRows(filtered, tbody, total) {
            tbody.innerHTML = '';
            if (!filtered.length) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;color:#999;padding:16px">No students match the filter.</td></tr>';
                return;
            }
            filtered.forEach((s,i) => {
                const row = tbody.insertRow();
                row.innerHTML = `<td>${i+1}</td>
                    <td><strong>${s.name||''}</strong></td>
                    <td style="font-size:12px">${s.email||''}</td>
                    <td>${s.phone||''}</td>
                    <td style="background:#fff3cd;font-family:monospace;font-weight:bold">${s.password||''}</td>
                    <td><span style="background:#e8f5e9;color:#2e7d32;padding:2px 8px;border-radius:8px;font-size:12px;font-weight:700">${s.class||''}</span></td>
                    <td style="font-size:12px">${s.registeredAt ? new Date(s.registeredAt).toLocaleDateString('en-IN') : 'â€”'}</td>
                    <td>${qsAdminEmailBadge(s)}</td>`;
            });
        }

        function qsAdminShowDuplicates() {
            const all    = window._qsAdminAllStudents || [];
            const tbody  = document.getElementById('quizStudentsTableAdmin');
            const countEl= document.getElementById('qsAdminCount');
            if (!tbody) return;

            // Find duplicate phones
            const phoneMap = {}, emailMap = {};
            all.forEach(s => {
                if (s.phone) { if (!phoneMap[s.phone]) phoneMap[s.phone]=[]; phoneMap[s.phone].push(s); }
                if (s.email) { const em=(s.email||'').toLowerCase(); if (!emailMap[em]) emailMap[em]=[]; emailMap[em].push(s); }
            });
            const dupPhones = Object.entries(phoneMap).filter(([,arr])=>arr.length>1);
            const dupEmails = Object.entries(emailMap).filter(([,arr])=>arr.length>1);

            tbody.innerHTML = '';
            if (!dupPhones.length && !dupEmails.length) {
                tbody.innerHTML = '<tr><td colspan="9" style="text-align:center;padding:20px"><span style="background:#e8f5e9;color:#2e7d32;padding:8px 20px;border-radius:10px;font-weight:700">âœ… No duplicate phones or emails found!</span></td></tr>';
                if (countEl) countEl.textContent = '0 duplicates found';
                return;
            }

            // Bulk delete button at top
            const bulkRow = tbody.insertRow();
            bulkRow.innerHTML = `<td colspan="9" style="padding:10px 14px;background:#fce4ec;border-bottom:2px solid #f48fb1">
                <button onclick="qsAdminDeleteOlderDuplicates()" style="background:linear-gradient(135deg,#c62828,#e53935);color:white;border:none;border-radius:8px;padding:9px 20px;font-weight:700;cursor:pointer;font-size:0.88em">
                    ðŸ—‘ï¸ Auto-Delete Older Duplicates (keep newest per phone)
                </button>
                <span style="color:#880e4f;font-size:0.82em;margin-left:12px">Or use the individual ðŸ—‘ï¸ Delete buttons below to choose which record to remove.</span>
            </td>`;

            let count = 0;
            const rendered = new Set();

            if (dupPhones.length) {
                const hdr = tbody.insertRow();
                hdr.innerHTML = '<td colspan="9" style="background:#fff3e0;color:#e65100;font-weight:800;padding:8px 14px;font-size:0.9em">ðŸ“ž DUPLICATE PHONE NUMBERS</td>';
                dupPhones.forEach(([phone, students]) => {
                    // Sort: newest first
                    students.sort((a,b) => new Date(b.registeredAt||0) - new Date(a.registeredAt||0));
                    students.forEach((s, si) => {
                        const key = (s.email||'')+s.phone;
                        if (rendered.has(key)) return;
                        rendered.add(key);
                        const isOldest = si === students.length - 1;
                        const row = tbody.insertRow();
                        row.id = 'qsRow_' + s.id;
                        row.style.background = isOldest ? '#fff3e0' : '#fff8e1';
                        row.innerHTML = `<td style="color:#e65100;font-weight:700">âš ï¸</td>
                            <td><strong>${s.name||''}</strong>${si===0?'<br><span style="font-size:10px;background:#e8f5e9;color:#1b5e20;padding:1px 6px;border-radius:6px">âœ… Newest</span>':''}</td>
                            <td style="font-size:12px">${s.email||''}</td>
                            <td style="background:#ffecb3;font-weight:800;color:#e65100">${s.phone||''} <span style="font-size:10px">(${students.length} accounts)</span></td>
                            <td style="background:#fff3cd;font-family:monospace;font-weight:bold">${s.password||''}</td>
                            <td><span style="background:#e8f5e9;color:#2e7d32;padding:2px 8px;border-radius:8px;font-size:12px">${s.class||''}</span></td>
                            <td style="font-size:12px">${s.registeredAt ? new Date(s.registeredAt).toLocaleDateString('en-IN') : 'â€”'}</td>
                            <td>${qsAdminEmailBadge(s)}</td>
                            <td><button onclick="qsAdminDeleteStudent('${s.id}','${(s.name||'').replace(/'/g,'')}')" style="background:#c62828;color:white;border:none;border-radius:6px;padding:5px 12px;font-size:0.78em;font-weight:700;cursor:pointer">ðŸ—‘ï¸ Delete</button></td>`;
                        count++;
                    });
                });
            }

            if (dupEmails.length) {
                const hdr = tbody.insertRow();
                hdr.innerHTML = '<td colspan="9" style="background:#fce4ec;color:#880e4f;font-weight:800;padding:8px 14px;font-size:0.9em">ðŸ“§ DUPLICATE EMAIL ADDRESSES</td>';
                dupEmails.forEach(([email, students]) => {
                    students.sort((a,b) => new Date(b.registeredAt||0) - new Date(a.registeredAt||0));
                    students.forEach((s, si) => {
                        const key = 'em_'+(s.email||'')+s.phone;
                        if (rendered.has(key)) return;
                        rendered.add(key);
                        const row = tbody.insertRow();
                        row.id = 'qsRow_' + s.id;
                        row.style.background = '#fce4ec';
                        row.innerHTML = `<td style="color:#880e4f;font-weight:700">âš ï¸</td>
                            <td><strong>${s.name||''}</strong>${si===0?'<br><span style="font-size:10px;background:#e8f5e9;color:#1b5e20;padding:1px 6px;border-radius:6px">âœ… Newest</span>':''}</td>
                            <td style="background:#f8bbd0;font-weight:800;color:#880e4f;font-size:12px">${s.email||''} <span style="font-size:10px">(${students.length} accounts)</span></td>
                            <td>${s.phone||''}</td>
                            <td style="background:#fff3cd;font-family:monospace;font-weight:bold">${s.password||''}</td>
                            <td><span style="background:#e8f5e9;color:#2e7d32;padding:2px 8px;border-radius:8px;font-size:12px">${s.class||''}</span></td>
                            <td style="font-size:12px">${s.registeredAt ? new Date(s.registeredAt).toLocaleDateString('en-IN') : 'â€”'}</td>
                            <td>${qsAdminEmailBadge(s)}</td>
                            <td><button onclick="qsAdminDeleteStudent('${s.id}','${(s.name||'').replace(/'/g,'')}')" style="background:#880e4f;color:white;border:none;border-radius:6px;padding:5px 12px;font-size:0.78em;font-weight:700;cursor:pointer">ðŸ—‘ï¸ Delete</button></td>`;
                        count++;
                    });
                });
            }

            if (countEl) countEl.textContent = `âš ï¸ ${dupPhones.length} dup phone group(s), ${dupEmails.length} dup email group(s)`;
        }

        async function qsAdminDeleteStudent(id, name) {
            if (!confirm(`ðŸ—‘ï¸ Delete student record?\n\nName: ${name}\nID: ${id}\n\nThis cannot be undone.`)) return;
            try {
                await db.ref('quizStudents/' + id).remove();
                // Reload fresh from Firebase then re-show duplicates
                const snap = await db.ref('quizStudents').once('value');
                window._qsAdminAllStudents = [];
                if (snap.exists()) snap.forEach(ch => { const s = ch.val(); s.id = ch.key; window._qsAdminAllStudents.push(s); });
                alert('âœ… Deleted: ' + name);
                qsAdminShowDuplicates();
            } catch(e) {
                alert('âŒ Error deleting: ' + e.message);
            }
        }

        async function qsAdminDeleteOlderDuplicates() {
            const all = window._qsAdminAllStudents || [];
            const phoneMap = {};
            all.forEach(s => {
                if (s.phone) { if (!phoneMap[s.phone]) phoneMap[s.phone]=[]; phoneMap[s.phone].push(s); }
            });
            const dupGroups = Object.entries(phoneMap).filter(([,arr])=>arr.length>1);
            if (!dupGroups.length) { alert('No duplicates to delete.'); return; }

            // For each group, keep newest (highest registeredAt), delete the rest
            const toDelete = [];
            dupGroups.forEach(([, students]) => {
                const sorted = [...students].sort((a,b) => new Date(b.registeredAt||0) - new Date(a.registeredAt||0));
                sorted.slice(1).forEach(s => toDelete.push(s));
            });

            const list = toDelete.map(s => `â€¢ ${s.name} (${s.phone}, registered ${s.registeredAt ? new Date(s.registeredAt).toLocaleDateString('en-IN') : '?'})`).join('\n');
            if (!confirm(`ðŸ—‘ï¸ Delete ${toDelete.length} older duplicate(s)?\n\nWill DELETE:\n${list}\n\n(Keeping the newest registration for each phone number)\n\nThis cannot be undone.`)) return;

            try {
                for (const s of toDelete) {
                    await db.ref('quizStudents/' + s.id).remove();
                }
                alert(`âœ… Deleted ${toDelete.length} duplicate record(s) successfully!`);
                // Reload fresh from Firebase then re-show duplicates
                const snap = await db.ref('quizStudents').once('value');
                window._qsAdminAllStudents = [];
                if (snap.exists()) snap.forEach(ch => { const s = ch.val(); s.id = ch.key; window._qsAdminAllStudents.push(s); });
                qsAdminShowDuplicates();
            } catch(e) {
                alert('âŒ Error: ' + e.message);
            }
        }

        function qsAdminShowEmailFailed() {
            const all    = window._qsAdminAllStudents || [];
            const tbody  = document.getElementById('quizStudentsTableAdmin');
            const countEl= document.getElementById('qsAdminCount');
            if (!tbody) return;

            const failed = all.filter(s => s.emailStatus === 'failed' || (!s.emailStatus && s.registeredAt));
            const unknown = all.filter(s => !s.emailStatus);

            tbody.innerHTML = '';

            if (failed.length || unknown.length) {
                if (failed.length) {
                    const hdr = tbody.insertRow();
                    hdr.innerHTML = '<td colspan="8" style="background:#ffebee;color:#c62828;font-weight:800;padding:8px 14px;font-size:0.9em">âŒ EMAIL DELIVERY FAILED</td>';
                    failed.forEach((s,i) => {
                        const row = tbody.insertRow();
                        row.style.background = '#fff5f5';
                        row.innerHTML = `<td>${i+1}</td>
                            <td><strong>${s.name||''}</strong></td>
                            <td style="background:#ffebee;font-size:12px">${s.email||''}</td>
                            <td>${s.phone||''}</td>
                            <td style="background:#fff3cd;font-family:monospace;font-weight:bold">${s.password||''}</td>
                            <td><span style="background:#e8f5e9;color:#2e7d32;padding:2px 8px;border-radius:8px;font-size:12px">${s.class||''}</span></td>
                            <td style="font-size:12px">${s.registeredAt ? new Date(s.registeredAt).toLocaleDateString('en-IN') : 'â€”'}</td>
                            <td><span style="background:#ffebee;color:#c62828;padding:2px 9px;border-radius:8px;font-size:11px;font-weight:700" title="${s.emailError||''}">âŒ Failed${s.emailError?'<br><span style=font-size:10px>'+s.emailError+'</span>':''}</span></td>`;
                    });
                }
                if (unknown.length) {
                    const hdr2 = tbody.insertRow();
                    hdr2.innerHTML = '<td colspan="8" style="background:#e3f2fd;color:#1565c0;font-weight:800;padding:8px 14px;font-size:0.9em">âš ï¸ EMAIL STATUS UNKNOWN (registered before tracking was added)</td>';
                    unknown.forEach((s,i) => {
                        const row = tbody.insertRow();
                        row.innerHTML = `<td>${i+1}</td>
                            <td><strong>${s.name||''}</strong></td>
                            <td style="font-size:12px">${s.email||''}</td>
                            <td>${s.phone||''}</td>
                            <td style="background:#fff3cd;font-family:monospace;font-weight:bold">${s.password||''}</td>
                            <td><span style="background:#e8f5e9;color:#2e7d32;padding:2px 8px;border-radius:8px;font-size:12px">${s.class||''}</span></td>
                            <td style="font-size:12px">${s.registeredAt ? new Date(s.registeredAt).toLocaleDateString('en-IN') : 'â€”'}</td>
                            <td><span style="background:#e3f2fd;color:#1565c0;padding:2px 9px;border-radius:8px;font-size:11px">âš ï¸ Unknown</span></td>`;
                    });
                }
            } else {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;padding:20px"><span style="background:#e8f5e9;color:#2e7d32;padding:8px 20px;border-radius:10px;font-weight:700">âœ… All emails delivered successfully!</span></td></tr>';
            }

            if (countEl) countEl.textContent = `${failed.length} failed Â· ${unknown.length} unknown`;
        }

        function qsAdminResetFilters() {
            const si = document.getElementById('qsAdminSearch');
            const ci = document.getElementById('qsAdminClassFilter');
            if (si) si.value = '';
            if (ci) ci.value = '';
            qsAdminApplyFilters();
        }

        async function qsAdminShowSummary() {
            const box        = document.getElementById('qsAdminSummaryBox');
            const contentEl  = document.getElementById('qsAdminSummaryContent');
            const msgBox     = document.getElementById('qsAdminMsgBox');
            if (!box) return;
            box.style.display = 'block';
            contentEl.innerHTML = '<p style="color:#999;text-align:center;padding:12px">&#9203; Loading class strengths&hellip;</p>';
            if (msgBox) msgBox.style.display = 'none';

            try {
                const ss = await db.ref('leaderboardConfig/classStrengths').once('value');
                window._classStrengths = ss.val() || {};
            } catch(e) { window._classStrengths = window._classStrengths || {}; }

            const all       = window._qsAdminAllStudents || [];
            const strengths = window._classStrengths || {};

            function normKey(s) {
                return String(s||'').toLowerCase().replace(/\./g,'_').replace(/\s+/g,' ').trim();
            }
            function getStrength(cls) {
                // Firebase sanitises '.' â†’ '_' in keys, so check both forms
                const sk = cls.replace(/[.\[\]#$\/]/g,'_');
                const nk = normKey(cls);
                return strengths[cls] || strengths[sk] ||
                    ((Object.entries(strengths).find(([k]) => normKey(k)===nk))||[])[1] || 0;
            }

            const regMap = {};
            all.forEach(s => {
                const cls = (s.class||'Unknown').trim();
                if (!regMap[cls]) regMap[cls] = [];
                regMap[cls].push(s);
            });

            // Also show classes that have strength set but 0 registrations
            Object.keys(strengths).forEach(k => {
                const match = Object.keys(regMap).find(c => normKey(c)===normKey(k));
                if (!match && strengths[k] > 0) regMap[k] = regMap[k] || [];
            });

            const sortedClasses = Object.keys(regMap).filter(c=>c!=='Unknown').sort();
            if (regMap['Unknown'] && regMap['Unknown'].length) sortedClasses.push('Unknown');

            let totalReg=0, totalStrength=0, totalMissing=0;
            const classLines = [];

            let tableHTML = `<div style="overflow-x:auto"><table style="width:100%;border-collapse:collapse;font-size:13px">
            <thead><tr style="background:#6a1b9a;color:white">
                <th style="padding:10px 14px;text-align:left">Class</th>
                <th style="padding:10px 14px;text-align:center">Strength</th>
                <th style="padding:10px 14px;text-align:center">Registered</th>
                <th style="padding:10px 14px;text-align:center">Missing</th>
                <th style="padding:10px 14px;text-align:center">Coverage</th>
                <th style="padding:10px 14px;text-align:center">Progress</th>
            </tr></thead><tbody>`;

            sortedClasses.forEach((cls, i) => {
                const students = regMap[cls] || [];
                const reg      = students.length;
                const strength = getStrength(cls);
                const missing  = strength ? Math.max(0, strength - reg) : null;
                const pct      = strength ? Math.round((reg/strength)*100) : null;
                const extra    = strength && reg > strength ? reg - strength : 0;
                totalReg += reg;
                if (strength) { totalStrength += strength; totalMissing += (missing||0); }

                const pctColor  = pct===null?'#9e9e9e':pct>=80?'#2e7d32':pct>=50?'#e65100':'#c62828';
                const barColor  = pct===null?'#bdbdbd':pct>=80?'#4caf50':pct>=50?'#ff9800':'#f44336';
                const rowBg     = i%2===0?'#fafafa':'white';
                const barFill   = pct!=null ? Math.min(100,pct) : 0;
                const barHTML   = `<div style="background:#e0e0e0;border-radius:6px;height:10px;width:90px;display:inline-block;vertical-align:middle"><div style="background:${barColor};height:10px;border-radius:6px;width:${barFill}%"></div></div>`;

                tableHTML += `<tr style="background:${rowBg}">
                    <td style="padding:9px 14px;font-weight:600;color:#3d0060">${cls}</td>
                    <td style="padding:9px 14px;text-align:center;color:#555">${strength||'&mdash;'}</td>
                    <td style="padding:9px 14px;text-align:center">
                        <span style="background:#e8f5e9;color:#2e7d32;padding:3px 10px;border-radius:10px;font-weight:700">${reg}</span>
                        ${extra>0?`<span style="font-size:11px;color:#1565c0;margin-left:4px">+${extra} extra</span>`:''}
                    </td>
                    <td style="padding:9px 14px;text-align:center">
                        ${missing!=null?`<span style="background:${missing>0?'#fff3cd':'#e8f5e9'};color:${missing>0?'#856404':'#2e7d32'};padding:3px 10px;border-radius:10px;font-weight:700">${missing}</span>`:'&mdash;'}
                    </td>
                    <td style="padding:9px 14px;text-align:center;font-weight:800;color:${pctColor}">
                        ${pct!=null?pct+'%':'&mdash;'}
                    </td>
                    <td style="padding:9px 14px;text-align:center">${barHTML}</td>
                </tr>`;

                const coverageStr = pct!=null ? ` (${pct}% of ${strength})` : '';
                const missingStr  = missing>0 ? `, ${missing} yet to register` : (missing===0?' \u2705 full coverage':'');
                classLines.push(`\u2022 ${cls}: ${reg} registered${coverageStr}${missingStr}`);
            });

            const totalPct = totalStrength ? Math.round((totalReg/totalStrength)*100) : null;
            tableHTML += `<tr style="background:#f3e5f5;font-weight:800">
                <td style="padding:10px 14px;color:#6a1b9a">TOTAL</td>
                <td style="padding:10px 14px;text-align:center;color:#6a1b9a">${totalStrength||'&mdash;'}</td>
                <td style="padding:10px 14px;text-align:center"><span style="background:#6a1b9a;color:white;padding:3px 10px;border-radius:10px;font-weight:700">${totalReg}</span></td>
                <td style="padding:10px 14px;text-align:center"><span style="background:#fff3cd;color:#856404;padding:3px 10px;border-radius:10px;font-weight:700">${totalMissing}</span></td>
                <td style="padding:10px 14px;text-align:center;color:#6a1b9a;font-size:1.1em">${totalPct!=null?totalPct+'%':'&mdash;'}</td>
                <td style="padding:10px 14px;text-align:center">
                    <div style="background:#e0e0e0;border-radius:6px;height:10px;width:90px;display:inline-block;vertical-align:middle">
                        <div style="background:#6a1b9a;height:10px;border-radius:6px;width:${Math.min(100,totalPct||0)}%"></div>
                    </div>
                </td>
            </tr></tbody></table></div>`;

            contentEl.innerHTML = tableHTML;

            // Build copyable WhatsApp message
            const now      = new Date();
            const dateStr  = now.toLocaleDateString('en-IN',{weekday:'long',day:'numeric',month:'long',year:'numeric'});
            const timeStr  = now.toLocaleTimeString('en-IN',{hour:'2-digit',minute:'2-digit',hour12:true});
            const coverLine = totalPct!=null
                ? `Overall coverage: ${totalReg}/${totalStrength} students (${totalPct}%)`
                : `Total registered: ${totalReg} students`;
            const alertLine = totalMissing>0
                ? `\u26a0\ufe0f ${totalMissing} student(s) still not registered`
                : `\u2705 All tracked classes have full registration!`;

            const msgText = [
                `\ud83d\udcca *Quiz Registration Summary*`,
                `\ud83d\udcc5 ${dateStr}  \ud83d\udd50 ${timeStr}`,
                ``,
                coverLine,
                alertLine,
                ``,
                `*Class-wise Breakdown:*`,
                ...classLines,
                ``,
                `_Please remind unregistered students to sign up._`,
                ``,
                `\ud83d\udd17 https://harshgujjar.github.io/Spurthi-youth-fest-2026/`
            ].join('\n');

            const msgTextEl = document.getElementById('qsAdminMsgText');
            if (msgTextEl) msgTextEl.value = msgText;
            if (msgBox) msgBox.style.display = 'block';
            box.scrollIntoView({behavior:'smooth', block:'nearest'});
        }

        function qsAdminCopyMsg() {
            const el = document.getElementById('qsAdminMsgText');
            if (!el) return;
            const btn = event.currentTarget || event.target;
            const origText = btn.textContent;
            const origBg   = btn.style.background;
            navigator.clipboard.writeText(el.value).then(() => {
                btn.textContent = '\u2705 Copied!';
                btn.style.background = '#4caf50';
                setTimeout(() => { btn.textContent = origText; btn.style.background = origBg; }, 2200);
            }).catch(() => {
                el.select();
                document.execCommand('copy');
                btn.textContent = '\u2705 Copied!';
                setTimeout(() => { btn.textContent = origText; }, 2000);
            });
        }

        
        async function loadQuizSubmissionsAdmin() {
            const today = getQuizToday();
            try {
                const snap = await db.ref(`quizSubmissions/${today}`).once('value');
                const tbody = document.getElementById('quizSubmissionsTableAdmin');
                tbody.innerHTML = '';

                // Populate class filter dropdown
                const classSet = new Set();
                const allRows = [];
                if (snap.exists()) {
                    snap.forEach(child => {
                        const s = child.val();
                        allRows.push(s);
                        if (s.studentClass) classSet.add(s.studentClass);
                    });
                }
                const classFilter = document.getElementById('qsClassFilter');
                if (classFilter) {
                    const prev = classFilter.value;
                    classFilter.innerHTML = '<option value="">All Classes</option>';
                    [...classSet].sort().forEach(c => {
                        const o = document.createElement('option');
                        o.value = c; o.textContent = c;
                        if (c === prev) o.selected = true;
                        classFilter.appendChild(o);
                    });
                }

                // Store rows globally for client-side filter
                window._qsAllRows = allRows;
                filterSubmissionsTable();

                // Populate date dropdown and auto-load stats for today
                await populateQsDateFilter();
                const dateSel = document.getElementById('qsDateFilter');
                if (dateSel && !dateSel.value) {
                    dateSel.value = today;
                }
                loadClassStats();

            } catch (err) {
                console.error('Load submissions error:', err);
            }
        }

        function filterSubmissionsTable() {
            const tbody = document.getElementById('quizSubmissionsTableAdmin');
            if (!tbody) return;
            const rows = window._qsAllRows || [];
            const classF = (document.getElementById('qsClassFilter') || {}).value || '';
            const scoreF = (document.getElementById('qsScoreFilter') || {}).value;
            tbody.innerHTML = '';

            if (rows.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;color:#999">No submissions yet today.</td></tr>';
                return;
            }
            let idx = 1;
            rows.filter(s => {
                if (classF && s.studentClass !== classF) return false;
                if (scoreF !== '' && scoreF !== undefined && String(s.score) !== scoreF) return false;
                return true;
            }).forEach(s => {
                const row = tbody.insertRow();
                const mins = Math.floor(s.timeTaken / 60);
                const secs = s.timeTaken % 60;
                const scoreBg = s.score === 2 ? '#d4edda' : s.score === 1 ? '#fff3cd' : '#f8d7da';
                const scoreCol = s.score === 2 ? '#155724' : s.score === 1 ? '#856404' : '#721c24';
                row.innerHTML = `<td>${idx++}</td><td>${s.studentName||''}</td><td>${s.studentEmail||''}</td>
                    <td><span style="background:#f3e5ff;color:#4a148c;padding:2px 8px;border-radius:10px;font-size:12px">${s.studentClass||''}</span></td>
                    <td style="font-size:12px">${new Date(s.submittedAt).toLocaleString('en-IN')}</td>
                    <td><span style="background:${scoreBg};color:${scoreCol};padding:3px 10px;border-radius:10px;font-weight:700">${s.score}/2</span></td>
                    <td style="font-size:12px">${mins}m ${secs}s</td>`;
            });
            if (idx === 1) tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;color:#999">No matching submissions.</td></tr>';
        }

        async function populateQsDateFilter() {
            try {
                // Read from BOTH quizQuestions AND quizSubmissions so all dates appear
                const [questSnap, subSnap] = await Promise.all([
                    db.ref('quizQuestions').once('value'),
                    db.ref('quizSubmissions').once('value')
                ]);
                const today = getQuizToday();
                const datesSet = new Set();
                if (questSnap.exists()) questSnap.forEach(d => datesSet.add(d.key));
                // Use Object.keys on the raw value to get ALL child keys from quizSubmissions
                if (subSnap.exists()) {
                    const subVal = subSnap.val();
                    if (subVal && typeof subVal === 'object') {
                        Object.keys(subVal).forEach(k => datesSet.add(k));
                    }
                }
                const dates = Array.from(datesSet);
                // Always include today even if no questions/submissions yet
                if (!dates.includes(today)) dates.push(today);
                dates.sort((a,b) => b.localeCompare(a));
                console.log('[populateQsDateFilter] dates found:', dates);

                function fillSelect(sel) {
                    if (!sel) return;
                    const cur = sel.value;
                    sel.innerHTML = '<option value="">â€” Select Date â€”</option>';
                    dates.forEach(d => {
                        const o = document.createElement('option');
                        o.value = d;
                        const label = new Date(d + 'T00:00:00').toLocaleDateString('en-IN',{weekday:'short',day:'numeric',month:'short',year:'numeric'});
                        o.textContent = d === today ? label + ' (Today)' : label;
                        if (d === cur || (!cur && d === today)) o.selected = true;
                        sel.appendChild(o);
                    });
                }

                // Populate admin submissions date filter (may not exist if CR logged in)
                fillSelect(document.getElementById('qsDateFilter'));
                // Populate CR date filter (may not exist if admin logged in)
                fillSelect(document.getElementById('crQsDateFilter'));

            } catch(e) { console.warn('populateQsDateFilter error:', e); }
        }

        async function loadClassStats() {
            const sel  = document.getElementById('qsDateFilter');
            const date = sel ? sel.value : getQuizToday();
            const container = document.getElementById('qsClassBreakdown');
            const infoBox   = document.getElementById('qsInfoBox');
            const pillTotal  = document.getElementById('qsPillTotal');
            const pillCorrect= document.getElementById('qsPillCorrect');
            const pillClass  = document.getElementById('qsPillClasses');
            if (!date) {
                if (container) container.innerHTML = '<p style="color:#999;font-size:13px;text-align:center;padding:12px">Select a date above</p>';
                return;
            }
            if (container) container.innerHTML = '<p style="color:#aaa;font-size:13px;text-align:center;padding:12px">â³ Loadingâ€¦</p>';
            try {
                const snap = await db.ref(`quizSubmissions/${date}`).once('value');
                const dateStr = new Date(date + 'T00:00:00').toLocaleDateString('en-IN',{weekday:'long',day:'numeric',month:'long',year:'numeric'});

                if (!snap.exists()) {
                    if (container) container.innerHTML = `<p style="color:#999;font-size:13px;text-align:center;padding:12px">No submissions found for ${dateStr}</p>`;
                    if (pillTotal) pillTotal.textContent = 'Total: 0';
                    if (pillCorrect) pillCorrect.textContent = 'Both Correct: 0';
                    if (pillClass) pillClass.textContent = 'Classes: 0';
                    if (infoBox) infoBox.style.display = 'none';
                    return;
                }

                // Aggregate by class
                const classMap = {}; // class â†’ {total, correct, partial, none, students[]}
                let grandTotal = 0, grandCorrect = 0;
                snap.forEach(child => {
                    const s = child.val();
                    const cls = s.studentClass || 'Unknown';
                    if (!classMap[cls]) classMap[cls] = {total:0, correct:0, partial:0, none:0};
                    classMap[cls].total++;
                    grandTotal++;
                    if (s.score === 2) { classMap[cls].correct++; grandCorrect++; }
                    else if (s.score === 1) classMap[cls].partial++;
                    else classMap[cls].none++;
                });

                const classCount = Object.keys(classMap).length;
                if (pillTotal)   pillTotal.textContent   = `Total: ${grandTotal}`;
                if (pillCorrect) pillCorrect.textContent = `Both Correct: ${grandCorrect}`;
                if (pillClass)   pillClass.textContent   = `Classes: ${classCount}`;

                // Build class breakdown table
                const sorted = Object.entries(classMap).sort((a,b) => b[1].total - a[1].total);
                let html = `<div class="table-wrapper" style="margin:0"><table style="font-size:13px">
                    <thead><tr>
                        <th style="background:#3d0060;color:#ffd700">Class</th>
                        <th style="background:#3d0060;color:white">Participated</th>
                        <th style="background:#3d0060;color:#a5d6a7">Both Correct âœ…</th>
                        <th style="background:#3d0060;color:#fff3cd">Partial (1/2) âš ï¸</th>
                        <th style="background:#3d0060;color:#f5c6cb">None (0/2) âŒ</th>
                        <th style="background:#3d0060;color:#80deea">Accuracy</th>
                    </tr></thead><tbody>`;
                sorted.forEach(([cls, d]) => {
                    const acc = d.total > 0 ? Math.round((d.correct/d.total)*100) : 0;
                    const barColor = acc >= 70 ? '#28a745' : acc >= 40 ? '#ffc107' : '#dc3545';
                    html += `<tr>
                        <td><strong>${cls}</strong></td>
                        <td style="text-align:center;font-weight:700">${d.total}</td>
                        <td style="text-align:center;color:#155724;font-weight:600">${d.correct}</td>
                        <td style="text-align:center;color:#856404">${d.partial}</td>
                        <td style="text-align:center;color:#721c24">${d.none}</td>
                        <td style="min-width:90px">
                            <div style="display:flex;align-items:center;gap:6px">
                                <div style="flex:1;background:#eee;border-radius:4px;height:8px;overflow:hidden">
                                    <div style="width:${acc}%;background:${barColor};height:100%;border-radius:4px;transition:width 0.4s"></div>
                                </div>
                                <span style="font-size:11px;font-weight:700;color:${barColor};min-width:30px">${acc}%</span>
                            </div>
                        </td>
                    </tr>`;
                });
                html += '</tbody></table></div>';
                if (container) container.innerHTML = html;

                // Build info text box â€” fetch class strengths from leaderboard config
                const infoDateEl = document.getElementById('qsInfoDate');
                const infoTextEl = document.getElementById('qsInfoText');
                const _qsDisplayTime = new Date().toLocaleTimeString('en-IN',{hour:'2-digit',minute:'2-digit',hour12:true});
                if (!window._classStrengths) {
                    try { const ss = await db.ref('leaderboardConfig/classStrengths').once('value'); window._classStrengths = ss.val() || {}; } catch(e) { window._classStrengths = {}; }
                }
                const _qsStr = window._classStrengths || {};
                function _normCls(s){ return String(s).toLowerCase().replace(/[^a-z0-9]/g,''); }
                function _getStrength(map, cls){ const n=_normCls(cls); const k=Object.keys(map).find(k=>_normCls(k)===n); return k?map[k]:0; }
                if (infoDateEl) infoDateEl.textContent = dateStr;
                if (infoTextEl) {
                    let infoLines = `<span style="color:#888;font-size:12px">ðŸ• Generated at: <strong>${_qsDisplayTime}</strong></span><br><br>`;
                    infoLines += `<strong>${grandTotal}</strong> students participated across <strong>${classCount}</strong> classes.<br>`;
                    infoLines += `<strong>${grandCorrect}</strong> got both questions correct (${grandTotal>0?Math.round((grandCorrect/grandTotal)*100):0}% accuracy).<br><br>`;
                    infoLines += '<strong>Class-wise breakdown:</strong><br>';
                    sorted.forEach(([cls,d]) => {
                        const acc = d.total>0?Math.round((d.correct/d.total)*100):0;
                        const strength = _getStrength(_qsStr, cls);
                        const strengthTag = strength ? `<span style="color:#888;font-size:0.92em">(Class Strength: ${strength})</span> ` : '';
                        infoLines += `â€¢ ${cls}: ${strengthTag}<strong>${d.total}</strong> participated, <strong>${d.correct}</strong> correct (${acc}%)<br>`;
                    });
                    infoTextEl.innerHTML = infoLines;
                }
                if (infoBox) infoBox.style.display = 'block';
                // Save for copy
                const _qsNow = new Date().toLocaleTimeString('en-IN',{hour:'2-digit',minute:'2-digit',hour12:true});
                window._qsLastInfoText = `ðŸ“‹ Quiz Summary â€” ${dateStr}\nðŸ• Generated at: ${_qsNow}\n\n${grandTotal} students participated across ${classCount} classes.\n${grandCorrect} got both questions correct (${grandTotal>0?Math.round((grandCorrect/grandTotal)*100):0}% accuracy).\n\nClass-wise breakdown:\n` +
                    sorted.map(([cls,d]) => {
                        const strength = _getStrength(_qsStr, cls);
                        const strengthTxt = strength ? `[Class Strength: ${strength}] ` : '';
                        return `â€¢ ${cls}: ${strengthTxt}${d.total} participated, ${d.correct} correct (${d.total>0?Math.round((d.correct/d.total)*100):0}%)`;
                    }).join('\n') +
                    `\n\nâ€” Spurthi Youth Fest 2026\nðŸ”— https://harshgujjar.github.io/Spurthi-youth-fest-2026/`;

            } catch(e) {
                if (container) container.innerHTML = `<p style="color:red;font-size:13px;padding:12px">Error: ${e.message}</p>`;
            }
        }

        function copyQsInfo() {
            const txt = window._qsLastInfoText || '';
            if (!txt) return;
            navigator.clipboard.writeText(txt).then(()=>{
                const btn = document.querySelector('[onclick="copyQsInfo()"]');
                if (btn) { const orig=btn.textContent; btn.textContent='âœ… Copied!'; setTimeout(()=>btn.textContent=orig,2000); }
            }).catch(()=>{ /* fallback */ });
        }

        async function loadCRQuizStats() {
            const crClass  = (window.currentCRClass || '').trim() || (document.getElementById('crClassName')||{}).textContent.trim() || '';
            const dateSel  = document.getElementById('crQsDateFilter');
            // Populate dates first
            await populateQsDateFilter();
            const date = dateSel ? dateSel.value || getQuizToday() : getQuizToday();
            if (dateSel && !dateSel.value) dateSel.value = date;

            const dateStr  = new Date(date + 'T00:00:00').toLocaleDateString('en-IN',{weekday:'long',day:'numeric',month:'long',year:'numeric'});
            const infoDate = document.getElementById('crQsInfoDate');
            const infoText = document.getElementById('crQsInfoText');
            const tbody    = document.getElementById('crQsTable');
            const totEl    = document.getElementById('crQsTotal');
            const corrEl   = document.getElementById('crQsCorrect');
            const partEl   = document.getElementById('crQsPartial');
            const rateEl   = document.getElementById('crQsRate');
            if (infoDate) infoDate.textContent = dateStr;
            if (tbody) tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;color:#aaa">â³ Loadingâ€¦</td></tr>';
            if (infoText) infoText.textContent = 'â³ Loadingâ€¦';
            try {
                // Fetch class strength first â€” always re-fetch fresh for accuracy
                try { const ss = await db.ref('leaderboardConfig/classStrengths').once('value'); window._classStrengths = ss.val() || {}; } catch(e) { window._classStrengths = window._classStrengths || {}; }
                const _crSafeKey = crClass ? crClass.replace(/[.\[\]#$\/]/g,'_') : '';
                const crClassStrength = (window._classStrengths[_crSafeKey] || window._classStrengths[crClass] || 0);
                const crStrengthTag = crClassStrength ? ` <span style="color:#888;font-size:0.92em">(Class Strength: ${crClassStrength})</span>` : '';

                const snap = await db.ref(`quizSubmissions/${date}`).once('value');
                if (!snap.exists()) {
                    if (totEl) totEl.textContent = '0';
                    if (corrEl) corrEl.textContent = '0';
                    if (partEl) partEl.textContent = '0';
                    if (rateEl) rateEl.textContent = '0%';
                    if (tbody) tbody.innerHTML = `<tr><td colspan="5" style="text-align:center;color:#999">No quiz submissions on ${dateStr}</td></tr>`;
                    if (infoText) infoText.innerHTML = `<strong>No students</strong> from <strong>${crClass}</strong>${crStrengthTag} participated in the quiz on ${dateStr}.`;
                    return;
                }
                // Filter to CR's class
                const classStudents = [];
                let total=0,correct=0,partial=0;
                snap.forEach(child => {
                    const s = child.val();
                    if (!crClass || s.studentClass === crClass) {
                        classStudents.push(s);
                        total++;
                        if (s.score===2) correct++;
                        else if(s.score===1) partial++;
                    }
                });
                const rate = total>0?Math.round((correct/total)*100):0;

                // Check if results have been declared for this date (to decide whether to show scores)
                const resSnap = await db.ref(`quizResults/${date}`).once('value');
                const resultsPublished = resSnap.exists();
                // Hide only the score column until results are declared
                const hideScores = !resultsPublished;

                if (totEl)  totEl.textContent  = total;
                if (corrEl) corrEl.textContent = hideScores ? 'ðŸ”’' : correct;
                if (partEl) partEl.textContent = hideScores ? 'ðŸ”’' : partial;
                if (rateEl) rateEl.textContent = hideScores ? 'ðŸ”’' : rate+'%';

                // Info text
                if (infoText) {
                    if (total === 0) {
                        infoText.innerHTML = `<strong>No students</strong> from <strong>${crClass}</strong>${crStrengthTag} participated in the quiz on ${dateStr}.`;
                    } else if (hideScores) {
                        infoText.innerHTML = `On <strong>${dateStr}</strong>, <strong>${total}</strong> student(s) from <strong>${crClass}</strong>${crStrengthTag} submitted the quiz.<br>
                            <span style="color:#856404">ðŸ”’ Scores are hidden until the admin declares the winners.</span>`;
                    } else {
                        infoText.innerHTML = `On <strong>${dateStr}</strong>, <strong>${total}</strong> student(s) from <strong>${crClass}</strong>${crStrengthTag} participated in the online quiz.<br>
                            <strong>${correct}</strong> got both questions correct (${rate}% accuracy).<br>
                            <strong>${partial}</strong> got one correct. <strong>${total-correct-partial}</strong> got none correct.<br>
                            ${correct>=2 ? 'âœ… Your class has eligible students for winner selection.' : correct===1 ? 'âš ï¸ Only 1 correct answer â€” need 2+ for winner &amp; runner-up.' : 'âŒ No correct answers from your class today.'}`;
                    }
                }

                // Student table
                if (tbody) {
                    if (classStudents.length === 0) {
                        tbody.innerHTML = `<tr><td colspan="5" style="text-align:center;color:#999">No submissions from ${crClass} on this date.</td></tr>`;
                    } else {
                        classStudents.sort((a,b) => new Date(a.submittedAt) - new Date(b.submittedAt));
                        tbody.innerHTML = '';
                        classStudents.forEach((s,i) => {
                            const row = tbody.insertRow();
                            const mins = Math.floor(s.timeTaken/60), secs = s.timeTaken%60;
                            let scoreCell;
                            if (hideScores) {
                                scoreCell = `<span style="background:#e9ecef;color:#6c757d;padding:3px 10px;border-radius:10px;font-weight:700">ðŸ”’ Hidden</span>`;
                            } else {
                                const scoreBg = s.score===2?'#d4edda':s.score===1?'#fff3cd':'#f8d7da';
                                const scoreCol= s.score===2?'#155724':s.score===1?'#856404':'#721c24';
                                scoreCell = `<span style="background:${scoreBg};color:${scoreCol};padding:3px 10px;border-radius:10px;font-weight:700">${s.score}/2</span>`;
                            }
                            row.innerHTML = `<td>${i+1}</td>
                                <td><strong>${s.studentName||''}</strong></td>
                                <td>${scoreCell}</td>
                                <td>${mins}m ${secs}s</td>
                                <td style="font-size:12px">${new Date(s.submittedAt).toLocaleString('en-IN')}</td>`;
                        });
                    }
                }
            } catch(e) {
                if (infoText) infoText.textContent = 'Error loading data: ' + e.message;
                if (tbody) tbody.innerHTML = `<tr><td colspan="5" style="color:red;text-align:center">Error: ${e.message}</td></tr>`;
            }
        }

        async function loadCRScavengerStats() {
            const crClass = (window.currentCRClass || '').trim() || (document.getElementById('crClassName')||{}).textContent.trim() || '';
            const infoDate = document.getElementById('crShInfoDate');
            const infoText = document.getElementById('crShInfoText');
            const totalEl  = document.getElementById('crShTotal');
            const appEl    = document.getElementById('crShApproved');
            const penEl    = document.getElementById('crShPending');
            const rejEl    = document.getElementById('crShRejected');
            const tbody    = document.getElementById('crShTable');
            if (infoDate) infoDate.textContent = new Date().toLocaleDateString('en-IN',{weekday:'long',day:'numeric',month:'long',year:'numeric'});
            if (infoText) infoText.textContent = 'â³ Loadingâ€¦';
            if (tbody) tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;color:#aaa">â³ Loadingâ€¦</td></tr>';
            try {
                try { const ss = await db.ref('leaderboardConfig/classStrengths').once('value'); window._classStrengths = ss.val() || {}; } catch(e) { window._classStrengths = window._classStrengths || {}; }
                const _shSafeKey = crClass ? crClass.replace(/[.\[\]#$\/]/g,'_') : '';
                const crClassStrengthSH = (window._classStrengths[_shSafeKey] || window._classStrengths[crClass] || 0);
                const crStrengthTagSH = crClassStrengthSH ? ` <span style="color:#888;font-size:0.92em">(Class Strength: ${crClassStrengthSH})</span>` : '';

                const [subSnap, taskSnap] = await Promise.all([
                    db.ref('scavengerHunt/submissions').once('value'),
                    db.ref('scavengerHunt/tasks').once('value')
                ]);
                const allSubs  = subSnap.val()  || {};
                const allTasks = taskSnap.val() || {};
                const totalTasks = Object.keys(allTasks).length;

                // -- Store data globally for task filter re-use ------------
                window._crShAllSubs  = allSubs;
                window._crShAllTasks = allTasks;
                window._crShClass    = crClass;
                window._crShStrengthTag = crStrengthTagSH;

                // -- Populate task filter dropdown -------------------------
                const taskSel = document.getElementById('crShTaskFilter');
                if (taskSel) {
                    const prevVal = taskSel.value;
                    taskSel.innerHTML = '<option value="">â€” All Tasks â€”</option>';
                    Object.entries(allTasks).forEach(([tid, t]) => {
                        const name = t.name || t.title || tid;
                        const opt = document.createElement('option');
                        opt.value = tid;
                        opt.textContent = name.length > 60 ? name.slice(0,60)+'â€¦' : name;
                        if (tid === prevVal) opt.selected = true;
                        taskSel.appendChild(opt);
                    });
                }

                // -- Render based on selected task filter ------------------
                crShRenderView();

            } catch(e) {
                if (infoText) infoText.textContent = 'Error loading data: ' + e.message;
                if (tbody) tbody.innerHTML = `<tr><td colspan="6" style="color:red;text-align:center">Error: ${e.message}</td></tr>`;
            }
        }

        function crShApplyTaskFilter() {
            const sel    = document.getElementById('crShTaskFilter');
            const badge  = document.getElementById('crShTaskBadge');
            const taskId = sel ? sel.value : '';
            const taskName = sel && sel.value ? sel.options[sel.selectedIndex].textContent : '';
            if (badge) {
                if (taskId) { badge.textContent = 'ðŸ“Œ ' + taskName; badge.style.display = 'inline-block'; }
                else        { badge.style.display = 'none'; }
            }
            crShRenderView();
        }

        function crShRenderView() {
            const allSubs   = window._crShAllSubs  || {};
            const allTasks  = window._crShAllTasks || {};
            const crClass   = window._crShClass    || '';
            const crStrengthTagSH = window._crShStrengthTag || '';
            const totalTasks = Object.keys(allTasks).length;
            const taskSel   = document.getElementById('crShTaskFilter');
            const selectedTask = taskSel ? taskSel.value : '';

            const infoText = document.getElementById('crShInfoText');
            const totalEl  = document.getElementById('crShTotal');
            const appEl    = document.getElementById('crShApproved');
            const penEl    = document.getElementById('crShPending');
            const rejEl    = document.getElementById('crShRejected');
            const tbody    = document.getElementById('crShTable');
            const tableHead = document.getElementById('crShTableHead');
            const nowTime   = new Date().toLocaleTimeString('en-IN',{hour:'2-digit',minute:'2-digit',hour12:true});

            if (selectedTask) {
                // -- TASK-WISE VIEW ----------------------------------------
                const taskDef  = allTasks[selectedTask] || {};
                const taskName = taskDef.name || taskDef.title || selectedTask;

                // Build student rows: submitted + not-submitted
                const submittedRows = [];
                let tApproved=0, tPending=0, tRejected=0;

                Object.entries(allSubs).forEach(([sk, ss]) => {
                    const firstSub = Object.values(ss)[0] || {};
                    if (crClass && firstSub.studentClass !== crClass) return;
                    const name = firstSub.studentName || sk;
                    const sub  = ss[selectedTask];
                    if (sub) {
                        const st = sub.status || 'pending';
                        if (st==='approved') tApproved++;
                        else if (st==='rejected') tRejected++;
                        else tPending++;
                        submittedRows.push({ name, status: st, submittedAt: sub.submittedAt, reviewedBy: sub.reviewedBy });
                    } else {
                        submittedRows.push({ name, status: 'not_submitted' });
                    }
                });

                submittedRows.sort((a,b) => {
                    const order = {approved:0,pending:1,rejected:2,not_submitted:3};
                    return (order[a.status]||3) - (order[b.status]||3);
                });

                const participated = submittedRows.filter(r => r.status !== 'not_submitted').length;
                if (totalEl) totalEl.textContent = participated;
                if (appEl)   appEl.textContent   = tApproved;
                if (penEl)   penEl.textContent   = tPending;
                if (rejEl)   rejEl.textContent   = tRejected;

                if (infoText) infoText.innerHTML =
                    `<span style="color:#888;font-size:12px">ðŸ• Generated at: <strong>${nowTime}</strong></span><br><br>` +
                    `Showing task: <strong style="color:#6a1b9a">${taskName}</strong><br>` +
                    `<strong>${participated}</strong> student(s) submitted Â· <strong>${tApproved}</strong> approved Â· <strong>${tPending}</strong> pending Â· <strong>${tRejected}</strong> rejected`;

                // Update table headers for task view
                if (tableHead) tableHead.innerHTML = `<tr><th>#</th><th>Student Name</th><th>Status</th><th>Submitted At</th><th>Reviewed By</th></tr>`;

                if (tbody) {
                    if (!submittedRows.length) {
                        tbody.innerHTML = `<tr><td colspan="5" style="text-align:center;color:#999">No students from ${crClass} yet.</td></tr>`;
                    } else {
                        tbody.innerHTML = '';
                        submittedRows.forEach((s,i) => {
                            const row = tbody.insertRow();
                            let statusBadge, rowStyle='';
                            if (s.status==='approved')       { statusBadge = '<span style="background:#d4edda;color:#155724;padding:3px 12px;border-radius:10px;font-weight:700">âœ… Approved</span>'; }
                            else if (s.status==='pending')   { statusBadge = '<span style="background:#fff3cd;color:#856404;padding:3px 12px;border-radius:10px;font-weight:700">â³ Pending</span>'; }
                            else if (s.status==='rejected')  { statusBadge = '<span style="background:#f8d7da;color:#721c24;padding:3px 12px;border-radius:10px;font-weight:700">âŒ Rejected</span>'; }
                            else { statusBadge = '<span style="color:#aaa;font-style:italic">â€” Not Submitted</span>'; rowStyle='opacity:0.5'; }
                            const timeStr = s.submittedAt ? new Date(s.submittedAt).toLocaleString('en-IN',{day:'2-digit',month:'short',hour:'2-digit',minute:'2-digit',hour12:true}) : 'â€”';
                            row.setAttribute('style', rowStyle);
                            row.innerHTML = `<td>${i+1}</td><td><strong>${s.name}</strong></td><td>${statusBadge}</td><td style="font-size:12px;color:#555">${timeStr}</td><td style="font-size:12px;color:#777">${s.reviewedBy||'â€”'}</td>`;
                        });
                    }
                }
            } else {
                // -- SUMMARY VIEW (All Tasks) ------------------------------
                const classStudents = [];
                let grandApproved=0, grandPending=0, grandRejected=0;

                Object.entries(allSubs).forEach(([sk, ss]) => {
                    const first = Object.values(ss)[0] || {};
                    if (crClass && first.studentClass !== crClass) return;
                    const name = first.studentName || sk;
                    let approved=0, pending=0, rejected=0;
                    Object.values(ss).forEach(sub => {
                        if (sub.status==='approved')       { approved++; grandApproved++; }
                        else if (sub.status==='pending')   { pending++;  grandPending++;  }
                        else if (sub.status==='rejected')  { rejected++; grandRejected++; }
                    });
                    classStudents.push({name, approved, pending, rejected, total: approved+pending+rejected});
                });
                classStudents.sort((a,b)=>b.approved-a.approved||b.total-a.total);
                const participantCount = classStudents.length;

                if (totalEl) totalEl.textContent = participantCount;
                if (appEl)   appEl.textContent   = grandApproved;
                if (penEl)   penEl.textContent   = grandPending;
                if (rejEl)   rejEl.textContent   = grandRejected;

                if (infoText) {
                    if (participantCount === 0) {
                        infoText.innerHTML = `<span style="color:#888;font-size:12px">ðŸ• Generated at: <strong>${nowTime}</strong></span><br><br><strong>No students</strong> from <strong>${crClass}</strong>${crStrengthTagSH} have participated in the Scavenger Hunt yet.`;
                    } else {
                        infoText.innerHTML = `<span style="color:#888;font-size:12px">ðŸ• Generated at: <strong>${nowTime}</strong></span><br><br>`
                            + `<strong>${participantCount}</strong> student(s) from <strong>${crClass}</strong>${crStrengthTagSH} have participated in the Scavenger Hunt.<br>`
                            + `<strong>${grandApproved}</strong> task(s) approved Â· <strong>${grandPending}</strong> pending review Â· <strong>${grandRejected}</strong> rejected.`
                            + (totalTasks ? ` | Total tasks: <strong>${totalTasks}</strong>` : '');
                    }
                }

                // Restore summary headers
                if (tableHead) tableHead.innerHTML = `<tr><th>#</th><th>Student Name</th><th>Tasks Submitted</th><th>Approved</th><th>Pending</th><th>Rejected</th></tr>`;

                if (tbody) {
                    if (!classStudents.length) {
                        tbody.innerHTML = `<tr><td colspan="6" style="text-align:center;color:#999">No scavenger hunt submissions from ${crClass} yet.</td></tr>`;
                    } else {
                        tbody.innerHTML = '';
                        classStudents.forEach((s,i) => {
                            const row = tbody.insertRow();
                            row.innerHTML = `<td>${i+1}</td>
                                <td><strong>${s.name}</strong></td>
                                <td style="text-align:center;font-weight:700">${s.total}${totalTasks?' / '+totalTasks:''}</td>
                                <td style="text-align:center"><span style="background:#d4edda;color:#155724;padding:3px 10px;border-radius:10px;font-weight:700">${s.approved}</span></td>
                                <td style="text-align:center"><span style="background:#fff3cd;color:#856404;padding:3px 10px;border-radius:10px;font-weight:700">${s.pending}</span></td>
                                <td style="text-align:center"><span style="background:#f8d7da;color:#721c24;padding:3px 10px;border-radius:10px;font-weight:700">${s.rejected}</span></td>`;
                        });
                    }
                }
            }
        }
        
        async function loadQuizResultsAdmin() {
            const dateInput = document.getElementById('winnersDateSelector');
            const selectedDate = (dateInput && dateInput.value) ? dateInput.value : getQuizToday();
            // Ensure the date input is set
            if (dateInput && !dateInput.value) dateInput.value = selectedDate;
            try {
                const snap = await db.ref(`quizSubmissions/${selectedDate}`).once('value');
                
                if (!snap.exists()) {
                    document.getElementById('resultTotalPartAdmin').textContent = '0';
                    document.getElementById('resultBothCorrectAdmin').textContent = '0';
                    document.getElementById('resultEligibleAdmin').textContent = '0';
                    const container = document.getElementById('eligibleStudentsListAdmin');
                    if (container) container.innerHTML = '<p style="color:#999;font-style:italic;text-align:center;padding:20px">No submissions found for ' + selectedDate + '</p>';
                    // Check for winner even if no submissions
                    const resSnap2 = await db.ref(`quizResults/${selectedDate}`).once('value');
                    const winnerDiv = document.getElementById('winnersDisplayAdmin');
                    if (resSnap2.exists()) { displayQuizWinnersAdmin(resSnap2.val()); }
                    else { if(winnerDiv) { winnerDiv.innerHTML = '<p style="color:#856404;background:#fff3cd;padding:12px 16px;border-radius:8px;margin-top:10px">ðŸ“­ No winner declared for ' + selectedDate + '</p>'; winnerDiv.style.display='block'; } }
                    return;
                }
                
                let total = 0, correct = 0;
                const eligibleStudents = [];
                
                snap.forEach(child => {
                    total++;
                    const data = child.val();
                    if (data.score === 2) {
                        correct++;
                        eligibleStudents.push({
                            name: data.studentName,
                            class: data.studentClass,
                            email: data.studentEmail,
                            time: data.timeTaken,
                            submittedAt: data.submittedAt
                        });
                    }
                });
                
                document.getElementById('resultTotalPartAdmin').textContent = total;
                document.getElementById('resultBothCorrectAdmin').textContent = correct;
                document.getElementById('resultEligibleAdmin').textContent = correct;
                
                // Display detailed list of eligible students
                displayEligibleStudentsList(eligibleStudents);
                
                // Show winner/runner-up for selected date
                const resSnap = await db.ref(`quizResults/${selectedDate}`).once('value');
                const winnerDiv = document.getElementById('winnersDisplayAdmin');
                if (resSnap.exists()) {
                    displayQuizWinnersAdmin(resSnap.val());
                } else {
                    if (winnerDiv) {
                        winnerDiv.innerHTML = '<p style="color:#856404;background:#fff3cd;padding:12px 16px;border-radius:8px;margin-top:10px">ðŸ“­ No winner declared yet for ' + selectedDate + '. Use the buttons below to declare winners.</p>';
                        winnerDiv.style.display = 'block';
                    }
                }
            } catch (err) {
                console.error('Load results error:', err);
            }
        }
        
        function displayEligibleStudentsList(students) {
            const container = document.getElementById('eligibleStudentsListAdmin');
            if (!container) return;
            // Cache for manual select dropdowns
            _eligibleCache = students;
            if (_manualPanelOpen) populateManualSelects();
            
            if (students.length === 0) {
                container.innerHTML = '<p style="color:#999;font-style:italic;text-align:center;padding:20px">No students with both correct answers yet</p>';
                return;
            }
            
            // Sort by submission time (fastest first)
            students.sort((a, b) => new Date(a.submittedAt) - new Date(b.submittedAt));
            
            let html = '<div style="margin-top:20px">';
            html += '<h4 style="color:#28a745;margin-bottom:15px">âœ… Eligible Students (Both Questions Correct)</h4>';
            html += '<div style="background:white;border-radius:10px;overflow:hidden;box-shadow:0 2px 8px rgba(0,0,0,0.1)">';
            html += '<div style="overflow-x:auto;-webkit-overflow-scrolling:touch;">';
            html += '<table style="width:100%;border-collapse:collapse;min-width:400px">';
            html += '<thead><tr style="background:#28a745;color:white">';
            html += '<th style="padding:10px 8px;text-align:left;white-space:nowrap">#</th>';
            html += '<th style="padding:10px 8px;text-align:left;white-space:nowrap">Name</th>';
            html += '<th style="padding:10px 8px;text-align:left;white-space:nowrap">Class</th>';
            html += '<th style="padding:10px 8px;text-align:left;white-space:nowrap">Time Taken</th>';
            html += '<th style="padding:10px 8px;text-align:left;white-space:nowrap">Submitted At</th>';
            html += '</tr></thead><tbody>';
            
            students.forEach((student, index) => {
                const bgColor = index % 2 === 0 ? '#f8f9fa' : 'white';
                const submittedTime = new Date(student.submittedAt).toLocaleTimeString('en-IN', {
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                });
                const timeTaken = Math.floor(student.time / 60) + 'm ' + (student.time % 60) + 's';
                
                html += `<tr style="background:${bgColor}">`;
                html += `<td style="padding:10px 8px;border-bottom:1px solid #e9ecef;white-space:nowrap">${index + 1}</td>`;
                html += `<td style="padding:10px 8px;border-bottom:1px solid #e9ecef;font-weight:600;word-break:break-word;max-width:140px">${student.name}</td>`;
                html += `<td style="padding:10px 8px;border-bottom:1px solid #e9ecef;white-space:nowrap">${student.class}</td>`;
                html += `<td style="padding:10px 8px;border-bottom:1px solid #e9ecef;white-space:nowrap">${timeTaken}</td>`;
                html += `<td style="padding:10px 8px;border-bottom:1px solid #e9ecef;white-space:nowrap">${submittedTime}</td>`;
                html += '</tr>';
            });
            
            html += '</tbody></table></div></div></div>';
            container.innerHTML = html;
        }
        
        async function selectQuizWinnersFromAdmin() {
            const wds = document.getElementById('winnersDateSelector');
            const today = (wds && wds.value) ? wds.value : getQuizToday();
            try {
                const snap = await db.ref(`quizSubmissions/${today}`).once('value');
                const eligible = [];
                snap.forEach(child => {
                    if (child.val().score === 2) eligible.push(child.val());
                });
                
                if (eligible.length === 0) {
                    showQuizMsg('quizAdminMessage', 'âš ï¸ No correct answers yet!', 'warning');
                    return;
                }
                
                if (eligible.length === 1) {
                    showQuizMsg('quizAdminMessage', 'âš ï¸ Only one correct. Need 2 for winner & runner-up.', 'warning');
                    return;
                }
                
                const shuffled = eligible.sort(() => 0.5 - Math.random());
                const winner = shuffled[0];
                const runnerUp = shuffled[1];
                
                const data = {
                    winner: {name: winner.studentName, email: winner.studentEmail, class: winner.studentClass, score: winner.score},
                    runnerUp: {name: runnerUp.studentName, email: runnerUp.studentEmail, class: runnerUp.studentClass, score: runnerUp.score},
                    declaredAt: new Date().toISOString(),
                    declaredBy: 'Super Admin',
                    totalEligible: eligible.length
                };
                
                await db.ref(`quizResults/${today}`).set(data);
                
                // Try to send emails but don't block winner declaration
                try {
                    await sendQuizEmail(winner.studentEmail, 'ðŸ† You Won Quiz!', `Dear ${winner.studentName},\n\nCongratulations! You are the WINNER of today's Daily Quiz Competition!\n\nScore: ${winner.score}/2\nClass: ${winner.studentClass}\n\nWell done!\n\nDavan Institute`);
                } catch (e) { console.log('Winner email failed:', e); }
                
                try {
                    await sendQuizEmail(runnerUp.studentEmail, 'ðŸ¥ˆ Runner-Up!', `Dear ${runnerUp.studentName},\n\nCongratulations! You are the RUNNER-UP!\n\nScore: ${runnerUp.score}/2\nClass: ${runnerUp.studentClass}\n\nGreat job!\n\nDavan Institute`);
                } catch (e) { console.log('Runner-up email failed:', e); }
                
                showQuizMsg('quizAdminMessage', 'âœ… Winners selected! Check Firebase for email logs.', 'success');
                displayQuizWinnersAdmin(data);
            } catch (err) {
                console.error('Select winners error:', err);
                showQuizMsg('quizAdminMessage', 'Error selecting winners.', 'error');
            }
        }
        
        function displayQuizWinnersAdmin(data) {
            const div = document.getElementById('winnersDisplayAdmin');
            let html = '<div style="background:#f8f9fa;padding:25px;border-radius:12px">';
            html += '<h3 style="color:#667eea;margin-bottom:20px;text-align:center">ðŸŽ‰ Today\'s Winners</h3>';
            html += '<div style="background:linear-gradient(135deg,#ffd700 0%,#ffed4e 100%);padding:20px;border-radius:10px;margin-bottom:15px;color:#333">';
            html += '<h4>ðŸ† WINNER</h4>';
            html += `<p><strong>Name:</strong> ${data.winner.name}</p>`;
            html += `<p><strong>Email:</strong> ${data.winner.email}</p>`;
            html += `<p><strong>Class:</strong> ${data.winner.class}</p>`;
            html += `<p><strong>Score:</strong> ${data.winner.score}/2</p></div>`;
            html += '<div style="background:linear-gradient(135deg,#c0c0c0 0%,#e8e8e8 100%);padding:20px;border-radius:10px;color:#333">';
            html += '<h4>ðŸ¥ˆ RUNNER-UP</h4>';
            html += `<p><strong>Name:</strong> ${data.runnerUp.name}</p>`;
            html += `<p><strong>Email:</strong> ${data.runnerUp.email}</p>`;
            html += `<p><strong>Class:</strong> ${data.runnerUp.class}</p>`;
            html += `<p><strong>Score:</strong> ${data.runnerUp.score}/2</p></div>`;
            const declaredBy = data.declaredBy || 'Admin';
            const modeTag = data.autoSelected
                ? '<span style="background:#6a1b9a;color:#ffd700;padding:2px 10px;border-radius:12px;font-size:12px;margin-left:6px">â° Auto-declared</span>'
                : (data.manualSelected
                    ? '<span style="background:#2196F3;color:white;padding:2px 10px;border-radius:12px;font-size:12px;margin-left:6px">âœ‹ Manual</span>'
                    : '<span style="background:#28a745;color:white;padding:2px 10px;border-radius:12px;font-size:12px;margin-left:6px">ðŸŽ² Random</span>');
            html += `<p style="text-align:center;margin-top:20px;color:#666"><small>Declared: ${new Date(data.declaredAt).toLocaleString()} by ${declaredBy}</small>${modeTag}</p></div>`;
            div.innerHTML = html;
            div.style.display = 'block';
        }

        // ============================================
        // AUTO-DECLARATION SCHEDULER (11:30 PM daily)
        // ============================================
        let _autoDeclarInterval = null;
        let _eligibleCache = []; // populated when winners tab loads

        function saveAutoDeclarSetting() {
            const enabled = document.getElementById('autoDeclarToggle').checked;
            const time    = document.getElementById('autoDeclarTime').value || '23:30';
            try { localStorage.setItem('quizAutoDeclar', enabled ? '1' : '0'); } catch(e){}
            try { localStorage.setItem('quizAutoDeclarTime', time); } catch(e){}
            // Persist to Firebase so it survives page refresh/close
            try { db.ref('quizConfig/autoDeclar').set({ enabled, time, updatedAt: new Date().toISOString() }); } catch(e){}
            // Also save SH auto-declar setting to Firebase
            try { window.db.ref('scavengerHunt/autoDeclar').set({ enabled, time, updatedAt: new Date().toISOString() }); } catch(e){}
            applyAutoDeclarUI(enabled, time);
            if (enabled) {
                startAutoDeclarScheduler();
            } else {
                stopAutoDeclarScheduler();
            }
        }

        function applyAutoDeclarUI(enabled, time) {
            time = time || document.getElementById('autoDeclarTime').value || '23:30';
            // Format time for display e.g. "23:30" â†’ "11:30 PM"
            const [hh, mm] = time.split(':').map(Number);
            const ampm = hh >= 12 ? 'PM' : 'AM';
            const h12  = hh % 12 || 12;
            const timeDisplay = `${h12}:${String(mm).padStart(2,'0')} ${ampm}`;
            const slider = document.getElementById('autoDeclarSlider');
            const thumb  = document.getElementById('autoDeclarThumb');
            const label  = document.getElementById('autoDeclarLabel');
            const status = document.getElementById('autoDeclarStatus');
            const countdown = document.getElementById('autoDeclarCountdown');
            if (!slider) return;
            if (enabled) {
                slider.style.background = '#28a745';
                thumb.style.left = '25px';
                label.textContent = 'ON';
                status.innerHTML = `ðŸŸ¢ Auto-declaration is <strong style="color:#a5ffb8">enabled</strong>. Winners will be auto-selected at <strong style="color:#ffd700">${timeDisplay}</strong> if not declared manually.`;
                countdown.style.display = 'block';
                updateAutoDeclarCountdown();
            } else {
                slider.style.background = '#555';
                thumb.style.left = '3px';
                label.textContent = 'OFF';
                status.innerHTML = 'ðŸ”´ Auto-declaration is <strong style="color:#ff6b6b">disabled</strong>. Toggle ON to enable.';
                countdown.style.display = 'none';
            }
        }

        function updateAutoDeclarCountdown() {
            const el = document.getElementById('autoDeclarCountdown');
            if (!el || !document.getElementById('autoDeclarToggle').checked) return;
            const time = document.getElementById('autoDeclarTime').value || '23:30';
            const [hh, mm] = time.split(':').map(Number);
            const now = new Date();
            const target = new Date();
            target.setHours(hh, mm, 0, 0);
            if (now >= target) {
                const [h12, ampm] = [hh % 12 || 12, hh >= 12 ? 'PM' : 'AM'];
                el.textContent = `â° ${h12}:${String(mm).padStart(2,'0')} ${ampm} has passed for today. Auto-declaration ran (or no eligible students).`;
                return;
            }
            const diff = Math.floor((target - now) / 1000);
            const h = Math.floor(diff / 3600);
            const m = Math.floor((diff % 3600) / 60);
            const s = diff % 60;
            el.textContent = `â³ Auto-declaration in: ${String(h).padStart(2,'0')}h ${String(m).padStart(2,'0')}m ${String(s).padStart(2,'0')}s`;
        }

        function startAutoDeclarScheduler() {
            stopAutoDeclarScheduler();
            _autoDeclarInterval = setInterval(async () => {
                if (!document.getElementById('autoDeclarToggle') || !document.getElementById('autoDeclarToggle').checked) return;
                updateAutoDeclarCountdown();
                const time = document.getElementById('autoDeclarTime').value || '23:30';
                const [hh, mm] = time.split(':').map(Number);
                const now = new Date();
                if (now.getHours() === hh && now.getMinutes() === mm) {
                    await runAutoDeclaration();
                }
            }, 1000);
        }

        function stopAutoDeclarScheduler() {
            if (_autoDeclarInterval) { clearInterval(_autoDeclarInterval); _autoDeclarInterval = null; }
        }

        async function runAutoDeclaration() {
            const today = getQuizToday();
            // Check if results already declared for today
            try {
                const existing = await db.ref(`quizResults/${today}`).once('value');
                if (existing.exists()) {
                    console.log('[AutoDeclar] Results already declared for', today, 'â€” skipping.');
                    return;
                }
                const snap = await db.ref(`quizSubmissions/${today}`).once('value');
                const eligible = [];
                snap.forEach(child => {
                    if (child.val().score === 2) eligible.push(child.val());
                });
                if (eligible.length < 2) {
                    console.log('[AutoDeclar] Not enough eligible students (' + eligible.length + ').');
                    const statusEl = document.getElementById('autoDeclarStatus');
                    if (statusEl) statusEl.innerHTML = 'âš ï¸ Auto-declaration ran at 11:30 PM but <strong>not enough eligible students</strong> (need at least 2).';
                    return;
                }
                const shuffled = eligible.sort(() => 0.5 - Math.random());
                const winner   = shuffled[0];
                const runnerUp = shuffled[1];
                const data = {
                    winner:       { name: winner.studentName,   email: winner.studentEmail,   class: winner.studentClass,   score: winner.score },
                    runnerUp:     { name: runnerUp.studentName, email: runnerUp.studentEmail, class: runnerUp.studentClass, score: runnerUp.score },
                    declaredAt:   new Date().toISOString(),
                    declaredBy:   'System (Auto 11:30 PM)',
                    totalEligible: eligible.length,
                    autoSelected: true
                };
                await db.ref(`quizResults/${today}`).set(data);
                console.log('[AutoDeclar] Winners saved for', today);
                // Send emails silently
                try { await sendQuizEmail(winner.studentEmail,   'ðŸ† You Won Quiz!', `Dear ${winner.studentName},\n\nCongratulations! You are the WINNER of today's Quiz!\n\nDavan Institute`); } catch(e){}
                try { await sendQuizEmail(runnerUp.studentEmail, 'ðŸ¥ˆ Runner-Up!',    `Dear ${runnerUp.studentName},\n\nCongratulations! You are today's RUNNER-UP!\n\nDavan Institute`); } catch(e){}
                // Update UI if winners tab is visible
                displayQuizWinnersAdmin(data);
                const statusEl = document.getElementById('autoDeclarStatus');
                if (statusEl) statusEl.innerHTML = `âœ… Auto-declared at 11:30 PM â€” <strong style="color:#a5ffb8">${winner.studentName}</strong> (Winner) &amp; <strong style="color:#ffd700">${runnerUp.studentName}</strong> (Runner-Up).`;
            } catch(e) {
                console.error('[AutoDeclar] Error:', e);
            }
        }

        async function initAutoDeclarScheduler() {
            let enabled = false;
            let time = '23:30';
            // Try Firebase first (most reliable across sessions)
            try {
                const snap = await db.ref('quizConfig/autoDeclar').once('value');
                if (snap.exists()) { enabled = !!snap.val().enabled; time = snap.val().time || '23:30'; }
                else {
                    enabled = localStorage.getItem('quizAutoDeclar') === '1';
                    time = localStorage.getItem('quizAutoDeclarTime') || '23:30';
                }
            } catch(e) {
                try { enabled = localStorage.getItem('quizAutoDeclar') === '1'; time = localStorage.getItem('quizAutoDeclarTime') || '23:30'; } catch(e2){}
            }
            const toggle   = document.getElementById('autoDeclarToggle');
            const timeInp  = document.getElementById('autoDeclarTime');
            if (toggle) {
                toggle.checked = enabled;
                if (timeInp) timeInp.value = time;
                try { localStorage.setItem('quizAutoDeclar', enabled ? '1' : '0'); } catch(e){}
                try { localStorage.setItem('quizAutoDeclarTime', time); } catch(e){}
                applyAutoDeclarUI(enabled, time);
                if (enabled) {
                    startAutoDeclarScheduler();
                    // Also check: did the set time already pass today without declaration?
                    checkMissedAutoDeclar();
                }
            }
        }

        // Check if today's auto-declaration was missed (set time passed, page was closed)
        async function checkMissedAutoDeclar() {
            const time = document.getElementById('autoDeclarTime').value || '23:30';
            const [hh, mm] = time.split(':').map(Number);
            const now = new Date();
            if (now.getHours() < hh || (now.getHours() === hh && now.getMinutes() < mm)) return;
            const today = getQuizToday();
            try {
                const existing = await db.ref(`quizResults/${today}`).once('value');
                if (!existing.exists()) {
                    // Results not declared yet and 11:30 has passed â€” run now
                    console.log('[AutoDeclar] Missed 11:30 PM trigger â€” running now on page load');
                    const statusEl = document.getElementById('autoDeclarStatus');
                    if (statusEl) statusEl.innerHTML = 'âš ï¸ <strong>11:30 PM was missed</strong> (page was closed). Running auto-declaration nowâ€¦';
                    await runAutoDeclaration();
                }
            } catch(e) { console.warn('[AutoDeclar] checkMissed error:', e); }
        }

        // ============================================
        // MANUAL WINNER SELECTION
        // ============================================
        let _manualPanelOpen = false;

        function toggleManualWinnerUI() {
            _manualPanelOpen = !_manualPanelOpen;
            const panel = document.getElementById('manualWinnerPanel');
            const btn   = document.getElementById('manualSelectToggleBtn');
            if (!panel) return;
            if (_manualPanelOpen) {
                panel.style.display = 'block';
                btn.textContent = 'âœ– Close Manual Select';
                populateManualSelects();
            } else {
                panel.style.display = 'none';
                btn.textContent = 'âœ‹ Manual Select';
            }
        }

        function populateManualSelects() {
            const winSel = document.getElementById('manualWinnerSelect');
            const runSel = document.getElementById('manualRunnerSelect');
            if (!winSel || !runSel) return;
            // Use _eligibleCache built when winners tab loads
            winSel.innerHTML = '<option value="">-- Select Winner --</option>';
            runSel.innerHTML = '<option value="">-- Select Runner-Up --</option>';
            _eligibleCache.forEach((s, i) => {
                const label = `${s.name} (${s.class})`;
                winSel.innerHTML += `<option value="${i}">${label}</option>`;
                runSel.innerHTML += `<option value="${i}">${label}</option>`;
            });
        }

        async function declareManualWinners() {
            const winIdx = parseInt(document.getElementById('manualWinnerSelect').value);
            const runIdx = parseInt(document.getElementById('manualRunnerSelect').value);
            if (isNaN(winIdx) || isNaN(runIdx)) {
                alert('âš ï¸ Please select both winner and runner-up.');
                return;
            }
            if (winIdx === runIdx) {
                alert('âš ï¸ Winner and runner-up must be different students.');
                return;
            }
            const winner   = _eligibleCache[winIdx];
            const runnerUp = _eligibleCache[runIdx];
            if (!winner || !runnerUp) { alert('âš ï¸ Invalid selection.'); return; }
            if (!confirm(`Declare:\nðŸ† Winner: ${winner.name}\nðŸ¥ˆ Runner-Up: ${runnerUp.name}\n\nProceed?`)) return;
            const wds2 = document.getElementById('winnersDateSelector'); const today = (wds2 && wds2.value) ? wds2.value : getQuizToday();
            const data = {
                winner:       { name: winner.name,   email: winner.email,   class: winner.class,   score: 2 },
                runnerUp:     { name: runnerUp.name, email: runnerUp.email, class: runnerUp.class, score: 2 },
                declaredAt:   new Date().toISOString(),
                declaredBy:   'Super Admin (Manual)',
                totalEligible: _eligibleCache.length,
                manualSelected: true
            };
            try {
                await db.ref(`quizResults/${today}`).set(data);
                try { await sendQuizEmail(winner.email,   'ðŸ† You Won Quiz!', `Dear ${winner.name},\n\nCongratulations! You are the WINNER!\n\nDavan Institute`); } catch(e){}
                try { await sendQuizEmail(runnerUp.email, 'ðŸ¥ˆ Runner-Up!',    `Dear ${runnerUp.name},\n\nCongratulations! You are the RUNNER-UP!\n\nDavan Institute`); } catch(e){}
                showQuizMsg('quizAdminMessage', 'âœ… Manual winners declared!', 'success');
                displayQuizWinnersAdmin(data);
                toggleManualWinnerUI(); // close panel
            } catch(e) {
                alert('âŒ Error saving: ' + e.message);
            }
        }
        
        // ============================================
        // NEW PUBLISH/UNPUBLISH FUNCTIONS
        // ============================================
        
        async function checkPublishStatusForToday() {
            const today = getQuizToday();
            console.log('checkPublishStatusForToday called for:', today);
            try {
                const qSnap = await db.ref(`quizQuestions/${today}`).once('value');
                if (!qSnap.exists()) {
                    console.log('No questions exist for today');
                    document.getElementById('publishControlSection').style.display = 'none';
                    return;
                }
                
                const pSnap = await db.ref(`quizPublished/${today}`).once('value');
                const publishData = pSnap.val();
                const isPublished = publishData && publishData.published === true;
                
                console.log('Publish data (Today):', JSON.stringify(publishData));
                console.log('Is published (Today):', isPublished);
                
                const publishControlSection = document.getElementById('publishControlSection');
                const statusDiv = document.getElementById('publishStatusDisplay');
                const btnPub = document.getElementById('btnPublish');
                const btnUnpub = document.getElementById('btnUnpublish');
                
                if (!publishControlSection || !statusDiv || !btnPub || !btnUnpub) {
                    console.error('Could not find required elements (Today tab)');
                    return;
                }
                
                publishControlSection.style.display = 'block';
                
                if (isPublished) {
                    console.log('Showing UNPUBLISH button (Today tab)');
                    statusDiv.innerHTML = '<div style="background:#d4edda;padding:15px;border-radius:8px;border:2px solid #28a745"><p style="margin:0;color:#155724;font-weight:bold">âœ… Quiz is PUBLISHED - Students can see it</p><p style="margin:5px 0 0 0;color:#155724;font-size:13px">Published: ' + new Date(publishData.publishedAt).toLocaleString() + '</p></div>';
                    btnPub.style.display = 'none';
                    btnUnpub.style.display = 'inline-block';
                } else {
                    console.log('Showing PUBLISH button (Today tab)');
                    statusDiv.innerHTML = '<div style="background:#fff3cd;padding:15px;border-radius:8px;border:2px solid #ffc107"><p style="margin:0;color:#856404;font-weight:bold">âš ï¸ Quiz is DRAFT - Not visible to students</p><p style="margin:5px 0 0 0;color:#856404;font-size:13px">Click PUBLISH to make it visible</p></div>';
                    btnPub.style.display = 'inline-block';
                    btnUnpub.style.display = 'none';
                }
            } catch (err) {
                console.error('Check publish error (Today):', err);
            }
        }
        
        async function publishTodayQuiz() {
            const today = getQuizToday();
            if (!confirm('Publish today\'s quiz? Students will be able to see and attempt it.')) return;
            
            console.log('=== PUBLISH STARTED ===');
            console.log('Today:', today);
            console.log('Current user:', quizCurrentUser);
            
            try {
                const qSnap = await db.ref(`quizQuestions/${today}`).once('value');
                if (!qSnap.exists()) {
                    showQuizMsg('quizAdminDashMessage', 'âš ï¸ No questions saved for today!', 'error');
                    return;
                }
                
                // Get the email safely
                const userEmail = quizCurrentUser ? quizCurrentUser.email : 'admin@system';
                console.log('Using email:', userEmail);
                
                // Write to database and wait for completion
                await db.ref(`quizPublished/${today}`).set({
                    published: true,
                    publishedAt: new Date().toISOString(),
                    publishedBy: userEmail
                });
                
                console.log('Firebase write completed');
                
                // Verify the write
                const verifySnap = await db.ref(`quizPublished/${today}`).once('value');
                const publishData = verifySnap.val();
                console.log('Verification read:', JSON.stringify(publishData));
                
                showQuizMsg('quizAdminDashMessage', 'âœ… Quiz published successfully!', 'success');
                
                // Direct DOM manipulation - force the UI to update immediately
                const statusDivAdmin = document.getElementById('publishStatusDisplayAdmin');
                const btnPubAdmin = document.getElementById('btnPublishAdmin');
                const btnUnpubAdmin = document.getElementById('btnUnpublishAdmin');
                
                const statusDiv = document.getElementById('publishStatusDisplay');
                const btnPub = document.getElementById('btnPublish');
                const btnUnpub = document.getElementById('btnUnpublish');
                
                console.log('Found elements:');
                console.log('  statusDivAdmin:', !!statusDivAdmin);
                console.log('  btnPubAdmin:', !!btnPubAdmin);
                console.log('  btnUnpubAdmin:', !!btnUnpubAdmin);
                console.log('  statusDiv:', !!statusDiv);
                console.log('  btnPub:', !!btnPub);
                console.log('  btnUnpub:', !!btnUnpub);
                
                // Update Admin Dashboard
                if (statusDivAdmin && btnPubAdmin && btnUnpubAdmin) {
                    console.log('Updating Admin Dashboard UI directly');
                    statusDivAdmin.innerHTML = '<div style="background:#d4edda;padding:15px;border-radius:8px;border:2px solid #28a745"><p style="margin:0;color:#155724;font-weight:bold">âœ… Quiz is PUBLISHED - Students can see it</p><p style="margin:5px 0 0 0;color:#155724;font-size:13px">Published: ' + new Date(publishData.publishedAt).toLocaleString() + '</p></div>';
                    btnPubAdmin.style.display = 'none';
                    btnUnpubAdmin.style.display = 'inline-block';
                    console.log('Admin buttons updated - Publish:', btnPubAdmin.style.display, 'Unpublish:', btnUnpubAdmin.style.display);
                } else {
                    console.log('Could not update Admin Dashboard - elements missing');
                }
                
                // Update Quiz Management Tab
                if (statusDiv && btnPub && btnUnpub) {
                    console.log('Updating Quiz Management Tab UI directly');
                    statusDiv.innerHTML = '<div style="background:#d4edda;padding:15px;border-radius:8px;border:2px solid #28a745"><p style="margin:0;color:#155724;font-weight:bold">âœ… Quiz is PUBLISHED - Students can see it</p><p style="margin:5px 0 0 0;color:#155724;font-size:13px">Published: ' + new Date(publishData.publishedAt).toLocaleString() + '</p></div>';
                    btnPub.style.display = 'none';
                    btnUnpub.style.display = 'inline-block';
                    console.log('Quiz tab buttons updated - Publish:', btnPub.style.display, 'Unpublish:', btnUnpub.style.display);
                } else {
                    console.log('Could not update Quiz Management Tab - elements missing');
                }
                
                console.log('=== PUBLISH COMPLETED ===');
            } catch (err) {
                console.error('Publish error:', err);
                console.error('Error stack:', err.stack);
                showQuizMsg('quizAdminDashMessage', 'âŒ Error publishing: ' + err.message, 'error');
            }
        }
        
        async function unpublishTodayQuiz() {
            const today = getQuizToday();
            if (!confirm('Unpublish today\'s quiz? Students will no longer see it.')) return;
            
            console.log('=== UNPUBLISH STARTED ===');
            console.log('Today:', today);
            console.log('Current user:', quizCurrentUser);
            
            try {
                // Get the email safely
                const userEmail = quizCurrentUser ? quizCurrentUser.email : 'admin@system';
                console.log('Using email:', userEmail);
                
                // Write to database and wait for completion
                await db.ref(`quizPublished/${today}`).set({
                    published: false,
                    unpublishedAt: new Date().toISOString(),
                    unpublishedBy: userEmail
                });
                
                console.log('Firebase write completed');
                
                // Verify the write
                const verifySnap = await db.ref(`quizPublished/${today}`).once('value');
                console.log('Verification read:', JSON.stringify(verifySnap.val()));
                
                showQuizMsg('quizAdminDashMessage', 'âœ… Quiz unpublished successfully!', 'success');
                
                // Direct DOM manipulation - force the UI to update immediately
                const statusDivAdmin = document.getElementById('publishStatusDisplayAdmin');
                const btnPubAdmin = document.getElementById('btnPublishAdmin');
                const btnUnpubAdmin = document.getElementById('btnUnpublishAdmin');
                
                const statusDiv = document.getElementById('publishStatusDisplay');
                const btnPub = document.getElementById('btnPublish');
                const btnUnpub = document.getElementById('btnUnpublish');
                
                console.log('Found elements:');
                console.log('  statusDivAdmin:', !!statusDivAdmin);
                console.log('  btnPubAdmin:', !!btnPubAdmin);
                console.log('  btnUnpubAdmin:', !!btnUnpubAdmin);
                console.log('  statusDiv:', !!statusDiv);
                console.log('  btnPub:', !!btnPub);
                console.log('  btnUnpub:', !!btnUnpub);
                
                // Update Admin Dashboard
                if (statusDivAdmin && btnPubAdmin && btnUnpubAdmin) {
                    console.log('Updating Admin Dashboard UI directly');
                    statusDivAdmin.innerHTML = '<div style="background:#fff3cd;padding:15px;border-radius:8px;border:2px solid #ffc107"><p style="margin:0;color:#856404;font-weight:bold">âš ï¸ Quiz is DRAFT - Not visible to students</p><p style="margin:5px 0 0 0;color:#856404;font-size:13px">Click PUBLISH to make it visible</p></div>';
                    btnPubAdmin.style.display = 'inline-block';
                    btnUnpubAdmin.style.display = 'none';
                    console.log('Admin buttons updated - Publish:', btnPubAdmin.style.display, 'Unpublish:', btnUnpubAdmin.style.display);
                } else {
                    console.log('Could not update Admin Dashboard - elements missing');
                }
                
                // Update Quiz Management Tab
                if (statusDiv && btnPub && btnUnpub) {
                    console.log('Updating Quiz Management Tab UI directly');
                    statusDiv.innerHTML = '<div style="background:#fff3cd;padding:15px;border-radius:8px;border:2px solid #ffc107"><p style="margin:0;color:#856404;font-weight:bold">âš ï¸ Quiz is DRAFT - Not visible to students</p><p style="margin:5px 0 0 0;color:#856404;font-size:13px">Click PUBLISH to make it visible</p></div>';
                    btnPub.style.display = 'inline-block';
                    btnUnpub.style.display = 'none';
                    console.log('Quiz tab buttons updated - Publish:', btnPub.style.display, 'Unpublish:', btnUnpub.style.display);
                } else {
                    console.log('Could not update Quiz Management Tab - elements missing');
                }
                
                console.log('=== UNPUBLISH COMPLETED ===');
            } catch (err) {
                console.error('Unpublish error:', err);
                console.error('Error stack:', err.stack);
                showQuizMsg('quizAdminDashMessage', 'âŒ Error unpublishing: ' + err.message, 'error');
            }
        }
        
        async function showTodayAnswers() {
            const today = getQuizToday();
            try {
                const snap = await db.ref(`quizQuestions/${today}`).once('value');
                const q = snap.val();
                
                // Determine which section we're in
                const isAdmin = document.getElementById('publishControlSectionAdmin') && 
                               document.getElementById('publishControlSectionAdmin').style.display !== 'none';
                const divId = isAdmin ? 'answersDisplaySectionAdmin' : 'answersDisplaySection';
                const div = document.getElementById(divId);
                
                if (!div) {
                    console.error('Answers display div not found');
                    alert('Error: Unable to display answers. Please contact support.');
                    return;
                }
                
                if (!q || !q.q1 || !q.q2) {
                    div.innerHTML = '<div style="background:#f8d7da;padding:15px;border-radius:8px"><p style="margin:0;color:#721c24">âŒ No questions found for today</p></div>';
                    div.style.display = 'block';
                    return;
                }
                
                let html = '<div style="background:#e8f5e9;padding:25px;border-radius:12px;border:3px solid #4CAF50">';
                html += '<h3 style="color:#2e7d32;margin-bottom:20px;text-align:center">ðŸ” Correct Answers</h3>';
                
                html += '<div style="background:white;padding:20px;border-radius:10px;margin-bottom:15px;border-left:5px solid #4CAF50">';
                html += '<h4 style="color:#667eea;margin-bottom:15px">Question 1</h4>';
                html += `<p style="font-weight:600;margin-bottom:10px">${q.q1.text || 'N/A'}</p>`;
                html += `<p style="margin-left:20px;color:#666">A) ${q.q1.options.A || 'N/A'}</p>`;
                html += `<p style="margin-left:20px;color:#666">B) ${q.q1.options.B || 'N/A'}</p>`;
                html += `<p style="margin-left:20px;color:#666">C) ${q.q1.options.C || 'N/A'}</p>`;
                html += `<p style="margin-left:20px;color:#666">D) ${q.q1.options.D || 'N/A'}</p>`;
                html += `<div style="background:#4CAF50;color:white;padding:12px;border-radius:8px;margin-top:15px;font-weight:bold">âœ… Correct Answer: ${q.q1.correct}) ${q.q1.options[q.q1.correct] || 'N/A'}</div></div>`;
                
                html += '<div style="background:white;padding:20px;border-radius:10px;border-left:5px solid #4CAF50">';
                html += '<h4 style="color:#667eea;margin-bottom:15px">Question 2</h4>';
                html += `<p style="font-weight:600;margin-bottom:10px">${q.q2.text || 'N/A'}</p>`;
                html += `<p style="margin-left:20px;color:#666">A) ${q.q2.options.A || 'N/A'}</p>`;
                html += `<p style="margin-left:20px;color:#666">B) ${q.q2.options.B || 'N/A'}</p>`;
                html += `<p style="margin-left:20px;color:#666">C) ${q.q2.options.C || 'N/A'}</p>`;
                html += `<p style="margin-left:20px;color:#666">D) ${q.q2.options.D || 'N/A'}</p>`;
                html += `<div style="background:#4CAF50;color:white;padding:12px;border-radius:8px;margin-top:15px;font-weight:bold">âœ… Correct Answer: ${q.q2.correct}) ${q.q2.options[q.q2.correct] || 'N/A'}</div></div>`;
                
                html += '<p style="text-align:center;margin-top:20px;color:#666;font-size:14px"><em>Visible to Admin Only</em></p></div>';
                
                div.innerHTML = html;
                div.style.display = 'block';
                
                // Scroll to the answers with a small delay to ensure rendering
                setTimeout(() => {
                    div.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                }, 100);
            } catch (err) {
                console.error('Show answers error:', err);
                const div = document.getElementById('answersDisplaySectionAdmin') || document.getElementById('answersDisplaySection');
                if (div) {
                    div.innerHTML = '<div style="background:#f8d7da;padding:15px;border-radius:8px"><p style="margin:0;color:#721c24">âŒ Error loading answers: ' + err.message + '</p></div>';
                    div.style.display = 'block';
                }
                alert('Error displaying answers. Please check the console for details.');
            }
        }
        
        // Admin Dashboard specific publish check
        async function checkPublishStatusForAdmin() {
            const today = getQuizToday();
            console.log('=== checkPublishStatusForAdmin START ===');
            console.log('Date:', today);
            
            try {
                const qSnap = await db.ref(`quizQuestions/${today}`).once('value');
                if (!qSnap.exists()) {
                    console.log('No questions exist for today');
                    document.getElementById('publishControlSectionAdmin').style.display = 'none';
                    return;
                }
                
                const pSnap = await db.ref(`quizPublished/${today}`).once('value');
                const publishData = pSnap.val();
                const isPublished = publishData && publishData.published === true;
                
                console.log('Publish data:', publishData);
                console.log('Is published:', isPublished);
                
                const publishControlSection = document.getElementById('publishControlSectionAdmin');
                const statusDiv = document.getElementById('publishStatusDisplayAdmin');
                
                if (!publishControlSection || !statusDiv) {
                    console.error('Could not find required elements');
                    return;
                }
                
                publishControlSection.style.display = 'block';
                
                // Recreate buttons HTML to force update
                const buttonsContainer = publishControlSection.querySelector('div[style*="display:flex"]');
                if (buttonsContainer) {
                    if (isPublished) {
                        console.log('Setting UP: UNPUBLISH button visible');
                        statusDiv.innerHTML = '<div style="background:#d4edda;padding:15px;border-radius:8px;border:2px solid #28a745"><p style="margin:0;color:#155724;font-weight:bold">âœ… Quiz is PUBLISHED - Students can see it</p><p style="margin:5px 0 0 0;color:#155724;font-size:13px">Published: ' + new Date(publishData.publishedAt).toLocaleString() + '</p></div>';
                        
                        buttonsContainer.innerHTML = `
                            <button class="btn btn-success" onclick="publishTodayQuiz()" id="btnPublishAdmin" style="display:none">âœ… PUBLISH Quiz (Make Live)</button>
                            <button class="btn btn-danger" onclick="unpublishTodayQuiz()" id="btnUnpublishAdmin" style="display:inline-block">âŒ UNPUBLISH Quiz (Hide)</button>
                        `;
                    } else {
                        console.log('Setting UP: PUBLISH button visible');
                        statusDiv.innerHTML = '<div style="background:#fff3cd;padding:15px;border-radius:8px;border:2px solid #ffc107"><p style="margin:0;color:#856404;font-weight:bold">âš ï¸ Quiz is DRAFT - Not visible to students</p><p style="margin:5px 0 0 0;color:#856404;font-size:13px">Click PUBLISH to make it visible</p></div>';
                        
                        buttonsContainer.innerHTML = `
                            <button class="btn btn-success" onclick="publishTodayQuiz()" id="btnPublishAdmin" style="display:inline-block">âœ… PUBLISH Quiz (Make Live)</button>
                            <button class="btn btn-danger" onclick="unpublishTodayQuiz()" id="btnUnpublishAdmin" style="display:none">âŒ UNPUBLISH Quiz (Hide)</button>
                        `;
                    }
                    console.log('Buttons HTML updated successfully');
                }
                
                console.log('=== checkPublishStatusForAdmin END ===');
            } catch (err) {
                console.error('Check publish error:', err);
            }
        }
        
        // ============================================
        // QUIZ DATE EDIT FUNCTIONS (Super Admin Only)
        // ============================================
        
        let selectedQuizForDateEdit = null;
        
        async function loadQuizzesForDateEdit() {
            try {
                const snapshot = await db.ref('quizQuestions').once('value');
                const quizzes = snapshot.val() || {};
                const quizListContainer = document.getElementById('quizListForDateEdit');
                
                if (Object.keys(quizzes).length === 0) {
                    quizListContainer.innerHTML = '<p style="text-align:center;color:#666;">No quizzes available to edit.</p>';
                    return;
                }
                
                let html = '';
                // Sort by date descending
                Object.entries(quizzes).sort((a, b) => b[0].localeCompare(a[0])).forEach(([date, quiz]) => {
                    const question1Preview = quiz.q1 ? quiz.q1.text.substring(0, 60) : (quiz.question1 ? quiz.question1.text.substring(0, 60) : '');
                    html += `
                        <div class="quiz-list-item" onclick="selectQuizForDateEdit('${date}')" id="quiz-item-${date}">
                            <div>
                                <div class="quiz-date-info">ðŸ“… ${date}</div>
                                <div class="quiz-question-preview">${question1Preview}${question1Preview.length >= 60 ? '...' : ''}</div>
                            </div>
                            <div>
                                <button class="btn btn-small btn-edit-date" onclick="event.stopPropagation(); selectQuizForDateEdit('${date}')">ðŸ“… Edit Date</button>
                            </div>
                        </div>
                    `;
                });
                
                quizListContainer.innerHTML = html;
            } catch (error) {
                console.error('Error loading quizzes for date edit:', error);
                showQuizMsg('dateChangeMessage', 'Error loading quizzes.', 'error');
            }
        }
        
        async function selectQuizForDateEdit(date) {
            try {
                const snapshot = await db.ref('quizQuestions/' + date).once('value');
                const quiz = snapshot.val();
                if (!quiz) return;
                
                selectedQuizForDateEdit = { date, ...quiz };
                
                // Highlight selected quiz
                document.querySelectorAll('.quiz-list-item').forEach(item => {
                    item.classList.remove('selected');
                });
                const selectedItem = document.getElementById('quiz-item-' + date);
                if (selectedItem) {
                    selectedItem.classList.add('selected');
                }
                
                // Show date change form
                document.getElementById('currentQuizDate').textContent = date;
                const questionPreview = quiz.q1 ? quiz.q1.text : (quiz.question1 ? quiz.question1.text : 'No question text');
                document.getElementById('currentQuizPreview').textContent = questionPreview;
                document.getElementById('newQuizDate').value = '';
                document.getElementById('dateChangeForm').style.display = 'block';
            } catch (error) {
                console.error('Error selecting quiz:', error);
                showQuizMsg('dateChangeMessage', 'Error selecting quiz.', 'error');
            }
        }
        
        function cancelDateEdit() {
            selectedQuizForDateEdit = null;
            document.getElementById('dateChangeForm').style.display = 'none';
            document.querySelectorAll('.quiz-list-item').forEach(item => {
                item.classList.remove('selected');
            });
            document.getElementById('dateChangeMessage').classList.remove('show');
        }
        
        async function updateQuizDate() {
            if (!selectedQuizForDateEdit) {
                showQuizMsg('dateChangeMessage', 'Please select a quiz first.', 'error');
                return;
            }
            
            const newDate = document.getElementById('newQuizDate').value;
            if (!newDate) {
                showQuizMsg('dateChangeMessage', 'Please select a new date.', 'error');
                return;
            }
            
            if (newDate === selectedQuizForDateEdit.date) {
                showQuizMsg('dateChangeMessage', 'New date must be different from current date.', 'error');
                return;
            }
            
            // Check if new date already has a quiz
            try {
                const snapshot = await db.ref('quizQuestions/' + newDate).once('value');
                if (snapshot.exists()) {
                    const confirmOverwrite = confirm(`A quiz already exists for ${newDate}. Do you want to overwrite it?`);
                    if (!confirmOverwrite) return;
                }
                
                // Show confirmation modal
                document.getElementById('dateEditModalMessage').innerHTML = `
                    <p>Are you sure you want to change the quiz date?</p>
                    <p style="margin-top:10px;"><strong>From:</strong> <span style="color:#c44569;">${selectedQuizForDateEdit.date}</span></p>
                    <p><strong>To:</strong> <span style="color:#4CAF50;">${newDate}</span></p>
                    <p style="margin-top:15px;font-size:0.9em;color:#666;">This will move the quiz and its publish status to the new date.</p>
                `;
                document.getElementById('quizDateEditModal').style.display = 'block';
            } catch (error) {
                console.error('Error checking new date:', error);
                showQuizMsg('dateChangeMessage', 'Error checking new date.', 'error');
            }
        }
        
        async function confirmDateChange() {
            const oldDate = selectedQuizForDateEdit.date;
            const newDate = document.getElementById('newQuizDate').value;
            const autoPublish = document.getElementById('autoPublishAfterMove').checked;
            
            try {
                // Get all related data
                const quizSnapshot = await db.ref('quizQuestions/' + oldDate).once('value');
                const publishSnapshot = await db.ref('quizPublished/' + oldDate).once('value');
                const submissionsSnapshot = await db.ref('quizSubmissions/' + oldDate).once('value');
                const resultsSnapshot = await db.ref('quizResults/' + oldDate).once('value');
                
                const quizData = quizSnapshot.val();
                const publishData = publishSnapshot.val();
                const submissionsData = submissionsSnapshot.val();
                const resultsData = resultsSnapshot.val();
                
                if (!quizData) {
                    throw new Error('No quiz found at old date');
                }
                
                // Create array of all write operations
                const writeOperations = [];
                
                // Write quiz to new date
                writeOperations.push(db.ref('quizQuestions/' + newDate).set(quizData));
                
                // Handle publish status
                if (autoPublish) {
                    // Auto-publish at new date
                    writeOperations.push(db.ref('quizPublished/' + newDate).set({
                        published: true,
                        publishedAt: Date.now(),
                        publishedBy: 'Super Admin (via date change)'
                    }));
                } else if (publishData) {
                    // Keep existing publish status
                    writeOperations.push(db.ref('quizPublished/' + newDate).set(publishData));
                }
                
                // Move submissions if exist
                if (submissionsData) {
                    writeOperations.push(db.ref('quizSubmissions/' + newDate).set(submissionsData));
                }
                
                // Move results if exist
                if (resultsData) {
                    writeOperations.push(db.ref('quizResults/' + newDate).set(resultsData));
                }
                
                // Wait for ALL writes to complete
                await Promise.all(writeOperations);
                
                // Now delete old entries - create array of delete operations
                const deleteOperations = [];
                deleteOperations.push(db.ref('quizQuestions/' + oldDate).remove());
                
                if (publishData) {
                    deleteOperations.push(db.ref('quizPublished/' + oldDate).remove());
                }
                
                if (submissionsData) {
                    deleteOperations.push(db.ref('quizSubmissions/' + oldDate).remove());
                }
                
                if (resultsData) {
                    deleteOperations.push(db.ref('quizResults/' + oldDate).remove());
                }
                
                // Wait for ALL deletes to complete
                await Promise.all(deleteOperations);
                
                // Show success message
                closeQuizDateEditModal();
                const publishMsg = autoPublish ? ' and published' : '';
                showQuizMsg('dateChangeMessage', `Quiz date successfully changed from ${oldDate} to ${newDate}${publishMsg}!`, 'success');
                
                // Reload quiz list
                setTimeout(() => {
                    cancelDateEdit();
                    loadQuizzesForDateEdit();
                }, 2000);
                
            } catch (error) {
                console.error('Date change error:', error);
                closeQuizDateEditModal();
                showQuizMsg('dateChangeMessage', 'Failed to change quiz date. Please try again.', 'error');
            }
        }
        
        function closeQuizDateEditModal() {
            document.getElementById('quizDateEditModal').style.display = 'none';
        }
        
        function showQuizMsg(elementId, text, type) {
            const message = document.getElementById(elementId);
            if (message) {
                message.textContent = text;
                message.className = `message ${type} show`;
                setTimeout(() => {
                    message.classList.remove('show');
                }, 5000);
            }
        }
    </script>
    
    <!-- ============================================ -->
    <!-- CLASS OF THE YEAR 2026 LEADERBOARD           -->
    <!-- Pulls live data from Firebase automatically  -->
    <!-- ============================================ -->
    <style>
        /* ===== LEADERBOARD STYLES ===== */
        @import url('https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700;900&family=DM+Sans:wght@400;500;600&display=swap');

        @keyframes lbFadeUp {
            from { opacity:0; transform:translateY(40px); }
            to   { opacity:1; transform:translateY(0); }
        }
        @keyframes lbShine {
            0%   { background-position: -200% center; }
            100% { background-position: 200% center; }
        }
        @keyframes lbGlow {
            0%,100% { box-shadow: 0 0 20px rgba(196,69,105,0.3); }
            50%      { box-shadow: 0 0 40px rgba(196,69,105,0.6), 0 0 60px rgba(106,27,154,0.3); }
        }
        @keyframes lbPodiumRise {
            from { transform: scaleY(0); transform-origin: bottom; }
            to   { transform: scaleY(1); transform-origin: bottom; }
        }
        @keyframes lbSparkle {
            0%,100% { transform: scale(1) rotate(0deg); opacity:1; }
            50%      { transform: scale(1.3) rotate(180deg); opacity:0.8; }
        }
        @keyframes lbRowSlide {
            from { opacity:0; transform:translateX(-30px); }
            to   { opacity:1; transform:translateX(0); }
        }
        @keyframes lbCountUp {
            from { opacity:0; transform:scale(0.5); }
            to   { opacity:1; transform:scale(1); }
        }
        @keyframes lbCrownFloat {
            0%,100% { transform: translateY(0px) rotate(-5deg); }
            50%      { transform: translateY(-8px) rotate(5deg); }
        }
        @keyframes lbPulseRing {
            0%   { transform: scale(1); opacity:0.8; }
            100% { transform: scale(1.5); opacity:0; }
        }

        .lb-section {
            margin: 40px 0 30px;
            animation: lbFadeUp 0.8s ease-out;
        }

        /* --- Header --- */
        .lb-header {
            text-align: center;
            padding: 50px 30px 40px;
            background: linear-gradient(135deg, #1a0030 0%, #3d0060 40%, #6a1b9a 70%, #c44569 100%);
            border-radius: 24px 24px 0 0;
            position: relative;
            overflow: hidden;
        }
        .lb-header::before {
            content: '';
            position: absolute; inset: 0;
            background: repeating-linear-gradient(
                45deg,
                transparent, transparent 20px,
                rgba(255,255,255,0.03) 20px, rgba(255,255,255,0.03) 40px
            );
        }
        .lb-header-stars {
            position: absolute; inset: 0; pointer-events: none;
        }
        .lb-star {
            position: absolute;
            color: rgba(255,255,255,0.15);
            font-size: 1.2em;
            animation: lbSparkle 3s ease-in-out infinite;
        }
        .lb-crown {
            font-size: 4em;
            display: block;
            margin-bottom: 10px;
            animation: lbCrownFloat 3s ease-in-out infinite;
            position: relative; z-index:1;
        }
        .lb-title {
            font-family: 'Playfair Display', Georgia, serif;
            font-size: clamp(1.8em, 4vw, 3em);
            font-weight: 900;
            color: #fff;
            letter-spacing: 2px;
            margin-bottom: 6px;
            background: linear-gradient(90deg, #fff 0%, #ffd700 50%, #fff 100%);
            background-size: 200% auto;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            animation: lbShine 3s linear infinite;
            position: relative; z-index:1;
        }
        .lb-subtitle {
            font-family: 'DM Sans', sans-serif;
            color: rgba(255,255,255,0.75);
            font-size: 1em;
            letter-spacing: 4px;
            text-transform: uppercase;
            position: relative; z-index:1;
        }
        .lb-events-pills {
            display: flex;
            justify-content: center;
            gap: 12px;
            margin-top: 20px;
            flex-wrap: wrap;
            position: relative; z-index:1;
        }
        .lb-pill {
            background: rgba(255,255,255,0.12);
            border: 1px solid rgba(255,255,255,0.25);
            color: white;
            padding: 6px 18px;
            border-radius: 30px;
            font-size: 0.85em;
            font-family: 'DM Sans', sans-serif;
            backdrop-filter: blur(8px);
        }

        /* --- Body card --- */
        .lb-body {
            background: white;
            border-radius: 0 0 24px 24px;
            box-shadow: 0 20px 60px rgba(106,27,154,0.15);
            overflow: hidden;
        }

        /* --- Scoring legend --- */
        .lb-legend {
            display: flex;
            gap: 10px;
            padding: 20px 30px;
            background: #faf5ff;
            border-bottom: 2px solid #f0e6ff;
            flex-wrap: wrap;
            align-items: center;
        }
        .lb-legend-title {
            font-family: 'DM Sans', sans-serif;
            font-weight: 600;
            color: #6a1b9a;
            font-size: 0.9em;
            margin-right: 6px;
        }
        .lb-legend-item {
            display: flex;
            align-items: center;
            gap: 6px;
            background: white;
            border: 1px solid #e0d0f0;
            border-radius: 20px;
            padding: 5px 14px;
            font-size: 0.82em;
            font-family: 'DM Sans', sans-serif;
            color: #444;
        }
        .lb-legend-dot {
            width: 10px; height: 10px;
            border-radius: 50%;
        }

        /* --- Top 3 Podium --- */
        .lb-podium-section {
            padding: 40px 30px 20px;
            background: linear-gradient(180deg, #fdf6ff 0%, #ffffff 100%);
        }
        .lb-podium-title {
            text-align: center;
            font-family: 'Playfair Display', serif;
            color: #6a1b9a;
            font-size: 1.4em;
            margin-bottom: 30px;
            font-weight: 700;
        }
        .lb-podium {
            display: flex;
            align-items: flex-end;
            justify-content: center;
            gap: 16px;
            max-width: 600px;
            margin: 0 auto;
        }
        .lb-podium-slot {
            flex: 1;
            text-align: center;
            max-width: 180px;
        }
        .lb-podium-name {
            font-family: 'DM Sans', sans-serif;
            font-weight: 600;
            font-size: 0.85em;
            color: #333;
            margin-bottom: 8px;
            line-height: 1.3;
            word-break: break-word;
        }
        .lb-podium-score {
            font-family: 'Playfair Display', serif;
            font-weight: 700;
            font-size: 1.1em;
            color: #6a1b9a;
            margin-bottom: 8px;
        }
        .lb-podium-block {
            border-radius: 12px 12px 0 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.5em;
            position: relative;
            overflow: hidden;
            animation: lbPodiumRise 0.8s ease-out;
        }
        .lb-podium-block::after {
            content: '';
            position: absolute; inset: 0;
            background: linear-gradient(180deg, rgba(255,255,255,0.2) 0%, transparent 100%);
        }
        .lb-pos-1 .lb-podium-block {
            height: 130px;
            background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
            box-shadow: 0 8px 25px rgba(255,165,0,0.4);
        }
        .lb-pos-2 .lb-podium-block {
            height: 100px;
            background: linear-gradient(135deg, #C0C0C0 0%, #A8A8A8 100%);
            box-shadow: 0 6px 20px rgba(150,150,150,0.3);
        }
        .lb-pos-3 .lb-podium-block {
            height: 75px;
            background: linear-gradient(135deg, #CD7F32 0%, #A0522D 100%);
            box-shadow: 0 5px 15px rgba(160,82,45,0.3);
        }
        .lb-pos-1 .lb-podium-name {
            font-size: 1em;
            color: #4a0080;
        }
        .lb-pos-1 .lb-podium-score {
            font-size: 1.3em;
            color: #c44569;
        }
        .lb-pos-1-ring {
            position: relative;
        }
        .lb-pos-1-ring::before {
            content: '';
            position: absolute;
            inset: -4px;
            border-radius: 50%;
            background: conic-gradient(#FFD700, #FF6B6B, #6A1B9A, #FFD700);
            z-index: -1;
            animation: lbPulseRing 2s ease-out infinite;
            opacity: 0;
        }

        /* --- Full Rankings Table --- */
        .lb-table-section {
            padding: 10px 30px 40px;
        }
        .lb-table-header {
            font-family: 'Playfair Display', serif;
            color: #6a1b9a;
            font-size: 1.2em;
            margin: 24px 0 16px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .lb-table-wrap {
            overflow-x: auto;
            border-radius: 16px;
            border: 2px solid #f0e6ff;
        }
        .lb-table {
            width: 100%;
            border-collapse: collapse;
            min-width: 560px;
            font-family: 'DM Sans', sans-serif;
        }
        .lb-table thead tr {
            background: linear-gradient(135deg, #c44569 0%, #6a1b9a 100%);
        }
        .lb-table thead th {
            color: white;
            padding: 14px 18px;
            font-size: 0.85em;
            font-weight: 600;
            letter-spacing: 0.5px;
            text-align: left;
            white-space: nowrap;
        }
        .lb-table tbody tr {
            border-bottom: 1px solid #f5eeff;
            transition: all 0.25s;
            animation: lbRowSlide 0.4s ease-out both;
        }
        .lb-table tbody tr:hover {
            background: #fdf5ff;
            transform: translateX(4px);
        }
        .lb-table tbody tr:last-child {
            border-bottom: none;
        }
        .lb-table tbody td {
            padding: 14px 18px;
            font-size: 0.92em;
            color: #333;
            white-space: nowrap;
        }
        .lb-rank-badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 34px; height: 34px;
            border-radius: 50%;
            font-weight: 700;
            font-size: 0.95em;
        }
        .lb-rank-1 { background: linear-gradient(135deg,#FFD700,#FFA500); color:#333; box-shadow:0 3px 10px rgba(255,165,0,0.4); }
        .lb-rank-2 { background: linear-gradient(135deg,#C0C0C0,#A8A8A8); color:#333; box-shadow:0 3px 10px rgba(150,150,150,0.3); }
        .lb-rank-3 { background: linear-gradient(135deg,#CD7F32,#A0522D); color:#fff; box-shadow:0 3px 10px rgba(160,82,45,0.3); }
        .lb-rank-other { background: #f0e6ff; color:#6a1b9a; }
        .lb-class-chip {
            background: linear-gradient(135deg, #f3e5ff 0%, #e8d5ff 100%);
            color: #6a1b9a;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.82em;
            font-weight: 600;
            display: inline-block;
        }
        .lb-pts-total {
            font-weight: 700;
            color: #c44569;
            font-size: 1.05em;
        }
        .lb-pts-event {
            font-size: 0.82em;
            color: #888;
        }
        .lb-bar-wrap {
            background: #f5eeff;
            border-radius: 10px;
            height: 8px;
            min-width: 80px;
            overflow: hidden;
        }
        .lb-bar-fill {
            height: 100%;
            border-radius: 10px;
            background: linear-gradient(90deg, #c44569, #6a1b9a);
            transition: width 1.2s ease;
        }
        .lb-loading {
            text-align: center;
            padding: 60px 20px;
            color: #aaa;
            font-family: 'DM Sans', sans-serif;
        }
        .lb-loading-spinner {
            width: 40px; height: 40px;
            border: 4px solid #f0e6ff;
            border-top-color: #c44569;
            border-radius: 50%;
            margin: 0 auto 16px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { to { transform:rotate(360deg); } }

        .lb-empty {
            text-align: center;
            padding: 50px 20px;
            color: #bbb;
            font-family: 'DM Sans', sans-serif;
            font-size: 1.1em;
        }
        .lb-last-updated {
            text-align: center;
            font-family: 'DM Sans', sans-serif;
            font-size: 0.8em;
            color: #bbb;
            padding: 15px;
            border-top: 1px solid #f5eeff;
        }
        .lb-refresh-btn {
            background: linear-gradient(135deg, #c44569 0%, #6a1b9a 100%);
            color: white;
            border: none;
            padding: 8px 20px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.85em;
            font-family: 'DM Sans', sans-serif;
            font-weight: 600;
            margin-left: 10px;
            transition: all 0.3s;
        }
        .lb-refresh-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(196,69,105,0.35);
        }

        /* Scoring breakdown popover */
        .lb-breakdown {
            display: inline-flex;
            gap: 6px;
            flex-wrap: wrap;
        }
        .lb-score-tag {
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.75em;
            font-weight: 600;
        }
        .lb-score-yf   { background:#fff3cd; color:#856404; border:1px solid #ffc107; }
        .lb-score-quiz { background:#d4edda; color:#155724; border:1px solid #28a745; }

        @media (max-width: 600px) {
            .lb-podium { gap: 8px; }
            .lb-table-section, .lb-legend { padding-left: 15px; padding-right: 15px; }
            .lb-pos-1 .lb-podium-block { height: 100px; }
            .lb-pos-2 .lb-podium-block { height: 75px; }
            .lb-pos-3 .lb-podium-block { height: 55px; }
        }
    </style>

    <div class="lb-section" id="leaderboardSection">

        <!-- Header -->
        <div class="lb-header">
            <div class="lb-header-stars" id="lbStars"></div>
            <span class="lb-crown">ðŸ‘‘</span>
            <div class="lb-title">Class of the Year 2026</div>
            <div class="lb-subtitle">Spurthi Youth Fest Â· Overall Rankings</div>
            <div class="lb-events-pills">
                <span class="lb-pill">ðŸŽ¤ Youthfest Registration</span>
                <span class="lb-pill">ðŸ§  Online Quiz Competition</span>
            </div>
        </div>

        <!-- Body -->
        <!-- Hidden-by-default gate; shown only when leaderboard is published -->
        <div id="lbHiddenMsg" style="display:none;border-radius:0 0 24px 24px;overflow:hidden">

            <!-- â”€â”€ COMING SOON BANNER (always shown when hidden) â”€â”€ -->
            <div style="text-align:center;padding:50px 30px 40px;background:linear-gradient(135deg,#1a0030 0%,#3d0060 40%,#6a1b9a 70%,#c44569 100%);position:relative">
                <div style="position:absolute;inset:0;background:repeating-linear-gradient(45deg,transparent,transparent 20px,rgba(255,255,255,0.02) 20px,rgba(255,255,255,0.02) 40px)"></div>
                <div style="position:relative;z-index:1">
                    <div style="font-size:3em;margin-bottom:14px">ðŸ”’</div>
                    <!-- Editable heading -->
                    <div id="hwpHeadingView">
                        <h2 id="hwpHeadingText" style="color:#ffd700;margin-bottom:10px;font-size:1.8em;letter-spacing:1px;text-shadow:0 0 20px rgba(255,215,0,0.4)">Leaderboard Coming Soon!</h2>
                    </div>
                    <div id="hwpHeadingEdit" style="display:none;margin-bottom:10px">
                        <input id="hwpHeadingInput" type="text" style="width:80%;max-width:500px;padding:10px 16px;border-radius:8px;border:2px solid #ffd700;background:rgba(255,255,255,0.1);color:#ffd700;font-size:1.3em;font-weight:700;text-align:center;outline:none">
                    </div>
                    <!-- Editable sub-text -->
                    <div id="hwpSubView">
                        <p id="hwpSubText" style="color:rgba(255,255,255,0.8);font-size:1em;margin:0">Results will be published by the Super Admin once the events are completed.<br>Check back soon!</p>
                    </div>
                    <div id="hwpSubEdit" style="display:none;margin-top:8px">
                        <textarea id="hwpSubInput" rows="2" style="width:80%;max-width:500px;padding:10px 14px;border-radius:8px;border:2px solid rgba(255,255,255,0.4);background:rgba(255,255,255,0.1);color:white;font-size:0.95em;text-align:center;outline:none;resize:vertical"></textarea>
                    </div>
                    <!-- Super Admin edit controls (only shown when SA logged in) -->
                    <div id="hwpBannerEditControls" class="super-admin-only" style="display:none;margin-top:16px;gap:8px;flex-wrap:wrap;justify-content:center">
                        <button onclick="hwpToggleBannerEdit()" id="hwpBannerEditBtn" style="background:rgba(255,215,0,0.2);color:#ffd700;border:1px solid #ffd700;padding:6px 16px;border-radius:6px;cursor:pointer;font-size:13px;font-weight:600">âœï¸ Edit Banner Text</button>
                        <button onclick="hwpSaveBanner()" id="hwpBannerSaveBtn" style="display:none;background:#ffd700;color:#1a0030;border:none;padding:6px 16px;border-radius:6px;cursor:pointer;font-size:13px;font-weight:700">ðŸ’¾ Save</button>
                        <button onclick="hwpCancelBannerEdit()" id="hwpBannerCancelBtn" style="display:none;background:rgba(255,255,255,0.15);color:white;border:1px solid rgba(255,255,255,0.3);padding:6px 16px;border-radius:6px;cursor:pointer;font-size:13px">Cancel</button>
                        <span id="hwpBannerSaveMsg" style="display:none;background:rgba(40,167,69,0.3);color:#a5d6a7;border:1px solid #28a745;padding:5px 12px;border-radius:6px;font-size:12px;font-weight:600">âœ… Saved!</span>
                    </div>
                </div>
            </div>

            <!-- â”€â”€ HOW WE PUBLISH â€” full section (white card below banner) â”€â”€ -->
            <!-- Accordion wrapper -->
            <div style="border:2px solid #e8d5f5;border-radius:12px;overflow:hidden;margin-bottom:4px">
                <!-- Accordion header -->
                <div onclick="toggleLoginAccordion('accHowWePublish','arrHowWePublish')" style="display:flex;justify-content:space-between;align-items:center;padding:14px 20px;background:linear-gradient(135deg,#f3e5ff,#fce4ec);cursor:pointer;user-select:none">
                    <div style="display:flex;align-items:center;gap:10px">
                        <span style="font-size:1.1em">ðŸ“‹</span>
                        <strong style="font-size:0.95em;color:#3d0060">How We Publish the Leaderboard</strong>
                    </div>
                    <span id="arrHowWePublish" style="font-size:1.1em;color:#6a1b9a;transition:transform 0.2s;display:inline-block">â–¶</span>
                </div>
                <!-- Accordion body -->
                <div id="accHowWePublish" style="display:none">
            <div style="background:white">

                <!-- Section header with SA edit toggle -->
                <div style="background:linear-gradient(135deg,#f3e5ff,#fce4ec);padding:20px 28px;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:10px;border-bottom:2px solid #e8d5f5">
                    <div style="display:flex;align-items:center;gap:10px">
                        <span style="font-size:1.5em">ðŸ“‹</span>
                        <div>
                            <h3 id="hwpSectionTitle" style="color:#3d0060;margin:0;font-size:1.1em;font-weight:800">How We Publish the Leaderboard</h3>
                            <p style="color:#666;margin:3px 0 0;font-size:12px">Transparent process â€” Spurthi Youth Fest 2026</p>
                        </div>
                    </div>
                    <!-- SA edit mode toggle -->
                    <div id="hwpEditModeControls" class="super-admin-only" style="display:none;gap:8px">
                        <button onclick="hwpToggleEditMode()" id="hwpEditModeBtn" style="background:linear-gradient(135deg,#6a1b9a,#c44569);color:white;border:none;padding:7px 16px;border-radius:6px;cursor:pointer;font-size:13px;font-weight:600">âœï¸ Edit This Section</button>
                        <button onclick="hwpSaveAll()" id="hwpSaveAllBtn" style="display:none;background:#28a745;color:white;border:none;padding:7px 16px;border-radius:6px;cursor:pointer;font-size:13px;font-weight:700">ðŸ’¾ Save All Changes</button>
                        <button onclick="hwpCancelEdit()" id="hwpCancelBtn" style="display:none;background:#666;color:white;border:none;padding:7px 16px;border-radius:6px;cursor:pointer;font-size:13px">âœ• Cancel</button>
                        <span id="hwpSaveAllMsg" style="display:none;background:#d4edda;color:#155724;border:1px solid #c3e6cb;padding:5px 12px;border-radius:6px;font-size:12px;font-weight:600">âœ… All changes saved!</span>
                    </div>
                </div>

                <div style="padding:24px 28px">

                    <!-- Overview text â€” editable -->
                    <div id="hwpOverviewView" style="background:linear-gradient(135deg,#f3e5ff,#fce4ec);border-radius:10px;padding:16px 18px;margin-bottom:22px;border-left:4px solid #6a1b9a">
                        <p id="hwpOverviewText" style="margin:0;color:#3d0060;font-size:13.5px;line-height:1.75">The <strong style="color:#c44569">Class of the Year 2026</strong> leaderboard ranks all <strong>11 classes</strong> competing across <strong>16 events</strong> at Spurthi Youth Fest. Rankings are hidden until the Super Admin verifies all results and officially publishes them â€” ensuring every score is accurate before you see it.</p>
                    </div>
                    <div id="hwpOverviewEdit" style="display:none;margin-bottom:22px">
                        <label style="font-size:12px;color:#6a1b9a;font-weight:700;display:block;margin-bottom:6px">Overview paragraph (supports basic HTML like &lt;strong&gt;):</label>
                        <textarea id="hwpOverviewInput" rows="4" style="width:100%;padding:10px 14px;border:2px solid #6a1b9a;border-radius:8px;font-size:13px;line-height:1.6;resize:vertical;outline:none"></textarea>
                    </div>

                    <!-- Points breakdown â€” 4 editable cards -->
                    <h4 style="color:#1a0030;font-size:1em;margin:0 0 12px;display:flex;align-items:center;gap:8px">
                        <span style="background:linear-gradient(135deg,#6a1b9a,#c44569);color:white;border-radius:50%;width:24px;height:24px;display:inline-flex;align-items:center;justify-content:center;font-size:11px;flex-shrink:0;font-weight:700">1</span>
                        How Points Are Calculated
                    </h4>
                    <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px;margin-bottom:24px" id="hwpPointsGrid">

                        <div style="background:#fffde7;border-radius:10px;padding:15px;border-top:4px solid #ffc107" data-hwp-card="0">
                            <div style="display:flex;align-items:center;gap:8px;margin-bottom:7px"><span style="font-size:1.3em">ðŸŽ¤</span><strong id="hwpCard0Title" style="color:#856404;font-size:0.9em">Youthfest Registration</strong></div>
                            <p id="hwpCard0Body" style="margin:0;color:#555;font-size:12.5px;line-height:1.6">Each class earns points for <strong>every event they enrol in</strong>. More participation = more points for your class.</p>
                            <div class="hwpCardEditArea" style="display:none;margin-top:8px">
                                <input type="text" class="hwpCardTitleInput" data-idx="0" placeholder="Card title" style="width:100%;padding:5px 8px;border:1px solid #ffc107;border-radius:4px;font-size:12px;margin-bottom:5px">
                                <textarea class="hwpCardBodyInput" data-idx="0" rows="3" placeholder="Card body text" style="width:100%;padding:5px 8px;border:1px solid #ffc107;border-radius:4px;font-size:12px;resize:vertical"></textarea>
                            </div>
                        </div>

                        <div style="background:#e8f5e9;border-radius:10px;padding:15px;border-top:4px solid #28a745" data-hwp-card="1">
                            <div style="display:flex;align-items:center;gap:8px;margin-bottom:7px"><span style="font-size:1.3em">ðŸ§ </span><strong id="hwpCard1Title" style="color:#155724;font-size:0.9em">Quiz Competition</strong></div>
                            <p id="hwpCard1Body" style="margin:0;color:#555;font-size:12.5px;line-height:1.6">Per published quiz day: <strong>flat bonus</strong> to the winner &amp; runner-up class, plus a <strong>participation rate bonus</strong> â€” fair across all class sizes.</p>
                            <div class="hwpCardEditArea" style="display:none;margin-top:8px">
                                <input type="text" class="hwpCardTitleInput" data-idx="1" placeholder="Card title" style="width:100%;padding:5px 8px;border:1px solid #28a745;border-radius:4px;font-size:12px;margin-bottom:5px">
                                <textarea class="hwpCardBodyInput" data-idx="1" rows="3" placeholder="Card body text" style="width:100%;padding:5px 8px;border:1px solid #28a745;border-radius:4px;font-size:12px;resize:vertical"></textarea>
                            </div>
                        </div>

                        <div style="background:#f3e5ff;border-radius:10px;padding:15px;border-top:4px solid #6a1b9a" data-hwp-card="2">
                            <div style="display:flex;align-items:center;gap:8px;margin-bottom:7px"><span style="font-size:1.3em">ðŸ†</span><strong id="hwpCard2Title" style="color:#4a148c;font-size:0.9em">Event Results</strong></div>
                            <p id="hwpCard2Body" style="margin:0;color:#555;font-size:12.5px;line-height:1.6">When jury results are published, the <strong>1st place class</strong> gets winner pts and <strong>2nd place</strong> gets runner-up pts. For individual &amp; multi-team events, each class is represented by their <strong>best performer or best team</strong>.</p>
                            <div class="hwpCardEditArea" style="display:none;margin-top:8px">
                                <input type="text" class="hwpCardTitleInput" data-idx="2" placeholder="Card title" style="width:100%;padding:5px 8px;border:1px solid #6a1b9a;border-radius:4px;font-size:12px;margin-bottom:5px">
                                <textarea class="hwpCardBodyInput" data-idx="2" rows="3" placeholder="Card body text" style="width:100%;padding:5px 8px;border:1px solid #6a1b9a;border-radius:4px;font-size:12px;resize:vertical"></textarea>
                            </div>
                        </div>

                        <div style="background:#fff3e0;border-radius:10px;padding:15px;border-top:4px solid #e8722a" data-hwp-card="3">
                            <div style="display:flex;align-items:center;gap:8px;margin-bottom:7px"><span style="font-size:1.3em">ðŸ—ºï¸</span><strong id="hwpCard3Title" style="color:#bf360c;font-size:0.9em">Scavenger Hunt</strong></div>
                            <p id="hwpCard3Body" style="margin:0;color:#555;font-size:12.5px;line-height:1.6">Points are awarded for <strong>approved task submissions</strong> in the Scavenger Hunt. The more tasks a student completes and gets approved, the more points their class earns.</p>
                            <div class="hwpCardEditArea" style="display:none;margin-top:8px">
                                <input type="text" class="hwpCardTitleInput" data-idx="3" placeholder="Card title" style="width:100%;padding:5px 8px;border:1px solid #e8722a;border-radius:4px;font-size:12px;margin-bottom:5px">
                                <textarea class="hwpCardBodyInput" data-idx="3" rows="3" placeholder="Card body text" style="width:100%;padding:5px 8px;border:1px solid #e8722a;border-radius:4px;font-size:12px;resize:vertical"></textarea>
                            </div>
                        </div>

                        <div style="background:#e8eaf6;border-radius:10px;padding:15px;border-top:4px solid #3949ab" data-hwp-card="4">
                            <div style="display:flex;align-items:center;gap:8px;margin-bottom:7px"><span style="font-size:1.3em">ðŸ§©</span><strong id="hwpCard4Title" style="color:#1a237e;font-size:0.9em">Speed Slide Challenge</strong></div>
                            <p id="hwpCard4Body" style="margin:0;color:#555;font-size:12.5px;line-height:1.6">Students solve a sliding puzzle and earn points based on <strong>speed &amp; difficulty</strong>. Every <strong>approved submission</strong> adds to the class total â€” so the more students from a class who play and get approved, the higher their class climbs.</p>
                            <div class="hwpCardEditArea" style="display:none;margin-top:8px">
                                <input type="text" class="hwpCardTitleInput" data-idx="4" placeholder="Card title" style="width:100%;padding:5px 8px;border:1px solid #3949ab;border-radius:4px;font-size:12px;margin-bottom:5px">
                                <textarea class="hwpCardBodyInput" data-idx="4" rows="3" placeholder="Card body text" style="width:100%;padding:5px 8px;border:1px solid #3949ab;border-radius:4px;font-size:12px;resize:vertical"></textarea>
                            </div>
                        </div>

                        <div style="background:#e0f7fa;border-radius:10px;padding:15px;border-top:4px solid #17a2b8" data-hwp-card="5">
                            <div style="display:flex;align-items:center;gap:8px;margin-bottom:7px"><span style="font-size:1.3em">âœ¨</span><strong id="hwpCard5Title" style="color:#0c5460;font-size:0.9em">Special / Custom Criteria</strong></div>
                            <p id="hwpCard5Body" style="margin:0;color:#555;font-size:12.5px;line-height:1.6">The Super Admin may add bonus points for criteria like discipline, attendance, best decorated class, or other special achievements.</p>
                            <div class="hwpCardEditArea" style="display:none;margin-top:8px">
                                <input type="text" class="hwpCardTitleInput" data-idx="5" placeholder="Card title" style="width:100%;padding:5px 8px;border:1px solid #17a2b8;border-radius:4px;font-size:12px;margin-bottom:5px">
                                <textarea class="hwpCardBodyInput" data-idx="5" rows="3" placeholder="Card body text" style="width:100%;padding:5px 8px;border:1px solid #17a2b8;border-radius:4px;font-size:12px;resize:vertical"></textarea>
                            </div>
                        </div>

                    </div>

                    <!-- Steps â€” editable -->
                    <h4 style="color:#1a0030;font-size:1em;margin:0 0 12px;display:flex;align-items:center;gap:8px">
                        <span style="background:linear-gradient(135deg,#6a1b9a,#c44569);color:white;border-radius:50%;width:24px;height:24px;display:inline-flex;align-items:center;justify-content:center;font-size:11px;flex-shrink:0;font-weight:700">2</span>
                        How the Super Admin Publishes Results
                    </h4>
                    <div id="hwpStepsGrid" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:10px;margin-bottom:22px">
                        <!-- Steps rendered by JS from Firebase / defaults -->
                    </div>

                    <!-- Important notes â€” editable textarea -->
                    <div style="background:#fff8e1;border-radius:10px;padding:15px 18px;border-left:4px solid #ffc107;margin-bottom:20px">
                        <h5 style="color:#856404;margin:0 0 8px;font-size:0.9em">âš ï¸ Important Notes</h5>
                        <div id="hwpNotesView">
                            <ul id="hwpNotesList" style="margin:0;padding-left:16px;color:#555;font-size:13px;line-height:1.9">
                                <li>Only the <strong>Super Admin</strong> can publish or hide the leaderboard.</li>
                                <li>All point calculations are <strong>fully automatic</strong> â€” no manual tampering.</li>
                                <li>For individual events (e.g. Hand Writing, Pod Casting), each class is represented by their <strong>best-scoring student</strong>. For multi-team events (e.g. Vlog), each class is represented by their <strong>best-scoring team</strong>.</li>
                                <li>The leaderboard refreshes every <strong>60 seconds</strong> once live.</li>
                                <li>Rankings may be updated progressively as more results are published.</li>
                            </ul>
                        </div>
                        <div id="hwpNotesEdit" style="display:none;margin-top:8px">
                            <label style="font-size:11px;color:#856404;font-weight:700;display:block;margin-bottom:5px">One note per line:</label>
                            <textarea id="hwpNotesInput" rows="5" style="width:100%;padding:8px 12px;border:2px solid #ffc107;border-radius:6px;font-size:13px;line-height:1.7;resize:vertical;outline:none"></textarea>
                        </div>
                    </div>

                    <!-- Footer -->
                    <div style="text-align:center;padding-top:14px;border-top:1px solid #f0e6ff">
                        <p style="margin:0;color:#999;font-size:11.5px">
                            ðŸŽ“ <strong style="color:#6a1b9a">Spurthi Youth Fest 2026</strong> Â· Davan Institute of Advanced Management Studies, Davangere<br>
                            <span style="font-size:10.5px">Platform by Harsha Gujjar, Director â€” Davan College</span>
                        </p>
                    </div>

                </div>
            </div><!-- /hwp white -->
                </div><!-- /accHowWePublish body -->
            </div><!-- /accHowWePublish accordion -->
        </div>
        <div id="lbPublicBody" style="display:none">
        <div class="lb-body">

            <!-- Scoring Legend -->
            <div class="lb-legend">
                <span class="lb-legend-title">ðŸ“Š Scoring:</span>
                <span class="lb-legend-item">
                    <span class="lb-legend-dot" style="background:#ffc107"></span>
                    Youthfest Reg: pts/event enrolled
                </span>
                <span class="lb-legend-item">
                    <span class="lb-legend-dot" style="background:#28a745"></span>
                    Quiz: winner/runner-up bonus + participation rate
                </span>
                <span class="lb-legend-item">
                    <span class="lb-legend-dot" style="background:#6a1b9a"></span>
                    ðŸ† Event Results: winner/runner-up pts
                </span>
                <span class="lb-legend-item">
                    <span class="lb-legend-dot" style="background:#17a2b8"></span>
                    âœ¨ Special criteria pts
                </span>
                <button class="lb-refresh-btn" onclick="loadLeaderboard()">ðŸ”„ Refresh</button>
            </div>

            <!-- Podium Top 3 -->
            <div class="lb-podium-section">
                <div class="lb-podium-title">ðŸ… Top 3 Classes</div>
                <div class="lb-podium" id="lbPodium">
                    <div class="lb-loading">
                        <div class="lb-loading-spinner"></div>
                        Loading rankingsâ€¦
                    </div>
                </div>
            </div>

            <!-- Full Rankings Table -->
            <div class="lb-table-section">
                <div class="lb-table-header">ðŸ“‹ Full Rankings</div>
                <div class="lb-table-wrap">
                    <table class="lb-table">
                        <thead>
                            <tr>
                                <th>Rank</th>
                                <th>Class</th>
                                <th>ðŸŽ¤ YF Reg</th>
                                <th>ðŸ§  Quiz</th>
                                <th>ðŸ† Results</th>
                                <th>ðŸ—ºï¸ Hunt</th>
                                <th>ðŸ§© Slide</th>
                                <th>Total</th>
                                <th>Progress</th>
                            </tr>
                        </thead>
                        <tbody id="lbTableBody">
                            <tr>
                                <td colspan="7" style="text-align:center;padding:40px;color:#bbb">
                                    <div class="lb-loading-spinner" style="margin:0 auto 10px"></div>
                                    Loadingâ€¦
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <div class="lb-last-updated" id="lbLastUpdated">Fetching live dataâ€¦</div>
            </div>


        </div>
        </div><!-- /lbPublicBody -->
    </div><!-- /lb-section -->

    <script>
    // ============================================================
    //  CLASS OF THE YEAR 2026 â€” LEADERBOARD ENGINE
    //  db is resolved via getDb() helper â€” safe across all script blocks

    // -- Safe Firebase db getter (works across separate <script> blocks) --
    function getDb() {
        if (window.db) return window.db;
        if (typeof db !== 'undefined' && db) return db;
        throw new Error("Firebase not initialised yet. Please wait and try again.");
    }

    //  Points:
    //    Youthfest Registration â†’ 10 pts per event a class enrolled in
    //    Online Quiz            â†’ 5 pts per correct answer per student per day
    // ============================================================

    // Star decoration in header
    (function spawnStars() {
        const container = document.getElementById('lbStars');
        if (!container) return;
        const symbols = ['âœ¦','âœ§','â‹†','â˜…','âœ©'];
        for (let i = 0; i < 18; i++) {
            const s = document.createElement('span');
            s.className = 'lb-star';
            s.textContent = symbols[Math.floor(Math.random() * symbols.length)];
            s.style.top  = Math.random() * 100 + '%';
            s.style.left = Math.random() * 100 + '%';
            s.style.animationDelay = (Math.random() * 3) + 's';
            s.style.fontSize = (0.7 + Math.random() * 1.2) + 'em';
            container.appendChild(s);
        }
    })();
    // ============================================================
    //  LEADERBOARD ENGINE v3 â€” FINAL
    //  Sources:
    //  1. Youthfest Registration  â†’ yfPtsPerEvent per event enrolled
    //  2. Quiz (per PUBLISHED day only):
    //       a) Winner class       â†’ quizWinnerPts (flat)
    //       b) Runner-up class    â†’ quizRunnerUpPts (flat)
    //       c) Participation rate â†’ (studentsWithMaxScore / classStrength) Ã— quizMaxPts
    //          â€” fair across classes of different sizes
    //  3. Youthfest event results â†’ winnerPts / runnerUpPts (jury published)
    //  4. Custom criteria         â†’ manual points from Super Admin
    //  Leaderboard itself hidden until Super Admin publishes it
    //  Config: leaderboardConfig/scoring | classStrengths | published | customCriteria
    // ============================================================

    const LB_CLASSES = [
        '1st B.Com','2nd B.Com','3rd B.Com',
        '1ST BCA','2ND BCA A SEC','2ND BCA B SEC',
        '3RD BCA A SEC','3RD BCA B SEC','3RD BCA C SEC',
        '2ND BBA','3RD BBA'
    ];

    let lbCfg = {
        yfPtsPerEvent: 10, winnerPts: 50, runnerUpPts: 30,
        quizWinnerPts: 20, quizRunnerUpPts: 10, quizMaxPts: 10,
        shWinnerPts: 30, shRunnerUpPts: 15, shTaskPts: 5, shCompletePts: 20
    };
    let lbClassStrengths = {}; // cls â†’ number of students

    async function getLbConfig() {
        try {
            const [cfgSnap, strSnap] = await Promise.all([
                getDb().ref('leaderboardConfig/scoring').once('value'),
                getDb().ref('leaderboardConfig/classStrengths').once('value')
            ]);
            if (cfgSnap.exists()) {
                const d = cfgSnap.val();
                lbCfg = {
                    yfPtsPerEvent:   d.yfPtsPerEvent   || 10,
                    winnerPts:       d.winnerPts        || 50,
                    runnerUpPts:     d.runnerUpPts      || 30,
                    quizWinnerPts:   d.quizWinnerPts    || 20,
                    quizRunnerUpPts: d.quizRunnerUpPts  || 10,
                    quizMaxPts:      d.quizMaxPts       || 10,
                    shWinnerPts:     d.shWinnerPts      || 30,
                    shRunnerUpPts:   d.shRunnerUpPts    || 15,
                    shTaskPts:       d.shTaskPts        || 5,
                    shCompletePts:   d.shCompletePts    || 20
                };
            }
            if (strSnap.exists()) {
                lbClassStrengths = strSnap.val() || {};
            }
        } catch(e) {}
        return lbCfg;
    }

    // -- Check publish status and show/hide leaderboard ----------
    async function checkLbPublished() {
        try {
            const snap = await getDb().ref('leaderboardConfig/published').once('value');
            const pub = snap.val() === true;
            document.getElementById('lbPublicBody').style.display  = pub ? 'block' : 'none';
            document.getElementById('lbHiddenMsg').style.display   = pub ? 'none'  : 'block';
            return pub;
        } catch(e) {
            document.getElementById('lbHiddenMsg').style.display = 'block';
            return false;
        }
    }

    async function loadLeaderboard() {
        const pub = await checkLbPublished();
        if (!pub) return; // don't fetch data if not published

        try {
            const cfg = await getLbConfig();
            const init = () => { const o = {}; LB_CLASSES.forEach(c => o[c] = 0); return o; };

            const yfPts     = init();
            const quizPts   = init();
            const resultPts = init();
            const customPts = init();

            // -- 1. Youthfest Registration --------------------------
            const yfSnap = await getDb().ref('youthfest-enrollments').once('value');
            if (yfSnap.exists()) {
                yfSnap.forEach(child => {
                    const d   = child.val();
                    const cls = d.classYear || d.class || '';
                    if (yfPts[cls] !== undefined) yfPts[cls] += cfg.yfPtsPerEvent;
                });
            }

            // -- 2. Quiz Points (PUBLISHED DAYS ONLY) -------------
            // Criteria:
            //   a) Flat bonus to winner's class
            //   b) Flat bonus to runner-up's class
            //   c) Participation-rate bonus â€” fair across class sizes:
            //      count how many students in the class scored max (2/2)
            //      divide by class strength â†’ multiply by quizMaxPts
            //      if strength not set, falls back to raw max-correct Ã— pts

            const quizResultsSnap = await getDb().ref('quizResults').once('value');
            const publishedDates    = new Set();
            const quizWinnersByDate = {};

            if (quizResultsSnap.exists()) {
                quizResultsSnap.forEach(dateNode => {
                    const res = dateNode.val();
                    if (res && res.winner && res.runnerUp) {
                        publishedDates.add(dateNode.key);
                        quizWinnersByDate[dateNode.key] = {
                            winnerClass: res.winner.class  || '',
                            runnerClass: res.runnerUp.class || ''
                        };
                    }
                });
            }

            if (publishedDates.size > 0) {
                const quizSubSnap = await getDb().ref('quizSubmissions').once('value');
                if (quizSubSnap.exists()) {
                    quizSubSnap.forEach(dateNode => {
                        const date = dateNode.key;
                        if (!publishedDates.has(date)) return;

                        const w = quizWinnersByDate[date];

                        // a) Winner class bonus
                        if (w.winnerClass && quizPts[w.winnerClass] !== undefined)
                            quizPts[w.winnerClass] += cfg.quizWinnerPts;

                        // b) Runner-up class bonus
                        if (w.runnerClass && quizPts[w.runnerClass] !== undefined)
                            quizPts[w.runnerClass] += cfg.quizRunnerUpPts;

                        // c) Participation-rate bonus per class
                        // Count students who scored the maximum (2/2) per class
                        const classMaxCount  = {}; // how many got max score
                        const classAnyCount  = {}; // how many attempted at all
                        const maxPossible    = 2;  // quiz has 2 questions

                        dateNode.forEach(subNode => {
                            const s  = subNode.val();
                            const cl = s.studentClass || '';
                            if (!LB_CLASSES.includes(cl)) return;
                            classAnyCount[cl]  = (classAnyCount[cl]  || 0) + 1;
                            if ((parseInt(s.score) || 0) >= maxPossible)
                                classMaxCount[cl] = (classMaxCount[cl] || 0) + 1;
                        });

                        LB_CLASSES.forEach(cl => {
                            if (!classAnyCount[cl]) return; // class didn't play
                            const strength = lbClassStrengths[cl.replace(/[.\[\]#$\/]/g,'_')]
                                          || lbClassStrengths[cl]
                                          || 0;
                            const topCount = classMaxCount[cl] || 0;
                            let bonus = 0;
                            if (strength > 0) {
                                // Fair formula: (top scorers / class size) Ã— max pts
                                bonus = Math.round((topCount / strength) * cfg.quizMaxPts * 10) / 10;
                            } else {
                                // Fallback if strength not set: just use topCount Ã— 1
                                bonus = topCount;
                            }
                            if (quizPts[cl] !== undefined) quizPts[cl] += bonus;
                        });
                    });
                }
            }

            // -- 3. Published Youthfest Event Results --------------
            // Class-based events: winner class = highest total â†’ gets winnerPts
            // Individual events:  jury marks rows are CLASS__pN keys; we group by origclass,
            //                     take the best score per class, then rank classes by that best score.
            //                     Winner class + runner-up class get points (same class can get both).
            const setupSnap = await getDb().ref('jurySetup').once('value');
            if (setupSnap.exists()) {
                for (const [evName, setup] of Object.entries(setupSnap.val())) {
                    if (!setup.resultsPublished) continue;
                    const mSnap = await getDb().ref('juryMarks/' + evName).once('value');
                    if (!mSnap.exists()) continue;

                    const isIndividual  = (setup.eventType === 'individual');
                    const isMultiteam   = (setup.eventType === 'multiteam');
                    const isVlogEvent   = (evName === 'Vlog');
                    const j1 = mSnap.val().jury1 || {}, j2 = mSnap.val().jury2 || {};
                    const allK = new Set([...Object.keys(j1), ...Object.keys(j2)]);

                    // For Vlog: load social scores keyed by rowKey
                    let vlogSocialByRow = {};
                    if (isVlogEvent) {
                        const [vlogSnap2, enrSnap2] = await Promise.all([
                            getDb().ref('vlogChallenge').once('value'),
                            getDb().ref('youthfest-enrollments').orderByChild('event').equalTo('Vlog').once('value')
                        ]);
                        const topicSocial2 = {};
                        if (vlogSnap2.exists()) vlogSnap2.forEach(ch => {
                            const v = ch.val();
                            topicSocial2[(v.classYear||'')+'__'+(v.topic||'')] = v.socialScore || 0;
                        });
                        if (enrSnap2.exists()) {
                            const enrollByClass2 = {};
                            enrSnap2.forEach(ch => {
                                const e = ch.val();
                                if (!enrollByClass2[e.classYear]) enrollByClass2[e.classYear] = [];
                                enrollByClass2[e.classYear].push(e);
                            });
                            Object.entries(enrollByClass2).forEach(([cls, members]) => {
                                const safeKey2 = cls.replace(/[.\[\]#$\/\s]/g,'_');
                                const tMap2 = {};
                                members.forEach((m,idx) => {
                                    let tk;
                                    if (m.teamNum!==undefined&&m.teamNum!==null) tk=String(m.teamNum);
                                    else if (m.topic) tk='topic__'+m.topic;
                                    else tk=String(Math.floor(idx/2)+1);
                                    if (!tMap2[tk]) tMap2[tk] = m;
                                });
                                Object.keys(tMap2).sort((a,b)=>{const na=Number(a),nb=Number(b);return(isNaN(na)||isNaN(nb))?a.localeCompare(b):na-nb;}).forEach((tk,ti) => {
                                    const m = tMap2[tk];
                                    const rk = safeKey2+'__t'+(ti+1);
                                    vlogSocialByRow[rk] = topicSocial2[cls+'__'+(m.topic||'')] || 0;
                                });
                            });
                        }
                    }

                    if (isIndividual || isMultiteam) {
                        const bestPerClass = {};
                        allK.forEach(sk => {
                            const d1 = j1[sk], d2 = j2[sk];
                            let cls = (d1 && d1.originalClassName) || (d2 && d2.originalClassName) || '';
                            if (!cls) {
                                const match = sk.match(/^(.+?)__[pt]\d+$/);
                                if (match) {
                                    const sanitisedPrefix = match[1];
                                    cls = LB_CLASSES.find(c => c.replace(/[.\[\]#$\/\s]/g,'_') === sanitisedPrefix) || sanitisedPrefix;
                                } else {
                                    cls = sk;
                                }
                            }
                            let t1=0, t2=0;
                            if(d1&&d1.marks)(Array.isArray(d1.marks)?d1.marks:Object.values(d1.marks)).forEach(m=>t1+=(m||0));
                            if(d2&&d2.marks)(Array.isArray(d2.marks)?d2.marks:Object.values(d2.marks)).forEach(m=>t2+=(m||0));
                            const juryAvg = (t1 + t2) / 2;
                            // For Vlog: apply Final % = (juryAvg/50 Ã— 50%) + (socialScore/1000 Ã— 50%)
                            let score = juryAvg;
                            if (isVlogEvent) {
                                const soc = vlogSocialByRow[sk] || 0;
                                score = (juryAvg / 50 * 50) + Math.min(50, soc / 1000 * 50);
                            }
                            if (bestPerClass[cls] === undefined || score > bestPerClass[cls]) {
                                bestPerClass[cls] = score;
                            }
                        });
                        const evRes = Object.entries(bestPerClass).map(([cls, best]) => ({cls, avg: best}));
                        evRes.sort((a,b) => b.avg - a.avg);
                        if (evRes[0] && resultPts[evRes[0].cls] !== undefined) resultPts[evRes[0].cls] += cfg.winnerPts;
                        if (evRes[1] && resultPts[evRes[1].cls] !== undefined) resultPts[evRes[1].cls] += cfg.runnerUpPts;
                        if (evRes[0] && evRes[1] && evRes[0].cls === evRes[1].cls && resultPts[evRes[0].cls] !== undefined) {
                            resultPts[evRes[0].cls] += cfg.runnerUpPts;
                        }
                    } else {
                        const evRes = [];
                        allK.forEach(sk => {
                            const d1=j1[sk], d2=j2[sk];
                            const cls=(d1&&d1.originalClassName)||(d2&&d2.originalClassName)||sk;
                            let t1=0,t2=0;
                            if(d1&&d1.marks)(Array.isArray(d1.marks)?d1.marks:Object.values(d1.marks)).forEach(m=>t1+=(m||0));
                            if(d2&&d2.marks)(Array.isArray(d2.marks)?d2.marks:Object.values(d2.marks)).forEach(m=>t2+=(m||0));
                            evRes.push({cls,avg:(t1+t2)/2});
                        });
                        evRes.sort((a,b)=>b.avg-a.avg);
                        if(evRes[0]&&resultPts[evRes[0].cls]!==undefined) resultPts[evRes[0].cls]+=cfg.winnerPts;
                        if(evRes[1]&&resultPts[evRes[1].cls]!==undefined) resultPts[evRes[1].cls]+=cfg.runnerUpPts;
                    }
                }
            }

            // -- 4. Custom Criteria ---------------------------------
            const customSnap = await getDb().ref('leaderboardConfig/customCriteria').once('value');
            if (customSnap.exists()) {
                customSnap.forEach(critNode => {
                    const crit = critNode.val();
                    if (!crit || !crit.points) return;
                    Object.keys(crit.points).forEach(k => {
                        LB_CLASSES.forEach(cls => {
                            if (cls.replace(/[.\[\]#$\/]/g,'_') === k && customPts[cls] !== undefined)
                                customPts[cls] += (crit.points[k] || 0);
                        });
                    });
                });
            }

            // -- 5. Scavenger Hunt Points ---------------------------
            const shPts = init();
            try {
                const [shSubSnap, shTaskSnap, shWinSnap] = await Promise.all([
                    getDb().ref('scavengerHunt/submissions').once('value'),
                    getDb().ref('scavengerHunt/tasks').once('value'),
                    getDb().ref('scavengerHunt/winner').once('value')
                ]);
                const shSubs  = shSubSnap.val()  || {};
                const shTasks = shTaskSnap.val() || {};
                const totalTasks = Object.keys(shTasks).length;
                const shWinner = shWinSnap.val() || null;

                // Per-student: task pts + completion bonus
                Object.values(shSubs).forEach(ss => {
                    const first = Object.values(ss)[0] || {};
                    const cls = first.studentClass || '';
                    if (shPts[cls] === undefined) return;
                    let approved = 0;
                    Object.values(ss).forEach(sub => { if (sub.status === 'approved') approved++; });
                    shPts[cls] += approved * cfg.shTaskPts;
                    if (totalTasks > 0 && approved >= totalTasks) shPts[cls] += cfg.shCompletePts;
                });

                // Winner / runner-up class bonus
                if (shWinner) {
                    const wCls  = shWinner.winner   ? shWinner.winner.cls   : '';
                    const ruCls = shWinner.runnerUp ? shWinner.runnerUp.cls : '';
                    if (wCls  && shPts[wCls]  !== undefined) shPts[wCls]  += cfg.shWinnerPts;
                    if (ruCls && shPts[ruCls] !== undefined) shPts[ruCls] += cfg.shRunnerUpPts;
                }
            } catch(e) { console.warn('SH points error:', e); }

            // -- 6. Speed Slide Challenge Points -----------------------
            const sscPts = init();
            try {
                const sscSnap = await getDb().ref('speedSlide/submissions').once('value');
                if (sscSnap.exists()) {
                    // ALL approved submissions add to class total (not just best)
                    sscSnap.forEach(child => {
                        const s = child.val();
                        if (!s || !s.class || s.points === undefined) return;
                        if (s.status !== 'approved') return;
                        if (sscPts[s.class] !== undefined)
                            sscPts[s.class] += Math.floor(s.points / 10) * (cfg.sscScoreFactor || 1);
                    });
                }
            } catch(e) { console.warn('SSC points error:', e); }

            // -- 7. Merge, sort, render -----------------------------
            const ranked = LB_CLASSES.map(cls => {
                const total=(yfPts[cls]||0)+(quizPts[cls]||0)+(resultPts[cls]||0)+(customPts[cls]||0)+(shPts[cls]||0)+(sscPts[cls]||0);
                return {cls,yfPts:yfPts[cls]||0,quizPts:quizPts[cls]||0,resultPts:resultPts[cls]||0,customPts:customPts[cls]||0,shPts:shPts[cls]||0,sscPts:sscPts[cls]||0,total};
            }).sort((a,b)=>b.total-a.total||b.yfPts-a.yfPts||b.quizPts-a.quizPts);

            const maxTotal = ranked[0]?.total || 1;
            renderPodium(ranked.slice(0,3));
            renderTable(ranked, maxTotal);

            const now = new Date();
            document.getElementById('lbLastUpdated').textContent =
                'â± Last updated: ' + now.toLocaleTimeString('en-IN',{hour:'2-digit',minute:'2-digit',second:'2-digit'})
                + ' Â· Quiz: ' + publishedDates.size + ' day' + (publishedDates.size!==1?'s':'')+' counted';

        } catch (err) {
            console.error('Leaderboard error:', err);
            document.getElementById('lbPodium').innerHTML='<div class="lb-empty">âš ï¸ Could not load data. Please refresh.</div>';
            document.getElementById('lbTableBody').innerHTML='<tr><td colspan="9" class="lb-empty">âš ï¸ Could not load data.</td></tr>';
        }
    }

    function medalEmoji(rank) { return ['ðŸ¥‡','ðŸ¥ˆ','ðŸ¥‰'][rank]||''; }
    function podiumEmoji(rank) { return ['1ï¸âƒ£','2ï¸âƒ£','3ï¸âƒ£'][rank]||''; }

    function renderPodium(top3) {
        const podium = document.getElementById('lbPodium');
        if (!top3||top3.length===0||top3[0].total===0) {
            podium.innerHTML='<div class="lb-empty">No scores yet. Scores will appear once events begin! ðŸŽ‰</div>';
            return;
        }
        const order=[top3[1],top3[0],top3[2]].filter(Boolean);
        const posClass=['lb-pos-2','lb-pos-1','lb-pos-3'];
        const actualRank=[2,1,3];
        let html='';
        order.forEach((entry,i)=>{
            const rank=actualRank[i], isFirst=rank===1;
            html+=`<div class="lb-podium-slot ${posClass[i]}">
                <div class="lb-podium-name">${isFirst?'ðŸ‘‘ ':''}${entry.cls}</div>
                <div class="lb-podium-score">${entry.total} pts</div>
                <div class="lb-podium-block">${podiumEmoji(rank-1)}</div>
            </div>`;
        });
        podium.innerHTML=html;
    }

    function renderTable(ranked, maxTotal) {
        const tbody=document.getElementById('lbTableBody');
        if(!ranked||ranked.length===0){tbody.innerHTML='<tr><td colspan="9" class="lb-empty">No data yet!</td></tr>';return;}
        let html='';
        ranked.forEach((entry,i)=>{
            const rank=i+1;
            const rankClass=rank<=3?`lb-rank-${rank}`:'lb-rank-other';
            const rankMedal=rank<=3?medalEmoji(rank-1):rank;
            const barPct=maxTotal>0?Math.round((entry.total/maxTotal)*100):0;
            const delay=(i*0.05).toFixed(2);
            const rowBg=rank===1?'background:linear-gradient(90deg,#fffbea,#fff);':rank===2?'background:linear-gradient(90deg,#f8f8f8,#fff);':rank===3?'background:linear-gradient(90deg,#fff5f0,#fff);':'';
            const resBadge=entry.resultPts>0?`<span class="lb-score-tag" style="background:#d4edda;color:#155724;border:1px solid #28a745">ðŸ† ${entry.resultPts}</span> `:'';
            const custBadge=entry.customPts>0?`<span class="lb-score-tag" style="background:#e8f4fd;color:#0c5460;border:1px solid #17a2b8">âœ¨ ${entry.customPts}</span>`:'';
            const shBadge=entry.shPts>0?`<span class="lb-score-tag" style="background:#f3e5f5;color:#6a1b9a;border:1px solid #ce93d8">ðŸ—ºï¸ ${entry.shPts}</span>`:'<span style="color:#ddd">â€”</span>';
            const sscBadge=entry.sscPts>0?`<span class="lb-score-tag" style="background:#e3f2fd;color:#0d47a1;border:1px solid #90caf9">ðŸ§© ${entry.sscPts}</span>`:'<span style="color:#ddd">â€”</span>';
            html+=`<tr style="${rowBg}animation-delay:${delay}s">
                <td><span class="lb-rank-badge ${rankClass}">${rankMedal}</span></td>
                <td><span class="lb-class-chip">${entry.cls}</span></td>
                <td><span class="lb-score-tag lb-score-yf">ðŸŽ¤ ${entry.yfPts}</span></td>
                <td><span class="lb-score-tag lb-score-quiz">ðŸ§  ${entry.quizPts}</span></td>
                <td>${resBadge}${custBadge}${(entry.resultPts===0&&entry.customPts===0)?'<span style="color:#ddd">â€”</span>':''}</td>
                <td>${shBadge}</td>
                <td>${sscBadge}</td>
                <td><span class="lb-pts-total">${entry.total}</span> <span class="lb-pts-event">pts</span></td>
                <td><div class="lb-bar-wrap"><div class="lb-bar-fill" style="width:${barPct}%"></div></div></td>
            </tr>`;
        });
        tbody.innerHTML=html;
    }

    // ============================================================
    //  ACTIVITY BANNERS ENGINE
    //  Shows live banners for: Quiz (if available today),
    //  Scavenger Hunt (active tasks today), Speed Slide, 
    //  and a "coming soon" banner for Speed Slide.
    //  Renders into #activityBannersContainer on page load.
    // ============================================================

    async function initActivityBanners() {
        const container = document.getElementById('activityBannersContainer');
        if (!container) return;

        // -- helper: today string ----------------------------------
        const todayISO = (function() {
            const d = new Date();
            return d.getFullYear() + '-' + String(d.getMonth()+1).padStart(2,'0') + '-' + String(d.getDate()).padStart(2,'0');
        })();
        const todayFmt = new Date(todayISO + 'T00:00:00').toLocaleDateString('en-IN',{weekday:'long',day:'2-digit',month:'long',year:'numeric'});
        const nowMs = Date.now();

        let html = '';

        // -- 1. QUIZ BANNER (only if today has questions) ---------
        try {
            const qSnap = await db.ref('quizQuestions/' + todayISO).once('value');
            if (qSnap.exists()) {
                html += `
                <div class="act-banner-wrap" id="actQuizBanner"
                     style="background:linear-gradient(135deg,#1a6b2a 0%,#28a745 55%,#20c997 100%);
                            animation-delay:.05s;margin-bottom:12px;">
                    <div class="act-banner-icon" style="animation-delay:.2s">ðŸ†</div>
                    <div class="act-banner-body">
                        <div class="act-banner-title" style="color:white">
                            <span class="live-dot" style="background:#ffe082;box-shadow:0 0 6px #ffe082"></span>
                            Today's Quiz is Available!
                        </div>
                        <div class="act-banner-sub" style="color:rgba(255,255,255,.92)">
                            ðŸ“… ${todayFmt} &nbsp;Â·&nbsp; âš¡ Be the fastest to answer correctly!
                        </div>
                        <div class="quiz-cdown-chip">
                            â³ Quiz ends in: <span id="actQuizCountdown">--:--:--</span>
                            <span style="opacity:.7;font-size:.82em;font-weight:600">(closes at 11:59 PM today)</span>
                        </div>
                    </div>
                    <button class="act-banner-cta"
                            style="background:#ffe082;color:#1a5e20;"
                            onclick="document.getElementById('competitionType').value='dailyquiz';handleCompetitionChange();document.getElementById('userType').value='';handleUserTypeChange();setTimeout(()=>{const el=document.getElementById('quizLoginPhone');if(el){el.scrollIntoView({behavior:'smooth',block:'center'});el.focus();}},100)">
                        ðŸš€ Play Now
                    </button>
                </div>`;
            }
        } catch(e) { console.warn('actBanner quiz check:', e.message); }

        // -- 2. SCAVENGER HUNT BANNER (active tasks today) --------
        try {
            const shSnap = await db.ref('scavengerHunt/tasks').once('value');
            if (shSnap.exists()) {
                const allTasks = Object.entries(shSnap.val() || {})
                    .map(([k,v]) => ({id:k,...v}))
                    .sort((a,b) => (a.order||0)-(b.order||0));

                // Tasks that are currently active (started, not yet expired)
                const activeTasks = allTasks.filter(t => {
                    const started  = !t.availableFrom || new Date(t.availableFrom).getTime() <= nowMs;
                    const notEnded = !t.deadline      || new Date(t.deadline).getTime()      >  nowMs;
                    return started && notEnded;
                });

                // Tasks unlocking today (announcements)
                const todayTasks = allTasks.filter(t => {
                    if (!t.availableFrom) return false;
                    const d = new Date(t.availableFrom);
                    return d.getFullYear()  === new Date().getFullYear()  &&
                           d.getMonth()     === new Date().getMonth()     &&
                           d.getDate()      === new Date().getDate();
                });

                if (activeTasks.length > 0) {
                    const taskPills = activeTasks.slice(0,10).map(t =>
                        `<span class="sh-task-pill">ðŸŽ¯ Task ${t.order||'?'}: ${t.name.length>28?t.name.slice(0,26)+'â€¦':t.name}</span>`
                    ).join('');

                    const newToday = todayTasks.length > 0
                        ? `<div style="margin-top:6px;font-size:.82em;color:#ffe082;font-weight:700">ðŸ†• ${todayTasks.length} new task${todayTasks.length>1?'s':''} just unlocked today!</div>`
                        : '';

                    html += `
                    <div class="act-banner-wrap" id="actShBanner"
                         style="background:linear-gradient(135deg,#4a148c 0%,#6a1b9a 50%,#c44569 100%);
                                animation-delay:.15s;margin-bottom:12px;animation:glowPurple 3s ease-in-out infinite,slideInUp .45s ease-out both;">
                        <div class="act-banner-icon" style="animation-delay:.4s">ðŸ—ºï¸</div>
                        <div class="act-banner-body">
                            <div class="act-banner-title" style="color:white">
                                <span class="live-dot" style="background:#ff4081;box-shadow:0 0 6px #ff4081"></span>
                                Scavenger Hunt is Live!
                            </div>
                            <div class="act-banner-sub" style="color:rgba(255,255,255,.9)">
                                ${activeTasks.length} active task${activeTasks.length>1?'s':''} waiting for you â€” find, photo &amp; win!
                            </div>
                            <div style="margin-top:7px">${taskPills}</div>
                            ${newToday}
                        </div>
                        <button class="act-banner-cta"
                                style="background:#ffe082;color:#4a148c;"
                                onclick="document.getElementById('competitionType').value='scavengerhunt';handleCompetitionChange();document.getElementById('userType').value='';handleUserTypeChange();setTimeout(()=>{const el=document.getElementById('scavengerHuntLogin');if(el){el.scrollIntoView({behavior:'smooth',block:'center'});}},100)">
                            ðŸŽ¯ Hunt Now!
                        </button>
                    </div>`;
                }
            }
        } catch(e) { console.warn('actBanner SH check:', e.message); }

        // -- 3. SPEED SLIDE BANNER (ACTIVE NOW) --
        html += `
        <div class="act-banner-wrap" id="actSsBanner"
             style="background:linear-gradient(135deg,#e65100 0%,#f57c00 45%,#ffa000 100%);
                    animation-delay:.25s;margin-bottom:12px;animation:glowAmber 3s ease-in-out infinite,slideInUp .45s ease-out .25s both;">
            <div class="act-banner-icon" style="animation-delay:.6s">ðŸ§©</div>
            <div class="act-banner-body">
                <div class="act-banner-title" style="color:white">
                    <span class="live-dot" style="background:#ffe082;box-shadow:0 0 6px #ffe082"></span>
                    ðŸŽ¯ Speed Slide Challenge â€” Active Now!
                </div>
                <div class="act-banner-sub" style="color:rgba(255,255,255,.92)">
                    Race against classmates to reassemble a scrambled photo the fastest.<br>
                    <span style="color:#ffe082;font-weight:700">âš¡ Event is LIVE at Spurthi Youth Fest 2026 â€” Play now!</span>
                </div>
            </div>
            <button class="act-banner-cta"
                    style="background:#ffe082;color:#bf360c;"
                    onclick="document.getElementById('competitionType').value='speedslide';handleCompetitionChange();document.getElementById('userType').value='';handleUserTypeChange();setTimeout(()=>{const el=document.getElementById('speedSlideLogin');if(el){el.scrollIntoView({behavior:'smooth',block:'center'});}},100)">
                ðŸ§© Login Now
            </button>
        </div>`;

        container.innerHTML = html;

        // -- Start quiz countdown if banner was rendered -----------
        const cdownEl = document.getElementById('actQuizCountdown');
        if (cdownEl) {
            (function tickCdown() {
                const now2 = new Date(), end2 = new Date();
                end2.setHours(23, 59, 59, 0);
                const diff = end2 - now2;
                if (diff <= 0) { cdownEl.textContent = 'CLOSED'; cdownEl.style.color = '#ffcdd2'; return; }
                const h = Math.floor(diff/3600000), m = Math.floor((diff%3600000)/60000), s = Math.floor((diff%60000)/1000);
                cdownEl.textContent = String(h).padStart(2,'0')+':'+String(m).padStart(2,'0')+':'+String(s).padStart(2,'0');
                setTimeout(tickCdown, 1000);
            })();
        }
    }

    // -- Auto-init after Firebase is ready ------------------------
    (function waitForDbThenBanners() {
        function tryBanners() {
            if (typeof db !== 'undefined' && db) {
                initActivityBanners();
                initDynamicBanner();
                initFeedbackSystem();
            }
            else { setTimeout(tryBanners, 600); }
        }
        tryBanners();
    })();

    // -- Auto-load ------------------------------------------------
    (function lbInit() {
        function tryLoad() {
            if (typeof db !== 'undefined' && db) {
                loadLeaderboard();
                setInterval(loadLeaderboard, 60000);
            } else {
                setTimeout(tryLoad, 800);
            }
        }
        tryLoad();
    })();

    // ============================================================
    //  LEADERBOARD ADMIN PANEL FUNCTIONS (Super Admin only)
    // ============================================================

    async function toggleLeaderboardPublish() {
        const btn    = document.getElementById('lbPublishBtn');
        const status = document.getElementById('lbVisibilityStatus');
        try {
            const snap = await getDb().ref('leaderboardConfig/published').once('value');
            const current = snap.val() === true;
            const next = !current;
            await getDb().ref('leaderboardConfig/published').set(next);
            updateLbPublishUI(next);
            showLbAdminMsg(next
                ? 'âœ… Leaderboard is now LIVE â€” students can see it!'
                : 'ðŸ”’ Leaderboard hidden â€” students cannot see it.',
                next ? 'success' : 'error');
        } catch(err) {
            showLbAdminMsg('âŒ Error: ' + err.message, 'error');
        }
    }

    function updateLbPublishUI(isPublished) {
        const btn    = document.getElementById('lbPublishBtn');
        const status = document.getElementById('lbVisibilityStatus');
        if (!btn || !status) return;
        if (isPublished) {
            status.textContent = 'âœ… LIVE â€” Students can see it';
            status.style.color = '#69f0ae';
            btn.textContent    = 'ðŸ”’ Hide Leaderboard';
            btn.className      = 'btn btn-danger';
        } else {
            status.textContent = 'ðŸ”’ Hidden from students';
            status.style.color = '#ffd700';
            btn.textContent    = 'ðŸ“¢ Publish Leaderboard';
            btn.className      = 'btn btn-success';
        }
    }

    async function loadLbPublishStatus() {
        try {
            const snap = await getDb().ref('leaderboardConfig/published').once('value');
            updateLbPublishUI(snap.val() === true);
        } catch(e) {
            updateLbPublishUI(false);
        }
    }

    async function saveLbConfig() {
        const btn = document.querySelector('[onclick="saveLbConfig()"]');
        const okEl  = document.getElementById('lbCfgSaveMsg');
        const errEl = document.getElementById('lbCfgErrMsg');
        if (okEl)  okEl.style.display  = 'none';
        if (errEl) errEl.style.display = 'none';
        if (btn) { btn.disabled = true; btn.textContent = 'â³ Savingâ€¦'; }
        const yfPts   = parseInt(document.getElementById('lbCfgYfPts').value)      || 10;
        const winPts  = parseInt(document.getElementById('lbCfgWinPts').value)     || 50;
        const runPts  = parseInt(document.getElementById('lbCfgRunPts').value)     || 30;
        const qWin    = parseInt(document.getElementById('lbCfgQuizWinPts').value) || 20;
        const qRun    = parseInt(document.getElementById('lbCfgQuizRunPts').value) || 10;
        const qMax    = parseInt(document.getElementById('lbCfgQuizMaxPts').value) || 10;
        const shWin   = parseInt(document.getElementById('lbCfgShWinPts').value)   || 30;
        const shRun   = parseInt(document.getElementById('lbCfgShRunPts').value)   || 15;
        const shTask  = parseInt(document.getElementById('lbCfgShTaskPts').value)  || 5;
        const shComp  = parseInt(document.getElementById('lbCfgShCompletePts').value) || 20;
        const sscScore= parseInt(document.getElementById('lbCfgSscScorePts').value)|| 1;
        try {
            await getDb().ref('leaderboardConfig/scoring').set({
                yfPtsPerEvent: yfPts, winnerPts: winPts, runnerUpPts: runPts,
                quizWinnerPts: qWin, quizRunnerUpPts: qRun, quizMaxPts: qMax,
                shWinnerPts: shWin, shRunnerUpPts: shRun, shTaskPts: shTask, shCompletePts: shComp,
                sscScoreFactor: sscScore,
                updatedAt: new Date().toISOString()
            });
            document.getElementById('lbWinPtsDisplay').textContent = winPts;
            document.getElementById('lbRunPtsDisplay').textContent = runPts;
            if (okEl)  { okEl.style.display  = 'inline-block'; setTimeout(() => okEl.style.display  = 'none', 4000); }
            showLbAdminMsg('âœ… Config saved! Leaderboard refreshes in â‰¤60 s.', 'success');
        } catch(err) {
            if (errEl) { errEl.textContent = 'âŒ Error: ' + err.message; errEl.style.display = 'inline-block'; setTimeout(() => errEl.style.display = 'none', 6000); }
            showLbAdminMsg('âŒ Error: ' + err.message, 'error');
        } finally {
            if (btn) { btn.disabled = false; btn.textContent = 'ðŸ’¾ Save Config'; }
        }
    }

    async function loadLbConfigIntoForm() {
        await loadLbPublishStatus();
        try {
            const [cfgSnap, strSnap] = await Promise.all([
                getDb().ref('leaderboardConfig/scoring').once('value'),
                getDb().ref('leaderboardConfig/classStrengths').once('value')
            ]);
            if (cfgSnap.exists()) {
                const d = cfgSnap.val();
                document.getElementById('lbCfgYfPts').value       = d.yfPtsPerEvent   || 10;
                document.getElementById('lbCfgWinPts').value      = d.winnerPts        || 50;
                document.getElementById('lbCfgRunPts').value      = d.runnerUpPts      || 30;
                document.getElementById('lbCfgQuizWinPts').value  = d.quizWinnerPts    || 20;
                document.getElementById('lbCfgQuizRunPts').value  = d.quizRunnerUpPts  || 10;
                document.getElementById('lbCfgQuizMaxPts').value  = d.quizMaxPts       || 10;
                document.getElementById('lbWinPtsDisplay').textContent = d.winnerPts   || 50;
                document.getElementById('lbRunPtsDisplay').textContent = d.runnerUpPts || 30;
                if (document.getElementById('lbCfgShWinPts'))      document.getElementById('lbCfgShWinPts').value      = d.shWinnerPts   || 30;
                if (document.getElementById('lbCfgShRunPts'))      document.getElementById('lbCfgShRunPts').value      = d.shRunnerUpPts || 15;
                if (document.getElementById('lbCfgShTaskPts'))     document.getElementById('lbCfgShTaskPts').value     = d.shTaskPts     || 5;
                if (document.getElementById('lbCfgShCompletePts')) document.getElementById('lbCfgShCompletePts').value = d.shCompletePts || 20;
                if (document.getElementById('lbCfgSscScorePts'))   document.getElementById('lbCfgSscScorePts').value   = d.sscScoreFactor|| 1;
            }
            // Build class strength grid
            const savedStr = strSnap.exists() ? strSnap.val() : {};
            const grid = document.getElementById('lbClassStrengthGrid');
            if (grid) {
                let html = '';
                LB_CLASSES.forEach(cls => {
                    const safeKey = cls.replace(/[.\[\]#$\/]/g,'_');
                    const val = savedStr[safeKey] || savedStr[cls] || '';
                    const safeId = 'lbStr_' + cls.replace(/[^a-zA-Z0-9]/g,'_');
                    html += `<div style="display:flex;align-items:center;gap:6px;background:#f1f8e9;padding:7px 10px;border-radius:6px;border:1px solid #a5d6a7">
                        <span style="font-size:0.78em;color:#1b5e20;flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap" title="${cls}">${cls}</span>
                        <input type="number" id="${safeId}" value="${val}" min="1" max="200" placeholder="Count"
                            style="width:65px;padding:4px 6px;border:1px solid #a5d6a7;border-radius:4px;text-align:center;font-size:0.85em">
                    </div>`;
                });
                grid.innerHTML = html;
            }
        } catch(e) {
            console.error('loadLbConfigIntoForm error:', e);
            const grid = document.getElementById('lbClassStrengthGrid');
            if (grid) grid.innerHTML = '<p style="color:red;font-size:12px">âŒ Failed to load: ' + e.message + '</p>';
        }
    }

    async function saveLbClassStrengths() {
        const btn = document.querySelector('[onclick="saveLbClassStrengths()"]');
        const okEl  = document.getElementById('lbStrSaveMsg');
        const errEl = document.getElementById('lbStrErrMsg');
        if (okEl)  okEl.style.display  = 'none';
        if (errEl) errEl.style.display = 'none';
        if (btn) { btn.disabled = true; btn.textContent = 'â³ Savingâ€¦'; }
        const obj = {};
        LB_CLASSES.forEach(cls => {
            const safeId  = 'lbStr_' + cls.replace(/[^a-zA-Z0-9]/g,'_');
            const safeKey = cls.replace(/[.\[\]#$\/]/g,'_');
            const inp = document.getElementById(safeId);
            if (inp && inp.value) obj[safeKey] = parseInt(inp.value) || 0;
        });
        try {
            await getDb().ref('leaderboardConfig/classStrengths').set(obj);
            if (okEl)  { okEl.style.display  = 'inline-block'; setTimeout(() => okEl.style.display  = 'none', 4000); }
            showLbAdminMsg('âœ… Class strengths saved! Quiz participation rates updated.', 'success');
        } catch(err) {
            if (errEl) { errEl.textContent = 'âŒ ' + err.message; errEl.style.display = 'inline-block'; setTimeout(() => errEl.style.display = 'none', 6000); }
            showLbAdminMsg('âŒ Error: ' + err.message, 'error');
        } finally {
            if (btn) { btn.disabled = false; btn.textContent = 'ðŸ’¾ Save Class Strengths'; }
        }
    }

    async function loadLbPublishedResults() {
        const container = document.getElementById('lbPublishedResultsList');
        container.innerHTML = '<p style="color:#aaa;font-size:13px">Loadingâ€¦</p>';
        try {
            const cfg = await getLbConfig();
            const snap = await getDb().ref('jurySetup').once('value');
            if (!snap.exists()) {
                container.innerHTML = '<p style="color:#aaa;font-size:13px">No events set up yet.</p>';
                return;
            }
            let html = '<div class="table-wrapper"><table style="min-width:500px"><thead><tr><th>Event</th><th>Status</th><th>Winner Class</th><th>Runner-Up Class</th></tr></thead><tbody>';
            for (const [evName, setup] of Object.entries(snap.val())) {
                const pub = setup.resultsPublished ? 'âœ… Published' : 'â³ Not published';
                let winner='â€”', runnerUp='â€”';
                if (setup.resultsPublished) {
                    const mSnap = await getDb().ref('juryMarks/'+evName).once('value');
                    if (mSnap.exists()) {
                        const j1=mSnap.val().jury1||{}, j2=mSnap.val().jury2||{};
                        const allK=new Set([...Object.keys(j1),...Object.keys(j2)]);
                        const isIndividualOrMulti = (setup.eventType === 'individual' || setup.eventType === 'multiteam');
                        const isVlogEv = (evName === 'Vlog');

                        // For Vlog: build rowKeyâ†’socialScore map
                        let vlogSocLb = {};
                        if (isVlogEv) {
                            const [vs3, es3] = await Promise.all([
                                getDb().ref('vlogChallenge').once('value'),
                                getDb().ref('youthfest-enrollments').orderByChild('event').equalTo('Vlog').once('value')
                            ]);
                            const ts3 = {};
                            if (vs3.exists()) vs3.forEach(ch=>{ const v=ch.val(); ts3[(v.classYear||'')+'__'+(v.topic||'')]=v.socialScore||0; });
                            if (es3.exists()) {
                                const ec3 = {};
                                es3.forEach(ch=>{ const e=ch.val(); if(!ec3[e.classYear])ec3[e.classYear]=[]; ec3[e.classYear].push(e); });
                                Object.entries(ec3).forEach(([cls,members])=>{
                                    const sk3=cls.replace(/[.\[\]#$\/\s]/g,'_');
                                    const tm3={};
                                    members.forEach((m,i)=>{ let tk; if(m.teamNum!=null) tk=String(m.teamNum); else if(m.topic) tk='topic__'+m.topic; else tk=String(Math.floor(i/2)+1); if(!tm3[tk])tm3[tk]=m; });
                                    Object.keys(tm3).sort((a,b)=>{const na=Number(a),nb=Number(b);return(isNaN(na)||isNaN(nb))?a.localeCompare(b):na-nb;}).forEach((tk,ti)=>{ const m=tm3[tk]; vlogSocLb[sk3+'__t'+(ti+1)]=ts3[cls+'__'+(m.topic||'')]||0; });
                                });
                            }
                        }

                        if (isIndividualOrMulti) {
                            // Best score per class
                            const bestPerClass = {};
                            allK.forEach(sk => {
                                const d1=j1[sk], d2=j2[sk];
                                let cls = (d1&&d1.originalClassName)||(d2&&d2.originalClassName)||'';
                                if (!cls) {
                                    const m = sk.match(/^(.+?)__[pt]\d+$/);
                                    if (m) cls = LB_CLASSES.find(c=>c.replace(/[.\[\]#$\/\s]/g,'_')===m[1]) || m[1];
                                    else cls = sk;
                                }
                                let t1=0,t2=0;
                                if(d1&&d1.marks)(Array.isArray(d1.marks)?d1.marks:Object.values(d1.marks)).forEach(m=>t1+=(m||0));
                                if(d2&&d2.marks)(Array.isArray(d2.marks)?d2.marks:Object.values(d2.marks)).forEach(m=>t2+=(m||0));
                                const juryAvg=(t1+t2)/2;
                                let score = juryAvg;
                                if (isVlogEv) { const soc=vlogSocLb[sk]||0; score=(juryAvg/50*50)+Math.min(50,soc/1000*50); }
                                if (bestPerClass[cls]===undefined || score>bestPerClass[cls]) bestPerClass[cls]=score;
                            });
                            const evR=Object.entries(bestPerClass).map(([c,a])=>({cls:c,avg:a})).sort((a,b)=>b.avg-a.avg);
                            if(evR[0]) winner=`<strong>${evR[0].cls}</strong> <span style="color:#c44569">+${cfg.winnerPts}pts</span>`;
                            if(evR[1]) runnerUp=`<strong>${evR[1].cls}</strong> <span style="color:#666">+${cfg.runnerUpPts}pts</span>`;
                        } else {
                            const evR=[];
                            allK.forEach(sk=>{
                                const d1=j1[sk],d2=j2[sk];
                                const cls=(d1&&d1.originalClassName)||(d2&&d2.originalClassName)||sk;
                                let t1=0,t2=0;
                                if(d1&&d1.marks)(Array.isArray(d1.marks)?d1.marks:Object.values(d1.marks)).forEach(m=>t1+=(m||0));
                                if(d2&&d2.marks)(Array.isArray(d2.marks)?d2.marks:Object.values(d2.marks)).forEach(m=>t2+=(m||0));
                                evR.push({cls,avg:(t1+t2)/2});
                            });
                            evR.sort((a,b)=>b.avg-a.avg);
                            if(evR[0]) winner=`<strong>${evR[0].cls}</strong> <span style="color:#c44569">+${cfg.winnerPts}pts</span>`;
                            if(evR[1]) runnerUp=`<strong>${evR[1].cls}</strong> <span style="color:#666">+${cfg.runnerUpPts}pts</span>`;
                        }
                    }
                }
                const typeLabel = setup.eventType === 'individual' ? ' <span style="font-size:10px;background:#e3f2fd;color:#1565c0;padding:2px 6px;border-radius:4px">Individual</span>' 
                                : setup.eventType === 'multiteam'  ? ' <span style="font-size:10px;background:#fff3e0;color:#e65100;padding:2px 6px;border-radius:4px">Multi-Team</span>' 
                                : '';
                html+=`<tr><td><strong>${evName}</strong>${typeLabel}</td><td style="color:${setup.resultsPublished?'#155724':'#856404'}">${pub}</td><td>${winner}</td><td>${runnerUp}</td></tr>`;
            }
            html+='</tbody></table></div>';
            container.innerHTML=html;
        } catch(err) {
            container.innerHTML='<p style="color:red">Error: '+err.message+'</p>';
        }
    }

    async function addLbCriterion() {
        const name = document.getElementById('lbNewCriterionName').value.trim();
        if (!name) { showLbAdminMsg('Please enter a criterion name.','error'); return; }
        try {
            const key = getDb().ref('leaderboardConfig/customCriteria').push().key;
            await getDb().ref('leaderboardConfig/customCriteria/'+key).set({name,createdAt:new Date().toISOString(),points:{}});
            document.getElementById('lbNewCriterionName').value='';
            showLbAdminMsg('âœ… Criterion "'+name+'" added!','success');
            loadLbCriteriaList();
        } catch(err) { showLbAdminMsg('âŒ Error: '+err.message,'error'); }
    }

    async function loadLbCriteriaList() {
        const container = document.getElementById('lbCriteriaList');
        container.innerHTML='<p style="color:#aaa;text-align:center;padding:20px;font-size:13px">Loadingâ€¦</p>';
        try {
            const snap = await getDb().ref('leaderboardConfig/customCriteria').once('value');
            if (!snap.exists()) {
                container.innerHTML='<p style="color:#aaa;text-align:center;padding:20px;font-size:13px">No custom criteria yet. Add one above!</p>';
                return;
            }
            let html='';
            snap.forEach(critNode=>{
                const key=critNode.key, crit=critNode.val(), pts=crit.points||{};
                html+=`<div style="background:white;border:1px solid #ffe082;border-radius:10px;padding:15px;margin-bottom:15px">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;flex-wrap:wrap;gap:8px">
                        <strong style="color:#e65100;font-size:1em">âœ¨ ${crit.name}</strong>
                        <button class="btn btn-danger btn-small" onclick="deleteLbCriterion('${key}','${crit.name.replace(/'/g,"\\'")}')">ðŸ—‘ Delete</button>
                    </div>
                    <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:8px">`;
                LB_CLASSES.forEach(cls=>{
                    const safeKey=cls.replace(/[.\[\]#$\/]/g,'_');
                    const val=pts[safeKey]||pts[cls]||0;
                    const safeId='lbPts_'+key+'_'+cls.replace(/[^a-zA-Z0-9]/g,'_');
                    html+=`<div style="display:flex;align-items:center;gap:6px;background:#fffdf0;padding:6px 10px;border-radius:6px;border:1px solid #ffe082">
                        <span style="font-size:0.78em;color:#555;flex:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis" title="${cls}">${cls}</span>
                        <input type="number" id="${safeId}" value="${val}" min="0" max="9999"
                            style="width:65px;padding:4px;border:1px solid #ddd;border-radius:4px;text-align:center;font-size:0.85em">
                    </div>`;
                });
                html+=`</div>
                    <button class="btn btn-small btn-success" onclick="saveLbCriterionPoints('${key}')" style="margin-top:12px">ðŸ’¾ Save Points for "${crit.name}"</button>
                </div>`;
            });
            container.innerHTML=html;
        } catch(err) { container.innerHTML='<p style="color:red">Error: '+err.message+'</p>'; }
    }

    async function saveLbCriterionPoints(key) {
        try {
            const snap = await getDb().ref('leaderboardConfig/customCriteria/'+key).once('value');
            const crit = snap.val();
            if (!crit) { showLbAdminMsg('Criterion not found.','error'); return; }
            const pointsObj={};
            LB_CLASSES.forEach(cls=>{
                const safeId='lbPts_'+key+'_'+cls.replace(/[^a-zA-Z0-9]/g,'_');
                const safeKey=cls.replace(/[.\[\]#$\/]/g,'_');
                const inp=document.getElementById(safeId);
                pointsObj[safeKey]=inp?(parseInt(inp.value)||0):0;
            });
            await getDb().ref('leaderboardConfig/customCriteria/'+key+'/points').set(pointsObj);
            showLbAdminMsg('âœ… Points saved for "'+crit.name+'"!','success');
        } catch(err) { showLbAdminMsg('âŒ Error: '+err.message,'error'); }
    }

    async function deleteLbCriterion(key,name) {
        if(!confirm('Delete criterion "'+name+'"?\n\nAll points for this criterion will be removed.')) return;
        try {
            await getDb().ref('leaderboardConfig/customCriteria/'+key).remove();
            showLbAdminMsg('âœ… "'+name+'" deleted.','success');
            loadLbCriteriaList();
        } catch(err) { showLbAdminMsg('âŒ Error: '+err.message,'error'); }
    }

    async function loadLbAdminPreview() {
        const container = document.getElementById('lbAdminPreview');
        const updEl     = document.getElementById('lbPreviewUpdated');
        container.innerHTML = '<p style="color:rgba(255,255,255,0.4);text-align:center;padding:30px">â³ Fetching live data from Firebaseâ€¦</p>';
        try {
            const cfg = await getLbConfig();
            const init = () => { const o={}; LB_CLASSES.forEach(c => o[c]=0); return o; };
            const yfP=init(), quizP=init(), resP=init(), custP=init();

            // -- 1. Youthfest Registration ----------------------------------
            const yfSnap = await getDb().ref('youthfest-enrollments').once('value');
            if (yfSnap.exists()) yfSnap.forEach(c => {
                const d=c.val(), cl=d.classYear||d.class||'';
                if (yfP[cl] !== undefined) yfP[cl] += cfg.yfPtsPerEvent;
            });

            // -- 2. Quiz Points (published days only) ----------------------
            const qrSnap = await getDb().ref('quizResults').once('value');
            const pubDates=new Set(); const qWinMap={};
            if (qrSnap.exists()) qrSnap.forEach(dn => {
                const r=dn.val();
                if (r && r.winner && r.runnerUp) {
                    pubDates.add(dn.key);
                    qWinMap[dn.key] = { w: r.winner.class||'', ru: r.runnerUp.class||'' };
                }
            });
            if (pubDates.size > 0) {
                const qsSnap = await getDb().ref('quizSubmissions').once('value');
                if (qsSnap.exists()) qsSnap.forEach(dn => {
                    if (!pubDates.has(dn.key)) return;
                    const w = qWinMap[dn.key];
                    if (w.w  && quizP[w.w]  !== undefined) quizP[w.w]  += cfg.quizWinnerPts;
                    if (w.ru && quizP[w.ru] !== undefined) quizP[w.ru] += cfg.quizRunnerUpPts;
                    const cmx={};
                    dn.forEach(sn => {
                        const s=sn.val(), cl=s.studentClass||'';
                        if (LB_CLASSES.includes(cl)) { if(!cmx[cl]) cmx[cl]=0; if((parseInt(s.score)||0)>=2) cmx[cl]++; }
                    });
                    LB_CLASSES.forEach(cl => {
                        if (!cmx[cl]) return;
                        const str = lbClassStrengths[cl.replace(/[.\[\]#$\/]/g,'_')] || lbClassStrengths[cl] || 0;
                        const b = str>0 ? Math.round((cmx[cl]/str)*cfg.quizMaxPts*10)/10 : cmx[cl];
                        if (quizP[cl] !== undefined) quizP[cl] += b;
                    });
                });
            }

            // -- 3. Event Results (published jury results) -----------------
            const sSnap = await getDb().ref('jurySetup').once('value');
            if (sSnap.exists()) {
                for (const [ev, setup] of Object.entries(sSnap.val())) {
                    if (!setup.resultsPublished) continue;
                    const mSnap = await getDb().ref('juryMarks/'+ev).once('value');
                    if (!mSnap.exists()) continue;
                    const j1=mSnap.val().jury1||{}, j2=mSnap.val().jury2||{};
                    const allK=new Set([...Object.keys(j1),...Object.keys(j2)]);
                    const isIndividualOrMulti = (setup.eventType === 'individual' || setup.eventType === 'multiteam');
                    const isVlogEv4 = (ev === 'Vlog');

                    // For Vlog: build rowKeyâ†’socialScore map
                    let vlogSocLb4 = {};
                    if (isVlogEv4) {
                        const [vs4, es4] = await Promise.all([
                            getDb().ref('vlogChallenge').once('value'),
                            getDb().ref('youthfest-enrollments').orderByChild('event').equalTo('Vlog').once('value')
                        ]);
                        const ts4={};
                        if(vs4.exists()) vs4.forEach(ch=>{ const v=ch.val(); ts4[(v.classYear||'')+'__'+(v.topic||'')]=v.socialScore||0; });
                        if(es4.exists()) {
                            const ec4={};
                            es4.forEach(ch=>{ const e=ch.val(); if(!ec4[e.classYear])ec4[e.classYear]=[]; ec4[e.classYear].push(e); });
                            Object.entries(ec4).forEach(([cls,members])=>{
                                const sk4=cls.replace(/[.\[\]#$\/\s]/g,'_'); const tm4={};
                                members.forEach((m,i)=>{ let tk; if(m.teamNum!=null) tk=String(m.teamNum); else if(m.topic) tk='topic__'+m.topic; else tk=String(Math.floor(i/2)+1); if(!tm4[tk])tm4[tk]=m; });
                                Object.keys(tm4).sort((a,b)=>{const na=Number(a),nb=Number(b);return(isNaN(na)||isNaN(nb))?a.localeCompare(b):na-nb;}).forEach((tk,ti)=>{ const m=tm4[tk]; vlogSocLb4[sk4+'__t'+(ti+1)]=ts4[cls+'__'+(m.topic||'')]||0; });
                            });
                        }
                    }

                    if (isIndividualOrMulti) {
                        const bestPerClass = {};
                        allK.forEach(sk => {
                            const d1=j1[sk], d2=j2[sk];
                            let cls=(d1&&d1.originalClassName)||(d2&&d2.originalClassName)||'';
                            if (!cls) {
                                const m=sk.match(/^(.+?)__[pt]\d+$/);
                                if(m) cls=LB_CLASSES.find(c=>c.replace(/[.\[\]#$\/\s]/g,'_')===m[1])||m[1];
                                else cls=sk;
                            }
                            let t1=0,t2=0;
                            if(d1&&d1.marks)(Array.isArray(d1.marks)?d1.marks:Object.values(d1.marks)).forEach(m=>t1+=(m||0));
                            if(d2&&d2.marks)(Array.isArray(d2.marks)?d2.marks:Object.values(d2.marks)).forEach(m=>t2+=(m||0));
                            const juryAvg=(t1+t2)/2;
                            let score=juryAvg;
                            if(isVlogEv4){ const soc=vlogSocLb4[sk]||0; score=(juryAvg/50*50)+Math.min(50,soc/1000*50); }
                            if(bestPerClass[cls]===undefined||score>bestPerClass[cls]) bestPerClass[cls]=score;
                        });
                        const evR=Object.entries(bestPerClass).map(([c,a])=>({cls:c,avg:a})).sort((a,b)=>b.avg-a.avg);
                        if(evR[0]&&resP[evR[0].cls]!==undefined) resP[evR[0].cls]+=cfg.winnerPts;
                        if(evR[1]&&resP[evR[1].cls]!==undefined) resP[evR[1].cls]+=cfg.runnerUpPts;
                        if(evR[0]&&evR[1]&&evR[0].cls===evR[1].cls&&resP[evR[0].cls]!==undefined) resP[evR[0].cls]+=cfg.runnerUpPts;
                    } else {
                        const evR=[];
                        allK.forEach(sk => {
                            const d1=j1[sk], d2=j2[sk];
                            const cls=(d1&&d1.originalClassName)||(d2&&d2.originalClassName)||sk;
                            let t1=0,t2=0;
                            if(d1&&d1.marks)(Array.isArray(d1.marks)?d1.marks:Object.values(d1.marks)).forEach(m=>t1+=(m||0));
                            if(d2&&d2.marks)(Array.isArray(d2.marks)?d2.marks:Object.values(d2.marks)).forEach(m=>t2+=(m||0));
                            evR.push({cls, avg:(t1+t2)/2});
                        });
                        evR.sort((a,b) => b.avg-a.avg);
                        if (evR[0] && resP[evR[0].cls] !== undefined) resP[evR[0].cls] += cfg.winnerPts;
                        if (evR[1] && resP[evR[1].cls] !== undefined) resP[evR[1].cls] += cfg.runnerUpPts;
                    }
                }
            }

            // -- 4. Custom Criteria ----------------------------------------
            const cSnap = await getDb().ref('leaderboardConfig/customCriteria').once('value');
            if (cSnap.exists()) cSnap.forEach(cn => {
                const c=cn.val(); if(!c||!c.points) return;
                Object.keys(c.points).forEach(k => {
                    LB_CLASSES.forEach(cl => {
                        if (cl.replace(/[.\[\]#$\/]/g,'_')===k && custP[cl]!==undefined) custP[cl]+=(c.points[k]||0);
                    });
                });
            });

            // -- 5. Scavenger Hunt Points ----------------------------------
            const shP = init();
            try {
                const [shSubSnap, shTaskSnap, shWinSnap] = await Promise.all([
                    getDb().ref('scavengerHunt/submissions').once('value'),
                    getDb().ref('scavengerHunt/tasks').once('value'),
                    getDb().ref('scavengerHunt/winner').once('value')
                ]);
                const shSubs = shSubSnap.val() || {};
                const totalTasks = Object.keys(shTaskSnap.val() || {}).length;
                const shWinner = shWinSnap.val() || null;
                Object.values(shSubs).forEach(ss => {
                    const first = Object.values(ss)[0] || {};
                    const cl = first.studentClass || '';
                    if (shP[cl] === undefined) return;
                    let approved = 0;
                    Object.values(ss).forEach(sub => { if (sub.status === 'approved') approved++; });
                    shP[cl] += approved * cfg.shTaskPts;
                    if (totalTasks > 0 && approved >= totalTasks) shP[cl] += cfg.shCompletePts;
                });
                if (shWinner) {
                    const wCls  = shWinner.winner   ? shWinner.winner.cls   : '';
                    const ruCls = shWinner.runnerUp ? shWinner.runnerUp.cls : '';
                    if (wCls  && shP[wCls]  !== undefined) shP[wCls]  += cfg.shWinnerPts;
                    if (ruCls && shP[ruCls] !== undefined) shP[ruCls] += cfg.shRunnerUpPts;
                }
            } catch(e) { console.warn('SH preview pts error:', e); }

            // -- 6. Speed Slide Challenge Points --------------------------
            const sscP = init();
            try {
                const sscSnap = await getDb().ref('speedSlide/submissions').once('value');
                if (sscSnap.exists()) {
                    // ALL approved submissions add to class total
                    sscSnap.forEach(child => {
                        const s = child.val();
                        if (!s || !s.class || s.points === undefined) return;
                        if (s.status !== 'approved') return;
                        if (sscP[s.class] !== undefined)
                            sscP[s.class] += Math.floor(s.points / 10) * (cfg.sscScoreFactor || 1);
                    });
                }
            } catch(e) { console.warn('SSC preview pts error:', e); }

            // -- Rank & render ---------------------------------------------
            const ranked = LB_CLASSES.map(cl => ({
                cl, yfP:yfP[cl]||0, quizP:quizP[cl]||0, resP:resP[cl]||0, custP:custP[cl]||0, shP:shP[cl]||0, sscP:sscP[cl]||0,
                total:(yfP[cl]||0)+(quizP[cl]||0)+(resP[cl]||0)+(custP[cl]||0)+(shP[cl]||0)+(sscP[cl]||0)
            })).sort((a,b) => b.total-a.total);

            const medals = ['ðŸ¥‡','ðŸ¥ˆ','ðŸ¥‰'];
            let html = '<div class="table-wrapper"><table style="min-width:780px;background:white;border-radius:8px;overflow:hidden">'
                     + '<thead><tr>'
                     + '<th style="background:#1a0030;color:#ffd700;padding:10px">Rank</th>'
                     + '<th style="background:#1a0030;color:#ffd700">Class</th>'
                     + '<th style="background:#1a0030;color:#ffc107">ðŸŽ¤ YF Reg</th>'
                     + '<th style="background:#1a0030;color:#a5d6a7">ðŸ§  Quiz</th>'
                     + '<th style="background:#1a0030;color:#ce93d8">ðŸ† Results</th>'
                     + '<th style="background:#1a0030;color:#80deea">âœ¨ Custom</th>'
                     + '<th style="background:#1a0030;color:#e1bee7">ðŸ—ºï¸ Hunt</th>'
                     + '<th style="background:#1a0030;color:#90caf9">ðŸ§© Slide</th>'
                     + '<th style="background:#c44569;color:white;font-size:1.05em">TOTAL</th>'
                     + '</tr></thead><tbody>';

            ranked.forEach((e,i) => {
                const rowBg = i===0 ? 'background:#fffde7' : i===1 ? 'background:#f8f8f8' : i===2 ? 'background:#fff3e0' : 'background:white';
                const rankCell = i<3 ? medals[i] : `<strong>${i+1}</strong>`;
                const totalStyle = i===0 ? 'font-weight:900;color:#c44569;font-size:1.2em' : 'font-weight:700;color:#c44569';
                html += `<tr style="${rowBg}">
                    <td style="text-align:center;font-size:1.1em">${rankCell}</td>
                    <td style="font-weight:600">${e.cl}</td>
                    <td style="color:#856404;text-align:center">${e.yfP}</td>
                    <td style="color:#155724;text-align:center">${e.quizP}</td>
                    <td style="color:#6a1b9a;text-align:center">${e.resP}</td>
                    <td style="color:#0c5460;text-align:center">${e.custP}</td>
                    <td style="color:#6a1b9a;font-weight:600;text-align:center">${e.shP || '<span style=\'color:#ccc\'>â€”</span>'}</td>
                    <td style="color:#0d47a1;font-weight:600;text-align:center">${e.sscP || '<span style=\'color:#ccc\'>â€”</span>'}</td>
                    <td style="${totalStyle};text-align:center">${e.total}</td>
                </tr>`;
            });
            html += '</tbody></table></div>';

            // Data source summary
            const now = new Date().toLocaleTimeString('en-IN');
            html += `<div style="margin-top:10px;padding:8px 12px;background:rgba(255,255,255,0.08);border-radius:6px;font-size:11px;color:rgba(255,255,255,0.5)">
                ðŸ“Š YF Reg pts: ${cfg.yfPtsPerEvent}/event &nbsp;|&nbsp;
                ðŸ§  Quiz winner: ${cfg.quizWinnerPts}pts, runner-up: ${cfg.quizRunnerUpPts}pts, participation max: ${cfg.quizMaxPts}pts &nbsp;|&nbsp;
                ðŸ† Event winner: ${cfg.winnerPts}pts, runner-up: ${cfg.runnerUpPts}pts &nbsp;|&nbsp;
                ðŸ—ºï¸ Hunt task: ${cfg.shTaskPts}pts, completion bonus: ${cfg.shCompletePts}pts, winner: ${cfg.shWinnerPts}pts, runner-up: ${cfg.shRunnerUpPts}pts &nbsp;|&nbsp;
                ðŸ§© Slide score factor: ${cfg.sscScoreFactor||1}pt per 10 game pts (Easy 100â†’10, Medium 200â†’20, Hard 300â†’30) &nbsp;|&nbsp;
                Quiz days counted: ${pubDates.size}
            </div>`;

            container.innerHTML = html;
            if (updEl) updEl.textContent = 'Last updated: ' + now;

        } catch(err) {
            container.innerHTML = '<p style="color:#ff6b6b;text-align:center;padding:20px">âŒ Error loading preview: <strong>' + err.message + '</strong></p>';
            if (updEl) updEl.textContent = 'Failed to load';
        }
    }

    function showLbAdminMsg(msg, type) {
        const el = document.getElementById('lbAdminMessage');
        if (!el) return;
        el.className = 'message ' + type + ' show';
        el.textContent = msg;
        setTimeout(() => el.classList.remove('show'), 6000);
    }

    // Leaderboard tab loading is handled inside showTab() in the main script above

    // ============================================================
    //  HOW WE PUBLISH â€” Editable Section Engine
    //  Super Admin can edit all text via Firebase
    //  Path: leaderboardConfig/howWePublish
    // ============================================================

    const HWP_DEFAULTS = {
        heading:  'Leaderboard Coming Soon!',
        subText:  'Results will be published by the Super Admin once the events are completed.\nCheck back soon!',
        overview: 'The <strong style="color:#c44569">Class of the Year 2026</strong> leaderboard ranks all <strong>11 classes</strong> competing across <strong>16 events</strong> at Spurthi Youth Fest. Rankings are hidden until the Super Admin verifies all results and officially publishes them â€” ensuring every score is accurate before you see it.',
        cards: [
            { title: 'Youthfest Registration', body: 'Each class earns points for <strong>every event they enrol in</strong>. More participation = more points for your class.' },
            { title: 'Quiz Competition',        body: 'Per published quiz day: <strong>flat bonus</strong> to the winner &amp; runner-up class, plus a <strong>participation rate bonus</strong> â€” fair across all class sizes.' },
            { title: 'Event Results',           body: 'When jury results are published, the <strong>1st place class</strong> gets winner pts and <strong>2nd place</strong> gets runner-up pts. For individual &amp; multi-team events, each class is represented by their <strong>best performer or best team</strong>.' },
            { title: 'Scavenger Hunt',          body: 'Points are awarded for <strong>approved task submissions</strong> in the Scavenger Hunt. The more tasks a student completes and gets approved, the more points their class earns.' },
            { title: 'Speed Slide Challenge',   body: 'Students solve a sliding puzzle and earn points based on <strong>speed &amp; difficulty</strong>. Every <strong>approved submission</strong> adds to the class total â€” so the more students from a class who play and get approved, the higher their class climbs.' },
            { title: 'Special / Custom Criteria', body: 'The Super Admin may add bonus points for criteria like discipline, attendance, best decorated class, or other special achievements.' }
        ],
        steps: [
            { title: 'Complete Events & Jury Scoring',  body: 'All events conducted. Jury 1 & Jury 2 fill and submit marks for every event.' },
            { title: 'Publish Quiz Results',            body: 'Daily quiz winners & runners-up declared. Only published days count.' },
            { title: 'Verify Scoring Config',           body: 'Points per event, quiz pts, winner/runner-up pts confirmed & saved.' },
            { title: 'Set Class Strengths',             body: 'Total students per class entered to ensure fair participation scoring.' },
            { title: 'Preview & Verify',                body: 'Live preview checked internally before releasing to students.' },
            { title: 'ðŸ“¢ Publish to Students',          body: 'Only after full verification â€” rankings go LIVE for all students to see.', highlight: true }
        ],
        notes: [
            'Only the <strong>Super Admin</strong> can publish or hide the leaderboard.',
            'All point calculations are <strong>fully automatic</strong> â€” no manual tampering.',
            'For individual events (e.g. Hand Writing, Pod Casting), each class is represented by their <strong>best-scoring student</strong>. For multi-team events (e.g. Vlog), each class is represented by their <strong>best-scoring team</strong>.',
            'The leaderboard refreshes every <strong>60 seconds</strong> once live.',
            'Rankings may be updated progressively as more results are published during the fest period.'
        ]
    };

    let hwpData = JSON.parse(JSON.stringify(HWP_DEFAULTS)); // working copy
    let hwpEditMode = false;

    // -- Load from Firebase (or use defaults) ---------------------------------
    async function hwpLoad() {
        try {
            const snap = await getDb().ref('leaderboardConfig/howWePublish').once('value');
            if (snap.exists()) {
                const d = snap.val();
                if (d.heading)  hwpData.heading  = d.heading;
                if (d.subText)  hwpData.subText  = d.subText;
                if (d.overview) hwpData.overview = d.overview;
                if (d.cards  && Array.isArray(d.cards))  hwpData.cards  = d.cards;
                if (d.steps  && Array.isArray(d.steps))  hwpData.steps  = d.steps;
                if (d.notes  && Array.isArray(d.notes))  hwpData.notes  = d.notes;
            }
        } catch(e) { console.warn('hwpLoad error (using defaults):', e.message); }
        hwpRender();
        hwpShowAdminControls();
    }

    // -- Render all content from hwpData --------------------------------------
    function hwpRender() {
        // Banner
        const hEl = document.getElementById('hwpHeadingText');
        const sEl = document.getElementById('hwpSubText');
        if (hEl) hEl.innerHTML = hwpData.heading;
        if (sEl) sEl.innerHTML = hwpData.subText.replace(/\n/g, '<br>');

        // Overview
        const ov = document.getElementById('hwpOverviewText');
        if (ov) ov.innerHTML = hwpData.overview;

        // Cards
        hwpData.cards.forEach((c, i) => {
            const t = document.getElementById('hwpCard'+i+'Title');
            const b = document.getElementById('hwpCard'+i+'Body');
            if (t) t.innerHTML = c.title;
            if (b) b.innerHTML = c.body;
        });

        // Steps
        const grid = document.getElementById('hwpStepsGrid');
        if (grid) {
            grid.innerHTML = hwpData.steps.map((s, i) => {
                const isLast = s.highlight;
                const numBg  = isLast ? '#28a745' : '#c44569';
                const cardBg = isLast ? 'background:linear-gradient(135deg,#e8f5e9,#d4edda);border:2px solid #28a745' : 'background:#fafafa;border:1px solid #eee';
                const titleColor = isLast ? '#155724' : '#333';
                const bodyColor  = isLast ? '#155724' : '#666';
                return `<div style="${cardBg};border-radius:8px;padding:13px;display:flex;gap:11px;align-items:flex-start" data-step="${i}">
                    <span style="background:${numBg};color:white;border-radius:50%;width:23px;height:23px;display:inline-flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;flex-shrink:0;margin-top:1px">${i+1}</span>
                    <div>
                        <strong style="color:${titleColor};font-size:12.5px" id="hwpStep${i}Title">${s.title}</strong>
                        <p style="margin:3px 0 0;color:${bodyColor};font-size:11.5px" id="hwpStep${i}Body">${s.body}</p>
                        <div class="hwpStepEditArea" style="display:none;margin-top:6px">
                            <input type="text" class="hwpStepTitleInput" data-idx="${i}" value="${s.title.replace(/"/g,'&quot;')}" style="width:100%;padding:4px 7px;border:1px solid #ccc;border-radius:4px;font-size:11.5px;margin-bottom:4px">
                            <textarea class="hwpStepBodyInput" data-idx="${i}" rows="2" style="width:100%;padding:4px 7px;border:1px solid #ccc;border-radius:4px;font-size:11.5px;resize:vertical">${s.body}</textarea>
                            <label style="font-size:11px;color:#666;display:flex;align-items:center;gap:5px;margin-top:3px">
                                <input type="checkbox" class="hwpStepHighlight" data-idx="${i}" ${s.highlight?'checked':''} style="width:auto"> Highlight as final step (green)
                            </label>
                        </div>
                    </div>
                </div>`;
            }).join('');
        }

        // Notes
        const nl = document.getElementById('hwpNotesList');
        if (nl) nl.innerHTML = hwpData.notes.map(n => `<li>${n}</li>`).join('');
    }

    // -- Show admin controls if Super Admin is logged in -----------------------
    function hwpShowAdminControls() {
        const isSA = typeof isSuperAdmin !== 'undefined' && isSuperAdmin;
        if (!isSA) return;
        const bannerCtrl  = document.getElementById('hwpBannerEditControls');
        const sectionCtrl = document.getElementById('hwpEditModeControls');
        if (bannerCtrl)  { bannerCtrl.style.display  = 'flex'; }
        if (sectionCtrl) { sectionCtrl.style.display = 'flex'; }
    }

    // -- Banner edit -----------------------------------------------------------
    function hwpToggleBannerEdit() {
        const isEditing = document.getElementById('hwpHeadingEdit').style.display !== 'none';
        if (!isEditing) {
            document.getElementById('hwpHeadingInput').value = hwpData.heading;
            document.getElementById('hwpSubInput').value     = hwpData.subText;
            document.getElementById('hwpHeadingView').style.display = 'none';
            document.getElementById('hwpSubView').style.display     = 'none';
            document.getElementById('hwpHeadingEdit').style.display = 'block';
            document.getElementById('hwpSubEdit').style.display     = 'block';
            document.getElementById('hwpBannerEditBtn').style.display  = 'none';
            document.getElementById('hwpBannerSaveBtn').style.display  = 'inline-block';
            document.getElementById('hwpBannerCancelBtn').style.display= 'inline-block';
        }
    }
    function hwpCancelBannerEdit() {
        document.getElementById('hwpHeadingView').style.display = 'block';
        document.getElementById('hwpSubView').style.display     = 'block';
        document.getElementById('hwpHeadingEdit').style.display = 'none';
        document.getElementById('hwpSubEdit').style.display     = 'none';
        document.getElementById('hwpBannerEditBtn').style.display   = 'inline-block';
        document.getElementById('hwpBannerSaveBtn').style.display   = 'none';
        document.getElementById('hwpBannerCancelBtn').style.display = 'none';
    }
    async function hwpSaveBanner() {
        hwpData.heading = document.getElementById('hwpHeadingInput').value.trim() || hwpData.heading;
        hwpData.subText = document.getElementById('hwpSubInput').value.trim()     || hwpData.subText;
        try {
            await getDb().ref('leaderboardConfig/howWePublish/heading').set(hwpData.heading);
            await getDb().ref('leaderboardConfig/howWePublish/subText').set(hwpData.subText);
            hwpRender();
            hwpCancelBannerEdit();
            const msg = document.getElementById('hwpBannerSaveMsg');
            if (msg) { msg.style.display='inline-block'; setTimeout(()=>msg.style.display='none',3000); }
        } catch(e) { alert('Save error: ' + e.message); }
    }

    // -- Section edit mode -----------------------------------------------------
    function hwpToggleEditMode() {
        hwpEditMode = true;
        // Overview
        document.getElementById('hwpOverviewView').style.display = 'none';
        document.getElementById('hwpOverviewEdit').style.display = 'block';
        document.getElementById('hwpOverviewInput').value = hwpData.overview;
        // Cards
        document.querySelectorAll('.hwpCardEditArea').forEach((el,i) => {
            el.style.display = 'block';
            const tIn = el.querySelector('.hwpCardTitleInput');
            const bIn = el.querySelector('.hwpCardBodyInput');
            if (tIn) tIn.value = hwpData.cards[i] ? hwpData.cards[i].title : '';
            if (bIn) bIn.value = hwpData.cards[i] ? hwpData.cards[i].body.replace(/<[^>]+>/g,'') : '';
        });
        // Steps
        document.querySelectorAll('.hwpStepEditArea').forEach(el => el.style.display='block');
        // Notes
        document.getElementById('hwpNotesView').style.display = 'none';
        document.getElementById('hwpNotesEdit').style.display = 'block';
        document.getElementById('hwpNotesInput').value = hwpData.notes.map(n=>n.replace(/<[^>]+>/g,'')).join('\n');
        // Buttons
        document.getElementById('hwpEditModeBtn').style.display  = 'none';
        document.getElementById('hwpSaveAllBtn').style.display   = 'inline-block';
        document.getElementById('hwpCancelBtn').style.display    = 'inline-block';
    }
    function hwpCancelEdit() {
        hwpEditMode = false;
        hwpRender();
        document.getElementById('hwpOverviewView').style.display = 'block';
        document.getElementById('hwpOverviewEdit').style.display = 'none';
        document.getElementById('hwpNotesView').style.display    = 'block';
        document.getElementById('hwpNotesEdit').style.display    = 'none';
        document.querySelectorAll('.hwpCardEditArea').forEach(el => el.style.display='none');
        document.getElementById('hwpEditModeBtn').style.display  = 'inline-block';
        document.getElementById('hwpSaveAllBtn').style.display   = 'none';
        document.getElementById('hwpCancelBtn').style.display    = 'none';
    }
    async function hwpSaveAll() {
        // Collect overview
        hwpData.overview = document.getElementById('hwpOverviewInput').value.trim() || hwpData.overview;

        // Collect cards
        document.querySelectorAll('.hwpCardTitleInput').forEach(inp => {
            const i = parseInt(inp.dataset.idx);
            if (!isNaN(i) && hwpData.cards[i]) hwpData.cards[i].title = inp.value.trim();
        });
        document.querySelectorAll('.hwpCardBodyInput').forEach(inp => {
            const i = parseInt(inp.dataset.idx);
            if (!isNaN(i) && hwpData.cards[i]) hwpData.cards[i].body = inp.value.trim();
        });

        // Collect steps
        document.querySelectorAll('.hwpStepTitleInput').forEach(inp => {
            const i = parseInt(inp.dataset.idx);
            if (!isNaN(i) && hwpData.steps[i]) hwpData.steps[i].title = inp.value.trim();
        });
        document.querySelectorAll('.hwpStepBodyInput').forEach(inp => {
            const i = parseInt(inp.dataset.idx);
            if (!isNaN(i) && hwpData.steps[i]) hwpData.steps[i].body = inp.value.trim();
        });
        document.querySelectorAll('.hwpStepHighlight').forEach(inp => {
            const i = parseInt(inp.dataset.idx);
            if (!isNaN(i) && hwpData.steps[i]) hwpData.steps[i].highlight = inp.checked;
        });

        // Collect notes
        const rawNotes = document.getElementById('hwpNotesInput').value.trim();
        if (rawNotes) hwpData.notes = rawNotes.split('\n').map(n=>n.trim()).filter(Boolean);

        const saveBtn = document.getElementById('hwpSaveAllBtn');
        if (saveBtn) { saveBtn.disabled=true; saveBtn.textContent='â³ Savingâ€¦'; }
        try {
            await getDb().ref('leaderboardConfig/howWePublish').set({
                heading:  hwpData.heading,
                subText:  hwpData.subText,
                overview: hwpData.overview,
                cards:    hwpData.cards,
                steps:    hwpData.steps,
                notes:    hwpData.notes,
                updatedAt: new Date().toISOString()
            });
            hwpCancelEdit();
            hwpRender();
            const msg = document.getElementById('hwpSaveAllMsg');
            if (msg) { msg.style.display='inline-block'; setTimeout(()=>msg.style.display='none',4000); }
        } catch(e) {
            alert('âŒ Save error: ' + e.message);
        } finally {
            if (saveBtn) { saveBtn.disabled=false; saveBtn.textContent='ðŸ’¾ Save All Changes'; }
        }
    }


    // ================================================================
    //  SCAVENGER HUNT SYSTEM
    // ================================================================
    let shCurrentUser   = null;
    let shTasks         = [];
    let shSettings      = { active: false, gps: true, radius: 100, autoApprove: false };
    let shUserLat       = null;
    let shUserLng       = null;
    let shGpsWatchId    = null;

    // -- Public status banner (before login) -------------------------
    async function shCheckPublicStatus() {
        const banner = document.getElementById('shPublicBanner');
        if (!banner) return;
        try {
            const snap = await window.db.ref('scavengerHunt/settings').once('value');
            const s = snap.val() || {};
            if (s.active) {
                banner.innerHTML = '<div style="font-size:2em;margin-bottom:6px">ðŸŸ¢</div><strong style="font-size:1.15em">Hunt is LIVE!</strong><p style="margin:6px 0 0;opacity:0.9;font-size:0.95em">Tasks are waiting. Login to start!</p>';
                banner.style.background = 'linear-gradient(135deg,#2e7d32,#43a047)';
            } else {
                banner.innerHTML = '<div style="font-size:2em;margin-bottom:6px">ðŸ”´</div><strong>Hunt Not Started Yet</strong><p style="margin:6px 0 0;opacity:0.9;font-size:0.9em">Stay tuned â€” the hunt will begin soon!</p>';
                banner.style.background = 'linear-gradient(135deg,#b71c1c,#e53935)';
            }
        } catch(e) { if (banner) banner.innerHTML = '<p style="margin:0">âš ï¸ Could not load status.</p>'; }
    }

    // -- Student Login -------------------------------------------------
    async function shLogin() {
        const phone = document.getElementById('shLoginPhone').value.trim();
        const pwd   = document.getElementById('shLoginPassword').value;
        const msg   = document.getElementById('shLoginMsg');
        msg.className = 'message'; msg.style.display = 'none';
        if (!phone || !pwd) { shShowMsg(msg,'error','Enter phone and password.'); return; }
        try {
            const snap = await window.db.ref('quizStudents').orderByChild('phone').equalTo(phone).once('value');
            if (!snap.exists()) { alert('âŒ Phone number not registered!\n\nPlease register via the Daily Quiz section first, then try Scavenger Hunt login.'); shShowMsg(msg,'error','âŒ Phone not registered. Register via Daily Quiz first.'); return; }
            let found = null, foundKey = null;
            snap.forEach(c => { if (c.val().password === pwd) { found = c.val(); foundKey = c.key; } });
            if (!found) { alert('âŒ Incorrect password!\n\nPlease check your password and try again.'); shShowMsg(msg,'error','âŒ Incorrect password.'); return; }

            // Save credentials if Remember Me checked
            if (document.getElementById('shRememberMe').checked) {
                localStorage.setItem('spurthi_sh_phone', phone);
                localStorage.setItem('spurthi_sh_pwd', pwd);
                localStorage.setItem('spurthi_sh_remember', '1');
            } else {
                localStorage.removeItem('spurthi_sh_phone');
                localStorage.removeItem('spurthi_sh_pwd');
                localStorage.removeItem('spurthi_sh_remember');
            }

            shCurrentUser = { key: foundKey, ...found };
            document.getElementById('loginSection').style.display        = 'none';
            document.getElementById('quizStudentDashboard').style.display = 'none';
            document.getElementById('shStudentDashboard').style.display   = 'block';
            document.getElementById('shStudentName').textContent   = found.name;
            document.getElementById('shStudentClass').textContent  = found.class || found.classYear || '';
            document.getElementById('shStudentBadge').textContent  = found.name;
            document.getElementById('userInfo').innerHTML = 'Logged in as: <span class="badge" style="background:#9c27b0;color:white;padding:5px 12px;border-radius:20px;font-size:0.85em">' + found.name + ' â€“ Scavenger Hunt</span>';
            if (window.maybeShowNotifBanner) maybeShowNotifBanner();
            setTimeout(() => {
                const shDash = document.getElementById('shStudentDashboard');
                if (shDash) {
                    const y = shDash.getBoundingClientRect().top + window.pageYOffset - 20;
                    window.scrollTo({ top: y, behavior: 'smooth' });
                }
            }, 150);
            await shLoadStudentDashboard();
        } catch(e) { 
            console.error('shLogin error:', e);
            alert('âŒ Login failed: ' + (e.message || 'Unknown error') + '\n\nCheck your internet connection and try again.');
            shShowMsg(msg,'error','âŒ Error: ' + e.message); 
        }
    }

    function shLogout() { logout(); }

    function shGoBack() {
        // Hide dashboard, show login page â€” student stays logged in but goes back to login screen
        document.getElementById('shStudentDashboard').style.display = 'none';
        document.getElementById('loginSection').style.display = 'block';
        document.getElementById('scavengerHuntLogin').style.display = 'block';
        // Make sure competition dropdown reflects scavenger hunt selection
        const compDrop = document.getElementById('competitionType');
        if (compDrop) compDrop.value = 'scavengerhunt';
        shCurrentUser = null;
    }

    // -- Student: Refresh Status ----------------------------------------
    async function shRefreshStatus() {
        const btn = document.getElementById('shRefreshBtn');
        const lastEl = document.getElementById('shLastRefreshed');
        if (btn) { btn.disabled = true; btn.textContent = 'â³ Checking...'; }
        await shLoadStudentDashboard();
        if (btn) { btn.disabled = false; btn.innerHTML = 'ðŸ”„ Check Status'; }
        const now = new Date().toLocaleTimeString('en-IN', {hour:'2-digit',minute:'2-digit',second:'2-digit'});
        if (lastEl) lastEl.textContent = 'Last checked: ' + now;
        // Show toast
        const toast = document.createElement('div');
        toast.textContent = 'âœ… Status updated!';
        toast.style.cssText = 'position:fixed;top:20px;left:50%;transform:translateX(-50%);background:#4caf50;color:white;padding:12px 28px;border-radius:30px;font-weight:700;font-size:1em;z-index:9999;box-shadow:0 4px 20px rgba(0,0,0,0.2);transition:opacity 0.5s';
        document.body.appendChild(toast);
        setTimeout(() => { toast.style.opacity = '0'; setTimeout(() => toast.remove(), 500); }, 2000);
    }

    // -- Check single task approval (no scroll) ------------------------
    async function shCheckTaskApproval(taskId, btn) {
        if (btn) { btn.disabled = true; btn.textContent = 'â³ Checking...'; }
        try {
            const subSnap = await window.db.ref('scavengerHunt/submissions/' + shCurrentUser.key + '/' + taskId).once('value');
            const sub = subSnap.val();

            function showToast(msg, color) {
                const t = document.createElement('div');
                t.textContent = msg;
                t.style.cssText = 'position:fixed;top:20px;left:50%;transform:translateX(-50%);background:'+color+';color:white;padding:12px 28px;border-radius:30px;font-weight:700;font-size:0.95em;z-index:9999;box-shadow:0 4px 20px rgba(0,0,0,0.2);transition:opacity 0.5s';
                document.body.appendChild(t);
                setTimeout(() => { t.style.opacity='0'; setTimeout(()=>t.remove(),500); }, 2500);
            }

            if (sub && sub.status === 'approved') {
                if (btn) { btn.disabled = false; btn.textContent = 'ðŸ”„ Check Approval'; }
                showToast('âœ… Approved by Super Admin!', '#4caf50');
                // Full reload from Firebase â€” do NOT touch DOM before this
                // so task counts are always based on fresh server data
                await shLoadStudentDashboard();

            } else if (sub && sub.status === 'rejected') {
                if (btn) { btn.disabled = false; btn.textContent = 'ðŸ”„ Check Approval'; }
                showToast('âŒ Task was Rejected â€” please reupload!', '#c62828');
                // For rejected, do a silent background reload after short delay so reupload UI appears
                setTimeout(() => shLoadStudentDashboard(), 500);

            } else {
                // Still pending â€” just show toast, no re-render, no scroll
                if (btn) { btn.disabled = false; btn.textContent = 'ðŸ”„ Check Approval'; }
                showToast('â³ Still waiting for super admin approvalâ€¦', '#ff9800');
            }
        } catch(e) {
            if (btn) { btn.disabled = false; btn.textContent = 'ðŸ”„ Check Approval'; }
            alert('Error checking status: ' + e.message);
        }
    }

    // -- Student Dashboard ---------------------------------------------
    async function shLoadStudentDashboard() {
        // Show loading state â€” keep progressSection visible during reload to avoid flash
        const notActive = document.getElementById('shNotActiveMsg');
        const progSect  = document.getElementById('shProgressSection');
        if (notActive) notActive.style.display = 'none';
        // Only hide progress section if it was never shown yet (first load)
        if (progSect && progSect.style.display === 'none') progSect.style.display = 'none';
        // Hide the All Done banner during reload â€” will be re-evaluated from fresh Firebase data
        const allDoneBanner = document.getElementById('shAllDoneSection');
        if (allDoneBanner) allDoneBanner.style.display = 'none';
        const tasksList = document.getElementById('shTasksList');
        if (tasksList) { tasksList.style.display = ''; tasksList.innerHTML = '<p style="color:#999;text-align:center;padding:20px">â³ Loading tasks...</p>'; }
        let settSnap, taskSnap, subSnap;
        try {
            [settSnap, taskSnap, subSnap] = await Promise.all([
                window.db.ref('scavengerHunt/settings').once('value'),
                window.db.ref('scavengerHunt/tasks').once('value'),
                window.db.ref('scavengerHunt/submissions/' + shCurrentUser.key).once('value')
            ]);
        } catch(e) {
            console.error('shLoadStudentDashboard DB error:', e);
            if (tasksList) tasksList.innerHTML = '<div style="background:#ffebee;padding:15px;border-radius:8px;color:#c62828">âŒ Failed to load: ' + e.message + '<br><button onclick="shLoadStudentDashboard()" class="btn btn-small" style="margin-top:8px">ðŸ”„ Retry</button></div>';
            if (progSect) progSect.style.display = 'block';
            return;
        }
        shSettings = settSnap.val() || { active:false, gps:true, radius:100, autoApprove:false };
        if (!shSettings.active) {
            document.getElementById('shNotActiveMsg').style.display    = 'block';
            document.getElementById('shProgressSection').style.display = 'none';
            return;
        }
        document.getElementById('shNotActiveMsg').style.display    = 'none';
        document.getElementById('shProgressSection').style.display = 'block';
        const tasksRaw = taskSnap.val() || {};
        shTasks = Object.entries(tasksRaw).map(([k,v])=>({id:k,...v})).sort((a,b)=>(a.order||0)-(b.order||0));
        const subs = subSnap.val() || {};
        let completed=0, pendingReview=0, locked=0, active=0, rejected=0;
        const nowMs = Date.now();
        // Pre-compute: all tasks require ALL previous tasks (by order) to be approved (strict chain)
        // Tasks are sorted by order. We count how many consecutive tasks from the start are approved.
        // IMPORTANT: we use task.order (not array index) so that if an earlier task is deleted
        // from the task list, later tasks (with higher order numbers) are NOT accidentally treated
        // as "first" and unlocked without prerequisite approval.
        const minOrder = shTasks.length > 0 ? (shTasks[0].order || 1) : 1;
        let approvedChainCount = 0; // how many consecutive tasks from the start are fully approved
        for (let i = 0; i < shTasks.length; i++) {
            const s = subs[shTasks[i].id];
            // Only count as approved if it has a real submission (submittedAt present)
            if (s && s.status === 'approved' && s.submittedAt) {
                approvedChainCount++;
            } else {
                break; // chain breaks â€” no task beyond this is unlocked
            }
        }

        shTasks.forEach((t, idx) => {
            const sub = subs[t.id];
            // A task is accessible only if ALL tasks before it (by sorted order) are approved.
            // Task at idx=0 is accessible only if its order equals minOrder (i.e. it IS the first
            // task by design). If a task has order > minOrder and is at idx=0 because earlier
            // order tasks were deleted, it is NOT automatically unlocked â€” it requires prior approval.
            const taskOrder = t.order || (idx + 1);
            // idx===0 = first task in sorted list = always accessible, regardless of order number value
            const allPrevApproved = (idx === 0) || approvedChainCount >= idx;
            // Check time availability
            const notYet = t.availableFrom && !isNaN(new Date(t.availableFrom).getTime()) && new Date(t.availableFrom).getTime() > nowMs;
            const expired = t.deadline && !isNaN(new Date(t.deadline).getTime()) && new Date(t.deadline).getTime() < nowMs;

            // Gate 1: ALL previous tasks must be approved â€” if not, lock immediately
            if (!allPrevApproved) {
                t._state = 'locked'; locked++;
            } else if (sub && sub.status === 'approved' && sub.submittedAt) {
                // For multi-part tasks: only fully completed when ALL parts are approved
                if (t.parts && t.parts.length > 0) {
                    const subParts = sub.parts || [];
                    const totalParts = t.parts.length;
                    const allApproved = subParts.length === totalParts && subParts.every(p => p && p.status === 'approved');
                    const anyPending  = subParts.some(p => p && p.status === 'pending');
                    if (allApproved) {
                        t._state = 'completed'; completed++;
                    } else if (anyPending) {
                        t._state = 'pending'; pendingReview++;
                    } else {
                        // Part 1 approved but later parts not yet submitted
                        t._state = 'active'; active++;
                    }
                } else {
                    t._state = 'completed'; completed++;
                }
            } else if (sub && sub.status === 'pending' && sub.submittedAt) {
                t._state = 'pending'; pendingReview++;
            } else if (sub && sub.status === 'rejected' && sub.submittedAt) {
                t._state = 'rejected'; rejected++;
            } else if (notYet) {
                t._state = 'locked'; t._lockReason = 'not_yet'; locked++;
            } else if (expired) {
                t._state = 'locked'; t._lockReason = 'expired'; locked++;
            } else {
                t._state = 'active'; active++;
            }
            t._sub = sub || null;
        });
        const total = shTasks.length;
        const pct   = total ? Math.round(completed/total*100) : 0;
        document.getElementById('shProgressText').textContent   = completed+'/'+total+' ('+pct+'%)';
        document.getElementById('shProgressBar').style.width    = pct+'%';
        document.getElementById('shCompletedCount').textContent = completed;
        document.getElementById('shPendingCount').textContent   = pendingReview;
        document.getElementById('shLockedCount').textContent    = locked;
        // Only show "All Done" when every task is truly approved (zero pending/rejected/locked/active)
        if (completed===total && total>0 && pendingReview===0 && locked===0 && active===0 && rejected===0) {
            const _sy = window.scrollY;
            document.getElementById('shTasksList').innerHTML = '';
            document.getElementById('shAllDoneSection').style.display = 'block';
            requestAnimationFrame(() => window.scrollTo({ top: _sy, behavior: 'instant' }));
        } else {
            const _sy2 = window.scrollY;
            document.getElementById('shAllDoneSection').style.display = 'none';
            shRenderTasks(shTasks, subs);
            requestAnimationFrame(() => window.scrollTo({ top: _sy2, behavior: 'instant' }));
        }
        if (shSettings.gps) shGetLocation();
    }

    function shRenderTasks(tasks, subs) {
        const el = document.getElementById('shTasksList');
        if (!tasks.length) { el.innerHTML = '<p style="color:#999">No tasks available yet.</p>'; return; }

        const nowMs  = Date.now();
        const todayStr = new Date().toLocaleDateString('en-IN',{weekday:'long',day:'2-digit',month:'long',year:'numeric'});

        // -- Summary banner -----------------------------------------------
        let summaryHtml = '<div style="background:linear-gradient(135deg,#1a0030,#6a1b9a);color:white;border-radius:12px;padding:16px 20px;margin-bottom:16px">';
        summaryHtml += '<div style="font-size:0.8em;opacity:0.75;margin-bottom:4px">ðŸ“… Today</div>';
        summaryHtml += '<div style="font-size:1.05em;font-weight:700;margin-bottom:12px">'+todayStr+'</div>';

        // Check each task for history
        tasks.forEach((t, idx) => {
            const sub  = subs[t.id] || null;
            const isToday = t.availableFrom && new Date(t.availableFrom).toDateString() === new Date().toDateString();
            const isPast  = t.availableFrom && new Date(t.availableFrom).getTime() < nowMs;
            const taskLabel = 'Task '+(idx+1);
            const statusIcon = sub ? (sub.status==='approved'?'âœ…':sub.status==='rejected'?'âŒ':'â³') : (isPast?'ðŸ“­':'ðŸ”’');
            const statusText = sub ? (sub.status==='approved'?'Approved':sub.status==='rejected'?'Rejected â€” Reupload':'Under Review') : (isPast?'Not submitted':'Upcoming');
            const statusColor = sub ? (sub.status==='approved'?'#a5d6a7':sub.status==='rejected'?'#ef9a9a':'#ffe082') : (isPast?'#ef9a9a':'rgba(255,255,255,.5)');
            const taskDay = t.availableFrom ? new Date(t.availableFrom).toLocaleDateString('en-IN',{weekday:'short',day:'2-digit',month:'short'}) : 'â€”';
            summaryHtml += '<div style="display:flex;align-items:center;gap:10px;background:rgba(255,255,255,.1);border-radius:8px;padding:8px 12px;margin-bottom:6px">';
            summaryHtml += '<span style="font-size:1.3em">'+statusIcon+'</span>';
            summaryHtml += '<div style="flex:1"><div style="font-weight:700;font-size:.9em">'+taskLabel+'</div><div style="font-size:.75em;opacity:.8">'+taskDay+'</div></div>';
            summaryHtml += '<span style="font-size:.8em;font-weight:700;color:'+statusColor+'">'+statusText+'</span>';
            summaryHtml += '</div>';
        });

        // Next upcoming task info
        const nextTask = tasks.find(t => t.availableFrom && new Date(t.availableFrom).getTime() > nowMs && !subs[t.id]);
        if (nextTask) {
            const nextTime = new Date(nextTask.availableFrom).toLocaleString('en-IN',{weekday:'short',day:'2-digit',month:'short',hour:'2-digit',minute:'2-digit',hour12:true});
            summaryHtml += '<div style="background:rgba(255,255,255,.15);border-radius:8px;padding:8px 12px;font-size:.85em;margin-top:4px">ðŸš€ <strong>Next hunt:</strong> Task '+(tasks.indexOf(nextTask)+1)+' opens on <strong>'+nextTime+'</strong></div>';
        }
        summaryHtml += '</div>';

        let html = summaryHtml;
        tasks.forEach((t,idx) => {
            const state = t._state;
            const sub   = t._sub;
            const stateLabel = {
                completed: '<span class="sh-badge sh-badge-done">âœ… Completed</span>',
                pending:   '<span class="sh-badge sh-badge-pending">â³ Under Review</span>',
                rejected:  '<span class="sh-badge sh-badge-rejected">âŒ Rejected â€“ Reupload</span>',
                active:    '<span class="sh-badge sh-badge-active">ðŸ“ Active</span>',
                locked:    '<span class="sh-badge" style="background:#eee;color:#999;border:1px solid #ccc">ðŸ”’ Locked</span>'
            }[state] || '';
            const cardClass = state==='completed' ? 'sh-task-card completed' : state==='pending' ? 'sh-task-card pending' : state==='locked' ? 'sh-task-card locked' : state==='rejected' ? 'sh-task-card rejected' : 'sh-task-card';
            const fmtDT = iso => new Date(iso).toLocaleString('en-IN',{weekday:'short',day:'2-digit',month:'short',year:'numeric',hour:'2-digit',minute:'2-digit',hour12:true});
            const fmtDate = iso => new Date(iso).toLocaleDateString('en-IN',{weekday:'long',day:'2-digit',month:'long',year:'numeric'});
            html += '<div class="' + cardClass + '" id="shTask_' + t.id + '">';

            // -- Task header banner -----------------------------------------
            const headerBg = state==='completed'?'linear-gradient(135deg,#2e7d32,#43a047)':state==='pending'?'linear-gradient(135deg,#e65100,#ff9800)':state==='rejected'?'linear-gradient(135deg,#b71c1c,#f44336)':state==='locked'?'linear-gradient(135deg,#546e7a,#78909c)':'linear-gradient(135deg,#6a1b9a,#9c27b0)';
            html += '<div style="background:'+headerBg+';color:white;border-radius:10px 10px 0 0;padding:12px 16px;margin:-1px -1px 14px;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:8px">';
            html += '<div><span style="font-size:0.75em;opacity:0.85;text-transform:uppercase;letter-spacing:1px">Task '+( idx+1)+' of '+shTasks.length+'</span><h4 style="margin:4px 0 0;font-size:1em;font-weight:700">'+shEsc(t.name)+'</h4></div>';
            html += stateLabel;
            html += '</div>';

            // -- Date/Time info panel ---------------------------------------
            html += '<div style="background:#f8f0ff;border-radius:8px;padding:10px 14px;margin-bottom:12px;font-size:0.85em">';
            if (t.availableFrom) {
                const fromDate = fmtDate(t.availableFrom);
                const fromTime = new Date(t.availableFrom).toLocaleTimeString('en-IN',{hour:'2-digit',minute:'2-digit',hour12:true});
                html += '<div style="display:flex;align-items:center;gap:8px;margin-bottom:4px"><span style="font-size:1.1em">ðŸ—“ï¸</span><span style="color:#6a1b9a;font-weight:700">Task Day:</span> <span style="color:#333">'+fromDate+'</span></div>';
                html += '<div style="display:flex;align-items:center;gap:8px;margin-bottom:4px"><span style="font-size:1.1em">â°</span><span style="color:#388e3c;font-weight:700">Starts:</span> <span style="color:#333">'+fmtDT(t.availableFrom)+'</span></div>';
            }
            if (t.deadline) {
                html += '<div style="display:flex;align-items:center;gap:8px;margin-bottom:4px"><span style="font-size:1.1em">ðŸ”š</span><span style="color:#f44336;font-weight:700">Deadline:</span> <span style="color:#333">'+fmtDT(t.deadline)+'</span></div>';
            }
            if (t.createdAt) {
                html += '<div style="display:flex;align-items:center;gap:8px"><span style="font-size:1.1em">ðŸ“‹</span><span style="color:#888;font-weight:600">Created:</span> <span style="color:#aaa">'+fmtDT(t.createdAt)+'</span></div>';
            }
            html += '</div>';

            if (t.hint) html += '<p style="color:#795548;font-size:0.9em;margin-bottom:10px;background:#fff8e1;padding:8px 12px;border-radius:6px;border-left:4px solid #ffb300">ðŸ’¡ <strong>Hint:</strong> ' + shEsc(t.hint) + '</p>';
            if (t.image) html += '<div style="margin-bottom:12px;text-align:center"><img src="'+t.image+'" style="max-width:100%;max-height:260px;border-radius:10px;border:2px solid #ce93d8;box-shadow:0 3px 12px rgba(106,27,154,0.15);cursor:pointer" onclick="shViewPhoto(this.src)" title="Click to enlarge" alt="Task reference image"><div style="font-size:0.78em;color:#9c27b0;margin-top:4px;opacity:0.8">ðŸ–¼ï¸ Reference image â€” click to enlarge</div></div>';

            // Lock/expiry reason
            if (t._lockReason==='not_yet')  html += '<div style="background:#e3f2fd;padding:10px 14px;border-radius:6px;font-size:0.88em;color:#1565c0;margin-bottom:10px;border-left:4px solid #2196f3">â³ <strong>Not open yet.</strong> This task unlocks on '+fmtDT(t.availableFrom)+'</div>';
            if (t._lockReason==='expired')  html += '<div style="background:#ffebee;padding:10px 14px;border-radius:6px;font-size:0.88em;color:#c62828;margin-bottom:10px;border-left:4px solid #f44336">â›” <strong>Deadline passed.</strong> This task is no longer available.</div>';
            if (state==='locked' && !t._lockReason) html += '<div style="background:#f5f5f5;padding:10px 14px;border-radius:6px;font-size:0.88em;color:#546e7a;margin-bottom:10px;border-left:4px solid #78909c">ðŸ”’ <strong>Locked.</strong> Complete and get the previous task approved first.</div>';

            if (shSettings.gps && t.lat && t.lng) html += '<span class="sh-gps-badge" style="margin-bottom:10px;display:inline-flex">ðŸ“ GPS Verified Location</span>';
            // Show submission date/time and review info
            if (sub) {
                const submittedTime = sub.submittedAt ? new Date(sub.submittedAt).toLocaleString('en-IN',{day:'2-digit',month:'short',year:'numeric',hour:'2-digit',minute:'2-digit',hour12:true}) : '';
                const reviewedTime  = sub.reviewedAt  ? new Date(sub.reviewedAt).toLocaleString('en-IN',{day:'2-digit',month:'short',year:'numeric',hour:'2-digit',minute:'2-digit',hour12:true}) : '';
                if (submittedTime) html += '<div style="font-size:0.82em;color:#888;margin-bottom:6px">ðŸ“… Submitted: <strong style="color:#555">' + submittedTime + '</strong></div>';
                if (state === 'completed' && reviewedTime) {
                    html += '<div style="background:#e8f5e9;border:2px solid #4caf50;border-radius:8px;padding:10px 14px;margin-bottom:8px;display:flex;align-items:center;gap:8px">';
                    html += '<span style="font-size:1.3em">âœ…</span><div><strong style="color:#2e7d32;font-size:0.95em">APPROVED by Admin</strong><br><span style="font-size:0.78em;color:#666">Reviewed on: ' + reviewedTime + '</span></div></div>';
                } else if (state === 'rejected') {
                    const rejReason = sub.rejectionReason ? sub.rejectionReason : '';
                    html += '<div style="background:#ffebee;border:2px solid #f44336;border-radius:8px;padding:12px 14px;margin-bottom:8px">';
                    html += '<div style="display:flex;align-items:flex-start;gap:10px">';
                    html += '<span style="font-size:1.4em;line-height:1">âŒ</span>';
                    html += '<div style="flex:1"><strong style="color:#c62828;font-size:0.95em">REJECTED â€” Please reupload</strong>';
                    if (reviewedTime) html += '<br><span style="font-size:0.78em;color:#666">Reviewed on: ' + reviewedTime + '</span>';
                    if (rejReason) html += '<div style="margin-top:8px;background:#fff0f0;border-left:3px solid #f44336;padding:8px 12px;border-radius:0 6px 6px 0;font-size:0.88em;color:#b71c1c"><strong>ðŸ“ Reason:</strong> ' + shEsc(rejReason) + '</div>';
                    html += '</div></div></div>';
                } else if (state === 'pending') {
                    html += '<div data-pending-box style="background:#fff3e0;border:2px solid #ff9800;border-radius:8px;padding:10px 14px;margin-bottom:8px;display:flex;align-items:center;justify-content:space-between;gap:8px;flex-wrap:wrap">';
                    html += '<div style="display:flex;align-items:center;gap:8px"><span style="font-size:1.3em">â³</span><div><strong style="color:#e65100;font-size:0.95em">Under Review</strong><br><span style="font-size:0.78em;color:#666">Waiting for super admin approval</span><br><span style="font-size:0.8em;color:#c0392b;font-weight:700">âš ï¸ You can proceed to the next task only after this is approved.</span></div></div>';
                    html += '<button id="shCheckBtn_' + t.id + '" onclick="shCheckTaskApproval(\'' + t.id + '\', this)" style="background:#ff9800;color:white;border:none;padding:7px 14px;border-radius:18px;cursor:pointer;font-size:0.82em;font-weight:700;display:flex;align-items:center;gap:5px;white-space:nowrap">ðŸ”„ Check Approval</button></div>';
                }
            }
            if (sub && sub.photoUrl) html += '<div style="margin:10px 0"><img src="' + sub.photoUrl + '" class="sh-preview-img" onclick="shViewPhoto(this.src)" title="Click to enlarge"></div>';

            // -- MULTI-PART TASK LOGIC --------------------------------------
            const taskParts = t.parts && t.parts.length ? t.parts : null;
            if (taskParts) {
                // Show overview bar of all parts
                const subParts = (sub && sub.parts) ? sub.parts : [];
                html += '<div style="background:#f3e5f5;border-left:4px solid #9c27b0;border-radius:8px;padding:10px 14px;margin-bottom:14px;font-size:0.88em">';
                html += '<strong style="color:#6a1b9a">ðŸ“‹ This task has ' + taskParts.length + ' parts</strong> â€” each part needs admin approval before the next unlocks.<br>';
                html += '<div style="display:flex;flex-wrap:wrap;gap:6px;margin-top:8px">';
                taskParts.forEach((pName, pi) => {
                    const ps = subParts[pi];
                    const icon = !ps ? 'â¬œ' : ps.status === 'approved' ? 'âœ…' : ps.status === 'rejected' ? 'âŒ' : 'â³';
                    html += '<span style="background:white;border:1px solid #ce93d8;border-radius:6px;padding:3px 8px;font-size:0.82em">' + icon + ' Part ' + (pi+1) + '</span>';
                });
                html += '</div></div>';

                if (state === 'active' || state === 'rejected') {
                    // Find the first part that needs action (not approved yet)
                    let activePartIdx = 0;
                    for (let pi = 0; pi < taskParts.length; pi++) {
                        const ps = subParts[pi];
                        if (ps && ps.status === 'approved') { activePartIdx = pi + 1; continue; }
                        if (ps && ps.status === 'pending') {
                            // This part is under review â€” show waiting
                            html += '<div style="background:#fff3e0;border:2px solid #ff9800;border-radius:8px;padding:12px 14px;margin-bottom:10px">';
                            html += '<strong style="color:#e65100">â³ Part ' + (pi+1) + ' Under Review</strong><br>';
                            html += '<span style="font-size:0.85em;color:#666">Part ' + (pi+2) + ' will unlock after Part ' + (pi+1) + ' is approved.</span></div>';
                        } else {
                            // This part needs to be submitted (new or rejected)
                            if (ps && ps.status === 'rejected') {
                                html += '<div style="background:#ffebee;border:2px solid #f44336;border-radius:8px;padding:10px 14px;margin-bottom:10px">';
                                html += '<strong style="color:#c62828">âŒ Part ' + (pi+1) + ' Rejected â€” Please reupload</strong>';
                                if (ps.rejectionReason) html += '<div style="margin-top:6px;font-size:0.85em;background:#fff0f0;border-left:3px solid #f44336;padding:7px 10px;border-radius:0 6px 6px 0"><strong>ðŸ“ Reason:</strong> ' + shEsc(ps.rejectionReason) + '</div>';
                                html += '</div>';
                            }
                            if (ps && ps.photoUrl) html += '<div style="margin:8px 0;font-size:0.82em;color:#6a1b9a;font-weight:700">ðŸ“¸ Part ' + (pi+1) + ' previous photo:</div><div style="margin:6px 0"><img src="' + ps.photoUrl + '" class="sh-preview-img" onclick="shViewPhoto(this.src)"></div>';
                            html += '<div style="font-weight:700;color:#6a1b9a;margin-bottom:6px">ðŸ“¸ Part ' + (pi+1) + ': ' + shEsc(taskParts[pi]) + '</div>';
                            const fpid = 'shPartFile_' + t.id + '_' + pi;
                            html += '<div class="sh-upload-zone" id="shPartZone_' + t.id + '_' + pi + '" onclick="document.getElementById(\'' + fpid + '\').click()">';
                            html += '<div style="font-size:2em;margin-bottom:8px">ðŸ“¸</div>';
                            html += '<p style="color:#9c27b0;font-weight:600;margin:0">Tap to take / upload Part ' + (pi+1) + ' photo</p>';
                            html += '<p style="color:#999;font-size:0.85em;margin:4px 0 0">JPG/PNG, max 5MB</p>';
                            html += '<input type="file" id="' + fpid + '" accept="image/*" capture="environment" style="display:none" onchange="shPartFileSelected(\'' + t.id + '\',' + pi + ',this)">';
                            html += '<img id="shPartThumb_' + t.id + '_' + pi + '" class="sh-preview-img" style="display:none"></div>';
                            html += '<div style="margin-top:12px">';
                            html += '<label style="display:block;font-weight:700;color:#6a1b9a;margin-bottom:6px;font-size:.95em">ðŸ’¬ Comment for Part ' + (pi+1) + ' <span style="color:#f44336">*</span></label>';
                            html += '<textarea id="shPartComment_' + t.id + '_' + pi + '" rows="2" placeholder="Describe what you did for this part..." style="width:100%;padding:10px 14px;border:2px solid #9c27b0;border-radius:8px;font-size:.95em;resize:vertical;font-family:inherit;box-sizing:border-box"></textarea>';
                            html += '</div>';
                            html += '<button class="btn btn-success" style="margin-top:10px;width:100%" onclick="shUploadPart(\'' + t.id + '\',' + pi + ',' + taskParts.length + ')">ðŸ“¤ Submit Part ' + (pi+1) + ' Photo</button>';
                            html += '<div id="shPartUploadMsg_' + t.id + '_' + pi + '" style="margin-top:8px;font-size:0.9em;display:none"></div>';
                        }
                        break; // Only show one part at a time
                    }
                    // If all parts done (approved), nothing more to show
                    if (activePartIdx >= taskParts.length) {
                        html += '<div style="background:#e8f5e9;border:2px solid #4caf50;border-radius:8px;padding:12px;text-align:center;font-weight:700;color:#2e7d32">ðŸŽ‰ All parts submitted and approved!</div>';
                    }
                } else if (state === 'pending') {
                    // Find which part is pending
                    for (let pi = 0; pi < taskParts.length; pi++) {
                        const ps = subParts[pi];
                        if (ps && ps.status === 'pending') {
                            html += '<div style="background:#fff3e0;border:2px solid #ff9800;border-radius:8px;padding:10px 14px;margin-bottom:8px;display:flex;align-items:center;gap:8px">';
                            html += '<span style="font-size:1.3em">â³</span><div><strong style="color:#e65100">Part ' + (pi+1) + ' Under Review</strong><br>';
                            html += '<span style="font-size:0.78em;color:#666">Waiting for admin approval</span></div></div>';
                        }
                    }
                }
            } else {
                // -- SINGLE-PHOTO TASK (original flow) ---------------------
                if (state==='active' || state==='rejected') {
                    const fid = 'shFileInput_' + t.id;
                    html += '<div class="sh-upload-zone" id="shZone_' + t.id + '" onclick="document.getElementById(\'' + fid + '\').click()">';
                    html += '<div style="font-size:2em;margin-bottom:8px">ðŸ“¸</div>';
                    html += '<p style="color:#9c27b0;font-weight:600;margin:0">Tap to take / upload photo proof</p>';
                    html += '<p style="color:#999;font-size:0.85em;margin:4px 0 0">JPG/PNG, max 5MB</p>';
                    html += '<input type="file" id="' + fid + '" accept="image/*" capture="environment" style="display:none" onchange="shFileSelected(\'' + t.id + '\',this)">';
                    html += '<img id="shThumb_' + t.id + '" class="sh-preview-img" style="display:none"></div>';
                    if (shSettings.gps && t.lat && t.lng) html += '<div id="shDistInfo_' + t.id + '" style="margin-top:8px;font-size:0.88em;color:#1565c0">ðŸ“¡ Checking distance...</div>';
                    html += '<div style="margin-top:14px">';
                    html += '<label style="display:block;font-weight:700;color:#6a1b9a;margin-bottom:6px;font-size:.95em">ðŸ’¬ Your Comment <span style="color:#f44336">*</span> <span style="font-weight:normal;color:#888;font-size:.85em">(required)</span></label>';
                    html += '<textarea id="shComment_' + t.id + '" rows="3" placeholder="Describe what you did, who you met, or anything interesting about completing this task..." style="width:100%;padding:10px 14px;border:2px solid #9c27b0;border-radius:8px;font-size:.95em;resize:vertical;font-family:inherit;box-sizing:border-box" oninput="shCommentChanged(\'' + t.id + '\')"></textarea>';
                    html += '<p style="color:#f44336;font-size:.82em;margin:4px 0 0;display:none" id="shCommentErr_' + t.id + '">âš ï¸ Please write a comment before submitting.</p>';
                    html += '</div>';
                    html += '<button class="btn btn-success" style="margin-top:12px;width:100%" onclick="shUploadPhoto(\'' + t.id + '\')">ðŸ“¤ Submit Photo + Comment</button>';
                    html += '<div id="shUploadMsg_' + t.id + '" style="margin-top:8px;font-size:0.9em;display:none"></div>';
                }
            }
            html += '</div>';
        });
        el.innerHTML = html;
        if (shUserLat !== null) shUpdateDistances();
    }

    // -- N-Parts: dynamic part input helpers ---------------------------
    // -- Task image preview helpers ------------------------------------
    function shPreviewNewTaskImage(input) {
        const file = input.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = e => {
            document.getElementById('shNewTaskImagePreviewImg').src = e.target.result;
            document.getElementById('shNewTaskImagePreview').style.display = 'block';
        };
        reader.readAsDataURL(file);
    }
    function shClearNewTaskImage() {
        document.getElementById('shNewTaskImageFile').value = '';
        document.getElementById('shNewTaskImagePreview').style.display = 'none';
        document.getElementById('shNewTaskImageMsg').textContent = 'Image will upload automatically when you save the task.';
        document.getElementById('shNewTaskImageMsg').style.color = '#888';
    }
    function shPreviewEditTaskImage(input) {
        const file = input.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = e => {
            document.getElementById('shEditImagePreviewImg').src = e.target.result;
            document.getElementById('shEditImagePreview').style.display = 'block';
        };
        reader.readAsDataURL(file);
    }
    function shClearEditTaskImage() {
        document.getElementById('shEditImageFile').value = '';
        document.getElementById('shEditImagePreview').style.display = 'none';
    }
    function shRemoveEditCurrentImage() {
        document.getElementById('shEditCurrentImageUrl').value = '';
        document.getElementById('shEditImageCurrentBox').innerHTML = '<span style="font-size:0.82em;color:#aaa">Image removed. Save to confirm.</span>';
    }

    function shAddNewTaskPart(value) {
        const box = document.getElementById('shNewTaskPartsBox');
        const idx = box.children.length;
        const row = document.createElement('div');
        row.style.cssText = 'display:flex;gap:6px;align-items:center';
        row.innerHTML = '<span style="font-size:0.82em;font-weight:700;color:#9c27b0;min-width:52px">Part '+(idx+1)+':</span>'
            +'<input type="text" class="sh-part-input" value="'+(value||'')+'" placeholder="Describe what to photo for this part" style="flex:1;padding:7px 10px;border:1.5px solid #ce93d8;border-radius:7px;font-size:0.92em">'
            +'<button type="button" onclick="this.parentElement.remove();shRenumberParts(\'shNewTaskPartsBox\')" style="background:#ffebee;color:#c62828;border:1px solid #ef9a9a;border-radius:6px;padding:4px 8px;cursor:pointer;font-size:0.82em">âœ•</button>';
        box.appendChild(row);
    }

    function shAddEditPart(value, num) {
        const box = document.getElementById('shEditPartsBox');
        const idx = num !== undefined ? num - 1 : box.children.length;
        const row = document.createElement('div');
        row.style.cssText = 'display:flex;gap:6px;align-items:center';
        row.innerHTML = '<span style="font-size:0.82em;font-weight:700;color:#9c27b0;min-width:52px">Part '+(idx+1)+':</span>'
            +'<input type="text" class="sh-part-input" value="'+(value||'')+'" placeholder="Describe what to photo for this part" style="flex:1;padding:7px 10px;border:1.5px solid #ce93d8;border-radius:7px;font-size:0.92em">'
            +'<button type="button" onclick="this.parentElement.remove();shRenumberParts(\'shEditPartsBox\')" style="background:#ffebee;color:#c62828;border:1px solid #ef9a9a;border-radius:6px;padding:4px 8px;cursor:pointer;font-size:0.82em">âœ•</button>';
        box.appendChild(row);
    }

    function shRenumberParts(boxId) {
        const box = document.getElementById(boxId);
        if (!box) return;
        Array.from(box.children).forEach((row, i) => {
            const lbl = row.querySelector('span');
            if (lbl) lbl.textContent = 'Part ' + (i+1) + ':';
        });
    }

    // -- N-Parts: student part file selection & upload -----------------
    function shPartFileSelected(taskId, partIdx, input) {
        if (!input.files || !input.files[0]) return;
        const reader = new FileReader();
        reader.onload = e => {
            const thumb = document.getElementById('shPartThumb_' + taskId + '_' + partIdx);
            const zone  = document.getElementById('shPartZone_'  + taskId + '_' + partIdx);
            if (thumb) { thumb.src = e.target.result; thumb.style.display = 'block'; }
            if (zone)  zone.classList.add('has-file');
        };
        reader.readAsDataURL(input.files[0]);
    }

    async function shUploadPart(taskId, partIdx, totalParts) {
        const input   = document.getElementById('shPartFile_'       + taskId + '_' + partIdx);
        const msgEl   = document.getElementById('shPartUploadMsg_'  + taskId + '_' + partIdx);
        const comment = (document.getElementById('shPartComment_'   + taskId + '_' + partIdx)?.value || '').trim();
        if (!input || !input.files || !input.files[0]) { shShowInlineMsg(msgEl,'error','ðŸ“¸ Select a photo first.'); return; }
        if (!comment) { shShowInlineMsg(msgEl,'error','âš ï¸ Please write a comment.'); return; }
        if (input.files[0].size > 5*1024*1024) { shShowInlineMsg(msgEl,'error','âŒ File too large. Max 5MB.'); return; }

        // Server-side guard: verify previous parts are approved
        const existingSnap = await window.db.ref('scavengerHunt/submissions/'+shCurrentUser.key+'/'+taskId).once('value');
        const existing = existingSnap.val() || {};
        const subParts = existing.parts || [];
        if (partIdx > 0) {
            const prevPart = subParts[partIdx - 1];
            if (!prevPart || prevPart.status !== 'approved') {
                shShowInlineMsg(msgEl,'error','ðŸ”’ Part ' + partIdx + ' must be approved before submitting Part ' + (partIdx+1) + '.'); return;
            }
        }

        shShowInlineMsg(msgEl,'info','â³ Uploading Part ' + (partIdx+1) + ' to storage...');
        try {
            const photoUrl = await shUploadToStorage(input.files[0], shCurrentUser.key, taskId, 'part' + partIdx);
            const newParts = [...subParts];
            newParts[partIdx] = { photoUrl, status: 'pending', comment, submittedAt: new Date().toISOString() };

            // If this is Part 1 (first ever submission), create the main sub record too
            if (partIdx === 0) {
                await window.db.ref('scavengerHunt/submissions/'+shCurrentUser.key+'/'+taskId).set({
                    taskId, taskName: shTasks.find(t=>t.id===taskId)?.name || '',
                    status: 'pending', submittedAt: new Date().toISOString(),
                    parts: newParts
                });
            } else {
                await window.db.ref('scavengerHunt/submissions/'+shCurrentUser.key+'/'+taskId+'/parts/'+partIdx).set(newParts[partIdx]);
            }
            shShowInlineMsg(msgEl,'success','âœ… Part ' + (partIdx+1) + ' submitted! Waiting for admin review.');
            setTimeout(() => shLoadStudentDashboard(), 1500);
        } catch(e) {
            shShowInlineMsg(msgEl,'error','âŒ Upload failed: '+e.message);
        }
    }

    // -- GPS ------------------------------------------------------------
    function shGetLocation() {
        const statusEl = document.getElementById('shGpsStatusText');
        if (!navigator.geolocation) { if(statusEl) statusEl.textContent='âš ï¸ GPS not available.'; return; }
        if (statusEl) statusEl.textContent = 'ðŸ”„ Getting location...';
        if (shGpsWatchId) navigator.geolocation.clearWatch(shGpsWatchId);
        shGpsWatchId = navigator.geolocation.watchPosition(
            pos => {
                shUserLat = pos.coords.latitude; shUserLng = pos.coords.longitude;
                if (statusEl) statusEl.textContent = 'âœ… Location found (Â±' + Math.round(pos.coords.accuracy) + 'm)';
                shUpdateDistances();
            },
            err => { if(statusEl) statusEl.textContent = 'âŒ ' + (err.message||'Location denied'); },
            { enableHighAccuracy:true, maximumAge:10000, timeout:15000 }
        );
    }

    function shUpdateDistances() {
        shTasks.forEach(t => {
            if (!t.lat || !t.lng) return;
            const el = document.getElementById('shDistInfo_' + t.id);
            if (!el) return;
            const dist = Math.round(shHaversine(shUserLat, shUserLng, t.lat, t.lng));
            const radius = shSettings.radius || 100;
            el.innerHTML = dist <= radius
                ? '<span style="color:#2e7d32;font-weight:700">âœ… You are ' + dist + 'm away â€” within range!</span>'
                : '<span style="color:#c62828">â— You are ' + dist + 'm away. Move closer (need ' + radius + 'm).</span>';
        });
    }

    function shHaversine(lat1,lon1,lat2,lon2) {
        const R=6371000, dLat=(lat2-lat1)*Math.PI/180, dLon=(lon2-lon1)*Math.PI/180;
        const a=Math.sin(dLat/2)*Math.sin(dLat/2)+Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)*Math.sin(dLon/2);
        return R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
    }

    // -- File preview ---------------------------------------------------
    function shFileSelected(taskId, input) {
        if (!input.files || !input.files[0]) return;
        const reader = new FileReader();
        reader.onload = e => {
            const thumb = document.getElementById('shThumb_' + taskId);
            const zone  = document.getElementById('shZone_' + taskId);
            if (thumb) { thumb.src = e.target.result; thumb.style.display = 'block'; }
            if (zone)  zone.classList.add('has-file');
        };
        reader.readAsDataURL(input.files[0]);
    }

    // -- Upload photo ---------------------------------------------------
    async function shUploadPhoto(taskId) {
        const task    = shTasks.find(t => t.id === taskId);
        const input   = document.getElementById('shFileInput_' + taskId);
        const msgEl   = document.getElementById('shUploadMsg_' + taskId);
        const btnEl   = document.querySelector('#shTask_' + taskId + ' .btn-success');
        const comment = (document.getElementById('shComment_' + taskId)?.value || '').trim();
        const commentErr = document.getElementById('shCommentErr_' + taskId);

        // Validate photo
        if (!input || !input.files || !input.files[0]) { shShowInlineMsg(msgEl,'error','ðŸ“¸ Select a photo first.'); return; }

        // Validate comment â€” REQUIRED
        if (!comment) {
            if (commentErr) { commentErr.style.display = 'block'; }
            document.getElementById('shComment_' + taskId)?.focus();
            shShowInlineMsg(msgEl,'error','ðŸ’¬ Please write a comment before submitting.');
            return;
        }
        if (commentErr) commentErr.style.display = 'none';
        if (shSettings.gps && task.lat && task.lng) {
            if (shUserLat===null) { shShowInlineMsg(msgEl,'error','âŒ GPS not ready. Wait and retry.'); return; }
            const dist = shHaversine(shUserLat,shUserLng,task.lat,task.lng);
            if (dist > (shSettings.radius||100)) { shShowInlineMsg(msgEl,'error','âŒ Too far! '+Math.round(dist)+'m away. Need '+( shSettings.radius||100)+'m.'); return; }
        }
        // -- Server-side chain guard (re-verify before writing) -------------
        // Re-fetch the full task list and submissions from Firebase right now
        // to enforce the sequential chain even if the UI state is stale or
        // a previous task was deleted and caused an incorrect index offset.
        try {
            const [liveTaskSnap, liveSubSnap] = await Promise.all([
                window.db.ref('scavengerHunt/tasks').once('value'),
                window.db.ref('scavengerHunt/submissions/'+shCurrentUser.key).once('value')
            ]);
            const liveTasksRaw  = liveTaskSnap.val() || {};
            const liveTasks     = Object.entries(liveTasksRaw)
                                    .map(([k,v])=>({id:k,...v}))
                                    .sort((a,b)=>(a.order||0)-(b.order||0));
            const liveSubs      = liveSubSnap.val() || {};
            // Find where this task sits in the live sorted list
            const liveTaskIdx   = liveTasks.findIndex(t => t.id === taskId);
            const liveMinOrder  = liveTasks.length > 0 ? (liveTasks[0].order || 1) : 1;
            const liveTaskOrder = liveTaskIdx >= 0 ? (liveTasks[liveTaskIdx].order || (liveTaskIdx+1)) : 999;
            // Count consecutive approved tasks from the beginning of the live list
            let liveApprovedCount = 0;
            for (let i = 0; i < liveTasks.length; i++) {
                const s = liveSubs[liveTasks[i].id];
                if (s && s.status === 'approved' && s.submittedAt) { liveApprovedCount++; }
                else { break; }
            }
            // Gate: task at liveTaskIdx=0 only if it genuinely has the minimum order;
            // otherwise require all prior tasks to be approved
            // liveTaskIdx===0 = first task in sorted list = always allow submission
            const liveAllPrevOk = (liveTaskIdx === 0) || liveApprovedCount >= liveTaskIdx;
            if (!liveAllPrevOk) {
                shShowInlineMsg(msgEl,'error','ðŸ”’ Cannot submit: previous task(s) must be approved first.');
                return;
            }
        } catch(chainErr) {
            console.error('Chain guard error:', chainErr);
            shShowInlineMsg(msgEl,'error','âŒ Could not verify task chain. Please retry.');
            return;
        }
        // -- End chain guard ------------------------------------------------
        if (btnEl) { btnEl.disabled=true; btnEl.textContent='â³ Uploading...'; }
        shShowInlineMsg(msgEl,'info','â³ Uploading photo to storage...');
        try {
            const file = input.files[0];
            if (file.size > 5*1024*1024) { shShowInlineMsg(msgEl,'error','âŒ File too large. Max 5MB.'); if(btnEl){btnEl.disabled=false;btnEl.textContent='ðŸ“¤ Submit Photo Proof';} return; }
            const photoUrl = await shUploadToStorage(file, shCurrentUser.key, taskId, 'p1');
            const subData = {
                taskId, taskName:task.name,
                studentKey:shCurrentUser.key, studentName:shCurrentUser.name,
                studentEmail:shCurrentUser.email, studentClass:shCurrentUser.class||shCurrentUser.classYear||'',
                photoUrl,
                comment: comment,
                status: shSettings.autoApprove && (!shSettings.gps||!task.lat) ? 'approved' : 'pending',
                submittedAt:new Date().toISOString(), lat:shUserLat, lng:shUserLng
            };
            await window.db.ref('scavengerHunt/submissions/'+shCurrentUser.key+'/'+taskId).set(subData);
            shShowInlineMsg(msgEl,'success','âœ… Submitted! '+(subData.status==='approved'?'Auto-approved!':'Waiting for admin review.'));
            if(btnEl){btnEl.disabled=false;btnEl.textContent='ðŸ“¤ Submit Photo Proof';}
            setTimeout(() => shLoadStudentDashboard(), 1500);
        } catch(e) {
            shShowInlineMsg(msgEl,'error','âŒ Upload failed: '+e.message);
            if(btnEl){btnEl.disabled=false;btnEl.textContent='ðŸ“¤ Submit Photo Proof';}
        }
    }

    function shResetSubmissionFilters() {
        const sf = document.getElementById('shSubmissionFilter');
        const df = document.getElementById('shSubmissionDateFilter');
        const tf = document.getElementById('shSubmissionTaskFilter');
        if (sf) sf.value = 'all';
        if (df) df.value = 'all';
        if (tf) tf.value = 'all';
        shAdminLoadSubmissions();
    }

    function shCommentChanged(taskId) {
        const val = (document.getElementById('shComment_' + taskId)?.value || '').trim();
        const err = document.getElementById('shCommentErr_' + taskId);
        if (err) err.style.display = val ? 'none' : 'block';
    }

    // -- Upload photo to Cloudinary, return secure URL -----------------
    // Cloud: dat0khbet | Preset: scavenger_hunt (unsigned)
    async function shUploadToStorage(file, studentKey, taskId, partLabel) {
        const formData = new FormData();
        formData.append('file', file);
        formData.append('upload_preset', 'scavenger_hunt');
        formData.append('folder', 'scavenger_hunt/' + studentKey);
        formData.append('public_id', taskId + '_' + partLabel + '_' + Date.now());
        const res = await fetch('https://api.cloudinary.com/v1_1/dat0khbet/image/upload', {
            method: 'POST',
            body: formData
        });
        if (!res.ok) {
            const err = await res.json();
            throw new Error(err.error?.message || 'Cloudinary upload failed');
        }
        const data = await res.json();
        return data.secure_url;
    }

    // Keep shFileToBase64 only for thumbnail previews (not used for storage anymore)
    function shFileToBase64(file) {
        return new Promise((res,rej) => { const r=new FileReader(); r.onload=()=>res(r.result); r.onerror=rej; r.readAsDataURL(file); });
    }

    // -- Photo lightbox -------------------------------------------------
    function shViewPhoto(src) {
        const d = document.createElement('div');
        d.className = 'sh-photo-modal';
        d.onclick = () => document.body.removeChild(d);
        d.innerHTML = '<img src="' + src + '" alt="proof"><br><span style="color:white;font-size:0.85em;margin-top:10px;display:block;text-align:center">Click anywhere to close</span>';
        document.body.appendChild(d);
    }

    // -- Admin Tab switching -------------------------------------------
    function shAdminTab(id, btn) {
        ['shAdminTasks','shAdminSubmissions','shAdminLeaderboard','shAdminClasswise','shAdminWinners','shAdminSettings'].forEach(pid => {
            const el = document.getElementById(pid);
            if (el) el.style.display = (pid===id) ? 'block' : 'none';
        });
        document.querySelectorAll('#scavengerAdmin .tabs .tab').forEach(t => t.classList.remove('active'));
        if (btn) btn.classList.add('active');
        if (id==='shAdminTasks')       shAdminLoadTasks();
        if (id==='shAdminSubmissions') shAdminLoadSubmissions();
        if (id==='shAdminLeaderboard') shAdminLoadLeaderboard();
        if (id==='shAdminClasswise')   shAdminLoadClasswise();
        if (id==='shAdminWinners')     { shLoadWinnersTab(); shInitAutoDeclarScheduler(); }
        if (id==='shAdminSettings')    { shAdminLoadSettings(); shPopulateAfsTaskDropdown(); }
    }

    // -- Admin: Create task ---------------------------------------------
    async function shAdminCreateTask() {
        const name     = document.getElementById('shNewTaskName').value.trim();
        const hint     = document.getElementById('shNewTaskHint').value.trim();
        const order    = parseInt(document.getElementById('shNewTaskOrder').value)||1;
        const lat      = parseFloat(document.getElementById('shNewTaskLat').value)||null;
        const lng      = parseFloat(document.getElementById('shNewTaskLng').value)||null;
        if (!name) { alert('Task name is required'); return; }
        const availFrom = document.getElementById('shNewTaskDate').value;
        const deadline  = document.getElementById('shNewTaskDeadline').value;
        // Collect parts from dynamic fields
        const partInputs = document.querySelectorAll('#shNewTaskPartsBox .sh-part-input');
        const parts = [];
        partInputs.forEach(inp => { const v = inp.value.trim(); if (v) parts.push(v); });

        // Upload image if selected
        const imgFile = document.getElementById('shNewTaskImageFile').files[0];
        let imageUrl = null;
        if (imgFile) {
            const msgEl = document.getElementById('shNewTaskImageMsg');
            msgEl.textContent = 'â³ Uploading imageâ€¦';
            msgEl.style.color = '#1565c0';
            try {
                const fd = new FormData();
                fd.append('file', imgFile);
                fd.append('upload_preset', 'scavenger_hunt');
                fd.append('folder', 'scavenger_hunt/task_images');
                fd.append('public_id', 'task_img_' + Date.now());
                const res = await fetch('https://api.cloudinary.com/v1_1/dat0khbet/image/upload', { method:'POST', body:fd });
                if (!res.ok) throw new Error((await res.json()).error?.message || 'Upload failed');
                imageUrl = (await res.json()).secure_url;
                msgEl.textContent = 'âœ… Image uploaded!';
                msgEl.style.color = '#2e7d32';
            } catch(e) {
                alert('Image upload failed: ' + e.message + '\nTask not saved. Please try again.');
                document.getElementById('shNewTaskImageMsg').textContent = 'âŒ Upload failed â€” try again';
                document.getElementById('shNewTaskImageMsg').style.color = '#c62828';
                return;
            }
        }

        const task = { name, order, createdAt:new Date().toISOString() };
        if (hint)          task.hint  = hint;
        if (imageUrl)      task.image = imageUrl;
        if (parts.length)  task.parts = parts;
        if (lat && lng) { task.lat=lat; task.lng=lng; }
        if (availFrom)  task.availableFrom = new Date(availFrom).toISOString();
        if (deadline)   task.deadline      = new Date(deadline).toISOString();
        await window.db.ref('scavengerHunt/tasks').push(task);

        // Show brief success badge
        const msgEl = document.getElementById('shCreateTaskMsg');
        msgEl.style.display = 'inline-block';
        setTimeout(()=>{ msgEl.style.display='none'; }, 3000);

        // Reset form
        document.getElementById('shNewTaskName').value     = '';
        document.getElementById('shNewTaskHint').value     = '';
        document.getElementById('shNewTaskPartsBox').innerHTML = '';
        document.getElementById('shNewTaskOrder').value    = order + 1;
        document.getElementById('shNewTaskLat').value      = '';
        document.getElementById('shNewTaskLng').value      = '';
        document.getElementById('shNewTaskDate').value     = '';
        document.getElementById('shNewTaskDeadline').value = '';
        document.getElementById('shNewTaskImageFile').value = '';
        document.getElementById('shNewTaskImagePreview').style.display = 'none';
        document.getElementById('shNewTaskImageMsg').textContent = 'Image will upload automatically when you save the task.';
        document.getElementById('shNewTaskImageMsg').style.color = '#888';
        // Reload tasks list â€” this also rebuilds the WhatsApp message for ALL tasks
        shAdminLoadTasks();
    }

    function shCopyWaMsg() {
        const ta = document.getElementById('shWaText');
        ta.select();
        try {
            navigator.clipboard.writeText(ta.value).then(() => {
                const btn = document.getElementById('shWaCopyBtn');
                const orig = btn.textContent;
                btn.textContent = 'âœ… Copied!';
                btn.style.background = '#28a745';
                setTimeout(() => { btn.textContent = orig; btn.style.background = ''; }, 2500);
            });
        } catch(e) {
            document.execCommand('copy');
            document.getElementById('shWaCopyBtn').textContent = 'âœ… Copied!';
            setTimeout(() => { document.getElementById('shWaCopyBtn').textContent = 'ðŸ“‹ Copy Message'; }, 2500);
        }
    }

    // -- Build WhatsApp message for ALL tasks --------------------------
    function shBuildWaMsg(tasks) {
        const fmtDT = iso => iso ? new Date(iso).toLocaleString('en-IN',{
            weekday:'short', day:'2-digit', month:'short', year:'numeric',
            hour:'2-digit', minute:'2-digit', hour12:true
        }) : null;

        if (!tasks || !tasks.length) {
            document.getElementById('shWaText').value = '(No tasks yet â€” create a task above to generate the announcement message)';
            return;
        }

        const lines = [
            `ðŸ—ºï¸ *SCAVENGER HUNT â€” SPURTHI YOUTH FEST 2026*`,
            `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”`,
            ``
        ];

        tasks.forEach((t, i) => {
            const num      = t.order || (i + 1);
            const fromFmt  = t.availableFrom ? fmtDT(t.availableFrom) : null;
            const tillFmt  = t.deadline      ? fmtDT(t.deadline)      : null;
            const hasGPS   = t.lat && t.lng;

            // Task header
            lines.push(`ðŸ“Œ *Task ${num}*`);
            lines.push(`â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”`);

            // Task description (full name â€” may be long, show as-is)
            lines.push(`${t.name}`);
            lines.push(``);

            // Hint
            if (t.hint) lines.push(`ðŸ’¡ *Hint:* ${t.hint}`);

            // Timing
            lines.push(fromFmt  ? `â° *Starts :* ${fromFmt}`   : `â° *Starts :* Immediately`);
            lines.push(tillFmt  ? `ðŸ”š *Deadline :* ${tillFmt}` : `ðŸ”š *Deadline :* No deadline`);

            // GPS
            if (hasGPS) lines.push(`ðŸ“ *Location:* GPS-verified task`);

            // Separator between tasks
            if (i < tasks.length - 1) lines.push(``);
        });

        lines.push(``);
        lines.push(`â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”`);
        lines.push(`ðŸ“¸ *How to participate:*`);
        lines.push(`1ï¸âƒ£ Go to: https://davandegree.github.io/spurthi/`);
        lines.push(`2ï¸âƒ£ Select Online Competition â†’ Scavenger Hunt`);
        lines.push(`3ï¸âƒ£ Login with your registered number`);
        lines.push(`4ï¸âƒ£ Complete the task & upload your photo`);
        lines.push(``);
        lines.push(`âš¡ *Be quick â€” points awarded on approval!*`);
        lines.push(``);
        lines.push(`ðŸŽ‰ _Spurthi Youth Fest 2026 â€” Davan Institute_`);
        lines.push(`ðŸ”— https://harshgujjar.github.io/Spurthi-youth-fest-2026/`);

        document.getElementById('shWaText').value = lines.join('\n');
    }

    async function shAdminLoadTasks() {
        const el = document.getElementById('shAdminTasksList');
        if(!el) return;
        el.innerHTML = '<p style="color:#999">Loading...</p>';
        try {
            const snap  = await window.db.ref('scavengerHunt/tasks').once('value');
            window._shTasksCache = snap.val() || {};
            const tasks = Object.entries(window._shTasksCache).map(([k,v])=>({id:k,...v})).sort((a,b)=>(a.order||0)-(b.order||0));
            // Always refresh WhatsApp message with current task list
            shBuildWaMsg(tasks);
            if (!tasks.length) { el.innerHTML='<p style="color:#999">No tasks yet. Create one above.</p>'; return; }

            let html = '';

            // -- Inline Edit Panel (hidden by default) --------------------------
            html += '<div id="shEditPanel" style="display:none;background:#f3e5f5;border:2px solid #9c27b0;border-radius:10px;padding:18px;margin-bottom:18px">';
            html += '<h4 style="color:#6a1b9a;margin:0 0 14px">âœï¸ Edit Task</h4>';
            html += '<div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:14px">';
            html += '<div class="form-group" style="margin:0"><label style="font-size:12px;font-weight:700;color:#6a1b9a">Task Name:</label><input id="shEditName" type="text" style="width:100%"></div>';
            html += '<div class="form-group" style="margin:0"><label style="font-size:12px;font-weight:700;color:#6a1b9a">Hint / Clue:</label><input id="shEditHint" type="text" style="width:100%"></div>';
            html += '<div class="form-group" style="margin:0"><label style="font-size:12px;font-weight:700;color:#6a1b9a">Task Order / Number:</label><input id="shEditOrder" type="number" min="1" style="width:100px"></div>';
            html += '<div class="form-group" style="grid-column:1/-1;margin:0"><label style="font-size:12px;font-weight:700;color:#6a1b9a">ðŸ–¼ï¸ Task Image (optional):</label>';
            html += '<div id="shEditImageCurrentBox" style="margin-bottom:8px"></div>';
            html += '<input type="file" id="shEditImageFile" accept="image/*" onchange="shPreviewEditTaskImage(this)" style="display:block;margin-bottom:6px">';
            html += '<div id="shEditImagePreview" style="display:none;margin-bottom:6px"><img id="shEditImagePreviewImg" style="max-width:200px;max-height:140px;border-radius:8px;border:2px solid #ce93d8" alt="preview"><button type="button" onclick="shClearEditTaskImage()" style="display:block;margin-top:4px;background:#ffebee;color:#c62828;border:1px solid #ef9a9a;border-radius:6px;padding:3px 10px;cursor:pointer;font-size:0.82em">âœ• Remove new image</button></div>';
            html += '<span id="shEditImageMsg" style="font-size:0.82em;color:#888">Upload a new image to replace, or leave empty to keep existing.</span></div>';
            html += '<div class="form-group" style="grid-column:1/-1;margin:0"><label style="font-size:12px;font-weight:700;color:#9c27b0">ðŸ“¸ Task Parts (multi-photo, optional):</label>';
            html += '<div id="shEditPartsBox" style="display:flex;flex-direction:column;gap:6px;margin-bottom:6px"></div>';
            html += '<button type="button" onclick="shAddEditPart()" style="background:#e8f5e9;color:#2e7d32;border:2px dashed #4caf50;border-radius:8px;padding:5px 12px;cursor:pointer;font-size:0.85em;font-weight:700">âž• Add Part</button>';
            html += '<span style="font-size:0.78em;color:#888;display:block;margin-top:3px">Each part = one photo. Leave empty = single-photo task.</span></div>';
            html += '<div class="form-group" style="margin:0"><label style="font-size:12px;font-weight:700;color:#6a1b9a">ðŸ“… Available From:</label><input id="shEditFrom" type="datetime-local" style="padding:7px 10px;border:2px solid #9c27b0;border-radius:8px;font-size:0.93em"></div>';
            html += '<div class="form-group" style="margin:0"><label style="font-size:12px;font-weight:700;color:#6a1b9a">â° Available Until:</label><input id="shEditTill" type="datetime-local" style="padding:7px 10px;border:2px solid #e91e63;border-radius:8px;font-size:0.93em"></div>';
            html += '<div class="form-group" style="margin:0"><label style="font-size:12px;font-weight:700;color:#1565c0">ðŸ“ GPS Lat / Lng (optional):</label>';
            html += '<div style="display:flex;gap:8px"><input id="shEditLat" type="number" step="0.000001" placeholder="Latitude" style="width:130px"><input id="shEditLng" type="number" step="0.000001" placeholder="Longitude" style="width:130px"></div></div>';
            html += '</div>';
            html += '<input type="hidden" id="shEditId">';
            html += '<input type="hidden" id="shEditCurrentImageUrl">';
            html += '<div style="display:flex;gap:8px;align-items:center">';
            html += '<button class="btn btn-success" onclick="shAdminSaveTask()">ðŸ’¾ Save Changes</button>';
            html += '<button class="btn btn-secondary" onclick="shAdminCancelEditTask()">âœ– Cancel</button>';
            html += '<span id="shEditMsg" style="font-size:13px;color:#4caf50;display:none;font-weight:600">âœ… Saved!</span>';
            html += '</div></div>';

            // -- Tasks Table ----------------------------------------------------
            html += '<div class="table-wrapper"><table><thead><tr><th>#</th><th>Task</th><th>Image</th><th>Hint</th><th>From</th><th>Until</th><th>GPS</th><th style="min-width:70px">Edit</th><th>Delete</th></tr></thead><tbody>';
            tasks.forEach(t => {
                const gps     = t.lat ? '<span class="sh-gps-badge" style="font-size:0.75em">ðŸ“ Set</span>' : '<span style="color:#999">â€”</span>';
                const fromStr = t.availableFrom ? new Date(t.availableFrom).toLocaleString('en-IN',{day:'2-digit',month:'short',hour:'2-digit',minute:'2-digit',hour12:true}) : 'â€”';
                const tillStr = t.deadline      ? new Date(t.deadline).toLocaleString('en-IN',{day:'2-digit',month:'short',hour:'2-digit',minute:'2-digit',hour12:true}) : 'â€”';
                const imgCell = t.image ? '<img src="'+t.image+'" style="width:48px;height:36px;object-fit:cover;border-radius:5px;border:1px solid #ce93d8;cursor:pointer" onclick="shViewPhoto(\''+t.image+'\')" title="Click to view">' : '<span style="color:#ccc;font-size:0.82em">â€”</span>';
                html += '<tr id="shTaskRow_'+t.id+'">';
                html += '<td><strong>'+(t.order||'-')+'</strong></td>';
                html += '<td>'+shEsc(t.name)+'</td>';
                html += '<td>'+imgCell+'</td>';
                html += '<td style="color:#795548;font-size:0.9em">'+shEsc(t.hint||'â€”')+'</td>';
                html += '<td style="font-size:0.82em;color:#1565c0;white-space:nowrap">'+fromStr+'</td>';
                html += '<td style="font-size:0.82em;color:#c62828;white-space:nowrap">'+tillStr+'</td>';
                html += '<td>'+gps+'</td>';
                html += '<td><button class="btn btn-info btn-small" onclick="shAdminEditTask(\''+t.id+'\')">âœï¸ Edit</button></td>';
                html += '<td><button class="delete-btn" onclick="shAdminDeleteTask(\''+t.id+'\')">ðŸ—‘ï¸</button></td>';
                html += '</tr>';
            });
            html += '</tbody></table></div>';
            el.innerHTML = html;
        } catch(e) { el.innerHTML='<p style="color:red">Error: '+e.message+'</p>'; }
    }

    function shAdminEditTask(id) {
        const t = window._shTasksCache && window._shTasksCache[id];
        if (!t) { alert('Task not found â€” please refresh.'); return; }

        // Populate the edit panel
        document.getElementById('shEditId').value    = id;
        document.getElementById('shEditName').value  = t.name  || '';
        document.getElementById('shEditHint').value  = t.hint  || '';
        document.getElementById('shEditOrder').value = t.order || 1;
        // Populate existing image
        document.getElementById('shEditCurrentImageUrl').value = t.image || '';
        document.getElementById('shEditImageFile').value = '';
        document.getElementById('shEditImagePreview').style.display = 'none';
        const curBox = document.getElementById('shEditImageCurrentBox');
        if (t.image) {
            curBox.innerHTML = '<div style="margin-bottom:6px"><span style="font-size:0.82em;color:#6a1b9a;font-weight:700">Current image:</span><br>'
                + '<img src="'+t.image+'" style="max-width:180px;max-height:120px;border-radius:8px;border:2px solid #ce93d8;margin-top:4px" alt="current">'
                + '<button type="button" onclick="shRemoveEditCurrentImage()" style="display:block;margin-top:4px;background:#ffebee;color:#c62828;border:1px solid #ef9a9a;border-radius:6px;padding:3px 10px;cursor:pointer;font-size:0.82em">ðŸ—‘ï¸ Remove current image</button></div>';
        } else {
            curBox.innerHTML = '<span style="font-size:0.82em;color:#aaa">No image set.</span>';
        }
        // Populate parts
        const editBox = document.getElementById('shEditPartsBox');
        editBox.innerHTML = '';
        (t.parts || []).forEach((p, i) => shAddEditPart(p, i+1));
        document.getElementById('shEditLat').value   = t.lat   || '';
        document.getElementById('shEditLng').value   = t.lng   || '';
        document.getElementById('shEditFrom').value  = t.availableFrom ? new Date(t.availableFrom).toISOString().slice(0,16) : '';
        document.getElementById('shEditTill').value  = t.deadline      ? new Date(t.deadline).toISOString().slice(0,16) : '';
        document.getElementById('shEditMsg').style.display = 'none';

        // Show panel and scroll to it
        const panel = document.getElementById('shEditPanel');
        panel.style.display = 'block';
        panel.scrollIntoView({behavior:'smooth', block:'start'});

        // Highlight the row being edited
        document.querySelectorAll('#shAdminTasksList tr').forEach(r => r.style.background = '');
        const row = document.getElementById('shTaskRow_'+id);
        if (row) row.style.background = '#fce4ec';
    }

    function shAdminCancelEditTask() {
        document.getElementById('shEditPanel').style.display = 'none';
        document.querySelectorAll('#shAdminTasksList tr').forEach(r => r.style.background = '');
    }

    async function shAdminSaveTask() {
        const id    = document.getElementById('shEditId').value;
        const name  = document.getElementById('shEditName').value.trim();
        const hint  = document.getElementById('shEditHint').value.trim();
        const order = parseInt(document.getElementById('shEditOrder').value) || 1;
        const fromV = document.getElementById('shEditFrom').value;
        const tillV = document.getElementById('shEditTill').value;
        const latV  = parseFloat(document.getElementById('shEditLat').value) || null;
        const lngV  = parseFloat(document.getElementById('shEditLng').value) || null;
        if (!name) { alert('Task name is required'); return; }

        // Collect parts from edit panel
        const editPartInputs = document.querySelectorAll('#shEditPartsBox .sh-part-input');
        const editParts = [];
        editPartInputs.forEach(inp => { const v = inp.value.trim(); if (v) editParts.push(v); });

        // Handle image: new file > existing URL > null
        let imageUrl = document.getElementById('shEditCurrentImageUrl').value || null;
        const newImgFile = document.getElementById('shEditImageFile').files[0];
        if (newImgFile) {
            const msgEl = document.getElementById('shEditImageMsg');
            msgEl.textContent = 'â³ Uploading imageâ€¦';
            msgEl.style.color = '#1565c0';
            try {
                const fd = new FormData();
                fd.append('file', newImgFile);
                fd.append('upload_preset', 'scavenger_hunt');
                fd.append('folder', 'scavenger_hunt/task_images');
                fd.append('public_id', 'task_img_' + id + '_' + Date.now());
                const res = await fetch('https://api.cloudinary.com/v1_1/dat0khbet/image/upload', { method:'POST', body:fd });
                if (!res.ok) throw new Error((await res.json()).error?.message || 'Upload failed');
                imageUrl = (await res.json()).secure_url;
                msgEl.textContent = 'âœ… Image uploaded!';
                msgEl.style.color = '#2e7d32';
            } catch(e) {
                alert('Image upload failed: ' + e.message);
                document.getElementById('shEditImageMsg').textContent = 'âŒ Upload failed';
                document.getElementById('shEditImageMsg').style.color = '#c62828';
                return;
            }
        }

        const update = {
            name,
            order,
            hint:          hint || null,
            image:         imageUrl || null,
            parts:         editParts.length ? editParts : null,
            availableFrom: fromV ? new Date(fromV).toISOString() : null,
            deadline:      tillV ? new Date(tillV).toISOString() : null,
            lat:           latV,
            lng:           lngV
        };

        // Firebase doesn't accept null â€” use set on the whole node with cleaned data
        const cleaned = {};
        Object.entries(update).forEach(([k,v]) => { if (v !== null) cleaned[k] = v; });
        // Preserve createdAt
        if (window._shTasksCache && window._shTasksCache[id] && window._shTasksCache[id].createdAt) {
            cleaned.createdAt = window._shTasksCache[id].createdAt;
        }

        try {
            await window.db.ref('scavengerHunt/tasks/'+id).set(cleaned);
            const msg = document.getElementById('shEditMsg');
            if (msg) { msg.style.display = 'inline-block'; }
            setTimeout(() => {
                shAdminCancelEditTask();
                shAdminLoadTasks();
            }, 1200);
        } catch(e) { alert('Save failed: ' + e.message); }
    }

    async function shAdminDeleteTask(id) {
        if (!confirm('Delete this task?')) return;
        await window.db.ref('scavengerHunt/tasks/'+id).remove();
        shAdminLoadTasks();
    }

    async function shAdminDeleteAllTasks() {
        if (!confirm('Delete ALL tasks?')) return;
        await window.db.ref('scavengerHunt/tasks').remove();
        shAdminLoadTasks();
    }

    async function shAdminResetAll() {
        if (!confirm('Reset ALL submissions?')) return;
        await window.db.ref('scavengerHunt/submissions').remove();
        alert('All submissions reset.');
    }

    function shAdminGetLocation() {
        const msgEl = document.getElementById('shAdminLocMsg');
        msgEl.textContent = 'ðŸ”„ Getting location...';
        if (!navigator.geolocation) { msgEl.textContent='âš ï¸ Not available'; return; }
        navigator.geolocation.getCurrentPosition(
            pos => {
                document.getElementById('shNewTaskLat').value = pos.coords.latitude.toFixed(6);
                document.getElementById('shNewTaskLng').value = pos.coords.longitude.toFixed(6);
                msgEl.textContent = 'âœ… Location set! (Â±'+Math.round(pos.coords.accuracy)+'m)';
            },
            err => { msgEl.textContent='âŒ '+err.message; },
            {enableHighAccuracy:true}
        );
    }

    // -- Admin: Submissions ---------------------------------------------
    // Realtime listener handle for submissions
    let _shSubmissionsListener = null;

    function shAdminStopSubmissionsListener() {
        if (_shSubmissionsListener) {
            getDb().ref('scavengerHunt/submissions').off('value', _shSubmissionsListener);
            _shSubmissionsListener = null;
        }
    }

    function shAdminStartSubmissionsListener() {
        shAdminStopSubmissionsListener();
        const el = document.getElementById('shAdminSubmissionsList');
        if(!el) return;
        el.innerHTML = '<p style="color:#999">ðŸ”„ Loading live submissions...</p>';
        _shSubmissionsListener = getDb().ref('scavengerHunt/submissions').on('value', snap => {
            shAdminRenderSubmissions(snap);
        }, err => {
            if(el) el.innerHTML = '<p style="color:red">Error: ' + err.message + '</p>';
        });
    }

    async function shAdminLoadSubmissions() {
        // Start realtime listener for live updates
        shAdminStartSubmissionsListener();
    }

    function shAdminRenderSubmissions(snap) {
        const el         = document.getElementById('shAdminSubmissionsList');
        const filter     = (document.getElementById('shSubmissionFilter')||{}).value||'all';
        const dateFilter = (document.getElementById('shSubmissionDateFilter')||{}).value||'all';
        const taskFilter = (document.getElementById('shSubmissionTaskFilter')||{}).value||'all';
        if(!el) return;
        try {
            const allSubs = snap.val() || {};
            let rows = [];
            Object.entries(allSubs).forEach(([sk,ss]) => {
                Object.entries(ss).forEach(([tid,sub]) => {
                    rows.push({studentKey:sk, taskId:tid, ...sub});
                });
            });

            // Populate date dropdown dynamically
            const dateSet = new Set(rows.map(r => r.submittedAt ? r.submittedAt.slice(0,10) : 'unknown').filter(Boolean));
            const dateSel = document.getElementById('shSubmissionDateFilter');
            const prevDate = dateSel ? dateSel.value : 'all';
            if (dateSel) {
                const sortedDates = [...dateSet].sort().reverse();
                dateSel.innerHTML = '<option value="all">ðŸ“… All Dates</option>' +
                    sortedDates.map(d => `<option value="${d}" ${d===prevDate?'selected':''}>${new Date(d+'T00:00:00').toLocaleDateString('en-IN',{weekday:'short',day:'2-digit',month:'short',year:'numeric'})}</option>`).join('');
            }

            // Populate task dropdown dynamically
            const taskMap = {};
            rows.forEach(r => { if (r.taskId && r.taskName) taskMap[r.taskId] = r.taskName; });
            const taskSel = document.getElementById('shSubmissionTaskFilter');
            const prevTask = taskSel ? taskSel.value : 'all';
            if (taskSel) {
                taskSel.innerHTML = '<option value="all">ðŸ“Œ All Tasks</option>' +
                    Object.entries(taskMap).map(([id,name]) => `<option value="${id}" ${id===prevTask?'selected':''}>${name.length>40?name.slice(0,40)+'â€¦':name}</option>`).join('');
            }

            // Apply all filters
            rows = rows.filter(r => {
                const rowDate = r.submittedAt ? r.submittedAt.slice(0,10) : 'unknown';
                if (filter!=='all'     && r.status!==filter)     return false;
                if (dateFilter!=='all' && rowDate!==dateFilter)   return false;
                if (taskFilter!=='all' && r.taskId!==taskFilter)  return false;
                return true;
            });
            if (!rows.length) { el.innerHTML='<p style="color:#999">No submissions for filter: '+filter+'</p>'; return; }
            rows.sort((a,b)=>new Date(b.submittedAt)-new Date(a.submittedAt));
            let html = '';
            // Show warning if any phantom submissions exist
            const phantoms = rows.filter(r => !r.submittedAt);
            if (phantoms.length) {
                html += '<div style="background:#fff3e0;border:2px solid #ff9800;border-radius:10px;padding:12px 16px;margin-bottom:16px">';
                html += '<strong style="color:#e65100">âš ï¸ '+phantoms.length+' phantom submission(s) found</strong> â€” these have no photo/timestamp (possibly created by accident). ';
                html += '<button onclick="shDeleteAllPhantoms()" style="background:#e65100;color:white;border:none;padding:4px 12px;border-radius:6px;cursor:pointer;font-size:12px;font-weight:700;margin-left:8px">ðŸ—‘ï¸ Delete All Phantoms</button>';
                html += '</div>';
            }

            rows.forEach(r => {
                // Phantom = admin-created status with no real submission
                if (!r.submittedAt) {
                    html += '<div style="background:#fff8e1;border:2px dashed #ff9800;border-radius:12px;padding:14px 18px;margin-bottom:14px;opacity:0.85">';
                    html += '<div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:8px">';
                    html += '<div><strong style="color:#e65100">âš ï¸ PHANTOM</strong> â€” <strong style="color:#6a1b9a">'+shEsc(r.studentName||r.studentKey)+'</strong> <span style="color:#666;font-size:0.85em">('+shEsc(r.studentClass||'')+')</span><br>';
                    html += '<span style="color:#555;font-size:0.9em">Task: <strong>'+shEsc(r.taskName||r.taskId)+'</strong></span> &nbsp; <span style="font-size:0.8em;color:#e65100">No photo or timestamp â€” student never actually submitted this task</span></div>';
                    html += '<button class="btn btn-danger btn-small" onclick="shAdminDeleteSubmission(\'' + r.studentKey + '\',\'' + r.taskId + '\')">ðŸ—‘ï¸ Delete Phantom</button>';
                    html += '</div></div>';
                    return;
                }
                const bg  = r.status==='approved'?'#d4edda':r.status==='rejected'?'#ffebee':'#fff3cd';
                const brd = r.status==='approved'?'#4caf50':r.status==='rejected'?'#f44336':'#ff9800';
                html += '<div style="background:'+bg+';border:2px solid '+brd+';border-radius:12px;padding:16px 18px;margin-bottom:14px">';
                html += '<div style="display:flex;justify-content:space-between;flex-wrap:wrap;gap:8px;margin-bottom:10px">';
                html += '<div><strong style="color:#6a1b9a">'+shEsc(r.studentName||r.studentKey)+'</strong> <span style="color:#666;font-size:0.85em">('+shEsc(r.studentClass||'')+')</span><br>';
                html += '<span style="color:#555;font-size:0.9em">Task: <strong>'+shEsc(r.taskName||r.taskId)+'</strong></span></div>';
                html += '<div style="text-align:right"><span style="font-size:0.8em;color:#777">'+new Date(r.submittedAt).toLocaleString('en-IN')+'</span></div></div>';
                if (r.photoUrl) html += '<div style="margin:6px 0 2px"><span style="font-size:0.78em;font-weight:700;color:#6a1b9a">ðŸ“¸ Part 1 Photo:</span></div><img src="'+r.photoUrl+'" class="sh-admin-photo" onclick="shViewPhoto(this.src)" title="Click to enlarge"><br>';
                if (r.lat && r.lng) html += '<a href="https://maps.google.com/?q='+r.lat+','+r.lng+'" target="_blank" style="font-size:0.85em;color:#1565c0">ðŸ“ View on Maps</a><br>';
                if (r.comment) html += '<div style="margin:10px 0;background:white;border-left:4px solid #9c27b0;border-radius:0 8px 8px 0;padding:10px 14px"><span style="font-size:0.8em;font-weight:700;color:#6a1b9a;display:block;margin-bottom:4px">ðŸ’¬ Student Comment:</span><span style="color:#333;font-size:0.93em">'+shEsc(r.comment)+'</span></div>';
                else html += '<div style="margin:8px 0;font-size:0.82em;color:#f44336;font-style:italic">ðŸ’¬ No comment provided</div>';

                // -- Multi-part submissions ---------------------------------
                // Check if this task has parts stored in Firebase tasks
                const taskDef = window._shTasksCache && window._shTasksCache[r.taskId];
                const taskParts = taskDef && taskDef.parts && taskDef.parts.length ? taskDef.parts : null;
                const subParts  = r.parts || [];

                if (taskParts) {
                    // Show each part with approve/reject
                    taskParts.forEach((pName, pi) => {
                        const ps = subParts[pi];
                        if (!ps || !ps.photoUrl) {
                            // Part not yet submitted by student
                            const prevApproved = pi === 0 || (subParts[pi-1] && subParts[pi-1].status === 'approved');
                            if (prevApproved) {
                                html += '<div style="margin-top:10px;background:#f3e5f5;border-left:4px solid #9c27b0;border-radius:6px;padding:8px 12px;font-size:0.85em;color:#6a1b9a">â³ Waiting for student to submit <strong>Part '+(pi+1)+': '+shEsc(pName)+'</strong></div>';
                            }
                            return;
                        }
                        const pbg  = ps.status==='approved'?'#e8f5e9':ps.status==='rejected'?'#ffebee':'#fff3cd';
                        const pbrd = ps.status==='approved'?'#4caf50':ps.status==='rejected'?'#f44336':'#ff9800';
                        html += '<div style="margin-top:12px;border-top:2px dashed #ce93d8;padding-top:12px">';
                        html += '<div style="font-weight:700;color:#6a1b9a;margin-bottom:6px">ðŸ“¸ Part '+(pi+1)+': '+shEsc(pName)+'</div>';
                        html += '<img src="'+ps.photoUrl+'" class="sh-admin-photo" onclick="shViewPhoto(this.src)" title="Click to enlarge"><br>';
                        if (ps.submittedAt) html += '<div style="font-size:0.78em;color:#888;margin:3px 0">Submitted: '+new Date(ps.submittedAt).toLocaleString('en-IN')+'</div>';
                        if (ps.comment) html += '<div style="background:white;border-left:3px solid #9c27b0;padding:6px 10px;border-radius:0 6px 6px 0;font-size:0.85em;margin:4px 0"><strong>ðŸ’¬</strong> '+shEsc(ps.comment)+'</div>';
                        if (!ps.status || ps.status === 'pending') {
                            html += '<div style="display:flex;gap:8px;margin-top:8px;flex-wrap:wrap">';
                            html += '<button class="btn btn-success btn-small" onclick="shAdminVerifyPart(\''+r.studentKey+'\',\''+r.taskId+'\','+pi+',\'approved\')">âœ… Approve Part '+(pi+1)+'</button>';
                            html += '<button class="btn btn-danger btn-small" onclick="shAdminVerifyPart(\''+r.studentKey+'\',\''+r.taskId+'\','+pi+',\'rejected\')">âŒ Reject Part '+(pi+1)+'</button>';
                            html += '</div>';
                        } else {
                            const picon = ps.status==='approved'?'âœ…':'âŒ';
                            html += '<div style="margin-top:6px;display:flex;align-items:center;gap:8px;flex-wrap:wrap"><strong>'+picon+' Part '+(pi+1)+' '+ps.status.toUpperCase()+'</strong>';
                            if (ps.status !== 'approved') html += '<button class="btn btn-success btn-small" onclick="shAdminVerifyPart(\''+r.studentKey+'\',\''+r.taskId+'\','+pi+',\'approved\')">âœ… Approve Part '+(pi+1)+'</button>';
                            html += '</div>';
                        }
                        html += '</div>';
                    });
                    // Overall task reset/delete
                    html += '<div style="display:flex;gap:8px;margin-top:12px;flex-wrap:wrap">';
                    html += '<button class="btn btn-secondary btn-small" onclick="shAdminVerify(\''+r.studentKey+'\',\''+r.taskId+'\',\'pending\',\'\')">â†©ï¸ Reset All</button>';
                    html += '<button class="btn btn-danger btn-small" onclick="shAdminDeleteSubmission(\''+r.studentKey+'\',\''+r.taskId+'\')">ðŸ—‘ï¸ Delete All</button>';
                    html += '</div>';
                } else {
                    // -- Single-photo task approve/reject (original flow) ---
                if (r.status==='pending') {
                    const rejectBoxId  = 'shRejectBox_' + r.studentKey + '_' + r.taskId;
                    const replyBoxId   = 'shReplyBox_'  + r.studentKey + '_' + r.taskId;
                    html += '<div style="margin-top:10px">';
                    // -- Admin reply/note box ------------------------------
                    html += '<div style="background:#e8f5e9;border:2px solid #4caf50;border-radius:10px;padding:12px 14px;margin-bottom:10px">';
                    html += '<label style="font-size:0.85em;color:#2e7d32;font-weight:700;display:block;margin-bottom:6px">ðŸ’¬ Reply / Note to Student <span style="color:#888;font-weight:400">(optional â€” shown to student on approval or rejection)</span></label>';
                    html += '<div style="display:flex;flex-wrap:wrap;gap:5px;margin-bottom:8px">';
                    [
                        'ðŸ‘ Great work!',
                        'ðŸŒŸ Excellent effort!',
                        'âœ… Well done, keep it up!',
                        'ðŸ‘ Perfect submission!',
                        'ðŸ˜Š Good job, proud of you!'
                    ].forEach(function(q) {
                        html += '<button type="button" onclick="document.getElementById(\'' + replyBoxId + '\').value=\'' + q.replace(/'/g,"\\'") + '\'" style="background:#c8e6c9;color:#1b5e20;border:1.5px solid #4caf50;border-radius:20px;padding:4px 11px;cursor:pointer;font-size:12px;font-weight:600;transition:background 0.15s" onmouseover="this.style.background=\'#a5d6a7\'" onmouseout="this.style.background=\'#c8e6c9\'">' + q + '</button>';
                    });
                    html += '</div>';
                    html += '<textarea id="' + replyBoxId + '" placeholder="e.g. Great work! Well done. / Please resubmit with clearer photoâ€¦" rows="2" style="width:100%;padding:8px;border:1.5px solid #4caf50;border-radius:6px;font-size:13px;box-sizing:border-box;resize:vertical;outline:none"></textarea>';
                    html += '</div>';
                    // -- Action buttons ------------------------------------
                    html += '<div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px">';
                    html += '<button class="btn btn-success btn-small" onclick="shAdminVerifyWithNote(\'' + r.studentKey + '\',\'' + r.taskId + '\',\'approved\',\'' + replyBoxId + '\')">âœ… Approve</button>';
                    html += '<button class="btn btn-danger btn-small" onclick="shAdminToggleRejectBox(\'' + rejectBoxId + '\')">âŒ Reject</button>';
                    html += '</div>';
                    html += '<div id="' + rejectBoxId + '" style="display:none;background:#fff0f0;border:2px solid #f44336;border-radius:10px;padding:14px;margin-top:4px">';
                    html += '<label style="font-size:0.88em;color:#c62828;font-weight:700;display:block;margin-bottom:6px">ðŸ“ Reason for rejection (will be shown to student):</label>';
                    html += '<div style="display:flex;flex-wrap:wrap;gap:6px;margin-bottom:10px">';
                    ['Wrong location','Blurry/unclear photo','Wrong task photo','Not at required spot','Photo not original'].forEach(p => {
                        html += '<button onclick="shSetRejectReason(\'' + rejectBoxId + '\',this)" data-reason="' + p + '" style="background:#ffebee;color:#c62828;border:1px solid #f44336;border-radius:6px;padding:5px 10px;cursor:pointer;font-size:12px">' + p + '</button>';
                    });
                    html += '</div>';
                    html += '<textarea id="' + rejectBoxId + '_txt" placeholder="Or type a custom reasonâ€¦" rows="2" style="width:100%;padding:8px;border:1px solid #f44336;border-radius:6px;font-size:13px;box-sizing:border-box;margin-bottom:10px;resize:vertical"></textarea>';
                    html += '<div style="display:flex;gap:8px">';
                    html += '<button class="btn btn-danger btn-small" onclick="shAdminVerifyWithReason(\'' + r.studentKey + '\',\'' + r.taskId + '\',\'' + replyBoxId + '\',\'' + rejectBoxId + '\')">âŒ Confirm Reject</button>';
                    html += '<button class="btn btn-secondary btn-small" onclick="shAdminToggleRejectBox(\'' + rejectBoxId + '\')">Cancel</button>';
                    html += '</div></div></div>';
                } else {
                    const statusIcon = r.status==='approved' ? 'âœ…' : 'âŒ';
                    const reviewedTime2 = r.reviewedAt ? new Date(r.reviewedAt).toLocaleString('en-IN',{day:'2-digit',month:'short',hour:'2-digit',minute:'2-digit',hour12:true}) : '';
                    const reviewerHtml = r.reviewedBy ? ' <span style="font-size:0.78em;color:#888">by ' + shEsc(r.reviewedBy) + '</span>' : '';
                    html += '<div style="margin-top:8px">';
                    html += '<div style="display:flex;align-items:center;gap:6px;flex-wrap:wrap">';
                    html += '<strong>' + statusIcon + ' ' + r.status.toUpperCase() + '</strong>' + reviewerHtml;
                    if (reviewedTime2) html += '<span style="font-size:0.78em;color:#888">Â· ' + reviewedTime2 + '</span>';
                    html += '</div>';
                    if (r.rejectionReason) html += '<div style="margin-top:6px;background:#fff0f0;border-left:3px solid #f44336;padding:7px 10px;border-radius:0 6px 6px 0;font-size:0.85em;color:#b71c1c"><strong>ðŸ“ Rejection Reason:</strong> ' + shEsc(r.rejectionReason) + '</div>';
                    if (r.adminNote) html += '<div style="margin-top:6px;background:#e8f5e9;border-left:3px solid #4caf50;padding:7px 10px;border-radius:0 6px 6px 0;font-size:0.85em;color:#2e7d32"><strong>ðŸ’¬ Admin Note:</strong> ' + shEsc(r.adminNote) + '</div>';
                    html += '<div style="display:flex;gap:8px;margin-top:8px;flex-wrap:wrap">';
                    html += '<button class="btn btn-secondary btn-small" onclick="shAdminVerify(\'' + r.studentKey + '\',\'' + r.taskId + '\',\'pending\',\'\')">â†©ï¸ Reset</button>';
                    html += '<button class="btn btn-danger btn-small" onclick="shAdminDeleteSubmission(\'' + r.studentKey + '\',\'' + r.taskId + '\')">ðŸ—‘ï¸ Delete</button>';
                    html += '</div></div>';
                }
                } // end single-photo else
                                html += '</div>';
            });
            const _scrollY = window.scrollY;
            el.innerHTML = html;
            requestAnimationFrame(() => window.scrollTo({ top: _scrollY, behavior: 'instant' }));
        } catch(e) { el.innerHTML='<p style="color:red">Error: '+e.message+'</p>'; }
    }

    async function shAdminVerify(studentKey, taskId, status, reason, adminNote) {
        const existing = await getDb().ref('scavengerHunt/submissions/'+studentKey+'/'+taskId).once('value');
        if (!existing.exists() || !existing.val().submittedAt) {
            alert('âš ï¸ No real submission found for this student/task. Cannot update.');
            return;
        }
        const update = {
            status,
            reviewedAt: new Date().toISOString(),
            reviewedBy: (window.currentUser && window.currentUser.name) ? window.currentUser.name : 'Admin',
            rejectionReason: (status === 'rejected' && reason) ? reason : null,
            adminNote: (adminNote && adminNote.trim()) ? adminNote.trim() : null
        };
        await getDb().ref('scavengerHunt/submissions/'+studentKey+'/'+taskId).update(update);
        shAdminLoadSubmissions();
    }

    async function shAdminVerifyPart(studentKey, taskId, partIdx, status) {
        try {
            await getDb().ref('scavengerHunt/submissions/'+studentKey+'/'+taskId+'/parts/'+partIdx).update({
                status,
                reviewedAt: new Date().toISOString(),
                reviewedBy: (window.currentUser && window.currentUser.name) ? window.currentUser.name : 'Admin'
            });
            // If ALL parts are now approved, also set the top-level status to 'approved'
            const snap = await getDb().ref('scavengerHunt/submissions/'+studentKey+'/'+taskId).once('value');
            const sub  = snap.val();
            const taskDef = window._shTasksCache && window._shTasksCache[taskId];
            const totalParts = taskDef && taskDef.parts ? taskDef.parts.length : 0;
            const subParts   = sub && sub.parts ? sub.parts : [];
            const allApproved = totalParts > 0 && subParts.length >= totalParts && subParts.every(p => p && p.status === 'approved');
            if (allApproved) {
                await getDb().ref('scavengerHunt/submissions/'+studentKey+'/'+taskId).update({
                    status: 'approved', reviewedAt: new Date().toISOString(),
                    reviewedBy: (window.currentUser && window.currentUser.name) ? window.currentUser.name : 'Admin'
                });
            }
            shAdminLoadSubmissions();
        } catch(e) { alert('Error: ' + e.message); }
    }

    async function shDeleteAllPhantoms() {
        if (!confirm('Delete ALL phantom submissions (entries with no photo/timestamp)? This cannot be undone.')) return;
        try {
            const snap = await getDb().ref('scavengerHunt/submissions').once('value');
            const allSubs = snap.val() || {};
            const deletes = [];
            Object.entries(allSubs).forEach(([sk, ss]) => {
                Object.entries(ss).forEach(([tid, sub]) => {
                    if (!sub.submittedAt) {
                        deletes.push(getDb().ref('scavengerHunt/submissions/'+sk+'/'+tid).remove());
                    }
                });
            });
            await Promise.all(deletes);
            alert('âœ… Deleted '+deletes.length+' phantom submission(s).');
            shAdminLoadSubmissions();
        } catch(e) { alert('Error: '+e.message); }
    }

    function shAdminToggleRejectBox(boxId) {
        const box = document.getElementById(boxId);
        if (box) box.style.display = box.style.display === 'none' ? 'block' : 'none';
    }

    function shSetRejectReason(boxId, btn) {
        const txt = document.getElementById(boxId + '_txt');
        if (txt) txt.value = btn.dataset.reason;
        // Highlight selected preset
        const box = document.getElementById(boxId);
        if (box) box.querySelectorAll('[data-reason]').forEach(b => b.style.background = '#ffebee');
        btn.style.background = '#f44336';
        btn.style.color = 'white';
    }

    async function shAdminVerifyWithReason(studentKey, taskId, replyBoxId, boxId) {
        const txt    = document.getElementById(boxId + '_txt');
        const reply  = document.getElementById(replyBoxId);
        const reason = (txt ? txt.value.trim() : '') || 'Rejected by admin';
        const adminNote = reply ? reply.value.trim() : '';
        await shAdminVerify(studentKey, taskId, 'rejected', reason, adminNote);
    }

    async function shAdminVerifyWithNote(studentKey, taskId, status, replyBoxId) {
        const reply = document.getElementById(replyBoxId);
        const adminNote = reply ? reply.value.trim() : '';
        await shAdminVerify(studentKey, taskId, status, '', adminNote);
    }

    async function shAdminDeleteSubmission(studentKey, taskId) {
        if (!confirm("Delete this submission permanently? This cannot be undone.")) return;
        try {
            await window.db.ref("scavengerHunt/submissions/"+studentKey+"/"+taskId).remove();
            const toast = document.createElement("div");
            toast.textContent = "ðŸ—‘ï¸ Submission deleted!";
            toast.style.cssText = "position:fixed;top:20px;left:50%;transform:translateX(-50%);background:#c62828;color:white;padding:12px 28px;border-radius:30px;font-weight:700;font-size:1em;z-index:9999;box-shadow:0 4px 20px rgba(0,0,0,0.2);transition:opacity 0.5s";
            document.body.appendChild(toast);
            setTimeout(() => { toast.style.opacity = "0"; setTimeout(() => toast.remove(), 500); }, 2000);
            shAdminLoadSubmissions();
        } catch(e) {
            alert("Failed to delete: " + e.message);
        }
    }

    // -- Admin: Leaderboard ---------------------------------------------
    // -- Leaderboard cache --------------------------------------------
    let _shLbSubsCache = null;
    let _shLbTasksCache = null;

    async function shAdminLoadLeaderboard() {
        const el = document.getElementById('shAdminLeaderboardList');
        if(!el) return;
        el.innerHTML = '<p style="color:#999">Loading...</p>';
        try {
            const _db = getDb();
            const [subSnap, taskSnap] = await Promise.all([
                _db.ref('scavengerHunt/submissions').once('value'),
                _db.ref('scavengerHunt/tasks').once('value')
            ]);
            _shLbSubsCache  = subSnap.val()  || {};
            _shLbTasksCache = taskSnap.val() || {};

            // Populate Task filter
            const taskSel = document.getElementById('shLbTaskFilter');
            if (taskSel) {
                const curTask = taskSel.value;
                taskSel.innerHTML = '<option value="all">ðŸ“Œ All Tasks</option>';
                Object.entries(_shLbTasksCache)
                    .sort((a,b)=>(a[1].order||0)-(b[1].order||0))
                    .forEach(([tid,t]) => {
                        const o = document.createElement('option');
                        o.value = tid;
                        o.textContent = 'ðŸ“ ' + (t.name||tid);
                        if (tid===curTask) o.selected=true;
                        taskSel.appendChild(o);
                    });
            }

            // Populate Class filter
            const classSel = document.getElementById('shLbClassFilter');
            if (classSel) {
                const curCls = classSel.value;
                const classSet = new Set();
                Object.values(_shLbSubsCache).forEach(ss => {
                    const first = Object.values(ss)[0]||{};
                    if (first.studentClass) classSet.add(first.studentClass);
                });
                classSel.innerHTML = '<option value="all">ðŸ« All Classes</option>';
                [...classSet].sort().forEach(c => {
                    const o = document.createElement('option');
                    o.value = c; o.textContent = c;
                    if (c===curCls) o.selected=true;
                    classSel.appendChild(o);
                });
            }

            shAdminRenderLeaderboard();
        } catch(e) { el.innerHTML='<p style="color:red">Error: '+e.message+'</p>'; }
    }

    function shAdminRenderLeaderboard() {
        const el = document.getElementById('shAdminLeaderboardList');
        if (!el || !_shLbSubsCache || !_shLbTasksCache) return;

        const taskF  = (document.getElementById('shLbTaskFilter')||{}).value||'all';
        const classF = (document.getElementById('shLbClassFilter')||{}).value||'all';

        // Sorted task list for display
        const allTasksSorted = Object.entries(_shLbTasksCache)
            .sort((a,b)=>(a[1].order||0)-(b[1].order||0));

        // Determine which tasks count toward "total" based on filter
        const taskIds = taskF === 'all'
            ? allTasksSorted.map(([tid])=>tid)
            : [taskF];
        const totalTasks = taskIds.length;

        let rows = [];
        Object.entries(_shLbSubsCache).forEach(([sk,ss]) => {
            const first = Object.values(ss)[0]||{};
            const cls = first.studentClass||'';
            if (classF !== 'all' && cls !== classF) return;

            let approved=0, submitted=0, lastTime=null;
            // Per-task status for inline display
            const taskStatuses = [];
            taskIds.forEach(tid => {
                const sub = ss[tid];
                const tName = (_shLbTasksCache[tid]||{}).name || ('Task '+(allTasksSorted.findIndex(([id])=>id===tid)+1));
                const tNum  = 'Task '+(allTasksSorted.findIndex(([id])=>id===tid)+1);
                if (sub) {
                    submitted++;
                    if (sub.status==='approved') {
                        approved++;
                        if (!lastTime || (sub.reviewedAt||'') > lastTime) lastTime = sub.reviewedAt||'';
                        taskStatuses.push({tNum, tName, status:'approved'});
                    } else if (sub.status==='pending') {
                        taskStatuses.push({tNum, tName, status:'pending'});
                    } else {
                        taskStatuses.push({tNum, tName, status:'rejected'});
                    }
                }
                // If no submission, don't add to taskStatuses (not submitted yet)
            });

            // When a specific task is filtered: only include students who have submitted that task
            // When "All Tasks": include everyone who has submitted at least one task
            if (taskF !== 'all' && submitted === 0) return;
            if (taskF === 'all' && submitted === 0) return;

            rows.push({name:first.studentName||sk, cls, approved, submitted, lastTime:lastTime||'', totalTasks, taskStatuses});
        });

        rows.sort((a,b)=>b.approved-a.approved||(a.lastTime||'zzz').localeCompare(b.lastTime||'zzz'));

        // Active filter label
        let filterLabel = '';
        if (taskF !== 'all') {
            const tName = (_shLbTasksCache[taskF]||{}).name || taskF;
            filterLabel += `<span style="background:#e8f5e9;color:#2e7d32;padding:3px 10px;border-radius:12px;font-size:0.8em;font-weight:700;margin-right:6px">ðŸ“ ${shEsc(tName)}</span>`;
        }
        if (classF !== 'all') {
            filterLabel += `<span style="background:#e3f2fd;color:#1565c0;padding:3px 10px;border-radius:12px;font-size:0.8em;font-weight:700">ðŸ« ${shEsc(classF)}</span>`;
        }

        if (!rows.length) {
            el.innerHTML = (filterLabel ? `<div style="margin-bottom:10px">${filterLabel}</div>` : '') + '<p style="color:#999">No participants have submitted for the selected filter.</p>';
            return;
        }

        const medals=['ðŸ¥‡','ðŸ¥ˆ','ðŸ¥‰'];
        let html = filterLabel ? `<div style="margin-bottom:12px">${filterLabel} <span style="color:#888;font-size:0.82em">(${rows.length} participant${rows.length!==1?'s':''} shown)</span></div>` : '';
        rows.forEach((r,i) => {
            const pct = totalTasks ? Math.round(r.approved/totalTasks*100) : 0;

            // Build inline task chips
            let taskChipsInline = '';
            if (r.taskStatuses && r.taskStatuses.length) {
                r.taskStatuses.forEach(ts => {
                    const chipBg  = ts.status==='approved'?'#e8f5e9':ts.status==='pending'?'#fff3e0':'#ffebee';
                    const chipCol = ts.status==='approved'?'#2e7d32':ts.status==='pending'?'#e65100':'#c62828';
                    const chipIcon = ts.status==='approved'?'âœ…':ts.status==='pending'?'â³':'âŒ';
                    taskChipsInline += `<span style="background:${chipBg};color:${chipCol};padding:2px 8px;border-radius:10px;font-size:0.75em;font-weight:700;white-space:nowrap">${chipIcon} ${shEsc(ts.tNum)}</span>`;
                });
            }

            html += '<div class="sh-leaderboard-row">';
            html += '<div class="sh-rank">'+(medals[i]||(i+1))+'</div>';
            html += '<div style="flex:1">';
            html += '<div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap;margin-bottom:4px">';
            html += '<strong style="color:#6a1b9a">'+shEsc(r.name)+'</strong>';
            html += '<span style="color:#999;font-size:0.85em">('+shEsc(r.cls)+')</span>';
            if (taskChipsInline) html += taskChipsInline;
            html += '</div>';
            html += '<div class="sh-progress-bar-wrap" style="height:8px;margin-top:2px"><div class="sh-progress-bar" style="width:'+pct+'%"></div></div>';
            html += '<span style="font-size:0.82em;color:#666">'+r.approved+'/'+r.totalTasks+' task'+(r.totalTasks!==1?'s':'')+' ('+pct+'%)</span></div></div>';
        });

        // -- Summary Report Box --------------------------------------------
        const totalParticipants = rows.length;
        const fullCompleters    = rows.filter(r => r.approved === r.totalTasks && r.totalTasks > 0).length;
        const partialCompleters = rows.filter(r => r.approved > 0 && r.approved < r.totalTasks).length;
        const noApproval        = rows.filter(r => r.approved === 0).length;
        const topStudents       = rows.slice(0,3).map((r,i)=>(medals[i]||'#'+(i+1))+' '+r.name+' ('+r.cls+') â€” '+r.approved+'/'+r.totalTasks+' tasks').join('\n');
        const filterNote        = (taskF!=='all'||classF!=='all')
            ? '\nFilter: '+(taskF!=='all'?'Task: '+((_shLbTasksCache[taskF]||{}).name||taskF):'All Tasks')+' | '+(classF!=='all'?'Class: '+classF:'All Classes')
            : '';
        const now               = new Date().toLocaleString('en-IN',{day:'2-digit',month:'short',year:'numeric',hour:'2-digit',minute:'2-digit',hour12:true});

        const reportText =
`ðŸ“Š Scavenger Hunt â€” Summary Report
ðŸ“… Generated: ${now}${filterNote}
------------------------------
ðŸ‘¥ Total Participants : ${totalParticipants}
âœ… Fully Completed    : ${fullCompleters}
â³ Partially Done     : ${partialCompleters}
âŒ No Approval Yet    : ${noApproval}
------------------------------
ðŸ† Top 3 Students:
${topStudents}
------------------------------`;

        html += `
        <div style="margin-top:28px;background:linear-gradient(135deg,#f3e5f5 0%,#e8f5e9 100%);border:2px solid #9c27b0;border-radius:14px;padding:18px 20px">
            <div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:8px;margin-bottom:12px">
                <span style="font-weight:800;color:#6a1b9a;font-size:1em">ðŸ“Š Summary Report</span>
                <div style="display:flex;gap:8px;flex-wrap:wrap">
                    <button onclick="(function(){var t=document.getElementById('shLbReportTxt');t.select();navigator.clipboard.writeText(t.value).then(function(){var b=document.getElementById('shLbCopyBtn');b.textContent='âœ… Copied!';b.style.background='#2e7d32';setTimeout(function(){b.textContent='ðŸ“‹ Copy';b.style.background='#6a1b9a';},2000);})})()" id="shLbCopyBtn" style="background:#6a1b9a;color:white;border:none;padding:6px 16px;border-radius:8px;cursor:pointer;font-weight:700;font-size:0.85em">ðŸ“‹ Copy</button>
                    <button onclick="(function(){var t=document.getElementById('shLbReportTxt');var b=document.createElement('a');b.href='data:text/plain;charset=utf-8,'+encodeURIComponent(t.value);b.download='scavenger_hunt_report.txt';b.click();})()" style="background:#1565c0;color:white;border:none;padding:6px 16px;border-radius:8px;cursor:pointer;font-weight:700;font-size:0.85em">â¬‡ï¸ Download</button>
                </div>
            </div>
            <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(130px,1fr));gap:10px;margin-bottom:14px">
                <div style="background:white;border-radius:10px;padding:12px;text-align:center;box-shadow:0 2px 8px rgba(106,27,154,0.08)">
                    <div style="font-size:1.6em;font-weight:800;color:#6a1b9a">${totalParticipants}</div>
                    <div style="font-size:0.75em;color:#888;font-weight:600">ðŸ‘¥ Participants</div>
                </div>
                <div style="background:white;border-radius:10px;padding:12px;text-align:center;box-shadow:0 2px 8px rgba(46,125,50,0.08)">
                    <div style="font-size:1.6em;font-weight:800;color:#2e7d32">${fullCompleters}</div>
                    <div style="font-size:0.75em;color:#888;font-weight:600">âœ… Fully Done</div>
                </div>
                <div style="background:white;border-radius:10px;padding:12px;text-align:center;box-shadow:0 2px 8px rgba(230,81,0,0.08)">
                    <div style="font-size:1.6em;font-weight:800;color:#e65100">${partialCompleters}</div>
                    <div style="font-size:0.75em;color:#888;font-weight:600">â³ Partial</div>
                </div>
                <div style="background:white;border-radius:10px;padding:12px;text-align:center;box-shadow:0 2px 8px rgba(198,40,40,0.08)">
                    <div style="font-size:1.6em;font-weight:800;color:#c62828">${noApproval}</div>
                    <div style="font-size:0.75em;color:#888;font-weight:600">âŒ No Approval</div>
                </div>
            </div>
            <textarea id="shLbReportTxt" readonly rows="10" style="width:100%;font-family:monospace;font-size:12.5px;padding:12px;border:1.5px solid #ce93d8;border-radius:8px;background:#fdf6ff;color:#333;resize:vertical;box-sizing:border-box;outline:none;line-height:1.7">${reportText.replace(/</g,'&lt;').replace(/>/g,'&gt;')}</textarea>
        </div>`;

        el.innerHTML = html;
        // Set textarea value properly (avoid HTML encoding issues)
        const ta = document.getElementById('shLbReportTxt');
        if (ta) ta.value = reportText;
    }

    // -- Admin: Class-wise Participation -------------------------------
    let _shAllSubsCache = null;
    let _shAllTasksCache = null;

    async function shAdminLoadClasswise() {
        const el = document.getElementById('shAdminClasswiseList');
        if (el) el.innerHTML = '<p style="color:#aaa;text-align:center;padding:12px">â³ Loadingâ€¦</p>';
        try {
            const _db = getDb();
            const [subSnap, taskSnap] = await Promise.all([
                _db.ref('scavengerHunt/submissions').once('value'),
                _db.ref('scavengerHunt/tasks').once('value')
            ]);
            _shAllSubsCache  = subSnap.val()  || {};
            _shAllTasksCache = taskSnap.val() || {};
            const totalTasks = Object.keys(_shAllTasksCache).length;

            // Populate Task filter for Summary
            const cwTaskSel = document.getElementById('shCwTaskFilter');
            if (cwTaskSel) {
                const curCwTask = cwTaskSel.value;
                cwTaskSel.innerHTML = '<option value="all">ðŸ“Œ All Tasks</option>';
                Object.entries(_shAllTasksCache)
                    .sort((a,b)=>(a[1].order||0)-(b[1].order||0))
                    .forEach(([tid,t]) => {
                        const o = document.createElement('option');
                        o.value = tid;
                        o.textContent = 'ðŸ“ ' + (t.name||tid);
                        if (tid===curCwTask) o.selected=true;
                        cwTaskSel.appendChild(o);
                    });
            }

            // Populate Date filter for Summary
            const cwDateSel = document.getElementById('shCwDateFilter');
            if (cwDateSel) {
                const curCwDate = cwDateSel.value;
                const dateSet = new Set();
                Object.values(_shAllSubsCache).forEach(ss => {
                    Object.values(ss).forEach(sub => {
                        if (sub.submittedAt) dateSet.add(sub.submittedAt.slice(0,10));
                    });
                });
                cwDateSel.innerHTML = '<option value="all">ðŸ“… All Dates</option>';
                [...dateSet].sort().reverse().forEach(d => {
                    const o = document.createElement('option');
                    o.value = d;
                    o.textContent = new Date(d+'T00:00:00').toLocaleDateString('en-IN',{weekday:'short',day:'2-digit',month:'short',year:'numeric'});
                    if (d===curCwDate) o.selected=true;
                    cwDateSel.appendChild(o);
                });
            }

            // Build class map
            const classMap = {}; // class â†’ {total, approved, pending, rejected, students[]}
            let grandTotal=0, grandApproved=0, grandPending=0;
            const allStudents = [];

            Object.entries(_shAllSubsCache).forEach(([sk, ss]) => {
                const first = Object.values(ss)[0] || {};
                const cls = first.studentClass || 'Unknown';
                const name = first.studentName || sk;
                let studentApproved=0;
                Object.entries(ss).forEach(([tid, sub]) => {
                    if (!classMap[cls]) classMap[cls] = {total:0, approved:0, pending:0, rejected:0};
                    classMap[cls].total++;
                    grandTotal++;
                    if (sub.status==='approved')  { classMap[cls].approved++; grandApproved++; studentApproved++; }
                    else if (sub.status==='pending')  { classMap[cls].pending++;  grandPending++; }
                    else if (sub.status==='rejected') classMap[cls].rejected++;
                });
                allStudents.push({key:sk, name, cls, approved:studentApproved, total:totalTasks});
            });

            // Pills
            const pt=document.getElementById('shCwPillTotal');
            const pa=document.getElementById('shCwPillApproved');
            const pp=document.getElementById('shCwPillPending');
            const pc=document.getElementById('shCwPillClasses');
            if(pt) pt.textContent='Total Submissions: '+grandTotal;
            if(pa) pa.textContent='Approved: '+grandApproved;
            if(pp) pp.textContent='Pending: '+grandPending;
            if(pc) pc.textContent='Classes: '+Object.keys(classMap).length;

            // Build class breakdown table
            const sorted = Object.entries(classMap).sort((a,b)=>b[1].approved-a[1].approved||b[1].total-a[1].total);
            let html = '<div class="table-wrapper" style="margin:0"><table style="font-size:13px;width:100%"><thead><tr>';
            html += '<th style="background:#3d0060;color:#ffd700">Class</th>';
            html += '<th style="background:#3d0060;color:white">Submissions</th>';
            html += '<th style="background:#3d0060;color:#a5d6a7">âœ… Approved</th>';
            html += '<th style="background:#3d0060;color:#fff3cd">â³ Pending</th>';
            html += '<th style="background:#3d0060;color:#f5c6cb">âŒ Rejected</th>';
            html += '<th style="background:#3d0060;color:#80deea">Approval %</th>';
            html += '</tr></thead><tbody>';
            sorted.forEach(([cls, d]) => {
                const acc = d.total > 0 ? Math.round((d.approved/d.total)*100) : 0;
                const barColor = acc>=70?'#28a745':acc>=40?'#ffc107':'#dc3545';
                html += '<tr>';
                html += '<td><strong>'+shEsc(cls)+'</strong></td>';
                html += '<td style="text-align:center;font-weight:700">'+d.total+'</td>';
                html += '<td style="text-align:center;color:#155724;font-weight:600">'+d.approved+'</td>';
                html += '<td style="text-align:center;color:#e65100;font-weight:600">'+d.pending+'</td>';
                html += '<td style="text-align:center;color:#c62828;font-weight:600">'+d.rejected+'</td>';
                html += '<td style="min-width:100px"><div style="background:#eee;border-radius:6px;height:8px;margin-bottom:3px"><div style="background:'+barColor+';width:'+acc+'%;height:8px;border-radius:6px"></div></div><span style="font-size:11px;color:#555">'+acc+'%</span></td>';
                html += '</tr>';
            });
            if (!sorted.length) html += '<tr><td colspan="6" style="text-align:center;color:#999;padding:16px">No submissions yet.</td></tr>';
            html += '</tbody></table></div>';
            if(el) el.innerHTML = html;

            // Populate class filter dropdown
            const classFilter = document.getElementById('shCwClassFilter');
            if (classFilter) {
                const curVal = classFilter.value;
                classFilter.innerHTML = '<option value="">All Classes</option>';
                Object.keys(classMap).sort().forEach(c => {
                    const o = document.createElement('option');
                    o.value = c; o.textContent = c;
                    if (c===curVal) o.selected=true;
                    classFilter.appendChild(o);
                });
            }

            // Build summary message box â€” fetch class strengths from leaderboard config
            const summaryBox  = document.getElementById('shCwSummaryBox');
            const summaryDate = document.getElementById('shCwSummaryDate');
            const summaryText = document.getElementById('shCwSummaryText');
            const nowTime = new Date().toLocaleTimeString('en-IN',{hour:'2-digit',minute:'2-digit',hour12:true});
            if (!window._classStrengths) {
                try { const ss = await getDb().ref('leaderboardConfig/classStrengths').once('value'); window._classStrengths = ss.val() || {}; } catch(e) { window._classStrengths = {}; }
            }
            const _shStr = window._classStrengths || {};
            function _normCls2(s){ return String(s).toLowerCase().replace(/[^a-z0-9]/g,''); }
            function _getStrength2(map,cls){ const n=_normCls2(cls); const k=Object.keys(map).find(k=>_normCls2(k)===n); return k?map[k]:0; }
            if (summaryDate) summaryDate.textContent = new Date().toLocaleDateString('en-IN',{weekday:'long',day:'numeric',month:'long',year:'numeric'});
            const studentCount = Object.keys(_shAllSubsCache||{}).length || grandTotal;
            if (summaryText) {
                let lines = `<span style="color:#888;font-size:12px">ðŸ• Generated at: <strong>${nowTime}</strong></span><br><br>`;
                lines += `<strong>${studentCount}</strong> students across <strong>${Object.keys(classMap).length}</strong> classes.<br>`;
                lines += `<strong>${grandApproved}</strong> approved, <strong>${grandPending}</strong> pending review.<br><br>`;
                lines += '<strong>Class-wise breakdown:</strong><br>';
                sorted.forEach(([cls,d]) => {
                    const acc = d.total>0?Math.round((d.approved/d.total)*100):0;
                    const strength = _getStrength2(_shStr, cls);
                    const strengthTag = strength ? `<span style="color:#888;font-size:0.92em">(Class Strength: ${strength})</span> ` : '';
                    lines += `â€¢ ${shEsc(cls)}: ${strengthTag}<strong>${d.total}</strong> submitted, <strong>${d.approved}</strong> approved (${acc}%)<br>`;
                });
                summaryText.innerHTML = lines;
            }
            if (summaryBox) summaryBox.style.display = 'block';
            // Store plain text for copy
            window._shLastSummaryText = `ðŸ—ºï¸ Scavenger Hunt Summary\nðŸ• Generated at: ${nowTime}\n\n` +
                `${studentCount} students across ${Object.keys(classMap).length} classes.\n` +
                `${grandApproved} approved, ${grandPending} pending review.\n\nClass-wise breakdown:\n` +
                sorted.map(([cls,d]) => {
                    const strength = _getStrength2(_shStr, cls);
                    const strengthTxt = strength ? `[Class Strength: ${strength}] ` : '';
                    return `â€¢ ${cls}: ${strengthTxt}${d.total} submitted, ${d.approved} approved (${d.total>0?Math.round((d.approved/d.total)*100):0}%)`;
                }).join('\n') +
                `\n\nâ€” Spurthi Youth Fest 2026\nðŸ”— https://harshgujjar.github.io/Spurthi-youth-fest-2026/`;

            shAdminLoadClasswiseDetail();
        } catch(e) {
            const el=document.getElementById('shAdminClasswiseList');
            if(el) el.innerHTML='<p style="color:red">Error: '+e.message+'</p>';
        }
    }

    // -- Apply task/date filters to the summary box + detail table ----
    function shAdminApplyClasswiseFilters() {
        if (!_shAllSubsCache || !_shAllTasksCache) return;
        const taskF = (document.getElementById('shCwTaskFilter')||{}).value||'all';
        const dateF = (document.getElementById('shCwDateFilter')||{}).value||'all';

        // Build filtered class map
        const classMap = {};
        let grandTotal=0, grandApproved=0, grandPending=0;
        Object.entries(_shAllSubsCache).forEach(([sk, ss]) => {
            const first = Object.values(ss)[0] || {};
            const cls = first.studentClass || 'Unknown';
            Object.entries(ss).forEach(([tid, sub]) => {
                if (taskF !== 'all' && tid !== taskF) return;
                if (dateF !== 'all' && (!sub.submittedAt || !sub.submittedAt.startsWith(dateF))) return;
                if (!classMap[cls]) classMap[cls] = {total:0, approved:0, pending:0, rejected:0};
                classMap[cls].total++;
                grandTotal++;
                if (sub.status==='approved')  { classMap[cls].approved++; grandApproved++; }
                else if (sub.status==='pending')  { classMap[cls].pending++;  grandPending++; }
                else if (sub.status==='rejected') classMap[cls].rejected++;
            });
        });

        // Update pills
        const pt=document.getElementById('shCwPillTotal');
        const pa=document.getElementById('shCwPillApproved');
        const pp=document.getElementById('shCwPillPending');
        const pc=document.getElementById('shCwPillClasses');
        if(pt) pt.textContent='Total Submissions: '+grandTotal;
        if(pa) pa.textContent='Approved: '+grandApproved;
        if(pp) pp.textContent='Pending: '+grandPending;
        if(pc) pc.textContent='Classes: '+Object.keys(classMap).length;

        // Build filter label for summary
        let filterLine = '';
        if (taskF !== 'all') {
            const tName = (_shAllTasksCache[taskF]||{}).name || taskF;
            filterLine += `ðŸ“ Task: <strong>${tName}</strong>  `;
        }
        if (dateF !== 'all') {
            const dLabel = new Date(dateF+'T00:00:00').toLocaleDateString('en-IN',{weekday:'long',day:'numeric',month:'long',year:'numeric'});
            filterLine += `ðŸ“… Date: <strong>${dLabel}</strong>`;
        }

        // Rebuild summary box
        const sorted = Object.entries(classMap).sort((a,b)=>b[1].approved-a[1].approved||b[1].total-a[1].total);
        if (!window._classStrengths) window._classStrengths = {};
        const _shStr = window._classStrengths || {};
        function _normC(s){ return String(s).toLowerCase().replace(/[^a-z0-9]/g,''); }
        function _getStr(map,cls){ const n=_normC(cls); const k=Object.keys(map).find(k=>_normC(k)===n); return k?map[k]:0; }
        const nowTime = new Date().toLocaleTimeString('en-IN',{hour:'2-digit',minute:'2-digit',hour12:true});
        const studentCount = Object.keys(_shAllSubsCache||{}).filter(sk => {
            const ss = _shAllSubsCache[sk];
            return Object.entries(ss).some(([tid,sub]) => {
                if (taskF!=='all' && tid!==taskF) return false;
                if (dateF!=='all' && (!sub.submittedAt||!sub.submittedAt.startsWith(dateF))) return false;
                return true;
            });
        }).length;

        const summaryDate = document.getElementById('shCwSummaryDate');
        const summaryText = document.getElementById('shCwSummaryText');
        const summaryBox  = document.getElementById('shCwSummaryBox');
        if (summaryDate) {
            summaryDate.textContent = dateF !== 'all'
                ? new Date(dateF+'T00:00:00').toLocaleDateString('en-IN',{weekday:'long',day:'numeric',month:'long',year:'numeric'})
                : new Date().toLocaleDateString('en-IN',{weekday:'long',day:'numeric',month:'long',year:'numeric'});
        }
        if (summaryText) {
            let lines = `<span style="color:#888;font-size:12px">ðŸ• Generated at: <strong>${nowTime}</strong></span>`;
            if (filterLine) lines += ` &nbsp;Â·&nbsp; <span style="color:#c44569;font-size:12px">${filterLine}</span>`;
            lines += `<br><br><strong>${studentCount}</strong> students across <strong>${Object.keys(classMap).length}</strong> classes.<br>`;
            lines += `<strong>${grandApproved}</strong> approved, <strong>${grandPending}</strong> pending review.<br><br>`;
            lines += '<strong>Class-wise breakdown:</strong><br>';
            if (!sorted.length) {
                lines += '<span style="color:#999">No submissions match the selected filters.</span>';
            } else {
                sorted.forEach(([cls,d]) => {
                    const acc = d.total>0?Math.round((d.approved/d.total)*100):0;
                    const strength = _getStr(_shStr, cls);
                    const strengthTag = strength ? `<span style="color:#888;font-size:0.92em">(Class Strength: ${strength})</span> ` : '';
                    lines += `â€¢ ${shEsc(cls)}: ${strengthTag}<strong>${d.total}</strong> submitted, <strong>${d.approved}</strong> approved (${acc}%)<br>`;
                });
            }
            summaryText.innerHTML = lines;
        }
        if (summaryBox) summaryBox.style.display = 'block';

        // Build plain text for copy
        const taskLabel = taskF!=='all' ? `\nðŸ“ Task: ${(_shAllTasksCache[taskF]||{}).name||taskF}` : '';
        const dateLabel = dateF!=='all' ? `\nðŸ“… Date: ${new Date(dateF+'T00:00:00').toLocaleDateString('en-IN',{weekday:'long',day:'numeric',month:'long',year:'numeric'})}` : '';
        window._shLastSummaryText = `ðŸ—ºï¸ Scavenger Hunt Summary\nðŸ• Generated at: ${nowTime}${taskLabel}${dateLabel}\n\n` +
            `${studentCount} students across ${Object.keys(classMap).length} classes.\n` +
            `${grandApproved} approved, ${grandPending} pending review.\n\nClass-wise breakdown:\n` +
            sorted.map(([cls,d]) => {
                const strength = _getStr(_shStr, cls);
                const strengthTxt = strength ? `[Class Strength: ${strength}] ` : '';
                return `â€¢ ${cls}: ${strengthTxt}${d.total} submitted, ${d.approved} approved (${d.total>0?Math.round((d.approved/d.total)*100):0}%)`;
            }).join('\n') +
            `\n\nâ€” Spurthi Youth Fest 2026\nðŸ”— https://harshgujjar.github.io/Spurthi-youth-fest-2026/`;

        // Also update detail table
        shAdminLoadClasswiseDetail();
    }

    function shAdminLoadClasswiseDetail() {
        const tbody = document.getElementById('shCwDetailTable');
        if(!tbody || !_shAllSubsCache || !_shAllTasksCache) return;
        const classF  = (document.getElementById('shCwClassFilter')||{}).value||'';
        const statusF = (document.getElementById('shCwStatusFilter')||{}).value||'';
        let rows = [];
        Object.entries(_shAllSubsCache).forEach(([sk,ss]) => {
            Object.entries(ss).forEach(([tid,sub]) => {
                const taskName = (_shAllTasksCache[tid]||{}).name || tid;
                if (classF  && sub.studentClass!==classF) return;
                if (statusF && sub.status!==statusF) return;
                rows.push({name:sub.studentName||sk, cls:sub.studentClass||'', task:taskName, submittedAt:sub.submittedAt, status:sub.status});
            });
        });
        rows.sort((a,b)=>new Date(b.submittedAt)-new Date(a.submittedAt));
        if(!rows.length){ tbody.innerHTML='<tr><td colspan="6" style="text-align:center;color:#999;padding:16px">No matching submissions.</td></tr>'; return; }
        tbody.innerHTML='';
        rows.forEach((r,i) => {
            const statusBg  = r.status==='approved'?'#d4edda':r.status==='rejected'?'#f8d7da':'#fff3cd';
            const statusCol = r.status==='approved'?'#155724':r.status==='rejected'?'#721c24':'#856404';
            const statusLabel = r.status==='approved'?'âœ… Approved':r.status==='rejected'?'âŒ Rejected':'â³ Pending';
            const row = tbody.insertRow();
            row.innerHTML = '<td>'+(i+1)+'</td>'
                +'<td><strong>'+shEsc(r.name)+'</strong></td>'
                +'<td><span style="background:#f3e5ff;color:#4a148c;padding:2px 8px;border-radius:10px;font-size:12px">'+shEsc(r.cls)+'</span></td>'
                +'<td>'+shEsc(r.task)+'</td>'
                +'<td style="font-size:12px">'+new Date(r.submittedAt).toLocaleString('en-IN')+'</td>'
                +'<td><span style="background:'+statusBg+';color:'+statusCol+';padding:3px 10px;border-radius:10px;font-weight:700;font-size:12px">'+statusLabel+'</span></td>';
        });
    }

    function shCopySummary() {
        const txt = window._shLastSummaryText || '';
        if (!txt) { alert('Load class-wise data first by clicking Refresh.'); return; }
        navigator.clipboard.writeText(txt).then(() => {
            const btn = document.querySelector('[onclick="shCopySummary()"]');
            if (btn) { const orig=btn.textContent; btn.textContent='âœ… Copied!'; setTimeout(()=>btn.textContent=orig,2000); }
        }).catch(() => {
            // Fallback for older browsers
            const ta = document.createElement('textarea');
            ta.value = txt; ta.style.position='fixed'; ta.style.opacity='0';
            document.body.appendChild(ta); ta.select();
            document.execCommand('copy'); document.body.removeChild(ta);
            const btn = document.querySelector('[onclick="shCopySummary()"]');
            if (btn) { const orig=btn.textContent; btn.textContent='âœ… Copied!'; setTimeout(()=>btn.textContent=orig,2000); }
        });
    }

    // -- Admin: Winners -------------------------------------------------
    let _shWinnersParticipants = [];

    async function shLoadWinnersTab() {
        const listEl = document.getElementById('shWinnersEligibleList');
        if(listEl) listEl.innerHTML='<p style="color:#aaa;text-align:center;padding:12px">â³ Loading participantsâ€¦</p>';
        try {
            const [subSnap, taskSnap] = await Promise.all([
                window.db.ref('scavengerHunt/submissions').once('value'),
                window.db.ref('scavengerHunt/tasks').once('value')
            ]);
            const allSubs  = subSnap.val()  || {};
            const allTasks = taskSnap.val() || {};
            const totalTasks = Object.keys(allTasks).length;
            _shWinnersParticipants = [];

            Object.entries(allSubs).forEach(([sk,ss]) => {
                const first = Object.values(ss)[0] || {};
                let approved=0, lastTime=null;
                Object.values(ss).forEach(sub => {
                    if(sub.status==='approved'){ approved++; if(!lastTime||sub.reviewedAt>lastTime) lastTime=sub.reviewedAt; }
                });
                _shWinnersParticipants.push({key:sk, name:first.studentName||sk, cls:first.studentClass||'', approved, totalTasks, lastTime:lastTime||''});
            });
            _shWinnersParticipants.sort((a,b)=>b.approved-a.approved||(a.lastTime||'zzz').localeCompare(b.lastTime||'zzz'));

            // Populate manual select dropdowns
            const winSel = document.getElementById('shManualWinnerSelect');
            const runSel = document.getElementById('shManualRunnerSelect');
            if(winSel){ winSel.innerHTML='<option value="">-- Select Winner --</option>'; }
            if(runSel){ runSel.innerHTML='<option value="">-- Select Runner-up --</option>'; }
            _shWinnersParticipants.forEach(p => {
                const label = p.name + ' ('+p.cls+') â€“ '+p.approved+'/'+p.totalTasks+' tasks';
                if(winSel){ const o=document.createElement('option'); o.value=p.key; o.textContent=label; winSel.appendChild(o); }
                if(runSel){ const o=document.createElement('option'); o.value=p.key; o.textContent=label; runSel.appendChild(o); }
            });

            // Render eligible participants table
            const medals=['ðŸ¥‡','ðŸ¥ˆ','ðŸ¥‰'];
            let html='<div class="table-wrapper"><table style="font-size:13px;width:100%"><thead><tr>';
            html+='<th style="background:#3d0060;color:#ffd700">Rank</th>';
            html+='<th style="background:#3d0060;color:white">Student</th>';
            html+='<th style="background:#3d0060;color:#ce93d8">Class</th>';
            html+='<th style="background:#3d0060;color:#a5d6a7">Tasks Done</th>';
            html+='<th style="background:#3d0060;color:#80deea">Progress</th>';
            html+='</tr></thead><tbody>';
            if(!_shWinnersParticipants.length){
                html+='<tr><td colspan="5" style="text-align:center;color:#999;padding:16px">No participants yet.</td></tr>';
            } else {
                _shWinnersParticipants.forEach((p,i) => {
                    const pct = p.totalTasks ? Math.round(p.approved/p.totalTasks*100) : 0;
                    const rowBg = i===0?'#fffde7':i===1?'#f5f5f5':i===2?'#fff8f0':'white';
                    html+='<tr style="background:'+rowBg+'">';
                    html+='<td style="text-align:center;font-size:1.3em">'+(medals[i]||(i+1))+'</td>';
                    html+='<td><strong style="color:#6a1b9a">'+shEsc(p.name)+'</strong></td>';
                    html+='<td><span style="background:#f3e5ff;color:#4a148c;padding:2px 8px;border-radius:10px;font-size:12px">'+shEsc(p.cls)+'</span></td>';
                    html+='<td style="text-align:center;font-weight:700;color:'+(p.approved===p.totalTasks?'#2e7d32':'#555')+'">'+p.approved+'/'+p.totalTasks+'</td>';
                    html+='<td style="min-width:120px"><div style="background:#eee;border-radius:6px;height:8px;margin-bottom:3px"><div style="background:'+(pct>=100?'#4caf50':'#9c27b0')+';width:'+pct+'%;height:8px;border-radius:6px"></div></div><span style="font-size:11px;color:#555">'+pct+'%</span></td>';
                    html+='</tr>';
                });
            }
            html+='</tbody></table></div>';
            if(listEl) listEl.innerHTML=html;

            // Load currently declared winner
            shLoadDeclaredWinner();
        } catch(e) {
            if(listEl) listEl.innerHTML='<p style="color:red">Error: '+e.message+'</p>';
        }
    }

    async function shLoadDeclaredWinner() {
        const box = document.getElementById('shWinnersDeclaredBox');
        if(!box) return;
        try {
            const snap = await window.db.ref('scavengerHunt/winner').once('value');
            const w = snap.val();
            if(!w){ box.style.display='none'; return; }
            box.style.display='block';
            const dateStr   = w.declaredFor ? new Date(w.declaredFor).toLocaleDateString('en-IN',{day:'2-digit',month:'short',year:'numeric'}) : '';
            const taskStr   = w.taskLabel   || 'All tasks';
            const declaredStr = new Date(w.declaredAt).toLocaleString('en-IN',{day:'2-digit',month:'short',year:'numeric',hour:'2-digit',minute:'2-digit',hour12:true});
            box.innerHTML = '<div style="background:linear-gradient(135deg,#ffd700,#ff9800);border-radius:14px;padding:22px;margin-top:10px;color:#3d0060">'
                +'<h4 style="margin:0 0 6px;font-size:1.1em">ðŸŽ–ï¸ Currently Declared Winner</h4>'
                +'<div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:14px">'
                +(dateStr?'<span style="background:rgba(255,255,255,0.6);padding:3px 10px;border-radius:12px;font-size:12px;font-weight:700">ðŸ“… '+dateStr+'</span>':'')
                +'<span style="background:rgba(255,255,255,0.6);padding:3px 10px;border-radius:12px;font-size:12px;font-weight:700">ðŸ—ºï¸ '+shEsc(taskStr)+'</span>'
                +'</div>'
                +'<div style="display:flex;gap:20px;flex-wrap:wrap">'
                +(w.winner?'<div style="background:rgba(255,255,255,0.7);border-radius:10px;padding:14px 20px;min-width:180px">'
                    +'<div style="font-size:1.8em;margin-bottom:4px">ðŸ¥‡</div>'
                    +'<strong style="font-size:1em;color:#1a237e">'+shEsc(w.winner.name)+'</strong>'
                    +'<br><span style="font-size:0.85em;color:#4a148c">'+shEsc(w.winner.cls)+'</span>'
                    +'<br><span style="font-size:0.8em;color:#555">'+w.winner.approved+'/'+w.winner.totalTasks+' tasks</span></div>':'')
                +(w.runnerUp?'<div style="background:rgba(255,255,255,0.5);border-radius:10px;padding:14px 20px;min-width:180px">'
                    +'<div style="font-size:1.8em;margin-bottom:4px">ðŸ¥ˆ</div>'
                    +'<strong style="font-size:1em;color:#1a237e">'+shEsc(w.runnerUp.name)+'</strong>'
                    +'<br><span style="font-size:0.85em;color:#4a148c">'+shEsc(w.runnerUp.cls)+'</span>'
                    +'<br><span style="font-size:0.8em;color:#555">'+w.runnerUp.approved+'/'+w.runnerUp.totalTasks+' tasks</span></div>':'')
                +'</div>'
                +'<div style="margin-top:12px;font-size:0.8em;opacity:0.75">Declared at: '+declaredStr+'</div>'
                +'<button onclick="shClearWinner()" class="btn btn-danger btn-small" style="margin-top:10px">ðŸ—‘ï¸ Clear Winner</button>'
                +'</div>';
        } catch(e) { console.warn('shLoadDeclaredWinner:', e); }
    }

    async function shSelectWinnersAuto() {
        if(!_shWinnersParticipants.length){ alert('Load participants first by clicking Refresh.'); return; }
        const top = _shWinnersParticipants[0];
        const maxApproved = top.approved;
        const eligible = _shWinnersParticipants.filter(p=>p.approved===maxApproved);
        if(eligible.length===0){ alert('No participants with approved tasks yet.'); return; }
        const winner = eligible[Math.floor(Math.random()*eligible.length)];
        const rest   = _shWinnersParticipants.filter(p=>p.key!==winner.key);
        const runnerUp = rest.length ? rest[0] : null;
        if(!confirm(`Auto-select:\nðŸ¥‡ Winner: ${winner.name} (${winner.cls})\n${runnerUp ? 'ðŸ¥ˆ Runner-up: '+runnerUp.name+' ('+runnerUp.cls+')' : ''}\n\nDeclare these winners?`)) return;
        await shSaveWinner(winner, runnerUp);
    }

    // -- Scavenger Hunt Auto-Declaration Scheduler --------------------
    let _shAutoDeclarInterval = null;

    function shToggleAutoDeclar() {
        const enabled = document.getElementById('shAutoDeclarToggle').checked;
        shApplyAutoDeclarUI(enabled);
        // Save to Firebase
        const time   = document.getElementById('shAutoDeclarTime').value || '23:30';
        const date   = document.getElementById('shAutoDeclarDate').value || '';
        const taskId = document.getElementById('shAutoDeclarTask').value || 'all';
        window.db.ref('scavengerHunt/autoDeclarConfig').set({ enabled, time, date, taskId, updatedAt: new Date().toISOString() });
        if (enabled) shStartAutoDeclarScheduler(); else shStopAutoDeclarScheduler();
    }

    function shApplyAutoDeclarUI(enabled) {
        const slider  = document.getElementById('shAutoDeclarSlider');
        const thumb   = document.getElementById('shAutoDeclarThumb');
        const badge   = document.getElementById('shAutoDeclarBadge');
        const status  = document.getElementById('shAutoDeclarStatusMsg');
        const countdown = document.getElementById('shAutoDeclarCountdownDisplay');
        if (!slider) return;
        const time = document.getElementById('shAutoDeclarTime')?.value || '23:30';
        const [hh, mm] = time.split(':').map(Number);
        const ampm = hh >= 12 ? 'PM' : 'AM';
        const h12  = hh % 12 || 12;
        const timeStr = `${h12}:${String(mm).padStart(2,'0')} ${ampm}`;
        if (enabled) {
            slider.style.background = '#28a745'; thumb.style.left = '25px';
            badge.textContent = 'ON';
            status.innerHTML = `ðŸŸ¢ Auto-declaration <strong style="color:#a5ffb8">enabled</strong>. Winners will be declared at <strong style="color:#ffd700">${timeStr}</strong> on the set date.`;
            countdown.style.display = 'block';
            shUpdateCountdown();
        } else {
            slider.style.background = '#555'; thumb.style.left = '3px';
            badge.textContent = 'OFF';
            status.innerHTML = 'ðŸ”´ Auto-declaration is <strong style="color:#ff6b6b">disabled</strong>. Toggle ON and save config to enable.';
            countdown.style.display = 'none';
        }
    }

    function shUpdateCountdown() {
        const el = document.getElementById('shAutoDeclarCountdownDisplay');
        if (!el) return;
        const time = document.getElementById('shAutoDeclarTime')?.value || '23:30';
        const date = document.getElementById('shAutoDeclarDate')?.value || '';
        const [hh, mm] = time.split(':').map(Number);
        const now = new Date();
        let target;
        if (date) {
            target = new Date(`${date}T${String(hh).padStart(2,'0')}:${String(mm).padStart(2,'0')}:00`);
        } else {
            target = new Date(); target.setHours(hh, mm, 0, 0);
            if (now >= target) target.setDate(target.getDate() + 1);
        }
        if (now >= target) {
            el.textContent = 'â° Scheduled time has passed.'; return;
        }
        const diff = Math.floor((target - now) / 1000);
        const h = Math.floor(diff / 3600), m = Math.floor((diff % 3600) / 60), s = diff % 60;
        el.textContent = `â³ Auto-declaration in: ${String(h).padStart(2,'0')}h ${String(m).padStart(2,'0')}m ${String(s).padStart(2,'0')}s`;
    }

    function shStartAutoDeclarScheduler() {
        shStopAutoDeclarScheduler();
        _shAutoDeclarInterval = setInterval(async () => {
            const toggle = document.getElementById('shAutoDeclarToggle');
            if (!toggle || !toggle.checked) return;
            shUpdateCountdown();
            const time = document.getElementById('shAutoDeclarTime')?.value || '23:30';
            const date = document.getElementById('shAutoDeclarDate')?.value || '';
            const [hh, mm] = time.split(':').map(Number);
            const now = new Date();
            const todayStr = now.toISOString().slice(0, 10);
            // Fire only if date matches (or no date set) AND time matches current minute
            const dateMatch = !date || date === todayStr;
            if (dateMatch && now.getHours() === hh && now.getMinutes() === mm) {
                await shRunAutoDeclaration();
            }
        }, 1000);
    }

    function shStopAutoDeclarScheduler() {
        if (_shAutoDeclarInterval) { clearInterval(_shAutoDeclarInterval); _shAutoDeclarInterval = null; }
    }

    async function shRunAutoDeclaration() {
        shStopAutoDeclarScheduler();
        try {
            const cfgSnap    = await window.db.ref('scavengerHunt/autoDeclarConfig').once('value');
            const cfg        = cfgSnap.val() || {};
            const filterTaskId = cfg.taskId || 'all';
            const targetDate   = cfg.date   || null;

            // Skip if date set and doesn't match today
            if (targetDate && targetDate !== new Date().toISOString().slice(0, 10)) {
                console.log('[SH-AutoDeclar] Date mismatch â€” skipping.'); return;
            }
            // Skip if already declared today
            const winSnap = await window.db.ref('scavengerHunt/winner').once('value');
            const existing = winSnap.val();
            if (existing?.declaredAt?.slice(0, 10) === new Date().toISOString().slice(0, 10)) {
                console.log('[SH-AutoDeclar] Already declared today â€” skipping.'); return;
            }

            const [taskSnap, subSnap] = await Promise.all([
                window.db.ref('scavengerHunt/tasks').once('value'),
                window.db.ref('scavengerHunt/submissions').once('value')
            ]);
            const allTasks   = taskSnap.val() || {};
            const totalTasks = Object.keys(allTasks).length;
            const allSubs    = subSnap.val() || {};

            const participants = [];
            Object.entries(allSubs).forEach(([sk, ss]) => {
                const first = Object.values(ss)[0] || {};
                let approved = 0, lastTime = null;
                if (filterTaskId === 'all') {
                    Object.values(ss).forEach(sub => { if (sub.status === 'approved') { approved++; if (!lastTime || sub.reviewedAt > lastTime) lastTime = sub.reviewedAt; } });
                } else {
                    const sub = ss[filterTaskId];
                    if (sub?.status === 'approved') { approved = 1; lastTime = sub.reviewedAt || ''; }
                }
                participants.push({ key: sk, name: first.studentName || sk, cls: first.studentClass || '', approved, totalTasks, lastTime: lastTime || '' });
            });
            participants.sort((a, b) => b.approved - a.approved || (a.lastTime || 'zzz').localeCompare(b.lastTime || 'zzz'));

            if (!participants.length || participants[0].approved === 0) {
                const s = document.getElementById('shAutoDeclarStatusMsg');
                if (s) s.innerHTML = 'âš ï¸ Auto-declaration ran but <strong>no approved submissions</strong> found for the selected task.';
                return;
            }

            const maxApproved = participants[0].approved;
            const eligible    = participants.filter(p => p.approved === maxApproved);
            const winner      = eligible[Math.floor(Math.random() * eligible.length)];
            const rest        = participants.filter(p => p.key !== winner.key);
            const runnerUp    = rest.length ? rest[0] : null;
            const taskLabel   = filterTaskId === 'all' ? 'All tasks' : (allTasks[filterTaskId]?.name || filterTaskId);

            await shSaveWinner(winner, runnerUp, taskLabel, targetDate);
            const s = document.getElementById('shAutoDeclarStatusMsg');
            if (s) s.innerHTML = `âœ… Declared! ðŸ¥‡ ${winner.name} (${winner.cls})${runnerUp ? ' | ðŸ¥ˆ ' + runnerUp.name + ' (' + runnerUp.cls + ')' : ''}`;
            console.log(`[SH-AutoDeclar] âœ… Winner: ${winner.name}`);
        } catch(e) {
            console.error('[SH-AutoDeclar] Error:', e);
        } finally {
            shStartAutoDeclarScheduler();
        }
    }

    async function shInitAutoDeclarScheduler() {
        try {
            // Load tasks into dropdown
            const taskSnap = await window.db.ref('scavengerHunt/tasks').once('value');
            const tasks = Object.entries(taskSnap.val() || {}).map(([k,v])=>({id:k,...v})).sort((a,b)=>(a.order||0)-(b.order||0));
            const taskSel = document.getElementById('shAutoDeclarTask');
            if (taskSel) {
                taskSel.innerHTML = '<option value="all">â­ All tasks</option>';
                tasks.forEach(t => {
                    const o = document.createElement('option');
                    o.value = t.id;
                    o.textContent = `Task ${t.order||'?'}: ${t.name.length > 45 ? t.name.slice(0,45)+'â€¦' : t.name}`;
                    taskSel.appendChild(o);
                });
            }
            // Restore saved config
            const cfgSnap = await window.db.ref('scavengerHunt/autoDeclarConfig').once('value');
            const cfg = cfgSnap.val() || {};
            if (cfg.date   && document.getElementById('shAutoDeclarDate')) document.getElementById('shAutoDeclarDate').value = cfg.date;
            if (cfg.time   && document.getElementById('shAutoDeclarTime')) document.getElementById('shAutoDeclarTime').value = cfg.time;
            if (cfg.taskId && taskSel) taskSel.value = cfg.taskId;
            const enabled = !!cfg.enabled;
            const toggle  = document.getElementById('shAutoDeclarToggle');
            if (toggle) toggle.checked = enabled;
            shApplyAutoDeclarUI(enabled);
            if (enabled) shStartAutoDeclarScheduler();
        } catch(e) { console.warn('[SH-AutoDeclar] Init error:', e); }
    }

    async function shSaveAutoDeclarConfig(btn) {
        const date   = document.getElementById('shAutoDeclarDate').value;
        const time   = document.getElementById('shAutoDeclarTime').value || '23:30';
        const taskId = document.getElementById('shAutoDeclarTask').value;
        const enabled = document.getElementById('shAutoDeclarToggle').checked;
        if (!date) { alert('Please select a date.'); return; }
        try {
            await window.db.ref('scavengerHunt/autoDeclarConfig').set({ enabled, date, time, taskId, updatedAt: new Date().toISOString() });
            shApplyAutoDeclarUI(enabled);
            if (enabled) shStartAutoDeclarScheduler();
            const orig = btn.textContent;
            btn.textContent = 'âœ… Saved!'; btn.style.background = '#4caf50'; btn.style.color = 'white';
            setTimeout(() => { btn.textContent = orig; btn.style.background = '#ffd700'; btn.style.color = '#1a0030'; }, 2000);
        } catch(e) { alert('Save failed: ' + e.message); }
    }

    function shSyncAutoDeclarPanel() {} // no-op, kept for compatibility

    function shToggleManualWinner() {
        const p = document.getElementById('shManualWinnerPanel');
        if(p) p.style.display = p.style.display==='none' ? 'block' : 'none';
    }

    async function shDeclareManualWinners() {
        const wKey = document.getElementById('shManualWinnerSelect').value;
        const rKey = document.getElementById('shManualRunnerSelect').value;
        if(!wKey){ alert('Please select a winner.'); return; }
        if(wKey===rKey){ alert('Winner and Runner-up cannot be the same person.'); return; }
        const winner   = _shWinnersParticipants.find(p=>p.key===wKey);
        const runnerUp = rKey ? _shWinnersParticipants.find(p=>p.key===rKey) : null;
        if(!confirm(`Declare:
ðŸ¥‡ Winner: ${winner.name} (${winner.cls})
${runnerUp ? 'ðŸ¥ˆ Runner-up: '+runnerUp.name+' ('+runnerUp.cls+')' : ''}

Proceed?`)) return;
        await shSaveWinner(winner, runnerUp);
        shToggleManualWinner();
    }

    async function shSaveWinner(winner, runnerUp, taskLabel, declaredDate) {
        try {
            const data = {
                winner:   {key:winner.key,   name:winner.name,   cls:winner.cls,   approved:winner.approved,   totalTasks:winner.totalTasks},
                runnerUp: runnerUp ? {key:runnerUp.key, name:runnerUp.name, cls:runnerUp.cls, approved:runnerUp.approved, totalTasks:runnerUp.totalTasks} : null,
                declaredAt:   new Date().toISOString(),
                declaredFor:  declaredDate || new Date().toISOString().slice(0,10),
                taskLabel:    taskLabel || 'All tasks',
                autoSelected: true
            };
            await window.db.ref('scavengerHunt/winner').set(data);
            const toast = document.createElement('div');
            toast.textContent = 'ðŸŽ–ï¸ Winners declared successfully!';
            toast.style.cssText = 'position:fixed;top:20px;left:50%;transform:translateX(-50%);background:#4caf50;color:white;padding:12px 28px;border-radius:30px;font-weight:700;font-size:1em;z-index:9999;box-shadow:0 4px 20px rgba(0,0,0,0.2);transition:opacity 0.5s';
            document.body.appendChild(toast);
            setTimeout(()=>{ toast.style.opacity='0'; setTimeout(()=>toast.remove(),500); }, 2500);
            shLoadDeclaredWinner();
        } catch(e) { alert('Failed to save winner: '+e.message); }
    }

    async function shClearWinner() {
        if(!confirm('Clear the declared winner? This cannot be undone.')) return;
        await window.db.ref('scavengerHunt/winner').remove();
        const box = document.getElementById('shWinnersDeclaredBox');
        if(box) box.style.display='none';
    }

    // -- Admin: Settings ------------------------------------------------
    // -- Remove All Deadlines from all tasks --------------------------
    async function shRemoveAllDeadlines(){
        var el=document.getElementById('shChainFixResult');
        el.style.display='block';
        el.textContent='Removing deadlines from all tasks...\n';
        try{
            var snap=await window.db.ref('scavengerHunt/tasks').once('value');
            var raw=snap.val()||{};
            var tasks=Object.entries(raw).map(function(e){return Object.assign({id:e[0]},e[1]);});
            if(!tasks.length){el.textContent='No tasks found.';return;}
            var updates={};
            for(var i=0;i<tasks.length;i++){
                updates['scavengerHunt/tasks/'+tasks[i].id+'/deadline']=null;
                updates['scavengerHunt/tasks/'+tasks[i].id+'/availableFrom']=null;
                el.textContent+='Removing deadline from: "'+tasks[i].name.substring(0,50)+'...\n';
            }
            await window.db.ref().update(updates);
            el.textContent+='Done! All deadlines removed from '+tasks.length+' task(s). Students can now submit. Tell them to refresh.';
        }catch(e){el.textContent+='Error: '+e.message;}
    }

    // -- Cloudinary Test ---------------------------------------------
    async function shTestCloudinary() {
        var fileInput=document.getElementById('shCloudTestFile');
        var resultEl=document.getElementById('shCloudTestResult');
        resultEl.innerHTML='Testing...'; resultEl.style.color='#555';
        var file=fileInput&&fileInput.files&&fileInput.files[0];
        if(!file){
            var b64='iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNk+M9QDwADhgGAWjR9awAAAABJRU5ErkJggg==';
            var bs=atob(b64),ab=new ArrayBuffer(bs.length),ia=new Uint8Array(ab);
            for(var i=0;i<bs.length;i++){ia[i]=bs.charCodeAt(i);}
            file=new Blob([ab],{type:'image/png'});
        }
        try{
            var fd=new FormData();
            fd.append('file',file);
            fd.append('upload_preset','scavenger_hunt');
            fd.append('folder','scavenger_hunt/_test_');
            fd.append('public_id','test_'+Date.now());
            var res=await fetch('https://api.cloudinary.com/v1_1/dat0khbet/image/upload',{method:'POST',body:fd});
            var data=await res.json();
            if(data.secure_url){
                resultEl.style.color='#2e7d32';
                resultEl.innerHTML='<strong>Cloudinary WORKING!</strong><br>URL: <a href="'+data.secure_url+'" target="_blank" style="word-break:break-all;color:#1565c0">'+data.secure_url+'</a><br><small>Size: '+data.bytes+' bytes</small>';
            } else {
                resultEl.style.color='red';
                resultEl.innerHTML='Failed: '+((data.error&&data.error.message)||JSON.stringify(data));
            }
        }catch(e){resultEl.style.color='red';resultEl.innerHTML='Error: '+e.message;}
    }

    // -- Fix Chain Order -----------------------------------------------
    async function shFixChainOrder(doWrite){
        var el=document.getElementById('shChainFixResult');
        el.style.display='block';
        el.textContent='Loading tasks...\n';
        try{
            var snap=await window.db.ref('scavengerHunt/tasks').once('value');
            var raw=snap.val()||{};
            var tasks=Object.entries(raw).map(function(e){return Object.assign({id:e[0]},e[1]);}).sort(function(a,b){return (a.order||0)-(b.order||0);});
            for(var i=0;i<tasks.length;i++){
                el.textContent+=(i+1)+'. "'+tasks[i].name+'" current order: '+tasks[i].order+'\n';
            }
            if(!doWrite){
                el.textContent+='\nTap Fix Order Numbers to renumber 1,2,3...';
                return;
            }
            var updates={};
            for(var j=0;j<tasks.length;j++){
                updates['scavengerHunt/tasks/'+tasks[j].id+'/order']=j+1;
            }
            await window.db.ref().update(updates);
            el.textContent+='\nFixed! Task 1 = order 1, Task 2 = order 2.\nTell students to refresh â€” they can now submit Task 1.';
        }catch(e){el.textContent+='\nError: '+e.message;}
    }

    // -- Admin Force Submit --------------------------------------------
    async function shAdminForceSubmit(){
        var studentKey=(document.getElementById('afsStudentKey')?document.getElementById('afsStudentKey').value:'').trim();
        var taskId=(document.getElementById('afsTaskId')?document.getElementById('afsTaskId').value:'').trim();
        var photoUrl=(document.getElementById('afsPhotoUrl')?document.getElementById('afsPhotoUrl').value:'').trim();
        var comment=(document.getElementById('afsComment')?document.getElementById('afsComment').value:'').trim();
        var resultEl=document.getElementById('afsResult');
        if(!studentKey||!taskId){resultEl.innerHTML='<span style="color:red">Enter student key and select task.</span>';return;}
        if(!photoUrl){resultEl.innerHTML='<span style="color:red">Enter the Cloudinary photo URL.</span>';return;}
        try{
            var tSnap=await window.db.ref('scavengerHunt/tasks/'+taskId).once('value');
            var sSnap=await window.db.ref('students/'+studentKey).once('value');
            var task=tSnap.val()||{};
            var stu=sSnap.val()||{};
            await window.db.ref('scavengerHunt/submissions/'+studentKey+'/'+taskId).set({
                taskId:taskId, taskName:task.name||taskId,
                studentKey:studentKey, studentName:stu.name||studentKey,
                studentEmail:stu.email||'', studentClass:stu.class||stu.classYear||'',
                photoUrl:photoUrl, comment:comment||'Admin force-submitted',
                status:'pending', submittedAt:new Date().toISOString(),
                lat:null, lng:null, adminForced:true
            });
            resultEl.innerHTML='<span style="color:#2e7d32">Done! '+studentKey+' Task is now Pending Review.</span>';
        }catch(e){resultEl.innerHTML='<span style="color:red">Error: '+e.message+'</span>';}
    }

    async function shPopulateAfsTaskDropdown(){
        var sel=document.getElementById('afsTaskId');
        if(!sel){return;}
        try{
            var snap=await window.db.ref('scavengerHunt/tasks').once('value');
            var raw=snap.val()||{};
            var tasks=Object.entries(raw).map(function(e){return Object.assign({id:e[0]},e[1]);}).sort(function(a,b){return (a.order||0)-(b.order||0);});
            sel.innerHTML='<option value="">â€” Select Task â€”</option>';
            for(var i=0;i<tasks.length;i++){
                var o=document.createElement('option');
                o.value=tasks[i].id;
                o.textContent=(tasks[i].order||'?')+'. '+(tasks[i].name||tasks[i].id).substring(0,60);
                sel.appendChild(o);
            }
        }catch(e){}
    }

    // -- Student Submission Debugger -----------------------------------
    async function shDebugStudentSubs(){
        var key=(document.getElementById('shDebugStudentKey')?document.getElementById('shDebugStudentKey').value:'').trim();
        var resultEl=document.getElementById('shDebugResult');
        if(!key){alert('Enter a student key');return;}
        resultEl.style.display='block';
        resultEl.textContent='Loading...\n';
        try{
            var subSnap=await window.db.ref('scavengerHunt/submissions/'+key).once('value');
            var taskSnap=await window.db.ref('scavengerHunt/tasks').once('value');
            var subs=subSnap.val();
            var tasks=taskSnap.val();
            var out='=== TASKS ===\n';
            if(tasks){
                var arr=Object.entries(tasks).map(function(e){return Object.assign({id:e[0]},e[1]);}).sort(function(a,b){return (a.order||0)-(b.order||0);});
                for(var i=0;i<arr.length;i++){
                    var t=arr[i];
                    var sub=subs&&subs[t.id];
                    out+='\nTask '+(i+1)+': "'+t.name.substring(0,50)+'" (order:'+t.order+')\n';
                    if(sub){
                        out+='  status:      '+sub.status+'\n';
                        out+='  submittedAt: '+(sub.submittedAt||'MISSING - causes Locked!')+'\n';
                        out+='  photoUrl:    '+(sub.photoUrl?'present':'MISSING')+'\n';
                    }else{
                        out+='  No submission found\n';
                    }
                }
            }
            out+='\n=== RAW ===\n'+(subs?JSON.stringify(subs,null,2):'empty - no submissions for: '+key);
            resultEl.textContent=out;
        }catch(e){resultEl.textContent='Error: '+e.message;}
    }

    async function shAdminLoadSettings() {
        try {
            const snap = await window.db.ref('scavengerHunt/settings').once('value');
            const s = snap.val() || {};
            document.getElementById('shSettingActive').checked      = !!s.active;
            document.getElementById('shSettingGPS').checked         = s.gps!==false;
            document.getElementById('shSettingRadius').value        = s.radius||100;
            document.getElementById('shSettingAutoApprove').checked = !!s.autoApprove;
        } catch(e) { console.error('shAdminLoadSettings:',e); }
    }

    async function shAdminSaveSettings() {
        const settings = {
            active:      document.getElementById('shSettingActive').checked,
            gps:         document.getElementById('shSettingGPS').checked,
            radius:      parseInt(document.getElementById('shSettingRadius').value)||100,
            autoApprove: document.getElementById('shSettingAutoApprove').checked,
            updatedAt:   new Date().toISOString()
        };
        await window.db.ref('scavengerHunt/settings').set(settings);
        const msg = document.getElementById('shSettingsSaveMsg');
        msg.style.display='inline-block';
        setTimeout(()=>msg.style.display='none', 3000);
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // SITE SETTINGS â€” Dynamic Banner + WhatsApp Text
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    const BANNER_COLORS = {
        orange: 'linear-gradient(90deg,#e8722a 0%,#f0a05a 40%,#f0a05a 60%,#e8722a 100%)',
        purple: 'linear-gradient(90deg,#6a1b9a 0%,#c44569 40%,#c44569 60%,#6a1b9a 100%)',
        green:  'linear-gradient(90deg,#2e7d32 0%,#66bb6a 40%,#66bb6a 60%,#2e7d32 100%)',
        red:    'linear-gradient(90deg,#c62828 0%,#ef5350 40%,#ef5350 60%,#c62828 100%)',
        blue:   'linear-gradient(90deg,#1565c0 0%,#42a5f5 40%,#42a5f5 60%,#1565c0 100%)',
        gold:   'linear-gradient(90deg,#f9a825 0%,#ffd54f 40%,#ffd54f 60%,#f9a825 100%)'
    };

    // Apply banner from Firebase on page load
    async function initDynamicBanner() {
        try {
            const snap = await db.ref('siteSettings/banner').once('value');
            const data = snap.val();
            if (!data) return;
            const bannerDiv = document.getElementById('announcementBannerDiv');
            const bannerText = document.getElementById('announcementBannerText');
            if (!bannerDiv || !bannerText) return;
            bannerDiv.style.display = data.visible === false ? 'none' : 'block';
            if (data.text) bannerText.textContent = data.text;
            if (data.color && BANNER_COLORS[data.color]) {
                bannerDiv.style.background = BANNER_COLORS[data.color];
                bannerText.style.color = data.color === 'gold' ? '#5d4037' : 'white';
            }
            if (data.font) bannerText.style.fontFamily = data.font;
            if (data.fontSize) bannerText.style.fontSize = data.fontSize + 'px';
        } catch(e) { console.warn('initDynamicBanner error:', e); }
    }

    async function loadSiteSettings() {
        const msg = document.getElementById('siteSettingsMsg');
        if (msg) msg.innerHTML = '<p style="color:#666;text-align:center">â³ Loading settings...</p>';
        try {
            const snap = await db.ref('siteSettings').once('value');
            const data = snap.val() || {};
            // Banner
            const banner = data.banner || {};
            const bannerText = document.getElementById('ssBannerText');
            if (bannerText) bannerText.value = banner.text || 'ðŸŽ¯ðŸ§© Speed Slide Challenge is LIVE now ðŸ§©ðŸŽ¯';
            const showRadio = document.getElementById('bannerShow');
            const hideRadio = document.getElementById('bannerHide');
            if (showRadio && hideRadio) {
                if (banner.visible === false) { hideRadio.checked = true; } else { showRadio.checked = true; }
            }
            // Font
            const fontSelect = document.getElementById('ssBannerFont');
            if (fontSelect && banner.font) fontSelect.value = banner.font;
            // Font size
            const fontSizeEl = document.getElementById('ssBannerFontSize');
            const fontSizeVal = document.getElementById('ssBannerFontSizeVal');
            if (fontSizeEl && banner.fontSize) { fontSizeEl.value = banner.fontSize; if (fontSizeVal) fontSizeVal.textContent = banner.fontSize + 'px'; }
            // Color
            const color = banner.color || 'orange';
            const colorRadio = document.getElementById('bColor' + color.charAt(0).toUpperCase() + color.slice(1));
            if (colorRadio) colorRadio.checked = true;
            else { const fallback = document.getElementById('bColorOrange'); if(fallback) fallback.checked = true; }
            // WhatsApp
            const waText = document.getElementById('ssWhatsappText');
            if (waText) waText.value = data.whatsappText || 'ðŸŽ“ Join our exciting Daily Quiz Competition! Answer 2 questions daily and win prizes. Register now and compete for glory!';
            if (msg) msg.innerHTML = '<p style="color:#28a745;background:#d4edda;padding:10px 14px;border-radius:8px;font-weight:600">âœ… Settings loaded successfully.</p>';
            setTimeout(() => { if(msg) msg.innerHTML = ''; }, 3000);
        } catch(e) {
            if (msg) msg.innerHTML = '<p style="color:#c62828;background:#fde8e8;padding:10px 14px;border-radius:8px">âŒ Error loading settings: ' + e.message + '</p>';
        }
    }

    async function saveBannerSettings() {
        const text = (document.getElementById('ssBannerText')?.value || '').trim();
        if (!text) { alert('âš ï¸ Please enter banner text!'); return; }
        const visible = !document.getElementById('bannerHide')?.checked;
        const colorChecked = document.querySelector('input[name="bannerColor"]:checked');
        const color = colorChecked ? colorChecked.value : 'orange';
        const fontSelect = document.getElementById('ssBannerFont');
        const font = fontSelect ? fontSelect.value : "'Segoe UI',sans-serif";
        const fontSizeEl = document.getElementById('ssBannerFontSize');
        const fontSize = fontSizeEl ? parseInt(fontSizeEl.value) : 18;
        try {
            await db.ref('siteSettings/banner').set({ text, visible, color, font, fontSize, updatedAt: new Date().toISOString(), updatedBy: 'Super Admin' });
            // Apply immediately on this page
            const bannerDiv = document.getElementById('announcementBannerDiv');
            const bannerSpan = document.getElementById('announcementBannerText');
            if (bannerDiv) { bannerDiv.style.display = visible ? 'block' : 'none'; bannerDiv.style.background = BANNER_COLORS[color] || BANNER_COLORS.orange; }
            if (bannerSpan) {
                bannerSpan.textContent = text;
                bannerSpan.style.color = color === 'gold' ? '#5d4037' : 'white';
                bannerSpan.style.fontFamily = font;
                bannerSpan.style.fontSize = fontSize + 'px';
            }
            // Show toast
            const toast = document.getElementById('bannerSaveToast');
            if (toast) { toast.style.display = 'inline-block'; setTimeout(() => { toast.style.display = 'none'; }, 3500); }
        } catch(e) {
            alert('âŒ Error saving banner: ' + e.message);
        }
    }

    function previewBanner() {
        const text = document.getElementById('ssBannerText')?.value || '';
        const colorChecked = document.querySelector('input[name="bannerColor"]:checked');
        const color = colorChecked ? colorChecked.value : 'orange';
        const visible = !document.getElementById('bannerHide')?.checked;
        const font = document.getElementById('ssBannerFont')?.value || "'Segoe UI',sans-serif";
        const fontSize = document.getElementById('ssBannerFontSize')?.value || 18;
        const bannerDiv = document.getElementById('announcementBannerDiv');
        const bannerSpan = document.getElementById('announcementBannerText');
        if (bannerDiv) { bannerDiv.style.display = visible ? 'block' : 'none'; bannerDiv.style.background = BANNER_COLORS[color] || BANNER_COLORS.orange; }
        if (bannerSpan) {
            bannerSpan.textContent = text || '(empty)';
            bannerSpan.style.color = color === 'gold' ? '#5d4037' : 'white';
            bannerSpan.style.fontFamily = font;
            bannerSpan.style.fontSize = fontSize + 'px';
        }
        alert('ðŸ‘ï¸ Preview applied! Scroll up to see the banner. Click Save to make it permanent.');
    }

    async function saveWhatsappText() {
        const text = (document.getElementById('ssWhatsappText')?.value || '').trim();
        if (!text) { alert('âš ï¸ Please enter WhatsApp share text!'); return; }
        try {
            await db.ref('siteSettings/whatsappText').set(text);
            // Update og:description meta tag (best-effort for new shares)
            const ogDesc = document.querySelector('meta[property="og:description"]');
            if (ogDesc) ogDesc.setAttribute('content', text);
            const twitterDesc = document.querySelector('meta[name="twitter:description"]');
            if (twitterDesc) twitterDesc.setAttribute('content', text);
            // Show toast
            const toast = document.getElementById('waSaveToast');
            if (toast) { toast.style.display = 'inline-block'; setTimeout(() => { toast.style.display = 'none'; }, 3500); }
        } catch(e) {
            alert('âŒ Error saving WhatsApp text: ' + e.message);
        }
    }

    function copyWhatsappShareLink() {
        const url = 'https://harshgujjar.github.io/Spurthi-youth-fest-2026/';
        const text = document.getElementById('ssWhatsappText')?.value || '';
        const fullText = (text ? text + '\n\n' : '') + url;
        navigator.clipboard.writeText(fullText).then(() => { alert('âœ… Link + text copied to clipboard! Paste in WhatsApp.'); }).catch(() => { prompt('Copy this link:', fullText); });
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // FEEDBACK SYSTEM
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    let fbDismissCount = 0;
    let fbAlreadySubmitted = false;
    let fbCurrentRecommend = '';
    let fbEventRatings = {};
    let fbListenerAttached = false;

    // Default events list
    const FB_DEFAULT_EVENTS = [
        'Social Awareness Skit','Mad Ads','YouTube Advertisement','Case Analysis',
        'Vlog','Podcast','Hand Writing','Talent Hunt','Best Out of Waste',
        'Interdisciplinary','Quiz','Speed Slide Challenge','Nukkad Natak'
    ];

    // On page load â€” listen for feedback trigger from Firebase
    async function initFeedbackSystem() {
        try {
            fbDismissCount = parseInt(localStorage.getItem('spurthi_fb_dismiss') || '0');
            if (!fbListenerAttached) {
                fbListenerAttached = true;
                db.ref('feedbackSettings').on('value', async snap => {
                    const data = snap.val();
                    if (!data || !data.active) return;
                    // Load maxDismiss
                    fbMaxDismiss = (data.maxDismiss !== undefined) ? parseInt(data.maxDismiss) : 1;
                    // Handle admin reset token
                    const storedToken = localStorage.getItem('spurthi_fb_reset_token');
                    const serverToken = data.resetToken || '';
                    if (serverToken && storedToken !== serverToken) {
                        localStorage.removeItem('spurthi_fb_dismiss');
                        localStorage.removeItem('spurthi_fb_submitted');
                        localStorage.setItem('spurthi_fb_reset_token', serverToken);
                        fbDismissCount = 0;
                        fbAlreadySubmitted = false;
                    }
                    // -- Deduplication check ------------------------------
                    // 1. If quiz student is logged in â€” check Firebase by their key
                    if (quizCurrentUser && quizCurrentUser.key) {
                        try {
                            const chk = await db.ref('feedbackSubmitted/students/' + quizCurrentUser.key).once('value');
                            if (chk.exists()) { fbAlreadySubmitted = true; return; } // silently skip
                        } catch(e) {}
                    } else {
                        // 2. Non-logged-in visitor â€” check localStorage only (phone checked at submit time)
                        const subKey = localStorage.getItem('spurthi_fb_submitted');
                        if (subKey === 'yes') { fbAlreadySubmitted = true; return; }
                    }
                    if (fbAlreadySubmitted) return;
                    showFeedbackPopup(data);
                });
            }
        } catch(e) { console.warn('initFeedbackSystem error:', e); }
    }

    async function showFeedbackPopup(settings) {
        if (fbAlreadySubmitted) return;
        const overlay = document.getElementById('feedbackPopupOverlay');
        if (!overlay || overlay.style.display === 'flex') return;
        // Set close button behavior based on dismiss count vs maxDismiss
        fbMaxDismiss = (settings && settings.maxDismiss !== undefined) ? parseInt(settings.maxDismiss) : fbMaxDismiss;
        const closeBtn = document.getElementById('fbPopupCloseBtn');
        const mustFill = fbDismissCount >= fbMaxDismiss;
        if (closeBtn) closeBtn.style.display = mustFill ? 'none' : 'flex';
        // Show/hide the must-fill warning banner â€” message depends on WHY it's forced
        let warnBanner = document.getElementById('fbMustFillBanner');
        if (!warnBanner) {
            warnBanner = document.createElement('div');
            warnBanner.id = 'fbMustFillBanner';
            warnBanner.style.cssText = 'background:#fff8e1;border-left:4px solid #ffc107;padding:10px 16px;font-size:0.85em;color:#856404;font-weight:600;display:flex;align-items:center;gap:8px;border-radius:0';
            const header = overlay.querySelector('.fb-modal-header');
            if (header && header.nextSibling) header.parentNode.insertBefore(warnBanner, header.nextSibling);
        }
        if (mustFill) {
            // Dismissed at least once before â†’ they know they skipped it
            const hasDismissedBefore = fbDismissCount > 0;
            warnBanner.innerHTML = hasDismissedBefore
                ? 'âš ï¸ <span>You dismissed this earlier. Please fill the form to continue â€” this is required.</span>'
                : 'ðŸ“‹ <span>Your feedback is important to us. Please take a moment to fill this form â€” it only takes 30 seconds!</span>';
            warnBanner.style.display = 'flex';
            warnBanner.style.background  = hasDismissedBefore ? '#fff8e1' : '#e8f5e9';
            warnBanner.style.borderColor = hasDismissedBefore ? '#ffc107' : '#4caf50';
            warnBanner.style.color       = hasDismissedBefore ? '#856404' : '#1b5e20';
        } else {
            warnBanner.style.display = 'none';
        }
        // Build overall score buttons â€” always rebuild fresh so buttons are never missing
        const scoreRow = document.getElementById('fbOverallScoreRow');
        if (scoreRow) {
            let html = '';
            for (let i = 1; i <= 10; i++) {
                const color = i <= 3 ? '#f44336' : i <= 6 ? '#ff9800' : i <= 8 ? '#66bb6a' : '#2e7d32';
                html += `<button type="button" onclick="fbSetScore(${i},this)" style="width:40px;height:40px;border-radius:50%;border:2px solid ${color};background:white;color:${color};font-weight:800;font-size:0.95em;cursor:pointer;transition:all 0.2s">${i}</button>`;
            }
            scoreRow.innerHTML = html;
        }
        // Always reset the hidden score value so a previous pick doesn't carry over
        const scoreInp = document.getElementById('fbOverallScore');
        if (scoreInp) scoreInp.value = '';
        // Load event list for ratings
        await loadFeedbackEventRatings();
        // Auto-fill and configure fields based on login state
        const phoneRow    = document.getElementById('fbPhoneRow');
        const nameRow     = document.getElementById('fbName')?.closest('div');
        const classRow    = document.getElementById('fbClassSelect')?.closest('div');
        const classSelect = document.getElementById('fbClassSelect');
        if (quizCurrentUser && quizCurrentUser.key) {
            // -- Logged-in quiz student --------------------------------------
            // Hide name, class and phone rows entirely â€” visitor doesn't need to see/fill them.
            // Data is saved silently via hidden inputs.
            if (phoneRow) phoneRow.style.display = 'none';
            if (nameRow)  nameRow.style.display  = 'none';
            if (classRow) classRow.style.display = 'none';

            // Silently write real values into the form fields so submitFeedback() picks them up
            const nameEl = document.getElementById('fbName');
            if (nameEl) { nameEl.value = quizCurrentUser.name || ''; }

            const cls = quizCurrentUser.class || '';
            if (classSelect) {
                let matched = false;
                for (let opt of classSelect.options) { if (opt.value === cls) { classSelect.value = cls; matched = true; break; } }
                if (!matched && cls) {
                    classSelect.value = 'others';
                    const otherEl = document.getElementById('fbClassOther');
                    if (otherEl) { otherEl.value = cls; }
                }
            }
            document.getElementById('fbClass').value = cls;
        } else {
            // -- Anonymous visitor â€” show all fields editable ----------------
            if (phoneRow) phoneRow.style.display = 'block';
            if (nameRow)  nameRow.style.display  = 'block';
            if (classRow) classRow.style.display = 'block';
            // Reset fields so previous session doesn't bleed through
            const nameEl = document.getElementById('fbName');
            if (nameEl) { nameEl.value = ''; nameEl.readOnly = false; nameEl.style.background = ''; nameEl.style.color = ''; }
            if (classSelect) { classSelect.value = ''; classSelect.disabled = false; classSelect.style.background = ''; classSelect.style.color = ''; }
            const otherEl = document.getElementById('fbClassOther');
            if (otherEl) { otherEl.style.display = 'none'; otherEl.value = ''; otherEl.readOnly = false; otherEl.style.background = ''; }
        }
        overlay.style.display = 'flex';
        overlay.style.alignItems = 'flex-start';
        document.body.style.overflow = 'hidden';
        // Apply custom question layouts from saved labels
        const fbLbl = window._fbCustomLabels || fbCurrentLabels || FB_DEFAULT_QUESTION_LABELS;
        // Q7
        const q7wrap = document.getElementById('fbCustomQ7Wrap');
        if (q7wrap) q7wrap.style.display = fbLbl.customQ7Enabled ? 'block' : 'none';
        if (fbLbl.customQ7Enabled) {
            if (document.getElementById('fbCustomQ7Label')) {
                document.getElementById('fbCustomQ7Label').innerHTML = 'ðŸŽ¨ ' + (fbLbl.customQ7 || 'Q7') + (fbLbl.customQ7Req === 'required' ? ' <span style="color:#c2185b">*</span>' : '');
            }
            fbApplyCustomQLayout(7, fbLbl.customQ7Type || 'rate3');
        }
        // Q8
        const q8wrap = document.getElementById('fbCustomQ8Wrap');
        if (q8wrap) q8wrap.style.display = fbLbl.customQ8Enabled ? 'block' : 'none';
        if (fbLbl.customQ8Enabled) {
            if (document.getElementById('fbCustomQ8Label')) {
                document.getElementById('fbCustomQ8Label').innerHTML = 'ðŸ”¢ ' + (fbLbl.customQ8 || 'Q8') + (fbLbl.customQ8Req === 'required' ? ' <span style="color:#c2185b">*</span>' : '');
            }
            fbApplyCustomQLayout(8, fbLbl.customQ8Type || 'score10');
        }
        // Q9
        const q9wrap = document.getElementById('fbCustomQ9Wrap');
        if (q9wrap) q9wrap.style.display = fbLbl.customQ9Enabled ? 'block' : 'none';
        if (fbLbl.customQ9Enabled) {
            if (document.getElementById('fbCustomQ9Label')) {
                document.getElementById('fbCustomQ9Label').innerHTML = 'ðŸ“ ' + (fbLbl.customQ9 || 'Q9') + (fbLbl.customQ9Req === 'required' ? ' <span style="color:#c2185b">*</span>' : '');
            }
            fbApplyCustomQLayout(9, fbLbl.customQ9Type || 'textarea');
        }
    }

    async function loadFeedbackEventRatings() {
        const list = document.getElementById('fbEventRatingsList');
        if (!list) return;
        let events = FB_DEFAULT_EVENTS;
        try {
            const snap = await db.ref('feedbackSettings/events').once('value');
            if (snap.exists()) events = snap.val();
        } catch(e) {}
        if (!events || !events.length) { list.innerHTML = '<p style="color:#888;font-style:italic">No events selected for rating.</p>'; return; }
        let html = '';
        events.forEach((ev, idx) => {
            html += `<div style="background:#f8f9fa;border-radius:10px;padding:12px 14px;margin-bottom:10px;border:1px solid #e0e0e0">
                <div style="font-weight:700;color:#333;margin-bottom:8px;font-size:0.93em">ðŸ“Œ ${ev}</div>
                <div style="display:flex;gap:6px" id="fbStars_${idx}">
                    ${[1,2,3,4,5].map(s => `<button type="button" onclick="fbSetStar(${idx},'${ev.replace(/'/g,"\\'")}',${s},this)" style="width:36px;height:36px;font-size:1.3em;background:none;border:none;cursor:pointer;transition:transform 0.1s" title="${s} star${s>1?'s':''}">â˜†</button>`).join('')}
                </div>
            </div>`;
        });
        list.innerHTML = html;
        fbEventRatings = {};
    }

    function fbSetStar(idx, eventName, stars, btn) {
        fbEventRatings[eventName] = stars;
        const row = document.getElementById('fbStars_' + idx);
        if (!row) return;
        const btns = row.querySelectorAll('button');
        btns.forEach((b, i) => { b.textContent = (i < stars) ? 'â­' : 'â˜†'; b.style.transform = (i < stars) ? 'scale(1.1)' : 'scale(1)'; });
    }

    function fbSetScore(score, btn) {
        document.getElementById('fbOverallScore').value = score;
        const row = document.getElementById('fbOverallScoreRow');
        if (!row) return;
        row.querySelectorAll('button').forEach(b => {
            const n = parseInt(b.textContent);
            const color = n <= 3 ? '#f44336' : n <= 6 ? '#ff9800' : n <= 8 ? '#66bb6a' : '#2e7d32';
            b.style.background = (n <= score) ? color : 'white';
            b.style.color = (n <= score) ? 'white' : color;
            b.style.transform = (n === score) ? 'scale(1.15)' : 'scale(1)';
        });
    }

    function fbHandleClassChange(val) {
        const otherInput = document.getElementById('fbClassOther');
        const hiddenClass = document.getElementById('fbClass');
        if (val === 'others') {
            if (otherInput) { otherInput.style.display = 'block'; otherInput.focus(); }
            if (hiddenClass) hiddenClass.value = '';
        } else {
            if (otherInput) { otherInput.style.display = 'none'; otherInput.value = ''; }
            if (hiddenClass) hiddenClass.value = val;
        }
    }

    // Keep fbClass hidden updated when typing in "Others" box
    document.addEventListener('input', function(e) {
        if (e.target && e.target.id === 'fbClassOther') {
            const hiddenClass = document.getElementById('fbClass');
            if (hiddenClass) hiddenClass.value = e.target.value.trim();
        }
    });

    function fbSetRecommend(val, btn) {
        fbCurrentRecommend = val;
        document.getElementById('fbRecommend').value = val;
        document.querySelectorAll('.fb-recommend-btn').forEach(b => {
            b.style.background = 'white';
            b.style.transform = 'scale(1)';
        });
        const colors = { yes:'#43a047', maybe:'#ff9800', no:'#f44336' };
        btn.style.background = colors[val];
        btn.style.color = 'white';
        btn.style.transform = 'scale(1.05)';
    }

    function fbSetCustomQ(qNum, val, btn) {
        document.getElementById('fbCustomQ' + qNum + 'Val').value = val;
        const colors = { yes:'#43a047', maybe:'#ff9800', no:'#f44336' };
        document.querySelectorAll('.fb-cq' + qNum + '-btn').forEach(b => {
            b.style.background = 'white'; b.style.color = b.style.borderColor || '#333'; b.style.transform = 'scale(1)';
        });
        if (btn) { btn.style.background = colors[val] || '#c44569'; btn.style.color = 'white'; btn.style.transform = 'scale(1.05)'; }
    }

    function fbInitCustomQScore10(qNum) {
        const row = document.getElementById('fbCustomQ' + qNum + 'Score10');
        if (!row || row.dataset.init) return;
        row.dataset.init = '1';
        row.innerHTML = [1,2,3,4,5,6,7,8,9,10].map(n =>
            `<button type="button" onclick="fbSetCustomQScore(${qNum},${n},this)" style="width:36px;height:36px;border-radius:50%;border:2px solid #ccc;background:white;font-size:0.82em;font-weight:700;cursor:pointer;transition:all 0.15s;color:#555">${n}</button>`
        ).join('');
    }

    function fbSetCustomQScore(qNum, val, btn) {
        document.getElementById('fbCustomQ' + qNum + 'Val').value = val;
        const scoreEl = document.getElementById('fbCustomQ' + qNum + 'Score10');
        if (scoreEl) scoreEl.querySelectorAll('button').forEach(b => { b.style.background='white'; b.style.color='#555'; b.style.borderColor='#ccc'; });
        if (btn) { btn.style.background='#c2185b'; btn.style.color='white'; btn.style.borderColor='#c2185b'; }
    }

    function fbApplyCustomQLayout(qNum, type) {
        const r3 = document.getElementById('fbCustomQ' + qNum + 'Rate3');
        const s10 = document.getElementById('fbCustomQ' + qNum + 'Score10');
        const ta = document.getElementById('fbCustomQ' + qNum + 'Textarea');
        if (r3) r3.style.display = type === 'rate3' ? 'flex' : 'none';
        if (s10) { s10.style.display = type === 'score10' ? 'flex' : 'none'; if (type === 'score10') fbInitCustomQScore10(qNum); }
        if (ta) ta.style.display = type === 'textarea' ? 'block' : 'none';
        document.getElementById('fbCustomQ' + qNum + 'Val').value = '';
    }

    function closeFeedbackPopup() {
        if (fbDismissCount >= fbMaxDismiss) return; // Block close once max dismissals reached
        fbDismissCount++;
        localStorage.setItem('spurthi_fb_dismiss', fbDismissCount);
        const overlay = document.getElementById('feedbackPopupOverlay');
        if (overlay) overlay.style.display = 'none';
        document.body.style.overflow = '';
        // Schedule re-show after 5 minutes if still has dismissals remaining OR must force
        if (!fbAlreadySubmitted) {
            setTimeout(() => {
                db.ref('feedbackSettings').once('value').then(snap => {
                    const data = snap.val();
                    if (data && data.active && !fbAlreadySubmitted) showFeedbackPopup(data);
                });
            }, 5 * 60 * 1000);
        }
    }

    async function submitFeedback() {
        const name = (document.getElementById('fbName')?.value || '').trim();
        const cls  = (document.getElementById('fbClass')?.value || '').trim();
        const phone = (document.getElementById('fbPhone')?.value || '').replace(/\D/g,'').trim();
        const overallScore = document.getElementById('fbOverallScore')?.value;
        const recommend    = document.getElementById('fbRecommend')?.value;
        const suggestions  = (document.getElementById('fbSuggestions')?.value || '').trim();
        const msgEl = document.getElementById('fbPopupMsg');
        const isLoggedIn = !!(quizCurrentUser && quizCurrentUser.key);

        // Custom Q7/Q8/Q9 values
        const lbl = window._fbCustomLabels || fbCurrentLabels || FB_DEFAULT_QUESTION_LABELS;
        const customQ7Val = (document.getElementById('fbCustomQ7Val')?.value || (document.getElementById('fbCustomQ7Textarea')?.style.display !== 'none' ? (document.getElementById('fbCustomQ7Textarea')?.value || '').trim() : '')).toString();
        const customQ8Val = (document.getElementById('fbCustomQ8Val')?.value || (document.getElementById('fbCustomQ8Textarea')?.style.display !== 'none' ? (document.getElementById('fbCustomQ8Textarea')?.value || '').trim() : '')).toString();
        const customQ9Val = (document.getElementById('fbCustomQ9Val')?.value || (document.getElementById('fbCustomQ9Textarea')?.style.display !== 'none' ? (document.getElementById('fbCustomQ9Textarea')?.value || '').trim() : '')).toString();

        // -- Validation ----------------------------------------------
        if (!isLoggedIn && !name) { if(msgEl) msgEl.innerHTML = '<p style="color:#c62828;background:#fde8e8;padding:8px 12px;border-radius:8px;font-weight:600">âš ï¸ Please enter your name.</p>'; return; }
        if (!isLoggedIn && !phone) { if(msgEl) msgEl.innerHTML = '<p style="color:#c62828;background:#fde8e8;padding:8px 12px;border-radius:8px;font-weight:600">âš ï¸ Please enter your phone number.</p>'; return; }
        if (!isLoggedIn && phone.length < 10) { if(msgEl) msgEl.innerHTML = '<p style="color:#c62828;background:#fde8e8;padding:8px 12px;border-radius:8px;font-weight:600">âš ï¸ Please enter a valid 10-digit phone number.</p>'; return; }
        if (!isLoggedIn && !cls) { if(msgEl) msgEl.innerHTML = '<p style="color:#c62828;background:#fde8e8;padding:8px 12px;border-radius:8px;font-weight:600">âš ï¸ Please select your class / designation.</p>'; return; }
        if (!overallScore) { if(msgEl) msgEl.innerHTML = '<p style="color:#c62828;background:#fde8e8;padding:8px 12px;border-radius:8px;font-weight:600">âš ï¸ Please rate the overall fest experience (1â€“10).</p>'; return; }
        if (!recommend) { if(msgEl) msgEl.innerHTML = '<p style="color:#c62828;background:#fde8e8;padding:8px 12px;border-radius:8px;font-weight:600">âš ï¸ Please answer the recommendation question.</p>'; return; }

        // Validate required custom questions (only if enabled)
        if (lbl.customQ7Enabled && (lbl.customQ7Req||'optional') === 'required' && !customQ7Val) { if(msgEl) msgEl.innerHTML = `<p style="color:#c62828;background:#fde8e8;padding:8px 12px;border-radius:8px;font-weight:600">âš ï¸ Please answer: ${lbl.customQ7||'Q7'}</p>`; return; }
        if (lbl.customQ8Enabled && (lbl.customQ8Req||'optional') === 'required' && !customQ8Val) { if(msgEl) msgEl.innerHTML = `<p style="color:#c62828;background:#fde8e8;padding:8px 12px;border-radius:8px;font-weight:600">âš ï¸ Please answer: ${lbl.customQ8||'Q8'}</p>`; return; }
        if (lbl.customQ9Enabled && (lbl.customQ9Req||'optional') === 'required' && !customQ9Val) { if(msgEl) msgEl.innerHTML = `<p style="color:#c62828;background:#fde8e8;padding:8px 12px;border-radius:8px;font-weight:600">âš ï¸ Please answer: ${lbl.customQ9||'Q9'}</p>`; return; }

        if(msgEl) msgEl.innerHTML = '<p style="color:#666">â³ Checking for duplicates...</p>';

        // -- Duplicate check before saving ---------------------------
        try {
            if (isLoggedIn) {
                // Check by student key
                const existing = await db.ref('feedbackSubmitted/students/' + quizCurrentUser.key).once('value');
                if (existing.exists()) {
                    fbAlreadySubmitted = true;
                    document.getElementById('feedbackPopupOverlay').style.display = 'none';
                    document.body.style.overflow = '';
                    return; // silently skip
                }
            } else {
                // Check by phone number
                const phoneKey = 'ph_' + phone;
                const existing = await db.ref('feedbackSubmitted/visitors/' + phoneKey).once('value');
                if (existing.exists()) {
                    fbAlreadySubmitted = true;
                    localStorage.setItem('spurthi_fb_submitted', 'yes');
                    document.getElementById('feedbackPopupOverlay').style.display = 'none';
                    document.body.style.overflow = '';
                    return; // silently skip
                }
            }
        } catch(e) { /* proceed even if check fails */ }

        if(msgEl) msgEl.innerHTML = '<p style="color:#666">â³ Submitting...</p>';

        // -- Build submission object ----------------------------------
        const now = new Date();
        const dateStr = now.toLocaleDateString('en-IN', { day:'2-digit', month:'short', year:'numeric' });
        const timeStr = now.toLocaleTimeString('en-IN', { hour:'2-digit', minute:'2-digit', hour12:true });
        const submissionData = {
            name,
            class: cls,
            overallScore: parseInt(overallScore),
            eventRatings: fbEventRatings,
            recommend,
            suggestions,
            customQ7: customQ7Val,
            customQ7Question: lbl.customQ7 || '',
            customQ8: customQ8Val,
            customQ8Question: lbl.customQ8 || '',
            customQ9: customQ9Val,
            customQ9Question: lbl.customQ9 || '',
            submittedAt: now.toISOString(),
            submittedDate: dateStr,
            submittedTime: timeStr,
            submittedDateTime: dateStr + ' at ' + timeStr,
            visitorType: isLoggedIn ? 'quiz_student' : 'visitor',
            ...(isLoggedIn ? {
                studentKey: quizCurrentUser.key,
                studentName: quizCurrentUser.name,
                studentClass: quizCurrentUser.class
            } : {
                phone: phone.replace(/(\d{2})(\d{4})(\d{4})/, '$1****$3') // mask middle digits in stored copy
            })
        };

        try {
            // Save response
            await db.ref('feedbackResponses').push(submissionData);
            // Mark as submitted to prevent future duplicates
            if (isLoggedIn) {
                await db.ref('feedbackSubmitted/students/' + quizCurrentUser.key).set({
                    submittedAt: now.toISOString(), name, class: cls
                });
            } else {
                const phoneKey = 'ph_' + phone;
                await db.ref('feedbackSubmitted/visitors/' + phoneKey).set({
                    submittedAt: now.toISOString(), name, class: cls
                });
                localStorage.setItem('spurthi_fb_submitted', 'yes');
            }
            fbAlreadySubmitted = true;

            // Show thank you screen
            const body = document.getElementById('feedbackFormBody');
            if (body) body.innerHTML = `<div style="text-align:center;padding:30px 20px">
                <div style="font-size:4em;margin-bottom:16px">ðŸŽ‰</div>
                <h3 style="color:#2e7d32;font-size:1.4em;margin-bottom:8px">Thank You, ${name}!</h3>
                <p style="color:#555;font-size:1em;margin-bottom:6px">Your feedback has been recorded.</p>
                <p style="color:#aaa;font-size:0.82em;margin-bottom:20px">ðŸ“… ${dateStr} &nbsp;ðŸ• ${timeStr}</p>

                <!-- Responsibilities Section -->
                <div style="text-align:left;background:#f9f0ff;border:2px solid #ce93d8;border-radius:14px;padding:18px;margin-bottom:20px">
                    <h4 style="text-align:center;color:#6a1b9a;font-size:1em;margin-bottom:14px;letter-spacing:0.3px">ðŸ“‹ Coordinator Responsibilities</h4>

                    <!-- Chandan G B -->
                    <div style="background:#c8e6c9;border-radius:10px;padding:13px 14px;margin-bottom:12px;border-left:4px solid #1b5e20">
                        <p style="font-weight:700;color:#1b5e20;font-size:0.95em;margin-bottom:4px">ðŸ‘¨â€ðŸ’¼ Chandan G B</p>
                        <p style="color:#2e7d32;font-size:0.82em;margin-bottom:6px;font-style:italic">ðŸ“Š Vlog Monitor + ðŸŽ™ï¸ Podcast Approval</p>
                        <ul style="list-style:none;padding:0;margin:0">
                            <li style="font-size:0.83em;color:#1b5e20;margin-bottom:3px">ðŸŽ­ <strong>Ramp Walk</strong> â€” On stage &nbsp;|&nbsp; II BBA / III B.Com</li>
                            <li style="font-size:0.83em;color:#1b5e20;margin-bottom:3px">ðŸŽ™ï¸ <strong>Pod Casting</strong> â€” Off stage &nbsp;|&nbsp; III BCOM / II BBA</li>
                            <li style="font-size:0.83em;color:#1b5e20">ðŸ“‹ <strong>Vlog</strong> â€” Off stage &nbsp;|&nbsp; III BCOM</li>
                        </ul>
                    </div>

                    <!-- Priyanka V -->
                    <div style="background:#e1bee7;border-radius:10px;padding:13px 14px;border-left:4px solid #7b1fa2">
                        <p style="font-weight:700;color:#4a148c;font-size:0.95em;margin-bottom:4px">ðŸ‘©â€ðŸ’¼ Priyanka V</p>
                        <p style="color:#6a1b9a;font-size:0.82em;margin-bottom:6px;font-style:italic">ðŸ“Š Vlog Monitor + ðŸ“‹ Event Incharge</p>
                        <ul style="list-style:none;padding:0;margin:0">
                            <li style="font-size:0.83em;color:#4a148c;margin-bottom:3px">ðŸŽ­ <strong>Mime</strong> â€” On stage &nbsp;|&nbsp; I BCA / II BCA 'B'</li>
                            <li style="font-size:0.83em;color:#4a148c;margin-bottom:3px">ðŸŽ­ <strong>Mad Ads</strong> â€” On stage &nbsp;|&nbsp; I BCOM / I BCA</li>
                            <li style="font-size:0.83em;color:#4a148c;margin-bottom:3px">ðŸ“‹ <strong>YouTube Advertisement</strong> â€” Off stage &nbsp;|&nbsp; I BCA 'A' / II BCA 'A'</li>
                            <li style="font-size:0.83em;color:#4a148c;margin-bottom:3px">ðŸ“‹ <strong>Case Analysis</strong> â€” Off stage &nbsp;|&nbsp; I BCOM / I BCA 'A'</li>
                            <li style="font-size:0.83em;color:#4a148c">ðŸ“‹ <strong>Vlog</strong> â€” Off stage &nbsp;|&nbsp; III BCOM</li>
                        </ul>
                    </div>
                </div>

                <button onclick="document.getElementById('feedbackPopupOverlay').style.display='none';document.body.style.overflow=''" style="background:linear-gradient(135deg,#880e4f,#c2185b);color:white;border:none;border-radius:10px;padding:12px 28px;font-size:1em;font-weight:700;cursor:pointer">âœ… Close</button>
            </div>`;
            setTimeout(() => {
                const overlay = document.getElementById('feedbackPopupOverlay');
                if (overlay) overlay.style.display = 'none';
                document.body.style.overflow = '';
            }, 5000);
        } catch(e) {
            if(msgEl) msgEl.innerHTML = '<p style="color:#c62828;background:#fde8e8;padding:8px 12px;border-radius:8px">âŒ Error submitting: ' + e.message + '</p>';
        }
    }

    // -- Dismiss Behavior Controls ----------------------------------
    let fbAdminMaxDismiss = 1; // local copy for admin UI

    const FB_DISMISS_LABELS = {
        0: 'ðŸ”´ No dismissals â€” must fill immediately on 1st show',
        1: 'ðŸŸ¡ 1 dismissal â€” can close once, forced on 2nd show',
        2: 'ðŸŸ  2 dismissals â€” can close twice, forced on 3rd show',
        3: 'ðŸŸ¢ 3 dismissals â€” very soft, forced on 4th show',
    };

    function fbChangeDismiss(delta) {
        fbAdminMaxDismiss = Math.max(0, Math.min(5, fbAdminMaxDismiss + delta));
        document.getElementById('fbMaxDismissVal').value = fbAdminMaxDismiss;
        document.getElementById('fbMaxDismissDisplay').textContent = fbAdminMaxDismiss;
        const explain = document.getElementById('fbDismissExplain');
        if (explain) explain.textContent = FB_DISMISS_LABELS[fbAdminMaxDismiss] || `ðŸŸ¢ ${fbAdminMaxDismiss} dismissals allowed before forcing`;
    }

    async function saveDismissSetting() {
        const val = parseInt(document.getElementById('fbMaxDismissVal')?.value || '1');
        try {
            await db.ref('feedbackSettings/maxDismiss').set(val);
            fbMaxDismiss = val; // update live variable too
            const toast = document.getElementById('fbDismissSaveToast');
            if (toast) { toast.style.display = 'inline-block'; setTimeout(() => { toast.style.display = 'none'; }, 3000); }
        } catch(e) { alert('âŒ Error saving: ' + e.message); }
    }

    async function resetAllDismissCounts() {
        if (!confirm('ðŸ”„ Reset dismiss counts for ALL visitors?\n\nEveryone will see the feedback popup fresh again â€” as if it\'s their first time.')) return;
        try {
            const resetToken = Date.now().toString();
            await db.ref('feedbackSettings/resetToken').set(resetToken);
            const toast = document.getElementById('fbResetToast');
            if (toast) { toast.style.display = 'inline-block'; setTimeout(() => { toast.style.display = 'none'; }, 4000); }
        } catch(e) { alert('âŒ Error: ' + e.message); }
    }

    // -- Feedback Questions Preview + Edit --------------------------
    const FB_DEFAULT_QUESTION_LABELS = {
        name:         'Your Name',
        classField:   'Class / Designation',
        overallScore: 'Overall Fest Experience (1 = Poor, 10 = Excellent)',
        eventRating:  'Rate Each Event (1â€“5 Stars)',
        recommend:    'Would you recommend Spurthi Youth Fest to others?',
        suggestions:  'Suggestions / Comments (Optional)',
        customQ7:     'How was the organisation and coordination of the events?',
        customQ7Type: 'rate3',
        customQ7Req:  'optional',
        customQ7Enabled: false,
        customQ8:     'How would you rate the overall ambience and decoration?',
        customQ8Type: 'score10',
        customQ8Req:  'required',
        customQ8Enabled: false,
        customQ9:     'Any specific event or moment that stood out for you?',
        customQ9Type: 'textarea',
        customQ9Req:  'optional',
        customQ9Enabled: false
    };

    let fbCurrentLabels = { ...FB_DEFAULT_QUESTION_LABELS };

    async function loadFeedbackQuestionLabels() {
        try {
            const snap = await db.ref('feedbackSettings/questionLabels').once('value');
            if (snap.exists()) fbCurrentLabels = { ...FB_DEFAULT_QUESTION_LABELS, ...snap.val() };
            else fbCurrentLabels = { ...FB_DEFAULT_QUESTION_LABELS };
        } catch(e) { fbCurrentLabels = { ...FB_DEFAULT_QUESTION_LABELS }; }
        renderFeedbackQuestionsPreview();
    }

    function renderFeedbackQuestionsPreview() {
        const container = document.getElementById('fbQuestionsPreview');
        if (!container) return;
        const lbl = fbCurrentLabels;
        container.innerHTML = `
        <p style="color:#e65100;font-weight:700;font-size:0.88em;margin:0 0 14px">ðŸ“ Edit the question label text below. What visitors see in the popup is shown here.</p>
        <div style="display:grid;gap:14px">

            <!-- Q1: Name -->
            <div style="background:white;border-radius:10px;padding:14px 16px;border:2px solid #ffe082">
                <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px">
                    <span style="background:#ff6f00;color:white;padding:2px 10px;border-radius:20px;font-size:0.75em;font-weight:700">Q1</span>
                    <span style="color:#888;font-size:0.82em">Text input â€” always shown</span>
                </div>
                <label style="font-weight:700;color:#555;font-size:0.85em;display:block;margin-bottom:5px">Question Label:</label>
                <input type="text" id="fbLblName" value="${lbl.name}" style="width:100%;padding:8px 12px;border:1.5px solid #ffcc02;border-radius:8px;font-size:0.92em;box-sizing:border-box;outline:none">
                <div style="margin-top:8px;background:#f9f9f9;border-radius:6px;padding:8px 12px;border-left:3px solid #ff6f00">
                    <span style="color:#555;font-size:0.82em">ðŸ‘¤ <strong id="fbPreviewName">${lbl.name}</strong> <span style="color:#c2185b">*</span></span>
                    <div style="margin-top:5px;background:#f0f0f0;border-radius:5px;height:22px;width:100%"></div>
                </div>
            </div>

            <!-- Q2: Class -->
            <div style="background:white;border-radius:10px;padding:14px 16px;border:2px solid #ffe082">
                <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px">
                    <span style="background:#ff6f00;color:white;padding:2px 10px;border-radius:20px;font-size:0.75em;font-weight:700">Q2</span>
                    <span style="color:#888;font-size:0.82em">Text input â€” always shown</span>
                </div>
                <label style="font-weight:700;color:#555;font-size:0.85em;display:block;margin-bottom:5px">Question Label:</label>
                <input type="text" id="fbLblClass" value="${lbl.classField}" style="width:100%;padding:8px 12px;border:1.5px solid #ffcc02;border-radius:8px;font-size:0.92em;box-sizing:border-box;outline:none">
                <div style="margin-top:8px;background:#f9f9f9;border-radius:6px;padding:8px 12px;border-left:3px solid #ff6f00">
                    <span style="color:#555;font-size:0.82em">ðŸ« <strong id="fbPreviewClass">${lbl.classField}</strong></span>
                    <div style="margin-top:5px;background:#f0f0f0;border-radius:5px;height:22px;width:100%"></div>
                </div>
            </div>

            <!-- Q3: Overall Score -->
            <div style="background:white;border-radius:10px;padding:14px 16px;border:2px solid #ffe082">
                <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px">
                    <span style="background:#c2185b;color:white;padding:2px 10px;border-radius:20px;font-size:0.75em;font-weight:700">Q3</span>
                    <span style="color:#888;font-size:0.82em">1â€“10 score buttons â€” always shown â€” required</span>
                </div>
                <label style="font-weight:700;color:#555;font-size:0.85em;display:block;margin-bottom:5px">Question Label:</label>
                <input type="text" id="fbLblOverall" value="${lbl.overallScore}" style="width:100%;padding:8px 12px;border:1.5px solid #ffcc02;border-radius:8px;font-size:0.92em;box-sizing:border-box;outline:none">
                <div style="margin-top:8px;background:#fce4ec;border-radius:6px;padding:8px 12px;border-left:3px solid #c2185b">
                    <span style="color:#880e4f;font-size:0.82em;font-weight:600">ðŸ“ <strong id="fbPreviewOverall">${lbl.overallScore}</strong> <span style="color:#c2185b">*</span></span>
                    <div style="margin-top:6px;display:flex;gap:4px">${[1,2,3,4,5,6,7,8,9,10].map(n=>`<div style="width:24px;height:24px;border-radius:50%;border:2px solid #ccc;background:white;font-size:0.7em;font-weight:700;display:flex;align-items:center;justify-content:center;color:#888">${n}</div>`).join('')}</div>
                </div>
            </div>

            <!-- Q4: Event Ratings -->
            <div style="background:white;border-radius:10px;padding:14px 16px;border:2px solid #ffe082">
                <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px">
                    <span style="background:#6a1b9a;color:white;padding:2px 10px;border-radius:20px;font-size:0.75em;font-weight:700">Q4</span>
                    <span style="color:#888;font-size:0.82em">â­ Star ratings â€” shown for each selected event</span>
                </div>
                <label style="font-weight:700;color:#555;font-size:0.85em;display:block;margin-bottom:5px">Section Heading:</label>
                <input type="text" id="fbLblEvents" value="${lbl.eventRating}" style="width:100%;padding:8px 12px;border:1.5px solid #ffcc02;border-radius:8px;font-size:0.92em;box-sizing:border-box;outline:none">
                <div style="margin-top:8px;background:#f3e5f5;border-radius:6px;padding:8px 12px;border-left:3px solid #6a1b9a">
                    <span style="color:#4a148c;font-size:0.82em;font-weight:600">â­ <strong id="fbPreviewEvents">${lbl.eventRating}</strong></span>
                    <div style="margin-top:5px;font-size:0.75em;color:#888;font-style:italic">[ Event 1: â˜†â˜†â˜†â˜†â˜† ] [ Event 2: â˜†â˜†â˜†â˜†â˜† ] ...</div>
                </div>
            </div>

            <!-- Q5: Recommend -->
            <div style="background:white;border-radius:10px;padding:14px 16px;border:2px solid #ffe082">
                <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px">
                    <span style="background:#2e7d32;color:white;padding:2px 10px;border-radius:20px;font-size:0.75em;font-weight:700">Q5</span>
                    <span style="color:#888;font-size:0.82em">Yes / Maybe / No buttons â€” required</span>
                </div>
                <label style="font-weight:700;color:#555;font-size:0.85em;display:block;margin-bottom:5px">Question Label:</label>
                <input type="text" id="fbLblRecommend" value="${lbl.recommend}" style="width:100%;padding:8px 12px;border:1.5px solid #ffcc02;border-radius:8px;font-size:0.92em;box-sizing:border-box;outline:none">
                <div style="margin-top:8px;background:#e8f5e9;border-radius:6px;padding:8px 12px;border-left:3px solid #2e7d32">
                    <span style="color:#2e7d32;font-size:0.82em;font-weight:600">ðŸŽ¯ <strong id="fbPreviewRecommend">${lbl.recommend}</strong> <span style="color:#c2185b">*</span></span>
                    <div style="margin-top:6px;display:flex;gap:6px"><span style="border:1.5px solid #43a047;padding:3px 10px;border-radius:12px;font-size:0.75em;font-weight:700;color:#2e7d32">ðŸ‘ Yes!</span><span style="border:1.5px solid #ff9800;padding:3px 10px;border-radius:12px;font-size:0.75em;font-weight:700;color:#e65100">ðŸ¤” Maybe</span><span style="border:1.5px solid #f44336;padding:3px 10px;border-radius:12px;font-size:0.75em;font-weight:700;color:#c62828">ðŸ‘Ž No</span></div>
                </div>
            </div>

            <!-- Q6: Suggestions -->
            <div style="background:white;border-radius:10px;padding:14px 16px;border:2px solid #ffe082">
                <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px">
                    <span style="background:#1565c0;color:white;padding:2px 10px;border-radius:20px;font-size:0.75em;font-weight:700">Q6</span>
                    <span style="color:#888;font-size:0.82em">Text area â€” optional</span>
                </div>
                <label style="font-weight:700;color:#555;font-size:0.85em;display:block;margin-bottom:5px">Question Label:</label>
                <input type="text" id="fbLblSuggestions" value="${lbl.suggestions}" style="width:100%;padding:8px 12px;border:1.5px solid #ffcc02;border-radius:8px;font-size:0.92em;box-sizing:border-box;outline:none">
                <div style="margin-top:8px;background:#e3f2fd;border-radius:6px;padding:8px 12px;border-left:3px solid #1565c0">
                    <span style="color:#0d47a1;font-size:0.82em;font-weight:600">ðŸ’¬ <strong id="fbPreviewSuggestions">${lbl.suggestions}</strong></span>
                    <div style="margin-top:5px;background:#f0f0f0;border-radius:5px;height:40px;width:100%"></div>
                </div>
            </div>

            <!-- Q7: Custom â€” Rate Each (Yes/Maybe/No or similar) -->
            <div style="background:white;border-radius:10px;padding:14px 16px;border:2px solid #f3e5f5">
                <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px;flex-wrap:wrap;justify-content:space-between">
                    <div style="display:flex;align-items:center;gap:8px">
                        <span style="background:#7b1fa2;color:white;padding:2px 10px;border-radius:20px;font-size:0.75em;font-weight:700">Q7</span>
                        <span style="color:#888;font-size:0.82em">Custom question</span>
                    </div>
                    <label id="fbQ7EnabledLabel" style="display:flex;align-items:center;gap:6px;cursor:pointer;padding:4px 12px;border-radius:20px;border:2px solid ${lbl.customQ7Enabled?'#43a047':'#ef9a9a'};background:${lbl.customQ7Enabled?'#e8f5e9':'#fce4ec'};font-size:0.8em;font-weight:700;color:${lbl.customQ7Enabled?'#2e7d32':'#c62828'}">
                        <input type="checkbox" id="fbQ7Enabled" ${lbl.customQ7Enabled?'checked':''} style="accent-color:#7b1fa2;width:14px;height:14px"> <span id="fbQ7EnabledTxt">${lbl.customQ7Enabled?'Enabled':'Disabled'}</span>
                    </label>
                </div>
                <label style="font-weight:700;color:#555;font-size:0.85em;display:block;margin-bottom:5px">Question Label:</label>
                <input type="text" id="fbLblQ7" value="${lbl.customQ7||''}" style="width:100%;padding:8px 12px;border:1.5px solid #ce93d8;border-radius:8px;font-size:0.92em;box-sizing:border-box;outline:none;margin-bottom:8px">
                <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-bottom:8px">
                    <div>
                        <label style="font-weight:700;color:#555;font-size:0.82em;display:block;margin-bottom:4px">Answer Type:</label>
                        <select id="fbQ7Type" style="padding:7px 10px;border:1.5px solid #ce93d8;border-radius:8px;font-size:0.88em;outline:none;background:white">
                            <option value="rate3" ${(lbl.customQ7Type||'rate3')==='rate3'?'selected':''}>ðŸ‘ Rate Each â€” Yes / Maybe / No</option>
                            <option value="score10" ${(lbl.customQ7Type||'')==='score10'?'selected':''}>ðŸ”¢ 1â€“10 Score Buttons</option>
                            <option value="textarea" ${(lbl.customQ7Type||'')==='textarea'?'selected':''}>ðŸ“ Text Area</option>
                        </select>
                    </div>
                    <div>
                        <label style="font-weight:700;color:#555;font-size:0.82em;display:block;margin-bottom:4px">Required:</label>
                        <select id="fbQ7Req" style="padding:7px 10px;border:1.5px solid #ce93d8;border-radius:8px;font-size:0.88em;outline:none;background:white">
                            <option value="optional" ${(lbl.customQ7Req||'optional')==='optional'?'selected':''}>Optional</option>
                            <option value="required" ${(lbl.customQ7Req||'')==='required'?'selected':''}>Required â˜…</option>
                        </select>
                    </div>
                </div>
                <div style="background:#f3e5f5;border-radius:6px;padding:8px 12px;border-left:3px solid #7b1fa2;font-size:0.82em;color:#4a148c;font-weight:600">
                    ðŸŽ¨ <strong id="fbPreviewQ7">${lbl.customQ7||'(no label set)'}</strong>
                    <div style="margin-top:5px;display:flex;gap:6px"><span style="border:1.5px solid #43a047;padding:3px 10px;border-radius:12px;font-size:0.75em;font-weight:700;color:#2e7d32">ðŸ‘ Yes</span><span style="border:1.5px solid #ff9800;padding:3px 10px;border-radius:12px;font-size:0.75em;font-weight:700;color:#e65100">ðŸ¤” Maybe</span><span style="border:1.5px solid #f44336;padding:3px 10px;border-radius:12px;font-size:0.75em;font-weight:700;color:#c62828">ðŸ‘Ž No</span></div>
                </div>
            </div>

            <!-- Q8: Custom â€” 1â€“10 Score -->
            <div style="background:white;border-radius:10px;padding:14px 16px;border:2px solid #e8f5e9">
                <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px;flex-wrap:wrap;justify-content:space-between">
                    <div style="display:flex;align-items:center;gap:8px">
                        <span style="background:#2e7d32;color:white;padding:2px 10px;border-radius:20px;font-size:0.75em;font-weight:700">Q8</span>
                        <span style="color:#888;font-size:0.82em">Custom question</span>
                    </div>
                    <label id="fbQ8EnabledLabel" style="display:flex;align-items:center;gap:6px;cursor:pointer;padding:4px 12px;border-radius:20px;border:2px solid ${lbl.customQ8Enabled?'#43a047':'#ef9a9a'};background:${lbl.customQ8Enabled?'#e8f5e9':'#fce4ec'};font-size:0.8em;font-weight:700;color:${lbl.customQ8Enabled?'#2e7d32':'#c62828'}">
                        <input type="checkbox" id="fbQ8Enabled" ${lbl.customQ8Enabled?'checked':''} style="accent-color:#2e7d32;width:14px;height:14px"> <span id="fbQ8EnabledTxt">${lbl.customQ8Enabled?'Enabled':'Disabled'}</span>
                    </label>
                </div>
                <label style="font-weight:700;color:#555;font-size:0.85em;display:block;margin-bottom:5px">Question Label:</label>
                <input type="text" id="fbLblQ8" value="${lbl.customQ8||''}" style="width:100%;padding:8px 12px;border:1.5px solid #a5d6a7;border-radius:8px;font-size:0.92em;box-sizing:border-box;outline:none;margin-bottom:8px">
                <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-bottom:8px">
                    <div>
                        <label style="font-weight:700;color:#555;font-size:0.82em;display:block;margin-bottom:4px">Answer Type:</label>
                        <select id="fbQ8Type" style="padding:7px 10px;border:1.5px solid #a5d6a7;border-radius:8px;font-size:0.88em;outline:none;background:white">
                            <option value="rate3" ${(lbl.customQ8Type||'')==='rate3'?'selected':''}>ðŸ‘ Rate Each â€” Yes / Maybe / No</option>
                            <option value="score10" ${(lbl.customQ8Type||'score10')==='score10'?'selected':''}>ðŸ”¢ 1â€“10 Score Buttons</option>
                            <option value="textarea" ${(lbl.customQ8Type||'')==='textarea'?'selected':''}>ðŸ“ Text Area</option>
                        </select>
                    </div>
                    <div>
                        <label style="font-weight:700;color:#555;font-size:0.82em;display:block;margin-bottom:4px">Required:</label>
                        <select id="fbQ8Req" style="padding:7px 10px;border:1.5px solid #a5d6a7;border-radius:8px;font-size:0.88em;outline:none;background:white">
                            <option value="optional" ${(lbl.customQ8Req||'')==='optional'?'selected':''}>Optional</option>
                            <option value="required" ${(lbl.customQ8Req||'required')==='required'?'selected':''}>Required â˜…</option>
                        </select>
                    </div>
                </div>
                <div style="background:#e8f5e9;border-radius:6px;padding:8px 12px;border-left:3px solid #2e7d32;font-size:0.82em;color:#1b5e20;font-weight:600">
                    ðŸ”¢ <strong id="fbPreviewQ8">${lbl.customQ8||'(no label set)'}</strong>
                    <div style="margin-top:6px;display:flex;gap:4px">${[1,2,3,4,5,6,7,8,9,10].map(n=>`<div style="width:24px;height:24px;border-radius:50%;border:2px solid #ccc;background:white;font-size:0.7em;font-weight:700;display:flex;align-items:center;justify-content:center;color:#888">${n}</div>`).join('')}</div>
                </div>
            </div>

            <!-- Q9: Custom â€” Text Area -->
            <div style="background:white;border-radius:10px;padding:14px 16px;border:2px solid #e3f2fd">
                <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px;flex-wrap:wrap;justify-content:space-between">
                    <div style="display:flex;align-items:center;gap:8px">
                        <span style="background:#0d47a1;color:white;padding:2px 10px;border-radius:20px;font-size:0.75em;font-weight:700">Q9</span>
                        <span style="color:#888;font-size:0.82em">Custom question</span>
                    </div>
                    <label id="fbQ9EnabledLabel" style="display:flex;align-items:center;gap:6px;cursor:pointer;padding:4px 12px;border-radius:20px;border:2px solid ${lbl.customQ9Enabled?'#43a047':'#ef9a9a'};background:${lbl.customQ9Enabled?'#e8f5e9':'#fce4ec'};font-size:0.8em;font-weight:700;color:${lbl.customQ9Enabled?'#2e7d32':'#c62828'}">
                        <input type="checkbox" id="fbQ9Enabled" ${lbl.customQ9Enabled?'checked':''} style="accent-color:#0d47a1;width:14px;height:14px"> <span id="fbQ9EnabledTxt">${lbl.customQ9Enabled?'Enabled':'Disabled'}</span>
                    </label>
                </div>
                <label style="font-weight:700;color:#555;font-size:0.85em;display:block;margin-bottom:5px">Question Label:</label>
                <input type="text" id="fbLblQ9" value="${lbl.customQ9||''}" style="width:100%;padding:8px 12px;border:1.5px solid #90caf9;border-radius:8px;font-size:0.92em;box-sizing:border-box;outline:none;margin-bottom:8px">
                <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-bottom:8px">
                    <div>
                        <label style="font-weight:700;color:#555;font-size:0.82em;display:block;margin-bottom:4px">Answer Type:</label>
                        <select id="fbQ9Type" style="padding:7px 10px;border:1.5px solid #90caf9;border-radius:8px;font-size:0.88em;outline:none;background:white">
                            <option value="rate3" ${(lbl.customQ9Type||'')==='rate3'?'selected':''}>ðŸ‘ Rate Each â€” Yes / Maybe / No</option>
                            <option value="score10" ${(lbl.customQ9Type||'')==='score10'?'selected':''}>ðŸ”¢ 1â€“10 Score Buttons</option>
                            <option value="textarea" ${(lbl.customQ9Type||'textarea')==='textarea'?'selected':''}>ðŸ“ Text Area</option>
                        </select>
                    </div>
                    <div>
                        <label style="font-weight:700;color:#555;font-size:0.82em;display:block;margin-bottom:4px">Required:</label>
                        <select id="fbQ9Req" style="padding:7px 10px;border:1.5px solid #90caf9;border-radius:8px;font-size:0.88em;outline:none;background:white">
                            <option value="optional" ${(lbl.customQ9Req||'optional')==='optional'?'selected':''}>Optional</option>
                            <option value="required" ${(lbl.customQ9Req||'')==='required'?'selected':''}>Required â˜…</option>
                        </select>
                    </div>
                </div>
                <div style="background:#e3f2fd;border-radius:6px;padding:8px 12px;border-left:3px solid #0d47a1;font-size:0.82em;color:#0d47a1;font-weight:600">
                    ðŸ“ <strong id="fbPreviewQ9">${lbl.customQ9||'(no label set)'}</strong>
                    <div style="margin-top:5px;background:#f0f0f0;border-radius:5px;height:40px;width:100%"></div>
                </div>
            </div>

        </div>`;
        // Live update preview text as user types
        ['Name','Class','Overall','Events','Recommend','Suggestions','Q7','Q8','Q9'].forEach(key => {
            const input = document.getElementById('fbLbl' + key);
            const preview = document.getElementById('fbPreview' + key);
            if (input && preview) {
                input.oninput = () => { preview.textContent = input.value || '(empty)'; };
            }
        });
    }

    async function saveFeedbackQuestions() {
        const labels = {
            name:         document.getElementById('fbLblName')?.value.trim() || FB_DEFAULT_QUESTION_LABELS.name,
            classField:   document.getElementById('fbLblClass')?.value.trim() || FB_DEFAULT_QUESTION_LABELS.classField,
            overallScore: document.getElementById('fbLblOverall')?.value.trim() || FB_DEFAULT_QUESTION_LABELS.overallScore,
            eventRating:  document.getElementById('fbLblEvents')?.value.trim() || FB_DEFAULT_QUESTION_LABELS.eventRating,
            recommend:    document.getElementById('fbLblRecommend')?.value.trim() || FB_DEFAULT_QUESTION_LABELS.recommend,
            suggestions:  document.getElementById('fbLblSuggestions')?.value.trim() || FB_DEFAULT_QUESTION_LABELS.suggestions,
            customQ7:     document.getElementById('fbLblQ7')?.value.trim() || FB_DEFAULT_QUESTION_LABELS.customQ7,
            customQ7Type: document.getElementById('fbQ7Type')?.value || FB_DEFAULT_QUESTION_LABELS.customQ7Type,
            customQ7Req:  document.getElementById('fbQ7Req')?.value || FB_DEFAULT_QUESTION_LABELS.customQ7Req,
            customQ7Enabled: !!(document.getElementById('fbQ7Enabled')?.checked),
            customQ8:     document.getElementById('fbLblQ8')?.value.trim() || FB_DEFAULT_QUESTION_LABELS.customQ8,
            customQ8Type: document.getElementById('fbQ8Type')?.value || FB_DEFAULT_QUESTION_LABELS.customQ8Type,
            customQ8Req:  document.getElementById('fbQ8Req')?.value || FB_DEFAULT_QUESTION_LABELS.customQ8Req,
            customQ8Enabled: !!(document.getElementById('fbQ8Enabled')?.checked),
            customQ9:     document.getElementById('fbLblQ9')?.value.trim() || FB_DEFAULT_QUESTION_LABELS.customQ9,
            customQ9Type: document.getElementById('fbQ9Type')?.value || FB_DEFAULT_QUESTION_LABELS.customQ9Type,
            customQ9Req:  document.getElementById('fbQ9Req')?.value || FB_DEFAULT_QUESTION_LABELS.customQ9Req,
            customQ9Enabled: !!(document.getElementById('fbQ9Enabled')?.checked)
        };
        try {
            await db.ref('feedbackSettings/questionLabels').set(labels);
            fbCurrentLabels = labels;
            // Update popup labels live
            applyFeedbackLabelsToPopup(labels);
            const toast = document.getElementById('fbQSaveToast');
            if (toast) { toast.style.display = 'inline-block'; setTimeout(() => { toast.style.display = 'none'; }, 3500); }
        } catch(e) { alert('âŒ Error saving question labels: ' + e.message); }
    }

    function applyFeedbackLabelsToPopup(lbl) {
        // Update the live popup labels if it's visible
        const map = {
            'fbName': lbl.name,
            'fbClass': lbl.classField,
            'fbOverallScoreRow': lbl.overallScore,
            'fbEventRatingsSection': lbl.eventRating,
            'fbRecommend': lbl.recommend,
            'fbSuggestions': lbl.suggestions
        };
        // Update label elements in the popup
        const nameLabel = document.querySelector('label[for="fbName"], #feedbackFormBody label');
        // Simpler: just store labels for next popup open
        window._fbCustomLabels = lbl;
    }

    async function resetFeedbackQuestions() {
        if (!confirm('Reset all question labels back to defaults?')) return;
        try {
            await db.ref('feedbackSettings/questionLabels').remove();
            fbCurrentLabels = { ...FB_DEFAULT_QUESTION_LABELS };
            renderFeedbackQuestionsPreview();
            const toast = document.getElementById('fbQSaveToast');
            if (toast) { toast.textContent = 'âœ… Reset to defaults!'; toast.style.display = 'inline-block'; setTimeout(() => { toast.style.display = 'none'; toast.textContent = 'âœ… Question labels saved!'; }, 3000); }
        } catch(e) { alert('âŒ Error: ' + e.message); }
    }

    // -- Feedback Admin Functions ------------------------------------
    async function loadFeedbackAdmin() {
        const msg = document.getElementById('feedbackAdminMsg');
        if (msg) msg.innerHTML = '<p style="color:#666;text-align:center">â³ Loading...</p>';
        try {
            const [settingsSnap, responsesSnap] = await Promise.all([
                db.ref('feedbackSettings').once('value'),
                db.ref('feedbackResponses').once('value')
            ]);
            const settings = settingsSnap.val() || {};
            const responses = responsesSnap.val() || {};
            // Stats
            const total = Object.keys(responses).length;
            document.getElementById('fbStatTotal').textContent = total;
            document.getElementById('fbStatActive').textContent = settings.active ? 'âœ… ON' : 'âŒ OFF';
            if (total > 0) {
                const vals = Object.values(responses);
                const avgScore = (vals.reduce((s,r) => s + (r.overallScore||0), 0) / total).toFixed(1);
                document.getElementById('fbStatAvgScore').textContent = avgScore + '/10';
                const yesCount = vals.filter(r => r.recommend === 'yes').length;
                document.getElementById('fbStatRecommend').textContent = yesCount + '/' + total;
            } else {
                document.getElementById('fbStatAvgScore').textContent = 'â€”';
                document.getElementById('fbStatRecommend').textContent = 'â€”';
            }
            // Trigger status
            const statusEl = document.getElementById('fbTriggerStatus');
            if (statusEl) {
                if (settings.active) {
                    statusEl.innerHTML = 'ðŸŸ¢ <strong>ACTIVE</strong> â€” Feedback popup is live for all visitors';
                    statusEl.style.cssText = 'padding:10px 20px;border-radius:20px;font-weight:700;font-size:0.95em;background:#d4edda;color:#155724';
                } else {
                    statusEl.innerHTML = 'ðŸ”´ <strong>INACTIVE</strong> â€” Feedback popup is off';
                    statusEl.style.cssText = 'padding:10px 20px;border-radius:20px;font-weight:700;font-size:0.95em;background:#f8d7da;color:#721c24';
                }
            }
            // -- Activation history bar with live ticking counter --------------
            const histEl = document.getElementById('fbActivationHistory');
            if (histEl) {
                // Clear any previous ticker
                if (window._fbActiveTicker) { clearInterval(window._fbActiveTicker); window._fbActiveTicker = null; }

                const fmtDT = iso => {
                    if (!iso) return 'â€”';
                    const d = new Date(iso);
                    return d.toLocaleDateString('en-IN', {day:'2-digit',month:'short',year:'numeric'})
                        + ' &nbsp;Â·&nbsp; '
                        + d.toLocaleTimeString('en-IN', {hour:'2-digit',minute:'2-digit',second:'2-digit',hour12:true});
                };
                const durLabel = fromIso => {
                    if (!fromIso) return 'â€”';
                    const diffMs = Date.now() - new Date(fromIso).getTime();
                    if (diffMs < 0) return '0s';
                    const totalSec = Math.floor(diffMs / 1000);
                    const h = Math.floor(totalSec / 3600);
                    const m = Math.floor((totalSec % 3600) / 60);
                    const s = totalSec % 60;
                    return (h > 0 ? h + 'h ' : '') + (m > 0 ? m + 'm ' : '') + s + 's';
                };
                const durFixed = (fromIso, toIso) => {
                    if (!fromIso || !toIso) return 'â€”';
                    const diffMs = new Date(toIso) - new Date(fromIso);
                    if (diffMs < 0) return 'â€”';
                    const totalSec = Math.floor(diffMs / 1000);
                    const h = Math.floor(totalSec / 3600);
                    const m = Math.floor((totalSec % 3600) / 60);
                    const s = totalSec % 60;
                    return (h > 0 ? h + 'h ' : '') + (m > 0 ? m + 'm ' : '') + s + 's';
                };

                const activatedAt   = settings.activatedAt   || null;
                const deactivatedAt = settings.deactivatedAt || null;
                const isActive      = !!settings.active;

                // Build static parts
                let rows = '';
                rows += '<span style="color:#555;font-weight:700">ðŸ“… Last Activated:</span> '
                    + (activatedAt
                        ? '<span style="color:#2e7d32;font-weight:600">' + fmtDT(activatedAt) + '</span>'
                        : '<span style="color:#aaa">Never activated</span>')
                    + '<br>';

                if (isActive) {
                    rows += '<span style="color:#555;font-weight:700">ðŸŸ¢ Currently Active for:</span> '
                        + '<span id="fbLiveTicker" style="color:#c2185b;font-weight:800;font-size:1.05em;font-variant-numeric:tabular-nums">'
                        + (activatedAt ? durLabel(activatedAt) : 'â€”')
                        + '</span>'
                        + ' &nbsp;<span style="font-size:10px;color:#aaa">(ticking live)</span><br>';
                } else {
                    rows += '<span style="color:#555;font-weight:700">â›” Deactivated at:</span> '
                        + (deactivatedAt
                            ? '<span style="color:#c62828;font-weight:600">' + fmtDT(deactivatedAt) + '</span>'
                            : '<span style="color:#aaa">â€”</span>');
                    if (activatedAt && deactivatedAt) {
                        rows += ' &nbsp;Â·&nbsp; <span style="color:#555;font-weight:700">Was active for:</span> '
                            + '<span style="color:#1565c0;font-weight:700">' + durFixed(activatedAt, deactivatedAt) + '</span>';
                    }
                    rows += '<br>';
                }

                // Warn if any quiz/response happened BEFORE this activation
                if (total > 0 && activatedAt) {
                    const respArr = Object.values(responses);
                    const before = respArr.filter(r => r.submittedAt && new Date(r.submittedAt) < new Date(activatedAt));
                    if (before.length > 0) {
                        rows += '<span style="color:#e65100;font-weight:700">âš ï¸ ' + before.length
                            + ' response(s) were submitted BEFORE feedback was activated</span>'
                            + ' â€” they may have been collected from an earlier session.<br>';
                    }
                }

                histEl.style.display    = 'block';
                histEl.innerHTML        = rows;
                histEl.style.borderColor = isActive ? '#a5d6a7' : '#ffcdd2';
                histEl.style.background  = isActive ? '#f1f8e9' : '#fff5f5';

                // -- Start live ticker if currently active ---------------------
                if (isActive && activatedAt) {
                    window._fbActiveTicker = setInterval(() => {
                        const tickEl = document.getElementById('fbLiveTicker');
                        if (!tickEl) { clearInterval(window._fbActiveTicker); return; }
                        tickEl.textContent = durLabel(activatedAt);
                    }, 1000);
                }
            }
            const savedEvents = settings.events || FB_DEFAULT_EVENTS;
            const checkboxContainer = document.getElementById('fbEventCheckboxes');
            if (checkboxContainer) {
                checkboxContainer.innerHTML = FB_DEFAULT_EVENTS.map(ev => `
                    <label style="display:flex;align-items:center;gap:8px;cursor:pointer;background:white;padding:8px 12px;border-radius:8px;border:2px solid ${savedEvents.includes(ev)?'#9c27b0':'#e0e0e0'};font-size:0.88em;font-weight:600;color:#333;transition:all 0.2s" onclick="this.style.borderColor=this.querySelector('input').checked?'#e0e0e0':'#9c27b0'">
                        <input type="checkbox" value="${ev}" ${savedEvents.includes(ev)?'checked':''} style="accent-color:#9c27b0;width:16px;height:16px"> ${ev}
                    </label>`).join('');
            }
            // Restore dismiss setting
            const maxDismiss = (settings.maxDismiss !== undefined) ? parseInt(settings.maxDismiss) : 1;
            fbAdminMaxDismiss = maxDismiss;
            const dispEl = document.getElementById('fbMaxDismissDisplay');
            const valEl = document.getElementById('fbMaxDismissVal');
            const explainEl = document.getElementById('fbDismissExplain');
            if (dispEl) dispEl.textContent = maxDismiss;
            if (valEl) valEl.value = maxDismiss;
            if (explainEl) explainEl.textContent = FB_DISMISS_LABELS[maxDismiss] || `ðŸŸ¢ ${maxDismiss} dismissals allowed before forcing`;
            // Load questions preview
            await loadFeedbackQuestionLabels();
            if (msg) msg.innerHTML = '<p style="color:#28a745;background:#d4edda;padding:10px 14px;border-radius:8px;font-weight:600">âœ… Feedback admin loaded.</p>';
            setTimeout(() => { if(msg) msg.innerHTML = ''; }, 3000);
        } catch(e) {
            if (msg) msg.innerHTML = '<p style="color:#c62828;background:#fde8e8;padding:10px 14px;border-radius:8px">âŒ Error: ' + e.message + '</p>';
        }
    }

    function fbSelectAllEvents() {
        document.querySelectorAll('#fbEventCheckboxes input[type="checkbox"]').forEach(cb => {
            cb.checked = true;
            cb.closest('label').style.borderColor = '#9c27b0';
        });
    }

    function fbClearAllEvents() {
        document.querySelectorAll('#fbEventCheckboxes input[type="checkbox"]').forEach(cb => {
            cb.checked = false;
            cb.closest('label').style.borderColor = '#e0e0e0';
        });
    }

    function fbAddCustomEvent() {
        const name = prompt('Enter custom event name:');
        if (!name || !name.trim()) return;
        const container = document.getElementById('fbCustomEventsContainer');
        const div = document.createElement('div');
        div.style.cssText = 'display:flex;align-items:center;gap:8px;margin-top:8px';
        div.innerHTML = `<label style="display:flex;align-items:center;gap:8px;cursor:pointer;background:white;padding:8px 12px;border-radius:8px;border:2px solid #9c27b0;font-size:0.88em;font-weight:600;color:#333"><input type="checkbox" value="${name.trim()}" checked class="fb-custom-event-cb" style="accent-color:#9c27b0;width:16px;height:16px"> âœ¨ ${name.trim()} <span style="color:#888;font-size:0.8em">(custom)</span></label><button onclick="this.parentNode.remove()" style="background:#f44336;color:white;border:none;border-radius:6px;padding:4px 10px;cursor:pointer;font-size:0.8em">âœ•</button>`;
        container.appendChild(div);
    }

    async function saveFeedbackEventList() {
        const checked = [...document.querySelectorAll('#fbEventCheckboxes input[type="checkbox"]:checked')].map(cb => cb.value);
        const custom = [...document.querySelectorAll('.fb-custom-event-cb:checked')].map(cb => cb.value);
        const allEvents = [...new Set([...checked, ...custom])];
        if (!allEvents.length) { alert('âš ï¸ Please select at least one event!'); return; }
        const msg = document.getElementById('feedbackAdminMsg');
        if (msg) msg.innerHTML = '<p style="color:#666">â³ Saving event list...</p>';
        try {
            await db.ref('feedbackSettings/events').set(allEvents);
            if (msg) msg.innerHTML = '<p style="color:#28a745;background:#d4edda;padding:10px 14px;border-radius:8px;font-weight:600">âœ… Event list saved! ' + allEvents.length + ' events selected.</p>';
            setTimeout(() => { if(msg) msg.innerHTML = ''; }, 3000);
        } catch(e) {
            if (msg) msg.innerHTML = '<p style="color:#c62828;background:#fde8e8;padding:10px 14px;border-radius:8px">âŒ Error: ' + e.message + '</p>';
        }
    }

    async function activateFeedback() {
        if (!confirm('ðŸš€ Activate feedback popup for ALL visitors now?\n\nEveryone on the page will see it.')) return;
        const msg = document.getElementById('feedbackAdminMsg');
        if (msg) msg.innerHTML = '<p style="color:#666">â³ Activating...</p>';
        try {
            const eventsSnap = await db.ref('feedbackSettings/events').once('value');
            const events = eventsSnap.val() || FB_DEFAULT_EVENTS;
            await db.ref('feedbackSettings').update({ active: true, activatedAt: new Date().toISOString(), activatedBy: 'Super Admin', events });
            if (msg) msg.innerHTML = '<p style="color:#28a745;background:#d4edda;padding:10px 14px;border-radius:8px;font-weight:600">ðŸš€ Feedback is now LIVE for all visitors!</p>';
            await loadFeedbackAdmin();
        } catch(e) {
            if (msg) msg.innerHTML = '<p style="color:#c62828;background:#fde8e8;padding:10px 14px;border-radius:8px">âŒ Error: ' + e.message + '</p>';
        }
    }

    async function deactivateFeedback() {
        if (!confirm('â›” Deactivate feedback popup?\n\nVisitors will no longer see the popup.')) return;
        const msg = document.getElementById('feedbackAdminMsg');
        if (msg) msg.innerHTML = '<p style="color:#666">â³ Deactivating...</p>';
        try {
            await db.ref('feedbackSettings').update({ active: false, deactivatedAt: new Date().toISOString() });
            if (msg) msg.innerHTML = '<p style="color:#ff9800;background:#fff3e0;padding:10px 14px;border-radius:8px;font-weight:600">â›” Feedback deactivated. Popup hidden for all visitors.</p>';
            await loadFeedbackAdmin();
        } catch(e) {
            if (msg) msg.innerHTML = '<p style="color:#c62828;background:#fde8e8;padding:10px 14px;border-radius:8px">âŒ Error: ' + e.message + '</p>';
        }
    }

    async function loadFeedbackResponses() {
        const container = document.getElementById('fbResponsesContainer');
        if (!container) return;
        container.innerHTML = '<p style="color:#666;text-align:center;padding:20px">â³ Loading responses...</p>';
        try {
            const snap = await db.ref('feedbackResponses').once('value');
            const data = snap.val();
            if (!data) { container.innerHTML = '<p style="color:#aaa;text-align:center;padding:20px">No feedback responses yet.</p>'; return; }
            const responses = Object.values(data).sort((a,b) => new Date(b.submittedAt) - new Date(a.submittedAt));
            let html = `<div style="overflow-x:auto"><table style="width:100%;border-collapse:collapse;font-size:0.85em">
                <thead><tr style="background:linear-gradient(135deg,#880e4f,#c2185b);color:white">
                    <th style="padding:10px 12px;text-align:left">#</th>
                    <th style="padding:10px 12px;text-align:left">Name</th>
                    <th style="padding:10px 12px;text-align:left">Class</th>
                    <th style="padding:10px 12px;text-align:center">Type</th>
                    <th style="padding:10px 12px;text-align:center">Score</th>
                    <th style="padding:10px 12px;text-align:center">Recommend</th>
                    <th style="padding:10px 12px;text-align:left">Event Ratings</th>
                    <th style="padding:10px 12px;text-align:left">Suggestions</th>
                    <th style="padding:10px 12px;text-align:left">Date</th>
                    <th style="padding:10px 12px;text-align:left">Time</th>
                </tr></thead><tbody>`;
            responses.forEach((r, i) => {
                const evRatings = r.eventRatings ? Object.entries(r.eventRatings).map(([ev,s]) => `${ev}: ${'â­'.repeat(s)}`).join(', ') : 'â€”';
                const recColors = {yes:'#d4edda;color:#155724', maybe:'#fff3cd;color:#856404', no:'#f8d7da;color:#721c24'};
                const recBg = recColors[r.recommend] || '#f5f5f5;color:#333';
                const submittedAt = r.submittedAt ? new Date(r.submittedAt) : null;
                const dateStr = r.submittedDate || (submittedAt ? submittedAt.toLocaleDateString('en-IN',{day:'2-digit',month:'short',year:'numeric'}) : 'â€”');
                const timeStr = r.submittedTime || (submittedAt ? submittedAt.toLocaleTimeString('en-IN',{hour:'2-digit',minute:'2-digit',hour12:true}) : 'â€”');
                const typeLabel = r.visitorType === 'quiz_student'
                    ? '<span style="background:#e8f5e9;color:#2e7d32;padding:2px 8px;border-radius:10px;font-size:0.8em;font-weight:700">ðŸŽ“ Student</span>'
                    : '<span style="background:#e3f2fd;color:#1565c0;padding:2px 8px;border-radius:10px;font-size:0.8em;font-weight:700">ðŸ‘¤ Visitor</span>';
                html += `<tr style="background:${i%2===0?'white':'#fafafa'};border-bottom:1px solid #eee">
                    <td style="padding:9px 12px;color:#888">${i+1}</td>
                    <td style="padding:9px 12px;font-weight:600">${r.name||'â€”'}</td>
                    <td style="padding:9px 12px">${r.class||'â€”'}</td>
                    <td style="padding:9px 12px;text-align:center">${typeLabel}</td>
                    <td style="padding:9px 12px;text-align:center"><span style="background:#e3f2fd;color:#1565c0;padding:3px 10px;border-radius:20px;font-weight:700">${r.overallScore||'â€”'}/10</span></td>
                    <td style="padding:9px 12px;text-align:center"><span style="background:${recBg};padding:3px 10px;border-radius:20px;font-weight:700;font-size:0.85em">${r.recommend||'â€”'}</span></td>
                    <td style="padding:9px 12px;font-size:0.82em;max-width:200px">${evRatings}</td>
                    <td style="padding:9px 12px;font-size:0.82em;max-width:160px;color:#555;font-style:italic">${r.suggestions||'â€”'}</td>
                    <td style="padding:9px 12px;font-size:0.8em;color:#555;white-space:nowrap">ðŸ“… ${dateStr}</td>
                    <td style="padding:9px 12px;font-size:0.8em;color:#888;white-space:nowrap">ðŸ• ${timeStr}</td>
                </tr>`;
            });
            html += '</tbody></table></div>';
            html += `<p style="color:#888;font-size:0.8em;margin-top:8px;text-align:right">${responses.length} response(s) total</p>`;
            container.innerHTML = html;
        } catch(e) {
            container.innerHTML = '<p style="color:#c62828;background:#fde8e8;padding:10px 14px;border-radius:8px">âŒ Error: ' + e.message + '</p>';
        }
    }

    async function downloadFeedbackCSV() {
        try {
            const snap = await db.ref('feedbackResponses').once('value');
            const data = snap.val();
            if (!data) { alert('No responses to download!'); return; }
            const rows = Object.values(data);
            const evKeys = [...new Set(rows.flatMap(r => r.eventRatings ? Object.keys(r.eventRatings) : []))];
            const headers = ['Name','Class','Overall Score (1-10)','Recommend',...evKeys,'Suggestions','Submitted At'];
            const csv = [headers.join(','), ...rows.map(r => [
                `"${(r.name||'').replace(/"/g,'""')}"`,
                `"${(r.class||'').replace(/"/g,'""')}"`,
                r.overallScore||'',
                r.recommend||'',
                ...evKeys.map(k => (r.eventRatings&&r.eventRatings[k])||''),
                `"${(r.suggestions||'').replace(/"/g,'""')}"`,
                r.submittedAt||''
            ].join(','))].join('\n');
            const blob = new Blob([csv], {type:'text/csv'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href=url; a.download='spurthi_feedback_' + new Date().toISOString().split('T')[0] + '.csv'; a.click();
            URL.revokeObjectURL(url);
        } catch(e) { alert('Error: ' + e.message); }
    }

    async function clearAllFeedback() {
        if (!confirm('âš ï¸ Delete ALL feedback responses? This cannot be undone!')) return;
        try {
            await db.ref('feedbackResponses').remove();
            alert('âœ… All feedback responses cleared.');
            await loadFeedbackAdmin();
        } catch(e) { alert('Error: ' + e.message); }
    }

    // -- Speed Slide Admin ----------------------------------------------
    let ssaAllSubs = [];
    let ssaLbDiff  = 'easy';

    function ssaShowTab(t) {
        ['sub','lb','cfg'].forEach(x => {
            document.getElementById('ssa-'+x).style.display = x===t ? 'block' : 'none';
            document.getElementById('ssa-tab-'+x).classList.toggle('active', x===t);
        });
        if (t==='sub') ssaLoadSubs();
        if (t==='lb')  ssaLoadLB();
        if (t==='cfg') ssaLoadCfg();
    }

    async function ssaLoadSubs() {
        document.getElementById('ssaSubList').innerHTML = '<p style="color:#aaa;padding:20px;text-align:center">Loadingâ€¦</p>';
        const diff   = document.getElementById('ssaSubFilter').value;
        const status = document.getElementById('ssaSubStatus').value;
        try {
            const snap = await window.db.ref('speedSlide/submissions').once('value');
            ssaAllSubs = [];
            snap.forEach(c => ssaAllSubs.push({ key: c.key, ...c.val() }));
            ssaAllSubs.sort((a,b) => b.solvedAt > a.solvedAt ? 1 : -1);
            let rows = ssaAllSubs.filter(r =>
                (!diff   || r.difficulty === diff) &&
                (!status || r.status     === status)
            );
            if (!rows.length) {
                document.getElementById('ssaSubList').innerHTML = '<p style="color:#aaa;text-align:center;padding:30px">No submissions found.</p>';
                return;
            }
            const diffLabel = {easy:'ðŸ˜Š 8-Puzzle', medium:'ðŸ˜… 15-Puzzle', hard:'ðŸ”¥ 24-Puzzle'};
            const statusColor = {approved:'#2e7d32', rejected:'#c62828', pending:'#e65100'};
            const statusBg    = {approved:'#e8f5e9', rejected:'#ffebee', pending:'#fff3e0'};
            document.getElementById('ssaSubList').innerHTML = rows.map(r => `
                <div style="background:white;border-radius:14px;padding:16px;margin-bottom:14px;box-shadow:0 2px 12px rgba(0,0,0,.1);border-left:5px solid ${r.status==='approved'?'#4caf50':r.status==='rejected'?'#f44336':'#ff9800'}">
                    <div style="display:flex;align-items:flex-start;gap:16px;flex-wrap:wrap">
                        <!-- Puzzle Photo -->
                        <div style="display:flex;flex-direction:column;align-items:center;gap:6px">
                            ${r.imageUrl
                                ? `<div style="position:relative;cursor:zoom-in" onclick="document.getElementById('ssaLightbox').style.display='flex';document.getElementById('ssaLightboxImg').src='${r.imageUrl}'">
                                    <img src="${r.imageUrl}" style="width:130px;height:130px;object-fit:cover;border-radius:10px;border:3px solid #9c27b0;display:block" alt="">
                                    <div style="position:absolute;bottom:0;left:0;right:0;background:linear-gradient(transparent,rgba(106,27,154,.85));border-radius:0 0 8px 8px;padding:5px 6px;text-align:center">
                                        <span style="color:white;font-size:.68em;font-weight:700">ðŸ” Tap to enlarge</span>
                                    </div>
                                   </div>
                                   <span style="font-size:.72em;font-weight:700;color:#6a1b9a;background:#f3e5f5;padding:3px 10px;border-radius:8px">ðŸ–¼ï¸ Puzzle Photo</span>`
                                : `<div style="width:130px;height:130px;background:#f0e6ff;border-radius:10px;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:6px;border:3px dashed #ce93d8">
                                    <span style="font-size:2.2em">ðŸ“·</span>
                                    <span style="font-size:.7em;color:#9c27b0;font-weight:600">No Photo</span>
                                   </div>`
                            }
                        </div>
                        <!-- Info -->
                        <div style="flex:1;min-width:160px">
                            <div style="font-weight:700;font-size:1.05em;color:#333">${ssaEsc(r.name)}</div>
                            <div style="color:#888;font-size:.85em;margin:3px 0">${ssaEsc(r.class||'')} Â· ${ssaEsc(r.phone||'')}</div>
                            <div style="font-size:.88em;color:#6a1b9a;margin:3px 0">
                                ${diffLabel[r.difficulty]||r.difficulty} Â· â± ${ssaFmtTime(r.timeSec)} Â· ðŸŽ¯ ${r.moves} moves Â· â­ ${r.points} pts
                            </div>
                            <div style="font-size:.8em;color:#aaa">${r.date||''} at ${(r.solvedAt||'').slice(11,19)}</div>
                            <span style="display:inline-block;padding:3px 10px;border-radius:10px;font-size:.78em;font-weight:700;background:${statusBg[r.status]||statusBg.pending};color:${statusColor[r.status]||statusColor.pending};margin-top:5px">${r.status||'pending'}</span>
                        </div>
                        <!-- Action Buttons -->
                        <div style="display:flex;flex-direction:column;gap:7px">
                            <button onclick="ssaApprove('${r.key}')" style="background:#4caf50;color:white;border:none;padding:8px 16px;border-radius:7px;cursor:pointer;font-weight:600;font-size:.88em">âœ… Approve</button>
                            <button onclick="ssaReject('${r.key}')"  style="background:#f44336;color:white;border:none;padding:8px 16px;border-radius:7px;cursor:pointer;font-weight:600;font-size:.88em">âŒ Reject</button>
                            <button onclick="ssaDelete('${r.key}')"  style="background:#888;   color:white;border:none;padding:8px 16px;border-radius:7px;cursor:pointer;font-weight:600;font-size:.88em">ðŸ—‘ Delete</button>
                        </div>
                    </div>
                </div>`).join('');
        } catch(e) {
            document.getElementById('ssaSubList').innerHTML = '<p style="color:red;padding:20px">Error: '+e.message+'</p>';
        }
    }

    async function ssaApprove(key) {
        await window.db.ref('speedSlide/submissions/'+key+'/status').set('approved');
        ssaLoadSubs();
    }
    async function ssaReject(key) {
        await window.db.ref('speedSlide/submissions/'+key+'/status').set('rejected');
        ssaLoadSubs();
    }
    async function ssaDelete(key) {
        if (!confirm('Delete this submission permanently?')) return;
        await window.db.ref('speedSlide/submissions/'+key).remove();
        ssaLoadSubs();
    }

    async function ssaLoadLB() {
        document.getElementById('ssaLbContainer').innerHTML = '<p style="color:#aaa;padding:20px;text-align:center">Loadingâ€¦</p>';
        try {
            const snap = await window.db.ref('speedSlide/submissions').once('value');
            let data = [];
            snap.forEach(c => { const v=c.val(); if(v.status==='approved') data.push(v); });
            data.sort((a,b) => {
                if (b.points !== a.points) return b.points - a.points;
                if (a.timeSec !== b.timeSec) return a.timeSec - b.timeSec;
                return a.moves - b.moves;
            });
            const diff = ssaLbDiff;
            let rows = diff==='all' ? data : data.filter(r => r.difficulty===diff);
            const seen = new Set();
            rows = rows.filter(r => {
                const k = (r.uid||r.phone)+'|'+r.difficulty;
                if (seen.has(k)) return false;
                seen.add(k); return true;
            });
            const medals = ['ðŸ¥‡','ðŸ¥ˆ','ðŸ¥‰'];
            const diffLabel = {easy:'ðŸ˜Š 8-Puzzle', medium:'ðŸ˜… 15-Puzzle', hard:'ðŸ”¥ 24-Puzzle'};
            document.getElementById('ssaLbContainer').innerHTML = rows.length
                ? rows.map((r,i) => `
                    <div style="display:grid;grid-template-columns:44px 1fr auto auto;gap:10px;align-items:center;padding:12px 16px;border-radius:10px;background:white;margin-bottom:8px;box-shadow:0 2px 8px rgba(0,0,0,.07)">
                        <div style="font-size:1.5em;text-align:center">${medals[i]||'#'+(i+1)}</div>
                        <div>
                            <div style="font-weight:700">${ssaEsc(r.name)}</div>
                            <div style="color:#888;font-size:.82em">${ssaEsc(r.class||'')} Â· ${r.date||''} Â· ${diffLabel[r.difficulty]||r.difficulty}</div>
                        </div>
                        <div style="color:#e65100;font-weight:700;font-size:.9em">â± ${ssaFmtTime(r.timeSec)} Â· ðŸŽ¯ ${r.moves}</div>
                        <div style="color:#6a1b9a;font-weight:800;font-size:1.1em;text-align:right">â­${r.points}</div>
                    </div>`).join('')
                : '<p style="color:#aaa;text-align:center;padding:30px">No approved scores yet.</p>';
        } catch(e) {
            document.getElementById('ssaLbContainer').innerHTML = '<p style="color:red">'+e.message+'</p>';
        }
    }

    function ssaSwitchLB(d) {
        ssaLbDiff = d;
        ['easy','medium','hard','all'].forEach(x =>
            document.getElementById('ssalbt-'+x)?.classList.toggle('active', x===d)
        );
        ssaLoadLB();
    }

    async function ssaLoadCfg() {
        try {
            const snap = await window.db.ref('speedSlide/config').once('value');
            const cfg  = snap.val() || {};
            document.getElementById('ssaCfgActive').value    = cfg.active    !== false ? '1' : '0';
            document.getElementById('ssaCfgLbVisible').value = cfg.lbVisible !== false ? '1' : '0';
            document.getElementById('ssaCfgMaxSubs').value   = cfg.maxSubs  || 3;
        } catch(e) { console.error('ssaLoadCfg:', e); }
    }

    async function ssaSaveCfg() {
        const cfg = {
            active    : document.getElementById('ssaCfgActive').value    === '1',
            lbVisible : document.getElementById('ssaCfgLbVisible').value === '1',
            maxSubs   : parseInt(document.getElementById('ssaCfgMaxSubs').value) || 3
        };
        await window.db.ref('speedSlide/config').set(cfg);
        const msg = document.getElementById('ssaCfgMsg');
        msg.style.display = 'inline-block';
        msg.style.color   = '#2e7d32';
        msg.textContent   = 'âœ… Settings saved!';
        setTimeout(() => msg.style.display='none', 3000);
    }

    async function ssaClearAllScores() {
        if (!confirm('âš ï¸ Delete ALL Speed Slide scores? This cannot be undone.')) return;
        await window.db.ref('speedSlide/submissions').remove();
        alert('All scores cleared.');
        ssaLoadSubs();
    }

    function ssaClearAllImages() {
        alert('To clear uploaded images, go to Firebase Console â†’ Storage â†’ speedSlide/ folder and delete files from there.');
    }

    function ssaDownloadCSV() {
        const rows = [['Name','Class','Phone','Difficulty','Time(sec)','Moves','Points','Status','Date','SolvedAt']];
        ssaAllSubs.forEach(r => rows.push([r.name,r.class,r.phone,r.difficulty,r.timeSec,r.moves,r.points,r.status,r.date,r.solvedAt]));
        const csv = rows.map(r => r.map(v => '"'+(v||'')+'"').join(',')).join('\n');
        const a = document.createElement('a');
        a.href = 'data:text/csv;charset=utf-8,' + encodeURIComponent(csv);
        a.download = 'speed_slide_results.csv';
        a.click();
    }

    function ssaFmtTime(sec) {
        if (!sec && sec !== 0) return 'â€”';
        const m = Math.floor(sec/60);
        const s = (sec%60).toString().padStart(2,'0');
        return m+':'+s;
    }
    function ssaEsc(s) {
        if (!s) return '';
        return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
    }

    // -- Speed Slide Admin Access ---------------------------------------
    function openSpeedSlideAdmin() {
        showTab('speedSlideAdmin');
        // Load submissions automatically
        ssaShowTab('sub');
    }

    // -- Helpers --------------------------------------------------------
    function shEsc(str) {
        if (!str) return '';
        return String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
    }
    function shShowMsg(el,type,text) {
        el.className='message '+(type==='error'?'error':'success')+' show';
        el.textContent=text; el.style.display='block';
    }
    function shShowInlineMsg(el,type,text) {
        if(!el) return;
        el.style.display='block';
        el.style.color=type==='error'?'#c62828':type==='success'?'#2e7d32':'#1565c0';
        el.style.background=type==='error'?'#ffebee':type==='success'?'#e8f5e9':'#e3f2fd';
        el.style.padding='8px 12px'; el.style.borderRadius='6px';
        el.textContent=text;
    }

    // showTab scavenger logic handled directly inside showTab() in main script


    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // SPEED SLIDE CHALLENGE â€” Full game logic (runs inside index.html)
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    const SSC_DIFF = {
        easy  : { size:3, maxPts:100,  label:'8-Puzzle (3Ã—3)'  },
        medium: { size:4, maxPts:200,  label:'15-Puzzle (4Ã—4)' },
        hard  : { size:5, maxPts:300,  label:'24-Puzzle (5Ã—5)' }
    };

    sscCurrentUser = null;
    let sscDiff        = 'medium';
    let sscSize        = 4;
    let sscTiles       = [];
    let sscEmpty       = 0;
    let sscMoves       = 0;
    let sscSeconds     = 0;
    sscTimerRef    = null;
    let sscSolDisabled = false;
    let sscSolved      = false;
    let sscImageData   = null;
    let sscImageHash   = null;
    let sscLbDiff      = 'easy';

    // â•â• SSC SOUND ENGINE (Web Audio API) â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    const sscAudioCtx = (function() {
        try { return new (window.AudioContext || window.webkitAudioContext)(); } catch(e) { return null; }
    })();

    function sscPlaySound(type) {
        if (!sscAudioCtx) return;
        try {
            const ctx = sscAudioCtx;
            if (ctx.state === 'suspended') ctx.resume();
            const o = ctx.createOscillator();
            const g = ctx.createGain();
            o.connect(g); g.connect(ctx.destination);
            const t = ctx.currentTime;
            if (type === 'move') {
                // Soft click: short blip
                o.type = 'sine';
                o.frequency.setValueAtTime(520, t);
                o.frequency.exponentialRampToValueAtTime(420, t + 0.06);
                g.gain.setValueAtTime(0.18, t);
                g.gain.exponentialRampToValueAtTime(0.001, t + 0.08);
                o.start(t); o.stop(t + 0.08);
            } else if (type === 'invalid') {
                // Dull thud for invalid move
                o.type = 'square';
                o.frequency.setValueAtTime(120, t);
                g.gain.setValueAtTime(0.12, t);
                g.gain.exponentialRampToValueAtTime(0.001, t + 0.1);
                o.start(t); o.stop(t + 0.1);
            } else if (type === 'select') {
                // UI selection pop
                o.type = 'sine';
                o.frequency.setValueAtTime(700, t);
                o.frequency.exponentialRampToValueAtTime(900, t + 0.07);
                g.gain.setValueAtTime(0.12, t);
                g.gain.exponentialRampToValueAtTime(0.001, t + 0.1);
                o.start(t); o.stop(t + 0.1);
            } else if (type === 'win') {
                // ðŸŽ‰ VICTORY FANFARE â€” rising chords + triumphant finish
                const winNotes = [
                    {f:523,d:0,dur:0.25},{f:659,d:0.18,dur:0.25},{f:784,d:0.36,dur:0.25},
                    {f:1047,d:0.55,dur:0.5},{f:988,d:0.6,dur:0.4},{f:1047,d:0.75,dur:0.6}
                ];
                winNotes.forEach(({f,d,dur}) => {
                    const o2=ctx.createOscillator(), g2=ctx.createGain();
                    o2.connect(g2); g2.connect(ctx.destination);
                    o2.type='triangle';
                    o2.frequency.setValueAtTime(f, t+d);
                    g2.gain.setValueAtTime(0.28, t+d);
                    g2.gain.exponentialRampToValueAtTime(0.001, t+d+dur);
                    o2.start(t+d); o2.stop(t+d+dur+0.05);
                });
                // Crowd cheer â€” layered noise bursts
                for(let w=0;w<3;w++){
                    const buf=ctx.createBuffer(1,ctx.sampleRate*0.6,ctx.sampleRate);
                    const data=buf.getChannelData(0);
                    for(let i=0;i<data.length;i++) data[i]=(Math.random()*2-1)*0.35;
                    const src=ctx.createBufferSource(), gn=ctx.createGain();
                    const fil=ctx.createBiquadFilter(); fil.type='bandpass';
                    fil.frequency.value=1200+w*400; fil.Q.value=0.8;
                    src.buffer=buf; src.connect(fil); fil.connect(gn); gn.connect(ctx.destination);
                    gn.gain.setValueAtTime(0, t+w*0.25);
                    gn.gain.linearRampToValueAtTime(0.18, t+w*0.25+0.1);
                    gn.gain.exponentialRampToValueAtTime(0.001, t+w*0.25+0.55);
                    src.start(t+w*0.25); src.stop(t+w*0.25+0.6);
                }
                // Clapping rhythm â€” sharp percussive hits
                [0.05,0.25,0.45,0.65,0.85,1.05,1.15,1.25].forEach(d => {
                    const buf=ctx.createBuffer(1,ctx.sampleRate*0.08,ctx.sampleRate);
                    const data=buf.getChannelData(0);
                    for(let i=0;i<data.length;i++) data[i]=(Math.random()*2-1)*Math.exp(-i/(ctx.sampleRate*0.025));
                    const src=ctx.createBufferSource(), gn=ctx.createGain();
                    const fil=ctx.createBiquadFilter(); fil.type='highpass'; fil.frequency.value=800;
                    src.buffer=buf; src.connect(fil); fil.connect(gn); gn.connect(ctx.destination);
                    gn.gain.setValueAtTime(0.4, t+d);
                    gn.gain.exponentialRampToValueAtTime(0.001, t+d+0.07);
                    src.start(t+d); src.stop(t+d+0.08);
                });
                return;
            } else if (type === 'gameover') {
                // ðŸ˜¤ BOO BOO â€” descending sad trombone + crowd boo
                const booNotes = [
                    {f:466,d:0,dur:0.3},{f:415,d:0.25,dur:0.3},{f:370,d:0.5,dur:0.3},{f:311,d:0.75,dur:0.55}
                ];
                booNotes.forEach(({f,d,dur}) => {
                    const o2=ctx.createOscillator(), g2=ctx.createGain();
                    o2.connect(g2); g2.connect(ctx.destination);
                    o2.type='sawtooth';
                    o2.frequency.setValueAtTime(f, t+d);
                    o2.frequency.exponentialRampToValueAtTime(f*0.88, t+d+dur);
                    g2.gain.setValueAtTime(0.2, t+d);
                    g2.gain.exponentialRampToValueAtTime(0.001, t+d+dur);
                    o2.start(t+d); o2.stop(t+d+dur+0.05);
                });
                // Crowd boo noise â€” low rumble
                for(let w=0;w<2;w++){
                    const buf=ctx.createBuffer(1,ctx.sampleRate*0.9,ctx.sampleRate);
                    const data=buf.getChannelData(0);
                    for(let i=0;i<data.length;i++) data[i]=(Math.random()*2-1)*0.25;
                    const src=ctx.createBufferSource(), gn=ctx.createGain();
                    const fil=ctx.createBiquadFilter(); fil.type='bandpass';
                    fil.frequency.value=300+w*120; fil.Q.value=1.2;
                    src.buffer=buf; src.connect(fil); fil.connect(gn); gn.connect(ctx.destination);
                    gn.gain.setValueAtTime(0, t+w*0.15);
                    gn.gain.linearRampToValueAtTime(0.15, t+w*0.15+0.2);
                    gn.gain.exponentialRampToValueAtTime(0.001, t+w*0.15+0.85);
                    src.start(t+w*0.15); src.stop(t+w*0.15+0.9);
                }
                return;
            }
        } catch(e) { /* ignore audio errors */ }
    }

    function sscUpdateLiveScore() {
        const base = SSC_DIFF[sscDiff] ? SSC_DIFF[sscDiff].maxPts : 0;
        const minMoves = sscSize * sscSize * 2;
        const live = Math.max(10, base - Math.floor(sscSeconds*0.5) - Math.max(0, sscMoves-minMoves));
        const el = document.getElementById('sscPtsDisplay');
        if (el) {
            el.textContent = live;
            el.classList.remove('ssc-score-drop');
            void el.offsetWidth; // reflow
            el.classList.add('ssc-score-drop');
        }
    }

    // -- LOGIN ----------------------------------------------------------
    async function sscLogin() {
        const phone = (document.getElementById('sscLoginPhone').value||'').trim();
        const pass  = (document.getElementById('sscLoginPassword').value||'').trim();
        const msg   = document.getElementById('sscLoginMsg');
        msg.className = 'message'; msg.style.display = 'none';
        if (!phone || !pass) { msg.className='message error show'; msg.textContent='Enter phone and password.'; return; }
        try {
            // Check if game is active before allowing login
            const cfgSnap = await window.db.ref('speedSlide/config').once('value');
            const cfg = cfgSnap.val() || {};
            if (cfg.active === false) {
                msg.className = 'message error show';
                msg.style.display = 'block';
                msg.innerHTML = 'â¸ï¸ <strong>Speed Slide Challenge is currently paused.</strong><br>The organiser has temporarily disabled the game. Please check back later!';
                return;
            }
            const snap = await window.db.ref('quizStudents').orderByChild('phone').equalTo(phone).once('value');
            if (!snap.exists()) { msg.className='message error show'; msg.textContent='Phone not registered. Register via Daily Quiz first.'; return; }
            let found = null, foundKey = null;
            snap.forEach(c => { if (c.val().password === pass) { found = c.val(); foundKey = c.key; } });
            if (!found) { msg.className='message error show'; msg.textContent='Incorrect password.'; return; }
            if (document.getElementById('sscRememberMe').checked) {
                localStorage.setItem('ssc_remember', '1');
                localStorage.setItem('ssc_ph', phone);
                localStorage.setItem('ssc_pw', pass);
            } else {
                localStorage.removeItem('ssc_remember');
                localStorage.removeItem('ssc_ph');
                localStorage.removeItem('ssc_pw');
            }
            sscCurrentUser = { key: foundKey, ...found };
            document.getElementById('loginSection').style.display    = 'none';
            document.getElementById('sscStudentDashboard').style.display = 'block';
            document.getElementById('sscPlayerBadge').textContent    = (found.name||'') + ' Â· ' + (found.class||found.classYear||'');
            document.getElementById('userInfo').innerHTML = 'Logged in as: <span class="admin-badge" style="background:#6a1b9a;color:white">ðŸ§© ' + (found.name||'') + ' â€“ Speed Slide</span>';
            if (window.maybeShowNotifBanner) maybeShowNotifBanner();
            window.scrollTo({ top: 0, behavior: 'smooth' });
            sscShowSection('play');
            sscSelectDiff('medium');
        } catch(e) {
            msg.className='message error show'; msg.textContent='Error: ' + e.message;
        }
    }

    function sscGoBack() {
        document.getElementById('sscStudentDashboard').style.display = 'none';
        document.getElementById('loginSection').style.display        = 'block';
        window.scrollTo({ top: 0, behavior: 'smooth' });
        sscResetGame();
    }

    // -- SCROLL TO TOP OF SSC DASHBOARD --------------------------------
    function sscScrollTop() {
        const dash = document.getElementById('sscStudentDashboard');
        if (dash) {
            const y = dash.getBoundingClientRect().top + window.pageYOffset - 10;
            window.scrollTo({ top: y, behavior: 'smooth' });
        }
    }

    // -- SECTIONS -------------------------------------------------------
    function sscShowSection(s) {
        document.getElementById('sscPlaySection').style.display = s==='play' ? 'block' : 'none';
        document.getElementById('sscLbSection').style.display   = s==='lb'   ? 'block' : 'none';
        // Show/hide paused banner when switching to play
        if (s === 'play') sscCheckPausedBanner();
        const tabPlay = document.getElementById('sscTabPlay');
        const tabLB   = document.getElementById('sscTabLB');
        if (tabPlay) {
            tabPlay.style.background = s==='play' ? 'rgba(255,255,255,.9)' : 'rgba(255,255,255,.2)';
            tabPlay.style.color      = s==='play' ? '#6a1b9a' : 'white';
            tabPlay.style.border     = s==='play' ? 'none' : '2px solid rgba(255,255,255,.5)';
        }
        if (tabLB) {
            tabLB.style.background = s==='lb' ? 'rgba(255,255,255,.9)' : 'rgba(255,255,255,.2)';
            tabLB.style.color      = s==='lb' ? '#6a1b9a' : 'white';
        }
        if (s==='lb') sscLoadLB();
        sscScrollTop();
    }

    // -- PAUSED BANNER CHECK ------------------------------------------------
    async function sscCheckPausedBanner() {
        try {
            const cfgSnap = await window.db.ref('speedSlide/config').once('value');
            const cfg = cfgSnap.val() || {};
            const paused = cfg.active === false;
            const banner  = document.getElementById('sscPausedBanner');
            const startBtn = document.getElementById('sscStartBtn');
            if (banner)   banner.style.display   = paused ? 'block' : 'none';
            if (startBtn) {
                startBtn.disabled = paused || !sscImageData;
                startBtn.style.opacity = (paused || !sscImageData) ? '.5' : '1';
                startBtn.title = paused ? 'Game is paused by organiser' : '';
            }
        } catch(e) { /* ignore */ }
    }

    // -- DIFFICULTY -----------------------------------------------------
    function sscSelectDiff(d) {
        sscDiff = d; sscSize = SSC_DIFF[d].size;
        ['easy','medium','hard'].forEach(x => {
            const el = document.getElementById('ssdc-'+x);
            if (!el) return;
            el.className = 'ssc-diff-card' + (x===d ? ' ssc-selected' : '');
        });
        const note = document.getElementById('sscDiffNote');
        if (note) note.textContent = SSC_DIFF[d].label + ' Â· ' + SSC_DIFF[d].maxPts + ' max points';
        // Play selection sound
        sscPlaySound('select');
        sscCheckReady();
    }

    // -- IMAGE HASH (simple checksum from first+last 2000 chars of base64) --
    function sscHashImage(base64) {
        const sample = base64.slice(0, 2000) + base64.slice(-2000);
        let h = 0;
        for (let i = 0; i < sample.length; i++) {
            h = ((h << 5) - h) + sample.charCodeAt(i);
            h |= 0;
        }
        return Math.abs(h).toString(36);
    }

    // -- IMAGE ----------------------------------------------------------
    async function sscHandleImage(e) {
        const file = e.target.files[0];
        if (!file) return;
        if (file.size > 5*1024*1024) { alert('Image must be < 5 MB'); return; }
        const reader = new FileReader();
        reader.onload = async ev => {
            const base64 = ev.target.result;
            const hash   = sscHashImage(base64);

            // -- Check if this image was already used in any submission --
            try {
                const snap = await window.db.ref('speedSlide/submissions')
                    .orderByChild('imageHash').equalTo(hash).once('value');
                if (snap.exists()) {
                    // Find who used it
                    let usedBy = '';
                    snap.forEach(c => { usedBy = c.val().name || c.val().phone || ''; });
                    const isSelf = usedBy && sscCurrentUser && (usedBy === sscCurrentUser.name);
                    if (isSelf) {
                        alert('âš ï¸ You have already used this photo in a previous submission. Please upload a different photo.');
                    } else {
                        alert('âš ï¸ This photo has already been used by another student. Please upload your own original photo.');
                    }
                    // Clear the input
                    document.getElementById('sscImgInput').value = '';
                    sscCheckReady();
                    return;
                }
            } catch(err) {
                // If check fails, allow upload (don't block student)
                console.warn('Image hash check failed:', err);
            }

            sscImageData = base64;
            sscImageHash = hash;
            const thumb = document.getElementById('sscPreviewThumb');
            thumb.src = sscImageData; thumb.style.display = 'block';
            const zone = document.getElementById('sscUploadZone');
            zone.className = 'ssc-upload-zone has-image';
            sscPlaySound('select');
            sscCheckReady();
        };
        reader.readAsDataURL(file);
    }

    function sscCheckReady() {
        const btn = document.getElementById('sscStartBtn');
        if (!btn) return;
        const ready = !!(sscDiff && sscImageData);
        btn.disabled = !ready;
        btn.style.opacity = ready ? '1' : '.5';
        btn.style.cursor  = ready ? 'pointer' : 'not-allowed';
    }

    // -- START GAME -----------------------------------------------------
    async function sscStartGame() {
        // Re-check game active status in case admin paused after login
        try {
            const cfgSnap = await window.db.ref('speedSlide/config').once('value');
            const cfg = cfgSnap.val() || {};
            if (cfg.active === false) {
                alert('â¸ï¸ Speed Slide Challenge has been paused by the organiser. Please try again later.');
                sscGoBack();
                return;
            }
        } catch(e) { /* allow if config unreadable */ }
        document.getElementById('sscSetupCard').style.display = 'none';
        document.getElementById('sscGameArea').style.display  = 'block';
        const fallbackOnStart = document.getElementById('sscMarkCompleteSection');
        if (fallbackOnStart) fallbackOnStart.style.display = 'none';
        document.getElementById('sscGameDiffLabel').textContent = ({easy:'ðŸ˜Š Easy',medium:'ðŸ˜„ Medium',hard:'ðŸ”¥ Hard'})[sscDiff] || SSC_DIFF[sscDiff].label;
        document.getElementById('sscPtsDisplay').textContent    = SSC_DIFF[sscDiff].maxPts;
        sscSolDisabled = false; sscSolved = false;
        sscPlaySound('select');
        sscScrollTop();
        sscInitPuzzle();
    }

    function sscInitPuzzle() {
        sscMoves = 0; sscSeconds = 0;
        clearInterval(sscTimerRef);
        document.getElementById('sscTimerDisplay').textContent  = '0:00';
        document.getElementById('sscMovesDisplay').textContent  = '0';
        const n = sscSize * sscSize;
        // Goal: [1,2,...,nÂ²-1, 0] â€” blank at bottom-right
        sscTiles = Array.from({length:n}, (_,i) => i===n-1 ? 0 : i+1);
        sscShuffleTiles(); // random-walk shuffle always produces a solvable puzzle
        sscBuildBoard();
        const prev = document.getElementById('sscInGamePreview');
        const prevWrap = document.getElementById('sscInGamePreviewWrap');
        prev.src = sscImageData; prev.style.display = 'block';
        if (prevWrap) prevWrap.style.display = 'block';
        sscTimerRef = setInterval(() => {
            sscSeconds++;
            document.getElementById('sscTimerDisplay').textContent = sscFmtTime(sscSeconds);
            if (sscSeconds % 2 === 0) sscUpdateLiveScore(); // refresh score every 2s
        }, 1000);
        sscUpdateLiveScore(); // init immediately
    }

    function sscShuffleTiles() {
        // STEP 1: Full Fisher-Yates random shuffle â€” completely different every time
        const n = sscTiles.length;
        for (let i = n - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [sscTiles[i], sscTiles[j]] = [sscTiles[j], sscTiles[i]];
        }
        // STEP 2: If not solvable, swap two non-blank tiles to fix parity
        if (!sscIsSolvable()) {
            // swap first two non-blank tiles to flip parity
            let first = -1, second = -1;
            for (let i = 0; i < sscTiles.length; i++) {
                if (sscTiles[i] !== 0) {
                    if (first === -1) first = i;
                    else { second = i; break; }
                }
            }
            [sscTiles[first], sscTiles[second]] = [sscTiles[second], sscTiles[first]];
        }
        // STEP 3: Short random-walk on top to add extra unpredictability
        // and guarantee the puzzle is not accidentally near-solved
        const extraMoves = sscSize === 3 ? 10 : sscSize === 4 ? 15 : 20;
        let blankIdx = sscTiles.indexOf(0);
        let lastBlank = -1;
        for (let m = 0; m < extraMoves; m++) {
            const r = Math.floor(blankIdx / sscSize);
            const c = blankIdx % sscSize;
            const neighbors = [];
            if (r > 0)            neighbors.push(blankIdx - sscSize);
            if (r < sscSize - 1)  neighbors.push(blankIdx + sscSize);
            if (c > 0)            neighbors.push(blankIdx - 1);
            if (c < sscSize - 1)  neighbors.push(blankIdx + 1);
            const choices = neighbors.filter(idx => idx !== lastBlank);
            const pick = choices[Math.floor(Math.random() * choices.length)];
            lastBlank = blankIdx;
            [sscTiles[blankIdx], sscTiles[pick]] = [sscTiles[pick], sscTiles[blankIdx]];
            blankIdx = pick;
        }
    }

    function sscIsSolvable() {
        const n = sscSize, t = sscTiles;
        let inv = 0;
        for (let i=0; i<t.length-1; i++)
            for (let j=i+1; j<t.length; j++)
                if (t[i] && t[j] && t[i]>t[j]) inv++;
        const blankRow = Math.floor(t.indexOf(0)/n);
        if (n%2===1) return inv%2===0;
        const rowFromBottom = n - blankRow;
        return rowFromBottom%2===0 ? inv%2===1 : inv%2===0;
    }

    function sscBuildBoard(movedIdx) {
        const board = document.getElementById('sscPuzzleBoard');
        board.style.gridTemplateColumns = 'repeat('+sscSize+',1fr)';
        board.style.touchAction = 'none';
        board.innerHTML = '';

        // Block ALL touch events on the board â€” non-passive so preventDefault works
        if (!board._touchBlocked) {
            board._touchBlocked = true;
            const blockTouch = (e) => { e.stopPropagation(); e.preventDefault(); };
            board.addEventListener('touchstart', blockTouch, { passive: false });
            board.addEventListener('touchmove',  blockTouch, { passive: false });
            board.addEventListener('touchend',   blockTouch, { passive: false });
        }

        // Also block touchmove on the entire game area so page can't scroll
        const gameArea = document.getElementById('sscGameArea');
        if (gameArea && !gameArea._touchBlocked) {
            gameArea._touchBlocked = true;
            gameArea.addEventListener('touchmove', (e) => e.preventDefault(), { passive: false });
        }

        const parentW = board.parentElement ? board.parentElement.clientWidth : 0;
        const tileSize = Math.max(200, (parentW || window.innerWidth - 40) - 10);
        const sz = Math.floor(tileSize / sscSize);
        sscTiles.forEach((val, idx) => {
            const tile = document.createElement('div');
            tile.className = 'ssc-tile' + (val===0 ? ' ssc-empty' : '') + (idx===movedIdx ? ' ssc-moved' : '');
            tile.style.cssText += ';touch-action:none;-webkit-touch-callout:none;user-select:none';
            tile.style.width = sz+'px'; tile.style.height = sz+'px';
            if (val === 0) {
                const logoEl = document.createElement('img');
                logoEl.src = 'davan_degree1.png';
                const logoSize = Math.floor(sz * 0.45);
                logoEl.style.cssText = `width:${logoSize}px;height:${logoSize}px;object-fit:contain;margin-bottom:3px;opacity:0.9;filter:drop-shadow(0 1px 3px rgba(0,0,0,.3))`;
                const iconEl = document.createElement('div');
                iconEl.style.cssText = 'font-size:1.3em;line-height:1;animation:sscEmptyArrow 0.9s ease-in-out infinite';
                iconEl.textContent = 'ðŸ‘†';
                const lblEl = document.createElement('div');
                lblEl.style.cssText = 'font-size:.55em;font-weight:900;letter-spacing:1px;color:#3d0000';
                lblEl.textContent = 'MOVE HERE';
                tile.appendChild(logoEl);
                tile.appendChild(iconEl);
                tile.appendChild(lblEl);
            } else {
                const zeroVal = val - 1;
                const col = zeroVal % sscSize;
                const row = Math.floor(zeroVal / sscSize);
                tile.style.backgroundImage    = 'url('+sscImageData+')';
                tile.style.backgroundSize     = (sz * sscSize) + 'px ' + (sz * sscSize) + 'px';
                tile.style.backgroundPosition = (-col * sz) + 'px ' + (-row * sz) + 'px';
            }

            // Use touchstart for instant response â€” no click event needed on mobile
            let touchMoved = false;
            tile.addEventListener('touchstart', (e) => {
                e.preventDefault(); e.stopPropagation();
                touchMoved = false;
            }, { passive: false });
            tile.addEventListener('touchmove', (e) => {
                e.preventDefault(); e.stopPropagation();
                touchMoved = true;
            }, { passive: false });
            tile.addEventListener('touchend', (e) => {
                e.preventDefault(); e.stopPropagation();
                if (!touchMoved) sscTryMove(idx); // only fire if it was a tap, not a swipe
            }, { passive: false });
            // Desktop click still works
            tile.addEventListener('click', (e) => { e.preventDefault(); e.stopPropagation(); sscTryMove(idx); });

            board.appendChild(tile);
        });
    }

    function sscTryMove(clickedIdx) {
        if (sscSolved) return;
        const emptyIdx = sscTiles.indexOf(0);
        const eR = Math.floor(emptyIdx/sscSize), eC = emptyIdx%sscSize;
        const cR = Math.floor(clickedIdx/sscSize), cC = clickedIdx%sscSize;
        const valid = (Math.abs(eR-cR)===1 && eC===cC)||(Math.abs(eC-cC)===1 && eR===cR);
        if (!valid) {
            // Shake the board briefly for invalid move
            sscPlaySound('invalid');
            const board = document.getElementById('sscPuzzleBoard');
            board.classList.remove('ssc-board-shake');
            void board.offsetWidth;
            board.classList.add('ssc-board-shake');
            setTimeout(() => board.classList.remove('ssc-board-shake'), 400);
            return;
        }
        [sscTiles[emptyIdx], sscTiles[clickedIdx]] = [sscTiles[clickedIdx], sscTiles[emptyIdx]];
        sscMoves++;
        document.getElementById('sscMovesDisplay').textContent = sscMoves;
        sscPlaySound('move');
        sscBuildBoard(clickedIdx); // pass moved tile index for animation
        sscUpdateLiveScore();
        sscCheckWin();
    }

    function sscCheckWin() {
        // Goal: tiles [1,2,3,...,nÂ²-1, 0] â€” blank at last position (bottom-right)
        const n2 = sscTiles.length;
        for (let i=0; i<n2-1; i++) if (sscTiles[i] !== i+1) return;
        if (sscTiles[n2-1] !== 0) return;
        sscSolved = true;
        clearInterval(sscTimerRef);
        const pts = sscCalcPoints();
        sscPlaySound('win');
        sscLaunchConfetti();
        // Hide fallback section â€” auto-save handles everything now
        const fallback = document.getElementById('sscMarkCompleteSection');
        if (fallback) fallback.style.display = 'none';
        setTimeout(() => {
            document.getElementById('sscWinTime').textContent  = sscFmtTime(sscSeconds);
            document.getElementById('sscWinMoves').textContent = sscMoves;
            document.getElementById('sscWinDiff').textContent  = ({easy:'ðŸ˜Š Easy',medium:'ðŸ˜„ Medium',hard:'ðŸ”¥ Hard'})[sscDiff];
            document.getElementById('sscWinPts').textContent   = pts;
            document.getElementById('sscWinSaveMsg').innerHTML =
                '<span style="color:#ffd700">â³ Saving your score automaticallyâ€¦</span>';
            const m = document.getElementById('sscWinModal');
            m.style.display = 'flex';
            // Auto-save immediately
            sscAutoSave(pts);
        }, 400);
    }

    function sscCalcPoints() {
        const base = SSC_DIFF[sscDiff].maxPts;
        const minMoves = sscSize * sscSize * 2;
        return Math.max(10, base - Math.floor(sscSeconds*0.5) - Math.max(0, sscMoves-minMoves));
    }

    // -- AUTO SAVE SCORE (called automatically on puzzle completion) ----
    // Step 1: Save score to Firebase INSTANTLY (no image wait)
    // Step 2: Upload image to Cloudinary in BACKGROUND
    // Step 3: Update Firebase record with image URL silently
    // Result: Score is NEVER lost even if image upload fails
    async function sscAutoSave(pts) {
        const msgEl = document.getElementById('sscWinSaveMsg');
        const saveBtn = document.getElementById('sscSaveScoreBtn');
        if (saveBtn) saveBtn.style.display = 'none'; // hide manual button â€” auto handles it

        function setMsg(html) { if (msgEl) msgEl.innerHTML = html; }

        if (sscSolDisabled) {
            setMsg('<span style="color:#ef9a9a">âŒ Score not saved â€” solution was viewed before completing.</span>');
            return;
        }
        if (!sscCurrentUser) {
            setMsg('<span style="color:#ef9a9a">âŒ Not logged in. Please log in and try again.</span>');
            return;
        }

        try {
            // -- STEP 1: Check daily limit ----------------------------
            setMsg('<span style="color:#ffd700">â³ Step 1/3 â€” Checking daily limitâ€¦</span>');
            const cfgSnap = await window.db.ref('speedSlide/config').once('value');
            const maxSubs = (cfgSnap.val() || {}).maxSubs || 3;
            const today   = new Date().toISOString().slice(0, 10);
            const allSnap = await window.db.ref('speedSlide/submissions')
                .orderByChild('phone').equalTo(sscCurrentUser.phone).once('value');
            let todayCount = 0;
            allSnap.forEach(c => { if ((c.val().date || '') === today) todayCount++; });
            if (todayCount >= maxSubs) {
                setMsg(`<span style="color:#ef9a9a">âŒ Daily limit reached! Maximum ${maxSubs} submissions per day.<br><small>Come back tomorrow to play again.</small></span>`);
                return;
            }

            // -- STEP 2: Save score to Firebase IMMEDIATELY -----------
            setMsg('<span style="color:#ffd700">â³ Step 2/3 â€” Saving your scoreâ€¦</span>');
            const entry = {
                uid: sscCurrentUser.key, name: sscCurrentUser.name,
                phone: sscCurrentUser.phone,
                class: sscCurrentUser.class || sscCurrentUser.classYear || '',
                difficulty: sscDiff, size: sscSize,
                timeSec: sscSeconds, moves: sscMoves, points: pts,
                imageUrl: '', imageHash: sscImageHash || '',
                solvedAt: new Date().toISOString(),
                date: today, status: 'pending',
                note: 'Score saved instantly; image uploading in background'
            };
            const ref = await window.db.ref('speedSlide/submissions').push(entry);
            const submissionKey = ref.key;
            const remaining = maxSubs - todayCount - 1;

            // -- Score is SAVED â€” tell student immediately -------------
            setMsg(`<span style="color:#a5d6a7">âœ… Score saved! Pending admin review.<br><small style="color:rgba(255,255,255,.5)">${remaining} submission${remaining!==1?'s':''} left today Â· ðŸ“¸ Uploading photo in backgroundâ€¦</small></span>`);

            // -- STEP 3: Upload image in background silently -----------
            try {
                const parts  = sscImageData.split(',');
                const mime   = parts[0].match(/:(.*?);/)[1];
                const binary = atob(parts[1]);
                const arr    = new Uint8Array(binary.length);
                for (let i = 0; i < binary.length; i++) arr[i] = binary.charCodeAt(i);
                const blob   = new Blob([arr], { type: mime });
                const cldFd  = new FormData();
                cldFd.append('file', blob, 'puzzle.jpg');
                cldFd.append('upload_preset', 'scavenger_hunt');
                cldFd.append('folder', 'speedSlide');
                const cldRes  = await fetch('https://api.cloudinary.com/v1_1/dat0khbet/image/upload', { method: 'POST', body: cldFd });
                const cldData = await cldRes.json();
                if (cldData.secure_url) {
                    // Update the record with the image URL
                    await window.db.ref('speedSlide/submissions/' + submissionKey).update({
                        imageUrl: cldData.secure_url,
                        note: 'Score and image saved successfully'
                    });
                    setMsg(`<span style="color:#a5d6a7">âœ… Score & photo saved! Pending admin review.<br><small style="color:rgba(255,255,255,.5)">${remaining} submission${remaining!==1?'s':''} left today</small></span>`);
                } else {
                    // Image failed but score is already saved â€” no panic
                    await window.db.ref('speedSlide/submissions/' + submissionKey).update({
                        note: 'Score saved; image upload failed â€” admin can verify manually'
                    });
                    setMsg(`<span style="color:#a5d6a7">âœ… Score saved! Photo upload had an issue but your score is safe.<br><small style="color:rgba(255,255,255,.6)">Admin has been notified. ${remaining} submission${remaining!==1?'s':''} left today.</small></span>`);
                }
            } catch(imgErr) {
                // Image upload error â€” score already saved, just update note
                try {
                    await window.db.ref('speedSlide/submissions/' + submissionKey).update({
                        note: 'Score saved; image upload error: ' + imgErr.message
                    });
                } catch(e) { /* ignore */ }
                setMsg(`<span style="color:#a5d6a7">âœ… Score saved! Photo upload had a network issue but your <strong>score is safe</strong>.<br><small style="color:rgba(255,255,255,.6)">Admin has been notified. ${remaining} submission${remaining!==1?'s':''} left today.</small></span>`);
            }

        } catch(e) {
            // Complete failure â€” Firebase itself failed
            setMsg(`<span style="color:#ef9a9a">âŒ Could not save score.<br><small>Possible reason: No internet connection or server error.<br><strong>What to do:</strong> Stay on this screen, reconnect to internet, then tap "â†©ï¸ Retry Save" below.</small></span>`);
            // Show retry button
            const retryWrap = document.getElementById('sscRetryWrap');
            if (retryWrap) retryWrap.style.display = 'block';
        }
    }

    // -- RETRY SAVE (shown only when auto-save fails completely) -------
    function sscRetrySave() {
        const retryWrap = document.getElementById('sscRetryWrap');
        if (retryWrap) retryWrap.style.display = 'none';
        sscAutoSave(sscCalcPoints());
    }

    // -- MARK COMPLETE (fallback with image â€” converts base64 to Blob) ----
    async function sscMarkComplete() {
        if (sscSolDisabled) { alert('Score cannot be saved â€” solution was viewed.'); return; }
        if (!sscCurrentUser) { alert('Not logged in.'); return; }
        const btn      = document.getElementById('sscMarkCompleteBtn');       // win modal button
        const btnGame  = document.getElementById('sscMarkCompleteBtnGame');   // in-game button
        const msg      = document.getElementById('sscWinSaveMsg');            // win modal message

        // -- VERIFY PUZZLE IS ACTUALLY SOLVED --------------------------
        // Check tile order: goal is [1,2,3,...,nÂ²-1, 0] â€” blank at last position
        let inlineMsg = document.getElementById('sscMarkCompleteInlineMsg');
        if (!inlineMsg && btnGame) {
            inlineMsg = document.createElement('p');
            inlineMsg.id = 'sscMarkCompleteInlineMsg';
            inlineMsg.style.cssText = 'font-size:.82em;font-weight:600;margin:6px 0 0;text-align:center;color:#f57f17';
            btnGame.parentElement.appendChild(inlineMsg);
        }
        const n2 = sscTiles.length;
        let puzzleComplete = true;
        for (let i = 0; i < n2 - 1; i++) { if (sscTiles[i] !== i + 1) { puzzleComplete = false; break; } }
        if (sscTiles[n2 - 1] !== 0) puzzleComplete = false;

        if (!puzzleComplete) {
            const notDoneMsg = 'âŒ Puzzle is not completed yet! Please arrange all tiles correctly before submitting.';
            if (msg) msg.textContent = notDoneMsg;
            if (inlineMsg) { inlineMsg.style.color = '#c62828'; inlineMsg.textContent = notDoneMsg; }
            return;
        }

        // Disable both buttons and show loading state
        [btn, btnGame].forEach(b => { if (b) { b.disabled = true; b.textContent = 'â³ Submittingâ€¦'; } });
        if (msg) msg.textContent = 'â³ Checking daily limitâ€¦';
        if (inlineMsg) inlineMsg.textContent = 'â³ Checking daily limitâ€¦';
        try {
            const cfgSnap = await window.db.ref('speedSlide/config').once('value');
            const maxSubs = (cfgSnap.val() || {}).maxSubs || 3;
            const today   = new Date().toISOString().slice(0, 10);
            const allSnap = await window.db.ref('speedSlide/submissions')
                .orderByChild('phone').equalTo(sscCurrentUser.phone).once('value');
            let todayCount = 0;
            allSnap.forEach(c => { if ((c.val().date || '') === today) todayCount++; });
            if (todayCount >= maxSubs) {
                const limitMsg = `âŒ Daily limit reached! Maximum ${maxSubs} submissions per day. Come back tomorrow!`;
                if (msg) msg.textContent = limitMsg;
                if (inlineMsg) inlineMsg.textContent = limitMsg;
                [btn, btnGame].forEach(b => { if (b) { b.disabled = false; b.textContent = 'âœ… I Completed It! â€” Submit My Score'; } });
                return;
            }
            // -- Convert base64 Data URL â†’ Blob for Cloudinary upload --
            if (msg) msg.textContent = 'â³ Uploading image & saving scoreâ€¦';
            if (inlineMsg) inlineMsg.textContent = 'â³ Uploading image & saving scoreâ€¦';
            let imgUrl = '';
            try {
                const base64 = sscImageData;
                const parts  = base64.split(',');
                const mime   = parts[0].match(/:(.*?);/)[1];
                const binary = atob(parts[1]);
                const arr    = new Uint8Array(binary.length);
                for (let i = 0; i < binary.length; i++) arr[i] = binary.charCodeAt(i);
                const blob   = new Blob([arr], { type: mime });
                const cldFd  = new FormData();
                cldFd.append('file', blob, 'puzzle.jpg');
                cldFd.append('upload_preset', 'scavenger_hunt');
                cldFd.append('folder', 'speedSlide');
                const cldRes  = await fetch('https://api.cloudinary.com/v1_1/dat0khbet/image/upload', { method: 'POST', body: cldFd });
                const cldData = await cldRes.json();
                if (cldData.secure_url) imgUrl = cldData.secure_url;
            } catch(uploadErr) {
                console.warn('Image upload failed in sscMarkComplete:', uploadErr);
            }
            const pts = sscCalcPoints();
            const entry = {
                uid: sscCurrentUser.key, name: sscCurrentUser.name,
                phone: sscCurrentUser.phone,
                class: sscCurrentUser.class || sscCurrentUser.classYear || '',
                difficulty: sscDiff, size: sscSize,
                timeSec: sscSeconds, moves: sscMoves, points: pts,
                imageUrl: imgUrl, imageHash: sscImageHash || '',
                solvedAt: new Date().toISOString(),
                date: today, status: 'pending',
                note: imgUrl ? 'Submitted via "I Completed It!" button' : 'Submitted via "I Completed It!" button â€” image upload failed'
            };
            await window.db.ref('speedSlide/submissions').push(entry);
            const remaining = maxSubs - todayCount - 1;
            const successMsg = `âœ… Submitted! Pending admin review. (${remaining} submission${remaining !== 1 ? 's' : ''} left today)`;
            if (msg) msg.textContent = successMsg;
            if (inlineMsg) { inlineMsg.style.color = '#2e7d32'; inlineMsg.textContent = successMsg; }
            [btn, btnGame].forEach(b => { if (b) { b.disabled = true; b.textContent = 'âœ… Submitted!'; b.style.background = 'linear-gradient(135deg,#388e3c,#2e7d32)'; } });
        } catch(e) {
            const errMsg = 'âŒ Submission failed: ' + e.message;
            if (msg) msg.textContent = errMsg;
            if (inlineMsg) { inlineMsg.style.color = '#c62828'; inlineMsg.textContent = errMsg; }
            [btn, btnGame].forEach(b => { if (b) { b.disabled = false; b.textContent = 'âœ… I Completed It! â€” Submit My Score'; } });
        }
    }

    // -- GIVE UP / SOLUTION ENGINE --------------------------------------
    let sscSolSteps     = [];
    let sscSolStepIdx   = 0;
    let sscSolAutoRef   = null;
    let sscSolPlaying   = false;

    function sscShowSolution() {
        if (!confirm('Give up? The solution will be shown step-by-step and the game will end. Continue?')) return;
        clearInterval(sscTimerRef);
        sscSolDisabled = true; sscSolved = true;
        sscPlaySound('gameover');

        document.getElementById('sscSolTime').textContent  = sscFmtTime(sscSeconds);
        document.getElementById('sscSolMoves').textContent = sscMoves;
        document.getElementById('sscSolDiff').textContent  = ({easy:'8-Puzzle',medium:'15-Puzzle',hard:'24-Puzzle'})[sscDiff] || sscDiff;

        const m = document.getElementById('sscGameOverModal');
        m.style.display = 'flex';
        setTimeout(() => sscLaunchBoo(), 150);

        sscSolSteps = []; sscSolStepIdx = 0; sscSolPlaying = false;
        clearInterval(sscSolAutoRef);
        document.getElementById('sscSolPlayBtn').textContent = 'â–¶ Play';
        document.getElementById('sscSolMoveDesc').innerHTML =
            '<span style="color:rgba(255,255,255,.6);font-size:.88em">ðŸ” Computing solutionâ€¦</span>';
        document.getElementById('sscSolStepCounter').textContent = 'â€¦';

        // Run A* solver in chunked async slices â€” no blocking, no loops
        setTimeout(() => sscRunSolverAsync([...sscTiles], sscSize), 100);
    }

    // -- CHUNKED A* / IDA* SOLVER --------------------------------------
    // 8-puzzle  (n=3): A* â€” fast & optimal
    // 15-puzzle (n=4): IDA* with Manhattan + Linear-Conflict heuristic
    // 24-puzzle (n=5): IDA* with Manhattan + Linear-Conflict heuristic
    function sscRunSolverAsync(startTiles, n) {
        const goalArr = Array.from({length:n*n}, (_,i) => i===n*n-1 ? 0 : i+1);
        const goalStr = goalArr.join(',');
        const startStr = startTiles.join(',');

        if (startStr === goalStr) {
            sscSolSteps = [startTiles]; sscSolStepIdx = 0;
            sscRenderSolStep(0); return;
        }

        // -- Heuristic: Manhattan + Linear Conflict --------------------
        function heuristic(t) {
            let h = 0;
            // Manhattan
            for (let i = 0; i < t.length; i++) {
                const v = t[i]; if (!v) continue;
                const goalR = Math.floor((v-1)/n), goalC = (v-1)%n;
                const curR  = Math.floor(i/n),    curC  = i%n;
                h += Math.abs(goalR - curR) + Math.abs(goalC - curC);
            }
            // Linear conflict â€” rows
            for (let r = 0; r < n; r++) {
                const row = [];
                for (let c = 0; c < n; c++) {
                    const v = t[r*n+c];
                    if (v && Math.floor((v-1)/n) === r) row.push(v);
                }
                for (let a = 0; a < row.length; a++)
                    for (let b = a+1; b < row.length; b++)
                        if (row[a] > row[b]) h += 2;
            }
            // Linear conflict â€” cols
            for (let c = 0; c < n; c++) {
                const col = [];
                for (let r = 0; r < n; r++) {
                    const v = t[r*n+c];
                    if (v && (v-1)%n === c) col.push(v);
                }
                for (let a = 0; a < col.length; a++)
                    for (let b = a+1; b < col.length; b++)
                        if (col[a] > col[b]) h += 2;
            }
            return h;
        }

        if (n <= 3) {
            // -- A* for 8-puzzle ---------------------------------------
            class Heap {
                constructor(){ this.d=[]; }
                push(item){ this.d.push(item); this._up(this.d.length-1); }
                pop(){ const t=this.d[0]; const b=this.d.pop(); if(this.d.length){this.d[0]=b;this._down(0);} return t; }
                get size(){ return this.d.length; }
                _up(i){ while(i>0){const p=(i-1)>>1; if(this.d[p][0]<=this.d[i][0])break; [this.d[p],this.d[i]]=[this.d[i],this.d[p]]; i=p;} }
                _down(i){ const n=this.d.length; while(true){ let s=i,l=2*i+1,r=2*i+2; if(l<n&&this.d[l][0]<this.d[s][0])s=l; if(r<n&&this.d[r][0]<this.d[s][0])s=r; if(s===i)break; [this.d[s],this.d[i]]=[this.d[i],this.d[s]]; i=s; } }
            }
            const dirs = [[-1,0],[1,0],[0,-1],[0,1]];
            const cameFrom = new Map();
            const gScore   = new Map();
            const heap     = new Heap();
            const sh = heuristic(startTiles);
            heap.push([sh, 0, startTiles]);
            gScore.set(startStr, 0);
            cameFrom.set(startStr, {tiles: startTiles.slice(), parent: null});
            const CHUNK = 500, MAX_NODES = 500000;
            let totalNodes = 0;
            function reconstruct(endKey) {
                const path = [];
                let k = endKey;
                while(k !== null) { const e=cameFrom.get(k); if(!e) break; path.unshift(e.tiles); k=e.parent; }
                return path;
            }
            function processChunk() {
                let c = 0;
                while(heap.size > 0 && c < CHUNK && totalNodes < MAX_NODES) {
                    const [f,g,cur] = heap.pop();
                    const curKey = cur.join(',');
                    totalNodes++;
                    if(gScore.has(curKey) && gScore.get(curKey) < g) continue;
                    if(curKey === goalStr) {
                        sscSolSteps = reconstruct(curKey); sscSolStepIdx = 0;
                        sscRenderSolStep(0); setTimeout(()=>sscSolStartPlay(), 500); return;
                    }
                    const ei=cur.indexOf(0), er=Math.floor(ei/n), ec=ei%n;
                    for(const [dr,dc] of dirs){
                        const nr=er+dr, nc=ec+dc;
                        if(nr<0||nr>=n||nc<0||nc>=n) continue;
                        const ni=nr*n+nc;
                        const next=cur.slice(); [next[ei],next[ni]]=[next[ni],next[ei]];
                        const nextKey=next.join(',');
                        const ng = g+1;
                        if(!gScore.has(nextKey) || ng < gScore.get(nextKey)){
                            gScore.set(nextKey, ng);
                            cameFrom.set(nextKey, {tiles: next.slice(), parent: curKey});
                            heap.push([ng + heuristic(next), ng, next]);
                        }
                    }
                    c++;
                }
                if(heap.size === 0 || totalNodes >= MAX_NODES) {
                    sscRenderSolBoard(goalArr, n, -1);
                    document.getElementById('sscSolMoveDesc').innerHTML = '<span style="color:#ef9a9a;font-size:.85em">âš ï¸ Puzzle too complex for instant solve â€” showing the goal state.</span>';
                    document.getElementById('sscSolStepCounter').textContent = 'N/A';
                    return;
                }
                setTimeout(processChunk, 0);
            }
            processChunk();

        } else {
            // -- IDA* for 15-puzzle and 24-puzzle ---------------------
            // IDA* is memory-efficient and can solve large puzzles
            const dirs = [[-1,0,'U'],[1,0,'D'],[0,-1,'L'],[0,1,'R']];
            const oppDir = {U:'D',D:'U',L:'R',R:'L'};
            let bound = heuristic(startTiles);
            let path  = [startTiles.slice()];
            let found = false;
            let totalIter = 0;
            const MAX_ITER = 8000000;
            // Limit solution depth to avoid infinite loops on unsolvable states
            const MAX_DEPTH = n <= 4 ? 100 : 150;

            function idaSearch(tiles, g, bound, lastDir) {
                const f = g + heuristic(tiles);
                if (f > bound) return f;
                if (tiles.join(',') === goalStr) { found = true; return -1; }
                if (g >= MAX_DEPTH) return Infinity;
                let minF = Infinity;
                const ei = tiles.indexOf(0);
                const er = Math.floor(ei/n), ec = ei%n;
                for (const [dr, dc, dName] of dirs) {
                    if (lastDir && dName === oppDir[lastDir]) continue; // no backtrack
                    const nr = er+dr, nc = ec+dc;
                    if (nr<0||nr>=n||nc<0||nc>=n) continue;
                    totalIter++;
                    if (totalIter > MAX_ITER) return Infinity;
                    const ni = nr*n+nc;
                    const next = tiles.slice();
                    [next[ei], next[ni]] = [next[ni], next[ei]];
                    path.push(next.slice());
                    const t = idaSearch(next, g+1, bound, dName);
                    if (found) return -1;
                    if (t < minF) minF = t;
                    path.pop();
                }
                return minF;
            }

            function runIDAChunk() {
                // Run one bound iteration per chunk
                totalIter = 0;
                path = [startTiles.slice()];
                found = false;
                const t = idaSearch(startTiles, 0, bound, null);
                if (found) {
                    sscSolSteps = path.map(s => s.slice());
                    sscSolStepIdx = 0;
                    sscRenderSolStep(0);
                    setTimeout(()=>sscSolStartPlay(), 500);
                    return;
                }
                if (t === Infinity || bound > MAX_DEPTH) {
                    // Too deeply shuffled â€” just show a message, do not display goal state
                    document.getElementById('sscSolMoveDesc').innerHTML =
                        '<span style="color:#ffe082;font-size:.85em">âš ï¸ This puzzle is too heavily shuffled to solve automatically. Please tap <strong>New Game</strong> for a fresh start!</span>';
                    document.getElementById('sscSolStepCounter').textContent = 'N/A';
                    return;
                }
                bound = t;
                // Update progress message
                document.getElementById('sscSolMoveDesc').innerHTML =
                    '<span style="color:rgba(255,255,255,.6);font-size:.88em">â³ Solvingâ€¦ exploring depth '+bound+' â€” please wait</span>';
                setTimeout(runIDAChunk, 0);
            }
            runIDAChunk();
        }
    }

    // -- RENDER SOL BOARD ----------------------------------------------
    function sscRenderSolBoard(tiles, n, highlightIdx) {
        const board = document.getElementById('sscSolBoard');
        const maxW = Math.min(320, (window.innerWidth * 0.85) - 40);
        const sz = Math.floor(maxW / n);
        board.style.gridTemplateColumns = 'repeat('+n+',1fr)';
        board.innerHTML = '';
        tiles.forEach((val, idx) => {
            const tile = document.createElement('div');
            const isEmpty = val === 0;
            const isHL = idx === highlightIdx;
            tile.style.width  = sz+'px';
            tile.style.height = sz+'px';
            tile.style.borderRadius = '5px';
            tile.style.transition = 'all .3s ease';
            if (isEmpty) {
                tile.style.background = 'rgba(196,69,105,.35)';
                tile.style.border = '2px dashed rgba(196,69,105,.6)';
                tile.style.background = 'linear-gradient(135deg,#ffe600,#ff8c00)';
                tile.style.display = 'flex';
                tile.style.alignItems = 'center';
                tile.style.justifyContent = 'center';
                tile.style.flexDirection = 'column';
                tile.style.color = '#3d0000';
                tile.style.fontSize = '0.75em';
                tile.style.fontWeight = '900';
                tile.style.letterSpacing = '1px';
                tile.style.border = '3px solid rgba(255,255,255,.6)';
                tile.style.animation = 'sscEmptyPulse 1.2s ease-in-out infinite';
                const solLogoEl = document.createElement('img');
                solLogoEl.src = 'davan_degree1.png';
                const solLogoSize = Math.floor(sz * 0.45);
                solLogoEl.style.cssText = `width:${solLogoSize}px;height:${solLogoSize}px;object-fit:contain;margin-bottom:2px;opacity:0.9;filter:drop-shadow(0 1px 3px rgba(0,0,0,.3))`;
                tile.appendChild(solLogoEl);
                const solEmptyIcon = document.createElement('div');
                solEmptyIcon.style.cssText = 'font-size:1.2em;margin-bottom:2px;animation:sscEmptyArrow 0.9s ease-in-out infinite';
                solEmptyIcon.textContent = 'ðŸ‘†';
                tile.appendChild(solEmptyIcon);
                const solEmptyLbl = document.createElement('div');
                solEmptyLbl.style.cssText = 'font-size:0.75em;font-weight:900;letter-spacing:1px;color:#3d0000';
                solEmptyLbl.textContent = 'EMPTY';
                tile.appendChild(solEmptyLbl);
            } else {
                tile.style.border = isHL
                    ? '3px solid #ffd54f'
                    : '1.5px solid rgba(255,255,255,.12)';
                if (isHL) tile.style.boxShadow = '0 0 14px rgba(255,213,79,.7)';
                const zv=val-1, col=zv%n, row=Math.floor(zv/n);
                tile.style.backgroundImage = 'url('+sscImageData+')';
                tile.style.backgroundSize = (sz*n)+'px '+(sz*n)+'px';
                tile.style.backgroundPosition = (-col*sz)+'px '+(-row*sz)+'px';
            }
            board.appendChild(tile);
        });
    }

    function sscRenderSolStep(idx) {
        if (!sscSolSteps.length) return;
        const tiles = sscSolSteps[idx];
        const n = sscSize;
        const total = sscSolSteps.length - 1;

        let movedTileIdx = -1;
        if (idx > 0) movedTileIdx = sscSolSteps[idx-1].indexOf(0);

        sscRenderSolBoard(tiles, n, movedTileIdx);

        // Counter
        document.getElementById('sscSolStepCounter').textContent =
            idx === 0 ? 'Start position' : ('Move '+idx+' / '+total);

        // Description
        let desc = '';
        if (idx === 0) {
            desc = `<span style="color:rgba(255,255,255,.75);font-size:.87em">ðŸ“ <strong style="color:#ffd54f">Starting position</strong> â€” ${total} moves needed to solve</span>`;
        } else if (idx >= total) {
            desc = `<span style="color:#a5d6a7;font-size:.87em">âœ… <strong>That's how it's done!</strong> Only ${total} moves needed â€” try again and beat it!</span>`;
        } else {
            const prev = sscSolSteps[idx-1], cur = sscSolSteps[idx];
            const prevEi = prev.indexOf(0), curEi = cur.indexOf(0);
            const dr = Math.floor(curEi/n) - Math.floor(prevEi/n);
            const dc = curEi%n - prevEi%n;
            const dirMap = {'-10':'slide tile â†“ Down','10':'slide tile â†‘ Up','0-1':'slide tile â†’ Right','01':'slide tile â† Left'};
            const dirStr = dirMap[''+dr+dc] || 'slide tile';
            const tileVal = cur[prevEi];
            desc = `<span style="color:rgba(255,255,255,.8);font-size:.87em">Move <strong style="color:#ffd54f">${idx}</strong> of ${total} â€” <strong style="color:#ce93d8">${dirStr}</strong></span>`;
        }
        document.getElementById('sscSolMoveDesc').innerHTML = desc;
    }

    function sscSolPlayPause() {
        if (sscSolPlaying) {
            sscSolPlaying = false;
            clearInterval(sscSolAutoRef);
            document.getElementById('sscSolPlayBtn').textContent = 'â–¶ Play';
        } else {
            if (sscSolStepIdx >= sscSolSteps.length - 1) sscSolStepIdx = 0;
            sscSolStartPlay();
        }
    }

    function sscSolStartPlay() {
        if (!sscSolSteps.length) return;
        sscSolPlaying = true;
        document.getElementById('sscSolPlayBtn').textContent = 'â¸ Pause';
        clearInterval(sscSolAutoRef);
        const delay = sscSize <= 3 ? 650 : (sscSize <= 4 ? 480 : 320);
        sscSolAutoRef = setInterval(() => {
            if (sscSolStepIdx < sscSolSteps.length - 1) {
                sscSolStepIdx++;
                sscRenderSolStep(sscSolStepIdx);
            } else {
                clearInterval(sscSolAutoRef);
                sscSolPlaying = false;
                document.getElementById('sscSolPlayBtn').textContent = 'â†º Replay';
            }
        }, delay);
    }

    function sscSolStepBack() {
        clearInterval(sscSolAutoRef); sscSolPlaying = false;
        document.getElementById('sscSolPlayBtn').textContent = 'â–¶ Play';
        if (sscSolStepIdx > 0) { sscSolStepIdx--; sscRenderSolStep(sscSolStepIdx); }
    }

    function sscSolStepFwd() {
        clearInterval(sscSolAutoRef); sscSolPlaying = false;
        document.getElementById('sscSolPlayBtn').textContent = 'â–¶ Play';
        if (sscSolStepIdx < sscSolSteps.length - 1) { sscSolStepIdx++; sscRenderSolStep(sscSolStepIdx); }
    }

    // -- RESET ----------------------------------------------------------
    function sscResetGame() {
        clearInterval(sscTimerRef);
        clearInterval(sscSolAutoRef);
        sscSolPlaying = false;
        sscSolSteps = [];
        sscSolStepIdx = 0;
        sscSolved = false; sscSolDisabled = false; sscImageData = null; sscImageHash = null;
        document.getElementById('sscWinModal').style.display     = 'none';
        document.getElementById('sscGameOverModal').style.display = 'none';
        document.getElementById('sscGameArea').style.display  = 'none';
        document.getElementById('sscSetupCard').style.display = 'block';
        // Reset touch block flags so they re-attach on next game
        const board2 = document.getElementById('sscPuzzleBoard');
        const gameArea2 = document.getElementById('sscGameArea');
        if (board2) board2._touchBlocked = false;
        if (gameArea2) gameArea2._touchBlocked = false;
        const fallback = document.getElementById('sscMarkCompleteSection');
        if (fallback) fallback.style.display = 'none';
        document.getElementById('sscPreviewThumb').style.display = 'none';
        document.getElementById('sscUploadZone').style.background  = '#faf0ff';
        document.getElementById('sscUploadZone').style.borderColor = '#9c27b0';
        document.getElementById('sscImgInput').value = '';
        sscCheckReady();
        sscScrollTop();
    }

    // -- LEADERBOARD ----------------------------------------------------
    async function sscLoadLB() {
        document.getElementById('sscLbContainer').innerHTML = '<p style="color:#aaa;text-align:center;padding:30px">Loadingâ€¦</p>';
        try {
            const snap = await window.db.ref('speedSlide/submissions').once('value');
            let data = [];
            snap.forEach(c => { const v=c.val(); if(v.status==='approved') data.push(v); });
            data.sort((a,b) => {
                if (b.points!==a.points) return b.points-a.points;
                if (a.timeSec!==b.timeSec) return a.timeSec-b.timeSec;
                return a.moves-b.moves;
            });
            const diff = sscLbDiff;
            let rows = diff==='all' ? data : data.filter(r=>r.difficulty===diff);
            const seen = new Set();
            rows = rows.filter(r => {
                const k=(r.uid||r.phone)+'|'+r.difficulty;
                if(seen.has(k)) return false; seen.add(k); return true;
            });
            if (!rows.length) {
                document.getElementById('sscLbContainer').innerHTML = '<p style="color:#aaa;text-align:center;padding:30px">No approved scores yet for this category.</p>';
                return;
            }
            const medals = ['ðŸ¥‡','ðŸ¥ˆ','ðŸ¥‰'];
            const dLabel = {easy:'ðŸ˜Š 8-Puzzle',medium:'ðŸ˜… 15-Puzzle',hard:'ðŸ”¥ 24-Puzzle'};
            document.getElementById('sscLbContainer').innerHTML = rows.map((r,i) => `
                <div style="display:grid;grid-template-columns:44px 1fr auto auto;gap:10px;align-items:center;padding:12px 16px;border-radius:10px;background:white;margin-bottom:8px;box-shadow:0 2px 8px rgba(0,0,0,.07)">
                    <div style="font-size:1.4em;text-align:center">${medals[i]||'#'+(i+1)}</div>
                    <div>
                        <div style="font-weight:700">${sscEsc(r.name)}</div>
                        <div style="color:#888;font-size:.82em">${sscEsc(r.class||'')} Â· ${r.date||''} Â· ${dLabel[r.difficulty]||r.difficulty}</div>
                    </div>
                    <div style="color:#e65100;font-weight:700;font-size:.88em">â± ${sscFmtTime(r.timeSec)} Â· ðŸŽ¯ ${r.moves}</div>
                    <div style="color:#6a1b9a;font-weight:800;font-size:1.05em">â­${r.points}</div>
                </div>`).join('');
        } catch(e) {
            document.getElementById('sscLbContainer').innerHTML = '<p style="color:red">Error: '+e.message+'</p>';
        }
    }

    function sscSwitchLB(d) {
        sscLbDiff = d;
        ['easy','medium','hard','all'].forEach(x => {
            const el = document.getElementById('ssclbt-'+x);
            if (el) el.classList.toggle('active', x===d);
        });
        sscLoadLB();
    }

    // -- CONFETTI -------------------------------------------------------
    function sscLaunchConfetti() {
        const colors = ['#c44569','#6a1b9a','#ffd700','#28a745','#ff9800','#2196F3','#e91e63','#00bcd4'];
        // Big confetti shower
        for (let i=0; i<100; i++) {
            const el = document.createElement('div');
            el.style.cssText = 'position:fixed;z-index:99999;border-radius:2px;pointer-events:none';
            el.style.left    = Math.random()*100+'vw';
            el.style.top     = '-20px';
            el.style.background = colors[Math.floor(Math.random()*colors.length)];
            el.style.width   = (6+Math.random()*10)+'px';
            el.style.height  = (6+Math.random()*10)+'px';
            el.style.animation = `confetti ${2+Math.random()}s ease-out forwards`;
            el.style.animationDelay = Math.random()*1.8+'s';
            document.body.appendChild(el);
            setTimeout(()=>el.remove(), 4500);
        }
        // Floating emoji burst inside the modal
        const burst = document.getElementById('sscWinEmojiBurst');
        if (burst) {
            const emojis = ['ðŸŽ‰','ðŸŽŠ','â­','ðŸ†','âœ¨','ðŸ¥³','ðŸŽˆ','ðŸ’«','ðŸŒŸ','ðŸ‘'];
            for(let i=0;i<18;i++){
                const e=document.createElement('span');
                e.textContent = emojis[Math.floor(Math.random()*emojis.length)];
                e.style.cssText = `position:absolute;font-size:${1.2+Math.random()*1.4}em;
                    left:${5+Math.random()*90}%;bottom:10%;
                    animation:sscEmojiFloat ${1.2+Math.random()*1}s ease-out ${Math.random()*0.8}s both;
                    pointer-events:none;`;
                burst.appendChild(e);
                setTimeout(()=>e.remove(), 3000);
            }
        }
    }

    function sscLaunchBoo() {
        const burst = document.getElementById('sscBooEmojiBurst');
        if (!burst) return;
        const emojis = ['ðŸ‘Ž','ðŸ˜¤','ðŸ’€','ðŸ˜¬','ðŸ™ˆ','ðŸ˜©','ðŸ‘Ž','ðŸ’”','ðŸ˜¤','ðŸ¤¦'];
        for(let i=0;i<14;i++){
            const e=document.createElement('span');
            e.textContent = emojis[Math.floor(Math.random()*emojis.length)];
            e.style.cssText = `position:absolute;font-size:${1+Math.random()*1.2}em;
                left:${5+Math.random()*90}%;top:5%;
                animation:sscBooDrop ${0.9+Math.random()*0.8}s ease-in ${Math.random()*0.6}s both;
                pointer-events:none;`;
            burst.appendChild(e);
            setTimeout(()=>e.remove(), 2500);
        }
    }

    // -- HELPERS --------------------------------------------------------
    function sscFmtTime(sec) {
        if (!sec && sec!==0) return 'â€”';
        return Math.floor(sec/60)+':'+(sec%60).toString().padStart(2,'0');
    }
    function sscEsc(s) {
        if (!s) return '';
        return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
    }

    // window.storage is initialized alongside window.db in the main script block above

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // ðŸ” DATABASE INSPECTOR â€” Super Admin Tool
    // Scans entire Firebase Realtime Database for base64 data & large fields
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    let dbiReportData = [];

    async function dbiRunScan() {
        const btn = document.getElementById('dbi-scan-btn');
        btn.disabled = true;
        btn.textContent = 'â³ Scanningâ€¦';
        dbiReportData = [];

        // Reset UI
        document.getElementById('dbi-alert').style.display = 'none';
        document.getElementById('dbi-results').style.display = 'none';
        document.getElementById('dbi-dl-btn').style.display = 'none';
        document.getElementById('dbi-table-body').innerHTML = '';
        document.getElementById('dbi-node-tree').innerHTML = '<p style="color:#888">Loadingâ€¦</p>';
        document.getElementById('dbi-total-nodes').textContent = 'â€¦';
        document.getElementById('dbi-b64-count').textContent = 'â€¦';
        document.getElementById('dbi-total-size').textContent = 'â€¦';
        document.getElementById('dbi-b64-size').textContent = 'â€¦';

        // Show progress
        const pw = document.getElementById('dbi-progress-wrap');
        const pb = document.getElementById('dbi-progress-bar');
        const pl = document.getElementById('dbi-progress-label');
        pw.style.display = 'block';
        pb.style.width = '10%';
        pl.textContent = 'Fetching database rootâ€¦';

        try {
            const db = getDb();
            const snapshot = await db.ref('/').once('value');
            pb.style.width = '50%';
            pl.textContent = 'Analyzing dataâ€¦';

            const root = snapshot.val();
            if (!root) {
                dbiShowAlert('âš ï¸ Database is empty or could not be read.', '#ffc107', '#856404');
                btn.disabled = false;
                btn.textContent = 'ðŸ” Scan Database Now';
                pw.style.display = 'none';
                return;
            }

            const fullJson = JSON.stringify(root);
            const totalSizeBytes = new Blob([fullJson]).size;

            // Walk the tree
            let totalNodes = 0;
            let b64Entries = [];
            let b64TotalBytes = 0;
            let nodeTree = {}; // top-level node â†’ size in bytes

            function walkNode(obj, path) {
                if (obj === null || obj === undefined) return;
                if (typeof obj !== 'object') {
                    totalNodes++;
                    const strVal = String(obj);
                    const sizeBytes = new Blob([strVal]).size;

                    // Detect base64 patterns
                    const b64Regex = /^data:[a-z]+\/[a-z+.-]+;base64,/i;
                    const rawB64Regex = /^[A-Za-z0-9+/]{100,}={0,2}$/;
                    let type = null;
                    if (b64Regex.test(strVal)) {
                        // Extract MIME type
                        const mime = strVal.match(/data:([^;]+);base64,/);
                        type = mime ? mime[1] : 'base64 (with header)';
                    } else if (rawB64Regex.test(strVal) && sizeBytes > 1000) {
                        type = 'raw base64 (no header)';
                    }

                    if (type) {
                        b64TotalBytes += sizeBytes;
                        const pathParts = path.split('/');
                        const fieldKey = pathParts[pathParts.length - 1];
                        const parentPath = pathParts.slice(0, -1).join('/') || '/';
                        b64Entries.push({
                            path: parentPath,
                            key: fieldKey,
                            type: type,
                            sizeBytes: sizeBytes,
                            preview: strVal.substring(0, 60) + 'â€¦'
                        });
                    }
                    return;
                }
                Object.keys(obj).forEach(key => {
                    walkNode(obj[key], path ? path + '/' + key : key);
                });
            }

            // Count top-level node sizes
            Object.keys(root).forEach(topKey => {
                const nodeJson = JSON.stringify(root[topKey]);
                nodeTree[topKey] = new Blob([nodeJson]).size;
            });

            pb.style.width = '75%';
            pl.textContent = 'Walking nodesâ€¦';

            walkNode(root, '');

            // Count total nodes (including objects)
            function countAllNodes(obj) {
                if (obj === null || typeof obj !== 'object') return 1;
                return 1 + Object.keys(obj).reduce((s, k) => s + countAllNodes(obj[k]), 0);
            }
            totalNodes = countAllNodes(root);

            pb.style.width = '100%';
            pl.textContent = 'Done!';

            // Update summary cards
            document.getElementById('dbi-total-nodes').textContent = totalNodes.toLocaleString();
            document.getElementById('dbi-b64-count').textContent = b64Entries.length;
            document.getElementById('dbi-total-size').textContent = dbiFormatSize(totalSizeBytes);
            document.getElementById('dbi-b64-size').textContent = dbiFormatSize(b64TotalBytes);

            // Alert
            if (b64Entries.length === 0) {
                dbiShowAlert('âœ… Great news! No base64 data found in your Firebase database. Your DB is clean.', '#d4edda', '#155724');
            } else {
                dbiShowAlert(`ðŸš¨ Found ${b64Entries.length} base64 field(s) using ${dbiFormatSize(b64TotalBytes)} of storage. Consider moving images to Firebase Storage instead.`, '#f8d7da', '#721c24');
            }

            // Fill results table
            if (b64Entries.length > 0) {
                dbiReportData = b64Entries;
                const tbody = document.getElementById('dbi-table-body');
                tbody.innerHTML = b64Entries.map((e, i) => `
                    <tr style="background:${i%2===0?'#fff':'#fdf5ff'};border-bottom:1px solid #eee">
                        <td style="padding:8px 12px;color:#999;font-size:.8em">${i+1}</td>
                        <td style="padding:8px 12px;font-family:monospace;font-size:.78em;color:#6a1b9a;word-break:break-all">${dbiEsc(e.path)}</td>
                        <td style="padding:8px 12px;font-family:monospace;font-size:.82em;font-weight:700;color:#c44569">${dbiEsc(e.key)}</td>
                        <td style="padding:8px 12px"><span style="background:#fff3cd;color:#856404;padding:2px 8px;border-radius:12px;font-size:.78em;font-weight:600">${dbiEsc(e.type)}</span></td>
                        <td style="padding:8px 12px;font-weight:700;color:${e.sizeBytes>100000?'#dc3545':'#e65100'}">${dbiFormatSize(e.sizeBytes)}</td>
                        <td style="padding:8px 12px;font-family:monospace;font-size:.72em;color:#555;word-break:break-all;max-width:200px">${dbiEsc(e.preview)}</td>
                    </tr>
                `).join('');
                document.getElementById('dbi-results-note').textContent = `Showing all ${b64Entries.length} base64 field(s) found in the database.`;
                document.getElementById('dbi-results').style.display = 'block';
                document.getElementById('dbi-dl-btn').style.display = 'inline-block';
            }

            // Node tree
            const sortedNodes = Object.entries(nodeTree).sort((a, b) => b[1] - a[1]);
            const maxSize = sortedNodes[0]?.[1] || 1;
            document.getElementById('dbi-node-tree').innerHTML = sortedNodes.map(([key, size]) => {
                const pct = Math.max(2, Math.round((size / maxSize) * 100));
                const color = size > 500000 ? '#f5576c' : size > 100000 ? '#f093fb' : size > 10000 ? '#667eea' : '#43e97b';
                return `
                <div style="margin-bottom:10px">
                    <div style="display:flex;justify-content:space-between;margin-bottom:3px">
                        <span style="font-family:monospace;font-weight:700;color:#333">/${dbiEsc(key)}</span>
                        <span style="color:#888;font-size:.82em">${dbiFormatSize(size)}</span>
                    </div>
                    <div style="background:#e0e0e0;border-radius:20px;height:8px;overflow:hidden">
                        <div style="background:${color};height:100%;width:${pct}%;border-radius:20px;transition:width .5s ease"></div>
                    </div>
                </div>`;
            }).join('') || '<p style="color:#888">No top-level nodes found.</p>';

            setTimeout(() => { pw.style.display = 'none'; }, 800);

        } catch(err) {
            dbiShowAlert('âŒ Error scanning database: ' + err.message + '. Check your Firebase rules allow Super Admin reads.', '#f8d7da', '#721c24');
            pw.style.display = 'none';
        }

        btn.disabled = false;
        btn.textContent = 'ðŸ” Scan Database Now';
    }

    function dbiShowAlert(msg, bg, color) {
        const el = document.getElementById('dbi-alert');
        el.style.display = 'block';
        el.style.background = bg;
        el.style.color = color;
        el.style.border = '1.5px solid ' + color;
        el.textContent = msg;
    }

    function dbiClearResults() {
        document.getElementById('dbi-alert').style.display = 'none';
        document.getElementById('dbi-results').style.display = 'none';
        document.getElementById('dbi-dl-btn').style.display = 'none';
        document.getElementById('dbi-table-body').innerHTML = '';
        document.getElementById('dbi-node-tree').innerHTML = 'Run a scan to see node sizes.';
        document.getElementById('dbi-total-nodes').textContent = 'â€”';
        document.getElementById('dbi-b64-count').textContent = 'â€”';
        document.getElementById('dbi-total-size').textContent = 'â€”';
        document.getElementById('dbi-b64-size').textContent = 'â€”';
        dbiReportData = [];
    }

    function dbiDownloadReport() {
        if (!dbiReportData.length) return;
        const rows = [['#','Path','Field Key','Type','Size (bytes)','Preview']];
        dbiReportData.forEach((e,i) => {
            rows.push([i+1, e.path, e.key, e.type, e.sizeBytes, e.preview.replace(/,/g,'')]);
        });
        const csv = rows.map(r => r.map(c => '"'+String(c).replace(/"/g,'""')+'"').join(',')).join('\n');
        const blob = new Blob([csv], {type:'text/csv'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'spurthi_db_inspector_' + new Date().toISOString().slice(0,10) + '.csv';
        a.click();
        URL.revokeObjectURL(url);
    }

    function dbiFormatSize(bytes) {
        if (bytes < 1024) return bytes + ' B';
        if (bytes < 1048576) return (bytes/1024).toFixed(1) + ' KB';
        return (bytes/1048576).toFixed(2) + ' MB';
    }

    function dbiEsc(s) {
        if (!s) return '';
        return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
    }
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // END DB INSPECTOR
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // â˜ï¸ CLOUDINARY INSPECTOR â€” Dual Mode (Manual Logger + Live Proxy)
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    const CLD_HISTORY_KEY  = 'spurthi_cld_history';
    const CLD_WORKER_KEY   = 'spurthi_cld_worker_url';

    // -- Mode switcher ---------------------------------------------------------
    function cldSwitchMode(mode) {
        const isManual = (mode === 'manual');
        document.getElementById('cld-panel-manual').style.display = isManual ? 'block' : 'none';
        document.getElementById('cld-panel-live').style.display   = isManual ? 'none'  : 'block';
        document.getElementById('cld-mode-manual-btn').style.background = isManual
            ? 'linear-gradient(135deg,#6a1b9a,#c44569)' : '#f3e8ff';
        document.getElementById('cld-mode-manual-btn').style.color = isManual ? 'white' : '#6a1b9a';
        document.getElementById('cld-mode-live-btn').style.background = isManual
            ? '#f3e8ff' : 'linear-gradient(135deg,#f7971e,#ffd200)';
        document.getElementById('cld-mode-live-btn').style.color = isManual ? '#6a1b9a' : '#333';
    }

    // â”€â”€ Quiz Submissions Date-Wise Cleanup â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    let qscDays = {}; // { dateKey: { count, resultsSaved, sizeEst } }

    async function qsCleanupLoad() {
        const btn = document.getElementById('qsc-load-btn');
        const tbody = document.getElementById('qsc-tbody');
        const wrap = document.getElementById('qsc-table-wrap');
        const delBtn = document.getElementById('qsc-del-btn');
        btn.disabled = true; btn.textContent = 'â³ Loadingâ€¦';
        qscShowAlert('', '');
        qscDays = {};

        try {
            const [subSnap, resSnap] = await Promise.all([
                db.ref('quizSubmissions').once('value'),
                db.ref('quizResults').once('value')
            ]);
            // Normalize all result keys to dashes format (2026-02-24)
            // so they match regardless of whether stored with dashes or underscores
            const resultDates = new Set();
            const resultData  = {}; // normalized key -> result object
            if (resSnap.exists()) resSnap.forEach(ch => {
                const normKey = ch.key.replace(/_/g, '-');
                resultDates.add(normKey);
                resultDates.add(ch.key.replace(/-/g, '_'));
                resultDates.add(ch.key);
                resultData[normKey] = ch.val();
            });

            if (!subSnap.exists()) {
                qscShowAlert('âœ… No quiz submissions found â€” nothing to delete!', '#d4edda', '#155724');
                btn.disabled = false; btn.textContent = 'ðŸ“‚ Load Submission Days';
                return;
            }

            subSnap.forEach(daySnap => {
                const dateKey = daySnap.key;
                let count = 0;
                let sizeEst = 0;
                daySnap.forEach(sub => {
                    count++;
                    sizeEst += JSON.stringify(sub.val()).length;
                });
                // Normalize dateKey to dashes for comparison
                const normalizedKey = dateKey.replace(/_/g, '-');
                const resultObj = resultData[normalizedKey] || null;
                qscDays[dateKey] = {
                    count,
                    sizeEst,
                    resultsSaved: !!(resultDates.has(normalizedKey) || resultDates.has(dateKey)),
                    resultObj
                };
            });

            const sortedDates = Object.keys(qscDays).sort();
            let totalSize = 0;
            tbody.innerHTML = sortedDates.map(dk => {
                const d = qscDays[dk];
                totalSize += d.sizeEst;
                const displayDate = qscFormatDate(dk);
                const sizeLabel = d.sizeEst > 1024 ? (d.sizeEst / 1024).toFixed(1) + ' KB' : d.sizeEst + ' B';
                const safe = d.resultsSaved;
                const r = d.resultObj;
                let winnerHtml = '<span style="color:#bbb;font-size:.8em">â€”</span>';
                if (r && r.winner) {
                    const declDate = r.declaredAt ? new Date(r.declaredAt).toLocaleString('en-IN',{day:'2-digit',month:'short',hour:'2-digit',minute:'2-digit'}) : '';
                    winnerHtml = `<div style="font-size:.82em;line-height:1.7">
                        <div><span style="font-size:1em">ðŸ¥‡</span> <strong style="color:#1565c0">${r.winner.name}</strong> <span style="color:#888">(${r.winner.class})</span> <span style="background:#fff3cd;color:#856404;padding:1px 6px;border-radius:8px;font-size:.78em">${r.winner.score}/2</span></div>
                        ${r.runnerUp ? `<div><span style="font-size:1em">ðŸ¥ˆ</span> <strong style="color:#6a1b9a">${r.runnerUp.name}</strong> <span style="color:#888">(${r.runnerUp.class})</span> <span style="background:#e8f5e9;color:#1b5e20;padding:1px 6px;border-radius:8px;font-size:.78em">${r.runnerUp.score}/2</span></div>` : ''}
                        ${declDate ? `<div style="color:#aaa;font-size:.75em">ðŸ“… Declared: ${declDate}</div>` : ''}
                    </div>`;
                }
                return `<tr style="border-bottom:1px solid #f0f0f0;background:${safe ? '#fff' : '#fff8e1'}">
                    <td style="padding:9px 12px;text-align:center">
                        <input type="checkbox" class="qsc-chk" data-key="${dk}" ${safe ? '' : 'disabled title="Results not saved yet â€” unsafe to delete"'}
                               style="width:16px;height:16px;cursor:${safe ? 'pointer' : 'not-allowed'}">
                    </td>
                    <td style="padding:9px 12px;font-weight:700;color:#333">${displayDate}</td>
                    <td style="padding:9px 12px;text-align:center;color:#1565c0;font-weight:700">${d.count}</td>
                    <td style="padding:9px 12px;text-align:center;color:#6a1b9a;font-weight:600">${sizeLabel}</td>
                    <td style="padding:9px 12px;text-align:center">
                        ${safe
                            ? '<span style="background:#d4edda;color:#155724;padding:3px 10px;border-radius:12px;font-size:.82em;font-weight:700">âœ… Saved</span>'
                            : '<span style="background:#fff3cd;color:#856404;padding:3px 10px;border-radius:12px;font-size:.82em;font-weight:700">âš ï¸ Not Saved</span>'}
                    </td>
                    <td style="padding:9px 14px">${winnerHtml}</td>
                </tr>`;
            }).join('');

            const totalLabel = document.getElementById('qsc-total-label');
            const totalKB = (totalSize / 1024).toFixed(1);
            totalLabel.textContent = `Total quizSubmissions size: ~${totalKB} KB across ${sortedDates.length} day(s)`;

            wrap.style.display = 'block';
            delBtn.style.display = 'inline-block';
            qscShowAlert(`ðŸ“‚ Found ${sortedDates.length} submission day(s). Safe days (âœ…) can be deleted without affecting winners or leaderboard.`, '#d4edda', '#155724');

        } catch(err) {
            qscShowAlert('âŒ Error loading: ' + err.message, '#f8d7da', '#721c24');
        }
        btn.disabled = false; btn.textContent = 'ðŸ”„ Refresh';
    }

    function qscFormatDate(dk) {
        // dateKey format: "2026-02-24" or "2026_02_24"
        const normalized = dk.replace(/_/g, '-');
        const d = new Date(normalized + 'T00:00:00');
        if (isNaN(d)) return dk;
        return d.toLocaleDateString('en-IN', { weekday:'short', day:'2-digit', month:'short', year:'numeric' });
    }

    function qsCleanupSelectAll() {
        document.querySelectorAll('.qsc-chk:not([disabled])').forEach(chk => chk.checked = true);
    }

    async function qsCleanupDeleteSelected() {
        const checked = [...document.querySelectorAll('.qsc-chk:checked')];
        if (!checked.length) {
            qscShowAlert('âš ï¸ No days selected. Check the boxes next to the days you want to delete.', '#fff3cd', '#856404');
            return;
        }
        const keys = checked.map(c => c.dataset.key);
        const totalEntries = keys.reduce((s, k) => s + (qscDays[k]?.count || 0), 0);
        const totalKB = (keys.reduce((s, k) => s + (qscDays[k]?.sizeEst || 0), 0) / 1024).toFixed(1);
        const confirmed = confirm(
            `ðŸ—‘ï¸ DELETE QUIZ SUBMISSIONS\n\n` +
            `You are about to delete submissions for ${keys.length} day(s):\n` +
            keys.map(k => `â€¢ ${qscFormatDate(k)} (${qscDays[k]?.count} entries)`).join('\n') +
            `\n\nTotal: ${totalEntries} submissions (~${totalKB} KB)\n\n` +
            `âœ… Winners & leaderboard (quizResults) will NOT be affected.\n\n` +
            `This cannot be undone. Continue?`
        );
        if (!confirmed) return;

        const delBtn = document.getElementById('qsc-del-btn');
        delBtn.disabled = true; delBtn.textContent = 'â³ Deletingâ€¦';

        try {
            const updates = {};
            keys.forEach(k => { updates['quizSubmissions/' + k] = null; });
            await db.ref().update(updates);
            qscShowAlert(`âœ… Successfully deleted ${keys.length} day(s) â€” ${totalEntries} submissions removed (~${totalKB} KB freed). Reload to refresh sizes.`, '#d4edda', '#155724');
            // Remove deleted rows
            keys.forEach(k => {
                const chk = document.querySelector(`.qsc-chk[data-key="${k}"]`);
                if (chk) chk.closest('tr').remove();
                delete qscDays[k];
            });
        } catch(err) {
            qscShowAlert('âŒ Delete failed: ' + err.message, '#f8d7da', '#721c24');
        }
        delBtn.disabled = false; delBtn.textContent = 'ðŸ—‘ï¸ Delete Selected Days';
    }

    function qscShowAlert(msg, bg, color) {
        const el = document.getElementById('qsc-alert');
        if (!msg) { el.style.display = 'none'; return; }
        el.style.display = 'block';
        el.style.background = bg || '#fff3cd';
        el.style.color = color || '#856404';
        el.innerHTML = msg;
    }

    // -- Helpers ---------------------------------------------------------------
    function cldFmtMB(mb) {
        if (!mb && mb !== 0) return 'â€”';
        if (mb >= 1024) return (mb / 1024).toFixed(2) + ' GB';
        return mb.toFixed(1) + ' MB';
    }
    function cldFmtBytes(bytes) {
        if (!bytes || bytes === 0) return '0 B';
        const gb = bytes / 1073741824;
        if (gb >= 1) return gb.toFixed(2) + ' GB';
        const mb = bytes / 1048576;
        if (mb >= 1) return mb.toFixed(1) + ' MB';
        return (bytes / 1024).toFixed(0) + ' KB';
    }
    function cldBarColor(pct) {
        return pct > 90 ? 'linear-gradient(90deg,#f5576c,#c44569)'
             : pct > 70 ? 'linear-gradient(90deg,#f7971e,#ffd200)'
             :             'linear-gradient(90deg,#43e97b,#38f9d7)';
    }
    function cldAlert(id, msg, bg, color) {
        const el = document.getElementById(id);
        el.style.display = 'block'; el.style.background = bg;
        el.style.color = color; el.style.border = '1.5px solid ' + color;
        el.textContent = msg;
    }

    // â•â• OPTION A â€” MANUAL LOGGER â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    function cldmLoadHistory() {
        try { return JSON.parse(localStorage.getItem(CLD_HISTORY_KEY) || '[]'); }
        catch(e) { return []; }
    }
    function cldmSaveHistory(h) { localStorage.setItem(CLD_HISTORY_KEY, JSON.stringify(h)); }

    function cldmSave() {
        const sUsed  = parseFloat(document.getElementById('cldm-storage-used').value);
        const sLimit = parseFloat(document.getElementById('cldm-storage-limit').value);
        const bUsed  = parseFloat(document.getElementById('cldm-bw-used').value);
        const bLimit = parseFloat(document.getElementById('cldm-bw-limit').value);
        const assets = parseInt(document.getElementById('cldm-assets').value) || 0;
        const date   = document.getElementById('cldm-date').value || new Date().toISOString().slice(0,10);

        if (isNaN(sUsed) || isNaN(sLimit) || isNaN(bUsed) || isNaN(bLimit)) {
            cldAlert('cldm-alert', 'âš ï¸ Please fill in all storage and bandwidth fields.', '#fff3cd', '#856404');
            return;
        }

        const entry = { date, sUsed, sLimit, bUsed, bLimit, assets };
        const history = cldmLoadHistory();
        const idx = history.findIndex(e => e.date === date);
        if (idx >= 0) history[idx] = entry; else history.push(entry);
        cldmSaveHistory(history);
        cldmRender(entry);

        // Clear inputs
        ['cldm-storage-used','cldm-storage-limit','cldm-bw-used','cldm-bw-limit','cldm-assets'].forEach(id => {
            document.getElementById(id).value = '';
        });
        document.getElementById('cldm-date').value = new Date().toISOString().slice(0,10);
    }

    function cldmRender(entry) {
        if (!entry) return;
        const sPct = entry.sLimit > 0 ? Math.min(100, Math.round((entry.sUsed / entry.sLimit) * 100)) : 0;
        const bPct = entry.bLimit > 0 ? Math.min(100, Math.round((entry.bUsed / entry.bLimit) * 100)) : 0;

        document.getElementById('cldm-card-storage-used').textContent  = cldFmtMB(entry.sUsed);
        document.getElementById('cldm-card-storage-limit').textContent = cldFmtMB(entry.sLimit);
        document.getElementById('cldm-card-bw-used').textContent       = cldFmtMB(entry.bUsed);
        document.getElementById('cldm-card-bw-limit').textContent      = cldFmtMB(entry.bLimit);
        document.getElementById('cldm-card-assets').textContent        = entry.assets.toLocaleString();
        document.getElementById('cldm-card-date').textContent          = entry.date;

        const sBar = document.getElementById('cldm-storage-bar');
        sBar.style.width = sPct + '%'; sBar.style.background = cldBarColor(sPct);
        document.getElementById('cldm-storage-pct-lbl').textContent = `${sPct}% of ${cldFmtMB(entry.sLimit)} used`;

        const bBar = document.getElementById('cldm-bw-bar');
        bBar.style.width = bPct + '%'; bBar.style.background = cldBarColor(bPct);
        document.getElementById('cldm-bw-pct-lbl').textContent = `${bPct}% of ${cldFmtMB(entry.bLimit)} used`;

        document.getElementById('cldm-cards').style.display = 'block';

        if (sPct > 90 || bPct > 90) {
            cldAlert('cldm-alert', `ðŸš¨ Warning: ${sPct > 90 ? 'Storage' : 'Bandwidth'} is over 90% of limit!`, '#f8d7da', '#721c24');
        } else {
            cldAlert('cldm-alert', `âœ… Data saved! Storage: ${sPct}% used | Bandwidth: ${bPct}% used`, '#d4edda', '#155724');
        }

        cldmRenderHistory();
    }

    function cldmRenderHistory() {
        const history = cldmLoadHistory().sort((a,b) => b.date.localeCompare(a.date)).slice(0, 7);
        const tbody = document.getElementById('cldm-history-body');
        if (!history.length) {
            tbody.innerHTML = '<tr><td colspan="5" style="padding:14px;text-align:center;color:#aaa">No entries yet.</td></tr>';
            return;
        }
        tbody.innerHTML = history.map((e, i) => {
            const sPct = e.sLimit > 0 ? Math.min(100,(e.sUsed/e.sLimit*100)).toFixed(1) : 'â€”';
            const bPct = e.bLimit > 0 ? Math.min(100,(e.bUsed/e.bLimit*100)).toFixed(1) : 'â€”';
            return `<tr style="background:${i%2===0?'#fff':'#fdf5ff'};border-bottom:1px solid #eee">
                <td style="padding:8px 12px;font-weight:600;color:#333">${e.date}</td>
                <td style="padding:8px 12px;color:#f7971e;font-weight:700">${cldFmtMB(e.sUsed)} <span style="color:#aaa;font-size:.8em">/ ${cldFmtMB(e.sLimit)} (${sPct}%)</span></td>
                <td style="padding:8px 12px;color:#4facfe;font-weight:700">${cldFmtMB(e.bUsed)} <span style="color:#aaa;font-size:.8em">/ ${cldFmtMB(e.bLimit)} (${bPct}%)</span></td>
                <td style="padding:8px 12px;color:#667eea;font-weight:700">${e.assets.toLocaleString()}</td>
                <td style="padding:8px 12px"><button onclick="cldmDelete('${e.date}')" style="background:#f8d7da;color:#721c24;border:none;border-radius:6px;padding:3px 10px;cursor:pointer;font-size:.78em">ðŸ—‘ï¸</button></td>
            </tr>`;
        }).join('');
    }

    function cldmDelete(date) {
        if (!confirm('Delete entry for ' + date + '?')) return;
        cldmSaveHistory(cldmLoadHistory().filter(e => e.date !== date));
        cldmRenderHistory();
    }

    function cldmClearAll() {
        if (!confirm('Clear all Cloudinary history?')) return;
        cldmSaveHistory([]);
        document.getElementById('cldm-cards').style.display = 'none';
        document.getElementById('cldm-alert').style.display = 'none';
        cldmRenderHistory();
    }

    // â•â• OPTION B â€” LIVE CLOUDFLARE WORKER PROXY â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    function cldLiveClear() {
        document.getElementById('cld-live-results').style.display = 'none';
        document.getElementById('cld-live-alert').style.display = 'none';
        ['cld-storage','cld-storage-limit','cld-bandwidth','cld-bandwidth-limit','cld-resources','cld-plan'].forEach(id => {
            const el = document.getElementById(id); if (el) el.textContent = 'â€”';
        });
    }

    async function cldLiveFetch() {
        const workerUrl = document.getElementById('cld-worker-url').value.trim();
        if (!workerUrl) {
            cldAlert('cld-live-alert', 'âš ï¸ Please enter your Cloudflare Worker URL.', '#fff3cd', '#856404');
            return;
        }
        // Save worker URL for convenience
        localStorage.setItem(CLD_WORKER_KEY, workerUrl);

        const btn = document.getElementById('cld-live-btn');
        btn.disabled = true; btn.textContent = 'â³ Fetchingâ€¦';
        document.getElementById('cld-live-alert').style.display = 'none';

        const pw = document.getElementById('cld-live-progress-wrap');
        const pb = document.getElementById('cld-live-progress-bar');
        const pl = document.getElementById('cld-live-progress-label');
        pw.style.display = 'block'; pb.style.width = '20%'; pl.textContent = 'Connectingâ€¦';

        try {
            pb.style.width = '50%'; pl.textContent = 'Fetching from Cloudinary via Workerâ€¦';
            const resp = await fetch(workerUrl, { method: 'GET' });
            pb.style.width = '85%'; pl.textContent = 'Processingâ€¦';

            if (!resp.ok) throw new Error(`Worker returned HTTP ${resp.status}. Check your Worker URL and deployment.`);
            const data = await resp.json();

            pb.style.width = '100%'; pl.textContent = 'Done!';
            setTimeout(() => { pw.style.display = 'none'; }, 700);

            const storageUsed  = data.storage?.usage  || 0;
            const storageLimit = data.storage?.limit  || 0;
            const bwUsed       = data.bandwidth?.usage || 0;
            const bwLimit      = data.bandwidth?.limit || 0;
            const resources    = data.resources        || 0;
            const plan         = data.plan             || 'Unknown';

            document.getElementById('cld-storage').textContent         = cldFmtBytes(storageUsed);
            document.getElementById('cld-storage-limit').textContent   = cldFmtBytes(storageLimit);
            document.getElementById('cld-bandwidth').textContent       = cldFmtBytes(bwUsed);
            document.getElementById('cld-bandwidth-limit').textContent = cldFmtBytes(bwLimit);
            document.getElementById('cld-resources').textContent       = resources.toLocaleString();
            document.getElementById('cld-plan').textContent            = plan.charAt(0).toUpperCase() + plan.slice(1);

            const sPct = storageLimit > 0 ? Math.min(100, Math.round(storageUsed / storageLimit * 100)) : 0;
            const bPct = bwLimit > 0      ? Math.min(100, Math.round(bwUsed / bwLimit * 100)) : 0;

            const sBar = document.getElementById('cld-storage-bar');
            sBar.style.width = sPct + '%'; sBar.style.background = cldBarColor(sPct);
            document.getElementById('cld-storage-pct-label').textContent = `${sPct}% used`;

            const bBar = document.getElementById('cld-bandwidth-bar');
            bBar.style.width = bPct + '%'; bBar.style.background = cldBarColor(bPct);
            document.getElementById('cld-bandwidth-pct-label').textContent = `${bPct}% used`;

            // Asset breakdown
            const cats = [
                { label: 'ðŸ–¼ï¸ Images',    count: data.derived_resources || 0, color: '#667eea' },
                { label: 'ðŸŽ¬ Videos',    count: data.video?.usage || 0,      color: '#f093fb' },
                { label: 'ðŸ“¦ Raw Files', count: data.raw?.usage   || 0,      color: '#43e97b' },
                { label: 'ðŸ”„ Derived',   count: data.derived?.usage || 0,    color: '#4facfe' },
            ];
            document.getElementById('cld-asset-breakdown').innerHTML = cats.map(c =>
                `<div style="background:white;border-radius:8px;padding:10px 14px;text-align:center;border:1px solid #e0d0f0">
                    <div style="font-size:1.3em;font-weight:700;color:${c.color}">${c.count.toLocaleString()}</div>
                    <div style="font-size:.75em;color:#888">${c.label}</div>
                </div>`).join('');

            document.getElementById('cld-live-results').style.display = 'block';

            if (sPct > 90 || bPct > 90) {
                cldAlert('cld-live-alert', `ðŸš¨ Warning: ${sPct > 90 ? 'Storage' : 'Bandwidth'} is over 90% of limit!`, '#f8d7da', '#721c24');
            } else {
                cldAlert('cld-live-alert', `âœ… Live stats loaded! Storage: ${sPct}% | Bandwidth: ${bPct}%`, '#d4edda', '#155724');
            }

        } catch(err) {
            pw.style.display = 'none';
            let msg = err.message;
            if (msg.toLowerCase().includes('failed to fetch') || msg.toLowerCase().includes('network') || msg.toLowerCase().includes('cors')) {
                msg = 'âŒ Could not reach your Worker URL. Make sure: (1) you deployed the Worker, (2) the URL is correct, (3) your Worker code has Access-Control-Allow-Origin: *.';
            } else {
                msg = 'âŒ ' + msg;
            }
            cldAlert('cld-live-alert', msg, '#f8d7da', '#721c24');
        }

        btn.disabled = false; btn.textContent = 'âš¡ Fetch Live Stats';
    }

    // -- Init ------------------------------------------------------------------
    (function cldInit() {
        // Restore saved worker URL
        const savedUrl = localStorage.getItem(CLD_WORKER_KEY);
        const urlEl = document.getElementById('cld-worker-url');
        if (savedUrl && urlEl) urlEl.value = savedUrl;

        // Set today's date in manual form
        const dateEl = document.getElementById('cldm-date');
        if (dateEl) dateEl.value = new Date().toISOString().slice(0,10);

        // Load latest manual entry if exists
        const history = cldmLoadHistory().sort((a,b) => b.date.localeCompare(a.date));
        if (history.length > 0) cldmRender(history[0]);
        cldmRenderHistory();
    })();

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // ðŸ”¥ FIREBASE DOWNLOAD MONITOR
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    const FDM_LIMIT_GB = 10;
    const FDM_STORAGE_KEY = 'spurthi_fdm_history';

    function fdmLoadHistory() {
        try {
            return JSON.parse(localStorage.getItem(FDM_STORAGE_KEY) || '[]');
        } catch(e) { return []; }
    }

    function fdmSaveHistory(history) {
        localStorage.setItem(FDM_STORAGE_KEY, JSON.stringify(history));
    }

    function fdmGetToday() {
        return new Date().toISOString().slice(0, 10);
    }

    function fdmStatusInfo(gb) {
        const pct = (gb / FDM_LIMIT_GB) * 100;
        if (pct >= 100) return { label: 'BLOCKED', color: '#dc3545', icon: 'ðŸš«', barColor: 'linear-gradient(90deg,#dc3545,#c0392b)' };
        if (pct >= 90)  return { label: 'CRITICAL', color: '#dc3545', icon: 'ðŸ”´', barColor: 'linear-gradient(90deg,#f5576c,#c44569)' };
        if (pct >= 75)  return { label: 'WARNING', color: '#e65100', icon: 'âš ï¸', barColor: 'linear-gradient(90deg,#f7971e,#ffd200)' };
        return { label: 'SAFE', color: '#28a745', icon: 'âœ…', barColor: 'linear-gradient(90deg,#43e97b,#38f9d7)' };
    }

    function fdmRenderGauge(todayGb) {
        const pct = Math.min(100, (todayGb / FDM_LIMIT_GB) * 100);
        const status = fdmStatusInfo(todayGb);
        const remaining = Math.max(0, FDM_LIMIT_GB - todayGb);

        document.getElementById('fdm-gauge-bar').style.width = pct + '%';
        document.getElementById('fdm-gauge-bar').style.background = status.barColor;
        document.getElementById('fdm-gauge-label').textContent = `${todayGb.toFixed(2)} / ${FDM_LIMIT_GB} GB`;
        document.getElementById('fdm-gauge-label').style.color = status.color;

        const badge = document.getElementById('fdm-status-badge');
        badge.style.background = status.color;
        badge.querySelector('span:first-child').textContent = status.icon;
        document.getElementById('fdm-status-text').textContent = status.label;

        document.getElementById('fdm-remaining-label').textContent =
            todayGb === 0
                ? 'No data logged yet. Use the form above to log usage.'
                : `${remaining.toFixed(2)} GB remaining today (${(100 - pct).toFixed(1)}% left) â€” Resets at midnight Pacific Time`;
        document.getElementById('fdm-remaining-label').style.color = status.color;
    }

    function fdmRenderHistory() {
        const history = fdmLoadHistory();
        const tbody = document.getElementById('fdm-history-body');

        if (history.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" style="padding:16px;text-align:center;color:#aaa">No history yet.</td></tr>';
            return;
        }

        // Sort newest first, show last 7
        const sorted = [...history].sort((a, b) => b.date.localeCompare(a.date)).slice(0, 7);
        const todayStr = fdmGetToday();

        tbody.innerHTML = sorted.map((entry, i) => {
            const pct = Math.min(100, (entry.gb / FDM_LIMIT_GB) * 100).toFixed(1);
            const status = fdmStatusInfo(entry.gb);
            const isToday = entry.date === todayStr;
            return `<tr style="background:${i % 2 === 0 ? '#fff' : '#fdf5ff'};border-bottom:1px solid #eee">
                <td style="padding:8px 12px;font-weight:${isToday ? '700' : '400'};color:${isToday ? '#c44569' : '#333'}">${entry.date}${isToday ? ' ðŸ“' : ''}</td>
                <td style="padding:8px 12px;font-weight:700;color:${status.color}">${entry.gb.toFixed(2)} GB</td>
                <td style="padding:8px 12px">
                    <div style="display:flex;align-items:center;gap:8px">
                        <div style="flex:1;background:#e0e0e0;border-radius:10px;height:7px;min-width:80px;overflow:hidden">
                            <div style="background:${status.barColor};height:100%;width:${pct}%;border-radius:10px"></div>
                        </div>
                        <span style="font-size:.8em;color:${status.color};font-weight:600">${pct}%</span>
                    </div>
                </td>
                <td style="padding:8px 12px"><span style="background:${status.color};color:white;padding:2px 10px;border-radius:12px;font-size:.76em;font-weight:600">${status.icon} ${status.label}</span></td>
                <td style="padding:8px 12px">
                    <button onclick="fdmDeleteEntry('${entry.date}')" style="background:#f8d7da;color:#721c24;border:none;border-radius:6px;padding:3px 10px;cursor:pointer;font-size:.78em">ðŸ—‘ï¸ Delete</button>
                </td>
            </tr>`;
        }).join('');

        // Update today's gauge
        const todayEntry = history.find(e => e.date === todayStr);
        fdmRenderGauge(todayEntry ? todayEntry.gb : 0);
    }

    function fdmLogUsage() {
        const gbInput = parseFloat(document.getElementById('fdm-today-gb').value);
        const dateInput = document.getElementById('fdm-date').value || fdmGetToday();

        if (isNaN(gbInput) || gbInput < 0) {
            alert('Please enter a valid download amount (GB).');
            return;
        }
        if (gbInput > 100) {
            alert('Value seems too high. Please enter GB, not MB or bytes.');
            return;
        }

        const history = fdmLoadHistory();
        const existingIdx = history.findIndex(e => e.date === dateInput);
        if (existingIdx >= 0) {
            history[existingIdx].gb = gbInput;
        } else {
            history.push({ date: dateInput, gb: gbInput });
        }

        fdmSaveHistory(history);
        fdmRenderHistory();

        document.getElementById('fdm-today-gb').value = '';
        document.getElementById('fdm-date').value = '';
    }

    function fdmDeleteEntry(date) {
        if (!confirm('Delete entry for ' + date + '?')) return;
        const history = fdmLoadHistory().filter(e => e.date !== date);
        fdmSaveHistory(history);
        fdmRenderHistory();
    }

    function fdmClearHistory() {
        if (!confirm('Clear all download history? This cannot be undone.')) return;
        fdmSaveHistory([]);
        fdmRenderHistory();
    }

    // Init: set today's date in the input, render history
    (function fdmInit() {
        const dateEl = document.getElementById('fdm-date');
        if (dateEl) dateEl.value = fdmGetToday();
        fdmRenderHistory();
    })();

    // -- Auto-init when db is ready --------------------------------------------
    (function hwpInit() {
        function tryInit() {
            try {
                getDb(); // will throw if not ready
                hwpLoad();
            } catch(e) { setTimeout(tryInit, 600); }
        }
        tryInit();
    })();

    // ============================================================
    //  ðŸ“„ PDF HANDOUTS â€” Admin + Public logic
    // ============================================================
    const PDF_CLD_CLOUD  = 'dat0khbet';
    const PDF_CLD_PRESET = 'scavenger_hunt';
    const PDF_FB_PATH    = 'pdfHandouts';

    let pdfSelectedFile = null;

    function pdfOnFileChange(input) {
        pdfSelectedFile = input.files[0] || null;
        const nameEl = document.getElementById('pdfFileName');
        const zone   = document.getElementById('pdfDropZone');
        if (pdfSelectedFile) {
            if (nameEl) nameEl.textContent = pdfSelectedFile.name;
            if (zone)   zone.style.background = '#e8f5e9';
        } else {
            if (nameEl) nameEl.textContent = 'No file selected';
            if (zone)   zone.style.background = 'white';
        }
    }

    async function pdfUploadHandout() {
        const label    = (document.getElementById('pdfLabel')?.value || '').trim();
        const uploader = (document.getElementById('pdfUploader')?.value || '').trim();
        const msg      = document.getElementById('pdfUploadMsg');
        const btn      = document.getElementById('pdfUploadBtn');
        const progress = document.getElementById('pdfUploadProgress');
        const bar      = document.getElementById('pdfUploadBar');
        const pLabel   = document.getElementById('pdfUploadProgressLabel');

        if (!label)          { alert('Please enter the event name / label.'); return; }
        if (!uploader)       { alert('Please enter your name (Uploaded By).'); return; }
        if (!pdfSelectedFile){ alert('Please select a PDF file.'); return; }
        if (!pdfSelectedFile.name.toLowerCase().endsWith('.pdf')) { alert('Only PDF files are accepted.'); return; }
        if (pdfSelectedFile.size > 20 * 1024 * 1024) { alert('File too large. Max 20 MB per PDF.'); return; }

        btn.disabled = true;
        if (progress) progress.style.display = 'block';
        if (bar) bar.style.width = '10%';
        if (pLabel) pLabel.textContent = 'Uploading to cloudâ€¦';
        if (msg) { msg.style.display = 'none'; }

        try {
            // Upload PDF to Cloudinary (raw resource type)
            const fd = new FormData();
            fd.append('file', pdfSelectedFile);
            fd.append('upload_preset', PDF_CLD_PRESET);
            fd.append('folder', 'pdfHandouts');
            fd.append('resource_type', 'raw');

            if (bar) bar.style.width = '40%';
            const cldRes = await fetch(
                `https://api.cloudinary.com/v1_1/${PDF_CLD_CLOUD}/raw/upload`,
                { method: 'POST', body: fd }
            );
            const cldData = await cldRes.json();
            if (!cldData.secure_url) throw new Error(cldData.error?.message || 'Upload failed');

            if (bar) bar.style.width = '80%';
            if (pLabel) pLabel.textContent = 'Saving to databaseâ€¦';

            // Save record to Firebase
            const record = {
                label,
                uploader,
                url:       cldData.secure_url,
                publicId:  cldData.public_id,
                size:      pdfSelectedFile.size,
                uploadedAt: new Date().toISOString(),
            };
            await getDb().ref(PDF_FB_PATH).push(record);

            if (bar) bar.style.width = '100%';
            if (pLabel) pLabel.textContent = 'âœ… Done!';
            if (msg) { msg.textContent = 'âœ… Handout published successfully!'; msg.style.color = '#1b5e20'; msg.style.display = 'inline'; }

            // Reset form
            document.getElementById('pdfLabel').value    = '';
            document.getElementById('pdfUploader').value = '';
            document.getElementById('pdfFileInput').value = '';
            pdfSelectedFile = null;
            const nameEl = document.getElementById('pdfFileName');
            const zone   = document.getElementById('pdfDropZone');
            if (nameEl) nameEl.textContent = 'No file selected';
            if (zone)   zone.style.background = 'white';

            setTimeout(() => { if (progress) progress.style.display = 'none'; if (bar) bar.style.width = '0%'; }, 2000);
            pdfLoadHandouts();
            initPublicPdfHandouts(); // refresh public section
        } catch(e) {
            if (msg) { msg.textContent = 'âŒ Error: ' + e.message; msg.style.color = '#b71c1c'; msg.style.display = 'inline'; }
            if (pLabel) pLabel.textContent = 'âŒ Upload failed.';
            console.error('PDF upload error:', e);
        } finally {
            btn.disabled = false;
        }
    }

    async function pdfLoadHandouts() {
        const wrap = document.getElementById('pdfHandoutsList');
        if (!wrap) return;
        wrap.innerHTML = '<p style="color:#aaa;text-align:center;padding:20px">Loadingâ€¦</p>';
        try {
            const snap = await getDb().ref(PDF_FB_PATH).once('value');
            if (!snap.exists()) { wrap.innerHTML = '<p style="color:#aaa;text-align:center;padding:20px">No handouts uploaded yet.</p>'; return; }
            const items = Object.entries(snap.val()).map(([k,v]) => ({id:k,...v}))
                              .sort((a,b) => new Date(b.uploadedAt) - new Date(a.uploadedAt));
            wrap.innerHTML = `
            <div style="overflow-x:auto;border-radius:10px;border:1px solid #e0e0e0">
                <table style="width:100%;border-collapse:collapse;font-size:.88em">
                    <thead>
                        <tr style="background:#6a1b9a;color:white">
                            <th style="padding:10px 12px;text-align:left">Label / Event</th>
                            <th style="padding:10px 12px;text-align:left">Uploaded By</th>
                            <th style="padding:10px 12px;text-align:left">Date</th>
                            <th style="padding:10px 12px;text-align:center">Size</th>
                            <th style="padding:10px 12px;text-align:center">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${items.map((it,i) => `
                        <tr style="background:${i%2===0?'#fafafa':'white'};border-bottom:1px solid #eee">
                            <td style="padding:9px 12px;font-weight:600;color:#4a148c">ðŸ“„ ${it.label}</td>
                            <td style="padding:9px 12px">${it.uploader}</td>
                            <td style="padding:9px 12px;font-size:.82em;color:#777">${new Date(it.uploadedAt).toLocaleString('en-IN')}</td>
                            <td style="padding:9px 12px;text-align:center;font-size:.82em">${it.size ? (it.size/1024).toFixed(0)+' KB' : 'â€”'}</td>
                            <td style="padding:9px 12px;text-align:center;white-space:nowrap">
                                <a href="${it.url}" target="_blank" style="background:#e8f5e9;color:#1b5e20;border:none;border-radius:6px;padding:4px 12px;font-size:.82em;font-weight:600;text-decoration:none;margin-right:6px;display:inline-block">â¬‡ï¸ View</a>
                                <button onclick="pdfDeleteHandout('${it.id}','${it.publicId || ''}')" style="background:#fce4ec;color:#880e4f;border:none;border-radius:6px;padding:4px 12px;cursor:pointer;font-size:.82em;font-weight:600">ðŸ—‘ï¸ Delete</button>
                            </td>
                        </tr>`).join('')}
                    </tbody>
                </table>
            </div>`;
        } catch(e) {
            wrap.innerHTML = `<p style="color:#b71c1c;text-align:center;padding:20px">Error loading: ${e.message}</p>`;
        }
    }

    async function pdfDeleteHandout(id, publicId) {
        if (!confirm('Delete this PDF handout? It will be removed from the public page too.')) return;
        try {
            await getDb().ref(`${PDF_FB_PATH}/${id}`).remove();
            pdfLoadHandouts();
            initPublicPdfHandouts();
        } catch(e) { alert('Delete failed: ' + e.message); }
    }

    // Public-facing: inject PDF buttons into #publicPdfHandouts
    async function initPublicPdfHandouts() {
        const wrap = document.getElementById('publicPdfHandouts');
        if (!wrap) return;

        // Always keep the Rules PDF button
        const rulesBtn = `<a href="rules.pdf" target="_blank" style="display:inline-flex;align-items:center;gap:8px;background:linear-gradient(135deg,#c44569 0%,#6a1b9a 100%);color:white;padding:12px 24px;border-radius:8px;text-decoration:none;font-weight:600;">ðŸ“„ Complete Rules &amp; Regulations PDF (Coming Soon)</a>`;

        try {
            const snap = await getDb().ref(PDF_FB_PATH).once('value');
            if (!snap.exists()) { wrap.innerHTML = rulesBtn; return; }
            const items = Object.values(snap.val()).sort((a,b) => new Date(a.uploadedAt) - new Date(b.uploadedAt));
            const colors = ['#0d47a1,#1976d2','#1b5e20,#388e3c','#880e4f,#c2185b','#e65100,#f57c00','#4a148c,#6a1b9a','#006064,#00838f'];
            const dynamicBtns = items.map((it,i) => {
                const c = colors[i % colors.length];
                return `<a href="${it.url}" target="_blank" style="display:inline-flex;align-items:center;gap:8px;background:linear-gradient(135deg,${c} 100%);color:white;padding:12px 24px;border-radius:8px;text-decoration:none;font-weight:600;">ðŸ“„ ${it.label}</a>`;
            }).join('');
            wrap.innerHTML = rulesBtn + dynamicBtns;
        } catch(e) {
            wrap.innerHTML = rulesBtn;
        }
    }

    // ============================================================
    //  ðŸ’³ PAYMENT APPROVAL â€” Admin logic
    // ============================================================
    const PA_FB_PATH = 'paymentRegistrations';

    async function paLoadPending() {
        const wrap       = document.getElementById('paRegistrationList');
        const filterSel  = document.getElementById('paFilterStatus');
        const searchEl   = document.getElementById('paSearch');
        if (!wrap) return;
        wrap.innerHTML = '<p style="color:#aaa;text-align:center;padding:24px">Loadingâ€¦</p>';

        const filterStatus = filterSel?.value || '';
        const searchTerm   = (searchEl?.value || '').toLowerCase();

        try {
            const snap = await getDb().ref(PA_FB_PATH).once('value');
            let items = [];
            if (snap.exists()) {
                items = Object.entries(snap.val()).map(([k,v]) => ({id:k,...v}))
                    .sort((a,b) => new Date(b.registeredAt||0) - new Date(a.registeredAt||0));
            }

            // Update stat counters
            document.getElementById('paStatPending').textContent  = items.filter(i=>i.status==='pending').length;
            document.getElementById('paStatApproved').textContent = items.filter(i=>i.status==='approved').length;
            document.getElementById('paStatRejected').textContent = items.filter(i=>i.status==='rejected').length;

            // Filter
            let filtered = items;
            if (filterStatus) filtered = filtered.filter(i => i.status === filterStatus);
            if (searchTerm)   filtered = filtered.filter(i =>
                (i.name||'').toLowerCase().includes(searchTerm) ||
                (i.classYear||'').toLowerCase().includes(searchTerm) ||
                (i.phone||'').toLowerCase().includes(searchTerm)
            );

            if (!filtered.length) {
                wrap.innerHTML = '<p style="color:#aaa;text-align:center;padding:24px">No records found.</p>';
                return;
            }

            const statusBadge = s => ({
                pending:  '<span style="background:#fff8e1;color:#f57f17;border:1px solid #ffc107;padding:3px 10px;border-radius:12px;font-size:.78em;font-weight:700">â³ Pending</span>',
                approved: '<span style="background:#e8f5e9;color:#1b5e20;border:1px solid #4caf50;padding:3px 10px;border-radius:12px;font-size:.78em;font-weight:700">âœ… Approved</span>',
                rejected: '<span style="background:#fce4ec;color:#880e4f;border:1px solid #e91e63;padding:3px 10px;border-radius:12px;font-size:.78em;font-weight:700">âŒ Rejected</span>',
            }[s] || s);

            wrap.innerHTML = `
            <div style="overflow-x:auto;border-radius:10px;border:1px solid #e0e0e0">
                <table style="width:100%;border-collapse:collapse;font-size:.88em">
                    <thead>
                        <tr style="background:linear-gradient(135deg,#c44569,#6a1b9a);color:white">
                            <th style="padding:10px 12px;text-align:left">Class Name</th>
                            <th style="padding:10px 12px;text-align:left">Captain Phone</th>
                            <th style="padding:10px 12px;text-align:left">Students</th>
                            <th style="padding:10px 12px;text-align:left">Registered</th>
                            <th style="padding:10px 12px;text-align:center">Status</th>
                            <th style="padding:10px 12px;text-align:left">Note</th>
                            <th style="padding:10px 12px;text-align:center">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${filtered.map((it,i) => `
                        <tr style="background:${i%2===0?'#fafafa':'white'};border-bottom:1px solid #eee" id="pa-row-${it.id}">
                            <td style="padding:9px 12px;font-weight:600">ðŸ« ${it.name||it.classYear||'â€”'}</td>
                            <td style="padding:9px 12px">${it.phone||'â€”'}</td>
                            <td style="padding:9px 12px;text-align:center">${it.studentCount||'â€”'}</td>
                            <td style="padding:9px 12px;font-size:.8em;color:#777">${it.registeredAt ? new Date(it.registeredAt).toLocaleString('en-IN') : 'â€”'}</td>
                            <td style="padding:9px 12px;text-align:center" id="pa-status-${it.id}">${statusBadge(it.status)}</td>
                            <td style="padding:9px 12px;font-size:.82em;color:#555">${it.note||''}</td>
                            <td style="padding:9px 12px;text-align:center;white-space:nowrap">
                                ${it.status !== 'approved' ? `<button onclick="paSetStatus('${it.id}','approved')" style="background:#e8f5e9;color:#1b5e20;border:none;border-radius:6px;padding:4px 10px;cursor:pointer;font-size:.8em;font-weight:700;margin:2px">âœ… Approve</button>` : ''}
                                ${it.status !== 'rejected' ? `<button onclick="paSetStatus('${it.id}','rejected')" style="background:#fce4ec;color:#880e4f;border:none;border-radius:6px;padding:4px 10px;cursor:pointer;font-size:.8em;font-weight:700;margin:2px">âŒ Reject</button>` : ''}
                                <button onclick="paDelete('${it.id}')" style="background:#f5f5f5;color:#555;border:none;border-radius:6px;padding:4px 10px;cursor:pointer;font-size:.8em;margin:2px">ðŸ—‘ï¸</button>
                            </td>
                        </tr>`).join('')}
                    </tbody>
                </table>
            </div>`;
        } catch(e) {
            wrap.innerHTML = `<p style="color:#b71c1c;text-align:center;padding:20px">Error: ${e.message}</p>`;
        }
    }

    async function paSetStatus(id, status) {
        try {
            await getDb().ref(`${PA_FB_PATH}/${id}/status`).set(status);
            await getDb().ref(`${PA_FB_PATH}/${id}/reviewedAt`).set(new Date().toISOString());
            await getDb().ref(`${PA_FB_PATH}/${id}/reviewedBy`).set(currentUser || 'Admin');
            paLoadPending();
        } catch(e) { alert('Error: ' + e.message); }
    }

    async function paDelete(id) {
        if (!confirm('Delete this registration entry?')) return;
        try {
            await getDb().ref(`${PA_FB_PATH}/${id}`).remove();
            paLoadPending();
        } catch(e) { alert('Error: ' + e.message); }
    }

    async function paManualAdd() {
        const className = (document.getElementById('paManualName')?.value || '').trim();
        const phone     = (document.getElementById('paManualPhone')?.value || '').trim();
        const students  = (document.getElementById('paManualClass')?.value || '').trim();
        const status    = document.getElementById('paManualStatus')?.value || 'pending';
        const note      = (document.getElementById('paManualNote')?.value || '').trim();

        if (!className || !phone) { alert('Please fill in Class Name and Captain Phone.'); return; }

        try {
            await getDb().ref(PA_FB_PATH).push({
                name: className, phone, classYear: className,
                studentCount: students, status, note,
                registeredAt: new Date().toISOString(),
                addedBy: currentUser || 'Admin',
            });
            document.getElementById('paManualName').value  = '';
            document.getElementById('paManualPhone').value = '';
            document.getElementById('paManualClass').value = '';
            document.getElementById('paManualNote').value  = '';
            paLoadPending();
        } catch(e) { alert('Error: ' + e.message); }
    }

    async function paDownloadCSV() {
        try {
            const snap = await getDb().ref(PA_FB_PATH).once('value');
            if (!snap.exists()) { alert('No data to download.'); return; }
            const items = Object.values(snap.val());
            const header = 'Name,Phone,Class,Status,Registered At,Reviewed By,Note';
            const rows = items.map(i =>
                [i.name,i.phone,i.classYear||i.class,i.status,i.registeredAt,i.reviewedBy||'',i.note||'']
                .map(v => `"${(v||'').replace(/"/g,'""')}"`)
                .join(',')
            );
            const blob = new Blob([header+'\n'+rows.join('\n')], {type:'text/csv'});
            const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
            a.download = 'payment_registrations.csv'; a.click();
        } catch(e) { alert('Error: ' + e.message); }
    }

    // ============================================================
    //  ðŸ“… EVENT SCHEDULE â€” Admin + Public logic
    // ============================================================
    const ES_FB_PATH = 'eventSchedule';

    const ES_DEFAULT_EVENTS = [
        {sl:1, name:'Mime', stageType:'On stage', classInfo:"I BCA / II BCA 'B'",      incharge:'Priyanka V / Kotrappa K',      meeting1:'Feb 24th at 1:00â€“1:15 pm',   meeting2:'March 4th at 1:00â€“1:15 pm',   startDate:'',           endDate:''},
        {sl:2, name:'Social Awareness Skit', stageType:'On stage', classInfo:'III BBA / II BCA "A"',  incharge:'Shankar B C / Smitha M',       meeting1:'Feb 27th at 1:00â€“1:15 pm',   meeting2:'March 7th at 1:00â€“1:15 pm',   startDate:'',           endDate:''},
        {sl:3, name:'Group Dance', stageType:'On stage', classInfo:"III BCA 'C' / III BCA 'B'", incharge:'Anitha N / Pooja C',           meeting1:'Feb 26th at 1:00â€“1:15 pm',   meeting2:'March 6th at 1:00â€“1:15 pm',   startDate:'',           endDate:''},
        {sl:4, name:'Mad Ads', stageType:'On stage', classInfo:'I BCOM / I BCA',          incharge:'Shilpa R Y / Roopa M C',       meeting1:'Feb 27th at 3:15â€“3:30 pm',   meeting2:'March 9th at 3:15â€“3:30 pm',   startDate:'',           endDate:''},
        {sl:5, name:'Ramp Walk', stageType:'On stage', classInfo:'II BBA / III B.Com',       incharge:'Hemavathi D / Chandan G B',    meeting1:'Feb 24th at 3:15â€“3:30 pm',   meeting2:'Feb 28th at 3:15â€“3:30 pm',    startDate:'',           endDate:''},
        {sl:6, name:'Pod Casting', stageType:'Off stage', classInfo:'III BCOM / II BBA',      incharge:'Chandan G B / Hemavathi D',    meeting1:'Feb 23rd at 12:45â€“1:00 pm',  meeting2:'March 2nd at 12:45â€“1:00 pm',  startDate:'02-03-2026', endDate:'07-03-2026'},
        {sl:7, name:'Nukkad Natak', stageType:'Off stage', classInfo:'II BCA "B" / III BBA',   incharge:'Kotrappa K / Shankar B C',     meeting1:'Feb 28th at 1:00â€“1:15 pm',   meeting2:'March 7th at 10:30â€“10:45 am', startDate:'09-03-2026', endDate:'14-03-2026'},
        {sl:8, name:'Talent Hunt', stageType:'Off stage', classInfo:'III BCA "B" / III BCA A', incharge:'Anitha N / Pooja C',           meeting1:'Feb 28th at 3:15â€“3:30 pm',   meeting2:'March 9th at 1:00â€“1:15 pm',   startDate:'',           endDate:'14-03-2026'},
        {sl:9, name:'YouTube Advertisement', stageType:'Off stage', classInfo:"I BCA 'A' / II BCA 'A'",incharge:'Roopa M C / Smitha M',        meeting1:'Feb 25th at 12:45â€“1:00 pm',  meeting2:'March 5th at 12:45â€“1:00 pm',  startDate:'02-03-2026', endDate:'07-03-2026'},
        {sl:10,name:'Case Analysis', stageType:'Off stage', classInfo:"I BCOM / I BCA 'A'",   incharge:'Shilpa R Y / Roopa M C',       meeting1:'Feb 25th at 1:00â€“1:15 pm',   meeting2:'March 5th at 1:00â€“1:15 pm',   startDate:'09-03-2026', endDate:'10-03-2026'},
        {sl:11,name:'Interdisciplinary', stageType:'Off stage', classInfo:'II BBA / II BCOM',    incharge:'Hemavathi D / Lalitha S K',    meeting1:'Feb 23rd at 1:00â€“1:15 pm',   meeting2:'March 2nd at 1:00â€“1:15 pm',   startDate:'02-03-2026', endDate:'07-03-2026'},
        {sl:12,name:'Quiz', stageType:'Off stage', classInfo:'III BCA "B" / II BCA "A"', incharge:'Smitha M / Pooja C',           meeting1:'Feb 24th at 12:45â€“1:00 pm',  meeting2:'March 4th at 12:45â€“1:00 pm',  startDate:'02-03-2026', endDate:'12-03-2026'},
        {sl:13,name:'Vlog', stageType:'Off stage', classInfo:'III BCOM',               incharge:'Chandan G B / Priyanka V',     meeting1:'Feb 26th at 12:45â€“1:00 pm',  meeting2:'March 6th at 12:45â€“1:00 pm',  startDate:'02-03-2026', endDate:'07-03-2026'},
        {sl:14,name:'Hand Writing', stageType:'Off stage', classInfo:'III BCA "A" / III BCA "C"',incharge:'Kotrappa K / Anitha N',        meeting1:'Feb 27th at 12:45â€“1:00 pm',  meeting2:'March 7th at 12:45â€“1:00 pm',  startDate:'',           endDate:'11-03-2026'},
        {sl:15,name:'Best Out of Waste', stageType:'Off stage', classInfo:'II BCOM / III BBA',   incharge:'Lalitha S K / Shankar B C',    meeting1:'Feb 28th at 12:45â€“1:00 pm',  meeting2:'March 7th at 3:15â€“3:30 pm',   startDate:'',           endDate:'13-03-2026'},
    ];

    async function esSeedDefaults() {
        if (!confirm('âš ï¸ This will DELETE all existing events and reload the 15 default events fresh. Continue?')) return;
        try {
            // First delete all existing events to prevent duplicates
            await getDb().ref(ES_FB_PATH).remove();
            // Then add the 15 defaults
            for (const ev of ES_DEFAULT_EVENTS) {
                await getDb().ref(ES_FB_PATH).push({...ev, createdAt: new Date().toISOString()});
            }
            alert('âœ… 15 default events loaded! All previous events were replaced.');
            esLoadEvents();
            esRenderPublicTable();
        } catch(e) { alert('Error: ' + e.message); }
    }

    async function esLoadEvents() {
        const wrap = document.getElementById('esAdminTableWrap');
        if (!wrap) return;
        wrap.innerHTML = '<p style="color:#aaa;text-align:center;padding:24px">Loadingâ€¦</p>';
        try {
            const snap = await getDb().ref(ES_FB_PATH).once('value');
            if (!snap.exists()) {
                wrap.innerHTML = '<p style="color:#aaa;text-align:center;padding:20px">No events yet. Click "Load Default 15 Events" or add manually above.</p>';
                return;
            }
            const items = Object.entries(snap.val()).map(([k,v])=>({id:k,...v}))
                              .sort((a,b)=>(a.sl||999)-(b.sl||999));
            wrap.innerHTML = `
            <table style="width:100%;border-collapse:collapse;font-size:.82em;background:white">
                <thead>
                    <tr style="background:#0d47a1;color:white">
                        <th style="padding:8px 10px">Sl</th>
                        <th style="padding:8px 10px;text-align:left">Event</th>
                        <th style="padding:8px 10px;text-align:left">Stage</th>
                        <th style="padding:8px 10px;text-align:left">Class</th>
                        <th style="padding:8px 10px;text-align:left">In-charge</th>
                        <th style="padding:8px 10px;text-align:left">I Meeting</th>
                        <th style="padding:8px 10px;text-align:left">II Meeting</th>
                        <th style="padding:8px 10px;text-align:center">Start</th>
                        <th style="padding:8px 10px;text-align:center">Start Time</th>
                        <th style="padding:8px 10px;text-align:center">End</th>
                        <th style="padding:8px 10px;text-align:center">End Time</th>
                        <th style="padding:8px 10px;text-align:center">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    ${items.map((it,i)=>`
                    <tr style="background:${i%2===0?'#f5f5f5':'white'};border-bottom:1px solid #e0e0e0">
                        <td style="padding:7px 10px;text-align:center;font-weight:700;color:#0d47a1">${it.sl||'â€”'}</td>
                        <td style="padding:7px 10px;font-weight:600">${it.name||'â€”'}</td>
                        <td style="padding:7px 10px;font-size:.82em">${it.stageType||'â€”'}</td>
                        <td style="padding:7px 10px;font-size:.82em">${it.classInfo||'â€”'}</td>
                        <td style="padding:7px 10px;font-size:.82em">${it.incharge||'â€”'}</td>
                        <td style="padding:7px 10px;font-size:.79em;color:#555">${it.meeting1||'â€”'}</td>
                        <td style="padding:7px 10px;font-size:.79em;color:#555">${it.meeting2||'â€”'}</td>
                        <td style="padding:7px 10px;text-align:center;font-size:.82em;color:#1b5e20;font-weight:600">${it.startDate||'â€”'}</td>
                        <td style="padding:7px 10px;text-align:center;font-size:.82em;color:#b71c1c;font-weight:600">${it.endDate||'â€”'}</td>
                        <td style="padding:7px 10px;text-align:center;font-size:.82em;color:#0d47a1;font-weight:600">${it.startTime||'â€”'}</td>
                        <td style="padding:7px 10px;text-align:center;font-size:.82em;color:#6a1b9a;font-weight:600">${it.endTime||'â€”'}</td>
                        <td style="padding:7px 10px;text-align:center;white-space:nowrap">
                            <button onclick="esEditLoad('${it.id}')" style="background:#e3f2fd;color:#0d47a1;border:none;border-radius:6px;padding:3px 10px;cursor:pointer;font-size:.8em;font-weight:700;margin:2px">âœï¸ Edit</button>
                            <button onclick="esDeleteEvent('${it.id}')" style="background:#fce4ec;color:#880e4f;border:none;border-radius:6px;padding:3px 10px;cursor:pointer;font-size:.8em;font-weight:700;margin:2px">ðŸ—‘ï¸</button>
                        </td>
                    </tr>`).join('')}
                </tbody>
            </table>`;
        } catch(e) {
            wrap.innerHTML = `<p style="color:#b71c1c;text-align:center;padding:20px">Error: ${e.message}</p>`;
        }
    }

    // -- Toggle custom event name field --------------------------------
    function esToggleCustomName(val) {
        const wrap = document.getElementById('esCustomNameWrap');
        if (!wrap) return;
        if (val === 'âž• Add Custom Eventâ€¦') {
            wrap.style.display = 'block';
            document.getElementById('esCustomName').focus();
            document.getElementById('esName').value = '';
        } else {
            wrap.style.display = 'none';
        }
    }

    async function esSaveEvent() {
        const id       = document.getElementById('esEditId')?.value || '';
        // Use custom name if the custom field is visible and filled
        const customWrap = document.getElementById('esCustomNameWrap');
        const isCustom   = customWrap && customWrap.style.display !== 'none';
        const rawName    = isCustom
            ? (document.getElementById('esCustomName')?.value || '').trim()
            : (document.getElementById('esName')?.value || '').trim();
        const name     = rawName;
        const stageType= document.getElementById('esStageType')?.value || 'On stage';
        const classInfo= (document.getElementById('esClass')?.value || '').trim();
        const incharge = (document.getElementById('esIncharge')?.value || '').trim();
        const meeting1 = (document.getElementById('esMeeting1')?.value || '').trim();
        const meeting2 = (document.getElementById('esMeeting2')?.value || '').trim();
        const startDate= (document.getElementById('esStartDate')?.value || '').trim();
        const endDate  = (document.getElementById('esEndDate')?.value || '').trim();
        const startTime= (document.getElementById('esStartTime')?.value || '').trim();
        const endTime  = (document.getElementById('esEndTime')?.value || '').trim();
        const msg      = document.getElementById('esFormMsg');

        if (!name) { alert('Event name is required.'); return; }

        // Auto-assign sl number if new event
        let sl = 0;
        if (!id) {
            try {
                const snap = await getDb().ref(ES_FB_PATH).once('value');
                sl = snap.exists() ? Object.keys(snap.val()).length + 1 : 1;
            } catch(e) { sl = 0; }
        } else {
            const snap = await getDb().ref(`${ES_FB_PATH}/${id}/sl`).once('value');
            sl = snap.val() || 0;
        }

        const record = { sl, name, stageType, classInfo, incharge, meeting1, meeting2, startDate, endDate, startTime, endTime, updatedAt: new Date().toISOString() };

        try {
            if (id) {
                await getDb().ref(`${ES_FB_PATH}/${id}`).update(record);
            } else {
                record.createdAt = new Date().toISOString();
                await getDb().ref(ES_FB_PATH).push(record);
            }
            if (msg) { msg.textContent = 'âœ… Saved!'; msg.style.color = '#1b5e20'; msg.style.display = 'inline'; setTimeout(()=>{ msg.style.display='none'; },3000); }
            esClearForm();
            esLoadEvents();
            esRenderPublicTable();
        } catch(e) {
            if (msg) { msg.textContent = 'âŒ Error: ' + e.message; msg.style.color = '#b71c1c'; msg.style.display = 'inline'; }
        }
    }

    async function esEditLoad(id) {
        try {
            const snap = await getDb().ref(`${ES_FB_PATH}/${id}`).once('value');
            if (!snap.exists()) return;
            const it = snap.val();
            document.getElementById('esEditId').value    = id;
            document.getElementById('esName').value      = it.name || '';
            document.getElementById('esStageType').value = it.stageType || 'On stage';
            document.getElementById('esClass').value     = it.classInfo || '';
            document.getElementById('esIncharge').value  = it.incharge || '';
            document.getElementById('esMeeting1').value  = it.meeting1 || '';
            document.getElementById('esMeeting2').value  = it.meeting2 || '';
            document.getElementById('esStartDate').value = it.startDate || '';
            document.getElementById('esEndDate').value   = it.endDate || '';
            document.getElementById('esStartTime').value = it.startTime || '';
            document.getElementById('esEndTime').value   = it.endTime || '';
            const title = document.getElementById('esFormTitle');
            if (title) title.textContent = 'âœï¸ Editing: ' + it.name;
            document.getElementById('eventScheduleAdmin').scrollIntoView({behavior:'smooth',block:'start'});
        } catch(e) { alert('Load error: ' + e.message); }
    }

    async function esDeleteEvent(id) {
        if (!confirm('Delete this event from the schedule?')) return;
        try {
            await getDb().ref(`${ES_FB_PATH}/${id}`).remove();
            esLoadEvents();
            esRenderPublicTable();
        } catch(e) { alert('Error: ' + e.message); }
    }

    function esClearForm() {
        document.getElementById('esEditId').value    = '';
        document.getElementById('esName').value      = '';
        document.getElementById('esStageType').value = 'On stage';
        document.getElementById('esClass').value     = '';
        document.getElementById('esIncharge').value  = '';
        document.getElementById('esMeeting1').value  = '';
        document.getElementById('esMeeting2').value  = '';
        document.getElementById('esStartDate').value = '';
        document.getElementById('esEndDate').value   = '';
        document.getElementById('esStartTime').value = '';
        document.getElementById('esEndTime').value   = '';
        // Hide custom name field
        const customWrap = document.getElementById('esCustomNameWrap');
        const customInput = document.getElementById('esCustomName');
        if (customWrap) customWrap.style.display = 'none';
        if (customInput) customInput.value = '';
        const title = document.getElementById('esFormTitle');
        if (title) title.textContent = 'âž• Add New Event';
    }
    // Render the public-facing event schedule table
    async function esRenderPublicTable() {
        const tbody = document.getElementById('eventScheduleBody');
        if (!tbody) return;
        try {
            const snap = await getDb().ref(ES_FB_PATH).once('value');
            if (!snap.exists()) return; // keep hardcoded rows if nothing in Firebase yet
            const items = Object.values(snap.val()).sort((a,b)=>(a.sl||999)-(b.sl||999));
            if (!items.length) return;
            tbody.innerHTML = items.map((it,i) => `
            <tr style="background:${i%2===0?'#fafafa':'white'};border-bottom:1px solid #eee;">
                <td style="padding:9px 10px;text-align:center;font-weight:700;color:#6a1b9a">${it.sl||i+1}</td>
                <td style="padding:9px 10px;font-weight:600">${it.name||'â€”'} <span style="font-size:.78em;color:#888;font-weight:400">(${it.stageType||''})</span></td>
                <td style="padding:9px 10px">${it.classInfo||'â€”'}</td>
                <td style="padding:9px 10px">${it.incharge||'â€”'}</td>
                <td style="padding:9px 10px;font-size:.82em">${it.meeting1||'â€”'}</td>
                <td style="padding:9px 10px;font-size:.82em">${it.meeting2||'â€”'}</td>
                <td style="padding:9px 10px;text-align:center;font-weight:600;color:${it.startDate?'#1b5e20':'#aaa'}">${it.startDate||'â€”'}</td>
                <td style="padding:9px 10px;text-align:center;font-weight:600;color:${it.endDate?'#b71c1c':'#aaa'}">${it.endDate||'â€”'}</td>
                <td style="padding:9px 10px;text-align:center;font-weight:600;color:${it.startTime?'#0d47a1':'#aaa'}">${it.startTime||'â€”'}</td>
                <td style="padding:9px 10px;text-align:center;font-weight:600;color:${it.endTime?'#6a1b9a':'#aaa'}">${it.endTime||'â€”'}</td>
            </tr>`).join('');
        } catch(e) {
            // Silently keep the hardcoded static table if Firebase rules not yet set
            console.info('esRenderPublicTable: using static fallback â€”', e.message);
        }
    }

    // Auto-init public sections when Firebase is ready
    (function initPublicSections() {
        function tryInit() {
            if (typeof db !== 'undefined' && db) {
                initPublicPdfHandouts();
                esRenderPublicTable();
            } else {
                setTimeout(tryInit, 700);
            }
        }
        tryInit();
    })();

    </script>

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <!-- DEV QUICK-LOGIN PANEL                                          -->
    <!-- Trigger 1: type /*- in ANY input field on the page            -->
    <!-- Trigger 2: tap version text in footer 5Ã— quickly              -->
    <!-- INVISIBLE to normal users â€” for testing only                  -->
    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div id="devPanel" style="display:none;position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:99999;background:linear-gradient(135deg,#1a1a2e,#16213e);border:2px solid #6a1b9a;border-radius:16px;padding:18px 20px;box-shadow:0 8px 40px rgba(0,0,0,.85);min-width:280px;max-width:92vw;font-family:'Segoe UI',sans-serif">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:14px">
            <span style="color:#ffd700;font-weight:800;font-size:1em">ðŸ”§ Dev Quick Login</span>
            <button onclick="document.getElementById('devPanel').style.display='none'" style="background:rgba(255,255,255,.15);border:none;color:white;border-radius:8px;padding:4px 10px;cursor:pointer;font-size:.9em">âœ•</button>
        </div>
        <div style="display:flex;flex-direction:column;gap:8px">
            <button onclick="devLogin('superadmin')" style="background:linear-gradient(135deg,#6a1b9a,#9c27b0);color:white;border:none;padding:11px 14px;border-radius:10px;cursor:pointer;font-weight:700;font-size:.9em;text-align:left">ðŸ‘‘ Super Admin</button>
            <button onclick="devLogin('admin')"      style="background:linear-gradient(135deg,#c44569,#e91e63);color:white;border:none;padding:11px 14px;border-radius:10px;cursor:pointer;font-weight:700;font-size:.9em;text-align:left">ðŸ›¡ï¸ Admin</button>
            <button onclick="devLogin('manager')"    style="background:linear-gradient(135deg,#1565c0,#2196f3);color:white;border:none;padding:11px 14px;border-radius:10px;cursor:pointer;font-weight:700;font-size:.9em;text-align:left">ðŸ‘” Manager</button>
            <div style="border-top:1px solid rgba(255,255,255,.1);margin:4px 0;padding-top:8px">
                <p style="color:rgba(255,255,255,.4);font-size:.72em;margin:0 0 7px;text-transform:uppercase;letter-spacing:.5px">ðŸŽ“ Student â€” 9844542132</p>
                <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:7px">
                    <button onclick="devLogin('quiz')" style="background:linear-gradient(135deg,#e65100,#ff6d00);color:white;border:none;padding:10px 6px;border-radius:10px;cursor:pointer;font-weight:700;font-size:.82em">ðŸ“ Quiz</button>
                    <button onclick="devLogin('sh')"   style="background:linear-gradient(135deg,#00695c,#00897b);color:white;border:none;padding:10px 6px;border-radius:10px;cursor:pointer;font-weight:700;font-size:.82em">ðŸ—ºï¸ Hunt</button>
                    <button onclick="devLogin('ssc')"  style="background:linear-gradient(135deg,#2e7d32,#43a047);color:white;border:none;padding:10px 6px;border-radius:10px;cursor:pointer;font-weight:700;font-size:.82em">ðŸ§© SSC</button>
                </div>
            </div>
        </div>
        <p style="color:rgba(255,255,255,.25);font-size:.68em;margin:12px 0 0;text-align:center">/*- in any input = auto-detects & logs in Â· tap "Login" 5Ã— = this panel</p>
    </div>

    <script>
    (function(){
        const DEV_PHONE = '9844542132';
        const DEV_PASS  = '@ANeWC0y2O';

        function showDevPanel() {
            document.getElementById('devPanel').style.display = 'block';
        }

        // -- TRIGGER 1: type /*- in any input â†’ smart login based on which field --
        // IMPORTANT: skip tel/numeric inputs (phone fields) â€” students typing their
        // phone number should never accidentally trigger the dev panel.
        document.addEventListener('input', function(e) {
            const el = e.target;
            if (!el || !['INPUT','TEXTAREA'].includes(el.tagName)) return;
            // Never trigger on phone / numeric fields or password fields
            if (el.type === 'tel' || el.inputMode === 'numeric' || el.type === 'number') return;
            if (el.type === 'password') return; // typing in any password field must never open dev panel
            if (!el.value.includes('/*-')) return;
            el.value = el.value.replace('/*-', '');

            const id = el.id || '';

            // Detect which login form this input belongs to
            if (id === 'sscLoginPhone' || id === 'sscLoginPassword') {
                devLogin('ssc');
            } else if (id === 'quizLoginPhone' || id === 'quizLoginPassword') {
                devLogin('quiz');
            } else if (id === 'shLoginPhone' || id === 'shLoginPassword') {
                devLogin('sh');
            } else if (id === 'superAdminPassword') {
                devLogin('superadmin');
            } else if (id === 'adminPassword') {
                devLogin('admin');
            } else if (id === 'managerPassword') {
                devLogin('manager');
            } else if (id === 'manager2Password') {
                devLogin('manager2');
            } else if (id === 'facultyLoginPwd') {
                devLogin('faculty');
            } else {
                // Unknown field â€” check which competition/usertype is currently selected
                const ct = document.getElementById('competitionType');
                const ut = document.getElementById('userType');
                const ctVal = ct ? ct.value : '';
                const utVal = ut ? ut.value : '';
                if (ctVal === 'speedslide')    devLogin('ssc');
                else if (ctVal === 'dailyquiz')     devLogin('quiz');
                else if (ctVal === 'scavengerhunt') devLogin('sh');
                else if (utVal === 'superadmin')    devLogin('superadmin');
                else if (utVal === 'admin')          devLogin('admin');
                else if (utVal === 'manager')        devLogin('manager');
                else if (utVal === 'manager2')       devLogin('manager2');
                else if (utVal === 'jury')           devLogin('jury');
                else devLogin('ssc'); // last resort default
            }
        });

        // -- TRIGGER 2: tap "Login" heading OR version text 5Ã— -------
        let tapCount = 0, tapTimer = null;
        function handleDevTap(e) {
            if (e.target && e.target.closest && (
                e.target.closest('#devTriggerVersion') ||
                e.target.closest('#devTriggerLogin')
            )) {
                tapCount++;
                clearTimeout(tapTimer);
                tapTimer = setTimeout(() => { tapCount = 0; }, 2000);
                if (tapCount >= 5) { tapCount = 0; showDevPanel(); }
            }
        }
        document.addEventListener('click', handleDevTap);
        document.addEventListener('touchend', handleDevTap);

        // -- LOGIN ACTIONS --------------------------------------------
        window.devLogin = async function(role) {
            document.getElementById('devPanel').style.display = 'none';

            // Make sure login section is visible
            const loginSec = document.getElementById('loginSection');
            if (loginSec) loginSec.style.display = 'block';

            if (role === 'superadmin') {
                const ut = document.getElementById('userType');
                if (ut) { ut.value = 'superadmin'; handleUserTypeChange(); }
                setTimeout(() => {
                    const el = document.getElementById('superAdminPassword');
                    if (el) { el.value = superAdminPassword; superAdminLogin(); }
                }, 80);

            } else if (role === 'admin') {
                const ut = document.getElementById('userType');
                if (ut) { ut.value = 'admin'; handleUserTypeChange(); }
                setTimeout(() => {
                    const el = document.getElementById('adminPassword');
                    if (el) { el.value = adminPassword; adminLogin(); }
                }, 80);

            } else if (role === 'manager') {
                const ut = document.getElementById('userType');
                if (ut) { ut.value = 'manager'; handleUserTypeChange(); }
                setTimeout(() => {
                    const el = document.getElementById('managerPassword');
                    if (el) { el.value = managerPassword; managerLogin(); }
                }, 80);

            } else if (role === 'quiz') {
                const ut = document.getElementById('userType');
                const ct = document.getElementById('competitionType');
                if (ut) { ut.value = 'student'; handleUserTypeChange(); }
                if (ct) { ct.value = 'dailyquiz'; handleCompetitionChange(); }
                setTimeout(async () => {
                    const ph = document.getElementById('quizLoginPhone');
                    const pw = document.getElementById('quizLoginPassword');
                    if (ph) ph.value = DEV_PHONE;
                    if (pw) pw.value = DEV_PASS;
                    await loginQuizStudent();
                }, 120);

            } else if (role === 'sh') {
                const ut = document.getElementById('userType');
                const ct = document.getElementById('competitionType');
                if (ut) { ut.value = 'student'; handleUserTypeChange(); }
                if (ct) { ct.value = 'scavengerhunt'; handleCompetitionChange(); }
                setTimeout(async () => {
                    const ph = document.getElementById('shLoginPhone');
                    const pw = document.getElementById('shLoginPassword');
                    if (ph) ph.value = DEV_PHONE;
                    if (pw) pw.value = DEV_PASS;
                    await shLogin();
                }, 120);

            } else if (role === 'ssc') {
                const ut = document.getElementById('userType');
                const ct = document.getElementById('competitionType');
                if (ut) { ut.value = 'student'; handleUserTypeChange(); }
                if (ct) { ct.value = 'speedslide'; handleCompetitionChange(); }
                setTimeout(async () => {
                    const ph = document.getElementById('sscLoginPhone');
                    const pw = document.getElementById('sscLoginPassword');
                    if (ph) ph.value = DEV_PHONE;
                    if (pw) pw.value = DEV_PASS;
                    await sscLogin();
                }, 120);

            } else if (role === 'manager2') {
                const ut = document.getElementById('userType');
                if (ut) { ut.value = 'manager2'; handleUserTypeChange(); }
                setTimeout(() => {
                    const el = document.getElementById('manager2Password');
                    if (el) { el.value = manager2Password; manager2Login(); }
                }, 80);

            } else if (role === 'jury') {
                const ut = document.getElementById('userType');
                if (ut) { ut.value = 'jury'; handleUserTypeChange(); }

            } else if (role === 'faculty') {
                // Scroll to / show the faculty section â€” do NOT auto-select anyone
                const ut = document.getElementById('userType');
                if (ut) { ut.value = 'faculty'; handleUserTypeChange(); }
                // Just pre-fill the master password so the user only needs to pick their name
                setTimeout(() => {
                    const pw = document.getElementById('facultyLoginPwd');
                    if (pw) pw.value = superAdminPassword;
                }, 150);
            }
        };
    })();
    </script>

    <!-- ============================================ -->
    <!-- RULES AND REGULATIONS SECTION                -->
    <!-- TO EDIT: Just change the text below          -->
    <!-- TO ADD PDF: Replace "rules.pdf" with your    -->
    <!-- PDF file name and upload it to same folder   -->
    <!-- ============================================ -->
    <div class="content" style="margin-bottom:30px;margin-top:40px;padding:40px 30px;">
        <div style="text-align:center;margin-bottom:30px;">
            <h2 style="color:#c44569;margin-bottom:20px;">ðŸ“‹ General Rules and Regulations</h2>
            
            <!-- ============================================ -->
            <!-- PDF HANDOUTS SECTION                         -->
            <!-- TO ADD A NEW PDF: Copy one <a> block below   -->
            <!-- and update the href and label text.          -->
            <!-- Upload the PDF file to the same folder.      -->
            <!-- ============================================ -->
            <!-- Dynamic PDF handouts loaded from Firebase by initPublicPdfHandouts() -->
            <div id="publicPdfHandouts" style="display:flex;flex-wrap:wrap;gap:10px;justify-content:center;margin-bottom:20px;">
                <a href="rules.pdf" target="_blank" style="display:inline-flex;align-items:center;gap:8px;background:linear-gradient(135deg,#c44569 0%,#6a1b9a 100%);color:white;padding:12px 24px;border-radius:8px;text-decoration:none;font-weight:600;">
                    ðŸ“„ Complete Rules &amp; Regulations PDF (Coming Soon)
                </a>
                <!-- Faculty-uploaded handouts appear here automatically after admin uploads them -->
            </div>
            <p style="font-size:.82em;color:#888;margin-top:-10px;margin-bottom:10px;">
                ðŸ“Œ <em>PDFs are uploaded by respective event in-charges. Contact your faculty for the latest handout.</em>
            </p>
        </div>

        <!-- ============================================ -->
        <!-- EVENT COORDINATORS                           -->
        <!-- ============================================ -->
        <div style="background:#fff3cd;padding:20px;border-radius:8px;border-left:5px solid #ffc107;margin-bottom:20px;">
            <p style="margin:0;color:#856404;font-weight:600;">ðŸ“Œ Event Coordinators: <strong>Lalitha S K &amp; Priyanka V</strong></p>
        </div>

        <!-- ============================================ -->
        <!-- REGISTRATION + PAYMENT APPROVAL SECTION     -->
        <!-- ============================================ -->
        <div style="border:2px solid #e91e63;border-radius:12px;margin-bottom:24px;overflow:hidden;">
            <!-- Accordion header -->
            <div onclick="toggleLoginAccordion('accRegPayment','arrRegPayment')" style="display:flex;justify-content:space-between;align-items:center;padding:14px 20px;background:linear-gradient(135deg,#fce4ec 0%,#f8bbd0 100%);cursor:pointer;user-select:none;">
                <div style="display:flex;align-items:center;gap:10px;">
                    <span style="font-size:1.1em;">ðŸ’³</span>
                    <strong style="font-size:0.95em;color:#880e4f;">Registration &amp; Payment Approval</strong>
                </div>
                <span id="arrRegPayment" style="font-size:1.1em;color:#e91e63;transition:transform 0.2s;display:inline-block;">â–¶</span>
            </div>
            <!-- Accordion body -->
            <div id="accRegPayment" style="display:none;padding:20px 25px;background:white;border-top:1.5px solid #f48fb1;">
                <p style="color:#4a0020;margin-bottom:12px;line-height:1.7;">
                    <strong>Last date for registration</strong> with one-time Refundable amount 
                    <span style="color:#c44569;font-weight:bold;font-size:1.1em;">â‚¹1,500/-</span> 
                    on or before 
                    <span style="color:#c44569;font-weight:bold;">23rd February, Monday within 3:30 PM</span>.
                </p>
                <div style="background:#fce4ec;border-radius:8px;padding:16px;border-left:5px solid #e91e63;">
                    <p style="margin:0 0 10px 0;color:#333;font-weight:600;">ðŸ“‹ Approval Process:</p>
                    <ol style="margin:0;padding-left:20px;color:#555;line-height:1.9;">
                        <li>Student pays â‚¹1,500/- to the event in-charge (<strong>Lalitha S K</strong> or <strong>Priyanka V</strong>).</li>
                        <li>In-charge verifies receipt of payment and gives <span style="color:#1b5e20;font-weight:700">âœ… Approval</span>.</li>
                        <li>Only approved students may proceed to participate in events.</li>
                        <li>Amount is fully refundable upon meeting all event obligations.</li>
                    </ol>
                </div>
                <div style="margin-top:14px;background:#fff8e1;border-radius:8px;padding:12px 16px;border-left:4px solid #ffa000;">
                    <p style="margin:0;color:#5d4037;font-size:.9em;">
                        âš ï¸ <strong>Note:</strong> Registration without payment confirmation from the in-charge will <strong>not be accepted</strong>. 
                        Please ensure you collect a payment acknowledgement from <strong>Lalitha S K</strong> or <strong>Priyanka V</strong>.
                    </p>
                </div>
            </div>
        </div>

        <!-- ============================================ -->
        <!-- GENERAL RULES                                -->
        <!-- ============================================ -->
        <div style="border:2px solid #f48fb1;border-radius:12px;margin-bottom:16px;overflow:hidden">
            <!-- Accordion header -->
            <div onclick="toggleLoginAccordion('accGenRules','arrGenRules')" style="display:flex;justify-content:space-between;align-items:center;padding:14px 20px;background:#fff0f5;cursor:pointer;user-select:none">
                <div style="display:flex;align-items:center;gap:10px">
                    <span style="font-size:1.1em">ðŸ“œ</span>
                    <strong style="font-size:0.95em;color:#c44569">General Rules and Regulations</strong>
                </div>
                <span id="arrGenRules" style="font-size:1.1em;color:#c44569;transition:transform 0.2s;display:inline-block">â–¶</span>
            </div>
            <!-- Accordion body -->
            <div id="accGenRules" style="display:none;padding:20px 25px;background:white;border-top:1.5px solid #f48fb1">
            <h3 style="color:#c44569;margin-bottom:14px;font-size:1.1em;">ðŸ“œ General Rules</h3>
            <ol style="line-height:1.8;color:#333;">
                <li style="margin-bottom:15px;">
                    <strong>Last date for registration</strong> with one time Refundable amount 
                    <span style="color:#c44569;font-weight:bold;">â‚¹1,500/-</span> 
                    on or before 
                    <span style="color:#c44569;font-weight:bold;">23rd February, Monday within 3:30 PM</span>.
                </li>
                <li style="margin-bottom:15px;">
                    <strong>Last date for submission of Music and Work Organising batch</strong> 
                    on or before 
                    <span style="color:#c44569;font-weight:bold;">7th March, Saturday</span>.
                </li>
                <li style="margin-bottom:15px;">
                    Students arriving late (Event and for the Class registration on the date of event) 
                    or absent for the event will be fined 
                    <span style="color:#c44569;font-weight:bold;">â‚¹500/- per day</span>.
                </li>
                <li style="margin-bottom:15px;">
                    Teams not submitting Music, or any other assignments with respect to the event, 
                    on date and time, will lead into 
                    <span style="color:#c44569;font-weight:bold;">non-refund of deposit â‚¹1,500/-</span>.
                </li>
            </ol>
            </div><!-- /accGenRules body -->
        </div><!-- /accGenRules accordion -->

        <!-- ============================================ -->
        <!-- SPURTHI YOUTH FEST â€” EVENT SCHEDULE TABLE    -->
        <!-- Festival Date: 18.03.2026                    -->
        <!-- ============================================ -->
        <div style="border:2px solid #ce93d8;border-radius:12px;margin-bottom:16px;overflow:hidden">
            <!-- Accordion header -->
            <div onclick="toggleLoginAccordion('accEventSched','arrEventSched')" style="display:flex;justify-content:space-between;align-items:center;padding:14px 20px;background:#f3e5f5;cursor:pointer;user-select:none">
                <div style="display:flex;align-items:center;gap:10px">
                    <span style="font-size:1.1em">ðŸ“…</span>
                    <strong style="font-size:0.95em;color:#6a1b9a">Spurthi Youth Festival â€” Event Schedule (18.03.2026)</strong>
                </div>
                <span id="arrEventSched" style="font-size:1.1em;color:#6a1b9a;transition:transform 0.2s;display:inline-block">â–¶</span>
            </div>
            <!-- Accordion body -->
            <div id="accEventSched" style="display:none;padding:20px 20px 10px;background:white;border-top:1.5px solid #ce93d8">
            <h3 style="color:#6a1b9a;margin-bottom:16px;font-size:1.1em;">ðŸ“… Spurthi Youth Festival â€” Event Schedule (18.03.2026)</h3>
            <div style="overflow-x:auto;border-radius:12px;box-shadow:0 4px 20px rgba(0,0,0,.1);">
                <table style="width:100%;border-collapse:collapse;background:white;font-size:.88em;">
                    <thead>
                        <tr style="background:linear-gradient(135deg,#6a1b9a 0%,#c44569 100%);color:white;">
                            <th style="padding:11px 10px;text-align:center;white-space:nowrap">Sl.<br>No.</th>
                            <th style="padding:11px 10px;text-align:left;white-space:nowrap">On Stage / Off Stage</th>
                            <th style="padding:11px 10px;text-align:left;white-space:nowrap">Class</th>
                            <th style="padding:11px 10px;text-align:left;white-space:nowrap">In-charge</th>
                            <th style="padding:11px 10px;text-align:left;white-space:nowrap">I Meeting Timings</th>
                            <th style="padding:11px 10px;text-align:left;white-space:nowrap">II Meeting Timings</th>
                            <th style="padding:11px 10px;text-align:center;white-space:nowrap">Event Start Date</th>
                            <th style="padding:11px 10px;text-align:center;white-space:nowrap">Event End Date</th>
                            <th style="padding:11px 10px;text-align:center;white-space:nowrap">Event Start Time</th>
                            <th style="padding:11px 10px;text-align:center;white-space:nowrap">Event End Time</th>
                        </tr>
                    </thead>
                    <tbody id="eventScheduleBody">
                        <!-- â”€â”€ ROW TEMPLATE (copy & paste to add events) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                        <tr style="background:#fafafa;border-bottom:1px solid #eee;">
                            <td style="padding:9px 10px;text-align:center;font-weight:700;color:#6a1b9a">N</td>
                            <td style="padding:9px 10px;font-weight:600">Event Name (On/Off stage)</td>
                            <td style="padding:9px 10px">Class</td>
                            <td style="padding:9px 10px">In-charge Name</td>
                            <td style="padding:9px 10px;font-size:.82em">Date at HH:MM to HH:MM</td>
                            <td style="padding:9px 10px;font-size:.82em">Date at HH:MM to HH:MM</td>
                            <td style="padding:9px 10px;text-align:center">DD-MM-YYYY</td>
                            <td style="padding:9px 10px;text-align:center">HH:MM am/pm</td>
                            <td style="padding:9px 10px;text-align:center">DD-MM-YYYY</td>
                            <td style="padding:9px 10px;text-align:center">HH:MM am/pm</td>
                        </tr>
                        â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
                        <tr style="background:#fafafa;border-bottom:1px solid #eee;">
                            <td style="padding:9px 10px;text-align:center;font-weight:700;color:#6a1b9a">1</td>
                            <td style="padding:9px 10px;font-weight:600">Mime (On stage)</td>
                            <td style="padding:9px 10px">I BCA / II BCA 'B'</td>
                            <td style="padding:9px 10px">Priyanka V / Kotrappa K</td>
                            <td style="padding:9px 10px;font-size:.82em">Feb 24th at 1:00â€“1:15 pm</td>
                            <td style="padding:9px 10px;font-size:.82em">March 4th at 1:00â€“1:15 pm</td>
                            <td style="padding:9px 10px;text-align:center;color:#888">â€”</td>
                            <td style="padding:9px 10px;text-align:center;color:#888">â€”</td>
                        </tr>
                        <tr style="background:white;border-bottom:1px solid #eee;">
                            <td style="padding:9px 10px;text-align:center;font-weight:700;color:#6a1b9a">2</td>
                            <td style="padding:9px 10px;font-weight:600">Social Awareness Skit (On stage)</td>
                            <td style="padding:9px 10px">III BBA / II BCA "A"</td>
                            <td style="padding:9px 10px">Shankar B C / Smitha M</td>
                            <td style="padding:9px 10px;font-size:.82em">Feb 27th at 1:00â€“1:15 pm</td>
                            <td style="padding:9px 10px;font-size:.82em">March 7th at 1:00â€“1:15 pm</td>
                            <td style="padding:9px 10px;text-align:center;color:#888">â€”</td>
                            <td style="padding:9px 10px;text-align:center;color:#888">â€”</td>
                        </tr>
                        <tr style="background:#fafafa;border-bottom:1px solid #eee;">
                            <td style="padding:9px 10px;text-align:center;font-weight:700;color:#6a1b9a">3</td>
                            <td style="padding:9px 10px;font-weight:600">Group Dance (On stage)</td>
                            <td style="padding:9px 10px">III BCA 'C' / III BCA 'B'</td>
                            <td style="padding:9px 10px">Anitha N / Pooja C</td>
                            <td style="padding:9px 10px;font-size:.82em">Feb 26th at 1:00â€“1:15 pm</td>
                            <td style="padding:9px 10px;font-size:.82em">March 6th at 1:00â€“1:15 pm</td>
                            <td style="padding:9px 10px;text-align:center;color:#888">â€”</td>
                            <td style="padding:9px 10px;text-align:center;color:#888">â€”</td>
                        </tr>
                        <tr style="background:white;border-bottom:1px solid #eee;">
                            <td style="padding:9px 10px;text-align:center;font-weight:700;color:#6a1b9a">4</td>
                            <td style="padding:9px 10px;font-weight:600">Mad Ads (On stage)</td>
                            <td style="padding:9px 10px">I BCOM / I BCA</td>
                            <td style="padding:9px 10px">Shilpa R Y / Roopa M C</td>
                            <td style="padding:9px 10px;font-size:.82em">Feb 27th at 3:15â€“3:30 pm</td>
                            <td style="padding:9px 10px;font-size:.82em">March 9th at 3:15â€“3:30 pm</td>
                            <td style="padding:9px 10px;text-align:center;color:#888">â€”</td>
                            <td style="padding:9px 10px;text-align:center;color:#888">â€”</td>
                        </tr>
                        <tr style="background:#fafafa;border-bottom:1px solid #eee;">
                            <td style="padding:9px 10px;text-align:center;font-weight:700;color:#6a1b9a">5</td>
                            <td style="padding:9px 10px;font-weight:600">Ramp Walk (On stage)</td>
                            <td style="padding:9px 10px">II BBA / III B.Com</td>
                            <td style="padding:9px 10px">Hemavathi D / Chandan G B</td>
                            <td style="padding:9px 10px;font-size:.82em">Feb 24th at 3:15â€“3:30 pm</td>
                            <td style="padding:9px 10px;font-size:.82em">Feb 28th at 3:15â€“3:30 pm</td>
                            <td style="padding:9px 10px;text-align:center;color:#888">â€”</td>
                            <td style="padding:9px 10px;text-align:center;color:#888">â€”</td>
                        </tr>
                        <tr style="background:white;border-bottom:1px solid #eee;">
                            <td style="padding:9px 10px;text-align:center;font-weight:700;color:#6a1b9a">6</td>
                            <td style="padding:9px 10px;font-weight:600">Pod Casting</td>
                            <td style="padding:9px 10px">III BCOM / II BBA</td>
                            <td style="padding:9px 10px">Chandan G B / Hemavathi D</td>
                            <td style="padding:9px 10px;font-size:.82em">Feb 23rd at 12:45â€“1:00 pm</td>
                            <td style="padding:9px 10px;font-size:.82em">March 2nd at 12:45â€“1:00 pm</td>
                            <td style="padding:9px 10px;text-align:center;font-weight:600;color:#1b5e20">02-03-2026</td>
                            <td style="padding:9px 10px;text-align:center;font-weight:600;color:#b71c1c">07-03-2026</td>
                        </tr>
                        <tr style="background:#fafafa;border-bottom:1px solid #eee;">
                            <td style="padding:9px 10px;text-align:center;font-weight:700;color:#6a1b9a">7</td>
                            <td style="padding:9px 10px;font-weight:600">Nukkad Natak</td>
                            <td style="padding:9px 10px">II BCA "B" / III BBA</td>
                            <td style="padding:9px 10px">Kotrappa K / Shankar B C</td>
                            <td style="padding:9px 10px;font-size:.82em">Feb 28th at 1:00â€“1:15 pm</td>
                            <td style="padding:9px 10px;font-size:.82em">March 7th at 10:30â€“10:45 am</td>
                            <td style="padding:9px 10px;text-align:center;font-weight:600;color:#1b5e20">09-03-2026</td>
                            <td style="padding:9px 10px;text-align:center;font-weight:600;color:#b71c1c">14-03-2026</td>
                        </tr>
                        <tr style="background:white;border-bottom:1px solid #eee;">
                            <td style="padding:9px 10px;text-align:center;font-weight:700;color:#6a1b9a">8</td>
                            <td style="padding:9px 10px;font-weight:600">Talent Hunt</td>
                            <td style="padding:9px 10px">III BCA "B" / III BCA A</td>
                            <td style="padding:9px 10px">Anitha N / Pooja C</td>
                            <td style="padding:9px 10px;font-size:.82em">Feb 28th at 3:15â€“3:30 pm</td>
                            <td style="padding:9px 10px;font-size:.82em">March 9th at 1:00â€“1:15 pm</td>
                            <td style="padding:9px 10px;text-align:center;color:#888">â€”</td>
                            <td style="padding:9px 10px;text-align:center;font-weight:600;color:#b71c1c">14-03-2026</td>
                        </tr>
                        <tr style="background:#fafafa;border-bottom:1px solid #eee;">
                            <td style="padding:9px 10px;text-align:center;font-weight:700;color:#6a1b9a">9</td>
                            <td style="padding:9px 10px;font-weight:600">YouTube Advertisement</td>
                            <td style="padding:9px 10px">I BCA "A" / II BCA 'A'</td>
                            <td style="padding:9px 10px">Roopa M C / Smitha M</td>
                            <td style="padding:9px 10px;font-size:.82em">Feb 25th at 12:45â€“1:00 pm</td>
                            <td style="padding:9px 10px;font-size:.82em">March 5th at 12:45â€“1:00 pm</td>
                            <td style="padding:9px 10px;text-align:center;font-weight:600;color:#1b5e20">02-03-2026</td>
                            <td style="padding:9px 10px;text-align:center;font-weight:600;color:#b71c1c">07-03-2026</td>
                        </tr>
                        <tr style="background:white;border-bottom:1px solid #eee;">
                            <td style="padding:9px 10px;text-align:center;font-weight:700;color:#6a1b9a">10</td>
                            <td style="padding:9px 10px;font-weight:600">Case Analysis</td>
                            <td style="padding:9px 10px">I BCOM / I BCA 'A'</td>
                            <td style="padding:9px 10px">Shilpa R Y / Roopa M C</td>
                            <td style="padding:9px 10px;font-size:.82em">Feb 25th at 1:00â€“1:15 pm</td>
                            <td style="padding:9px 10px;font-size:.82em">March 5th at 1:00â€“1:15 pm</td>
                            <td style="padding:9px 10px;text-align:center;font-weight:600;color:#1b5e20">09-03-2026</td>
                            <td style="padding:9px 10px;text-align:center;font-weight:600;color:#b71c1c">10-03-2026</td>
                        </tr>
                        <tr style="background:#fafafa;border-bottom:1px solid #eee;">
                            <td style="padding:9px 10px;text-align:center;font-weight:700;color:#6a1b9a">11</td>
                            <td style="padding:9px 10px;font-weight:600">Interdisciplinary</td>
                            <td style="padding:9px 10px">II BBA / II BCOM</td>
                            <td style="padding:9px 10px">Hemavathi D / Lalitha S K</td>
                            <td style="padding:9px 10px;font-size:.82em">Feb 23rd at 1:00â€“1:15 pm</td>
                            <td style="padding:9px 10px;font-size:.82em">March 2nd at 1:00â€“1:15 pm</td>
                            <td style="padding:9px 10px;text-align:center;font-weight:600;color:#1b5e20">02-03-2026</td>
                            <td style="padding:9px 10px;text-align:center;font-weight:600;color:#b71c1c">07-03-2026</td>
                        </tr>
                        <tr style="background:white;border-bottom:1px solid #eee;">
                            <td style="padding:9px 10px;text-align:center;font-weight:700;color:#6a1b9a">12</td>
                            <td style="padding:9px 10px;font-weight:600">Quiz</td>
                            <td style="padding:9px 10px">III BCA "B" / II BCA "A"</td>
                            <td style="padding:9px 10px">Smitha M / Pooja C</td>
                            <td style="padding:9px 10px;font-size:.82em">Feb 24th at 12:45â€“1:00 pm</td>
                            <td style="padding:9px 10px;font-size:.82em">March 4th at 12:45â€“1:00 pm</td>
                            <td style="padding:9px 10px;text-align:center;font-weight:600;color:#1b5e20">02-03-2026</td>
                            <td style="padding:9px 10px;text-align:center;font-weight:600;color:#b71c1c">12-03-2026</td>
                        </tr>
                        <tr style="background:#fafafa;border-bottom:1px solid #eee;">
                            <td style="padding:9px 10px;text-align:center;font-weight:700;color:#6a1b9a">13</td>
                            <td style="padding:9px 10px;font-weight:600">Vlog</td>
                            <td style="padding:9px 10px">III BCOM</td>
                            <td style="padding:9px 10px">Chandan G B / Priyanka V</td>
                            <td style="padding:9px 10px;font-size:.82em">Feb 26th at 12:45â€“1:00 pm</td>
                            <td style="padding:9px 10px;font-size:.82em">March 6th at 12:45â€“1:00 pm</td>
                            <td style="padding:9px 10px;text-align:center;font-weight:600;color:#1b5e20">02-03-2026</td>
                            <td style="padding:9px 10px;text-align:center;font-weight:600;color:#b71c1c">07-03-2026</td>
                        </tr>
                        <tr style="background:white;border-bottom:1px solid #eee;">
                            <td style="padding:9px 10px;text-align:center;font-weight:700;color:#6a1b9a">14</td>
                            <td style="padding:9px 10px;font-weight:600">Hand Writing</td>
                            <td style="padding:9px 10px">III BCA "A" / III BCA "C"</td>
                            <td style="padding:9px 10px">Kotrappa K / Anitha N</td>
                            <td style="padding:9px 10px;font-size:.82em">Feb 27th at 12:45â€“1:00 pm</td>
                            <td style="padding:9px 10px;font-size:.82em">March 7th at 12:45â€“1:00 pm</td>
                            <td style="padding:9px 10px;text-align:center;color:#888">â€”</td>
                            <td style="padding:9px 10px;text-align:center;font-weight:600;color:#b71c1c">11-03-2026</td>
                        </tr>
                        <tr style="background:#fafafa;border-bottom:1px solid #eee;">
                            <td style="padding:9px 10px;text-align:center;font-weight:700;color:#6a1b9a">15</td>
                            <td style="padding:9px 10px;font-weight:600">Best Out of Waste</td>
                            <td style="padding:9px 10px">II BCOM / III BBA</td>
                            <td style="padding:9px 10px">Lalitha S K / Shankar B C</td>
                            <td style="padding:9px 10px;font-size:.82em">Feb 28th at 12:45â€“1:00 pm</td>
                            <td style="padding:9px 10px;font-size:.82em">March 7th at 3:15â€“3:30 pm</td>
                            <td style="padding:9px 10px;text-align:center;color:#888">â€”</td>
                            <td style="padding:9px 10px;text-align:center;font-weight:600;color:#b71c1c">13-03-2026</td>
                        </tr>
                        <!-- â”€â”€ ADD MORE EVENT ROWS ABOVE THIS LINE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
                    </tbody>
                </table>
            </div>
            <p style="font-size:.8em;color:#888;margin-top:8px;">
                ðŸ“Œ <em>To add more events, copy a &lt;tr&gt; row block inside the table and fill in the details.</em>
            </p>
            </div><!-- /accEventSched body -->
        </div><!-- /accEventSched accordion -->
    </div>
    <!-- ============================================ -->
    <!-- END OF RULES SECTION                         -->
    <!-- ============================================ -->
    
    <!-- Footer -->
    <!-- ============================================================ -->
    <!-- FEEDBACK POPUP MODAL                                         -->
    <!-- Triggered by Super Admin via Firebase feedbackSettings       -->
    <!-- ============================================================ -->
    <div id="feedbackPopupOverlay" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.7);z-index:99990;overflow-y:auto;padding:20px;box-sizing:border-box">
        <div style="background:white;border-radius:20px;max-width:600px;margin:20px auto;box-shadow:0 12px 50px rgba(0,0,0,0.4);overflow:hidden;position:relative">
            <!-- Header -->
            <div class="fb-modal-header" style="background:linear-gradient(135deg,#880e4f,#c2185b,#e91e63);padding:24px 28px;color:white;position:relative">
                <h2 style="margin:0 0 4px;font-size:1.4em">ðŸ“‹ Spurthi Youth Fest 2026 â€” Feedback</h2>
                <p style="margin:0;opacity:0.9;font-size:0.9em">Your feedback helps us make next year even better! ðŸŽ‰</p>
                <button id="fbPopupCloseBtn" onclick="closeFeedbackPopup()" style="position:absolute;top:16px;right:16px;background:rgba(255,255,255,0.2);color:white;border:none;border-radius:50%;width:32px;height:32px;font-size:1.1em;cursor:pointer;font-weight:700;line-height:1">âœ•</button>
            </div>

            <div style="padding:24px 28px" id="feedbackFormBody">
                <!-- Name field (auto-filled if logged in quiz student) -->
                <div style="margin-bottom:18px">
                    <label style="font-weight:700;color:#555;font-size:0.95em;display:block;margin-bottom:6px">ðŸ‘¤ Your Name <span style="color:#c2185b">*</span></label>
                    <input type="text" id="fbName" placeholder="Enter your name..." style="width:100%;padding:11px 14px;border:2px solid #f48fb1;border-radius:10px;font-size:0.95em;box-sizing:border-box;outline:none">
                </div>

                <!-- Phone â€” hidden for logged-in students, shown for visitors -->
                <div style="margin-bottom:18px" id="fbPhoneRow">
                    <label style="font-weight:700;color:#555;font-size:0.95em;display:block;margin-bottom:6px">ðŸ“± Phone Number <span style="color:#c2185b">*</span></label>
                    <input type="tel" id="fbPhone" placeholder="e.g. 9876543210" maxlength="15" style="width:100%;padding:11px 14px;border:2px solid #f48fb1;border-radius:10px;font-size:0.95em;box-sizing:border-box;outline:none">
                    <small style="color:#888;margin-top:4px;display:block">Used only to prevent duplicate submissions. Not shared with anyone.</small>
                </div>

                <!-- Class / Designation with Others option -->
                <div style="margin-bottom:18px">
                    <label style="font-weight:700;color:#555;font-size:0.95em;display:block;margin-bottom:6px">ðŸ« Class / Designation <span style="color:#c2185b">*</span></label>
                    <select id="fbClassSelect" onchange="fbHandleClassChange(this.value)" style="width:100%;padding:11px 14px;border:2px solid #f48fb1;border-radius:10px;font-size:0.95em;box-sizing:border-box;outline:none;background:white;cursor:pointer">
                        <option value="">â€” Select your class / role â€”</option>
                        <option value="I BCA A">I BCA A</option>
                        <option value="I BCA B">I BCA B</option>
                        <option value="II BCA A">II BCA A</option>
                        <option value="II BCA B">II BCA B</option>
                        <option value="III BCA A">III BCA A</option>
                        <option value="III BCA B">III BCA B</option>
                        <option value="I BBA A">I BBA A</option>
                        <option value="I BBA B">I BBA B</option>
                        <option value="II BBA A">II BBA A</option>
                        <option value="II BBA B">II BBA B</option>
                        <option value="III BBA A">III BBA A</option>
                        <option value="III BBA B">III BBA B</option>
                        <option value="Faculty">Faculty</option>
                        <option value="Staff">Staff</option>
                        <option value="Guest / Visitor">Guest / Visitor</option>
                        <option value="others">âœï¸ Others (type below)</option>
                    </select>
                    <input type="text" id="fbClassOther" placeholder="Please specify your class or designation..." style="display:none;width:100%;padding:11px 14px;border:2px solid #f48fb1;border-radius:10px;font-size:0.95em;box-sizing:border-box;outline:none;margin-top:8px">
                    <input type="hidden" id="fbClass">
                </div>

                <!-- Overall Fest Score 1-10 -->
                <div style="margin-bottom:22px;background:#fce4ec;padding:16px;border-radius:12px;border-left:4px solid #e91e63">
                    <label style="font-weight:700;color:#880e4f;font-size:0.95em;display:block;margin-bottom:10px">ðŸ“ Overall Fest Experience (1 = Poor, 10 = Excellent) <span style="color:#c2185b">*</span></label>
                    <div style="display:flex;gap:8px;flex-wrap:wrap" id="fbOverallScoreRow">
                        <!-- 1-10 buttons generated by JS -->
                    </div>
                    <input type="hidden" id="fbOverallScore" value="">
                </div>

                <!-- Event Star Ratings -->
                <div id="fbEventRatingsSection" style="margin-bottom:22px">
                    <h4 style="color:#4a148c;margin:0 0 12px;font-size:1em">â­ Rate Each Event (1â€“5 Stars)</h4>
                    <div id="fbEventRatingsList">
                        <!-- Populated dynamically from Firebase event list -->
                    </div>
                </div>

                <!-- Recommend -->
                <div style="margin-bottom:22px;background:#e8f5e9;padding:16px;border-radius:12px;border-left:4px solid #43a047">
                    <label style="font-weight:700;color:#2e7d32;font-size:0.95em;display:block;margin-bottom:10px">ðŸŽ¯ Would you recommend Spurthi Youth Fest to others? <span style="color:#c2185b">*</span></label>
                    <div style="display:flex;gap:10px;flex-wrap:wrap">
                        <button type="button" onclick="fbSetRecommend('yes',this)" class="fb-recommend-btn" style="padding:10px 24px;border:2px solid #43a047;border-radius:20px;background:white;color:#2e7d32;font-weight:700;cursor:pointer;font-size:0.95em;transition:all 0.2s">ðŸ‘ Yes!</button>
                        <button type="button" onclick="fbSetRecommend('maybe',this)" class="fb-recommend-btn" style="padding:10px 24px;border:2px solid #ff9800;border-radius:20px;background:white;color:#e65100;font-weight:700;cursor:pointer;font-size:0.95em;transition:all 0.2s">ðŸ¤” Maybe</button>
                        <button type="button" onclick="fbSetRecommend('no',this)" class="fb-recommend-btn" style="padding:10px 24px;border:2px solid #f44336;border-radius:20px;background:white;color:#c62828;font-weight:700;cursor:pointer;font-size:0.95em;transition:all 0.2s">ðŸ‘Ž No</button>
                    </div>
                    <input type="hidden" id="fbRecommend" value="">
                </div>

                <!-- Suggestions -->
                <div style="margin-bottom:22px">
                    <label style="font-weight:700;color:#555;font-size:0.95em;display:block;margin-bottom:6px">ðŸ’¬ Suggestions / Comments (Optional)</label>
                    <textarea id="fbSuggestions" rows="3" placeholder="Any suggestions to improve next year's fest? We'd love to hear from you!" style="width:100%;padding:11px 14px;border:2px solid #ce93d8;border-radius:10px;font-size:0.93em;box-sizing:border-box;outline:none;resize:vertical"></textarea>
                </div>

                <!-- Custom Q7 -->
                <div id="fbCustomQ7Wrap" style="margin-bottom:22px;background:#f3e5f5;padding:16px;border-radius:12px;border-left:4px solid #7b1fa2">
                    <label id="fbCustomQ7Label" style="font-weight:700;color:#4a148c;font-size:0.95em;display:block;margin-bottom:10px">ðŸŽ¨ How was the organisation and coordination of the events? <span id="fbCustomQ7ReqStar" style="color:#c2185b">*</span></label>
                    <!-- rate3 buttons -->
                    <div id="fbCustomQ7Rate3" style="display:flex;gap:10px;flex-wrap:wrap">
                        <button type="button" onclick="fbSetCustomQ(7,'yes',this)" class="fb-cq7-btn" style="padding:10px 24px;border:2px solid #43a047;border-radius:20px;background:white;color:#2e7d32;font-weight:700;cursor:pointer;font-size:0.95em;transition:all 0.2s">ðŸ‘ Yes</button>
                        <button type="button" onclick="fbSetCustomQ(7,'maybe',this)" class="fb-cq7-btn" style="padding:10px 24px;border:2px solid #ff9800;border-radius:20px;background:white;color:#e65100;font-weight:700;cursor:pointer;font-size:0.95em;transition:all 0.2s">ðŸ¤” Maybe</button>
                        <button type="button" onclick="fbSetCustomQ(7,'no',this)" class="fb-cq7-btn" style="padding:10px 24px;border:2px solid #f44336;border-radius:20px;background:white;color:#c62828;font-weight:700;cursor:pointer;font-size:0.95em;transition:all 0.2s">ðŸ‘Ž No</button>
                    </div>
                    <!-- score10 buttons -->
                    <div id="fbCustomQ7Score10" style="display:none;flex-wrap:wrap;gap:8px"></div>
                    <!-- textarea -->
                    <textarea id="fbCustomQ7Textarea" rows="2" style="display:none;width:100%;padding:11px 14px;border:2px solid #ce93d8;border-radius:10px;font-size:0.93em;box-sizing:border-box;outline:none;resize:vertical" placeholder="Your answer..."></textarea>
                    <input type="hidden" id="fbCustomQ7Val" value="">
                </div>

                <!-- Custom Q8 -->
                <div id="fbCustomQ8Wrap" style="margin-bottom:22px;background:#e8f5e9;padding:16px;border-radius:12px;border-left:4px solid #2e7d32">
                    <label id="fbCustomQ8Label" style="font-weight:700;color:#1b5e20;font-size:0.95em;display:block;margin-bottom:10px">ðŸ”¢ How would you rate the overall ambience and decoration? <span id="fbCustomQ8ReqStar" style="color:#c2185b">*</span></label>
                    <!-- rate3 buttons -->
                    <div id="fbCustomQ8Rate3" style="display:none;flex-wrap:wrap;gap:10px">
                        <button type="button" onclick="fbSetCustomQ(8,'yes',this)" class="fb-cq8-btn" style="padding:10px 24px;border:2px solid #43a047;border-radius:20px;background:white;color:#2e7d32;font-weight:700;cursor:pointer;font-size:0.95em;transition:all 0.2s">ðŸ‘ Yes</button>
                        <button type="button" onclick="fbSetCustomQ(8,'maybe',this)" class="fb-cq8-btn" style="padding:10px 24px;border:2px solid #ff9800;border-radius:20px;background:white;color:#e65100;font-weight:700;cursor:pointer;font-size:0.95em;transition:all 0.2s">ðŸ¤” Maybe</button>
                        <button type="button" onclick="fbSetCustomQ(8,'no',this)" class="fb-cq8-btn" style="padding:10px 24px;border:2px solid #f44336;border-radius:20px;background:white;color:#c62828;font-weight:700;cursor:pointer;font-size:0.95em;transition:all 0.2s">ðŸ‘Ž No</button>
                    </div>
                    <!-- score10 buttons -->
                    <div id="fbCustomQ8Score10" style="display:flex;flex-wrap:wrap;gap:8px"></div>
                    <!-- textarea -->
                    <textarea id="fbCustomQ8Textarea" rows="2" style="display:none;width:100%;padding:11px 14px;border:2px solid #a5d6a7;border-radius:10px;font-size:0.93em;box-sizing:border-box;outline:none;resize:vertical" placeholder="Your answer..."></textarea>
                    <input type="hidden" id="fbCustomQ8Val" value="">
                </div>

                <!-- Custom Q9 -->
                <div id="fbCustomQ9Wrap" style="margin-bottom:22px;background:#e3f2fd;padding:16px;border-radius:12px;border-left:4px solid #0d47a1">
                    <label id="fbCustomQ9Label" style="font-weight:700;color:#0d47a1;font-size:0.95em;display:block;margin-bottom:10px">ðŸ“ Any specific event or moment that stood out for you? <span id="fbCustomQ9ReqStar" style="color:#c2185b;display:none"></span></label>
                    <!-- rate3 buttons -->
                    <div id="fbCustomQ9Rate3" style="display:none;flex-wrap:wrap;gap:10px">
                        <button type="button" onclick="fbSetCustomQ(9,'yes',this)" class="fb-cq9-btn" style="padding:10px 24px;border:2px solid #43a047;border-radius:20px;background:white;color:#2e7d32;font-weight:700;cursor:pointer;font-size:0.95em;transition:all 0.2s">ðŸ‘ Yes</button>
                        <button type="button" onclick="fbSetCustomQ(9,'maybe',this)" class="fb-cq9-btn" style="padding:10px 24px;border:2px solid #ff9800;border-radius:20px;background:white;color:#e65100;font-weight:700;cursor:pointer;font-size:0.95em;transition:all 0.2s">ðŸ¤” Maybe</button>
                        <button type="button" onclick="fbSetCustomQ(9,'no',this)" class="fb-cq9-btn" style="padding:10px 24px;border:2px solid #f44336;border-radius:20px;background:white;color:#c62828;font-weight:700;cursor:pointer;font-size:0.95em;transition:all 0.2s">ðŸ‘Ž No</button>
                    </div>
                    <!-- score10 buttons -->
                    <div id="fbCustomQ9Score10" style="display:none;flex-wrap:wrap;gap:8px"></div>
                    <!-- textarea -->
                    <textarea id="fbCustomQ9Textarea" rows="2" style="display:block;width:100%;padding:11px 14px;border:2px solid #90caf9;border-radius:10px;font-size:0.93em;box-sizing:border-box;outline:none;resize:vertical" placeholder="Your answer..."></textarea>
                    <input type="hidden" id="fbCustomQ9Val" value="">
                </div>

                <div id="fbPopupMsg" style="margin-bottom:12px"></div>
                <button onclick="submitFeedback()" style="width:100%;background:linear-gradient(135deg,#880e4f,#c2185b,#e91e63);color:white;border:none;border-radius:12px;padding:15px;font-size:1.1em;font-weight:700;cursor:pointer;box-shadow:0 4px 15px rgba(194,24,91,0.4);letter-spacing:0.5px">ðŸš€ Submit Feedback</button>
                <p style="text-align:center;color:#aaa;font-size:0.8em;margin-top:10px">Your response is anonymous and helps us improve! ðŸ’ª</p>
            </div>
        </div>
    </div>
    <!-- ============================================================ -->
    <!-- END FEEDBACK POPUP MODAL                                     -->
    <!-- ============================================================ -->

<!-- VERSION HISTORY
v4.57 | Feb 27 2026 01:30 IST | Quiz text-input type restored
v4.58 | Feb 27 2026 07:15 IST | Published quiz shows images & audio
v4.59 | Feb 27 2026 13:10 IST | Quiz Archive added
v4.60 | Feb 27 2026 14:45 IST | Post-feedback thank-you screen shows Chandan G B & Priyanka V responsibilities
v4.61 | Feb 27 2026 15:10 IST | Vlog monitor empty-state replaced with class-card layout matching YouTube Ad panel
v4.62 | Feb 27 2026 15:35 IST | Fixed vlog team grouping to strictly 2 members per team; Chandan panel shows enrolled participant names per team
v4.63 | Feb 27 2026 15:55 IST | Vlog topics updated to Travel/Food/Event/Daily Life; Chandan panel now shows all classes with vlog enrollments
v4.64 | Feb 27 2026 16:10 IST | Vlog topic emojis added in dropdown options and enrollment form cards
v4.65 | Feb 27 2026 16:25 IST | Fixed class name normalization so all enrollment variants merge into correct team buckets
v4.66 | Feb 27 2026 16:50 IST | Registration & Payment Approval segment added inside General Rules accordion under point 1
v4.67 | Feb 27 2026 14:09 IST | Registration & Payment Approval card converted to accordion with â–¶/â–¼ toggle
v4.68 | Feb 27 2026 14:09 IST | All Teams Overview table added to Chandan GB / Hemavathi D podcast panel
v4.69 | Feb 27 2026 14:09 IST | Sub-topic column added to podcast All Teams Overview table
v4.70 | Feb 27 2026 14:31 IST | Removed redundant bottom Refresh All Teams button from Vlog panel
v4.71 | Feb 27 2026 14:31 IST | BOW team numbers now globally unique across all classes (Team 1, 2, 3â€¦ not restarting per class)
v4.72 | Feb 27 2026 14:31 IST | BOW jury sheet & SA live monitor now show global team numbers (Team 1, 2, 3â€¦) not per-class numbers
v4.73 | Feb 27 2026 14:31 IST | Fixed missing isBOW variable in SA live monitor causing loading freeze
v4.74 | Feb 27 2026 14:31 IST | Fixed missing membersPerTeam variable in SA live monitor multiteam block
v4.75 | Feb 27 2026 15:20 IST | Added Group Dance story tab in CR; story visible to jury, SA live monitor, and Anitha N/Pooja C incharge panel
v4.76 | Feb 27 2026 16:10 IST | Dance Performance Title & Story Summary shown prominently (first) in Anitha N / Pooja C incharge panel
v4.77 | Feb 27 2026 16:30 IST | Dance Title & Story Summary now visible inside Group Dance card in generic incharge panel for Anitha N / Pooja C
v4.78 | Feb 27 2026 16:45 IST | Fixed Cloudflare Worker fetch to use POST so health-check no longer gets 405 Method Not Allowed
v4.79 | Feb 27 2026 17:00 IST | Cloudinary stats worker fetch reverted to GET; worker template updated with CORS OPTIONS; warning added that stats worker must be separate from email worker
v4.80 | Feb 27 2026 17:05 IST | Event schedule column order fixed: Start Date, End Date, Start Time, End Time
v4.87 | Feb 28 2026 10:50 IST | Firebase Presence (Live Now panel) + PWA Push Notifications (SA send panel + student banner) added
v4.90 | Feb 28 2026 14:37 IST | Push panel redesigned: inline registered devices list + inline notification history with seen/opened tracking; popups removed
v4.91 | Feb 28 2026 14:56 IST | Registered Devices panel now collapsible (hidden by default) with filter by class / guest
v4.92 | Feb 28 2026 16:56 IST | Student & CR login now require phone + quiz password (class-locked); push banner shows once in all sections
v4.93 | Feb 28 2026 17:10 IST | /*- dev trigger now skips password fields so quiz password box no longer opens dev panel
v4.94 | Feb 28 2026 17:25 IST | Push notification banner fixed to truly show only once â€” removed duplicate display:flex from HTML and added session guard
v4.95 | Feb 28 2026 17:35 IST | /*- in quiz password field of Student and CR login now bypasses all auth rules and logs in directly
v4.96 | Feb 28 2026 17:50 IST | Live Now and Notifications panels clear data when switching away â€” reload fresh on each tab click
v4.97 | Feb 28 2026 17:38 IST | Live Now and Notifications panels now properly hidden when switching to any other tab
v4.98 | Feb 28 2026 19:16 IST | In-app real-time notification toast added via Firebase â€” works on all browsers including Opera
v4.99 | Feb 28 2026 19:33 IST | VAPID public key replaced with newly generated key pair (fresh Web Push setup)
v5.00 | Feb 28 2026 19:33 IST | Fixed push: subscription was stored as JSON string â€” now parsed before sending to worker
v5.01 | Feb 28 2026 21:15 IST | Fixed Registered Devices panel not expanding after switching tabs
v5.02 | Feb 28 2026 21:30 IST | Fixed Cannot read properties of undefined error on student login & quiz archive
v5.03 | Feb 28 2026 21:45 IST | Fixed /*- bypass not working in quiz login password field
v5.04 | Feb 28 2026 22:00 IST | Fixed Live Now showing Guest after login â€” presence interval now resets with new identity
v5.05 | Feb 28 2026 22:15 IST | Merged all v5.01â€“v5.04 fixes into single file (previous updates were missing)
v5.06 | Mar 01 2026 00:30 IST | Targeted notifications â€” send to All / One Class / One Person with both in-app toast and FCM push
v5.07 | Mar 01 2026 04:45 IST | Fixed person-targeted toast not showing â€” now targets by name not session ID, works across all devices
v5.08 | Mar 01 2026 05:10 IST | Toast window increased from 30s to 5min so mobile users who open site shortly after still see it
v5.09 | Mar 01 2026 05:20 IST | Fixed all timestamps showing wrong time â€” IST was being added twice (browser + manual)
v5.10 | Mar 01 2026 05:35 IST | Fixed toast never showing â€” now re-checks on login so notifications sent before page load still appear
v5.14 | Feb 28 2026 23:44 IST | Fixed person-targeted toast not showing â€” now resolves real identity from FCM token when _currentUserName is generic (Student/CR/Guest)
v5.15 | Feb 28 2026 23:55 IST | Fixed toast never showing â€” session ID now uses localStorage so FCM token identity persists across page refreshes and tabs
v5.16 | Mar 01 2026 00:10 IST | Fixed toast invisible â€” toast div was nested inside notifPermBanner (display:none), restructured to be direct child of body
v5.17 | Mar 01 2026 00:20 IST | Added correct sw.js code in admin panel with copy button + test push button; missing push handler in sw.js was root cause of no native notifications
v5.18 | Mar 01 2026 00:30 IST | Fixed test push button (event->param); _currentUserName default to empty; toast window 5minâ†’30min; clipboard API for copy
v5.19 | Mar 01 2026 00:40 IST | Fixed Test Push Now button not working â€” showSwJsCode/copySwJs/testPushLocally were inside IIFE, exposed via window.* to make onclick accessible
v5.20 | Mar 01 2026 00:55 IST | Fixed ALL push panel buttons (refreshDeviceCount, toggleDevicesPanel, sendPushNotification etc) â€” entire Firebase IIFE was trapping all functions, now all exposed via window.*
v5.21 | Mar 01 2026 01:05 IST | Rewired Test Push Now + Copy sw.js via addEventListener in initPushNotifPanel â€” onclick scope unreliable, now wired directly on DOM element
v5.22 | Mar 01 2026 01:15 IST | Fixed Test Push hanging with 6s SW timeout; identity recovery now scans all FCM tokens to find real name when localStorage SID has no identity
v5.23 | Mar 01 2026 12:59 IST | Fixed Compose Notification silently doing nothing when 0 subscriptions found â€” now shows clear warning; worker errors and network failures also surfaced with exact error message
v5.24 | Mar 01 2026 12:59 IST | Compose Notification now shows push-enabled vs total registered count; 0-subscription warning tells admin students must click Allow on notification prompt
v5.25 | Mar 01 2026 12:59 IST | Added Re-send Notification Permission Prompt button in admin panel â€” writes to Firebase, students online see banner instantly; others see it on next load
v5.26 | Mar 01 2026 12:59 IST | Added Clean Stale Subscriptions button â€” tests each subscription individually via worker and removes failed ones from Firebase; success message now hints about stale count
v5.27 | Mar 01 2026 12:59 IST | Fixed SW reg to call reg.update() on every load; added Force Update SW button â€” writes to Firebase, triggers reg.update() on all online devices immediately
v5.28 | Mar 01 2026 12:59 IST | Added SW Push Debug Log panel â€” sw.js logs every push step to Firebase REST API; admin sees live log with push_received/push_shown_ok/push_show_error
v5.29 | Mar 01 2026 | Added â¬‡ï¸ Download sw.js button + auto health-check that fetches live sw.js and warns if push handler is missing â€” root fix for "notification not going"
v5.30 | Mar 01 2026 | Fixed stale push subscription â€” after SW update old sub no longer receives pushes; now forces fresh re-subscribe; added Force Re-subscribe All Devices admin button + Firebase listener on student side
v5.31 | Mar 01 2026 | Added ðŸ”¬ Diagnose button in SW Push Debug panel â€” shows permission, SW state, subscription existence, Firebase match, and VAPID key to pinpoint exactly why notifications aren't arriving
v5.32 | Mar 01 2026 | Fixed Diagnose/Clear/Refresh buttons not clickable â€” info box above was overlapping; added z-index and position:relative to fix stacking
v5.33 | Mar 01 2026 | Fixed buttons still not clickable â€” moved Diagnose/Clear/Refresh below description text (away from overlap zone); added overflow:hidden + z-index to Compose card
v5.34 | Mar 01 2026 | Root cause fixed: window.diagnosePushOnDevice= line was inserted inside initPushNotifPanel body, breaking it â€” button wiring never ran, so onclick handlers were never attached
v5.39 | Mar 01 2026 | Root fix for notifications not working: saveFcmToken verifies write + retries + shows page banner + localStorage fallback when Firebase Rules block; sendPushNotification uses localStorage fallback when 0 subscriptions in Firebase; Diagnose tests Firebase Rules write; new Check Firebase Rules button with copyable JSON
v5.40 | Mar 01 2026 | Fixed false "Firebase write test passed but no subscription" contradiction â€” saveFcmToken now trusts write promise and does delayed 3s verify instead of immediate read-back; Diagnose now auto-triggers re-subscribe when Rules are OK but sub missing, then rechecks after 3s
v5.41 | Mar 01 2026 | Added ðŸ—‘ delete button on each notification history entry + Clear Old button (top & bottom) with date picker to bulk delete entries on or before a chosen date
v5.42 | Mar 01 2026 | Fixed notifications wiping themselves: stopped auto-deleting subscriptions worker marks failed (Firefox endpoints are valid but worker can't reach them); added Firefox/Mozilla endpoint warning in Diagnose and on subscribe
v5.43 | Mar 01 2026 | Fixed race condition: saveFcmToken now polls Firebase until write confirmed (up to 5s) before returning, so sendPushNotification always finds the token instead of falling back to localStorage
v5.44 | Mar 01 2026 | Root fix for worker delivery failure: generated fresh matched VAPID key pair; new public key in HTML; full Cloudflare Worker code with matching private key embedded in admin panel with Copy + Download buttons
v5.45 | Mar 01 2026 | Fixed InvalidAccessError: old VAPID public key was 64 bytes (invalid); replaced with fresh correctly-generated 65-byte key pair
-->
    <!-- ============================================================ -->
    <!-- ðŸŸ¢ FIREBASE PRESENCE + ðŸ“£ PUSH NOTIFICATIONS SCRIPTS       -->
    <!-- ============================================================ -->
    <script>
    (function() {
    // â”€â”€â”€ CONFIGURATION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const VAPID_KEY = 'BLrDcA6CEFSxsK5JphRx7YpKx-aZFvE3jiJgxYkMtIj2iVGNEII3pYoDmP6w3gUtEF9H2AI6Wm3TL5628_6iKTg';
    // âš ï¸ Replace this with your actual fcm-push Cloudflare Worker URL after deploying it
    const FCM_WORKER_URL = 'https://fcm-push.harshgujjar.workers.dev';
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    // â”€â”€ GENERATE A SESSION ID â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function getSessionId() {
        // localStorage ensures same device keeps same ID across page refreshes/tabs
        // critical for FCM token + identity matching
        let sid = localStorage.getItem('spurthi_sid');
        if (!sid) {
            sid = 'sid_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            localStorage.setItem('spurthi_sid', sid);
        }
        return sid;
    }

    // â”€â”€ DETECT DEVICE TYPE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function getDeviceType() {
        return /Mobi|Android|iPhone|iPad/i.test(navigator.userAgent) ? 'Mobile' : 'Desktop';
    }

    // â”€â”€ FORMAT TIME AS HH:MM AM/PM â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function fmtTime(ts) {
        const d = new Date(ts);
        let h = d.getHours(), m = d.getMinutes();
        const ampm = h >= 12 ? 'PM' : 'AM';
        h = h % 12 || 12;
        return h + ':' + String(m).padStart(2, '0') + ' ' + ampm;
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // ðŸŸ¢ FIREBASE PRESENCE â€” writes /liveUsers/{sessionId}
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    function registerPresence(name, className) {
        const db = window.db || firebase.database();
        if (!db) { setTimeout(() => registerPresence(name, className), 1000); return; }

        const sid = getSessionId();
        const presRef = db.ref('liveUsers/' + sid);

        const data = {
            name:   name      || 'Guest',
            class:  className || 'â€”',
            device: getDeviceType(),
            since:  Date.now()
        };

        // Write presence
        presRef.set(data);

        // Auto-remove when tab closes / connection drops
        presRef.onDisconnect().remove();

        // Keep alive â€” clear any old interval so the NEW identity is used
        if (window._presenceInterval) clearInterval(window._presenceInterval);
        window._presenceInterval = setInterval(() => { presRef.set(data); }, 4 * 60 * 1000);
    }

    // Call registerPresence as soon as Firebase is ready
    document.addEventListener('DOMContentLoaded', () => {
        // Wait for window.db to be set by main script, then register as Guest
        const waitForDb = setInterval(() => {
            if (window.db) {
                clearInterval(waitForDb);
                registerPresence('Guest', 'â€”');
                // â”€â”€ FIX: Load real identity from Firebase so toast name-match works
                // even when user logs in via generic Student login (not quiz login)
                const sid = getSessionId();
                const genericNames = ['', 'guest', 'student', 'cr'];
                window.db.ref('fcmTokens/' + sid + '/identity').once('value').then(snap => {
                    const id = snap.val();
                    if (id && id.name && !genericNames.includes(id.name.toLowerCase())) {
                        window._currentUserName = id.name;
                        window._currentUserClass = id.class || window._currentUserClass || '';
                        console.log('[Toast] Restored real identity from FCM token:', id.name, id.class);
                    } else {
                        // SID has no real identity (new localStorage SID) â€” find newest token with real identity
                        console.log('[Toast] No identity under current SID, scanning all FCM tokens...');
                        window.db.ref('fcmTokens').once('value').then(allSnap => {
                            if (!allSnap.exists()) return;
                            let best = null;
                            allSnap.forEach(child => {
                                const t = child.val();
                                if (t && t.identity && t.identity.name && !genericNames.includes(t.identity.name.toLowerCase())) {
                                    if (!best || (t.savedAt || 0) > (best.savedAt || 0)) best = t;
                                }
                            });
                            if (best) {
                                window.db.ref('fcmTokens/' + sid + '/identity').set(best.identity).catch(()=>{});
                                window._currentUserName  = best.identity.name;
                                window._currentUserClass = best.identity.class || '';
                                console.log('[Toast] Identity recovered from newest FCM token:', best.identity.name);
                                // Re-check latest notification now that we have a name
                                if (window._evalInAppNotif && window.db) {
                                    window.db.ref('live_notifications/latest').once('value').then(s => {
                                        if (s.exists()) window._evalInAppNotif(s.val());
                                    });
                                }
                            }
                        }).catch(() => {});
                    }
                }).catch(() => {});
            }
        }, 500);

        // Show notification permission banner if not yet decided (once per session)
        setTimeout(() => { if (window.maybeShowNotifBanner) maybeShowNotifBanner(); }, 800);

        // Register service worker â€” with inline blob fallback so push always works
        if ('serviceWorker' in navigator) {
            // SW registered below â€” see sw.js on GitHub for push handler
            // Register external sw.js â€” force update every time to pick up latest push handler
            navigator.serviceWorker.register('/Spurthi-youth-fest-2026/sw.js')
                .then(reg => {
                    console.log('[SW] Registered:', reg.scope);
                    // Force update check â€” ensures browser picks up latest sw.js from GitHub
                    reg.update().then(() => {
                        console.log('[SW] Update check triggered');
                    }).catch(() => {});
                    if (Notification.permission === 'granted') subscribeToPush(reg);
                })
                .catch(err => {
                    console.warn('[SW] sw.js registration failed:', err.message);
                });
            navigator.serviceWorker.ready.then(reg => {
                console.log('[SW] Ready. Active worker:', reg.active ? reg.active.state : 'none');
                if (Notification.permission === 'granted') subscribeToPush(reg);
                // Verify push handler exists by checking sw.js content
                reg.update().catch(() => {});
            });
        }
    });

    // â”€â”€ HOOK: called from your existing login functions after login success
    // You should call  window.onSpurthiLogin(name, className)  inside your
    // existing loginSuccess / quiz login success code.
    window.onSpurthiLogin = function(name, className) {
        registerPresence(name, className);
        window._currentUserClass = className || '';
        window._currentUserName  = name      || '';
        // Re-check latest notification in case it arrived before login
        if (window.db) {
            window.db.ref('live_notifications/latest').once('value').then(snap => {
                if (snap.exists() && window._evalInAppNotif) window._evalInAppNotif(snap.val());
            });
        }
        // Also save FCM token identity
        const sid = getSessionId();
        const db = window.db || firebase.database();
        db.ref('fcmTokens/' + sid + '/identity').set({ name, class: className });
        // Re-check push notification banner â€” show once if not yet dismissed
        maybeShowNotifBanner();
    };

    // Show notification permission banner ONCE per session if not already dismissed/granted
    window.maybeShowNotifBanner = function() {
        // Already granted or permanently dismissed â†’ never show
        if (Notification.permission !== 'default') return;
        if (localStorage.getItem('notif_banner_dismissed')) return;
        // Already shown this session â†’ don't show again
        if (sessionStorage.getItem('notif_banner_shown')) return;
        const banner = document.getElementById('notifPermBanner');
        if (banner) {
            banner.style.display = 'flex';
            sessionStorage.setItem('notif_banner_shown', '1');
        }
    };

    // â”€â”€â”€ RETRIGGER BANNER LISTENER (student side) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // Admin writes to notif_banner_retrigger â†’ banner re-appears for all students
    (function() {
        const waitForDb2 = setInterval(() => {
            if (window.db) {
                clearInterval(waitForDb2);
                let _lastRetrigger = null;
                window.db.ref('notif_banner_retrigger').on('value', snap => {
                    if (!snap.exists()) return;
                    const data = snap.val();
                    if (!data || !data.triggeredAt) return;
                    if (_lastRetrigger === data.triggeredAt) return;
                    _lastRetrigger = data.triggeredAt;
                    // Skip if already granted â€” they don't need the banner
                    if (typeof Notification !== 'undefined' && Notification.permission === 'granted') return;
                    // Skip if browser has permanently blocked (can't override that)
                    if (typeof Notification !== 'undefined' && Notification.permission === 'denied') return;
                    // Clear the dismissed flag so banner can show again
                    localStorage.removeItem('notif_banner_dismissed');
                    sessionStorage.removeItem('notif_banner_shown');
                    // Show the banner immediately
                    const banner = document.getElementById('notifPermBanner');
                    if (banner) {
                        banner.style.display = 'flex';
                        sessionStorage.setItem('notif_banner_shown', '1');
                        console.log('[Push] Admin triggered permission banner re-show');
                    }
                });
            }
        }, 500);
    })();

    // â”€â”€â”€ SW FORCE UPDATE LISTENER (student side) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    (function() {
        const waitForDbSW = setInterval(() => {
            if (window.db) {
                clearInterval(waitForDbSW);
                let _lastSWUpdate = null;
                window.db.ref('sw_force_update').on('value', snap => {
                    if (!snap.exists()) return;
                    const data = snap.val();
                    if (!data || !data.triggeredAt) return;
                    if (_lastSWUpdate === data.triggeredAt) return;
                    _lastSWUpdate = data.triggeredAt;
                    if (!('serviceWorker' in navigator)) return;
                    navigator.serviceWorker.ready.then(reg => {
                        reg.update().then(() => {
                            console.log('[SW] Admin triggered force update â€” sw.js reloaded');
                        }).catch(() => {});
                    }).catch(() => {});
                });
            }
        }, 500);
    })();

    // â”€â”€â”€ FORCE RE-SUBSCRIBE LISTENER (student side) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // Admin writes to push_force_resub â†’ all online students drop old sub and get fresh one
    (function() {
        const waitForDbResub = setInterval(() => {
            if (window.db) {
                clearInterval(waitForDbResub);
                let _lastResub = null;
                window.db.ref('push_force_resub').on('value', snap => {
                    if (!snap.exists()) return;
                    const data = snap.val();
                    if (!data || !data.triggeredAt) return;
                    if (_lastResub === data.triggeredAt) return;
                    _lastResub = data.triggeredAt;
                    if (!('serviceWorker' in navigator)) return;
                    if (Notification.permission !== 'granted') return;
                    navigator.serviceWorker.ready.then(reg => {
                        localStorage.removeItem('spurthi_push_subbed_v2');
                        subscribeToPush(reg, true).then(() => {
                            console.log('[Push] Admin triggered force re-subscribe â€” fresh subscription saved');
                        }).catch(() => {});
                    }).catch(() => {});
                });
            }
        }, 500);
    })();

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // ðŸŸ¢ LIVE NOW PANEL â€” SA functions
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    let _liveUsersListener = null;

    function initLiveUsersPanel() {
        // Always re-attach fresh (listener is detached when switching away from this tab)
        if (_liveUsersListener) {
            const _db = window.db || firebase.database();
            _db.ref('liveUsers').off('value', _liveUsersListener);
            _liveUsersListener = null;
        }
        const db = window.db || firebase.database();
        _liveUsersListener = db.ref('liveUsers').on('value', snap => {
            const data = snap.val() || {};
            const users = Object.values(data);
            document.getElementById('liveCountBadge').textContent = users.length;

            const tbody = document.getElementById('liveUsersTableBody');
            if (users.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;padding:30px;color:#999;font-size:14px">ðŸ”´ No users currently online</td></tr>';
                return;
            }
            // Sort by since desc (most recent first)
            users.sort((a, b) => b.since - a.since);
            tbody.innerHTML = users.map((u, i) => `
                <tr style="background:${i % 2 === 0 ? '#fafafa' : '#fff'};border-bottom:1px solid #eee">
                    <td style="padding:11px 16px;font-size:14px;color:#1a0030;font-weight:600">${u.name || 'Guest'}</td>
                    <td style="padding:11px 16px;font-size:13px;color:#555">${u.class || 'â€”'}</td>
                    <td style="padding:11px 16px;font-size:13px;color:#888">${fmtTime(u.since)}</td>
                    <td style="padding:11px 16px;font-size:13px">
                        <span style="background:${u.device === 'Mobile' ? '#e8f5e9' : '#e3f2fd'};color:${u.device === 'Mobile' ? '#2e7d32' : '#1565c0'};padding:3px 10px;border-radius:12px;font-size:12px;font-weight:700">${u.device || 'Unknown'}</span>
                    </td>
                </tr>
            `).join('');
        });
    }

    function refreshLiveUsers() {
        // Listener already live â€” just force a UI flash to show it's working
        const badge = document.getElementById('liveCountBadge');
        badge.style.opacity = '0.4';
        setTimeout(() => { badge.style.opacity = '1'; }, 400);
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // ðŸ”” PUSH NOTIFICATION BANNER â€” student side
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function dismissNotifBanner() {
        localStorage.setItem('notif_banner_dismissed', '1');
        const banner = document.getElementById('notifPermBanner');
        if (banner) banner.style.display = 'none';
    }

    async function requestNotifPermission() {
        dismissNotifBanner();
        if (!('Notification' in window)) return;
        const permission = await Notification.requestPermission();
        if (permission === 'granted') {
            const reg = await navigator.serviceWorker.ready;
            await subscribeToPush(reg, true); // force fresh subscription
        }
    }

    async function subscribeToPush(reg, forceResub) {
        try {
            const existing = await reg.pushManager.getSubscription();
            // Force re-subscribe if: explicitly requested, or first time after SW update
            // This is critical â€” after SW update, old subscription is stale and won't receive pushes
            const needsResub = forceResub || !localStorage.getItem('spurthi_push_subbed_v2');
            if (existing && !needsResub) {
                await saveFcmToken(existing);
                return;
            }
            // Unsubscribe old stale subscription first
            if (existing) {
                await existing.unsubscribe();
                console.log('[Push] Unsubscribed old stale subscription');
            }
            const sub = await reg.pushManager.subscribe({
                userVisibleOnly: true,
                applicationServerKey: urlBase64ToUint8Array(VAPID_KEY)
            });
            localStorage.setItem('spurthi_push_subbed_v2', '1');
            await saveFcmToken(sub);
            console.log('[Push] Fresh subscription created and saved');
            // Detect Firefox/Mozilla endpoint â€” warn that Cloudflare Worker must support Web Push
            const endpoint = sub.endpoint || '';
            if (endpoint.includes('mozilla') || endpoint.includes('firefox')) {
                console.warn('[Push] âš ï¸ Firefox/Mozilla push endpoint detected. Your Cloudflare Worker must use proper VAPID Web Push signing (not FCM-only) to deliver to Firefox. If notifications fail, try Chrome or Edge instead.');
            }
        } catch (e) {
            console.warn('[Push] Subscribe failed:', e);
        }
    }

    async function saveFcmToken(subscription) {
        const sid = getSessionId();
        const db  = window.db || firebase.database();
        const payload = {
            subscription: JSON.stringify(subscription),
            device: getDeviceType(),
            savedAt: Date.now()
        };

        // Always store locally as fallback
        try { localStorage.setItem('spurthi_push_sub_fallback', JSON.stringify(subscription)); } catch(e) {}

        // Write to Firebase and wait for confirmation before returning
        // This ensures sendPushNotification always finds the token when it reads Firebase
        try {
            await db.ref('fcmTokens/' + sid).update(payload);
            console.log('[Push] âœ… Token written to Firebase');
            // Poll until confirmed readable (up to 5s) â€” Firebase propagation can take 1-2s
            for (let i = 0; i < 5; i++) {
                await new Promise(r => setTimeout(r, 1000));
                try {
                    const check = await db.ref('fcmTokens/' + sid + '/subscription').once('value');
                    if (check.exists()) {
                        console.log('[Push] âœ… Token confirmed in Firebase after ' + (i + 1) + 's');
                        return;
                    }
                } catch(e) {}
            }
            console.error('[Push] âŒ Token NOT confirmed in Firebase after 5s â€” check Firebase Rules.');
        } catch(e) {
            console.error('[Push] âŒ Token write threw error:', e.message);
        }
    }

    function urlBase64ToUint8Array(base64String) {
        const padding = '='.repeat((4 - base64String.length % 4) % 4);
        const base64 = (base64String + padding).replace(/-/g, '+').replace(/_/g, '/');
        const raw = atob(base64);
        return Uint8Array.from([...raw].map(c => c.charCodeAt(0)));
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // ðŸ“£ PUSH NOTIFICATIONS PANEL â€” SA functions
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // â”€â”€ sw.js code viewer â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const SW_JS_CODE = `// sw.js â€” Spurthi Youth Fest 2026
// Upload this file to your GitHub repo at: /Spurthi-youth-fest-2026/sw.js

const FIREBASE_URL = 'https://spurthi-youthfest-2026-default-rtdb.asia-southeast1.firebasedatabase.app';

function swLog(step, detail) {
    const entry = { step, detail: detail || '', ts: Date.now() };
    fetch(FIREBASE_URL + '/sw_debug.json', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(entry)
    }).catch(() => {});
}

self.addEventListener('install', e => {
    swLog('install', 'SW installed');
    e.waitUntil(self.skipWaiting());
});

self.addEventListener('activate', e => {
    swLog('activate', 'SW activated');
    e.waitUntil(self.clients.claim());
});

self.addEventListener('push', function(event) {
    swLog('push_received', event.data ? event.data.text() : 'NO DATA');
    let data = { title: 'Spurthi 2026', body: 'New notification' };
    try {
        if (event.data) {
            const text = event.data.text();
            try { data = JSON.parse(text); } catch(e) { data.body = text; }
        }
    } catch(e) { swLog('push_parse_error', e.message); }
    const title = data.title || (data.notification && data.notification.title) || 'Spurthi 2026';
    const body  = data.body  || (data.notification && data.notification.body)  || '';
    swLog('push_showing', 'title=' + title + ' body=' + body);
    const options = {
        body: body,
        icon: '/Spurthi-youth-fest-2026/davan_logo_2026.gif',
        badge: '/Spurthi-youth-fest-2026/davan_logo_2026.gif',
        vibrate: [300, 100, 300, 100, 300],
        requireInteraction: true,
        tag: 'spurthi-notif',
        renotify: true,
        data: { url: 'https://harshgujjar.github.io/Spurthi-youth-fest-2026/' }
    };
    event.waitUntil(
        self.registration.showNotification(title, options)
            .then(() => { swLog('push_shown_ok', title); })
            .catch(err => { swLog('push_show_error', err.message); })
    );
});

self.addEventListener('notificationclick', function(event) {
    swLog('notification_clicked', '');
    event.notification.close();
    const url = (event.notification.data && event.notification.data.url)
                || 'https://harshgujjar.github.io/Spurthi-youth-fest-2026/';
    event.waitUntil(
        clients.matchAll({ type: 'window', includeUncontrolled: true }).then(list => {
            for (const c of list) {
                if (c.url.includes('Spurthi') && 'focus' in c) return c.focus();
            }
            if (clients.openWindow) return clients.openWindow(url);
        })
    );
});`;

    function showSwJsCode() {
        document.getElementById('swJsCodeArea').value = SW_JS_CODE;
        document.getElementById('swJsModal').style.display = 'flex';
    }

    function copySwJs(btn) {
        const ta = document.getElementById('swJsCodeArea');
        ta.select();
        try { document.execCommand('copy'); } catch(e) {}
        if (navigator.clipboard) navigator.clipboard.writeText(ta.value).catch(()=>{});
        if (btn) { btn.textContent = 'âœ… Copied!'; setTimeout(() => btn.textContent = 'ðŸ“‹ Copy to Clipboard', 2500); }
    }


    async function testPushLocally() {
        const res = document.getElementById('testPushResult');
        function setRes(txt) { if (res) res.textContent = txt; }

        // Step 1: Check Notification API
        if (!('Notification' in window)) {
            setRes(''); alert('âŒ Notifications not supported in this browser.'); return;
        }
        setRes('â³ Checking permission...');
        if (Notification.permission === 'denied') {
            setRes('âŒ Blocked');
            alert('âŒ Notifications are BLOCKED.\nGo to browser Settings â†’ Site Settings â†’ Notifications â†’ find this site â†’ set to Allow.');
            return;
        }
        if (Notification.permission !== 'granted') {
            const p = await Notification.requestPermission();
            if (p !== 'granted') { setRes('âŒ Not allowed'); alert('Please tap Allow when the browser asks.'); return; }
        }

        // Step 2: Check Service Worker
        if (!('serviceWorker' in navigator)) {
            setRes('âŒ No SW');
            alert('âŒ Service workers not supported. Push notifications require a modern browser.');
            return;
        }

        setRes('â³ Getting SW...');
        // Use a 6s timeout on serviceWorker.ready so it never hangs forever
        let reg;
        try {
            reg = await Promise.race([
                navigator.serviceWorker.ready,
                new Promise((_, rej) => setTimeout(() => rej(new Error('SW not ready after 6s â€” try refreshing the page')), 6000))
            ]);
        } catch(e) {
            setRes('âŒ SW timeout');
            alert('âŒ Service Worker issue: ' + e.message +
                  '\n\nFix: Refresh the page and try again. If this keeps happening, open DevTools â†’ Application â†’ Service Workers â†’ click Unregister, then refresh.');
            return;
        }

        // Step 3: Show test notification
        setRes('â³ Showing notification...');
        try {
            const swState = reg.active ? reg.active.state : 'no active worker';
            let sub = null;
            try { sub = await reg.pushManager.getSubscription(); } catch(e2) {}
            await reg.showNotification('ðŸ§ª Spurthi Test', {
                body: 'Push notifications are working! âœ…',
                icon: '/Spurthi-youth-fest-2026/davan_logo_2026.gif',
                vibrate: [200, 100, 200],
                tag: 'swtest'
            });
            setRes('âœ… Done!');
            setTimeout(() => {
                alert('ðŸ§ª Test Result\n\n' +
                      'â€¢ Notification permission: âœ… Granted\n' +
                      'â€¢ SW state: ' + swState + '\n' +
                      'â€¢ Push subscription: ' + (sub ? 'âœ… Active' : 'âŒ Missing â€” reload page to re-subscribe') + '\n\n' +
                      'Did you see a popup notification?\n' +
                      '  YES âœ… â†’ Everything working!\n' +
                      '  NO  âŒ â†’ sw.js has no push handler â€” use "Copy correct sw.js code" button and re-upload it to GitHub');
            }, 500);
        } catch(e) {
            setRes('âŒ Failed');
            alert('âŒ Notification failed: ' + e.message);
        }
    }
    async function diagnosePushOnDevice() {
        const el = document.getElementById('swDiagnoseResult');
        if (!el) return;
        el.style.display = 'block';
        el.innerHTML = 'â³ Running diagnosisâ€¦';

        const lines = [];
        const ok  = t => `<span style="color:#a8ff78">âœ… ${t}</span>`;
        const err = t => `<span style="color:#ff5252">âŒ ${t}</span>`;
        const warn= t => `<span style="color:#ffcc02">âš ï¸ ${t}</span>`;

        // 1. Notification permission
        const perm = ('Notification' in window) ? Notification.permission : 'unsupported';
        lines.push(perm === 'granted' ? ok('Notification permission: granted') : err('Notification permission: ' + perm + ' â€” student must click Allow'));

        // 2. Service Worker
        if (!('serviceWorker' in navigator)) {
            lines.push(err('Service Workers not supported in this browser'));
            el.innerHTML = lines.join('<br>'); return;
        }
        lines.push(ok('Service Workers: supported'));

        // 3. SW registration
        let reg;
        try {
            reg = await Promise.race([
                navigator.serviceWorker.ready,
                new Promise((_, rej) => setTimeout(() => rej(new Error('timeout')), 4000))
            ]);
            lines.push(ok('SW registered â€” scope: ' + reg.scope));
            lines.push(reg.active ? ok('SW active state: ' + reg.active.state) : err('SW has no active worker'));
        } catch(e) {
            lines.push(err('SW not ready: ' + e.message));
            el.innerHTML = lines.join('<br>'); return;
        }

        // 4. Push subscription
        try {
            const sub = await reg.pushManager.getSubscription();
            if (!sub) {
                lines.push(err('No push subscription on this device â€” page reload needed to re-subscribe'));
            } else {
                const endpoint = sub.endpoint || '';
                const shortEp = endpoint.substring(0, 60) + 'â€¦';
                lines.push(ok('Push subscription exists'));
                lines.push(warn('Endpoint: ' + shortEp));
                if (endpoint.includes('mozilla') || endpoint.includes('firefox')) {
                    lines.push(warn('âš ï¸ Firefox/Mozilla endpoint â€” your Cloudflare Worker must support standard VAPID Web Push to reach Firefox. If notifications fail, test on Chrome or Edge instead.'));
                }
                const expiry = sub.expirationTime;
                if (expiry && expiry < Date.now()) {
                    lines.push(err('Subscription EXPIRED â€” must re-subscribe'));
                } else {
                    lines.push(ok('Subscription not expired'));
                }
                // Check if subscription is saved in Firebase
                const sid = localStorage.getItem('spurthi_sid');
                if (sid && window.db) {
                    try {
                        const snap = await window.db.ref('fcmTokens/' + sid + '/subscription').once('value');
                        if (snap.exists()) {
                            let saved;
                            try { saved = JSON.parse(snap.val()); } catch(e) { saved = snap.val(); }
                            const match = saved && saved.endpoint === endpoint;
                            lines.push(match ? ok('Firebase subscription matches browser') : err('Firebase subscription MISMATCH â€” browser has different sub than Firebase. Click Force Re-subscribe below!'));
                        } else {
                            // Write test to distinguish Rules block vs timing issue
                            let rulesOk = false;
                            try {
                                await window.db.ref('fcmTokens/' + sid + '/_ruletest').set(1);
                                await window.db.ref('fcmTokens/' + sid + '/_ruletest').remove();
                                rulesOk = true;
                            } catch(ruleErr) { rulesOk = false; }

                            if (rulesOk) {
                                // Rules are fine â€” subscription just hasn't saved yet, trigger it now
                                lines.push(warn('No subscription in Firebase yet â€” triggering re-subscribe nowâ€¦'));
                                el.innerHTML = lines.join('<br>');
                                try {
                                    const reg2 = await navigator.serviceWorker.ready;
                                    localStorage.removeItem('spurthi_push_subbed_v2');
                                    await subscribeToPush(reg2, true);
                                    // Wait 3s then recheck
                                    await new Promise(r => setTimeout(r, 3000));
                                    const recheck = await window.db.ref('fcmTokens/' + sid + '/subscription').once('value');
                                    if (recheck.exists()) {
                                        lines.push(ok('Subscription now saved in Firebase âœ… â€” you can send notifications'));
                                    } else {
                                        lines.push(err('Still not saved after re-subscribe â€” check browser console for errors'));
                                    }
                                } catch(resubErr) {
                                    lines.push(err('Re-subscribe failed: ' + resubErr.message));
                                }
                            } else {
                                lines.push(err('ðŸ”´ FIREBASE RULES blocking writes to fcmTokens/ â€” this is why notifications fail!'));
                                lines.push(err('Fix: Firebase Console â†’ Realtime Database â†’ Rules â†’ add: "fcmTokens": {".read": true, ".write": true}'));
                            }
                            const fbSub = localStorage.getItem('spurthi_push_sub_fallback');
                            if (fbSub) lines.push(warn('localStorage fallback subscription found â€” push may still work for this device via fallback'));
                        }
                    } catch(readErr) {
                        lines.push(err('Firebase READ blocked (Rules deny fcmTokens reads) â€” add ".read":true to fcmTokens rule in Firebase Console'));
                    }
                }
            }
        } catch(e) {
            lines.push(err('Could not get subscription: ' + e.message));
        }

        // 5. VAPID key check (indirect â€” just show key length)
        lines.push(warn('VAPID public key used: ' + VAPID_KEY.substring(0,20) + 'â€¦ (verify this matches your Cloudflare Worker)'));

        // 6. Summary
        const hasErrors = lines.some(l => l.includes('ff5252'));
        lines.push('');
        lines.push(hasErrors
            ? err('ISSUES FOUND â€” click ðŸ” Force Re-subscribe below, then try sending again')
            : ok('All checks passed â€” if push still fails, the VAPID private key in your Cloudflare Worker may not match the public key above'));

        el.innerHTML = lines.join('<br>');
    }

    window.diagnosePushOnDevice = diagnosePushOnDevice;

    async function initPushNotifPanel() {
        await refreshDeviceCount();
        startSwDebugPolling();
        loadAllDevices();
        loadPushLogs();
        // Re-wire buttons each time panel is opened (in case DOM wasn't ready at DOMContentLoaded)
        setTimeout(function() {
            const swBtn      = document.getElementById('swJsCodeBtn');
            const testBtn    = document.getElementById('testPushBtn');
            const dlBtn      = document.getElementById('swJsDownloadBtn');
            const healthBadge = document.getElementById('swJsHealthBadge');
            if (swBtn && !swBtn._wired)   { swBtn.addEventListener('click', function() { showSwJsCode(); }); swBtn._wired = true; }
            if (testBtn && !testBtn._wired) {
                testBtn.addEventListener('click', function() {
                    const res = document.getElementById('testPushResult');
                    if (res) res.textContent = 'â³ Running...';
                    testPushLocally().catch(function(e) {
                        if (res) res.textContent = 'âŒ ' + e.message;
                        alert('Test Push error: ' + e.message);
                    });
                });
                testBtn._wired = true;
            }
            if (dlBtn && !dlBtn._wired) {
                dlBtn.addEventListener('click', function() {
                    const blob = new Blob([SW_JS_CODE], {type: 'application/javascript'});
                    const a = document.createElement('a');
                    a.href = URL.createObjectURL(blob);
                    a.download = 'sw.js';
                    a.click();
                    URL.revokeObjectURL(a.href);
                });
                dlBtn._wired = true;
            }
            // Auto-check if live sw.js on GitHub has push handler
            if (healthBadge && !healthBadge._checked) {
                healthBadge._checked = true;
                fetch('/Spurthi-youth-fest-2026/sw.js?_=' + Date.now())
                    .then(r => r.text())
                    .then(txt => {
                        if (txt.includes("addEventListener('push'") || txt.includes('addEventListener("push"')) {
                            healthBadge.style.display = 'block';
                            healthBadge.style.color = '#a8ff78';
                            healthBadge.textContent = 'âœ… sw.js on GitHub has push handler â€” notifications should work.';
                        } else {
                            healthBadge.style.display = 'block';
                            healthBadge.style.color = '#ff5252';
                            healthBadge.textContent = 'âŒ sw.js on GitHub is MISSING the push handler! Download sw.js below and upload it to GitHub â€” this is why notifications are not showing.';
                        }
                    })
                    .catch(() => {
                        healthBadge.style.display = 'block';
                        healthBadge.style.color = '#ffcc02';
                        healthBadge.textContent = 'âš ï¸ Could not fetch sw.js to verify. If notifications aren\'t showing, download sw.js and upload to GitHub.';
                    });
            }
        }, 100);
    }

    async function refreshDeviceCount() {
        const db = window.db || firebase.database();
        const snap = await db.ref('fcmTokens').once('value');
        const count = snap.exists() ? Object.keys(snap.val()).length : 0;
        document.getElementById('registeredDevicesCount').textContent = count;
    }

    function escHtml(str) {
        return String(str||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
    }

    // â”€â”€ Registered Devices panel toggle â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    let _allDevicesData = [];

    function toggleDevicesPanel() {
        const panel = document.getElementById('devicesPanel');
        const arrow = document.getElementById('devicesToggleArrow');
        const isOpen = panel.style.display !== 'none';
        panel.style.display = isOpen ? 'none' : 'block';
        arrow.style.transform = isOpen ? 'rotate(0deg)' : 'rotate(90deg)';
        if (!isOpen && _allDevicesData.length === 0) loadAllDevices();
    }

    async function loadAllDevices() {
        const container = document.getElementById('allDevicesInlineList');
        if (!container) return;
        container.innerHTML = '<p style="color:#aaa;font-size:13px;text-align:center;padding:10px 0">Loadingâ€¦</p>';
        try {
            const db = window.db || firebase.database();
            const snap = await db.ref('fcmTokens').once('value');
            const tokens = snap.val() || {};
            _allDevicesData = Object.entries(tokens).sort((a,b) => (b[1].savedAt||0) - (a[1].savedAt||0));
            const count = _allDevicesData.length;
            document.getElementById('registeredDevicesCount').textContent = count;
            document.getElementById('devicesCountBadge').textContent = count;

            // Build class filter buttons dynamically
            const classes = [...new Set(_allDevicesData.map(([,t]) => (t.identity&&t.identity.class)||'').filter(c=>c))].sort();
            const classFilters = document.getElementById('devFilterClassButtons');
            classFilters.innerHTML = classes.map(cls =>
                `<button onclick="filterDevices('${escHtml(cls)}')" id="devFilter_${escHtml(cls)}" class="devFilterBtn" style="padding:4px 12px;border-radius:14px;border:1.5px solid #aaa;background:#fff;color:#666;font-size:11px;font-weight:700;cursor:pointer">${escHtml(cls)}</button>`
            ).join('');

            renderDeviceList('all');
        } catch(e) {
            container.innerHTML = `<p style="color:#c00;font-size:13px">Error: ${e.message}</p>`;
        }
    }

    function filterDevices(filter) {
        // Update active button style
        document.querySelectorAll('.devFilterBtn').forEach(btn => {
            btn.style.background = '#fff';
            btn.style.color = '#666';
            btn.style.borderColor = '#aaa';
        });
        const activeBtn = document.getElementById('devFilter_' + filter);
        if (activeBtn) { activeBtn.style.background = '#6a1b9a'; activeBtn.style.color = '#fff'; activeBtn.style.borderColor = '#6a1b9a'; }
        renderDeviceList(filter);
    }

    function renderDeviceList(filter) {
        const container = document.getElementById('allDevicesInlineList');
        if (!container) return;
        let filtered = _allDevicesData;
        if (filter === 'guest') {
            filtered = _allDevicesData.filter(([,t]) => !(t.identity&&t.identity.name));
        } else if (filter !== 'all') {
            filtered = _allDevicesData.filter(([,t]) => (t.identity&&t.identity.class) === filter);
        }
        if (filtered.length === 0) {
            container.innerHTML = '<p style="color:#aaa;font-size:13px;text-align:center;padding:10px 0">No devices in this category.</p>';
            return;
        }
        container.innerHTML = filtered.map(([sid, t], i) => {
            const identity = t.identity || {};
            const name = identity.name || 'â€”';
            const cls  = identity.class || 'â€”';
            const device = t.device || 'Unknown';
            const ts = t.savedAt ? new Date(t.savedAt) : null;
            const regStr = ts
                ? ts.toLocaleDateString('en-IN',{day:'2-digit',month:'short',year:'numeric'}) + ' ' +
                  ts.toLocaleTimeString('en-IN',{hour:'2-digit',minute:'2-digit',hour12:true}) + ' IST'
                : 'â€”';
            const deviceIcon = device.toLowerCase().includes('mobile') ? 'ðŸ“±' : 'ðŸ’»';
            const isGuest = !identity.name;
            return `<div style="display:flex;align-items:center;gap:12px;padding:9px 0;border-bottom:1px solid #f0e6ff">
                <div style="background:${isGuest?'#aaa':'linear-gradient(135deg,#c44569,#6a1b9a)'};color:#fff;border-radius:50%;width:28px;height:28px;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:800;flex-shrink:0">${i+1}</div>
                <div style="flex:1;min-width:0">
                    <div style="font-weight:700;color:${isGuest?'#aaa':'#2d2d2d'};font-size:13px">${isGuest?'<em>Guest (not logged in)</em>':escHtml(name)} ${!isGuest?`<span style="color:#6a1b9a;font-weight:600;font-size:11px">${escHtml(cls)}</span>`:''}</div>
                    <div style="color:#888;font-size:11px;margin-top:1px">${deviceIcon} ${escHtml(device)} &nbsp;|&nbsp; ðŸ• ${regStr}</div>
                </div>
            </div>`;
        }).join('');
    }

    async function loadPushLogs() {
        const container = document.getElementById('pushLogsContainer');
        if (!container) return;
        container.innerHTML = '<p style="color:#aaa;font-size:13px;text-align:center;padding:20px 0">Loadingâ€¦</p>';
        try {
            const db = window.db || firebase.database();
            const snap = await db.ref('push_logs').orderByChild('sentAt').limitToLast(30).once('value');
            const logs = snap.val();
            if (!logs) {
                container.innerHTML = '<p style="color:#aaa;font-size:13px;text-align:center;padding:20px 0">No notifications sent yet.</p>';
                return;
            }
            const entries = Object.entries(logs).sort((a,b) => b[1].sentAt - a[1].sentAt);
            container.innerHTML = entries.map(([logId, log]) => {
                const d = new Date(log.sentAt);
                const dateStr = d.toLocaleDateString('en-IN',{day:'2-digit',month:'short',year:'numeric'});
                const timeStr = d.toLocaleTimeString('en-IN',{hour:'2-digit',minute:'2-digit',hour12:true});
                const seenCount = log.seen ? Object.keys(log.seen).length : 0;
                const totalDevices = log.total || (log.devices ? log.devices.length : 0);
                return `<div style="border:1.5px solid #e8e0f0;border-radius:10px;padding:14px 16px;margin-bottom:12px">
                    <div style="display:flex;align-items:flex-start;justify-content:space-between;gap:10px;flex-wrap:wrap">
                        <div style="flex:1;min-width:0">
                            <div style="font-weight:700;color:#2d2d2d;font-size:14px;margin-bottom:3px">ðŸ“£ ${escHtml(log.title)}</div>
                            <div style="color:#555;font-size:13px;margin-bottom:8px">${escHtml(log.body)}</div>
                            <div style="font-size:11px;color:#888">ðŸ• ${dateStr} &nbsp;${timeStr} IST</div>
                        </div>
                        <div style="text-align:right;white-space:nowrap">
                            <span style="background:#d4edda;color:#155724;padding:3px 10px;border-radius:12px;font-size:12px;font-weight:700">âœ… ${log.sent} sent</span>
                            ${log.failed > 0 ? `<span style="background:#f8d7da;color:#721c24;padding:3px 10px;border-radius:12px;font-size:12px;font-weight:700;margin-left:5px">âŒ ${log.failed} failed</span>` : ''}
                        </div>
                    </div>
                    <div style="display:flex;gap:10px;margin-top:10px;flex-wrap:wrap;align-items:center">
                        <button onclick="showSeenDevices('${logId}')" style="background:rgba(106,27,154,0.08);color:#6a1b9a;border:1.5px solid rgba(106,27,154,0.25);padding:5px 12px;border-radius:16px;cursor:pointer;font-size:12px;font-weight:600">
                            ðŸ‘ Seen: ${seenCount} / ${totalDevices}
                        </button>
                        <button onclick="showSentDevices('${logId}')" style="background:rgba(196,69,105,0.08);color:#c44569;border:1.5px solid rgba(196,69,105,0.25);padding:5px 12px;border-radius:16px;cursor:pointer;font-size:12px;font-weight:600">
                            ðŸ“± ${totalDevices} device(s) targeted
                        </button>
                        <button onclick="deleteLogEntry('${logId}')" style="margin-left:auto;background:rgba(183,28,28,0.07);color:#b71c1c;border:1.5px solid rgba(183,28,28,0.2);padding:5px 10px;border-radius:16px;cursor:pointer;font-size:12px;font-weight:600" title="Delete this entry">ðŸ—‘</button>
                    </div>
                </div>`;
            }).join('');
        } catch(e) {
            container.innerHTML = `<p style="color:#c00;font-size:13px">Error loading logs: ${e.message}</p>`;
        }
    }

    async function showSentDevices(logId) {
        const db = window.db || firebase.database();
        const snap = await db.ref('push_logs/' + logId).once('value');
        const log = snap.val();
        if (!log) return;
        const devices = log.devices || [];
        document.getElementById('seenModalTitle').textContent = `ðŸ“± Targeted Devices â€” "${log.title}"`;
        document.getElementById('seenModalBody').innerHTML = devices.length === 0
            ? '<p style="color:#aaa;font-size:13px">No device info available.</p>'
            : devices.map(d => {
                const reg = new Date(d.savedAt||0);
                const regStr = reg.toLocaleDateString('en-IN',{day:'2-digit',month:'short'}) + ' ' + reg.toLocaleTimeString('en-IN',{hour:'2-digit',minute:'2-digit',hour12:true});
                return `<div style="border-bottom:1px solid #f0e6ff;padding:8px 0;font-size:13px">
                    <strong style="color:#2d2d2d">${escHtml(d.name||'Unknown')}</strong>
                    ${d.class ? `<span style="color:#6a1b9a;font-size:11px;margin-left:6px">${escHtml(d.class)}</span>` : ''}
                    <br><span style="color:#888;font-size:11px">ðŸ“± ${escHtml(d.device||'')} &nbsp;|&nbsp; Registered: ${regStr} IST</span>
                </div>`;
              }).join('');
        document.getElementById('seenDevicesModal').style.display = 'flex';
    }

    async function showSeenDevices(logId) {
        const db = window.db || firebase.database();
        const snap = await db.ref('push_logs/' + logId).once('value');
        const log = snap.val();
        if (!log) return;
        const seen = log.seen || {};
        const seenEntries = Object.values(seen);
        document.getElementById('seenModalTitle').textContent = `ðŸ‘ Seen / Opened â€” "${log.title}"`;
        document.getElementById('seenModalBody').innerHTML = seenEntries.length === 0
            ? '<p style="color:#aaa;font-size:13px;text-align:center;padding:10px">No one has opened this notification yet.</p>'
            : seenEntries.map(s => {
                const d = new Date(s.seenAt||0);
                const dStr = d.toLocaleDateString('en-IN',{day:'2-digit',month:'short'}) + ' ' + d.toLocaleTimeString('en-IN',{hour:'2-digit',minute:'2-digit',hour12:true});
                return `<div style="border-bottom:1px solid #f0e6ff;padding:8px 0;font-size:13px">
                    <strong style="color:#2d2d2d">${escHtml(s.name||'Unknown')}</strong>
                    ${s.class ? `<span style="color:#6a1b9a;font-size:11px;margin-left:6px">${escHtml(s.class)}</span>` : ''}
                    <br><span style="color:#888;font-size:11px">ðŸ“± ${escHtml(s.device||'')} &nbsp;|&nbsp; Opened: ${dStr} IST</span>
                </div>`;
              }).join('');
        document.getElementById('seenDevicesModal').style.display = 'flex';
    }

    // â”€â”€ Notification target state â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    let _notifTarget = 'all'; // 'all' | 'class' | 'person'

    function setNotifTarget(mode) {
        _notifTarget = mode;
        const db = window.db || firebase.database();

        // Update button styles
        ['all','class','person'].forEach(m => {
            const btn = document.getElementById('ntBtn_' + m);
            if (!btn) return;
            if (m === mode) {
                btn.style.background = '#6a1b9a'; btn.style.color = '#fff'; btn.style.borderColor = '#6a1b9a';
            } else {
                btn.style.background = '#fff'; btn.style.color = '#666'; btn.style.borderColor = '#aaa';
            }
        });

        // Show/hide rows
        document.getElementById('notifClassRow').style.display  = mode === 'class'  ? 'block' : 'none';
        document.getElementById('notifPersonRow').style.display = mode === 'person' ? 'block' : 'none';

        // Update send button label
        const sendBtn = document.getElementById('sendNotifBtn');
        if (sendBtn) sendBtn.textContent = mode === 'all' ? 'ðŸ“¢ Send to All Devices' : mode === 'class' ? 'ðŸ« Send to Class' : 'ðŸ‘¤ Send to Person';

        // Populate dropdowns
        if (mode === 'class' || mode === 'person') {
            db.ref('fcmTokens').once('value').then(snap => {
                const tokens = snap.val() || {};
                if (mode === 'class') {
                    const classes = [...new Set(Object.values(tokens).map(t => (t.identity && t.identity.class) || '').filter(Boolean))].sort();
                    const sel = document.getElementById('notifTargetClass');
                    sel.innerHTML = '<option value="">â€” Select class â€”</option>' + classes.map(c => `<option value="${c}">${c}</option>`).join('');
                } else {
                    // Deduplicate by name â€” one person may have multiple devices/sessions
                    const nameMap = {};
                    Object.values(tokens).forEach(t => {
                        const name = (t.identity && t.identity.name) || '';
                        const cls  = (t.identity && t.identity.class) || 'â€”';
                        if (name && name !== 'Guest' && !nameMap[name]) nameMap[name] = cls;
                    });
                    const people = Object.entries(nameMap).sort((a,b) => a[0].localeCompare(b[0]));
                    const sel = document.getElementById('notifTargetPerson');
                    sel.innerHTML = '<option value="">â€” Select person â€”</option>' + people.map(([name, cls]) => `<option value="${name}">${name} Â· ${cls}</option>`).join('');
                }
            });
        }
    }

    async function sendPushNotification() {
        const title = document.getElementById('notifTitle').value.trim();
        const body  = document.getElementById('notifBody').value.trim();
        const statusEl = document.getElementById('notifSendStatus');
        const btn = document.getElementById('sendNotifBtn');

        if (!title || !body) {
            statusEl.style.display = 'block';
            statusEl.style.background = '#fff3cd';
            statusEl.style.color = '#856404';
            statusEl.textContent = 'âš ï¸ Please fill in both Title and Message.';
            return;
        }

        // Validate target selection
        const targetClass  = (_notifTarget === 'class')  ? (document.getElementById('notifTargetClass').value  || '') : '';
        const targetName   = (_notifTarget === 'person') ? (document.getElementById('notifTargetPerson').value || '') : '';
        if (_notifTarget === 'class'  && !targetClass)  { statusEl.style.display='block'; statusEl.style.background='#fff3cd'; statusEl.style.color='#856404'; statusEl.textContent='âš ï¸ Please select a class.'; return; }
        if (_notifTarget === 'person' && !targetName)   { statusEl.style.display='block'; statusEl.style.background='#fff3cd'; statusEl.style.color='#856404'; statusEl.textContent='âš ï¸ Please select a person.'; return; }

        btn.disabled = true;
        btn.textContent = 'â³ Sendingâ€¦';
        statusEl.style.display = 'none';

        try {
            const db = window.db || firebase.database();

            // â”€â”€ STEP 1: Write to Firebase for in-app real-time toast â”€â”€
            const notifPayload = {
                title, body,
                sentAt: Date.now(),
                id: Date.now().toString(),
                targetClass: targetClass || null,
                targetName:  targetName  || null
            };

            // Always write to /latest â€” clients filter by targetClass or targetName
            await db.ref('live_notifications/latest').set(notifPayload);

            // â”€â”€ STEP 2: FCM push (filtered by target) â”€â”€
            const snap = await db.ref('fcmTokens').once('value');
            const tokens = snap.val() || {};
            const allEntries = Object.entries(tokens);
            let tokenEntries = allEntries.filter(([,t]) => t.subscription);

            // Fallback: if Firebase has no subscriptions (likely Firebase Rules blocking writes),
            // use the locally-stored subscription for this device
            if (tokenEntries.length === 0) {
                const fallbackSub = localStorage.getItem('spurthi_push_sub_fallback');
                if (fallbackSub) {
                    console.warn('[FCM Push] 0 subscriptions in Firebase â€” using localStorage fallback for this device');
                    const sid = getSessionId();
                    tokenEntries = [[sid, { subscription: fallbackSub, device: getDeviceType(), savedAt: Date.now() }]];
                }
            }

            // Filter by class or person name (all devices of that person)
            if (_notifTarget === 'class' && targetClass) {
                tokenEntries = tokenEntries.filter(([,t]) => (t.identity && t.identity.class) === targetClass);
            } else if (_notifTarget === 'person' && targetName) {
                tokenEntries = tokenEntries.filter(([,t]) => (t.identity && t.identity.name) === targetName);
            }

            const subscriptions = tokenEntries.map(([,t]) => { try { return typeof t.subscription === "string" ? JSON.parse(t.subscription) : t.subscription; } catch(e) { return null; } }).filter(Boolean);
            const deviceList = tokenEntries.map(([sid, t]) => ({
                sid, device: t.device || 'Unknown',
                name: (t.identity && t.identity.name) || '',
                class: (t.identity && t.identity.class) || '',
                savedAt: t.savedAt || 0
            }));

            let sentCount = 0, failedCount = 0;
            const totalRegistered = allEntries.length;
            const pushEnabled = allEntries.filter(([,t]) => t.subscription).length;
            console.log('[FCM Push] Registered:', totalRegistered, '| Push-enabled:', pushEnabled, '| Targeting:', subscriptions.length);
            if (subscriptions.length === 0) {
                statusEl.style.display = 'block';
                statusEl.style.background = '#fff3cd';
                statusEl.style.color = '#856404';
                statusEl.textContent = `âš ï¸ In-app toast sent, but 0 devices found with push enabled for this target (${totalRegistered} total registered, ${pushEnabled} push-enabled). Students must open the site and tap Allow on the notification prompt.`;
                btn.disabled = false;
                btn.textContent = _notifTarget === 'all' ? 'ðŸ“¢ Send to All Devices' : _notifTarget === 'class' ? 'ðŸ« Send to Class' : 'ðŸ‘¤ Send to Person';
                loadPushLogs();
                return;
            }
            try {
                const resp = await fetch(FCM_WORKER_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ title, body, subscriptions, sids: tokenEntries.map(([sid]) => sid) })
                });
                if (resp.ok) {
                    const result = await resp.json();
                    sentCount = result.sent || subscriptions.length;
                    failedCount = result.failed || 0;
                    // NOTE: Do NOT auto-delete failed subscriptions here.
                    // A "failed" result from the worker often means the worker doesn't support
                    // that browser's push endpoint (e.g. Firefox/Mozilla endpoints need proper
                    // VAPID support in the worker). The subscription itself is still valid.
                    // Use the manual "Clean Stale Subscriptions" button only when needed.
                    if (failedCount > 0) {
                        console.warn('[FCM Push] Worker reported', failedCount, 'failed â€” subscriptions NOT auto-deleted (may be Firefox/Mozilla endpoints that worker cannot handle)');
                    }
                } else {
                    const errText = await resp.text().catch(() => resp.status);
                    console.warn('[FCM Push] Worker returned error:', resp.status, errText);
                    failedCount = subscriptions.length;
                    statusEl.style.display = 'block';
                    statusEl.style.background = '#f8d7da';
                    statusEl.style.color = '#721c24';
                    statusEl.textContent = `âŒ FCM Worker error ${resp.status}: ${errText}`;
                    btn.disabled = false;
                    btn.textContent = _notifTarget === 'all' ? 'ðŸ“¢ Send to All Devices' : _notifTarget === 'class' ? 'ðŸ« Send to Class' : 'ðŸ‘¤ Send to Person';
                    loadPushLogs();
                    return;
                }
            } catch(fcmErr) {
                console.warn('[FCM Push] Failed (in-app still delivered):', fcmErr.message);
                failedCount = subscriptions.length;
                statusEl.style.display = 'block';
                statusEl.style.background = '#f8d7da';
                statusEl.style.color = '#721c24';
                statusEl.textContent = `âŒ FCM Worker unreachable: ${fcmErr.message}`;
                btn.disabled = false;
                btn.textContent = _notifTarget === 'all' ? 'ðŸ“¢ Send to All Devices' : _notifTarget === 'class' ? 'ðŸ« Send to Class' : 'ðŸ‘¤ Send to Person';
                loadPushLogs();
                return;
            }

            // Save log
            const nowIST = new Date(Date.now() + 5.5*60*60*1000);
            const logRef = db.ref('push_logs').push();
            await logRef.set({
                title, body,
                sentAt: Date.now(),
                sentAtIST: nowIST.toISOString(),
                sent: sentCount,
                failed: failedCount,
                total: subscriptions.length,
                devices: deviceList,
                target: _notifTarget,
                targetClass: targetClass || null,
                targetName: targetName || null
            });

            const targetLabel = _notifTarget === 'all' ? 'all devices' : _notifTarget === 'class' ? `class: ${targetClass}` : `${targetName}`;
            statusEl.style.display = 'block';
            statusEl.style.background = '#d4edda';
            statusEl.style.color = '#155724';
            statusEl.textContent = `âœ… Sent to ${targetLabel}! FCM push: ${sentCount}/${subscriptions.length} delivered${failedCount > 0 ? ` (âš ï¸ ${failedCount} stale â€” use â€œClean Staleâ€ button below to remove them)` : ''}. (${pushEnabled} of ${totalRegistered} push-enabled)`;
            document.getElementById('notifTitle').value = '';
            document.getElementById('notifBody').value = '';
            loadPushLogs();

        } catch (err) {
            statusEl.style.display = 'block';
            statusEl.style.background = '#f8d7da';
            statusEl.style.color = '#721c24';
            statusEl.textContent = 'âŒ Failed to send: ' + err.message;
            console.error('[Push Send]', err);
        }

        btn.disabled = false;
        btn.textContent = _notifTarget === 'all' ? 'ðŸ“¢ Send to All Devices' : _notifTarget === 'class' ? 'ðŸ« Send to Class' : 'ðŸ‘¤ Send to Person';

    }

    async function retriggerPermissionBanner() {
        const btn = document.getElementById('retriggerBannerBtn');
        const statusEl = document.getElementById('retriggerStatus');
        btn.disabled = true;
        btn.textContent = 'â³ Sendingâ€¦';
        try {
            const db = window.db || firebase.database();
            await db.ref('notif_banner_retrigger').set({ triggeredAt: Date.now(), triggeredBy: 'admin' });
            statusEl.style.display = 'block';
            statusEl.style.background = '#d4edda';
            statusEl.style.color = '#155724';
            statusEl.textContent = 'âœ… Done! Banner will re-appear for all students on their next page load or within seconds if they are currently online.';
        } catch(err) {
            statusEl.style.display = 'block';
            statusEl.style.background = '#f8d7da';
            statusEl.style.color = '#721c24';
            statusEl.textContent = 'âŒ Failed: ' + err.message;
        }
        btn.disabled = false;
        btn.textContent = 'ðŸ”” Re-send Notification Permission Prompt to All Students';
        setTimeout(() => { statusEl.style.display = 'none'; }, 6000);
    }

    async function cleanStaleSubscriptions() {
        const btn = document.getElementById('cleanStaleBtn');
        const statusEl = document.getElementById('cleanStaleStatus');
        btn.disabled = true;
        statusEl.style.display = 'block';
        statusEl.style.background = '#e3f2fd';
        statusEl.style.color = '#0d47a1';
        statusEl.textContent = 'â³ Loading subscriptions from Firebaseâ€¦';
        try {
            const db = window.db || firebase.database();
            const snap = await db.ref('fcmTokens').once('value');
            const tokens = snap.val() || {};
            const entries = Object.entries(tokens).filter(([,t]) => t.subscription);
            if (entries.length === 0) {
                statusEl.style.background = '#fff3cd'; statusEl.style.color = '#856404';
                statusEl.textContent = 'âš ï¸ No push subscriptions found in Firebase.';
                btn.disabled = false; return;
            }
            statusEl.textContent = `â³ Testing ${entries.length} subscriptions one by oneâ€¦`;
            let removed = 0, kept = 0;
            for (let idx = 0; idx < entries.length; idx++) {
                const [sid, t] = entries[idx];
                statusEl.textContent = `â³ Testing ${idx + 1} / ${entries.length}â€¦`;
                let sub;
                try { sub = typeof t.subscription === 'string' ? JSON.parse(t.subscription) : t.subscription; } catch(e) { sub = null; }
                if (!sub || !sub.endpoint) {
                    await db.ref('fcmTokens/' + sid + '/subscription').remove();
                    removed++; continue;
                }
                // Send a test ping to the worker with just this one subscription
                try {
                    const resp = await fetch(FCM_WORKER_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ title: '_ping', body: '_test', subscriptions: [sub], sids: [sid] })
                    });
                    if (resp.ok) {
                        const result = await resp.json();
                        const failed = (result.failed || 0) > 0 || (result.sent || 0) === 0;
                        if (failed) {
                            await db.ref('fcmTokens/' + sid + '/subscription').remove();
                            removed++;
                        } else { kept++; }
                    } else { kept++; } // worker error â€” don't remove, might be temporary
                } catch(e) { kept++; } // network error â€” keep
                // Small delay to avoid rate limiting
                await new Promise(r => setTimeout(r, 300));
            }
            statusEl.style.background = '#d4edda'; statusEl.style.color = '#155724';
            statusEl.textContent = `âœ… Done! Removed ${removed} stale subscriptions, kept ${kept} valid. Next send will only target ${kept} device(s).`;
        } catch(err) {
            statusEl.style.background = '#f8d7da'; statusEl.style.color = '#721c24';
            statusEl.textContent = 'âŒ Error: ' + err.message;
        }
        btn.disabled = false;
    }

    async function forceUpdateSW() {
        const btn = document.getElementById('forceUpdateSWBtn');
        const statusEl = document.getElementById('forceUpdateSWStatus');
        btn.disabled = true;
        btn.textContent = 'â³ Sendingâ€¦';

        let firebaseOk = false;
        let localOk = false;

        try {
            const db = window.db || firebase.database();
            await db.ref('sw_force_update').set({ triggeredAt: Date.now(), triggeredBy: 'admin' });
            firebaseOk = true;
        } catch(err) {
            console.warn('[ForceUpdateSW] Firebase write failed:', err.message);
        }

        try {
            if ('serviceWorker' in navigator) {
                const reg = await navigator.serviceWorker.ready;
                await reg.update();
                localOk = true;
            }
        } catch(err) {
            console.warn('[ForceUpdateSW] Local SW update failed:', err.message);
        }

        statusEl.style.display = 'block';
        if (firebaseOk) {
            statusEl.style.background = '#d4edda';
            statusEl.style.color = '#155724';
            statusEl.textContent = 'âœ… Done! All online devices will reload sw.js within seconds.';
        } else {
            statusEl.style.background = '#fff3cd';
            statusEl.style.color = '#856404';
            statusEl.textContent = localOk
                ? 'âš ï¸ This device\'s SW updated, but couldn\'t signal others (Firebase rules block sw_force_update). Add ".read":true,".write":true for sw_force_update in Firebase Rules.'
                : 'âŒ Firebase blocked. Add sw_force_update rule in Firebase Console â†’ Rules.';
        }

        btn.disabled = false;
        btn.textContent = 'ðŸ”„ Force Service Worker Update on All Devices';
        setTimeout(() => { statusEl.style.display = 'none'; }, 15000);
    }

    async function forceResubscribeAll() {
        const btn = document.getElementById('forceResubBtn');
        const statusEl = document.getElementById('forceResubStatus');
        btn.disabled = true;
        btn.textContent = 'â³ Sendingâ€¦';
        statusEl.style.display = 'none';

        let firebaseOk = false;
        let localOk = false;

        // 1. Try Firebase signal (requires Firebase rules to allow write to push_force_resub)
        try {
            const db = window.db || firebase.database();
            await db.ref('push_force_resub').set({ triggeredAt: Date.now(), triggeredBy: 'admin' });
            firebaseOk = true;
        } catch(err) {
            console.warn('[ForceResub] Firebase write failed (check rules):', err.message);
        }

        // 2. Always re-subscribe on THIS device regardless of Firebase result
        try {
            if ('serviceWorker' in navigator && Notification.permission === 'granted') {
                const reg = await navigator.serviceWorker.ready;
                localStorage.removeItem('spurthi_push_subbed_v2');
                await subscribeToPush(reg, true);
                localOk = true;
            }
        } catch(err) {
            console.warn('[ForceResub] Local re-subscribe failed:', err.message);
        }

        statusEl.style.display = 'block';
        if (firebaseOk && localOk) {
            statusEl.style.background = '#d4edda';
            statusEl.style.color = '#155724';
            statusEl.textContent = 'âœ… Done! Signal sent to all online devices + this device re-subscribed. Send a test notification now.';
        } else if (localOk) {
            statusEl.style.background = '#fff3cd';
            statusEl.style.color = '#856404';
            statusEl.textContent = 'âš ï¸ This device re-subscribed successfully, but couldn\'t signal other devices (Firebase rules block push_force_resub). Add ".read": true, ".write": true for push_force_resub in Firebase Rules. Students who reload their page will re-subscribe automatically.';
        } else if (firebaseOk) {
            statusEl.style.background = '#d4edda';
            statusEl.style.color = '#155724';
            statusEl.textContent = 'âœ… Signal sent to all online devices. This device has no notification permission.';
        } else {
            statusEl.style.background = '#f8d7da';
            statusEl.style.color = '#721c24';
            statusEl.textContent = 'âŒ Firebase blocked (add push_force_resub rule) and no local SW permission. Go to Firebase Console â†’ Rules and add: "push_force_resub": {".read":true,".write":true}';
        }

        btn.disabled = false;
        btn.textContent = 'ðŸ” Force Re-subscribe All Devices to Push';
        setTimeout(() => { statusEl.style.display = 'none'; }, 20000);
    }

    function loadSwDebugLog() {
        const el = document.getElementById('swDebugLog');
        if (!el) return;
        const db = window.db || firebase.database();
        db.ref('sw_debug').orderByChild('ts').limitToLast(30).once('value').then(snap => {
            const data = snap.val();
            if (!data) { el.innerHTML = '<span style="color:#555">No debug logs yet â€” send a notification to see sw.js activity.</span>'; return; }
            const entries = Object.values(data).sort((a, b) => b.ts - a.ts);
            const colors = { push_received:'#ffcc02', push_showing:'#a8ff78', push_shown_ok:'#00e676', push_show_error:'#ff5252', push_parse_error:'#ff5252', install:'#64b5f6', activate:'#64b5f6', notification_clicked:'#ce93d8' };
            el.innerHTML = entries.map(e => {
                const t = new Date(e.ts);
                const tStr = t.toLocaleTimeString('en-IN', {hour:'2-digit',minute:'2-digit',second:'2-digit'});
                const col = colors[e.step] || '#ccc';
                return `<div style="margin-bottom:6px;border-bottom:1px solid #1a1a2e;padding-bottom:6px"><span style="color:#555">${tStr}</span> <span style="color:${col};font-weight:700">[${e.step}]</span> <span style="color:#ddd">${e.detail || ''}</span></div>`;
            }).join('');
        }).catch(err => { el.innerHTML = '<span style="color:#ff5252">Error loading: ' + err.message + '</span>'; });
    }

    function clearSwDebugLog() {
        const db = window.db || firebase.database();
        db.ref('sw_debug').remove().then(() => {
            const el = document.getElementById('swDebugLog');
            if (el) el.innerHTML = '<span style="color:#555">Log cleared.</span>';
        });
    }

    // Auto-refresh debug log every 3s when push panel is open
    let _swDebugInterval = null;
    function startSwDebugPolling() {
        loadSwDebugLog();
        _swDebugInterval = setInterval(loadSwDebugLog, 3000);
    }
    function stopSwDebugPolling() {
        clearInterval(_swDebugInterval);
    }

    // Mark notifications as seen when student opens site
    async function markNotificationsSeen() {
        try {
            const sid = getSessionId();
            const db = window.db || firebase.database();
            const idSnap = await db.ref('fcmTokens/' + sid + '/identity').once('value');
            const identity = idSnap.val() || {};
            const deviceSnap = await db.ref('fcmTokens/' + sid + '/device').once('value');
            const device = deviceSnap.val() || 'Unknown';
            const cutoff = Date.now() - 7*24*60*60*1000;
            const logsSnap = await db.ref('push_logs').orderByChild('sentAt').startAt(cutoff).once('value');
            const logs = logsSnap.val();
            if (!logs) return;
            const nowTs = Date.now();
            const updates = {};
            for (const [logId, log] of Object.entries(logs)) {
                if (!log.seen || !log.seen[sid]) {
                    updates[`push_logs/${logId}/seen/${sid}`] = {
                        sid, name: identity.name||'', class: identity.class||'', device, seenAt: nowTs
                    };
                }
            }
            if (Object.keys(updates).length > 0) await db.ref().update(updates);
        } catch(e) { console.warn('[Seen]', e.message); }
    }

    document.addEventListener('DOMContentLoaded', () => {
        setTimeout(markNotificationsSeen, 3000);
    });

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // ðŸ“£ IN-APP REAL-TIME NOTIFICATION TOAST
    // Listens to Firebase live_notifications/latest
    // Works on ALL browsers â€” Opera, Chrome, Safari, Firefox
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    let _inAppLastId = null;
    let _inAppDismissTimer = null;
    window._currentUserName  = window._currentUserName  || '';
    window._currentUserClass = window._currentUserClass || '';

    function showInAppToast(title, body) {
        const toast = document.getElementById('inAppNotifToast');
        if (!toast) { console.warn('[Toast] element not found!'); return; }
        document.getElementById('inAppNotifTitle').textContent = title;
        document.getElementById('inAppNotifBody').textContent  = body;
        toast.style.cssText = 'display:block;position:fixed;top:0;left:0;right:0;z-index:999999;background:linear-gradient(135deg,#c44569,#6a1b9a);color:#fff;padding:16px 20px;box-shadow:0 4px 20px rgba(0,0,0,0.5)';
        // Reset and start progress bar
        const bar = document.getElementById('inAppNotifBar');
        if (bar) { bar.style.transition = 'none'; bar.style.width = '100%'; }
        setTimeout(() => { if (bar) { bar.style.transition = 'width 8s linear'; bar.style.width = '0%'; } }, 50);
        // Auto dismiss after 8s
        clearTimeout(_inAppDismissTimer);
        _inAppDismissTimer = setTimeout(dismissInAppToast, 8000);
        console.log('[Toast] displayed successfully');
    }

    function dismissInAppToast() {
        clearTimeout(_inAppDismissTimer);
        const toast = document.getElementById('inAppNotifToast');
        if (toast) toast.style.display = 'none';
    }

    // Start listening as soon as Firebase is ready
    (function startInAppNotifListener() {
        const waitForDb = setInterval(() => {
            if (window.db) {
                clearInterval(waitForDb);

                // Core function to evaluate and show a notification
                window._evalInAppNotif = function(data) {
                    if (!data || !data.id) return;
                    if (_inAppLastId === data.id) return;
                    const age = Date.now() - data.sentAt;
                    console.log('[Toast] id:', data.id, 'age:', Math.round(age/1000)+'s', 'targetName:', data.targetName, 'myName:', window._currentUserName);
                    if (age > 30 * 60 * 1000) { _inAppLastId = data.id; console.log('[Toast] BLOCKED: too old (>30min)'); return; }
                    // Class filter â€” only block if MY class is known AND doesn't match
                    if (data.targetClass) {
                        const myClass = (window._currentUserClass || '').trim().toLowerCase();
                        const tClass  = data.targetClass.trim().toLowerCase();
                        if (myClass && myClass !== tClass) { console.log('[Toast] BLOCKED: class mismatch', myClass, '!=', tClass); return; }
                    }
                    // Person filter â€” only block if MY name is known AND doesn't match
                    if (data.targetName) {
                        const myName = (window._currentUserName || '').trim().toLowerCase();
                        const tName  = data.targetName.trim().toLowerCase();
                        const genericNames = ['', 'student', 'cr', 'guest'];
                        if (genericNames.includes(myName)) {
                            // Real name not yet known â€” look up FCM identity from Firebase
                            console.log('[Toast] PENDING: real name not known, checking FCM identity...');
                            const sid = getSessionId();
                            window.db.ref('fcmTokens/' + sid + '/identity').once('value').then(snap => {
                                const id = snap.val();
                                if (id && id.name && !genericNames.includes(id.name.toLowerCase())) {
                                    window._currentUserName = id.name;
                                    window._currentUserClass = id.class || window._currentUserClass || '';
                                    console.log('[Toast] FCM identity resolved:', id.name, 'â€” re-evaluating toast');
                                    window._evalInAppNotif(data);
                                } else {
                                    console.log('[Toast] BLOCKED: no real identity in FCM token');
                                }
                            }).catch(() => {});
                            return;
                        }
                        if (myName !== tName) { _inAppLastId = data.id; console.log('[Toast] BLOCKED: name mismatch', myName, '!=', tName); return; }
                    }
                    console.log('[Toast] SHOWING toast!');
                    _inAppLastId = data.id;
                    showInAppToast(data.title, data.body);
                };

                // Listen to /latest (all, class, and person targeted)
                window.db.ref('live_notifications/latest').on('value', snap => {
                    if (!snap.exists()) return;
                    window._evalInAppNotif(snap.val());
                });
            }
        }, 500);
    })();
    // â”€â”€ EXPOSE ALL ONCLICK FUNCTIONS TO GLOBAL WINDOW SCOPE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // This script runs inside an IIFE â€” functions must be assigned to window
    // for HTML onclick= handlers to find them
    window.refreshDeviceCount      = refreshDeviceCount;
    window.toggleDevicesPanel      = toggleDevicesPanel;
    window.filterDevices           = filterDevices;
    window.renderDeviceList        = renderDeviceList;
    window.setNotifTarget          = setNotifTarget;
    // â”€â”€ CLOUDFLARE WORKER CODE TEMPLATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const CF_WORKER_CODE = `// fcm-push Cloudflare Worker
// Deploy at: https://dash.cloudflare.com â†’ Workers â†’ Create Worker
// Paste this entire file, then click Deploy.
// âš ï¸ VAPID keys below are matched to the HTML file â€” do NOT change them.

const VAPID_PUBLIC_KEY  = 'BLrDcA6CEFSxsK5JphRx7YpKx-aZFvE3jiJgxYkMtIj2iVGNEII3pYoDmP6w3gUtEF9H2AI6Wm3TL5628_6iKTg';
const VAPID_PRIVATE_KEY = 'l3s13VcNmE3X4yhFo3hTcwELH07HMK71ItNEsTeBMUw';
const VAPID_SUBJECT     = 'mailto:harshgujjar@example.com';

function base64urlToUint8Array(base64url) {
    const pad = '='.repeat((4 - base64url.length % 4) % 4);
    const b64 = (base64url + pad).replace(/-/g, '+').replace(/_/g, '/');
    const raw = atob(b64);
    return Uint8Array.from([...raw].map(c => c.charCodeAt(0)));
}

function uint8ArrayToBase64url(arr) {
    return btoa(String.fromCharCode(...arr))
        .replace(/\+/g, '-').replace(/\//g, '_').replace(/=/g, '');
}

async function makeVapidHeaders(endpoint, subject, publicKeyB64, privateKeyB64) {
    const audience = new URL(endpoint).origin;
    const now = Math.floor(Date.now() / 1000);
    const header = uint8ArrayToBase64url(new TextEncoder().encode(JSON.stringify({ typ: 'JWT', alg: 'ES256' })));
    const payload = uint8ArrayToBase64url(new TextEncoder().encode(JSON.stringify({ aud: audience, exp: now + 43200, sub: subject })));
    const sigInput = header + '.' + payload;
    const privKeyBytes = base64urlToUint8Array(privateKeyB64);
    const cryptoKey = await crypto.subtle.importKey(
        'raw', privKeyBytes, { name: 'ECDH', namedCurve: 'P-256' }, false, []
    ).catch(async () => {
        // Try PKCS8 import as fallback
        return crypto.subtle.importKey(
            'jwk',
            { kty: 'EC', crv: 'P-256', d: privateKeyB64,
              x: publicKeyB64.substring(0, 43), y: publicKeyB64.substring(43, 86), ext: true },
            { name: 'ECDSA', namedCurve: 'P-256' }, false, ['sign']
        );
    });
    // Use ECDSA signing directly
    const privKey = await crypto.subtle.importKey(
        'jwk',
        { kty: 'EC', crv: 'P-256', d: privateKeyB64,
          x: 'twJAtYJ_UTPTamHoELvIj2-01vtmYvaDid-66345Rxg',
          y: 'p_8g4Dn8SgookhtKhbLGXhYRsdwBVZ-yWGMlVSMnoNw', ext: true },
        { name: 'ECDSA', namedCurve: 'P-256' }, false, ['sign']
    );
    const sig = await crypto.subtle.sign(
        { name: 'ECDSA', hash: 'SHA-256' },
        privKey,
        new TextEncoder().encode(sigInput)
    );
    const jwt = sigInput + '.' + uint8ArrayToBase64url(new Uint8Array(sig));
    return {
        Authorization: 'vapid t=' + jwt + ', k=' + publicKeyB64,
        'Crypto-Key': 'p256ecdsa=' + publicKeyB64
    };
}

async function sendPush(subscription, payload) {
    const endpoint = subscription.endpoint;
    const headers = await makeVapidHeaders(endpoint, VAPID_SUBJECT, VAPID_PUBLIC_KEY, VAPID_PRIVATE_KEY);
    const body = new TextEncoder().encode(JSON.stringify(payload));
    const resp = await fetch(endpoint, {
        method: 'POST',
        headers: { ...headers, 'Content-Type': 'application/json', 'Content-Length': body.length, 'TTL': '86400' },
        body
    });
    return resp;
}

export default {
    async fetch(request, env) {
        const corsHeaders = {
            'Access-Control-Allow-Origin': '*',
            'Access-Control-Allow-Methods': 'POST, OPTIONS',
            'Access-Control-Allow-Headers': 'Content-Type'
        };
        if (request.method === 'OPTIONS') return new Response(null, { headers: corsHeaders });
        if (request.method !== 'POST') return new Response('Method not allowed', { status: 405, headers: corsHeaders });

        let body;
        try { body = await request.json(); } catch(e) { return new Response('Invalid JSON', { status: 400, headers: corsHeaders }); }

        const { title, body: msgBody, subscriptions, sids } = body;
        if (!title || !msgBody || !subscriptions || !subscriptions.length) {
            return new Response('Missing fields', { status: 400, headers: corsHeaders });
        }

        let sent = 0, failed = 0;
        const failedSids = [];
        for (let i = 0; i < subscriptions.length; i++) {
            const sub = subscriptions[i];
            try {
                const resp = await sendPush(sub, { title, body: msgBody, notification: { title, body: msgBody } });
                if (resp.ok || resp.status === 201) { sent++; }
                else { failed++; if (sids && sids[i]) failedSids.push(sids[i]); }
            } catch(e) { failed++; if (sids && sids[i]) failedSids.push(sids[i]); }
        }
        return new Response(JSON.stringify({ sent, failed, failedSids }), {
            headers: { ...corsHeaders, 'Content-Type': 'application/json' }
        });
    }
};`;

    function populateWorkerCodeArea() {
        const ta = document.getElementById('cfWorkerCodeArea');
        if (ta) ta.value = CF_WORKER_CODE;
    }

    function copyWorkerCode() {
        const ta = document.getElementById('cfWorkerCodeArea');
        if (!ta) return;
        navigator.clipboard.writeText(ta.value)
            .then(() => alert('âœ… Worker code copied! Now go to Cloudflare Dashboard â†’ Workers â†’ fcm-push â†’ Edit â†’ paste this â†’ Deploy.'))
            .catch(() => { ta.select(); document.execCommand('copy'); alert('âœ… Copied!'); });
    }

    function downloadWorkerCode() {
        const blob = new Blob([CF_WORKER_CODE], { type: 'application/javascript' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = 'fcm-push-worker.js';
        a.click();
        URL.revokeObjectURL(a.href);
    }

    window.copyWorkerCode    = copyWorkerCode;
    window.downloadWorkerCode = downloadWorkerCode;

    // Populate worker code textarea when panel becomes visible
    document.addEventListener('DOMContentLoaded', () => {
        setTimeout(populateWorkerCodeArea, 500);
    });
    setTimeout(populateWorkerCodeArea, 1000);

    // â”€â”€ FIREBASE RULES CHECKER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function checkAndShowFirebaseRulesFix() {
        const btn = document.getElementById('firebaseRulesBtn');
        const resultEl = document.getElementById('firebaseRulesResult');
        btn.disabled = true;
        btn.textContent = 'â³ Testing Firebase Rulesâ€¦';
        resultEl.style.display = 'block';
        resultEl.innerHTML = 'â³ Testing write access to fcmTokens/â€¦';

        const db = window.db || firebase.database();
        const sid = getSessionId();
        let writeOk = false, readOk = false;

        try {
            await db.ref('fcmTokens/' + sid + '/_ruletest').set({ t: Date.now() });
            await db.ref('fcmTokens/' + sid + '/_ruletest').remove();
            writeOk = true;
        } catch(e) { writeOk = false; }

        try {
            await db.ref('fcmTokens/' + sid).once('value');
            readOk = true;
        } catch(e) { readOk = false; }

        const rulesJson = `{
  "rules": {
    ".read": false,
    ".write": false,
    "fcmTokens": { ".read": true, ".write": true },
    "push_force_resub": { ".read": true, ".write": true },
    "sw_force_update": { ".read": true, ".write": true },
    "live_notifications": { ".read": true, ".write": true }
  }
}`;

        if (writeOk && readOk) {
            resultEl.style.background = 'rgba(46,125,50,0.3)';
            resultEl.innerHTML = 'âœ… Firebase Rules OK â€” fcmTokens is readable and writable.<br>Click <strong>Force Re-subscribe</strong> then send a test notification.';
        } else {
            resultEl.style.background = 'rgba(183,28,28,0.25)';
            resultEl.innerHTML = `<span style="color:#ff5252;font-weight:700;font-size:13px">âŒ Firebase Rules are BLOCKING ${!writeOk ? 'WRITES' : ''}${!writeOk && !readOk ? ' and ' : ''}${!readOk ? 'READS' : ''} to fcmTokens/ â€” THIS IS WHY NOTIFICATIONS ARE NOT WORKING.</span><br><br>
<strong>Fix in 2 minutes:</strong><br>
1. Open <a href="https://console.firebase.google.com" target="_blank" style="color:#80cbc4">Firebase Console</a> â†’ your project â†’ Realtime Database â†’ <strong>Rules</strong> tab<br>
2. Replace rules with this and click <strong>Publish</strong>:<br><br>
<textarea id="_rulesTextarea" style="width:100%;height:150px;font-family:monospace;font-size:11px;background:#111;color:#a5d6a7;border:1px solid #444;border-radius:6px;padding:8px;resize:none">${rulesJson}</textarea>
<button onclick="navigator.clipboard.writeText(document.getElementById('_rulesTextarea').value).then(()=>this.textContent='âœ… Copied!').catch(()=>{})" style="margin-top:6px;background:#1565c0;color:#fff;border:none;padding:6px 16px;border-radius:12px;cursor:pointer;font-size:12px;font-weight:700">ðŸ“‹ Copy Rules JSON</button><br>
<small style="color:#aaa">3. After publishing, click Force Re-subscribe â†’ then send notification again.</small>`;
        }
        btn.disabled = false;
        btn.textContent = 'ðŸ” Check Firebase Rules (Fix if Notifications Broken)';
    }
    // â”€â”€ NOTIFICATION HISTORY DELETION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function toggleClearOldPanel() {
        const panel = document.getElementById('clearOldPanel');
        if (!panel) return;
        const isOpen = panel.style.display !== 'none';
        panel.style.display = isOpen ? 'none' : 'block';
        if (!isOpen) {
            // Default date to today
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('clearOldDateInput').value = today;
            document.getElementById('clearOldStatus').style.display = 'none';
        }
    }

    async function deleteLogEntry(logId) {
        if (!confirm('Delete this notification entry permanently?')) return;
        try {
            const db = window.db || firebase.database();
            await db.ref('push_logs/' + logId).remove();
            loadPushLogs();
        } catch(e) {
            alert('Failed to delete: ' + e.message);
        }
    }

    async function clearOldLogs() {
        const dateInput = document.getElementById('clearOldDateInput');
        const statusEl = document.getElementById('clearOldStatus');
        if (!dateInput || !dateInput.value) {
            alert('Please pick a date first.');
            return;
        }
        const cutoffDate = new Date(dateInput.value);
        cutoffDate.setHours(23, 59, 59, 999); // end of selected day
        const cutoffTs = cutoffDate.getTime();

        if (!confirm(`Delete all notification history sent on or before ${dateInput.value}?`)) return;

        statusEl.style.display = 'block';
        statusEl.style.color = '#555';
        statusEl.textContent = 'â³ Deletingâ€¦';

        try {
            const db = window.db || firebase.database();
            const snap = await db.ref('push_logs').once('value');
            if (!snap.exists()) {
                statusEl.style.color = '#888';
                statusEl.textContent = 'No entries found.';
                return;
            }
            const logs = snap.val();
            const toDelete = Object.entries(logs).filter(([, log]) => log.sentAt <= cutoffTs);
            if (toDelete.length === 0) {
                statusEl.style.color = '#856404';
                statusEl.textContent = `No entries found on or before ${dateInput.value}.`;
                return;
            }
            const updates = {};
            toDelete.forEach(([logId]) => { updates['push_logs/' + logId] = null; });
            await db.ref().update(updates);
            statusEl.style.color = '#155724';
            statusEl.textContent = `âœ… Deleted ${toDelete.length} entr${toDelete.length === 1 ? 'y' : 'ies'}.`;
            setTimeout(() => {
                document.getElementById('clearOldPanel').style.display = 'none';
                loadPushLogs();
            }, 1500);
        } catch(e) {
            statusEl.style.color = '#b71c1c';
            statusEl.textContent = 'âŒ Failed: ' + e.message;
        }
    }

    window.toggleClearOldPanel = toggleClearOldPanel;
    window.deleteLogEntry       = deleteLogEntry;
    window.clearOldLogs         = clearOldLogs;

    window.checkAndShowFirebaseRulesFix = checkAndShowFirebaseRulesFix;

    window.sendPushNotification    = sendPushNotification;
    window.initPushNotifPanel      = initPushNotifPanel;
    window.loadPushLogs            = loadPushLogs;
    window.showSentDevices         = showSentDevices;
    window.showSeenDevices         = showSeenDevices;
    window.dismissInAppToast       = dismissInAppToast;
    window.requestNotifPermission  = requestNotifPermission;
    window.dismissNotifBanner      = dismissNotifBanner;
    window.showSwJsCode            = showSwJsCode;
    window.copySwJs                = copySwJs;
    window.testPushLocally         = testPushLocally;
    window.maybeShowNotifBanner    = maybeShowNotifBanner;
    window.retriggerPermissionBanner = retriggerPermissionBanner;
    window.cleanStaleSubscriptions  = cleanStaleSubscriptions;
    window.forceUpdateSW             = forceUpdateSW;
    window.forceResubscribeAll        = forceResubscribeAll;
    window.loadSwDebugLog           = loadSwDebugLog;
    window.clearSwDebugLog          = clearSwDebugLog;
    window.startSwDebugPolling      = startSwDebugPolling;
    window.stopSwDebugPolling       = stopSwDebugPolling;
    window.initLiveUsersPanel      = initLiveUsersPanel;
    window.refreshLiveUsers        = refreshLiveUsers;

    // â”€â”€ WIRE BUTTONS VIA addEventListener (bulletproof â€” no onclick scope issues) â”€â”€
    document.addEventListener('DOMContentLoaded', function() {
        // Retry wiring after a short delay in case DOM isn't ready
        function wireButtons() {
            const swBtn   = document.getElementById('swJsCodeBtn');
            const testBtn = document.getElementById('testPushBtn');
            if (swBtn)   swBtn.addEventListener('click',   function() { showSwJsCode(); });
            if (testBtn) testBtn.addEventListener('click', function() {
                const res = document.getElementById('testPushResult');
                if (res) res.textContent = 'â³ Running...';
                testPushLocally().catch(function(e) {
                    if (res) res.textContent = 'âŒ ' + e.message;
                    alert('Test Push error: ' + e.message);
                });
            });
        }
        wireButtons();
        setTimeout(wireButtons, 1500); // retry after panel might be shown
    });
    })();
    </script>

    <footer style="background: white; border-radius: 12px; padding: 25px; margin-top: 30px; box-shadow: 0 4px 20px rgba(0,0,0,0.1);">
        <div style="text-align: center;">
            
            <!-- ================================================== -->
            <!-- CIRCULAR LOGO (Top)                                -->
            <!-- ================================================== -->
            <div style="margin-bottom: 0px;">
                <img src="davan_logo_2026.gif" alt="Spurthi Davan Circular Logo" style="height: 200px; width: auto; display: inline-block;" id="devTriggerLogo">
            </div>
            
            <p style="color: #6a1b9a; font-size: 0.9em; margin-bottom: 8px;">
                Â© 2026 Davan Institute of Advanced Management Studies
            </p>
            
            <!-- ============================================ -->
            <!-- SUPER ADMIN: UPDATE VERSION AND DATE HERE    -->
            <!-- ============================================ -->
            <p style="color: #666; font-size: 0.85em; margin-bottom: 8px;" id="devTriggerVersion">
                <strong>Version:</strong> 5.45 â€” Fixed InvalidAccessError: replaced malformed 64-byte VAPID public key with valid 65-byte key pair | <strong>Last Updated:</strong> Mar 01, 2026</p>
            <!-- ============================================ -->
            
            <p style="color: #c44569; font-size: 0.85em; font-weight: 600; margin-bottom: 8px;">
                Built by Harsha Gujjar, Director - Davan College
            </p>

            <!-- ================================================== -->
            <!-- TEXT LOGO (Below "Built by" line)                  -->
            <!-- ================================================== -->
            <div style="margin-top: 12px;">
                <img src="davan_logo.png" alt="Spurthi Davan Text Logo" style="height: 80px; width: auto; display: inline-block;">
            </div>

        </div>
    </footer>