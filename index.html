<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spurthi Youth Fest 2026</title>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #c44569 0%, #6a1b9a 100%); min-height: 100vh; padding: 20px; }
        .container { max-width: 1400px; margin: 0 auto; }
        .banner { width: 100%; max-width: 1200px; margin: 0 auto 30px; border-radius: 12px; box-shadow: 0 10px 40px rgba(0,0,0,0.3); display: block; }
        .header { text-align: center; color: white; margin-bottom: 30px; }
        .header h1 { font-size: 1.8em; }
        .admin-badge { display: inline-block; background: #FFD700; color: #333; padding: 5px 15px; border-radius: 20px; font-size: 0.9em; font-weight: bold; margin-left: 10px; }
        
        /* Class Indicator */
        .class-indicator {
            background: white;
            padding: 15px 25px;
            border-radius: 8px;
            margin: 20px auto;
            max-width: 500px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            display: none;
        }
        .class-indicator.active {
            display: block;
        }
        .class-indicator h3 {
            color: #6a1b9a;
            font-size: 1.2em;
            margin-bottom: 8px;
        }
        .class-indicator .class-name {
            color: #c44569;
            font-size: 1.5em;
            font-weight: bold;
        }
        
        /* Admin Dashboard */
        .admin-dashboard {
            background: white;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }
        .dashboard-title {
            color: #c44569;
            font-size: 1.8em;
            margin-bottom: 25px;
            text-align: center;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 6px 20px rgba(0,0,0,0.15);
            transition: transform 0.3s;
        }
        .stat-card:hover {
            transform: translateY(-5px);
        }
        .stat-number {
            font-size: 3em;
            font-weight: bold;
            margin-bottom: 10px;
        }
        .stat-label {
            font-size: 1.1em;
            opacity: 0.9;
        }
        
        .tabs { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
        .tab { padding: 12px 24px; background: white; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: 600; transition: all 0.3s; }
        .tab:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.2); }
        .tab.active { background: linear-gradient(135deg, #c44569 0%, #6a1b9a 100%); color: white; }
        .content { background: white; border-radius: 12px; padding: 30px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); }
        .form-section { display: none; }
        .form-section.active { display: block; }
        .form-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; font-weight: 600; color: #333; }
        input, select { width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 6px; font-size: 16px; transition: border-color 0.3s; }
        input:focus, select:focus { outline: none; border-color: #c44569; }
        .event-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 15px; margin: 20px 0; }
        .event-card { padding: 20px; border: 3px solid #ddd; border-radius: 12px; cursor: pointer; transition: all 0.3s; background: white; position: relative; }
        .event-card:hover { border-color: #c44569; transform: translateY(-3px); box-shadow: 0 6px 20px rgba(196, 69, 105, 0.3); }
        .event-card.full { border-color: #f44336; background: #ffebee; cursor: not-allowed; opacity: 0.7; }
        .event-card.full:hover { transform: none; }
        .event-title { font-size: 1.1em; font-weight: bold; margin-bottom: 8px; }
        .event-size { font-size: 0.9em; opacity: 0.8; margin-bottom: 5px; }
        .event-status { font-size: 0.85em; padding: 5px 10px; border-radius: 15px; display: inline-block; margin-top: 5px; font-weight: bold; }
        .status-full { background: #f44336; color: white; }
        .status-available { background: #4CAF50; color: white; }
        .status-limited { background: #FF9800; color: white; }
        .team-member-box { border: 2px solid #c44569; padding: 15px; border-radius: 8px; margin-bottom: 15px; background: #f9f9f9; }
        .member-header { color: #6a1b9a; font-weight: bold; margin-bottom: 10px; font-size: 1.1em; }
        .btn { padding: 12px 30px; background: linear-gradient(135deg, #c44569 0%, #6a1b9a 100%); color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.3s; }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(0,0,0,0.2); }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }
        .btn-secondary { background: #666; }
        .btn-small { padding: 6px 12px; font-size: 14px; }
        .message { padding: 15px; border-radius: 6px; margin-bottom: 20px; display: none; }
        .message.show { display: block; }
        .message.success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .message.error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.7); overflow-y: auto; }
        .modal-content { background-color: white; margin: 50px auto; padding: 30px; border-radius: 12px; width: 90%; max-width: 600px; }
        .modal-header { font-size: 1.5em; color: #c44569; margin-bottom: 20px; text-align: center; }
        .modal-icon { font-size: 4em; margin-bottom: 20px; text-align: center; }
        .modal-buttons { margin-top: 20px; display: flex; gap: 10px; justify-content: center; flex-wrap: wrap; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #ddd; }
        th { background: linear-gradient(135deg, #c44569 0%, #6a1b9a 100%); color: white; font-weight: 600; }
        tr:hover { background: #f5f5f5; }
        .edit-btn { background: #2196F3; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; margin-right: 5px; }
        .delete-btn { background: #f44336; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; }
        .filter-section { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
        .filter-section select { flex: 1; min-width: 200px; }
        .admin-only { display: none; }
        .student-section { background: #f0f0f0; padding: 20px; border-radius: 8px; margin-bottom: 30px; }
        .cr-section { background: #e3f2fd; padding: 20px; border-radius: 8px; margin-bottom: 20px; border: 2px solid #2196F3; }
        @media (max-width: 768px) { .event-grid { grid-template-columns: 1fr; } .filter-section { flex-direction: column; } }
        /* Firebase Status Indicator */
        .firebase-status {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: white;
            padding: 12px 20px;
            border-radius: 25px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            display: flex;
            align-items: center;
            gap: 10px;
            z-index: 999;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s;
        }
        .firebase-status:hover {
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
            transform: translateY(-2px);
        }
        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }
        .status-connected {
            background: #4CAF50;
            box-shadow: 0 0 10px rgba(76, 175, 80, 0.5);
        }
        .status-disconnected {
            background: #f44336;
            box-shadow: 0 0 10px rgba(244, 67, 54, 0.5);
            animation: blink 1s infinite;
        }
        .status-checking {
            background: #FF9800;
            box-shadow: 0 0 10px rgba(255, 152, 0, 0.5);
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        @keyframes blink {
            0%, 50%, 100% { opacity: 1; }
            25%, 75% { opacity: 0.3; }
        }
        @media (max-width: 768px) {
            .firebase-status {
                bottom: 10px;
                right: 10px;
                padding: 8px 15px;
                font-size: 12px;
            }
            .status-dot {
                width: 10px;
                height: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- BANNER IMAGE - Replace src with your base64 data -->
        <img src="banner.gif?v=5" class="banner">
        <!-- TO EMBED YOUR BANNER: See SETUP_INSTRUCTIONS.txt -->
        
        <div class="header"><h1>üé≠ Spurthi Youth Fest 2026 üé≠<span id="userBadge"></span></h1></div>
        
        <!-- Class Indicator (shown when class is selected) -->
        <div class="class-indicator" id="classIndicator">
            <h3>üìö You are enrolling for:</h3>
            <div class="class-name" id="selectedClassName"></div>
        </div>

        
        <!-- Firebase Status Indicator -->
        <div class="firebase-status" id="firebaseStatus">
            <div class="status-dot status-checking" id="statusDot"></div>
            <span id="statusText">Checking...</span>
        </div>
        
        <div class="tabs">
            <button class="tab active" onclick="switchTab('enroll')">üìù Enroll</button>
            <button class="tab admin-only" onclick="switchTab('dashboard')" style="display:none;">üìä Dashboard</button>
            <button class="tab admin-only" onclick="switchTab('master')" style="display:none;">üìã Master</button>
            <button class="tab admin-only" onclick="switchTab('eventwise')" style="display:none;">üé≠ Events</button>
            <button class="tab" onclick="switchTab('admin')">üîê Admin</button>
        </div>
        
        <div class="content">
            <!-- Enrollment Section -->
            <div id="enrollSection" class="form-section active">
                <h2 style="color: #c44569; margin-bottom: 20px;">Student Enrollment</h2>
                
                <!-- Student Search & Edit -->
                <div class="student-section">
                    <h3 style="color: #6a1b9a; margin-bottom: 10px;">üì± Manage Your Enrollments</h3>
                    <p style="margin-bottom: 10px;">Enter your phone number:</p>
                    <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                        <input type="tel" id="studentPhone" placeholder="10 digits" maxlength="10" style="max-width: 250px;">
                        <button class="btn btn-small" onclick="searchStudent()">Search</button>
                        <button class="btn btn-secondary btn-small" onclick="clearStudentSearch()">Clear</button>
                    </div>
                    <div id="studentResults"></div>
                </div>
                
                <!-- CR Section -->
                <div class="cr-section">
                    <h3 style="color: #1976D2; margin-bottom: 10px;">üë• Class Representative Mode</h3>
                    <p style="margin-bottom: 10px;">View and download your class enrollments:</p>
                    <div style="display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap;">
                        <select id="crClass" style="max-width: 300px;">
                            <option value="">-- Select Your Class --</option>
                            <option value="1st B.Com">1st B.Com</option>
                            <option value="2nd B.Com">2nd B.Com</option>
                            <option value="3rd B.Com">3rd B.Com</option>
                            <option value="1ST BCA">1ST BCA</option>
                            <option value="2ND BCA A SEC">2ND BCA A SEC</option>
                            <option value="2ND BCA B SEC">2ND BCA B SEC</option>
                            <option value="3RD BCA A SEC">3RD BCA A SEC</option>
                            <option value="3RD BCA B SEC">3RD BCA B SEC</option>
                            <option value="3RD BCA C SEC">3RD BCA C SEC</option>
                            <option value="2ND BBA">2ND BBA</option>
                            <option value="3RD BBA">3RD BBA</option>
                        </select>
                        <button class="btn btn-small" onclick="viewClassEnrollments()">View</button>
                        <button class="btn btn-small" onclick="downloadClassReport()">üì• Download</button>
                    </div>
                    <div id="crResults"></div>
                </div>
                
                <div id="enrollMessage" class="message"></div>
                
                <!-- Step 1: Select Class -->
                <div id="step1">
                    <h3 style="margin-bottom: 15px;">Step 1: Select Your Class</h3>
                    <select id="classYear" style="font-size: 1.1em;">
                        <option value="">-- Choose Class --</option>
                        <option value="1st B.Com">1st B.Com</option>
                        <option value="2nd B.Com">2nd B.Com</option>
                        <option value="3rd B.Com">3rd B.Com</option>
                        <option value="1ST BCA">1ST BCA</option>
                        <option value="2ND BCA A SEC">2ND BCA A SEC</option>
                        <option value="2ND BCA B SEC">2ND BCA B SEC</option>
                        <option value="3RD BCA A SEC">3RD BCA A SEC</option>
                        <option value="3RD BCA B SEC">3RD BCA B SEC</option>
                        <option value="3RD BCA C SEC">3RD BCA C SEC</option>
                        <option value="2ND BBA">2ND BBA</option>
                        <option value="3RD BBA">3RD BBA</option>
                    </select>
                    <button class="btn" onclick="goToStep2()" style="margin-top: 15px;">Next ‚Üí</button>
                </div>
                
                <!-- Step 2: Select Event -->
                <div id="step2" style="display: none;">
                    <button class="btn btn-secondary" onclick="backToStep1()">‚Üê Back</button>
                    <h3 style="margin: 20px 0;">Step 2: Select Event</h3>
                    <div class="event-grid" id="eventGrid"></div>
                </div>
                
                <!-- Step 3: Team Details -->
                <div id="step3" style="display: none;">
                    <button class="btn btn-secondary" onclick="backToStep2()">‚Üê Back</button>
                    <h3 style="margin: 20px 0;" id="step3Title">Step 3: Enter Details</h3>
                    <div id="teamContainer"></div>
                    <div id="extraContainer"></div>
                    <button class="btn" onclick="submitForm()" id="submitBtn">Submit ‚úì</button>
                </div>
            </div>
            
            <!-- Admin Dashboard Section -->
            <div id="dashboardSection" class="form-section">
                <div class="admin-dashboard">
                    <h2 class="dashboard-title">üìä Master Enrollment Sheet (All Classes)</h2>
                    
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-number" id="totalEnrollments">0</div>
                            <div class="stat-label">Total Enrollments</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="activeClasses">0</div>
                            <div class="stat-label">Active Classes</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="activeSports">0</div>
                            <div class="stat-label">Active Events</div>
                        </div>
                    </div>
                    
                    <div style="background: #f5f5f5; padding: 20px; border-radius: 8px;">
                        <h3 style="color: #6a1b9a; margin-bottom: 15px;">üìà Breakdown by Class</h3>
                        <div id="classBreakdown"></div>
                    </div>
                </div>
            </div>
            
            <!-- Admin Login -->
            <div id="adminSection" class="form-section">
                <h2 style="color: #c44569; margin-bottom: 20px;">Admin Login</h2>
                <div id="adminMessage" class="message"></div>
                <input type="password" id="adminPassword" placeholder="Password" style="max-width: 300px; margin-bottom: 10px;">
                <div>
                    <button class="btn" onclick="adminLogin()">Login</button>
                    <button class="btn btn-secondary" onclick="adminLogout()" id="logoutBtn" style="display:none; margin-left: 10px;">Logout</button>
                </div>
            </div>
            
            <!-- Master Sheet -->
            <div id="masterSection" class="form-section">
                <h2 style="color: #c44569; margin-bottom: 20px;">Master Sheet</h2>
                <div class="filter-section">
                    <select id="filterClass" onchange="updateMaster()"><option value="">All Classes</option></select>
                    <select id="filterEvent" onchange="updateMaster()"><option value="">All Events</option></select>
                    <button class="btn" onclick="clearFilters()">Clear</button>
                    <button class="btn" onclick="downloadMaster()">üì• Download</button>
                </div>
                <div style="overflow-x: auto;">
                    <table>
                        <thead><tr><th>Sl</th><th>Name</th><th>Phone</th><th>Class</th><th>Event</th><th>Role</th><th>Details</th><th>Actions</th></tr></thead>
                        <tbody id="masterBody"><tr><td colspan="8" style="text-align: center; padding: 40px;">Loading...</td></tr></tbody>
                    </table>
                </div>
            </div>
            
            <!-- Event-wise View -->
            <div id="eventwiseSection" class="form-section">
                <h2 style="color: #c44569; margin-bottom: 20px;">Event-wise Enrollments</h2>
                <button class="btn" onclick="downloadEvents()">üì• Download</button>
                <div id="eventsContainer" style="margin-top: 20px;"></div>
            </div>
        </div>
        
        <!-- General Rules and Regulations (Bottom of Page) -->
        <div style="background: white; border-radius: 12px; padding: 25px; margin-top: 30px; box-shadow: 0 4px 20px rgba(0,0,0,0.1);">
            <h2 style="color: #c44569; margin-bottom: 15px; text-align: center;">üìã General Rules and Regulations</h2>
            <div style="background: #fff3cd; border-left: 4px solid #ff9800; padding: 15px; border-radius: 6px; margin-bottom: 15px;">
                <p style="margin: 0; color: #856404; font-weight: 600;">Event Coordinators: Lalitha S K & Priyanka V</p>
            </div>
            <div style="background: #f9f9f9; padding: 20px; border-radius: 8px;">
                <ol style="margin: 0; padding-left: 20px; line-height: 1.8;">
                    <li style="margin-bottom: 12px;"><strong>Last date for registration</strong> with one time Refundable amount <strong style="color: #c44569;">‚Çπ1,500/-</strong> on or before <strong>23rd February, Monday within 3:30 PM</strong>.</li>
                    <li style="margin-bottom: 12px;"><strong>Last date for submission of Music and Work Organising batch</strong> on or before <strong>7th March, Saturday</strong>.</li>
                    <li style="margin-bottom: 12px;">Students arriving late (Event and for the Class registration on the date of event) or absent for the event will be fined <strong style="color: #f44336;">‚Çπ500/- per day</strong>.</li>
                    <li style="margin-bottom: 12px;">Teams not submitting Music, or any other assignments with respect to the event, on date and time, will lead into <strong style="color: #f44336;">non-refund of deposit ‚Çπ1,500/-</strong>.</li>
                </ol>
            </div>
        </div>
    </div>
    
    <!-- Success Modal -->
    <div id="successModal" class="modal">
        <div class="modal-content">
            <div class="modal-icon">‚úÖ</div>
            <h2 style="color: #4CAF50; text-align: center;">Success!</h2>
            <p id="successMsg" style="text-align: center; margin: 20px 0; font-size: 1.1em;"></p>
            <div class="modal-buttons" id="successBtns"></div>
        </div>
    </div>
    
    <!-- Edit Modal -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <h2 class="modal-header">Edit Enrollment</h2>
            <div id="editForm"></div>
            <div class="modal-buttons">
                <button class="btn" onclick="saveEdit()">Save</button>
                <button class="btn btn-secondary" onclick="closeEdit()">Cancel</button>
            </div>
        </div>
    </div>

    <script>
        // Firebase Configuration - YOUR ACTUAL CONFIG
        const firebaseConfig = {
            apiKey: "AIzaSyCkjglXJOsXEqGrlavYL4vQ635BV_dbMzY",
            authDomain: "spurthi-youthfest-2026.firebaseapp.com",
            databaseURL: "https://spurthi-youthfest-2026-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "spurthi-youthfest-2026",
            storageBucket: "spurthi-youthfest-2026.firebasestorage.app",
            messagingSenderId: "840281252513",
            appId: "1:840281252513:web:13f32d3239b5f5664ec6e0"
        };

        let db, ref;
        try {
            firebase.initializeApp(firebaseConfig);
            db = firebase.database();
            ref = db.ref('youthfest-enrollments');
        } catch (e) { console.error('Firebase error:', e); }

        // Firebase Connection Status Monitor
        let isConnected = false;
        
        function updateFirebaseStatus(connected) {
            isConnected = connected;
            const statusDot = document.getElementById('statusDot');
            const statusText = document.getElementById('statusText');
            
            statusDot.className = 'status-dot';
            if (connected) {
                statusDot.classList.add('status-connected');
                statusText.textContent = 'üü¢ Database Connected';
            } else {
                statusDot.classList.add('status-disconnected');
                statusText.textContent = 'üî¥ Database Offline';
            }
        }
        
        // Check Firebase connection
        if (ref) {
            const connectedRef = db.ref('.info/connected');
            connectedRef.on('value', function(snap) {
                if (snap.val() === true) {
                    updateFirebaseStatus(true);
                } else {
                    updateFirebaseStatus(false);
                }
            });
            
            // Initial check after 2 seconds
            setTimeout(function() {
                ref.once('value').then(function() {
                    updateFirebaseStatus(true);
                }).catch(function() {
                    updateFirebaseStatus(false);
                });
            }, 2000);
        } else {
            setTimeout(function() {
                updateFirebaseStatus(false);
            }, 1000);
        }


        // Event Configurations with max limits
        const events = {
            'Pod Casting': {size:'Individual',count:1,role:false,topic:true,topicLabel:'Topic',allow:false,maxPerClass:1},
            'Mime': {size:'6 Members',count:6,role:true,topic:true,topicLabel:'Theme',allow:false,maxPerClass:1},
            'Interdisciplinary': {size:'5 Members',count:5,role:true,topic:true,topicLabel:'Topic',allow:false,maxPerClass:1},
            'Ramp Walk': {size:'10+5 Members',count:15,role:true,topic:true,topicLabel:'Theme',show:true,allow:false,maxPerClass:1},
            'Quiz': {size:'6 Members',count:6,role:true,allow:false,maxPerClass:1},
            'Vlog': {size:'3 Members',count:3,role:true,topic:true,topicLabel:'Topic',allow:true,maxPerClass:2},
            'YouTube Advertisement': {size:'8 Members',count:8,role:true,prod:true,allow:false,maxPerClass:1},
            'Mad Ads': {size:'8 Members',count:8,role:true,topic:true,topicLabel:'Topic',allow:false,maxPerClass:1},
            'Hand Writing': {size:'Individual',count:1,role:false,lang:true,allow:false,maxPerClass:1},
            'Best of Waste': {size:'2 Members',count:2,role:true,allow:true,maxPerClass:999},
            'Social Awareness Skit': {size:'8 Members',count:8,role:true,cause:true,allow:false,maxPerClass:1},
            'Solo Dance': {size:'Individual',count:1,role:false,allow:true,maxPerClass:5},
            'Group Dance': {size:'5-8 Members',count:5,role:true,allow:false,maxPerClass:1},
            'Nukkad Natak': {size:'8-10 Members',count:8,role:true,cause:true,causeLabel:'Different Cause',allow:false,maxPerClass:1}
        };

        const classes = ['1st B.Com','2nd B.Com','3rd B.Com','1ST BCA','2ND BCA A SEC','2ND BCA B SEC','3RD BCA A SEC','3RD BCA B SEC','3RD BCA C SEC','2ND BBA','3RD BBA'];
        const ADMIN = 'admin123';
        let isAdmin = localStorage.getItem('isAdmin')==='true', all = [], selClass = '', selEvent = '', selCfg = null, editId = null;

        document.addEventListener('DOMContentLoaded', function() {
            populateEvents();
            populateFilters();
            updateAdminUI();
            loadData();
        });

        function switchTab(t) {
            document.querySelectorAll('.tab').forEach(x => x.classList.remove('active'));
            document.querySelectorAll('.form-section').forEach(x => x.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById(t+'Section').classList.add('active');
            if (t==='master' && isAdmin) updateMaster();
            else if (t==='eventwise' && isAdmin) updateEvents();
            else if (t==='dashboard' && isAdmin) updateDashboard();
        }

        function updateClassIndicator() {
            const indicator = document.getElementById('classIndicator');
            const className = document.getElementById('selectedClassName');
            
            if (selClass) {
                className.textContent = selClass;
                indicator.classList.add('active');
            } else {
                indicator.classList.remove('active');
            }
        }

        function goToStep2() {
            const c = document.getElementById('classYear').value;
            if (!c) { showErr('Select class'); return; }
            selClass = c;
            updateClassIndicator();
            document.getElementById('step1').style.display = 'none';
            document.getElementById('step2').style.display = 'block';
            updateEventAvailability();
            scroll(0,0);
        }

        function backToStep1() {
            selClass = '';
            updateClassIndicator();
            document.getElementById('step2').style.display = 'none';
            document.getElementById('step1').style.display = 'block';
            scroll(0,0);
        }

        function updateEventAvailability() {
            const cards = document.querySelectorAll('.event-card');
            cards.forEach(function(card) {
                const eventName = card.dataset.event;
                const cfg = events[eventName];
                const enrolled = countEnrolledTeams(selClass, eventName);
                
                card.classList.remove('full');
                const statusEl = card.querySelector('.event-status');
                if (statusEl) statusEl.remove();
                
                const status = document.createElement('div');
                status.className = 'event-status';
                
                if (enrolled >= cfg.maxPerClass) {
                    card.classList.add('full');
                    card.onclick = function() { showErr('This event is full for your class!'); };
                    status.className += ' status-full';
                    status.textContent = 'üîí FULL';
                } else if (cfg.allow) {
                    const remaining = cfg.maxPerClass - enrolled;
                    status.className += remaining <= 2 ? ' status-limited' : ' status-available';
                    status.textContent = remaining + ' slots left';
                } else {
                    status.className += ' status-available';
                    status.textContent = '‚úÖ Available';
                }
                
                card.appendChild(status);
            });
        }

        function countEnrolledTeams(className, eventName) {
            const enrollments = all.filter(e => e.classYear === className && e.event === eventName);
            const cfg = events[eventName];
            if (!cfg) return 0;
            
            // Count unique teams (by grouping members)
            const uniquePhones = new Set();
            enrollments.forEach(e => uniquePhones.add(e.phone));
            
            // Estimate teams
            return Math.ceil(uniquePhones.size / cfg.count);
        }

        function selectEvent(e) {
            const cfg = events[e];
            const enrolled = countEnrolledTeams(selClass, e);
            
            if (enrolled >= cfg.maxPerClass) {
                showErr('This event is already full for your class!');
                return;
            }
            
            selEvent = e;
            selCfg = cfg;
            setTimeout(function() {
                document.getElementById('step2').style.display = 'none';
                document.getElementById('step3').style.display = 'block';
                document.getElementById('step3Title').textContent = 'Step 3: '+e;
                genInputs();
                scroll(0,0);
            }, 200);
        }

        function backToStep2() {
            document.getElementById('step3').style.display = 'none';
            document.getElementById('step2').style.display = 'block';
            scroll(0,0);
        }

        function populateEvents() {
            const g = document.getElementById('eventGrid');
            g.innerHTML = '';
            Object.keys(events).forEach(function(e) {
                const cfg = events[e];
                const card = document.createElement('div');
                card.className = 'event-card';
                card.dataset.event = e;
                card.onclick = function() { selectEvent(e); };
                card.innerHTML = '<div class="event-title">'+e+'</div><div class="event-size">'+cfg.size+'</div>';
                g.appendChild(card);
            });
        }

        function genInputs() {
            const tc = document.getElementById('teamContainer');
            const ec = document.getElementById('extraContainer');
            const cfg = selCfg;
            
            let h = '<div style="background:#f9f9f9;padding:20px;border-radius:8px;margin:20px 0"><h3 style="color:#c44569;margin-bottom:20px">Team Members ('+cfg.count+')</h3>';
            for (let i=0; i<cfg.count; i++) {
                const role = cfg.role ? (i===0?'Captain':'Member '+(i+1)) : 'Participant '+(i+1);
                h += '<div class="team-member-box"><div class="member-header">'+role+'</div>';
                h += '<div class="form-group"><label>Name *</label><input type="text" id="n'+i+'" required></div>';
                h += '<div class="form-group"><label>Phone *</label><input type="tel" id="p'+i+'" required maxlength="10"></div></div>';
            }
            h += '</div>';
            tc.innerHTML = h;
            
            let e = '<div style="background:#fff3cd;padding:20px;border-radius:8px;margin:20px 0"><h3 style="color:#856404;margin-bottom:20px">Event Details</h3>';
            if (cfg.topic) e += '<div class="form-group"><label>'+(cfg.topicLabel||'Topic')+' *</label><input type="text" id="topic" required></div>';
            if (cfg.prod) e += '<div class="form-group"><label>Product *</label><input type="text" id="product" required></div>';
            if (cfg.cause) e += '<div class="form-group"><label>'+(cfg.causeLabel||'Cause')+' *</label><input type="text" id="cause" required></div>';
            if (cfg.lang) e += '<div class="form-group"><label>Languages</label><div><label style="display:inline-block;margin-right:15px"><input type="checkbox" id="lEn" checked disabled> English</label><label style="display:inline-block;margin-right:15px"><input type="checkbox" id="lKn"> Kannada</label><label style="display:inline-block"><input type="checkbox" id="lHi"> Hindi</label></div></div>';
            if (cfg.show) e += '<div class="form-group"><label>Showstopper *</label><input type="text" id="show" required></div>';
            e += '</div>';
            ec.innerHTML = e;
        }

        function submitForm() {
            const btn = document.getElementById('submitBtn');
            btn.disabled = true;
            btn.textContent = 'Submitting...';
            
            const members = [];
            for (let i=0; i<selCfg.count; i++) {
                const n = document.getElementById('n'+i).value.trim();
                const p = document.getElementById('p'+i).value.trim();
                if (!n || !p) { showErr('Fill all fields'); btn.disabled = false; btn.textContent = 'Submit ‚úì'; return; }
                if (p.length!==10 || !/^\d{10}$/.test(p)) { showErr('Invalid phone: '+n); btn.disabled = false; btn.textContent = 'Submit ‚úì'; return; }
                members.push({name:n,phone:p,role:selCfg.role?(i===0?'Captain':'Member'):'Participant'});
            }
            
            const base = {classYear:selClass,event:selEvent,timestamp:Date.now()};
            if (selCfg.topic) { const t = document.getElementById('topic'); if (!t||!t.value.trim()) { showErr('Enter topic'); btn.disabled = false; btn.textContent = 'Submit ‚úì'; return; } base.topic = t.value.trim(); }
            if (selCfg.prod) { const pr = document.getElementById('product'); if (!pr||!pr.value.trim()) { showErr('Enter product'); btn.disabled = false; btn.textContent = 'Submit ‚úì'; return; } base.product = pr.value.trim(); }
            if (selCfg.cause) { const c = document.getElementById('cause'); if (!c||!c.value.trim()) { showErr('Enter cause'); btn.disabled = false; btn.textContent = 'Submit ‚úì'; return; } base.cause = c.value.trim(); }
            if (selCfg.lang) { const langs = ['English']; const kn = document.getElementById('lKn'); const hi = document.getElementById('lHi'); if (kn&&kn.checked) langs.push('Kannada'); if (hi&&hi.checked) langs.push('Hindi'); base.languages = langs.join(', '); }
            if (selCfg.show) { const s = document.getElementById('show'); if (!s||!s.value.trim()) { showErr('Enter showstopper'); btn.disabled = false; btn.textContent = 'Submit ‚úì'; return; } base.showstopper = s.value.trim(); }
            
            const promises = members.map(m => ref.push(Object.assign({},base,{name:m.name,phone:m.phone,role:m.role})));
            Promise.all(promises).then(function() {
                btn.disabled = false;
                btn.textContent = 'Submit ‚úì';
                showSuccessModal(members.length);
            }).catch(function(er) {
                showErr('Error: '+er.message);
                btn.disabled = false;
                btn.textContent = 'Submit ‚úì';
            });
        }

        function showSuccessModal(cnt) {
            const modal = document.getElementById('successModal');
            const msg = document.getElementById('successMsg');
            const btns = document.getElementById('successBtns');
            msg.textContent = 'Enrolled '+cnt+' member(s) for '+selEvent+'!';
            btns.innerHTML = selCfg.allow ? '<button class="btn" onclick="addMore()">Add Another</button><button class="btn btn-secondary" onclick="done()">Done</button>' : '<button class="btn" onclick="done()">Continue</button>';
            modal.style.display = 'block';
        }

        function addMore() {
            document.getElementById('successModal').style.display = 'none';
            for (let i=0; i<selCfg.count; i++) {
                const n = document.getElementById('n'+i); const p = document.getElementById('p'+i);
                if (n) n.value = ''; if (p) p.value = '';
            }
            ['topic','product','cause','show'].forEach(id => { const el = document.getElementById(id); if (el) el.value = ''; });
            const kn = document.getElementById('lKn'); const hi = document.getElementById('lHi');
            if (kn) kn.checked = false; if (hi) hi.checked = false;
            scroll(0,0);
        }

        function done() {
            document.getElementById('successModal').style.display = 'none';
            document.getElementById('step3').style.display = 'none';
            document.getElementById('step2').style.display = 'block';
            updateEventAvailability();
            scroll(0,0);
        }

        // Student Search & Edit
        function searchStudent() {
            const phone = document.getElementById('studentPhone').value.trim();
            if (!phone || phone.length!==10) { showErr('Enter valid 10-digit phone'); return; }
            const mine = all.filter(x => x.phone===phone);
            const cont = document.getElementById('studentResults');
            if (mine.length===0) { cont.innerHTML = '<p style="color:#666;padding:15px;background:white;border-radius:6px;margin-top:10px">No enrollments found</p>'; return; }
            let h = '<div style="background:white;border-radius:6px;padding:15px;margin-top:10px"><h4>Your Enrollments ('+mine.length+')</h4><table style="font-size:14px"><thead><tr><th>Name</th><th>Class</th><th>Event</th><th>Role</th><th>Actions</th></tr></thead><tbody>';
            mine.forEach(e => h += '<tr><td>'+e.name+'</td><td>'+e.classYear+'</td><td>'+e.event+'</td><td>'+e.role+'</td><td><button class="edit-btn" onclick="openEdit(\''+e.id+'\')">Edit</button> <button class="delete-btn" onclick="confirmDel(\''+e.id+'\',\''+e.name+'\')">Delete</button></td></tr>');
            h += '</tbody></table></div>';
            cont.innerHTML = h;
        }

        function clearStudentSearch() {
            document.getElementById('studentPhone').value = '';
            document.getElementById('studentResults').innerHTML = '';
        }

        // CR Functions
        function viewClassEnrollments() {
            const cl = document.getElementById('crClass').value;
            if (!cl) { showErr('Select your class'); return; }
            const classEnr = all.filter(e => e.classYear === cl);
            const cont = document.getElementById('crResults');
            if (classEnr.length === 0) { cont.innerHTML = '<p style="color:#666;padding:15px;background:white;border-radius:6px;margin-top:10px">No enrollments for this class</p>'; return; }
            let h = '<div style="background:white;border-radius:6px;padding:15px;margin-top:10px"><h4>'+cl+' Enrollments ('+classEnr.length+')</h4><table><thead><tr><th>Name</th><th>Phone</th><th>Event</th><th>Role</th><th>Details</th></tr></thead><tbody>';
            classEnr.forEach(e => h += '<tr><td>'+e.name+'</td><td>'+e.phone+'</td><td>'+e.event+'</td><td>'+e.role+'</td><td>'+getDet(e)+'</td></tr>');
            h += '</tbody></table></div>';
            cont.innerHTML = h;
        }

        function downloadClassReport() {
            const cl = document.getElementById('crClass').value;
            if (!cl) { alert('Select class'); return; }
            const classEnr = all.filter(e => e.classYear === cl);
            if (classEnr.length === 0) { alert('No data'); return; }
            let csv = 'Name,Phone,Event,Role,Details\n';
            classEnr.forEach(e => csv += '"'+e.name+'","'+e.phone+'","'+e.event+'","'+e.role+'","'+getDet(e).replace(/<br>/g,' | ')+'"\n');
            download(csv, cl.replace(/[^a-zA-Z0-9]/g,'_')+'_enrollments.csv');
        }

        // Admin Dashboard
        function updateDashboard() {
            // Calculate statistics
            const totalEnrollments = all.length;
            
            // Count active classes (classes with at least one enrollment)
            const activeClassesSet = new Set();
            all.forEach(e => activeClassesSet.add(e.classYear));
            const activeClasses = activeClassesSet.size;
            
            // Count active events (events with at least one enrollment)
            const activeSportsSet = new Set();
            all.forEach(e => activeSportsSet.add(e.event));
            const activeSports = activeSportsSet.size;
            
            // Update stats display
            document.getElementById('totalEnrollments').textContent = totalEnrollments;
            document.getElementById('activeClasses').textContent = activeClasses;
            document.getElementById('activeSports').textContent = activeSports;
            
            // Class breakdown
            const classStats = {};
            classes.forEach(c => classStats[c] = 0);
            all.forEach(e => {
                if (classStats[e.classYear] !== undefined) {
                    classStats[e.classYear]++;
                }
            });
            
            let breakdownHTML = '<table style="width: 100%;"><thead><tr><th>Class</th><th>Enrollments</th><th>Percentage</th></tr></thead><tbody>';
            classes.forEach(c => {
                const count = classStats[c];
                const percentage = totalEnrollments > 0 ? ((count / totalEnrollments) * 100).toFixed(1) : 0;
                if (count > 0) {
                    breakdownHTML += '<tr><td><strong>'+c+'</strong></td><td>'+count+'</td><td>'+percentage+'%</td></tr>';
                }
            });
            breakdownHTML += '</tbody></table>';
            
            document.getElementById('classBreakdown').innerHTML = breakdownHTML;
        }

        function openEdit(id) {
            const e = all.find(x => x.id===id);
            if (!e) return;
            editId = id;
            let h = '<div class="form-group"><label>Name</label><input type="text" id="eName" value="'+e.name+'"></div>';
            h += '<div class="form-group"><label>Phone</label><input type="tel" id="ePhone" value="'+e.phone+'" maxlength="10"></div>';
            h += '<div class="form-group"><label>Class</label><select id="eClass">';
            classes.forEach(c => h += '<option value="'+c+'"'+(c===e.classYear?' selected':'')+'>'+c+'</option>');
            h += '</select></div><div class="form-group"><label>Role</label><input type="text" id="eRole" value="'+e.role+'"></div>';
            if (e.topic) h += '<div class="form-group"><label>Topic</label><input type="text" id="eTopic" value="'+e.topic+'"></div>';
            if (e.product) h += '<div class="form-group"><label>Product</label><input type="text" id="eProduct" value="'+e.product+'"></div>';
            if (e.cause) h += '<div class="form-group"><label>Cause</label><input type="text" id="eCause" value="'+e.cause+'"></div>';
            if (e.languages) h += '<div class="form-group"><label>Languages</label><input type="text" id="eLangs" value="'+e.languages+'"></div>';
            if (e.showstopper) h += '<div class="form-group"><label>Showstopper</label><input type="text" id="eShow" value="'+e.showstopper+'"></div>';
            document.getElementById('editForm').innerHTML = h;
            document.getElementById('editModal').style.display = 'block';
        }

        function saveEdit() {
            if (!editId) return;
            const upd = { name: document.getElementById('eName').value.trim(), phone: document.getElementById('ePhone').value.trim(), classYear: document.getElementById('eClass').value, role: document.getElementById('eRole').value.trim() };
            [{id:'eTopic',key:'topic'},{id:'eProduct',key:'product'},{id:'eCause',key:'cause'},{id:'eLangs',key:'languages'},{id:'eShow',key:'showstopper'}].forEach(f => { const el = document.getElementById(f.id); if (el) upd[f.key] = el.value.trim(); });
            ref.child(editId).update(upd).then(function() {
                closeEdit();
                showOk('Updated!');
                clearStudentSearch();
            }).catch(er => showErr('Error: '+er.message));
        }

        function closeEdit() {
            document.getElementById('editModal').style.display = 'none';
            editId = null;
        }

        function confirmDel(id, name) {
            if (!confirm('Delete '+name+'?')) return;
            ref.child(id).remove().then(function() {
                showOk('Deleted!');
                clearStudentSearch();
            }).catch(er => showErr('Error: '+er.message));
        }

        function adminLogin() {
            const pw = document.getElementById('adminPassword').value;
            if (pw===ADMIN) { isAdmin = true; localStorage.setItem('isAdmin','true'); updateAdminUI(); showAdminMsg('Success!','success'); }
            else showAdminMsg('Wrong!','error');
            document.getElementById('adminPassword').value = '';
        }

        function adminLogout() {
            isAdmin = false;
            localStorage.removeItem('isAdmin');
            updateAdminUI();
            showAdminMsg('Logged out!','success');
        }

        function updateAdminUI() {
            if (isAdmin) {
                document.querySelectorAll('.admin-only').forEach(x => x.style.display='block');
                document.getElementById('logoutBtn').style.display='inline-block';
                document.getElementById('userBadge').innerHTML='<span class="admin-badge">ADMIN</span>';
            } else {
                document.querySelectorAll('.admin-only').forEach(x => x.style.display='none');
                document.getElementById('logoutBtn').style.display='none';
                document.getElementById('userBadge').innerHTML='';
            }
        }

        function showAdminMsg(msg,type) {
            const d = document.getElementById('adminMessage');
            d.className = 'message '+type+' show';
            d.textContent = msg;
            setTimeout(() => d.classList.remove('show'), 3000);
        }

        function loadData() {
            if (!ref) return;
            ref.on('value', snap => {
                all = [];
                snap.forEach(ch => { const d = ch.val(); d.id = ch.key; all.push(d); });
                all.sort((a,b) => b.timestamp-a.timestamp);
                
                // Update dashboard if admin is viewing it
                if (isAdmin && document.getElementById('dashboardSection').classList.contains('active')) {
                    updateDashboard();
                }
            });
        }

        function populateFilters() {
            const cf = document.getElementById('filterClass');
            const ef = document.getElementById('filterEvent');
            classes.forEach(c => { const o = document.createElement('option'); o.value = c; o.textContent = c; cf.appendChild(o); });
            Object.keys(events).forEach(e => { const o = document.createElement('option'); o.value = e; o.textContent = e; ef.appendChild(o); });
        }

        function updateMaster() {
            const body = document.getElementById('masterBody');
            const cf = document.getElementById('filterClass').value;
            const ef = document.getElementById('filterEvent').value;
            const filt = all.filter(e => (!cf || e.classYear===cf) && (!ef || e.event===ef));
            if (filt.length===0) { body.innerHTML = '<tr><td colspan="8" style="text-align:center;padding:40px">No data</td></tr>'; return; }
            let h = '';
            filt.forEach((e,i) => h += '<tr><td>'+(i+1)+'</td><td>'+e.name+'</td><td>'+e.phone+'</td><td>'+e.classYear+'</td><td>'+e.event+'</td><td>'+e.role+'</td><td>'+getDet(e)+'</td><td><button class="edit-btn" onclick="openEdit(\''+e.id+'\')">Edit</button> <button class="delete-btn" onclick="confirmDel(\''+e.id+'\',\''+e.name+'\')">Delete</button></td></tr>');
            body.innerHTML = h;
        }

        function updateEvents() {
            const cont = document.getElementById('eventsContainer');
            if (all.length===0) { cont.innerHTML = '<p style="text-align:center;padding:40px">No data</p>'; return; }
            let h = '';
            Object.keys(events).forEach(ev => {
                const evEnr = all.filter(e => e.event===ev);
                if (evEnr.length===0) return;
                h += '<div style="background:#f9f9f9;padding:20px;border-radius:8px;margin-bottom:20px"><h3 style="color:#c44569;margin-bottom:15px">'+ev+' ('+evEnr.length+')</h3>';
                classes.forEach(cl => {
                    const clEnr = evEnr.filter(e => e.classYear===cl);
                    if (clEnr.length===0) return;
                    h += '<div style="background:white;padding:15px;border-radius:6px;margin-bottom:15px"><h4 style="color:#6a1b9a;margin-bottom:10px">'+cl+' ('+clEnr.length+')</h4><table><thead><tr><th>Sl</th><th>Name</th><th>Phone</th><th>Role</th><th>Details</th></tr></thead><tbody>';
                    clEnr.forEach((e,i) => h += '<tr><td>'+(i+1)+'</td><td>'+e.name+'</td><td>'+e.phone+'</td><td>'+e.role+'</td><td>'+getDet(e)+'</td></tr>');
                    h += '</tbody></table></div>';
                });
                h += '</div>';
            });
            cont.innerHTML = h;
        }

        function clearFilters() {
            document.getElementById('filterClass').value = '';
            document.getElementById('filterEvent').value = '';
            updateMaster();
        }

        function getDet(e) {
            const d = [];
            if (e.topic) d.push('Topic: '+e.topic);
            if (e.product) d.push('Product: '+e.product);
            if (e.cause) d.push('Cause: '+e.cause);
            if (e.languages) d.push('Languages: '+e.languages);
            if (e.showstopper) d.push('Showstopper: '+e.showstopper);
            return d.length>0 ? d.join('<br>') : '-';
        }

        function downloadMaster() {
            if (all.length===0) { alert('No data'); return; }
            let csv = 'Sl,Name,Phone,Class,Event,Role,Details\n';
            all.forEach((e,i) => csv += (i+1)+',"'+e.name+'","'+e.phone+'","'+e.classYear+'","'+e.event+'","'+e.role+'","'+getDet(e).replace(/<br>/g,' | ')+'"\n');
            download(csv,'youthfest_master.csv');
        }

        function downloadEvents() {
            if (all.length===0) { alert('No data'); return; }
            let csv = '';
            Object.keys(events).forEach(ev => {
                const evEnr = all.filter(e => e.event===ev);
                if (evEnr.length===0) return;
                csv += '\n'+ev+'\n';
                csv += 'Sl,Name,Phone,Class,Role,Details\n';
                let sl = 1;
                evEnr.forEach(e => { csv += sl+',"'+e.name+'","'+e.phone+'","'+e.classYear+'","'+e.role+'","'+getDet(e).replace(/<br>/g,' | ')+'"\n'; sl++; });
            });
            download(csv,'youthfest_events.csv');
        }

        function download(content,filename) {
            const blob = new Blob([content],{type:'text/csv'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            URL.revokeObjectURL(url);
        }

        function showOk(msg) {
            const d = document.getElementById('enrollMessage');
            d.className = 'message success show';
            d.textContent = '‚úì '+msg;
            setTimeout(() => d.classList.remove('show'), 5000);
            scroll(0,0);
        }

        function showErr(msg) {
            const d = document.getElementById('enrollMessage');
            d.className = 'message error show';
            d.textContent = '‚úó '+msg;
            setTimeout(() => d.classList.remove('show'), 5000);
            scroll(0,0);
        }

        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) event.target.style.display = 'none';
        }
    </script>
</body>
</html>
