<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spurthi Youth Fest 2026 - Daily Quiz Competition</title>
    
    <!-- Favicon -->
    <link rel="icon" type="image/png" href="davan_degree1.png">
    <link rel="apple-touch-icon" href="davan_degree1.png">
    
    <!-- Open Graph / WhatsApp / Facebook Meta Tags -->
    <meta property="og:title" content="Spurthi Youth Fest 2026 - Daily Quiz Competition">
    <meta property="og:description" content="ðŸŽ“ Join our exciting Daily Quiz Competition! Answer 2 questions daily and win prizes. Register now for â‚¹1,500 (Refundable)">
    <meta property="og:image" content="https://harshgujjar.github.io/Spurthi-youth-fest-2026/og_image.png">
    <meta property="og:image:secure_url" content="https://harshgujjar.github.io/Spurthi-youth-fest-2026/og_image.png">
    <meta property="og:image:type" content="image/png">
    <meta property="og:image:width" content="1200">
    <meta property="og:image:height" content="630">
    <meta property="og:image:alt" content="Spurthi Youth Fest 2026 - Daily Quiz Competition by Davan Institute">
    <meta property="og:url" content="https://harshgujjar.github.io/Spurthi-youth-fest-2026/">
    <meta property="og:type" content="website">
    <meta property="og:site_name" content="Spurthi Youth Fest 2026">
    <meta property="og:locale" content="en_IN">
    
    <!-- Twitter Card Meta Tags -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="Spurthi Youth Fest 2026 - Daily Quiz Competition">
    <meta name="twitter:description" content="ðŸŽ“ Join our Daily Quiz Competition! Answer 2 questions daily and win prizes. Register now for â‚¹1,500 (Refundable)">
    <meta name="twitter:image" content="https://harshgujjar.github.io/Spurthi-youth-fest-2026/og_image.png">
    <meta name="twitter:image:alt" content="Spurthi Youth Fest 2026 - Daily Quiz Competition by Davan Institute">
    
    <!-- Additional Meta Tags -->
    <meta name="description" content="Spurthi Youth Fest 2026 Daily Quiz Competition - Test your knowledge, win prizes! By Davan Institute of Advanced Management Studies">
    <meta name="keywords" content="Spurthi, Youth Fest, Quiz, Competition, Davan Institute, College Fest, Student Competition">
    <meta name="author" content="Davan Institute of Advanced Management Studies">
    
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-storage-compat.js"></script>
    <!-- EmailJS for sending actual emails -->
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
    <script type="text/javascript">
        (function(){
            emailjs.init("iISS6N2b69VmKwx8Y"); // Your EmailJS Public Key from image
        })();
    </script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #c44569 0%, #6a1b9a 100%); min-height: 100vh; padding: 20px; }
        
        /* ========== QUIZ ANIMATIONS ========== */
        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes pulse {
            0%, 100% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.05);
            }
        }
        
        @keyframes shimmer {
            0% {
                background-position: -1000px 0;
            }
            100% {
                background-position: 1000px 0;
            }
        }
        
        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% {
                transform: translateY(0);
            }
            40% {
                transform: translateY(-20px);
            }
            60% {
                transform: translateY(-10px);
            }
        }
        
        @keyframes confetti {
            0% {
                transform: translateY(0) rotateZ(0deg);
                opacity: 1;
            }
            100% {
                transform: translateY(1000px) rotateZ(720deg);
                opacity: 0;
            }
        }
        
        @keyframes correctShake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px) rotate(-2deg); }
            75% { transform: translateX(5px) rotate(2deg); }
        }
        
        /* Quiz Status Cards with Animation */
        .quiz-status-card {
            animation: slideInUp 0.6s ease-out;
            transition: all 0.3s ease;
        }
        
        .quiz-status-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.2);
        }
        
        /* Shimmer effect for available quiz */
        .quiz-available-banner {
            background: linear-gradient(90deg, #d4edda 0%, #e8f5e9 50%, #d4edda 100%);
            background-size: 2000px 100%;
            animation: shimmer 3s linear infinite;
            border: 3px solid #28a745;
            border-radius: 15px;
            padding: 25px;
            margin: 20px 0;
            box-shadow: 0 6px 20px rgba(40, 167, 69, 0.3);
        }
        
        .quiz-available-banner h3 {
            color: #155724;
            font-size: 1.5em;
            margin-bottom: 10px;
            animation: pulse 2s ease-in-out infinite;
        }
        
        .quiz-available-banner .trophy-icon {
            font-size: 3em;
            display: inline-block;
            animation: bounce 2s ease-in-out infinite;
        }
        
        /* Question Cards */
        .quiz-question-card {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 8px 30px rgba(0,0,0,0.15);
            border-left: 6px solid #667eea;
            animation: slideInUp 0.5s ease-out;
            transition: all 0.3s ease;
        }
        
        .quiz-question-card:hover {
            transform: translateX(5px);
            box-shadow: 0 12px 40px rgba(102, 126, 234, 0.3);
        }
        
        .quiz-question-card h4 {
            color: #667eea;
            font-size: 1.3em;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .quiz-question-card .question-text {
            color: #333;
            font-size: 1.15em;
            margin-bottom: 20px;
            line-height: 1.6;
            font-weight: 500;
        }
        
        /* Option Buttons */
        .quiz-option {
            background: #f8f9fa;
            border: 3px solid #e9ecef;
            border-radius: 12px;
            padding: 18px 25px;
            margin: 12px 0;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 15px;
            font-size: 1.05em;
        }
        
        .quiz-option:hover {
            background: #e3f2fd;
            border-color: #2196F3;
            transform: translateX(10px);
            box-shadow: 0 4px 15px rgba(33, 150, 243, 0.2);
        }
        
        .quiz-option.selected {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-color: #667eea;
            color: white;
            font-weight: 600;
            transform: scale(1.02);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }
        
        .quiz-option .option-circle {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: #667eea;
            flex-shrink: 0;
        }
        
        .quiz-option.selected .option-circle {
            background: white;
            color: #667eea;
        }
        
        /* Submit Button Enhancement */
        .quiz-submit-btn {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            border: none;
            border-radius: 15px;
            padding: 20px 40px;
            font-size: 1.3em;
            font-weight: 700;
            cursor: pointer;
            width: 100%;
            margin-top: 30px;
            transition: all 0.3s ease;
            box-shadow: 0 8px 25px rgba(40, 167, 69, 0.4);
            position: relative;
            overflow: hidden;
        }
        
        .quiz-submit-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 35px rgba(40, 167, 69, 0.5);
        }
        
        .quiz-submit-btn:active {
            transform: translateY(-1px);
        }
        
        .quiz-submit-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: rgba(255,255,255,0.2);
            transition: left 0.5s ease;
        }
        
        .quiz-submit-btn:hover::before {
            left: 100%;
        }
        
        /* Timer Enhancement */
        .quiz-timer-box {
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, #ff6b6b 0%, #ff8e53 100%);
            color: white;
            padding: 15px 25px;
            border-radius: 15px;
            box-shadow: 0 6px 20px rgba(255, 107, 107, 0.4);
            z-index: 1000;
            font-weight: 700;
            font-size: 1.2em;
            animation: pulse 2s ease-in-out infinite;
        }
        
        /* Confetti */
        .confetti {
            position: fixed;
            width: 10px;
            height: 10px;
            z-index: 9999;
            animation: confetti 3s ease-out forwards;
        }
        
        /* Success Modal */
        .quiz-success-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            animation: fadeIn 0.3s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .quiz-success-content {
            background: white;
            border-radius: 25px;
            padding: 50px;
            text-align: center;
            max-width: 600px;
            animation: slideInUp 0.5s ease-out;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        
        .quiz-success-content .success-icon {
            font-size: 5em;
            margin-bottom: 20px;
            animation: bounce 1s ease-in-out;
        }
        
        .quiz-success-content h2 {
            color: #28a745;
            font-size: 2.5em;
            margin-bottom: 15px;
        }
        
        .quiz-success-content p {
            font-size: 1.2em;
            color: #666;
            margin: 10px 0;
        }

        /* ========== SCAVENGER HUNT STYLES ========== */
        .sh-tab-panel          { display: none; }
        .sh-tab-panel.sh-tab-active { display: block; }

        .sh-task-card {
            background: white;
            border-radius: 14px;
            padding: 20px 22px;
            margin-bottom: 16px;
            box-shadow: 0 4px 18px rgba(0,0,0,0.10);
            border-left: 6px solid #9c27b0;
            transition: all 0.3s ease;
            animation: slideInUp 0.4s ease-out;
        }
        .sh-task-card.completed { border-left-color: #4caf50; background: #f1f8f1; }
        .sh-task-card.pending   { border-left-color: #ff9800; }
        .sh-task-card.locked    { border-left-color: #bdbdbd; opacity: 0.6; }
        .sh-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.78em;
            font-weight: 700;
            letter-spacing: 0.5px;
            text-transform: uppercase;
        }
        .sh-badge-active   { background:#fff3e0; color:#e65100; border:1px solid #ffb74d; }
        .sh-badge-done     { background:#e8f5e9; color:#2e7d32; border:1px solid #81c784; }
        .sh-badge-pending  { background:#e3f2fd; color:#1565c0; border:1px solid #64b5f6; }
        .sh-badge-rejected { background:#ffebee; color:#c62828; border:1px solid #ef9a9a; }
        .sh-upload-zone {
            border: 2.5px dashed #9c27b0;
            border-radius: 12px;
            padding: 22px;
            text-align: center;
            cursor: pointer;
            transition: all 0.25s ease;
            background: #faf0ff;
            margin-top: 14px;
        }
        .sh-upload-zone:hover { background: #f3e5f5; border-color: #6a1b9a; }
        .sh-upload-zone.has-file { background: #e8f5e9; border-color: #4caf50; }
        .sh-preview-img {
            max-width: 100%;
            max-height: 200px;
            border-radius: 10px;
            margin-top: 12px;
            object-fit: cover;
            border: 3px solid #9c27b0;
        }
        .sh-admin-photo {
            max-width: 180px;
            max-height: 180px;
            border-radius: 8px;
            object-fit: cover;
            border: 3px solid #9c27b0;
            cursor: pointer;
        }
        .sh-progress-bar-wrap {
            background: #e0e0e0;
            border-radius: 20px;
            height: 12px;
            overflow: hidden;
            margin: 10px 0;
        }
        .sh-progress-bar {
            height: 100%;
            border-radius: 20px;
            background: linear-gradient(90deg, #9c27b0, #e91e63);
            transition: width 0.6s ease;
        }
        .sh-leaderboard-row {
            display: flex;
            align-items: center;
            gap: 14px;
            padding: 12px 16px;
            border-radius: 10px;
            margin-bottom: 8px;
            background: white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.07);
            transition: all 0.2s;
        }
        .sh-leaderboard-row:hover { transform: translateX(4px); box-shadow: 0 4px 15px rgba(156,39,176,0.15); }
        .sh-rank { font-size: 1.5em; min-width: 36px; text-align: center; }
        .sh-photo-modal {
            position: fixed; top:0; left:0; width:100%; height:100%;
            background: rgba(0,0,0,0.85);
            display: flex; align-items: center; justify-content: center;
            z-index: 99999;
        }
        .sh-photo-modal img { max-width: 92vw; max-height: 90vh; border-radius: 12px; }
        @keyframes shGlowPulse {
            0%,100% { box-shadow: 0 0 0 0 rgba(156,39,176,0.4); }
            50%      { box-shadow: 0 0 0 12px rgba(156,39,176,0); }
        }
        .sh-glow { animation: shGlowPulse 2s infinite; }
        .sh-gps-badge {
            display:inline-flex; align-items:center; gap:5px;
            background: linear-gradient(135deg,#00bcd4,#009688);
            color:white; padding:4px 12px; border-radius:20px;
            font-size:0.8em; font-weight:700;
        }

        .container { max-width: 1400px; margin: 0 auto; }
        .banner { width: 100%; max-width: 1200px; margin: 0 auto 30px; border-radius: 12px; box-shadow: 0 10px 40px rgba(0,0,0,0.3); display: block; }
        .header { text-align: center; color: white; margin-bottom: 30px; }
        .header h1 { font-size: 1.8em; }
        .admin-badge { display: inline-block; background: #FFD700; color: #333; padding: 5px 15px; border-radius: 20px; font-size: 0.9em; font-weight: bold; margin-left: 10px; }
        .super-admin-badge { display: inline-block; background: #FF6B6B; color: white; padding: 5px 15px; border-radius: 20px; font-size: 0.9em; font-weight: bold; margin-left: 10px; }
        .jury-badge { display: inline-block; background: #4ECDC4; color: white; padding: 5px 15px; border-radius: 20px; font-size: 0.9em; font-weight: bold; margin-left: 10px; }
        
        /* Class Indicator */
        .class-indicator {
            background: white;
            padding: 15px 25px;
            border-radius: 8px;
            margin: 20px auto;
            max-width: 500px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            display: none;
        }
        .class-indicator.active {
            display: block;
        }
        .class-indicator h3 {
            color: #6a1b9a;
            font-size: 1.2em;
            margin-bottom: 8px;
        }
        .class-indicator .class-name {
            color: #c44569;
            font-size: 1.5em;
            font-weight: bold;
        }
        
        /* Admin Dashboard */
        .admin-dashboard {
            background: white;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }
        .dashboard-title {
            color: #c44569;
            font-size: 1.8em;
            margin-bottom: 25px;
            text-align: center;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 6px 20px rgba(0,0,0,0.15);
            transition: transform 0.3s;
        }
        .stat-card:hover {
            transform: translateY(-5px);
        }
        .stat-number {
            font-size: 3em;
            font-weight: bold;
            margin-bottom: 10px;
        }
        .stat-label {
            font-size: 1.1em;
            opacity: 0.9;
        }
        
        .tabs { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
        .tab { padding: 12px 24px; background: white; color: #333; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: 600; transition: all 0.3s; }
        .tab:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.2); }
        .tab.active { background: linear-gradient(135deg, #c44569 0%, #6a1b9a 100%); color: white; }
        .content { background: white; border-radius: 12px; padding: 30px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); }
        #adminContentBox.lb-active { background: transparent; box-shadow: none; padding: 0; }
        .form-section { display: none; }
        .form-section.active { display: block !important; }
        .form-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; font-weight: 600; color: #333; }
        input, select, textarea { width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 6px; font-size: 16px; transition: border-color 0.3s; }
        input:focus, select:focus, textarea:focus { outline: none; border-color: #c44569; }
        .event-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 15px; margin: 20px 0; }
        .event-card { padding: 20px; border: 3px solid #ddd; border-radius: 12px; cursor: pointer; transition: all 0.3s; background: white; position: relative; }
        .event-card:hover { border-color: #c44569; transform: translateY(-3px); box-shadow: 0 6px 20px rgba(196, 69, 105, 0.3); }
        .event-card.full { border-color: #f44336; background: #ffebee; cursor: not-allowed; opacity: 0.7; }
        .event-card.full:hover { transform: none; }
        .event-title { font-size: 1.1em; font-weight: bold; margin-bottom: 8px; }
        .event-size { font-size: 0.9em; opacity: 0.8; margin-bottom: 5px; }
        .event-status { font-size: 0.85em; padding: 5px 10px; border-radius: 15px; display: inline-block; margin-top: 5px; font-weight: bold; }
        .status-full { background: #f44336; color: white; }
        .status-available { background: #4CAF50; color: white; }
        .status-limited { background: #FF9800; color: white; }
        .team-member-box { border: 2px solid #c44569; padding: 15px; border-radius: 8px; margin-bottom: 15px; background: #f9f9f9; }
        .member-header { color: #6a1b9a; font-weight: bold; margin-bottom: 10px; font-size: 1.1em; }
        .btn { padding: 12px 30px; background: linear-gradient(135deg, #c44569 0%, #6a1b9a 100%); color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.3s; }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(0,0,0,0.2); }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }
        .btn-secondary { background: #666; }
        .btn-small { padding: 6px 12px; font-size: 14px; }
        .btn-success { background: #4CAF50; }
        .btn-danger { background: #f44336; }
        .btn-info { background: #2196F3; }
        .message { padding: 15px; border-radius: 6px; margin-bottom: 20px; display: none; }
        .message.show { display: block; }
        .message.success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .message.error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.7); overflow-y: auto; }
        .modal-content { background-color: white; margin: 50px auto; padding: 30px; border-radius: 12px; width: 90%; max-width: 600px; }
        .modal-header { font-size: 1.5em; color: #c44569; margin-bottom: 20px; text-align: center; }
        .modal-icon { font-size: 4em; margin-bottom: 20px; text-align: center; }
        .modal-buttons { margin-top: 20px; display: flex; gap: 10px; justify-content: center; flex-wrap: wrap; }
        /* Table Wrapper for Horizontal Scroll */
        .table-wrapper {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            margin-top: 20px;
        }
        table { width: 100%; border-collapse: collapse; min-width: 600px; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #ddd; white-space: nowrap; }
        th { background: linear-gradient(135deg, #c44569 0%, #6a1b9a 100%); color: white; font-weight: 600; position: sticky; top: 0; z-index: 10; }
        tr:hover { background: #f5f5f5; }
        
        /* Mobile Responsive Table */
        @media (max-width: 768px) {
            table { min-width: 800px; font-size: 14px; }
            th, td { padding: 8px 6px; }
            .btn-small { padding: 4px 8px; font-size: 12px; }
        }
        .edit-btn { background: #2196F3; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; margin-right: 5px; }
        .edit-btn:hover { background: #1976D2; }
        .delete-btn { background: #f44336; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; }
        .delete-btn:hover { background: #d32f2f; }
        .filter-section { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
        .filter-section select { flex: 1; min-width: 200px; }
        .admin-only { display: none; }
        .super-admin-only { display: none; }
        .jury-only { display: none; }
        .student-section { background: #f0f0f0; padding: 20px; border-radius: 8px; margin-bottom: 30px; }
        .cr-section { background: #e3f2fd; padding: 20px; border-radius: 8px; margin-bottom: 20px; border: 2px solid #2196F3; }
        
        /* Jury Sheet Styles */
        .criteria-input-group {
            background: #f9f9f9;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            border: 2px solid #ddd;
        }
        .criteria-input-group input {
            margin-bottom: 10px;
        }
        .remove-criteria-btn {
            background: #f44336;
            color: white;
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
        }
        .marks-table {
            overflow-x: auto;
        }
        .marks-input {
            width: 80px;
            padding: 8px;
            border: 2px solid #ddd;
            border-radius: 4px;
            text-align: center;
        }
        .marks-input:focus {
            border-color: #4CAF50;
        }
        .total-marks {
            font-weight: bold;
            color: #c44569;
            font-size: 1.2em;
        }
        .winner-badge {
            background: #FFD700;
            color: #333;
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: bold;
            display: inline-block;
            margin-left: 10px;
        }
        .runner-badge {
            background: #C0C0C0;
            color: #333;
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: bold;
            display: inline-block;
            margin-left: 10px;
        }
        .jury-password-section {
            background: #fff3cd;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 2px solid #ffc107;
        }
        .results-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        .rank-1 {
            border-left: 5px solid #FFD700;
        }
        .rank-2 {
            border-left: 5px solid #C0C0C0;
        }
        .rank-3 {
            border-left: 5px solid #CD7F32;
        }
        
        @media (max-width: 768px) { 
            .event-grid { grid-template-columns: 1fr; } 
            .filter-section { flex-direction: column; }
            .marks-input { width: 60px; }
        }
        
        /* Firebase Status Indicator */
        .firebase-status {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: white;
            padding: 12px 20px;
            border-radius: 25px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            display: flex;
            align-items: center;
            gap: 10px;
            z-index: 999;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s;
        }
        .firebase-status:hover {
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
            transform: translateY(-2px);
        }
        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }
        .status-connected {
            background: #4CAF50;
            box-shadow: 0 0 10px rgba(76, 175, 80, 0.5);
        }
        .status-disconnected {
            background: #f44336;
            box-shadow: 0 0 10px rgba(244, 67, 54, 0.5);
            animation: blink 1s infinite;
        }
        .status-checking {
            background: #FF9800;
            box-shadow: 0 0 10px rgba(255, 152, 0, 0.5);
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        @keyframes blink {
            0%, 50%, 100% { opacity: 1; }
            25%, 75% { opacity: 0.3; }
        }
        @media (max-width: 768px) {
            .firebase-status {
                bottom: 10px;
                right: 10px;
                padding: 8px 15px;
                font-size: 12px;
            }
            .status-dot {
                width: 10px;
                height: 10px;
            }
        }
        
        /* Edit Date Button Styling */
        .btn-warning { background: #FF9800; }
        .btn-edit-date {
            background: linear-gradient(135deg, #FF9800 0%, #F57C00 100%);
            margin-left: 10px;
        }
        .btn-edit-date:hover {
            box-shadow: 0 6px 20px rgba(255, 152, 0, 0.4);
        }
        
        /* Date Editor Modal */
        .date-picker-group {
            display: flex;
            gap: 15px;
            align-items: center;
            margin: 20px 0;
            flex-wrap: wrap;
        }
        .date-picker-group > div {
            flex: 1;
            min-width: 200px;
        }
        .quiz-list-item {
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .quiz-list-item:hover {
            border-color: #c44569;
            background: #f9f9f9;
        }
        .quiz-list-item.selected {
            border-color: #4CAF50;
            background: #e8f5e9;
        }
        .quiz-date-info {
            font-weight: 600;
            color: #6a1b9a;
        }
        .quiz-question-preview {
            font-size: 0.9em;
            color: #666;
            margin-top: 5px;
        }

        /* â”€â”€ Activity Banners: Quiz / Scavenger Hunt / Speed Slide â”€â”€â”€ */
        @keyframes floatIcon {
            0%,100% { transform: translateY(0px) rotate(-2deg); }
            50%      { transform: translateY(-7px) rotate(2deg); }
        }
        @keyframes glowGreen {
            0%,100% { box-shadow: 0 6px 28px rgba(40,167,69,.4), 0 0 0 0 rgba(40,167,69,.15); }
            50%      { box-shadow: 0 10px 38px rgba(40,167,69,.55), 0 0 0 10px rgba(40,167,69,0); }
        }
        @keyframes glowPurple {
            0%,100% { box-shadow: 0 6px 28px rgba(106,27,154,.4), 0 0 0 0 rgba(106,27,154,.15); }
            50%      { box-shadow: 0 10px 38px rgba(106,27,154,.55), 0 0 0 10px rgba(106,27,154,0); }
        }
        @keyframes glowAmber {
            0%,100% { box-shadow: 0 6px 28px rgba(255,160,0,.4), 0 0 0 0 rgba(255,160,0,.15); }
            50%      { box-shadow: 0 10px 38px rgba(255,160,0,.55), 0 0 0 10px rgba(255,160,0,0); }
        }
        @keyframes liveDot {
            0%,100% { opacity:1; transform:scale(1); }
            50%      { opacity:.4; transform:scale(1.4); }
        }
        @keyframes ctaPop {
            0%,100% { transform:scale(1); }
            50%      { transform:scale(1.04); }
        }
        .act-banner-wrap {
            width:100%;max-width:1200px;margin:0 auto 12px;
            border-radius:18px;padding:18px 22px 18px 20px;
            display:flex;align-items:center;gap:16px;flex-wrap:wrap;
            position:relative;overflow:hidden;
            animation:slideInUp .45s ease-out both;
        }
        .act-banner-wrap::before {
            content:'';position:absolute;inset:0;
            background:repeating-linear-gradient(135deg,rgba(255,255,255,.04) 0px,rgba(255,255,255,.04) 1px,transparent 1px,transparent 24px);
            pointer-events:none;
        }
        .act-banner-icon {
            font-size:2.8em;flex-shrink:0;
            animation:floatIcon 3.2s ease-in-out infinite;
            filter:drop-shadow(0 3px 8px rgba(0,0,0,.25));
        }
        .act-banner-body { flex:1;min-width:180px; }
        .act-banner-title {
            font-size:1.12em;font-weight:800;margin:0 0 3px;
            letter-spacing:.2px;line-height:1.3;
        }
        .act-banner-sub { font-size:.85em;opacity:.9;margin:0;line-height:1.6; }
        .act-banner-cta {
            flex-shrink:0;padding:11px 24px;border-radius:30px;font-weight:800;
            font-size:.88em;border:none;cursor:pointer;letter-spacing:.4px;
            white-space:nowrap;transition:transform .15s,filter .15s;
            animation:ctaPop 2.5s ease-in-out infinite;
        }
        .act-banner-cta:hover { transform:scale(1.07)!important; filter:brightness(1.1); }
        .live-dot {
            display:inline-block;width:9px;height:9px;border-radius:50%;
            margin-right:6px;vertical-align:middle;
            animation:liveDot 1.4s ease-in-out infinite;
        }
        /* countdown chip inside quiz banner */
        .quiz-cdown-chip {
            display:inline-flex;align-items:center;gap:8px;
            background:rgba(255,255,255,.18);backdrop-filter:blur(4px);
            border:1.5px solid rgba(255,255,255,.35);border-radius:30px;
            padding:7px 16px;margin-top:10px;font-size:.88em;font-weight:700;color:white;
        }
        .quiz-cdown-chip span { color:#ffe082;font-size:1.1em;letter-spacing:1px; }
        /* scavenger task pill */
        .sh-task-pill {
            display:inline-flex;align-items:center;gap:6px;
            background:rgba(255,255,255,.18);border:1.5px solid rgba(255,255,255,.35);
            border-radius:20px;padding:4px 12px;font-size:.8em;font-weight:700;
            color:white;margin:3px 3px 0 0;white-space:nowrap;
        }

        /* â”€â”€ Speed Slide Challenge â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        @keyframes sscPop {
            from { transform: scale(.7); opacity: 0; }
            to   { transform: scale(1);  opacity: 1; }
        }
        .ssc-tile {
            background-size: cover; background-position: center;
            border-radius: 7px; cursor: pointer;
            transition: transform .12s, box-shadow .12s;
            box-shadow: inset 0 0 0 2px rgba(255,255,255,.25);
            aspect-ratio: 1;
        }
        .ssc-tile:hover { transform: scale(1.04); box-shadow: 0 4px 12px rgba(0,0,0,.3); }
        .ssc-tile.ssc-empty { background: #c44569 !important; cursor: default; opacity: .3; }
        .ssc-tile.ssc-empty:hover { transform: none; box-shadow: none; }
        @keyframes sscWinPop {
            from { transform: scale(0.5); opacity: 0; }
            to   { transform: scale(1);   opacity: 1; }
        }
        @keyframes sscWinBounce {
            0%   { transform: scale(0) rotate(-15deg); opacity:0; }
            60%  { transform: scale(1.3) rotate(5deg); }
            80%  { transform: scale(0.9) rotate(-3deg); }
            100% { transform: scale(1) rotate(0); opacity:1; }
        }
        @keyframes sscScoreCount {
            from { transform: scale(0.4); opacity:0; }
            to   { transform: scale(1);   opacity:1; }
        }
        @keyframes sscDiffFloat {
            0%,100% { transform: translateY(0); }
            50%     { transform: translateY(-10px); }
        }
        @keyframes sscBoardShake {
            0%,100% { transform: translateX(0); }
            20%,60% { transform: translateX(-6px); }
            40%,80% { transform: translateX(6px); }
        }
        @keyframes sscBooShake {
            0%,100% { transform: translateX(0) rotate(0); }
            20%     { transform: translateX(-8px) rotate(-5deg); }
            40%     { transform: translateX(8px) rotate(5deg); }
            60%     { transform: translateX(-5px) rotate(-3deg); }
            80%     { transform: translateX(5px) rotate(3deg); }
        }
        @keyframes sscEmojiFloat {
            0%   { transform: translateY(0) rotate(0deg) scale(1); opacity:1; }
            100% { transform: translateY(-260px) rotate(720deg) scale(0.1); opacity:0; }
        }
        @keyframes sscBooDrop {
            0%   { transform: translateY(-20px) rotate(0deg); opacity:1; }
            100% { transform: translateY(200px) rotate(-360deg) scale(0.2); opacity:0; }
        }
        .ssc-board-shake { animation: sscBoardShake 0.4s ease; }
    </style>

    <style>
        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           SPEED SLIDE CHALLENGE â€” NEW GAME SETUP REDESIGN
           Professional, mobile-first layout
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

        /* â”€â”€ Play section wrapper â”€â”€ */
        #sscPlaySection {
            max-width: 680px !important;
            margin-left: auto !important;
            margin-right: auto !important;
            border-radius: 24px !important;
            padding: 0 !important;
            overflow: hidden;
            background: #ffffff !important;
            border: none !important;
            box-shadow: 0 24px 64px rgba(106,27,154,0.16), 0 4px 20px rgba(0,0,0,0.07) !important;
        }

        /* â”€â”€ Setup card container â”€â”€ */
        #sscSetupCard {
            padding: 32px 28px 28px;
        }

        /* â”€â”€ Title area â”€â”€ */
        #sscSetupCard > div[style*="text-align:center"] {
            background: linear-gradient(135deg, #6a1b9a 0%, #c44569 100%);
            margin: -32px -28px 28px !important;
            padding: 34px 28px 28px !important;
            border-radius: 0 !important;
            position: relative;
            overflow: hidden;
        }
        #sscSetupCard > div[style*="text-align:center"]::before {
            content: '';
            position: absolute; top: -50px; right: -50px;
            width: 160px; height: 160px; border-radius: 50%;
            background: rgba(255,255,255,0.06);
            pointer-events: none;
        }
        #sscSetupCard > div[style*="text-align:center"]::after {
            content: '';
            position: absolute; bottom: -40px; left: -30px;
            width: 120px; height: 120px; border-radius: 50%;
            background: rgba(255,255,255,0.05);
            pointer-events: none;
        }
        #sscSetupCard > div[style*="text-align:center"] > div:first-child {
            filter: drop-shadow(0 4px 8px rgba(0,0,0,0.2));
        }
        #sscSetupCard > div[style*="text-align:center"] h2 {
            color: white !important;
            font-size: 2em !important;
            font-weight: 900 !important;
            letter-spacing: -0.5px !important;
            text-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }
        #sscSetupCard > div[style*="text-align:center"] p {
            color: rgba(255,255,255,0.82) !important;
            font-size: 0.95em !important;
        }

        /* â”€â”€ Step number badges â”€â”€ */
        #sscSetupCard div[style*="width:30px"] {
            box-shadow: 0 4px 12px rgba(106,27,154,0.4);
        }

        /* â”€â”€ Difficulty cards â”€â”€ */
        .ssc-diff-card {
            background: #fafafa;
            border: 2.5px solid #e0e0e0;
            border-radius: 16px;
            padding: 20px 16px 16px;
            cursor: pointer;
            text-align: center;
            transition: all 0.25s ease;
            position: relative;
            overflow: hidden;
        }
        .ssc-diff-card:hover {
            border-color: #9c27b0;
            background: #faf0ff;
            transform: translateY(-3px);
            box-shadow: 0 8px 24px rgba(106,27,154,0.15);
        }
        .ssc-diff-card.ssc-selected {
            border-color: #6a1b9a;
            background: linear-gradient(135deg, #faf0ff 0%, #fce4ec 100%);
            box-shadow: 0 8px 24px rgba(106,27,154,0.2);
            transform: translateY(-2px);
        }
        .ssc-diff-card.ssc-selected::after {
            content: 'âœ“';
            position: absolute;
            top: 8px; right: 10px;
            width: 22px; height: 22px;
            background: linear-gradient(135deg, #6a1b9a, #c44569);
            color: white;
            border-radius: 50%;
            font-size: 0.7em;
            font-weight: 900;
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 22px;
            text-align: center;
        }
        .diff-emoji {
            font-size: 2.2em;
            display: block;
            margin-bottom: 2px;
        }

        /* Grid responsive for difficulty cards */
        #sscSetupCard div[style*="repeat(auto-fit"] {
            grid-template-columns: repeat(3, 1fr) !important;
        }
        @media (max-width: 480px) {
            #sscSetupCard div[style*="repeat(auto-fit"] {
                grid-template-columns: 1fr !important;
                gap: 10px !important;
            }
            .ssc-diff-card {
                display: flex;
                align-items: center;
                gap: 14px;
                padding: 14px 16px;
                text-align: left;
            }
            .diff-emoji { font-size: 1.8em; margin-bottom: 0; flex-shrink: 0; }
            .ssc-diff-card > div:not(.diff-emoji) { flex: 1; }
        }

        /* â”€â”€ Upload zone â”€â”€ */
        .ssc-upload-zone {
            border: 2.5px dashed #ce93d8;
            border-radius: 16px;
            padding: 32px 20px;
            text-align: center;
            cursor: pointer;
            background: linear-gradient(135deg, #faf0ff 0%, #fce4ec 100%);
            transition: all 0.25s ease;
            position: relative;
        }
        .ssc-upload-zone:hover {
            border-color: #6a1b9a;
            background: linear-gradient(135deg, #f3e5f5 0%, #fce4ec 100%);
            box-shadow: 0 6px 20px rgba(106,27,154,0.12);
        }
        .ssc-upload-zone.has-image {
            border-color: #4caf50;
            border-style: solid;
            background: linear-gradient(135deg, #f1f8e9, #e8f5e9);
        }

        /* â”€â”€ Start button â”€â”€ */
        #sscStartBtn {
            border-radius: 14px !important;
            font-size: 1.1em !important;
            font-weight: 800 !important;
            letter-spacing: 0.5px !important;
            transition: all 0.3s ease !important;
        }
        #sscStartBtn:not([disabled]):hover {
            transform: translateY(-2px) !important;
            box-shadow: 0 12px 32px rgba(67,160,71,0.5) !important;
        }

        /* â”€â”€ Paused banner polish â”€â”€ */
        #sscPausedBanner {
            border-radius: 14px !important;
            border-left-width: 5px !important;
        }

        /* â”€â”€ Stat boxes in game area â”€â”€ */
        .ssc-stat-box {
            border-radius: 14px;
            padding: 14px 10px;
            text-align: center;
        }
        .ssc-stat-val {
            font-size: 1.6em;
            font-weight: 900;
            line-height: 1;
        }
        .ssc-stat-lbl {
            font-size: 0.72em;
            color: #888;
            margin-top: 5px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* â”€â”€ Win modal â”€â”€ */
        .ssc-win-inner {
            background: linear-gradient(160deg, #1a0030 0%, #3d0060 60%, #6a1b9a 100%);
            border-radius: 24px;
            padding: 40px 32px 36px;
            max-width: 440px;
            width: 90vw;
            text-align: center;
            box-shadow: 0 32px 80px rgba(0,0,0,0.5);
        }
        .ssc-win-stat {
            background: rgba(255,255,255,0.08);
            border-radius: 12px;
            padding: 14px 10px;
            text-align: center;
            border: 1px solid rgba(255,255,255,0.12);
            flex: 1;
        }

        /* â”€â”€ Responsive â”€â”€ */
        @media (max-width: 600px) {
            #sscPlaySection { border-radius: 18px !important; }
            #sscSetupCard { padding: 24px 16px 22px; }
            #sscSetupCard > div[style*="text-align:center"] {
                margin: -24px -16px 22px !important;
                padding: 26px 18px 22px !important;
            }
            #sscSetupCard > div[style*="text-align:center"] h2 { font-size: 1.6em !important; }
            .ssc-win-inner { padding: 28px 20px 24px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- ============================================ -->
        <!-- TO CHANGE BANNER IMAGE:                      -->
        <!-- Replace "banner.gif?v=5" with your file      -->
        <!-- Supported: .gif, .png, .jpg                  -->
        <!-- ============================================ -->
        <img src="banner.gif?v=5" class="banner">
        
        <div class="header">
            <h1>ðŸŽ‰ SPURTHI YOUTH FEST 2026 ðŸŽ‰</h1>
            <p id="userInfo"></p>
        </div>

        <!-- ============================================================ -->
        <!-- ANNOUNCEMENT BANNER                                          -->
        <!-- TO EDIT: Change the text inside the <span> tag below        -->
        <!-- TO HIDE: Change display:block to display:none on the div    -->
        <!-- ============================================================ -->
        <div style="display:block;width:100%;max-width:1200px;margin:0 auto 22px;border-radius:14px;background:linear-gradient(90deg,#e8722a 0%,#f0a05a 40%,#f0a05a 60%,#e8722a 100%);box-shadow:0 4px 18px rgba(232,114,42,0.35);padding:16px 30px;text-align:center;animation:shimmer 3s linear infinite;background-size:2000px 100%">
            <!-- EDIT BANNER TEXT BELOW -->
            <span id="announcementBannerText" style="color:white;font-size:1.1em;font-weight:700;letter-spacing:0.5px;text-shadow:0 1px 4px rgba(0,0,0,0.18)">
                ðŸŽ¯ welcome to Spurthi Youth Fest 2026 ðŸŽ¯ The most trending college fest-------
            </span>
        </div>
        <!-- ============================================================ -->
        <!-- END ANNOUNCEMENT BANNER                                      -->
        <!-- ============================================================ -->

        <!-- ============================================================ -->
        <!-- ACTIVITY BANNERS (Quiz Â· Scavenger Hunt Â· Speed Slide)       -->
        <!-- These are rendered dynamically by initActivityBanners()      -->
        <!-- ============================================================ -->
        <div id="activityBannersContainer" style="width:100%;max-width:1200px;margin:0 auto"></div>
        <!-- ============================================================ -->
        <!-- END ACTIVITY BANNERS                                         -->
        <!-- ============================================================ -->

        <!-- Login/Logout Section (Visible to all) -->
        <div class="content" id="loginSection">
            <h2 style="text-align:center;color:#c44569;margin-bottom:25px">Login</h2>
            
            <!-- Student Login at Top -->
            <div id="studentLogin">
                <div class="form-group">
                    <label>Class:</label>
                    <select id="studentClass"></select>
                </div>
                <button class="btn" onclick="studentLogin()">Login as Student</button>
            </div>
            
            <!-- Divider -->
            <div style="margin: 30px 0; border-top: 2px solid #ddd;"></div>
            
            <!-- Youthfest Registration Dropdown -->
            <div class="form-group">
                <label>Youthfest Registration</label>
                <select id="userType" onchange="handleUserTypeChange()">
                    <option value="">-- Select --</option>
                    <option value="cr">Class Representative (CR)</option>
                    <option value="admin">Admin</option>
                    <option value="superadmin">Super Admin</option>
                    <option value="manager">Manager</option>
                    <option value="jury">Jury</option>
                </select>
            </div>
            
            <!-- CR Login -->
            <div id="crLogin" style="display:none">
                <div class="form-group">
                    <label>Class:</label>
                    <select id="crClass"></select>
                </div>
                <div style="margin-bottom:12px">
                    <label style="display:flex;align-items:center;gap:8px;cursor:pointer;font-size:0.9em;color:#555;font-weight:normal">
                        <input type="checkbox" id="crRememberMe" style="width:auto;accent-color:#6a1b9a"> Remember my class on this device
                    </label>
                </div>
                <button class="btn" onclick="crLogin()">Login as CR</button>
            </div>
            
            <!-- Admin Login -->
            <div id="adminLogin" style="display:none">
                <div class="form-group">
                    <label>Admin Password:</label>
                    <input type="password" id="adminPassword" placeholder="Enter admin password" onkeydown="if(event.key==='Enter') adminLogin()">
                </div>
                <div style="margin-bottom:12px">
                    <label style="display:flex;align-items:center;gap:8px;cursor:pointer;font-size:0.9em;color:#555;font-weight:normal">
                        <input type="checkbox" id="adminRememberMe" style="width:auto;accent-color:#6a1b9a"> Remember password on this device
                    </label>
                </div>
                <button class="btn" onclick="adminLogin()">Login as Admin</button>
            </div>
            
            <!-- Super Admin Login -->
            <div id="superAdminLogin" style="display:none">
                <div class="form-group">
                    <label>Super Admin Password:</label>
                    <input type="password" id="superAdminPassword" placeholder="Enter super admin password" onkeydown="if(event.key==='Enter') superAdminLogin()">
                </div>
                <div style="margin-bottom:12px">
                    <label style="display:flex;align-items:center;gap:8px;cursor:pointer;font-size:0.9em;color:#555;font-weight:normal">
                        <input type="checkbox" id="superAdminRememberMe" style="width:auto;accent-color:#6a1b9a"> Remember password on this device
                    </label>
                </div>
                <button class="btn" onclick="superAdminLogin()">Login as Super Admin</button>
            </div>
            
            <!-- Manager Login -->
            <div id="managerLogin" style="display:none">
                <div class="form-group">
                    <label>Manager Password:</label>
                    <input type="password" id="managerPassword" placeholder="Enter manager password" onkeydown="if(event.key==='Enter') managerLogin()">
                </div>
                <div style="margin-bottom:12px">
                    <label style="display:flex;align-items:center;gap:8px;cursor:pointer;font-size:0.9em;color:#555;font-weight:normal">
                        <input type="checkbox" id="managerRememberMe" style="width:auto;accent-color:#2196F3"> Remember password on this device
                    </label>
                </div>
                <button class="btn" style="background:#2196F3" onclick="managerLogin()">Login as Manager</button>
            </div>

            <!-- Jury Login -->
            <div id="juryLogin" style="display:none">
                <div class="form-group">
                    <label>Select Event:</label>
                    <select id="juryEvent"></select>
                </div>
                <div class="form-group">
                    <label>Jury Password:</label>
                    <input type="password" id="juryPassword" placeholder="Enter jury password for this event" onkeydown="if(event.key==='Enter') juryLogin()">
                </div>
                <div class="form-group">
                    <label>Jury Number (1 or 2):</label>
                    <select id="juryNumber">
                        <option value="">-- Select --</option>
                        <option value="1">Jury 1</option>
                        <option value="2">Jury 2</option>
                    </select>
                </div>
                <button class="btn" onclick="juryLogin()">Login as Jury</button>
            </div>
            
            <!-- Divider -->
            <div style="margin: 30px 0; border-top: 2px solid #ddd;"></div>
            
            <!-- Online Competition Dropdown -->
            <div class="form-group">
                <label>Online Competition</label>
                <select id="competitionType" onchange="handleCompetitionChange()">
                    <option value="">-- Select --</option>
                    <option value="dailyquiz">Daily Quiz Competition</option>
                    <option value="scavengerhunt">ðŸ—ºï¸ Scavenger Hunt</option>
                    <option value="speedslide">ðŸ§© Speed Slide Challenge</option>
                </select>
            </div>
            
            <!-- Daily Quiz Competition Login -->
            <div id="dailyQuizLogin" style="display:none">
                <!-- Public Quiz Status (shows before login) -->
                <div id="publicQuizStatus" style="margin-bottom:30px">
                    <h3 style="color:#c44569;margin-bottom:20px;font-size:1.8em;text-align:center">ðŸ“ Today's Daily Quiz Competition</h3>
                    <div id="publicQuizMessage" class="quiz-status-card" style="padding:25px;background:white;border-radius:15px;border-left:5px solid #667eea;box-shadow:0 6px 20px rgba(0,0,0,0.1)">
                        <p style="margin:0;color:#666;text-align:center">Checking today's quiz status...</p>
                    </div>
                </div>

                <!-- Past Results Lookup -->
                <div style="background:white;border-radius:14px;padding:18px 20px;margin-bottom:24px;box-shadow:0 4px 16px rgba(0,0,0,0.08);border:2px solid #e0e0e0">
                    <div style="display:flex;align-items:center;gap:10px;margin-bottom:14px;flex-wrap:wrap">
                        <span style="font-size:1.4em">ðŸ“…</span>
                        <h4 style="margin:0;color:#6a1b9a;font-size:1em">Check Past Quiz Results</h4>
                    </div>
                    <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
                        <input type="date" id="pastResultDate"
                            style="flex:1;min-width:150px;padding:10px 14px;border:2px solid #9c27b0;border-radius:10px;font-size:14px;color:#333;cursor:pointer">
                        <button onclick="loadPastQuizResult()" style="background:linear-gradient(135deg,#6a1b9a,#c44569);color:white;border:none;padding:10px 20px;border-radius:10px;font-size:14px;font-weight:700;cursor:pointer;white-space:nowrap">ðŸ” Check Result</button>
                    </div>
                    <div id="pastResultBox" style="margin-top:14px;display:none"></div>
                </div>
                
                <hr style="margin:30px 0;border:none;border-top:2px solid #e9ecef">
                
                <h3 style="color:#6a1b9a;margin-bottom:15px">Student Registration & Login</h3>
                <div id="quizMessage" class="message"></div>
                
                <div style="background:#fff3cd;padding:15px;border-radius:8px;margin-bottom:20px;border-left:4px solid #ffc107">
                    <p style="margin:0;color:#856404"><strong>New Student?</strong> Register to get password</p>
                </div>
                
                <div class="form-group">
                    <label>Select Class:</label>
                    <select id="quizClass"></select>
                </div>
                <div class="form-group">
                    <label>Email Address:</label>
                    <input type="email" id="quizEmail" placeholder="your.email@example.com">
                </div>
                <div class="form-group">
                    <label>Phone Number:</label>
                    <input type="tel" id="quizPhone" placeholder="10-digit mobile number">
                </div>
                <div class="form-group">
                    <label>Full Name:</label>
                    <input type="text" id="quizName" placeholder="Enter your full name">
                </div>
                <button class="btn" onclick="registerQuizStudent()" style="margin-bottom:10px">ðŸ“ Register & Get Password</button>
                
                <hr style="margin:25px 0;border:none;border-top:2px solid #e9ecef">
                
                <div style="background:#d4edda;padding:15px;border-radius:8px;margin-bottom:20px;border-left:4px solid #28a745">
                    <p style="margin:0;color:#155724"><strong>Already Registered?</strong> Login with your phone number and password</p>
                </div>
                
                <div class="form-group">
                    <label>Phone Number:</label>
                    <input type="tel" id="quizLoginPhone" placeholder="Enter 10-digit phone number" maxlength="10" inputmode="numeric" pattern="[0-9]*" autocomplete="tel" onkeydown="if(event.key==='Enter') loginQuizStudent()">
                </div>
                <div class="form-group">
                    <label>Password:</label>
                    <input type="password" id="quizLoginPassword" placeholder="Enter password" onkeydown="if(event.key==='Enter') loginQuizStudent()">
                </div>
                <div style="margin-bottom:12px">
                    <label style="display:flex;align-items:center;gap:8px;cursor:pointer;font-size:0.9em;color:#555;font-weight:normal">
                        <input type="checkbox" id="quizRememberMe" style="width:auto;accent-color:#6a1b9a"> Remember me on this device
                    </label>
                </div>
                <button class="btn btn-success" onclick="loginQuizStudent()">ðŸš€ Login to Quiz</button>
            </div>

            <!-- ============================================ -->
            <!-- SCAVENGER HUNT LOGIN                         -->
            <!-- ============================================ -->
            <div id="scavengerHuntLogin" style="display:none">
                <div style="text-align:center;margin-bottom:24px">
                    <div style="font-size:3em;margin-bottom:8px">ðŸ—ºï¸</div>
                    <h3 style="color:#6a1b9a;font-size:1.8em;margin-bottom:6px">Scavenger Hunt</h3>
                    <p style="color:#666;font-size:1em">Find locations Â· Take photos Â· Win prizes!</p>
                </div>

                <!-- Hunt Status Banner -->
                <div id="shPublicBanner" style="background:linear-gradient(135deg,#9c27b0,#e91e63);color:white;border-radius:14px;padding:18px 22px;margin-bottom:22px;text-align:center">
                    <p style="margin:0;font-size:1em;opacity:0.9">â³ Checking hunt status...</p>
                </div>

                <div style="background:#f3e5f5;padding:15px;border-radius:8px;margin-bottom:20px;border-left:4px solid #9c27b0">
                    <p style="margin:0;color:#6a1b9a"><strong>ðŸ“‹ How it works:</strong> Login â†’ Get tasks â†’ Visit locations â†’ Upload photo proof â†’ Admin verifies â†’ First to finish wins! ðŸ†</p>
                </div>

                <div style="background:#e8f5e9;padding:15px;border-radius:8px;margin-bottom:20px;border-left:4px solid #4caf50">
                    <p style="margin:0;color:#2e7d32"><strong>ðŸ“ GPS Version Active:</strong> App auto-detects your location. You must be within 100 metres of the target to upload your photo.</p>
                </div>

                <h4 style="color:#6a1b9a;margin-bottom:14px">Login with your Quiz account</h4>
                <div id="shLoginMsg" class="message"></div>
                <div class="form-group">
                    <label>Phone Number:</label>
                    <input type="tel" id="shLoginPhone" placeholder="Enter 10-digit phone number" maxlength="10" inputmode="numeric" onkeydown="if(event.key==='Enter') shLogin()">
                </div>
                <div class="form-group">
                    <label>Password:</label>
                    <input type="password" id="shLoginPassword" placeholder="Enter password" onkeydown="if(event.key==='Enter') shLogin()">
                </div>
                <div style="margin-bottom:14px">
                    <label style="display:flex;align-items:center;gap:8px;cursor:pointer;font-size:0.9em;color:#555;font-weight:normal">
                        <input type="checkbox" id="shRememberMe" style="width:auto;accent-color:#9c27b0"> Remember me on this device
                    </label>
                </div>
                <button class="btn sh-glow" onclick="shLogin()" style="background:linear-gradient(135deg,#9c27b0,#e91e63);color:white;width:100%;font-size:1.1em;padding:15px;border-radius:12px;font-weight:700;letter-spacing:0.5px;margin-bottom:8px">
                    ðŸš€ Enter Scavenger Hunt
                </button>
            </div>

            <!-- ============================================ -->
            <!-- SPEED SLIDE CHALLENGE LOGIN                   -->
            <!-- ============================================ -->
            <div id="speedSlideLogin" style="display:none">
                <div style="text-align:center;margin-bottom:20px">
                    <div style="font-size:3em;margin-bottom:8px">ðŸ§©</div>
                    <h3 style="color:#6a1b9a;font-size:1.8em;margin-bottom:6px">Speed Slide Challenge</h3>
                    <p style="color:#666;font-size:1em">Upload any photo Â· Solve the sliding puzzle Â· Win points!</p>
                </div>
                <div style="background:linear-gradient(135deg,#6a1b9a,#c44569);border-radius:14px;padding:14px 20px;text-align:center;margin-bottom:18px">
                    <p style="color:white;margin:0;font-size:.95em;font-weight:600">ðŸ§© 3 levels Â· 8-Puzzle (100pts) Â· 15-Puzzle (200pts) Â· 24-Puzzle (300pts)</p>
                </div>
                <div style="background:#f3e5f5;padding:12px 16px;border-radius:8px;margin-bottom:18px;border-left:4px solid #9c27b0">
                    <p style="margin:0;color:#6a1b9a;font-size:.9em"><strong>ðŸ“‹ How it works:</strong> Login â†’ Upload photo â†’ Solve puzzle â†’ Submit score â†’ Leaderboard!</p>
                </div>
                <div id="sscLoginMsg" class="message"></div>
                <div class="form-group">
                    <label>Phone Number:</label>
                    <input type="tel" id="sscLoginPhone" placeholder="10-digit mobile number" maxlength="10" inputmode="numeric" onkeydown="if(event.key==='Enter') sscLogin()">
                </div>
                <div class="form-group">
                    <label>Password:</label>
                    <input type="password" id="sscLoginPassword" placeholder="Your quiz password" onkeydown="if(event.key==='Enter') sscLogin()">
                </div>
                <div style="margin-bottom:14px">
                    <label style="display:flex;align-items:center;gap:8px;cursor:pointer;font-weight:normal;color:#555;font-size:.9em">
                        <input type="checkbox" id="sscRememberMe" style="width:auto;accent-color:#6a1b9a"> Remember me on this device
                    </label>
                </div>
                <button class="btn" onclick="sscLogin()" style="background:linear-gradient(135deg,#6a1b9a,#c44569);width:100%;padding:14px;font-size:1.05em">ðŸš€ Login &amp; Play</button>
            </div>
        </div>

        <!-- Student Enrollment Section -->
        <div class="student-section" id="studentSection" style="display:none">
            <button class="btn btn-secondary" onclick="logout()" style="float:right">Logout</button>
            <h2 style="color:#c44569;margin-bottom:20px">Student Enrollment</h2>
            <div id="enrollMessage" class="message"></div>
            
            <div class="class-indicator" id="classIndicator">
                <h3>You are enrolling for</h3>
                <div class="class-name" id="currentClassName"></div>
            </div>

            <!-- View Class Enrollments Section -->
            <div style="background:#e3f2fd;padding:20px;border-radius:8px;margin-bottom:20px;border:2px solid #2196F3;">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:15px;">
                    <h3 style="color:#1976D2;margin:0;">ðŸ“Š Your Class Enrollments</h3>
                    <button class="btn btn-small" onclick="toggleEnrollmentView()" id="toggleEnrollmentBtn">
                        Hide Details
                    </button>
                </div>
                
                <!-- Event Filter -->
                <div class="form-group" style="margin-bottom:15px;">
                    <label>Filter by Event:</label>
                    <select id="studentEventFilter" onchange="viewStudentClassEnrollments()">
                        <option value="">All Events</option>
                    </select>
                </div>
                
                <div id="studentEnrollmentResults"></div>
            </div>

            <div class="form-group">
                <label>Select Event to Enroll:</label>
                <div class="event-grid" id="eventCardsContainer"></div>
            </div>

            <div id="enrollmentForm" style="display:none">
                <div id="enrollmentFormContent"></div>
                <div id="enrollBtnsNormal">
                    <button class="btn" onclick="submitEnrollment(false)">Submit Enrollment</button>
                    <button class="btn btn-secondary" onclick="cancelEnrollment()">Cancel</button>
                </div>
                <div id="enrollBtnsOneAtATime" style="display:none">
                    <button class="btn btn-success" onclick="submitEnrollment(true)" style="margin-right:10px">âœ… Submit & Add Another</button>
                    <button class="btn" onclick="submitEnrollment(false)">âœ” Submit & Finish</button>
                    <button class="btn btn-secondary" onclick="cancelEnrollment()">Cancel</button>
                </div>
            </div>
        </div>

        <!-- CR Section -->
        <div class="cr-section" id="crSection" style="display:none">
            <button class="btn btn-secondary" onclick="logout()" style="float:right">Logout</button>
            <h2 style="color:#2196F3;margin-bottom:20px">Class Representative Dashboard</h2>
            <div id="crMessage" class="message"></div>
            
            <div class="class-indicator active">
                <h3>Managing Class</h3>
                <div class="class-name" id="crClassName"></div>
            </div>

            <div class="tabs">
                <button class="tab active" onclick="showCRTab('crEnroll')">Enroll Students</button>
                <button class="tab" onclick="showCRTab('crView')">View Enrollments</button>
                <button class="tab" onclick="showCRTab('crQuizStats');loadCRQuizStats()">ðŸ§  Quiz Stats</button>
                <button class="tab" onclick="showCRTab('crScavengerStats');loadCRScavengerStats()">ðŸ—ºï¸ Scavenger Hunt</button>
            </div>

            <div id="crEnroll" class="form-section active">
                <h3 style="margin-bottom:20px">Enroll Students for Your Class</h3>
                <div class="form-group">
                    <label>Select Event:</label>
                    <div class="event-grid" id="crEventCardsContainer"></div>
                </div>

                <div id="crEnrollmentForm" style="display:none">
                    <div id="crEnrollmentFormContent"></div>
                    <div id="crEnrollBtnsNormal">
                        <button class="btn" onclick="submitCREnrollment(false)">Submit Enrollment</button>
                        <button class="btn btn-secondary" onclick="cancelCREnrollment()">Cancel</button>
                    </div>
                    <div id="crEnrollBtnsOneAtATime" style="display:none">
                        <button class="btn btn-success" onclick="submitCREnrollment(true)" style="margin-right:10px">âœ… Submit & Add Another</button>
                        <button class="btn" onclick="submitCREnrollment(false)">âœ” Submit & Finish</button>
                        <button class="btn btn-secondary" onclick="cancelCREnrollment()">Cancel</button>
                    </div>
                </div>
            </div>

            <div id="crView" class="form-section">
                <h3 style="margin-bottom:20px">Your Class Enrollments</h3>
                <div class="filter-section">
                    <select id="crFilterEvent" onchange="updateCRView()">
                        <option value="">All Events</option>
                    </select>
                    <button class="btn btn-small" onclick="clearCRFilters()">Clear Filters</button>
                    <button class="btn btn-small btn-success" onclick="downloadCREnrollments()">ðŸ“¥ Download Enrollments</button>
                </div>
                <div id="crSummary" style="margin-bottom:20px"></div>
                <div id="crEnrollmentsContainer"></div>
            </div>

            <!-- â”€â”€ CR SCAVENGER HUNT STATS TAB â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
            <div id="crScavengerStats" class="form-section">
                <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:10px;margin-bottom:14px">
                    <h3 style="color:#6a1b9a;margin:0">ðŸ—ºï¸ Scavenger Hunt â€” Your Class Stats</h3>
                    <button class="btn btn-small btn-info" onclick="loadCRScavengerStats()">ðŸ”„ Refresh</button>
                </div>

                <!-- Task Filter Bar -->
                <div style="background:linear-gradient(135deg,#6a1b9a,#c44569);border-radius:12px;padding:12px 18px;margin-bottom:16px;display:flex;align-items:center;gap:12px;flex-wrap:wrap">
                    <label style="color:white;font-weight:700;font-size:0.9em;white-space:nowrap">ðŸ” Filter by Task:</label>
                    <select id="crShTaskFilter" onchange="crShApplyTaskFilter()" style="flex:1;min-width:200px;padding:8px 12px;border-radius:8px;border:none;font-size:0.9em;color:#3d0060;font-weight:600;outline:none">
                        <option value="">â€” All Tasks â€”</option>
                    </select>
                    <span id="crShTaskBadge" style="display:none;background:white;color:#6a1b9a;padding:4px 12px;border-radius:20px;font-size:0.8em;font-weight:700;max-width:220px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap"></span>
                </div>

                <!-- Info summary box -->
                <div id="crShInfoBox" style="background:#fffde7;border-radius:10px;padding:16px 18px;margin-bottom:16px;border-left:4px solid #ffc107">
                    <h4 style="color:#856404;margin:0 0 5px;font-size:0.9em">ðŸ“‹ Scavenger Hunt Participation Summary â€” <span id="crShInfoDate">Loadingâ€¦</span></h4>
                    <div id="crShInfoText" style="color:#555;font-size:13px;line-height:1.75">Loading your class's scavenger hunt dataâ€¦</div>
                </div>

                <!-- Stats cards -->
                <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:12px;margin-bottom:18px">
                    <div style="background:linear-gradient(135deg,#667eea,#764ba2);border-radius:10px;padding:16px;text-align:center">
                        <div style="font-size:1.8em;font-weight:800;color:white" id="crShTotal">â€”</div>
                        <div style="color:rgba(255,255,255,0.8);font-size:12px;margin-top:4px">Participants</div>
                    </div>
                    <div style="background:linear-gradient(135deg,#28a745,#20c997);border-radius:10px;padding:16px;text-align:center">
                        <div style="font-size:1.8em;font-weight:800;color:white" id="crShApproved">â€”</div>
                        <div style="color:rgba(255,255,255,0.8);font-size:12px;margin-top:4px">Approved Tasks</div>
                    </div>
                    <div style="background:linear-gradient(135deg,#ffc107,#ff9800);border-radius:10px;padding:16px;text-align:center">
                        <div style="font-size:1.8em;font-weight:800;color:white" id="crShPending">â€”</div>
                        <div style="color:rgba(255,255,255,0.8);font-size:12px;margin-top:4px">Pending Review</div>
                    </div>
                    <div style="background:linear-gradient(135deg,#c44569,#e91e63);border-radius:10px;padding:16px;text-align:center">
                        <div style="font-size:1.8em;font-weight:800;color:white" id="crShRejected">â€”</div>
                        <div style="color:rgba(255,255,255,0.8);font-size:12px;margin-top:4px">Rejected</div>
                    </div>
                </div>

                <!-- Student list -->
                <div style="background:white;border-radius:10px;border:2px solid #e0c8f5;overflow:hidden">
                    <div style="background:linear-gradient(135deg,#6a1b9a,#c44569);padding:12px 16px">
                        <h4 style="color:white;margin:0;font-size:0.95em">Your Class Students â€” Scavenger Hunt Submissions</h4>
                    </div>
                    <div class="table-wrapper" style="margin:0">
                        <table>
                            <thead id="crShTableHead">
                                <tr>
                                    <th>#</th>
                                    <th>Student Name</th>
                                    <th>Tasks Submitted</th>
                                    <th>Approved</th>
                                    <th>Pending</th>
                                    <th>Rejected</th>
                                </tr>
                            </thead>
                            <tbody id="crShTable"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- â”€â”€ CR QUIZ STATS TAB â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
            <div id="crQuizStats" class="form-section">
                <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:10px;margin-bottom:18px">
                    <h3 style="color:#6a1b9a;margin:0">ðŸ§  Online Quiz â€” Your Class Stats</h3>
                    <div style="display:flex;gap:8px;align-items:center">
                        <select id="crQsDateFilter" onchange="loadCRQuizStats()" style="padding:7px 12px;border:2px solid #6a1b9a;border-radius:8px;color:#3d0060;font-weight:600;background:white;outline:none">
                            <option value="">â€” Select Date â€”</option>
                        </select>
                        <button class="btn btn-small btn-info" onclick="loadCRQuizStats()">ðŸ”„ Refresh</button>
                    </div>
                </div>

                <!-- Info notice box â€” visible to CR -->
                <div id="crQsInfoBox" style="background:#fffde7;border-radius:10px;padding:16px 18px;margin-bottom:16px;border-left:4px solid #ffc107">
                    <h4 style="color:#856404;margin:0 0 5px;font-size:0.9em">ðŸ“‹ Quiz Participation Summary â€” <span id="crQsInfoDate">select a date</span></h4>
                    <div id="crQsInfoText" style="color:#555;font-size:13px;line-height:1.75">Select a date above to see your class's quiz participation details.</div>
                </div>

                <!-- Stats cards for CR's class -->
                <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:12px;margin-bottom:18px" id="crQsCards">
                    <div style="background:linear-gradient(135deg,#667eea,#764ba2);border-radius:10px;padding:16px;text-align:center">
                        <div style="font-size:1.8em;font-weight:800;color:white" id="crQsTotal">â€”</div>
                        <div style="color:rgba(255,255,255,0.8);font-size:12px;margin-top:4px">Participated</div>
                    </div>
                    <div style="background:linear-gradient(135deg,#28a745,#20c997);border-radius:10px;padding:16px;text-align:center">
                        <div style="font-size:1.8em;font-weight:800;color:white" id="crQsCorrect">â€”</div>
                        <div style="color:rgba(255,255,255,0.8);font-size:12px;margin-top:4px">Both Correct</div>
                    </div>
                    <div style="background:linear-gradient(135deg,#ffc107,#ff9800);border-radius:10px;padding:16px;text-align:center">
                        <div style="font-size:1.8em;font-weight:800;color:white" id="crQsPartial">â€”</div>
                        <div style="color:rgba(255,255,255,0.8);font-size:12px;margin-top:4px">Partial (1/2)</div>
                    </div>
                    <div style="background:linear-gradient(135deg,#c44569,#e91e63);border-radius:10px;padding:16px;text-align:center">
                        <div style="font-size:1.8em;font-weight:800;color:white" id="crQsRate">â€”</div>
                        <div style="color:rgba(255,255,255,0.8);font-size:12px;margin-top:4px">Accuracy Rate</div>
                    </div>
                </div>

                <!-- Student list for CR's class on selected date -->
                <div style="background:white;border-radius:10px;border:2px solid #e0c8f5;overflow:hidden">
                    <div style="background:linear-gradient(135deg,#6a1b9a,#c44569);padding:12px 16px">
                        <h4 style="color:white;margin:0;font-size:0.95em">Your Class Students â€” Quiz Submissions</h4>
                    </div>
                    <div class="table-wrapper" style="margin:0">
                        <table>
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>Student Name</th>
                                    <th>Score</th>
                                    <th>Time Taken</th>
                                    <th>Submitted At</th>
                                </tr>
                            </thead>
                            <tbody id="crQsTable"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Admin Section -->
        <div class="admin-only" id="adminSection">
            <button class="btn btn-secondary" onclick="logout()" style="float:right">Logout</button>
            
            <!-- Admin Dashboard -->
            <div class="admin-dashboard">
                <h2 class="dashboard-title">ðŸ“Š Admin Dashboard</h2>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number" id="totalStudents">0</div>
                        <div class="stat-label">Total Students</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="totalEvents">0</div>
                        <div class="stat-label">Active Events</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="totalClasses">0</div>
                        <div class="stat-label">Classes</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="totalEnrollments">0</div>
                        <div class="stat-label">Total Enrollments</div>
                    </div>
                </div>
            </div>

            <div class="tabs">
                <button class="tab active" onclick="showTab('master')">Master List</button>
                <button class="tab" onclick="showTab('events')">By Events</button>
                <button class="tab super-admin-only" onclick="showTab('jurySetup')">Jury Setup</button>
                <button class="tab super-admin-only" onclick="showTab('juryLiveMonitor');startLiveJuryMonitor()">ðŸ“¡ Jury Live Monitor</button>
                <button class="tab" onclick="showTab('results')" id="resultsTab">Results</button>
                <button class="tab super-admin-only" onclick="showTab('quizManagement')" id="quizManagementTab">ðŸ“ Quiz Management</button>
                <button class="tab super-admin-only" onclick="showTab('leaderboardAdmin')" id="leaderboardAdminTab">ðŸ† Leaderboard</button>
                <button class="tab super-admin-only" onclick="showTab('scavengerAdmin')" id="scavengerAdminTab">ðŸ—ºï¸ Scavenger Hunt</button>
                <button class="tab super-admin-only" onclick="openSpeedSlideAdmin()" id="speedSlideAdminTab">ðŸ§© Speed Slide Admin</button>
                <button class="tab super-admin-only" onclick="showTab('dbInspector')" id="dbInspectorTab">ðŸ” DB Inspector</button>
                <button class="tab super-admin-only" onclick="showTab('cloudinaryInspector')" id="cloudinaryInspectorTab">â˜ï¸ Cloudinary</button>
                <button class="tab super-admin-only" onclick="showTab('firebaseDownloadMonitor')" id="firebaseDownloadMonitorTab">ðŸ”¥ Download Monitor</button>
                <button class="tab super-admin-only" onclick="showTab('managerPermissionsPanel')" id="managerPermissionsPanelTab">ðŸ‘” Manager Permissions</button>
            </div>

            <div class="content" id="adminContentBox">
                <!-- Master List Tab -->
                <div id="master" class="form-section active">
                    <h2 style="color:#c44569;margin-bottom:20px">Master Enrollment List</h2>
                    <div class="filter-section">
                        <select id="filterClass" onchange="updateMaster()">
                            <option value="">All Classes</option>
                        </select>
                        <select id="filterEvent" onchange="updateMaster()">
                            <option value="">All Events</option>
                        </select>
                        <button class="btn btn-small" onclick="clearFilters()">Clear Filters</button>
                        <button class="btn btn-small btn-success" onclick="downloadMaster()">ðŸ“¥ Download CSV</button>
                    </div>
                    <div id="summaryInfo" style="background:#e3f2fd;padding:15px;border-radius:8px;margin-bottom:20px"></div>
                    <div id="masterContainer"></div>
                </div>

                <!-- Events Tab -->
                <div id="events" class="form-section">
                    <h2 style="color:#c44569;margin-bottom:20px">Enrollments by Events</h2>
                    <button class="btn btn-small btn-success" onclick="downloadEvents()" style="margin-bottom:20px">ðŸ“¥ Download CSV</button>
                    <div id="eventsContainer"></div>
                </div>

                <!-- Jury Setup Tab (Super Admin Only) -->
                <div id="jurySetup" class="form-section super-admin-only">
                    <h2 style="color:#c44569;margin-bottom:20px">Jury Setup & Criteria Management</h2>
                    
                    <div class="form-group">
                        <label>Select Event:</label>
                        <select id="setupEventSelect" onchange="loadEventSetup()">
                            <option value="">-- Select Event --</option>
                        </select>
                    </div>

                    <!-- Eligibility Info Banner (auto-filled on event select) -->
                    <div id="eventEligibilityBanner" style="display:none;margin-bottom:15px;padding:12px 16px;border-radius:8px;border-left:5px solid #6a1b9a;background:#f3e5f5">
                        <strong style="color:#6a1b9a">ðŸŽ¯ Enrollment Criteria for this event:</strong>
                        <span id="eventEligibilityText" style="color:#333;margin-left:8px"></span>
                    </div>
                    
                    <div id="eventSetupContainer" style="display:none">

                        <!-- Event Type -->
                        <div style="background:#e8f5e9;border-radius:10px;padding:15px;margin-bottom:20px;border:2px solid #a5d6a7">
                            <h3 style="color:#1b5e20;margin-bottom:10px">âš™ï¸ Event Type</h3>
                            <p style="color:#555;font-size:13px;margin-bottom:12px">Choose how jury scores are aggregated for the leaderboard.</p>
                            <div style="display:flex;gap:20px;flex-wrap:wrap">
                                <label style="display:flex;align-items:center;gap:8px;cursor:pointer;font-weight:600;color:#1b5e20">
                                    <input type="radio" name="juryEventType" id="eventTypeClass" value="class" checked style="width:18px;height:18px">
                                    ðŸ« Class-based â€” One team per class, jury scores the class
                                </label>
                                <label style="display:flex;align-items:center;gap:8px;cursor:pointer;font-weight:600;color:#6a1b9a">
                                    <input type="radio" name="juryEventType" id="eventTypeIndividual" value="individual" style="width:18px;height:18px">
                                    ðŸ§‘ Individual â€” Multiple students per class; jury scores each student; class gets points from their best performer
                                </label>
                                <label style="display:flex;align-items:center;gap:8px;cursor:pointer;font-weight:600;color:#e65100">
                                    <input type="radio" name="juryEventType" id="eventTypeMultiteam" value="multiteam" style="width:18px;height:18px">
                                    ðŸ‘¥ Multi-Team â€” Multiple teams per class (e.g. Vlog: 3 teams Ã— 3 members); jury scores each team; class gets points from their best team
                                </label>
                            </div>
                        </div>
                        <div class="jury-password-section">
                            <h3 style="color:#6a1b9a;margin-bottom:15px">ðŸ‘¥ Jury Details</h3>
                            
                            <div style="background:#f0f0f0;padding:15px;border-radius:8px;margin-bottom:15px">
                                <h4 style="color:#6a1b9a;margin-bottom:10px">Jury 1</h4>
                                <div class="form-group">
                                    <label>Jury 1 Name:</label>
                                    <input type="text" id="jury1Name" placeholder="e.g., Dr. Smith, Prof. John">
                                </div>
                                <div class="form-group">
                                    <label>Jury 1 Password:</label>
                                    <input type="text" id="jury1Password" placeholder="Set password for Jury 1">
                                </div>
                            </div>
                            
                            <div style="background:#f0f0f0;padding:15px;border-radius:8px;margin-bottom:15px">
                                <h4 style="color:#6a1b9a;margin-bottom:10px">Jury 2</h4>
                                <div class="form-group">
                                    <label>Jury 2 Name:</label>
                                    <input type="text" id="jury2Name" placeholder="e.g., Dr. Jane, Prof. Mary">
                                </div>
                                <div class="form-group">
                                    <label>Jury 2 Password:</label>
                                    <input type="text" id="jury2Password" placeholder="Set password for Jury 2">
                                </div>
                            </div>
                        </div>
                        
                        <h3 style="color:#6a1b9a;margin:20px 0 15px">ðŸŽ­ Class Code Names (shown to jury instead of real names)</h3>
                        <p style="color:#666;font-size:13px;margin-bottom:12px">Assign anonymous code names to each participating class. Jury will only see these names â€” real class names are revealed after they mark as completed.</p>
                        <div id="classAliasContainer" style="background:#f9f0ff;border-radius:10px;padding:15px;margin-bottom:15px">
                            <p style="color:#999;font-size:13px">Save jury passwords and select event to load enrolled classes here.</p>
                        </div>
                        <button class="btn btn-small btn-info" onclick="loadClassAliasFields()" style="margin-bottom:15px">ðŸ”„ Load Enrolled Classes</button>

                        <h3 style="color:#6a1b9a;margin:20px 0 15px">ðŸ“‹ Evaluation Criteria (5 criteria, 10 marks each)</h3>
                        <div id="criteriaContainer"></div>
                        <button class="btn btn-small btn-info" onclick="addCriterion()" style="margin-top:10px">+ Add Criterion</button>
                        
                        <div style="margin-top:30px">
                            <button class="btn btn-success" onclick="saveEventSetup()">Save Setup</button>
                        </div>
                        
                        <div id="setupMessage" class="message" style="margin-top:20px"></div>
                    </div>
                </div>

                <!-- Live Jury Monitor Tab (Super Admin Only) -->
                <div id="juryLiveMonitor" class="form-section super-admin-only">
                    <h2 style="color:#c44569;margin-bottom:20px">ðŸ“¡ Live Jury Marks Monitor</h2>
                    <div class="form-group">
                        <label>Select Event:</label>
                        <div style="display:flex;gap:10px;align-items:center">
                            <select id="liveMonitorEvent" onchange="startLiveJuryMonitor()" style="flex:1">
                                <option value="">-- Select Event --</option>
                            </select>
                            <button class="btn btn-small btn-info" onclick="startLiveJuryMonitor()">ðŸ”„ Refresh</button>
                        </div>
                    </div>
                    <div id="liveJuryMonitorContainer" style="margin-top:20px">
                        <p style="color:#999;text-align:center;padding:30px">Select an event to see live jury marks.</p>
                    </div>
                </div>

                <!-- Results Tab -->
                <div id="results" class="form-section">
                    <h2 style="color:#c44569;margin-bottom:20px">Event Results</h2>
                    
                    <div class="form-group">
                        <label>Select Event:</label>
                        <div style="display:flex;gap:10px;">
                            <select id="resultsEventSelect" onchange="loadEventResults()" style="flex:1">
                                <option value="">-- Select Event --</option>
                            </select>
                            <button class="btn btn-small" onclick="loadEventResults()" style="white-space:nowrap">ðŸ”„ Refresh</button>
                        </div>
                    </div>
                    
                    <!-- Super Admin Only: Publish/Unpublish Results -->
                    <div class="super-admin-only" style="margin:20px 0;padding:15px;background:#fff3cd;border-radius:8px;border:2px solid #ffc107">
                        <h3 style="color:#6a1b9a;margin-bottom:10px">ðŸ“¢ Results Management</h3>
                        <p style="color:#666;margin-bottom:15px;font-size:14px">Publish or unpublish results for the selected event.</p>
                        <div style="display:flex;gap:10px;flex-wrap:wrap">
                            <button class="btn btn-danger" onclick="publishResults()">âœ… Publish Results to Admins</button>
                            <button class="btn btn-secondary" onclick="unpublishResults()">âŒ Unpublish Results</button>
                        </div>
                    </div>
                    
                    <div id="resultsContainer"></div>
                </div>
                
                <!-- Quiz Management Tab -->
                <div id="quizManagement" class="form-section">
                    <h2 style="color:#c44569;margin-bottom:25px">ðŸ“ Daily Quiz Competition Management</h2>
                    
                    <div class="stats-grid" style="margin-bottom:30px">
                        <div class="stat-card">
                            <div class="stat-number" id="quizTotalStudents">0</div>
                            <div class="stat-label">Total Quiz Students</div>
                        </div>
                        <div class="stat-card" style="background:linear-gradient(135deg,#28a745 0%,#20c997 100%)">
                            <div class="stat-number" id="quizTodayParticipants">0</div>
                            <div class="stat-label">Today's Participants</div>
                        </div>
                        <div class="stat-card" style="background:linear-gradient(135deg,#ffc107 0%,#ff9800 100%)">
                            <div class="stat-number" id="quizQuestionsCount">0</div>
                            <div class="stat-label">Questions Today</div>
                        </div>
                    </div>
                    
                    <div id="quizAdminMessage" class="message"></div>
                    
                    <div class="tabs" style="margin-bottom:25px">
                        <button class="tab active" onclick="showQuizManagementTab('questions', event)">ðŸ“ Questions</button>
                        <button class="tab" onclick="showQuizManagementTab('allquizzes', event)">ðŸ“š All Quizzes</button>
                        <button class="tab" onclick="showQuizManagementTab('students', event)">ðŸ‘¥ Students</button>
                        <button class="tab" onclick="showQuizManagementTab('submissions', event)">ðŸ“Š Submissions</button>
                        <button class="tab" onclick="showQuizManagementTab('winners', event)">ðŸ† Winners</button>
                        <button class="tab super-admin-only" onclick="showQuizManagementTab('editdates', event)" id="editDatesTab">ðŸ“… Edit Quiz Dates</button>
                    </div>
                    
                    <!-- Questions Sub-Tab -->
                    <div id="quizQuestionsContent" class="form-section active">
                        <!-- Date Selector moved here for easier access -->
                        <div style="background:#fff3cd;padding:18px 20px;border-radius:10px;margin-bottom:22px;border-left:5px solid #ffc107;display:flex;align-items:center;gap:16px;flex-wrap:wrap">
                            <label for="quizDateSelector" style="font-size:1em;color:#856404;font-weight:700;margin:0;white-space:nowrap">ðŸ“… Select Date for Quiz:</label>
                            <input type="date" id="quizDateSelector" style="border:2px solid #ffc107;border-radius:8px;padding:8px 12px;font-size:1em;color:#333;background:white;flex-shrink:0" required onchange="loadQuizForSelectedDate()">
                            <p style="color:#856404;font-size:13px;margin:0;flex:1;min-width:200px"><strong>Note:</strong> Select a date to create/edit quiz questions. Students will see this quiz automatically on the selected date.</p>
                        </div>
                        <h3 style="color:#6a1b9a;margin-bottom:20px" id="quizQuestionsHeading">Create Quiz (2 Questions)</h3>
                        
                        
                        <div style="background:#f8f9fa;padding:20px;border-radius:10px;margin-bottom:30px">
                            <h4 style="color:#667eea;margin-bottom:15px">Question 1</h4>
                            
                            <div class="form-group">
                                <label>Question Text:</label>
                                <textarea id="quiz_q1Text" rows="3" placeholder="Enter question 1"></textarea>
                            </div>
                            
                            <!-- Image Upload -->
                            <div class="form-group">
                                <label>ðŸ“· Add Image (Optional):</label>
                                <input type="file" id="quiz_q1Image" accept="image/*" onchange="previewQuestionImage(this, 'quiz_q1ImagePreview')">
                                <div id="quiz_q1ImagePreview" style="margin-top:10px"></div>
                                <small style="color:#666">Upload an image to show with the question</small>
                            </div>
                            
                            <!-- Audio Upload -->
                            <div class="form-group">
                                <label>ðŸŽµ Add Audio (Optional):</label>
                                <input type="file" id="quiz_q1Audio" accept="audio/*" onchange="previewQuestionAudio(this, 'quiz_q1AudioPreview')">
                                <div id="quiz_q1AudioPreview" style="margin-top:10px"></div>
                                <small style="color:#666">Upload audio/music to play with the question</small>
                            </div>
                            
                            <div class="form-group">
                                <label>Option A:</label>
                                <input type="text" id="quiz_q1OptA" placeholder="Option A">
                            </div>
                            <div class="form-group">
                                <label>Option B:</label>
                                <input type="text" id="quiz_q1OptB" placeholder="Option B">
                            </div>
                            <div class="form-group">
                                <label>Option C:</label>
                                <input type="text" id="quiz_q1OptC" placeholder="Option C">
                            </div>
                            <div class="form-group">
                                <label>Option D:</label>
                                <input type="text" id="quiz_q1OptD" placeholder="Option D">
                            </div>
                            <div class="form-group">
                                <label>Correct Answer:</label>
                                <select id="quiz_q1Correct">
                                    <option value="">-- Select --</option>
                                    <option value="A">A</option>
                                    <option value="B">B</option>
                                    <option value="C">C</option>
                                    <option value="D">D</option>
                                </select>
                            </div>
                        </div>
                        
                        <div style="background:#f8f9fa;padding:20px;border-radius:10px;margin-bottom:30px">
                            <h4 style="color:#667eea;margin-bottom:15px">Question 2</h4>
                            
                            <div class="form-group">
                                <label>Question Text:</label>
                                <textarea id="quiz_q2Text" rows="3" placeholder="Enter question 2"></textarea>
                            </div>
                            
                            <!-- Image Upload -->
                            <div class="form-group">
                                <label>ðŸ“· Add Image (Optional):</label>
                                <input type="file" id="quiz_q2Image" accept="image/*" onchange="previewQuestionImage(this, 'quiz_q2ImagePreview')">
                                <div id="quiz_q2ImagePreview" style="margin-top:10px"></div>
                                <small style="color:#666">Upload an image to show with the question</small>
                            </div>
                            
                            <!-- Audio Upload -->
                            <div class="form-group">
                                <label>ðŸŽµ Add Audio (Optional):</label>
                                <input type="file" id="quiz_q2Audio" accept="audio/*" onchange="previewQuestionAudio(this, 'quiz_q2AudioPreview')">
                                <div id="quiz_q2AudioPreview" style="margin-top:10px"></div>
                                <small style="color:#666">Upload audio/music to play with the question</small>
                            </div>
                            
                            <div class="form-group">
                                <label>Option A:</label>
                                <input type="text" id="quiz_q2OptA" placeholder="Option A">
                            </div>
                            <div class="form-group">
                                <label>Option B:</label>
                                <input type="text" id="quiz_q2OptB" placeholder="Option B">
                            </div>
                            <div class="form-group">
                                <label>Option C:</label>
                                <input type="text" id="quiz_q2OptC" placeholder="Option C">
                            </div>
                            <div class="form-group">
                                <label>Option D:</label>
                                <input type="text" id="quiz_q2OptD" placeholder="Option D">
                            </div>
                            <div class="form-group">
                                <label>Correct Answer:</label>
                                <select id="quiz_q2Correct">
                                    <option value="">-- Select --</option>
                                    <option value="A">A</option>
                                    <option value="B">B</option>
                                    <option value="C">C</option>
                                    <option value="D">D</option>
                                </select>
                            </div>
                        </div>
                        
                        <button class="btn btn-success" onclick="saveQuizQuestionsFromAdmin()" style="font-size:1.1em">ðŸ’¾ Save Questions</button>
                        <button class="btn btn-info btn-small" onclick="viewTodayQuestionsAdmin()" style="margin-left:10px">ðŸ‘ï¸ View Today's Questions</button>
                        
                        <!-- Publish/Unpublish Section for Admin Dashboard -->
                        <div id="publishControlSectionAdmin" style="display:none;margin-top:30px;background:#fff3cd;padding:25px;border-radius:12px;border-left:5px solid #ffc107">
                            <h3 style="color:#6a1b9a;margin-bottom:15px">ðŸ“¢ Quiz Publication Control</h3>
                            <div id="publishStatusDisplayAdmin" style="margin-bottom:20px"></div>
                            <div style="display:flex;gap:10px;flex-wrap:wrap">
                                <button class="btn btn-success" onclick="publishTodayQuiz()" id="btnPublishAdmin" style="display:none">âœ… PUBLISH Quiz (Make Live)</button>
                                <button class="btn btn-danger" onclick="unpublishTodayQuiz()" id="btnUnpublishAdmin" style="display:none">âŒ UNPUBLISH Quiz (Hide)</button>
                            </div>
                        </div>
                        
                        <div id="todayQuestionsViewAdmin" style="display:none;margin-top:30px"></div>
                    </div>
                    
                    <!-- All Quizzes Sub-Tab -->
                    <div id="quizAllQuizzesContent" class="form-section">
                        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px">
                            <h3 style="color:#6a1b9a;margin:0">ðŸ“š All Quiz Questions (Sorted by Date)</h3>
                            <button class="btn btn-info btn-small" onclick="loadAllQuizzes()">ðŸ”„ Refresh List</button>
                        </div>
                        <div id="allQuizzesContainer"></div>
                    </div>
                    
                    <!-- Students Sub-Tab -->
                    <div id="quizStudentsContent" class="form-section">
                        <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:10px;margin-bottom:14px">
                            <h3 style="color:#6a1b9a;margin:0">Registered Quiz Students</h3>
                            <button class="btn btn-info btn-small" onclick="loadQuizStudentsAdmin()">ðŸ”„ Refresh Students</button>
                        </div>
                        <!-- Filter Bar -->
                        <div style="background:#f3e5f5;border-radius:12px;padding:14px 18px;margin-bottom:12px;display:flex;flex-wrap:wrap;gap:10px;align-items:center;border:2px solid #e0c8f5">
                            <input id="qsAdminSearch" type="text" placeholder="ðŸ” Search by name / phone / emailâ€¦" oninput="qsAdminApplyFilters()" style="flex:1;min-width:180px;padding:8px 12px;border:2px solid #9c27b0;border-radius:8px;font-size:0.9em;color:#3d0060;outline:none">
                            <select id="qsAdminClassFilter" onchange="qsAdminApplyFilters()" style="padding:8px 12px;border:2px solid #9c27b0;border-radius:8px;color:#3d0060;font-weight:600;background:white;outline:none">
                                <option value="">â€” All Classes â€”</option>
                            </select>
                            <button onclick="qsAdminResetFilters()" style="padding:8px 14px;background:#9c27b0;color:white;border:none;border-radius:8px;font-weight:700;cursor:pointer;font-size:0.85em">âœ– Reset</button>
                            <button onclick="qsAdminShowDuplicates()" style="padding:8px 14px;background:linear-gradient(135deg,#e65100,#f44336);color:white;border:none;border-radius:8px;font-weight:700;cursor:pointer;font-size:0.85em">âš ï¸ Duplicates</button>
                            <button onclick="qsAdminShowEmailFailed()" style="padding:8px 14px;background:linear-gradient(135deg,#1565c0,#0288d1);color:white;border:none;border-radius:8px;font-weight:700;cursor:pointer;font-size:0.85em">ðŸ“§ Email Failed</button>
                            <button onclick="qsAdminShowSummary()" style="padding:8px 14px;background:linear-gradient(135deg,#6a1b9a,#c44569);color:white;border:none;border-radius:8px;font-weight:700;cursor:pointer;font-size:0.85em">ðŸ“Š Summary</button>
                            <span id="qsAdminCount" style="color:#6a1b9a;font-weight:700;font-size:0.9em"></span>
                        </div>

                        <!-- Summary Report Box -->
                        <div id="qsAdminSummaryBox" style="display:none;background:white;border:2px solid #6a1b9a;border-radius:14px;margin-bottom:16px;overflow:hidden">
                            <div style="background:linear-gradient(135deg,#6a1b9a,#c44569);padding:14px 20px;display:flex;justify-content:space-between;align-items:center">
                                <h4 style="color:white;margin:0;font-size:1em">ðŸ“Š Class-wise Registration Summary (vs Class Strength)</h4>
                                <button onclick="document.getElementById('qsAdminSummaryBox').style.display='none'" style="background:rgba(255,255,255,0.2);color:white;border:none;border-radius:6px;padding:4px 10px;cursor:pointer;font-size:12px;font-weight:700">âœ• Close</button>
                            </div>
                            <div id="qsAdminSummaryContent" style="padding:16px 20px">
                                <p style="color:#999;text-align:center">Click ðŸ“Š Summary Report to generate</p>
                            </div>
                            <!-- Copy-ready message box -->
                            <div id="qsAdminMsgBox" style="display:none;margin:0 16px 16px;background:#f3e5f5;border-radius:10px;border:2px solid #9c27b0;padding:14px">
                                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
                                    <span style="color:#6a1b9a;font-weight:700;font-size:0.9em">ðŸ“‹ WhatsApp / Message Ready Text:</span>
                                    <button onclick="qsAdminCopyMsg()" style="background:#25d366;color:white;border:none;border-radius:6px;padding:5px 14px;cursor:pointer;font-size:12px;font-weight:700">ðŸ“‹ Copy</button>
                                </div>
                                <textarea id="qsAdminMsgText" rows="10" readonly style="width:100%;padding:10px;border:1.5px solid #9c27b0;border-radius:8px;font-size:13px;font-family:monospace;box-sizing:border-box;background:white;resize:vertical;color:#333"></textarea>
                            </div>
                        </div>

                        <div class="table-wrapper">
                            <table>
                                <thead>
                                    <tr>
                                        <th>#</th>
                                        <th>Name</th>
                                        <th>Email</th>
                                        <th>Phone</th>
                                        <th>Password</th>
                                        <th>Class</th>
                                        <th>Registered</th>
                                        <th>Email Status</th>
                                    </tr>
                                </thead>
                                <tbody id="quizStudentsTableAdmin"></tbody>
                            </table>
                        </div>
                    </div>
                    
                    <!-- Submissions Sub-Tab -->
                    <div id="quizSubmissionsContent" class="form-section">

                        <!-- â”€â”€ DATE SELECTOR + CLASS BREAKDOWN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
                        <div style="background:linear-gradient(135deg,#f3e5ff,#fce4ec);border-radius:14px;padding:20px 22px;margin-bottom:20px;border:2px solid #e0c8f5">
                            <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:12px;margin-bottom:16px">
                                <h3 style="color:#3d0060;margin:0;font-size:1.05em">ðŸ“… Class-wise Participation by Date</h3>
                                <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
                                    <select id="qsDateFilter" onchange="loadClassStats()" style="padding:7px 12px;border:2px solid #6a1b9a;border-radius:8px;color:#3d0060;font-weight:600;background:white;outline:none">
                                        <option value="">â€” Select Date â€”</option>
                                    </select>
                                    <button class="btn btn-small btn-info" onclick="loadClassStats()">ðŸ”„ Refresh</button>
                                </div>
                            </div>

                            <!-- Summary pills -->
                            <div id="qsSummaryPills" style="display:flex;gap:10px;flex-wrap:wrap;margin-bottom:14px">
                                <span style="background:rgba(106,27,154,0.12);color:#4a148c;padding:5px 14px;border-radius:20px;font-size:12.5px;font-weight:600" id="qsPillTotal">Total: â€”</span>
                                <span style="background:rgba(40,167,69,0.12);color:#155724;padding:5px 14px;border-radius:20px;font-size:12.5px;font-weight:600" id="qsPillCorrect">Both Correct: â€”</span>
                                <span style="background:rgba(196,69,105,0.12);color:#7b1040;padding:5px 14px;border-radius:20px;font-size:12.5px;font-weight:600" id="qsPillClasses">Classes Participated: â€”</span>
                            </div>

                            <!-- Class breakdown table -->
                            <div id="qsClassBreakdown">
                                <p style="color:#999;font-size:13px;text-align:center;padding:12px">Select a date above to see class-wise breakdown</p>
                            </div>
                        </div>

                        <!-- â”€â”€ QUIZ INFO NOTICE BOX â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
                        <div id="qsInfoBox" style="background:#fffde7;border-radius:10px;padding:16px 20px;margin-bottom:18px;border-left:4px solid #ffc107;display:none">
                            <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:10px">
                                <div style="flex:1">
                                    <h4 style="color:#856404;margin:0 0 6px;font-size:0.95em">ðŸ“‹ Quiz Summary â€” <span id="qsInfoDate"></span></h4>
                                    <div id="qsInfoText" style="color:#555;font-size:13px;line-height:1.7"></div>
                                </div>
                                <button onclick="copyQsInfo()" style="background:#ffc107;color:#1a0030;border:none;padding:5px 12px;border-radius:6px;cursor:pointer;font-size:12px;font-weight:700;white-space:nowrap">ðŸ“‹ Copy</button>
                            </div>
                        </div>

                        <!-- â”€â”€ TODAY'S FULL SUBMISSIONS TABLE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
                        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:14px;flex-wrap:wrap;gap:8px">
                            <h3 style="color:#6a1b9a;margin:0">Today's Quiz Submissions</h3>
                            <div style="display:flex;gap:8px;align-items:center">
                                <select id="qsClassFilter" onchange="filterSubmissionsTable()" style="padding:6px 10px;border:1px solid #6a1b9a;border-radius:6px;font-size:13px;outline:none">
                                    <option value="">All Classes</option>
                                </select>
                                <select id="qsScoreFilter" onchange="filterSubmissionsTable()" style="padding:6px 10px;border:1px solid #6a1b9a;border-radius:6px;font-size:13px;outline:none">
                                    <option value="">All Scores</option>
                                    <option value="2">Both Correct (2/2)</option>
                                    <option value="1">One Correct (1/2)</option>
                                    <option value="0">None Correct (0/2)</option>
                                </select>
                                <button class="btn btn-info btn-small" onclick="loadQuizSubmissionsAdmin()">ðŸ”„ Refresh</button>
                            </div>
                        </div>
                        <div class="table-wrapper">
                            <table>
                                <thead>
                                    <tr>
                                        <th>#</th>
                                        <th>Name</th>
                                        <th>Email</th>
                                        <th>Class</th>
                                        <th>Submitted</th>
                                        <th>Score</th>
                                        <th>Time</th>
                                    </tr>
                                </thead>
                                <tbody id="quizSubmissionsTableAdmin"></tbody>
                            </table>
                        </div>
                    </div>
                    
                    <!-- Winners Sub-Tab -->
                    <div id="quizWinnersContent" class="form-section">
                        <h3 style="color:#6a1b9a;margin-bottom:20px">ðŸ† Declare Today's Winners</h3>

                        <!-- â”€â”€ AUTO-DECLARATION PANEL â”€â”€ -->
                        <div style="background:linear-gradient(135deg,#1a0030 0%,#3d0060 100%);border-radius:14px;padding:20px 22px;margin-bottom:22px;border:2px solid rgba(255,215,0,0.3)">
                            <div style="display:flex;align-items:center;gap:12px;margin-bottom:14px;flex-wrap:wrap">
                                <span style="font-size:1.7em">â°</span>
                                <div style="flex:1">
                                    <h4 style="color:#ffd700;margin:0;font-size:1em">Auto-Declaration</h4>
                                    <p style="color:rgba(255,255,255,0.65);font-size:12px;margin:3px 0 0">Winners auto-selected at your chosen time daily.</p>
                                </div>
                                <!-- Time picker -->
                                <input type="time" id="autoDeclarTime" value="23:30" onchange="saveAutoDeclarSetting()"
                                    style="padding:6px 10px;border-radius:8px;border:2px solid #ffd700;background:#2a0050;color:#ffd700;font-size:14px;font-weight:700;cursor:pointer">
                                <label style="display:flex;align-items:center;gap:8px;cursor:pointer;margin:0">
                                    <div style="position:relative;width:48px;height:26px">
                                        <input type="checkbox" id="autoDeclarToggle" onchange="saveAutoDeclarSetting()" style="opacity:0;width:0;height:0;position:absolute">
                                        <span id="autoDeclarSlider" style="position:absolute;inset:0;background:#555;border-radius:26px;transition:0.3s;cursor:pointer"></span>
                                        <span id="autoDeclarThumb" style="position:absolute;left:3px;top:3px;width:20px;height:20px;background:white;border-radius:50%;transition:0.3s;pointer-events:none"></span>
                                    </div>
                                    <span id="autoDeclarLabel" style="color:#ffd700;font-weight:700;font-size:13px;white-space:nowrap">OFF</span>
                                </label>
                            </div>
                            <div id="autoDeclarWarning" style="background:rgba(255,150,0,0.15);border-radius:8px;padding:10px 14px;font-size:12px;color:#ffd700;margin-bottom:8px">
                                âš ï¸ <strong>Important:</strong> Auto-declaration only runs if this page is <strong>open in a browser at the set time</strong>. If the page is closed, use <strong>Run Now</strong> after the time passes.
                            </div>
                            <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px">
                                <button onclick="runAutoDeclaration()" style="background:#ffd700;color:#1a0030;border:none;padding:6px 16px;border-radius:8px;cursor:pointer;font-size:12px;font-weight:700">â–¶ï¸ Run Now (Manual Trigger)</button>
                                <button onclick="checkMissedAutoDeclar()" style="background:rgba(255,255,255,0.15);color:white;border:none;padding:6px 16px;border-radius:8px;cursor:pointer;font-size:12px;font-weight:600">ðŸ” Check Missed</button>
                            </div>
                            <div id="autoDeclarStatus" style="background:rgba(255,255,255,0.07);border-radius:8px;padding:10px 14px;font-size:12.5px;color:rgba(255,255,255,0.75)">
                                ðŸ”´ Auto-declaration is <strong style="color:#ff6b6b">disabled</strong>. Toggle ON to enable.
                            </div>
                            <div id="autoDeclarCountdown" style="display:none;margin-top:10px;background:rgba(255,215,0,0.1);border-radius:8px;padding:10px 14px;font-size:13px;color:#ffd700;font-weight:600;text-align:center"></div>
                        </div>

                        <!-- â”€â”€ HOW IT WORKS â”€â”€ -->\
                        <div style="background:#fff3cd;padding:15px 20px;border-radius:10px;margin-bottom:22px">
                            <p style="margin:0;color:#856404"><strong>â„¹ï¸ How it works:</strong> System randomly selects winner &amp; runner-up from students who got BOTH questions correct.</p>
                        </div>
                        
                        <!-- â”€â”€ DATE SELECTOR FOR STATS â”€â”€ -->
                        <div style="background:#e3f2fd;padding:14px 18px;border-radius:10px;margin-bottom:16px;display:flex;align-items:center;gap:14px;flex-wrap:wrap">
                            <label style="font-weight:700;color:#1565c0;white-space:nowrap">ðŸ“… View Stats for Date:</label>
                            <input type="date" id="winnersDateSelector" style="border:2px solid #1565c0;border-radius:8px;padding:7px 12px;font-size:1em;color:#333;background:white" onchange="loadQuizResultsAdmin()" />
                            <button onclick="loadQuizResultsAdmin()" style="background:#1565c0;color:white;border:none;padding:8px 18px;border-radius:8px;font-weight:700;cursor:pointer;font-size:0.95em">ðŸ”„ Load</button>
                        </div>
                        
                        <div style="background:#f8f9fa;padding:20px;border-radius:10px;margin:0 0 20px">
                            <h4 style="margin-bottom:15px">ðŸ“Š Statistics</h4>
                            <p><strong>Total:</strong> <span id="resultTotalPartAdmin">0</span></p>
                            <p><strong>Both Correct:</strong> <span id="resultBothCorrectAdmin">0</span></p>
                            <p><strong>Eligible:</strong> <span id="resultEligibleAdmin">0</span></p>
                        </div>
                        
                        <!-- Eligible Students List -->
                        <div id="eligibleStudentsListAdmin"></div>

                        <!-- Winner display for selected date -->
                        <div id="winnersDisplayAdmin" style="display:none;margin-top:25px"></div>

                        <!-- â”€â”€ ACTION BUTTONS â”€â”€ -->
                        <div style="display:flex;gap:12px;flex-wrap:wrap;margin-top:20px;margin-bottom:10px">
                            <button class="btn btn-warning" onclick="selectQuizWinnersFromAdmin()" style="font-size:1em;padding:14px 22px">ðŸŽ² Select Winners (Random)</button>
                            <button class="btn btn-info" onclick="toggleManualWinnerUI()" style="font-size:1em;padding:14px 22px" id="manualSelectToggleBtn">âœ‹ Manual Select</button>
                        </div>

                        <!-- â”€â”€ MANUAL SELECTION PANEL â”€â”€ -->
                        <div id="manualWinnerPanel" style="display:none;background:#f0f4ff;border:2px solid #667eea;border-radius:12px;padding:22px;margin-top:10px">
                            <h4 style="color:#667eea;margin-bottom:16px">âœ‹ Manual Winner Selection</h4>
                            <p style="color:#555;font-size:13px;margin-bottom:18px">Choose winner and runner-up from eligible students (both questions correct).</p>
                            <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:18px">
                                <div class="form-group" style="margin:0">
                                    <label style="color:#667eea;font-weight:700">ðŸ† Winner</label>
                                    <select id="manualWinnerSelect" style="border:2px solid #ffd700;border-radius:8px;padding:10px;margin-top:6px">
                                        <option value="">-- Select Winner --</option>
                                    </select>
                                </div>
                                <div class="form-group" style="margin:0">
                                    <label style="color:#667eea;font-weight:700">ðŸ¥ˆ Runner-Up</label>
                                    <select id="manualRunnerSelect" style="border:2px solid #aaa;border-radius:8px;padding:10px;margin-top:6px">
                                        <option value="">-- Select Runner-Up --</option>
                                    </select>
                                </div>
                            </div>
                            <div style="display:flex;gap:10px;flex-wrap:wrap">
                                <button class="btn btn-success" onclick="declareManualWinners()" style="padding:12px 24px">âœ… Declare These Winners</button>
                                <button class="btn btn-secondary" onclick="toggleManualWinnerUI()" style="padding:12px 20px">âœ– Cancel</button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Edit Quiz Dates Sub-Tab (Super Admin Only) -->
                    <div id="quizEditDatesContent" class="form-section super-admin-only">
                        <h3 style="color:#6a1b9a;margin-bottom:20px">ðŸ“… Edit Quiz Dates</h3>
                        <p style="color:#666;margin-bottom:20px">Select a quiz and change its date. This will move the quiz to a different day.</p>
                        
                        <div style="background:#fff3cd;padding:15px;border-radius:8px;border-left:5px solid #ffc107;margin-bottom:20px">
                            <p style="margin:0;color:#856404;font-weight:600">âš ï¸ Warning: Changing quiz dates will affect student access and published status.</p>
                        </div>
                        
                        <!-- Quiz Selection -->
                        <div id="quizDateList" style="margin-bottom:30px">
                            <h4 style="color:#c44569;margin-bottom:15px">Select Quiz to Edit:</h4>
                            <button class="btn btn-info btn-small" onclick="loadQuizzesForDateEdit()" style="margin-bottom:15px">ðŸ”„ Refresh Quiz List</button>
                            <div id="quizListForDateEdit"></div>
                        </div>
                        
                        <!-- Date Change Form -->
                        <div id="dateChangeForm" style="display:none">
                            <h4 style="color:#c44569;margin-bottom:15px">Change Quiz Date:</h4>
                            
                            <div style="background:#f9f9f9;padding:20px;border-radius:8px;margin-bottom:20px">
                                <p style="margin:0 0 10px 0;color:#333"><strong>Current Date:</strong> <span id="currentQuizDate" style="color:#c44569"></span></p>
                                <p style="margin:0;color:#666;font-size:0.9em" id="currentQuizPreview"></p>
                            </div>
                            
                            <div class="form-group">
                                <label for="newQuizDate">New Date *</label>
                                <input type="date" id="newQuizDate" required>
                            </div>
                            
                            <div class="form-group">
                                <label style="display:flex;align-items:center;cursor:pointer;">
                                    <input type="checkbox" id="autoPublishAfterMove" checked style="width:auto;margin-right:10px;">
                                    <span>Automatically publish quiz at new date</span>
                                </label>
                                <p style="color:#666;font-size:0.9em;margin-top:5px;">If checked, the quiz will be published and visible to students at the new date.</p>
                            </div>
                            
                            <div id="dateChangeMessage" class="message"></div>
                            
                            <div style="display:flex;gap:10px;margin-top:20px">
                                <button class="btn btn-warning" onclick="updateQuizDate()">ðŸ“… Change Date</button>
                                <button class="btn btn-secondary" onclick="cancelDateEdit()">âŒ Cancel</button>
                            </div>
                        </div>
                    </div>
                </div>
            <!-- ============================================ -->
            <!-- SCAVENGER HUNT ADMIN PANEL                  -->
            <!-- ============================================ -->
            <div id="scavengerAdmin" class="form-section super-admin-only">
                <h2 style="color:#9c27b0;margin-bottom:6px">ðŸ—ºï¸ Scavenger Hunt Management</h2>
                <p style="color:#666;margin-bottom:22px">Create tasks, verify photo submissions and declare winners.</p>

                <!-- Sub-tabs -->
                <div class="tabs" style="margin-bottom:20px">
                    <button class="tab active" onclick="shAdminTab('shAdminTasks', this)">ðŸ“‹ Tasks</button>
                    <button class="tab" onclick="shAdminTab('shAdminSubmissions', this)">ðŸ“¸ Submissions</button>
                    <button class="tab" onclick="shAdminTab('shAdminLeaderboard', this)">ðŸ† Leaderboard</button>
                    <button class="tab" onclick="shAdminTab('shAdminClasswise', this)">ðŸ“Š Class-wise</button>
                    <button class="tab" onclick="shAdminTab('shAdminWinners', this)">ðŸŽ–ï¸ Winners</button>
                    <button class="tab" onclick="shAdminTab('shAdminSettings', this)">âš™ï¸ Settings</button>
                </div>

                <!-- TASKS TAB -->
                <div id="shAdminTasks" class="sh-tab-panel" style="display:block">
                    <div style="background:#f3e5f5;padding:18px;border-radius:10px;margin-bottom:20px;border-left:5px solid #9c27b0">
                        <h4 style="color:#6a1b9a;margin-bottom:14px">âž• Create New Task</h4>
                        <div class="form-group">
                            <label>Task Name / Description:</label>
                            <input type="text" id="shNewTaskName" placeholder='e.g. "Find the school library"'>
                        </div>
                        <div class="form-group">
                            <label>Hint / Clue (optional):</label>
                            <input type="text" id="shNewTaskHint" placeholder='e.g. "Look near the main building ground floor"'>
                        </div>
                        <div class="form-group">
                            <label>ðŸ–¼ï¸ Task Image (optional â€” shown to students as a visual clue or reference):</label>
                            <input type="file" id="shNewTaskImageFile" accept="image/*" onchange="shPreviewNewTaskImage(this)" style="display:block;margin-bottom:8px">
                            <div id="shNewTaskImagePreview" style="display:none;margin-bottom:6px">
                                <img id="shNewTaskImagePreviewImg" style="max-width:220px;max-height:160px;border-radius:8px;border:2px solid #ce93d8;box-shadow:0 2px 8px rgba(0,0,0,0.12)" alt="preview">
                                <button type="button" onclick="shClearNewTaskImage()" style="display:block;margin-top:5px;background:#ffebee;color:#c62828;border:1px solid #ef9a9a;border-radius:6px;padding:3px 10px;cursor:pointer;font-size:0.82em">âœ• Remove</button>
                            </div>
                            <span id="shNewTaskImageMsg" style="font-size:0.82em;color:#888">Image will upload automatically when you save the task.</span>
                        </div>
                        <div class="form-group">
                            <label>ðŸ“¸ Task Parts (multi-photo, optional):</label>
                            <div id="shNewTaskPartsBox" style="display:flex;flex-direction:column;gap:6px;margin-bottom:6px"></div>
                            <button type="button" onclick="shAddNewTaskPart()" style="background:#e8f5e9;color:#2e7d32;border:2px dashed #4caf50;border-radius:8px;padding:6px 14px;cursor:pointer;font-size:0.88em;font-weight:700">âž• Add Part</button>
                            <span style="font-size:0.8em;color:#888;display:block;margin-top:4px">Each part = one photo. Student must get each part approved before the next unlocks. Leave empty for single-photo task.</span>
                        </div>
                        <div class="form-group">
                            <label>Task Order / Number:</label>
                            <input type="number" id="shNewTaskOrder" value="1" min="1" style="width:100px">
                        </div>
                        <div class="form-group">
                            <label>ðŸ“… Available From (Date & Time):</label>
                            <input type="datetime-local" id="shNewTaskDate" style="padding:8px 12px;border:2px solid #9c27b0;border-radius:8px;font-size:0.95em">
                            <span style="font-size:0.8em;color:#888;display:block;margin-top:4px">Leave blank = available immediately</span>
                        </div>
                        <div class="form-group">
                            <label>â° Available Until (Deadline):</label>
                            <input type="datetime-local" id="shNewTaskDeadline" style="padding:8px 12px;border:2px solid #e91e63;border-radius:8px;font-size:0.95em">
                            <span style="font-size:0.8em;color:#888;display:block;margin-top:4px">Leave blank = no deadline</span>
                        </div>

                        <div style="background:#e3f2fd;padding:14px;border-radius:8px;margin-bottom:14px;border-left:4px solid #2196f3">
                            <strong style="color:#1565c0">ðŸ“ GPS Target Location (for Auto-Verification)</strong><br>
                            <small style="color:#555">Click the button below or enter coordinates manually. Participants must be within 100m.</small>
                            <div style="display:flex;gap:10px;margin-top:10px;flex-wrap:wrap;align-items:center">
                                <input type="number" id="shNewTaskLat" placeholder="Latitude" step="0.000001" style="width:160px">
                                <input type="number" id="shNewTaskLng" placeholder="Longitude" step="0.000001" style="width:160px">
                                <button onclick="shAdminGetLocation()" class="btn btn-info btn-small">ðŸ“ Use My Location</button>
                            </div>
                            <div id="shAdminLocMsg" style="font-size:0.85em;color:#1565c0;margin-top:6px"></div>
                        </div>

                        <button class="btn" onclick="shAdminCreateTask()" style="background:linear-gradient(135deg,#9c27b0,#e91e63)">
                            âž• Add Task
                        </button>
                        <span id="shCreateTaskMsg" style="margin-left:12px;font-size:0.9em;color:#4caf50;display:none">âœ… Task created!</span>
                    </div>

                    <!-- â”€â”€ WhatsApp Share Box (always visible) â”€â”€ -->
                    <div id="shWaBox" style="display:block;background:linear-gradient(135deg,#e8f5e9,#f1f8e9);border:2px solid #25D366;border-radius:12px;padding:18px;margin-bottom:20px">
                        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:10px;flex-wrap:wrap;gap:8px">
                            <span style="color:#1b5e20;font-weight:700;font-size:1em">ðŸ“² WhatsApp Announcement Ready!</span>
                            <div style="display:flex;gap:8px">
                                <button class="btn btn-success btn-small" onclick="shCopyWaMsg()" id="shWaCopyBtn">ðŸ“‹ Copy Message</button>
                            </div>
                        </div>
                        <textarea id="shWaText" rows="8" readonly
                            style="width:100%;padding:12px;border:1px solid #a5d6a7;border-radius:8px;font-size:13px;line-height:1.7;background:white;color:#1a1a1a;resize:vertical;font-family:inherit;cursor:text"
                            onclick="this.select()">â³ Loading tasks...</textarea>
                    </div>

                    <h4 style="color:#6a1b9a;margin-bottom:12px">ðŸ“‹ All Tasks</h4>
                    <div id="shAdminTasksList">
                        <p style="color:#999">Loading tasks...</p>
                    </div>
                </div>

                <!-- SUBMISSIONS TAB -->
                <div id="shAdminSubmissions" class="sh-tab-panel" style="display:none">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;flex-wrap:wrap;gap:10px">
                        <h4 style="color:#6a1b9a;margin:0">ðŸ“¸ Photo Submissions <span style="background:#28a745;color:white;font-size:0.7em;padding:2px 8px;border-radius:20px;margin-left:6px">ðŸ”´ LIVE</span></h4>
                        <button class="btn btn-info btn-small" onclick="shAdminLoadSubmissions()">ðŸ”„ Refresh</button>
                    </div>
                    <div style="display:flex;gap:10px;margin-bottom:14px;flex-wrap:wrap;align-items:center">
                        <select id="shSubmissionFilter" onchange="shAdminLoadSubmissions()" style="padding:8px 14px;border-radius:8px;border:2px solid #9c27b0">
                            <option value="all">ðŸ“‹ All Status</option>
                            <option value="pending">â³ Pending</option>
                            <option value="approved">âœ… Approved</option>
                            <option value="rejected">âŒ Rejected</option>
                        </select>
                        <select id="shSubmissionDateFilter" onchange="shAdminLoadSubmissions()" style="padding:8px 14px;border-radius:8px;border:2px solid #9c27b0">
                            <option value="all">ðŸ“… All Dates</option>
                        </select>
                        <select id="shSubmissionTaskFilter" onchange="shAdminLoadSubmissions()" style="padding:8px 14px;border-radius:8px;border:2px solid #9c27b0">
                            <option value="all">ðŸ“Œ All Tasks</option>
                        </select>
                        <button class="btn btn-secondary btn-small" onclick="shResetSubmissionFilters()">âœ– Reset</button>
                    </div>
                    <div id="shAdminSubmissionsList">
                        <p style="color:#999">Click Refresh to load submissions.</p>
                    </div>
                </div>

                <!-- LEADERBOARD TAB -->
                <div id="shAdminLeaderboard" class="sh-tab-panel" style="display:none">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;flex-wrap:wrap;gap:10px">
                        <h4 style="color:#6a1b9a;margin:0">ðŸ† Live Leaderboard</h4>
                        <button class="btn btn-info btn-small" onclick="shAdminLoadLeaderboard()">ðŸ”„ Refresh</button>
                    </div>
                    <!-- Leaderboard Filters -->
                    <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-bottom:16px;background:#f3e5f5;padding:10px 14px;border-radius:10px;border:1px solid #ce93d8">
                        <span style="font-size:0.82em;font-weight:700;color:#6a1b9a;white-space:nowrap">ðŸ” Filter:</span>
                        <select id="shLbTaskFilter" onchange="shAdminRenderLeaderboard()" style="padding:6px 12px;border:2px solid #9c27b0;border-radius:8px;font-weight:600;color:#3d0060;font-size:0.85em">
                            <option value="all">ðŸ“Œ All Tasks</option>
                        </select>
                        <select id="shLbClassFilter" onchange="shAdminRenderLeaderboard()" style="padding:6px 12px;border:2px solid #9c27b0;border-radius:8px;font-weight:600;color:#3d0060;font-size:0.85em">
                            <option value="all">ðŸ« All Classes</option>
                        </select>
                        <button onclick="document.getElementById('shLbTaskFilter').value='all';document.getElementById('shLbClassFilter').value='all';shAdminRenderLeaderboard();" style="background:#6a1b9a;color:white;border:none;padding:6px 12px;border-radius:8px;cursor:pointer;font-size:0.82em;font-weight:600">âœ– Clear</button>
                    </div>
                    <div id="shAdminLeaderboardList">
                        <p style="color:#999">Click Refresh to load leaderboard.</p>
                    </div>
                </div>

                <!-- CLASS-WISE TAB -->
                <div id="shAdminClasswise" class="sh-tab-panel" style="display:none">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;flex-wrap:wrap;gap:10px">
                        <h4 style="color:#6a1b9a;margin:0">ðŸ“Š Class-wise Participation</h4>
                        <button class="btn btn-info btn-small" onclick="shAdminLoadClasswise()">ðŸ”„ Refresh</button>
                    </div>
                    <!-- Class-wise Summary Filters -->
                    <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-bottom:16px;background:#fffde7;padding:10px 14px;border-radius:10px;border:1px solid #ffc107">
                        <span style="font-size:0.82em;font-weight:700;color:#856404;white-space:nowrap">ðŸ” Filter Summary:</span>
                        <select id="shCwTaskFilter" onchange="shAdminApplyClasswiseFilters()" style="padding:6px 12px;border:2px solid #ffc107;border-radius:8px;font-weight:600;color:#3d0060;font-size:0.85em">
                            <option value="all">ðŸ“Œ All Tasks</option>
                        </select>
                        <select id="shCwDateFilter" onchange="shAdminApplyClasswiseFilters()" style="padding:6px 12px;border:2px solid #ffc107;border-radius:8px;font-weight:600;color:#3d0060;font-size:0.85em">
                            <option value="all">ðŸ“… All Dates</option>
                        </select>
                        <button onclick="document.getElementById('shCwTaskFilter').value='all';document.getElementById('shCwDateFilter').value='all';shAdminApplyClasswiseFilters();" style="background:#856404;color:white;border:none;padding:6px 12px;border-radius:8px;cursor:pointer;font-size:0.82em;font-weight:600">âœ– Clear</button>
                    </div>

                    <!-- SH Summary message box (copyable) -->
                    <div id="shCwSummaryBox" style="background:#fffde7;border-radius:10px;padding:16px 20px;margin-bottom:18px;border-left:4px solid #ffc107;display:none">
                        <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:10px">
                            <div style="flex:1">
                                <h4 style="color:#856404;margin:0 0 6px;font-size:0.95em">ðŸ—ºï¸ Scavenger Hunt Summary â€” <span id="shCwSummaryDate"></span></h4>
                                <div id="shCwSummaryText" style="color:#555;font-size:13px;line-height:1.7"></div>
                            </div>
                            <button onclick="shCopySummary()" style="background:#ffc107;color:#1a0030;border:none;padding:5px 12px;border-radius:6px;cursor:pointer;font-size:12px;font-weight:700;white-space:nowrap">ðŸ“‹ Copy</button>
                        </div>
                    </div>

                    <!-- Summary pills -->
                    <div style="display:flex;gap:10px;flex-wrap:wrap;margin-bottom:16px">
                        <span id="shCwPillTotal" style="background:#e8eaf6;color:#3949ab;padding:6px 16px;border-radius:20px;font-size:0.85em;font-weight:700">Total: â€”</span>
                        <span id="shCwPillApproved" style="background:#e8f5e9;color:#2e7d32;padding:6px 16px;border-radius:20px;font-size:0.85em;font-weight:700">Approved: â€”</span>
                        <span id="shCwPillPending" style="background:#fff3e0;color:#e65100;padding:6px 16px;border-radius:20px;font-size:0.85em;font-weight:700">Pending: â€”</span>
                        <span id="shCwPillClasses" style="background:#f3e5f5;color:#6a1b9a;padding:6px 16px;border-radius:20px;font-size:0.85em;font-weight:700">Classes: â€”</span>
                    </div>

                    <!-- Class breakdown table -->
                    <div id="shAdminClasswiseList">
                        <p style="color:#999">Click Refresh to load class-wise data.</p>
                    </div>

                    <hr style="margin:24px 0;border-color:#e0e0e0">

                    <!-- Today's submissions by class (like quiz) -->
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;flex-wrap:wrap;gap:10px">
                        <h4 style="color:#6a1b9a;margin:0">ðŸ“¸ All Submissions Detail</h4>
                        <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">
                            <select id="shCwClassFilter" onchange="shAdminLoadClasswiseDetail()" style="padding:7px 12px;border:2px solid #9c27b0;border-radius:8px;font-weight:600;color:#3d0060">
                                <option value="">All Classes</option>
                            </select>
                            <select id="shCwStatusFilter" onchange="shAdminLoadClasswiseDetail()" style="padding:7px 12px;border:2px solid #9c27b0;border-radius:8px;font-weight:600;color:#3d0060">
                                <option value="">All Statuses</option>
                                <option value="approved">âœ… Approved</option>
                                <option value="pending">â³ Pending</option>
                                <option value="rejected">âŒ Rejected</option>
                            </select>
                        </div>
                    </div>
                    <div class="table-wrapper">
                        <table style="font-size:13px;width:100%">
                            <thead><tr>
                                <th style="background:#3d0060;color:#ffd700">#</th>
                                <th style="background:#3d0060;color:white">Student</th>
                                <th style="background:#3d0060;color:#ce93d8">Class</th>
                                <th style="background:#3d0060;color:#80deea">Task</th>
                                <th style="background:#3d0060;color:#fff3cd">Submitted At</th>
                                <th style="background:#3d0060;color:#a5d6a7">Status</th>
                            </tr></thead>
                            <tbody id="shCwDetailTable">
                                <tr><td colspan="6" style="text-align:center;color:#999;padding:16px">Click Refresh to load</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- WINNERS TAB -->
                <div id="shAdminWinners" class="sh-tab-panel" style="display:none">
                    <div style="background:linear-gradient(135deg,#7b1fa2,#e91e63);border-radius:14px;padding:22px;margin-bottom:20px;color:white">
                        <h3 style="margin:0 0 6px;font-size:1.2em">ðŸŽ–ï¸ Declare Scavenger Hunt Winner</h3>
                        <p style="margin:0;font-size:0.88em;opacity:0.85">Select winner and runner-up from participants who completed ALL tasks</p>
                    </div>

                    <!-- â”€â”€ AUTO-DECLARATION PANEL â”€â”€ -->
                    <div style="background:linear-gradient(135deg,#1a0030 0%,#3d0060 100%);border-radius:14px;padding:20px 22px;margin-bottom:20px;border:2px solid rgba(255,215,0,0.3)">
                        <div style="display:flex;align-items:center;gap:12px;margin-bottom:16px;flex-wrap:wrap">
                            <span style="font-size:1.7em">â°</span>
                            <div style="flex:1">
                                <h4 style="color:#ffd700;margin:0;font-size:1em">Auto-Declaration</h4>
                                <p style="color:rgba(255,255,255,0.65);font-size:12px;margin:3px 0 0">Set the date, time and which task winners should be declared for.</p>
                            </div>
                            <!-- Toggle -->
                            <label style="display:flex;align-items:center;gap:8px;cursor:pointer;margin:0">
                                <div style="position:relative;width:48px;height:26px">
                                    <input type="checkbox" id="shAutoDeclarToggle" onchange="shToggleAutoDeclar()" style="opacity:0;width:0;height:0;position:absolute">
                                    <span id="shAutoDeclarSlider" style="position:absolute;inset:0;background:#555;border-radius:26px;transition:0.3s;cursor:pointer"></span>
                                    <span id="shAutoDeclarThumb" style="position:absolute;left:3px;top:3px;width:20px;height:20px;background:white;border-radius:50%;transition:0.3s;pointer-events:none"></span>
                                </div>
                                <span id="shAutoDeclarBadge" style="color:#ffd700;font-weight:700;font-size:13px;white-space:nowrap">OFF</span>
                            </label>
                        </div>

                        <!-- Date + Time + Task row -->
                        <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;margin-bottom:14px">
                            <div>
                                <label style="color:rgba(255,255,255,0.7);font-size:11px;font-weight:600;display:block;margin-bottom:4px">ðŸ“… DATE</label>
                                <input type="date" id="shAutoDeclarDate"
                                    style="width:100%;padding:8px 10px;border-radius:8px;border:2px solid #ffd700;background:#2a0050;color:#ffd700;font-size:13px;font-weight:700;cursor:pointer">
                            </div>
                            <div>
                                <label style="color:rgba(255,255,255,0.7);font-size:11px;font-weight:600;display:block;margin-bottom:4px">ðŸ• TIME</label>
                                <input type="time" id="shAutoDeclarTime"
                                    style="width:100%;padding:8px 10px;border-radius:8px;border:2px solid #ffd700;background:#2a0050;color:#ffd700;font-size:13px;font-weight:700;cursor:pointer">
                            </div>
                            <div>
                                <label style="color:rgba(255,255,255,0.7);font-size:11px;font-weight:600;display:block;margin-bottom:4px">ðŸ—ºï¸ TASK</label>
                                <select id="shAutoDeclarTask"
                                    style="width:100%;padding:8px 10px;border-radius:8px;border:2px solid #ffd700;background:#2a0050;color:#ffd700;font-size:13px;font-weight:700;cursor:pointer">
                                    <option value="all">â­ All tasks</option>
                                </select>
                            </div>
                        </div>

                        <div style="display:flex;gap:8px;margin-bottom:12px;flex-wrap:wrap">
                            <button onclick="shSaveAutoDeclarConfig(this)" style="background:#ffd700;color:#1a0030;border:none;padding:7px 18px;border-radius:8px;cursor:pointer;font-size:12px;font-weight:700">ðŸ’¾ Save Config</button>
                            <button onclick="shRunAutoDeclaration()" style="background:rgba(255,255,255,0.15);color:white;border:none;padding:7px 16px;border-radius:8px;cursor:pointer;font-size:12px;font-weight:600">â–¶ï¸ Run Now</button>
                        </div>

                        <div id="shAutoDeclarStatusMsg" style="background:rgba(255,255,255,0.07);border-radius:8px;padding:10px 14px;font-size:12.5px;color:rgba(255,255,255,0.75);margin-bottom:8px">
                            ðŸ”´ Auto-declaration is <strong style="color:#ff6b6b">disabled</strong>. Toggle ON and save config to enable.
                        </div>
                        <div id="shAutoDeclarCountdownDisplay" style="display:none;background:rgba(255,215,0,0.1);border-radius:8px;padding:8px 14px;font-size:13px;color:#ffd700;font-weight:600;text-align:center"></div>
                    </div>

                    <div style="display:flex;gap:12px;flex-wrap:wrap;margin-bottom:20px">
                        <button class="btn btn-success" onclick="shSelectWinnersAuto()" style="font-size:1em;padding:12px 22px">ðŸŽ² Auto-Select (Random from Top)</button>
                        <button class="btn btn-info" onclick="shToggleManualWinner()" id="shManualWinnerToggleBtn" style="font-size:1em;padding:12px 22px">âœ‹ Manual Select</button>
                        <button class="btn btn-info btn-small" onclick="shLoadWinnersTab()" style="margin-left:auto">ðŸ”„ Refresh</button>
                    </div>

                    <!-- Manual select panel -->
                    <div id="shManualWinnerPanel" style="display:none;background:#f0f4ff;border:2px solid #667eea;border-radius:12px;padding:22px;margin-bottom:20px">
                        <h4 style="color:#667eea;margin-bottom:14px">âœ‹ Manual Winner Selection</h4>
                        <p style="color:#555;font-size:13px;margin-bottom:16px">Choose winner and runner-up from all participants.</p>
                        <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:16px">
                            <div>
                                <label style="color:#ffd700;font-weight:700;display:block;margin-bottom:6px">ðŸ¥‡ Winner</label>
                                <select id="shManualWinnerSelect" style="width:100%;padding:10px;border:2px solid #ffd700;border-radius:8px;font-size:0.95em">
                                    <option value="">-- Select Winner --</option>
                                </select>
                            </div>
                            <div>
                                <label style="color:#c0c0c0;font-weight:700;display:block;margin-bottom:6px">ðŸ¥ˆ Runner-up</label>
                                <select id="shManualRunnerSelect" style="width:100%;padding:10px;border:2px solid #c0c0c0;border-radius:8px;font-size:0.95em">
                                    <option value="">-- Select Runner-up --</option>
                                </select>
                            </div>
                        </div>
                        <div style="display:flex;gap:10px">
                            <button class="btn btn-success" onclick="shDeclareManualWinners()" style="padding:12px 24px">âœ… Declare These Winners</button>
                            <button class="btn btn-secondary" onclick="shToggleManualWinner()" style="padding:12px 20px">âœ– Cancel</button>
                        </div>
                    </div>

                    <!-- Eligible participants list -->
                    <div id="shWinnersEligibleList" style="margin-bottom:20px">
                        <p style="color:#999">Click Refresh to load participants.</p>
                    </div>

                    <!-- Current declared winner display -->
                    <div id="shWinnersDeclaredBox" style="display:none"></div>
                </div>

                <!-- SETTINGS TAB -->
                <div id="shAdminSettings" class="sh-tab-panel" style="display:none">
                    <div style="background:#fff3e0;padding:18px;border-radius:10px;margin-bottom:20px;border-left:5px solid #ff9800">
                        <h4 style="color:#e65100;margin-bottom:14px">âš™ï¸ Hunt Settings</h4>

                        <div class="form-group">
                            <label style="display:flex;align-items:center;gap:10px;cursor:pointer">
                                <input type="checkbox" id="shSettingActive" style="width:20px;height:20px;accent-color:#9c27b0">
                                <span><strong>Hunt is ACTIVE</strong> â€” Students can login and attempt tasks</span>
                            </label>
                        </div>
                        <div class="form-group">
                            <label style="display:flex;align-items:center;gap:10px;cursor:pointer">
                                <input type="checkbox" id="shSettingGPS" style="width:20px;height:20px;accent-color:#9c27b0" checked>
                                <span><strong>GPS Verification ON</strong> â€” Must be within 100m to upload</span>
                            </label>
                        </div>
                        <div class="form-group">
                            <label>GPS Radius (metres):</label>
                            <input type="number" id="shSettingRadius" value="100" min="10" max="1000" style="width:120px">
                        </div>
                        <div class="form-group">
                            <label style="display:flex;align-items:center;gap:10px;cursor:pointer">
                                <input type="checkbox" id="shSettingAutoApprove" style="width:20px;height:20px;accent-color:#9c27b0">
                                <span><strong>Auto-Approve</strong> on GPS match (no manual review needed)</span>
                            </label>
                        </div>
                        <button class="btn btn-success" onclick="shAdminSaveSettings()" style="margin-top:6px">ðŸ’¾ Save Settings</button>
                        <span id="shSettingsSaveMsg" style="margin-left:12px;font-size:0.9em;color:#4caf50;display:none">âœ… Saved!</span>
                    </div>

                    <!-- â˜ï¸ CLOUDINARY TEST -->
                    <div style="background:#e3f2fd;padding:18px;border-radius:10px;margin-bottom:20px;border-left:5px solid #1976d2">
                        <h4 style="color:#0d47a1;margin-bottom:10px">â˜ï¸ Cloudinary Connection Test</h4>
                        <p style="color:#555;font-size:0.9em;margin-bottom:12px">Cloud: <strong>dat0khbet</strong> | Preset: <strong>scavenger_hunt</strong><br>Pick a photo (or leave blank) and tap Test.</p>
                        <input type="file" id="shCloudTestFile" accept="image/*" style="margin-bottom:10px;font-size:0.9em"><br>
                        <button class="btn" style="background:#1976d2;color:white" onclick="shTestCloudinary()">ðŸ§ª Test Cloudinary Upload</button>
                        <div id="shCloudTestResult" style="margin-top:12px;font-size:0.9em"></div>
                    </div>

                    <!-- ðŸ”§ FIX TASK ORDER + DEADLINES -->
                    <div style="background:#e8f5e9;padding:18px;border-radius:10px;margin-bottom:20px;border-left:5px solid #2e7d32">
                        <h4 style="color:#1b5e20;margin-bottom:8px">ðŸ”§ Fix Task Order Numbers</h4>
                        <p style="color:#555;font-size:0.9em;margin-bottom:12px">Renumbers tasks 1, 2, 3... and optionally removes all deadlines so expired tasks never block submissions.</p>
                        <button class="btn" style="background:#388e3c;color:white;margin-right:10px" onclick="shFixChainOrder(false)">ðŸ” Preview</button>
                        <button class="btn" style="background:#2e7d32;color:white;margin-right:10px" onclick="shFixChainOrder(true)">âœ… Fix Order Numbers</button>
                        <button class="btn" style="background:#e65100;color:white" onclick="shRemoveAllDeadlines()">ðŸ—“ï¸ Remove ALL Deadlines</button>
                        <div id="shChainFixResult" style="margin-top:12px;font-size:0.85em;font-family:monospace;background:#fafafa;padding:10px;border-radius:6px;border:1px solid #c8e6c9;display:none;white-space:pre-wrap"></div>
                    </div>

                    <!-- ðŸ› ï¸ ADMIN FORCE SUBMIT -->
                    <div style="background:#fff8e1;padding:18px;border-radius:10px;margin-bottom:20px;border-left:5px solid #f9a825">
                        <h4 style="color:#e65100;margin-bottom:8px">ðŸ› ï¸ Admin Force Submit</h4>
                        <p style="color:#555;font-size:0.9em;margin-bottom:12px">Manually create a pending submission. Get the photo URL from your Cloudinary dashboard â†’ Assets.</p>
                        <div style="display:grid;gap:8px;max-width:500px">
                            <input type="text" id="afsStudentKey" placeholder="Student key e.g. Gujjar1" style="padding:8px 12px;border-radius:6px;border:1px solid #ccc">
                            <select id="afsTaskId" style="padding:8px 12px;border-radius:6px;border:1px solid #ccc"><option value="">â€” Select Task â€”</option></select>
                            <input type="text" id="afsPhotoUrl" placeholder="Cloudinary URL (https://res.cloudinary.com/...)" style="padding:8px 12px;border-radius:6px;border:1px solid #ccc">
                            <input type="text" id="afsComment" placeholder="Comment / note" style="padding:8px 12px;border-radius:6px;border:1px solid #ccc">
                        </div>
                        <button class="btn" style="background:#f57c00;color:white;margin-top:10px" onclick="shAdminForceSubmit()">ðŸ› ï¸ Force Create Submission</button>
                        <div id="afsResult" style="margin-top:10px;font-size:0.9em"></div>
                    </div>

                    <!-- ðŸ” DEBUGGER -->
                    <div style="background:#f3e5f5;padding:18px;border-radius:10px;margin-bottom:20px;border-left:5px solid #7b1fa2">
                        <h4 style="color:#4a148c;margin-bottom:10px">ðŸ” Student Submission Debugger</h4>
                        <p style="color:#555;font-size:0.9em;margin-bottom:10px">Enter a student key to see exactly what Firebase has saved for them.</p>
                        <input type="text" id="shDebugStudentKey" placeholder="Student key e.g. Gujjar1" style="padding:8px 12px;border-radius:6px;border:1px solid #ccc;width:220px;margin-right:8px">
                        <button class="btn" style="background:#7b1fa2;color:white" onclick="shDebugStudentSubs()">ðŸ” Check Firebase</button>
                        <div id="shDebugResult" style="margin-top:14px;font-size:0.85em;font-family:monospace;background:#fafafa;padding:12px;border-radius:6px;border:1px solid #e0e0e0;display:none;max-height:300px;overflow-y:auto;white-space:pre-wrap"></div>
                    </div>

                    <div style="background:#ffebee;padding:18px;border-radius:10px;border-left:5px solid #f44336">
                        <h4 style="color:#c62828;margin-bottom:10px">ðŸ—‘ï¸ Danger Zone</h4>
                        <button class="btn btn-danger btn-small" onclick="shAdminResetAll()" style="margin-right:10px">ðŸ—‘ï¸ Reset All Submissions</button>
                        <button class="btn btn-danger btn-small" onclick="shAdminDeleteAllTasks()">ðŸ—‘ï¸ Delete All Tasks</button>
                    </div>
                </div>
            </div>

            <!-- ================================================ -->
            <!-- LEADERBOARD ADMIN PANEL (Super Admin only)       -->
            <!-- Accessed via the "ðŸ† Leaderboard" tab above      -->
            <!-- ================================================ -->

            <!-- ================================================ -->
            <!-- SPEED SLIDE ADMIN PANEL (Super Admin only)       -->
            <!-- Accessed via the "ðŸ§© Speed Slide Admin" tab      -->
            <!-- ================================================ -->
            <div id="speedSlideAdmin" class="form-section super-admin-only">
                <h2 style="color:#c44569;margin-bottom:6px">ðŸ§© Speed Slide Challenge â€” Admin Panel</h2>
                <p style="color:#888;margin-bottom:20px;font-size:.9em">Manage all submissions, approve scores, view leaderboard and configure the game.</p>

                <!-- Sub-tabs -->
                <div class="tabs" style="margin-bottom:20px">
                    <button class="tab active" id="ssa-tab-sub" onclick="ssaShowTab('sub')">ðŸ“¥ Submissions</button>
                    <button class="tab"        id="ssa-tab-lb"  onclick="ssaShowTab('lb')">ðŸ† Leaderboard</button>
                    <button class="tab"        id="ssa-tab-cfg" onclick="ssaShowTab('cfg')">âš™ï¸ Settings</button>
                </div>

                <!-- â”€â”€ Submissions â”€â”€ -->
                <div id="ssa-sub">
                    <div style="display:flex;gap:10px;margin-bottom:16px;flex-wrap:wrap">
                        <select id="ssaSubFilter" onchange="ssaLoadSubs()" style="flex:1;min-width:160px;padding:9px 12px;border-radius:8px;border:2px solid #ddd">
                            <option value="">All Difficulties</option>
                            <option value="easy">ðŸ˜Š 8-Puzzle</option>
                            <option value="medium">ðŸ˜… 15-Puzzle</option>
                            <option value="hard">ðŸ”¥ 24-Puzzle</option>
                        </select>
                        <select id="ssaSubStatus" onchange="ssaLoadSubs()" style="flex:1;min-width:160px;padding:9px 12px;border-radius:8px;border:2px solid #ddd">
                            <option value="">All Status</option>
                            <option value="pending">â³ Pending</option>
                            <option value="approved">âœ… Approved</option>
                            <option value="rejected">âŒ Rejected</option>
                        </select>
                        <button class="btn btn-small" onclick="ssaLoadSubs()">ðŸ”„ Refresh</button>
                        <button class="btn btn-small btn-success" onclick="ssaDownloadCSV()">ðŸ“¥ Download CSV</button>
                    </div>
                    <div id="ssaSubList">
                        <p style="color:#aaa;text-align:center;padding:30px">Click Refresh to load submissions.</p>
                    </div>
                </div>

                <!-- â”€â”€ Leaderboard â”€â”€ -->
                <div id="ssa-lb" style="display:none">
                    <div style="display:flex;gap:8px;margin-bottom:16px;flex-wrap:wrap">
                        <button class="tab active" id="ssalbt-easy"   onclick="ssaSwitchLB('easy')">ðŸ˜Š 8-Puzzle</button>
                        <button class="tab"        id="ssalbt-medium" onclick="ssaSwitchLB('medium')">ðŸ˜… 15-Puzzle</button>
                        <button class="tab"        id="ssalbt-hard"   onclick="ssaSwitchLB('hard')">ðŸ”¥ 24-Puzzle</button>
                        <button class="tab"        id="ssalbt-all"    onclick="ssaSwitchLB('all')">ðŸ“Š All</button>
                    </div>
                    <div id="ssaLbContainer">
                        <p style="color:#aaa;text-align:center;padding:30px">Loadingâ€¦</p>
                    </div>
                </div>

                <!-- â”€â”€ Settings â”€â”€ -->
                <div id="ssa-cfg" style="display:none">
                    <div style="background:#fff3cd;padding:18px;border-radius:10px;border-left:5px solid #ffc107;margin-bottom:20px">
                        <p style="color:#856404;margin:0;font-size:.9em"><strong>Note:</strong> These settings control what players see and can do in Speed Slide Challenge.</p>
                    </div>
                    <div class="form-group">
                        <label>Game Active? (players can play)</label>
                        <select id="ssaCfgActive" style="padding:10px;border-radius:8px;border:2px solid #ddd">
                            <option value="1">âœ… Yes â€” Game is ON</option>
                            <option value="0">âŒ No â€” Game is PAUSED</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Leaderboard visible to players?</label>
                        <select id="ssaCfgLbVisible" style="padding:10px;border-radius:8px;border:2px solid #ddd">
                            <option value="1">âœ… Yes â€” Visible</option>
                            <option value="0">âŒ No â€” Hidden</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Max submissions per player per day</label>
                        <input type="number" id="ssaCfgMaxSubs" value="3" min="1" max="99" style="padding:10px;border-radius:8px;border:2px solid #ddd;width:120px">
                    </div>
                    <button class="btn btn-success" onclick="ssaSaveCfg()">ðŸ’¾ Save Settings</button>
                    <span id="ssaCfgMsg" style="margin-left:12px;font-size:.9em;display:none"></span>

                    <hr style="margin:24px 0;border-color:#eee">
                    <h3 style="color:#f44336;margin-bottom:12px">ðŸ—‘ï¸ Danger Zone</h3>
                    <div style="display:flex;gap:10px;flex-wrap:wrap">
                        <button class="btn btn-danger btn-small" onclick="ssaClearAllScores()">ðŸ—‘ï¸ Clear All Scores</button>
                        <button class="btn btn-danger btn-small" onclick="ssaClearAllImages()">ðŸ—‘ï¸ Clear Images (Firebase Storage)</button>
                    </div>
                </div>

                <!-- Lightbox for submission images -->
                <div id="ssaLightbox" onclick="this.style.display='none'" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.9);z-index:99999;align-items:center;justify-content:center;cursor:zoom-out">
                    <img id="ssaLightboxImg" style="max-width:94vw;max-height:90vh;border-radius:12px" alt="">
                </div>
            </div>
            <!-- ================================================ -->
            <!-- END SPEED SLIDE ADMIN PANEL                      -->
            <!-- ================================================ -->

            <!-- ================================================ -->
            <!-- DB INSPECTOR PANEL (Super Admin Only)             -->
            <!-- ================================================ -->
            <div id="dbInspector" class="form-section super-admin-only" style="margin-top:20px">
                <h2 style="color:#c44569;margin-bottom:6px">ðŸ” Database Inspector</h2>
                <p style="color:#888;margin-bottom:20px;font-size:.9em">Scan your entire Firebase Realtime Database for base64 data, large fields, and suspicious entries.</p>

                <!-- Summary Cards -->
                <div id="dbi-summary" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:12px;margin-bottom:20px">
                    <div style="background:linear-gradient(135deg,#667eea,#764ba2);border-radius:12px;padding:16px;color:white;text-align:center">
                        <div style="font-size:2em" id="dbi-total-nodes">â€”</div>
                        <div style="font-size:.8em;opacity:.85">Total Nodes Scanned</div>
                    </div>
                    <div style="background:linear-gradient(135deg,#f093fb,#f5576c);border-radius:12px;padding:16px;color:white;text-align:center">
                        <div style="font-size:2em" id="dbi-b64-count">â€”</div>
                        <div style="font-size:.8em;opacity:.85">Base64 Fields Found</div>
                    </div>
                    <div style="background:linear-gradient(135deg,#4facfe,#00f2fe);border-radius:12px;padding:16px;color:white;text-align:center">
                        <div style="font-size:2em" id="dbi-total-size">â€”</div>
                        <div style="font-size:.8em;opacity:.85">Total DB Size</div>
                    </div>
                    <div style="background:linear-gradient(135deg,#43e97b,#38f9d7);border-radius:12px;padding:16px;color:white;text-align:center">
                        <div style="font-size:2em" id="dbi-b64-size">â€”</div>
                        <div style="font-size:.8em;opacity:.85">Base64 Data Size</div>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div style="display:flex;gap:10px;flex-wrap:wrap;margin-bottom:20px">
                    <button class="btn btn-success" onclick="dbiRunScan()" id="dbi-scan-btn">ðŸ” Scan Database Now</button>
                    <button class="btn btn-small" onclick="dbiClearResults()" style="background:#888;color:white">ðŸ—‘ï¸ Clear Results</button>
                    <button class="btn btn-small" onclick="dbiDownloadReport()" id="dbi-dl-btn" style="display:none;background:#6a1b9a;color:white">ðŸ“¥ Download Report</button>
                </div>

                <!-- Progress Bar -->
                <div id="dbi-progress-wrap" style="display:none;margin-bottom:16px">
                    <div style="background:#eee;border-radius:20px;height:10px;overflow:hidden">
                        <div id="dbi-progress-bar" style="background:linear-gradient(90deg,#c44569,#6a1b9a);height:100%;width:0%;transition:width .4s ease;border-radius:20px"></div>
                    </div>
                    <p id="dbi-progress-label" style="color:#888;font-size:.82em;margin-top:4px;text-align:center">Scanningâ€¦</p>
                </div>

                <!-- Alert Banner -->
                <div id="dbi-alert" style="display:none;padding:14px 18px;border-radius:10px;margin-bottom:16px;font-weight:600"></div>

                <!-- Results Table -->
                <div id="dbi-results" style="display:none">
                    <h3 style="color:#c44569;margin-bottom:10px">ðŸ“‹ Scan Results</h3>
                    <div style="overflow-x:auto">
                        <table style="width:100%;border-collapse:collapse;font-size:.85em">
                            <thead>
                                <tr style="background:linear-gradient(135deg,#c44569,#6a1b9a);color:white">
                                    <th style="padding:10px 12px;text-align:left;border-radius:8px 0 0 0">#</th>
                                    <th style="padding:10px 12px;text-align:left">Firebase Path</th>
                                    <th style="padding:10px 12px;text-align:left">Field Key</th>
                                    <th style="padding:10px 12px;text-align:left">Type</th>
                                    <th style="padding:10px 12px;text-align:left">Size</th>
                                    <th style="padding:10px 12px;text-align:left;border-radius:0 8px 0 0">Preview</th>
                                </tr>
                            </thead>
                            <tbody id="dbi-table-body"></tbody>
                        </table>
                    </div>
                    <p style="color:#888;font-size:.8em;margin-top:10px" id="dbi-results-note"></p>
                </div>

                <!-- Node Tree Explorer -->
                <div style="margin-top:24px">
                    <h3 style="color:#6a1b9a;margin-bottom:10px">ðŸŒ³ Top-Level Node Sizes</h3>
                    <div id="dbi-node-tree" style="background:#f9f5ff;border-radius:10px;padding:16px;min-height:60px;color:#888;font-size:.85em">
                        Run a scan to see node sizes.
                    </div>
                </div>
            </div>
            <!-- ================================================ -->
            <!-- END DB INSPECTOR PANEL                           -->
            <!-- ================================================ -->

            <!-- ================================================ -->
            <!-- â˜ï¸ CLOUDINARY INSPECTOR PANEL (Super Admin Only) -->
            <!-- ================================================ -->
            <div id="cloudinaryInspector" class="form-section super-admin-only" style="margin-top:20px">
                <h2 style="color:#c44569;margin-bottom:6px">â˜ï¸ Cloudinary Inspector</h2>
                <p style="color:#888;margin-bottom:16px;font-size:.9em">Two ways to check your Cloudinary usage â€” pick whichever works for you.</p>

                <!-- â”€â”€ MODE SWITCHER â”€â”€ -->
                <div style="display:flex;gap:0;margin-bottom:20px;border-radius:10px;overflow:hidden;border:2px solid #6a1b9a;width:fit-content">
                    <button id="cld-mode-manual-btn" onclick="cldSwitchMode('manual')"
                        style="padding:10px 22px;font-size:.88em;font-weight:700;cursor:pointer;border:none;background:linear-gradient(135deg,#6a1b9a,#c44569);color:white;transition:all .2s">
                        ðŸ“‹ Option A â€” Manual Logger
                    </button>
                    <button id="cld-mode-live-btn" onclick="cldSwitchMode('live')"
                        style="padding:10px 22px;font-size:.88em;font-weight:700;cursor:pointer;border:none;background:#f3e8ff;color:#6a1b9a;transition:all .2s">
                        âš¡ Option B â€” Live via Proxy
                    </button>
                </div>

                <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
                <!-- OPTION A â€” MANUAL LOGGER                        -->
                <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
                <div id="cld-panel-manual">

                    <!-- How-to banner -->
                    <div style="background:linear-gradient(135deg,#e8f4fd,#f3e8ff);border-radius:12px;padding:16px;margin-bottom:16px;border-left:5px solid #6a1b9a">
                        <p style="color:#6a1b9a;font-weight:700;margin-bottom:8px;font-size:.92em">ðŸ“– How to get your numbers</p>
                        <ol style="color:#555;font-size:.84em;margin:0;padding-left:18px;line-height:2">
                            <li>Go to <a href="https://cloudinary.com/console" target="_blank" style="color:#c44569;font-weight:600">cloudinary.com/console</a> and log in</li>
                            <li>On the <strong>Home / Dashboard</strong> page you'll see Storage, Bandwidth, and Transformations gauges</li>
                            <li>For full history: click <strong>Reports â†’ Usage Report</strong> in the left sidebar</li>
                            <li>Note down the values and enter them below â€” they're saved in your browser</li>
                        </ol>
                    </div>

                    <!-- Input form -->
                    <div style="background:#f9f5ff;border-radius:12px;padding:16px;margin-bottom:16px;border:1px solid #e0d0f0">
                        <p style="color:#6a1b9a;font-weight:700;margin-bottom:12px;font-size:.9em">ðŸ“¥ Log Current Usage</p>
                        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:10px;margin-bottom:12px">
                            <div>
                                <label style="font-size:.78em;color:#888;display:block;margin-bottom:4px">ðŸ—„ï¸ Storage Used (MB)</label>
                                <input id="cldm-storage-used" type="number" min="0" step="0.1" placeholder="e.g. 450.5"
                                    style="width:100%;padding:8px 12px;border:1.5px solid #e0d0f0;border-radius:8px;font-size:.9em;outline:none">
                            </div>
                            <div>
                                <label style="font-size:.78em;color:#888;display:block;margin-bottom:4px">ðŸ“¦ Storage Limit (MB)</label>
                                <input id="cldm-storage-limit" type="number" min="0" step="0.1" placeholder="e.g. 25600 (25 GB free)"
                                    style="width:100%;padding:8px 12px;border:1.5px solid #e0d0f0;border-radius:8px;font-size:.9em;outline:none">
                            </div>
                            <div>
                                <label style="font-size:.78em;color:#888;display:block;margin-bottom:4px">ðŸŒ Bandwidth Used (MB)</label>
                                <input id="cldm-bw-used" type="number" min="0" step="0.1" placeholder="e.g. 1200"
                                    style="width:100%;padding:8px 12px;border:1.5px solid #e0d0f0;border-radius:8px;font-size:.9em;outline:none">
                            </div>
                            <div>
                                <label style="font-size:.78em;color:#888;display:block;margin-bottom:4px">ðŸ“¡ Bandwidth Limit (MB)</label>
                                <input id="cldm-bw-limit" type="number" min="0" step="0.1" placeholder="e.g. 25600 (25 GB free)"
                                    style="width:100%;padding:8px 12px;border:1.5px solid #e0d0f0;border-radius:8px;font-size:.9em;outline:none">
                            </div>
                            <div>
                                <label style="font-size:.78em;color:#888;display:block;margin-bottom:4px">ðŸ–¼ï¸ Total Assets</label>
                                <input id="cldm-assets" type="number" min="0" step="1" placeholder="e.g. 342"
                                    style="width:100%;padding:8px 12px;border:1.5px solid #e0d0f0;border-radius:8px;font-size:.9em;outline:none">
                            </div>
                            <div>
                                <label style="font-size:.78em;color:#888;display:block;margin-bottom:4px">ðŸ“… Date Checked</label>
                                <input id="cldm-date" type="date"
                                    style="width:100%;padding:8px 12px;border:1.5px solid #e0d0f0;border-radius:8px;font-size:.9em;outline:none">
                            </div>
                        </div>
                        <div style="display:flex;gap:10px;flex-wrap:wrap">
                            <button class="btn btn-success" onclick="cldmSave()">ðŸ’¾ Save & Visualise</button>
                            <button class="btn btn-small" onclick="cldmClearAll()" style="background:#dc3545;color:white">ðŸ—‘ï¸ Clear All</button>
                        </div>
                    </div>

                    <!-- Alert -->
                    <div id="cldm-alert" style="display:none;padding:14px 18px;border-radius:10px;margin-bottom:16px;font-weight:600"></div>

                    <!-- Summary Cards -->
                    <div id="cldm-cards" style="display:none">
                        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:12px;margin-bottom:16px">
                            <div style="background:linear-gradient(135deg,#f7971e,#ffd200);border-radius:12px;padding:14px;color:#333;text-align:center">
                                <div style="font-size:1.6em;font-weight:700" id="cldm-card-storage-used">â€”</div>
                                <div style="font-size:.75em;opacity:.85">Storage Used</div>
                            </div>
                            <div style="background:linear-gradient(135deg,#11998e,#38ef7d);border-radius:12px;padding:14px;color:white;text-align:center">
                                <div style="font-size:1.6em;font-weight:700" id="cldm-card-storage-limit">â€”</div>
                                <div style="font-size:.75em;opacity:.85">Storage Limit</div>
                            </div>
                            <div style="background:linear-gradient(135deg,#4facfe,#00f2fe);border-radius:12px;padding:14px;color:white;text-align:center">
                                <div style="font-size:1.6em;font-weight:700" id="cldm-card-bw-used">â€”</div>
                                <div style="font-size:.75em;opacity:.85">Bandwidth Used</div>
                            </div>
                            <div style="background:linear-gradient(135deg,#f093fb,#f5576c);border-radius:12px;padding:14px;color:white;text-align:center">
                                <div style="font-size:1.6em;font-weight:700" id="cldm-card-bw-limit">â€”</div>
                                <div style="font-size:.75em;opacity:.85">Bandwidth Limit</div>
                            </div>
                            <div style="background:linear-gradient(135deg,#667eea,#764ba2);border-radius:12px;padding:14px;color:white;text-align:center">
                                <div style="font-size:1.6em;font-weight:700" id="cldm-card-assets">â€”</div>
                                <div style="font-size:.75em;opacity:.85">Total Assets</div>
                            </div>
                            <div style="background:linear-gradient(135deg,#43e97b,#38f9d7);border-radius:12px;padding:14px;color:white;text-align:center">
                                <div style="font-size:1.6em;font-weight:700" id="cldm-card-date">â€”</div>
                                <div style="font-size:.75em;opacity:.85">Last Checked</div>
                            </div>
                        </div>

                        <!-- Usage bars -->
                        <div style="background:#f9f5ff;border-radius:12px;padding:16px;margin-bottom:16px">
                            <h3 style="color:#6a1b9a;margin-bottom:14px;font-size:1em">ðŸ“Š Usage Overview</h3>
                            <div style="margin-bottom:14px">
                                <div style="display:flex;justify-content:space-between;margin-bottom:4px">
                                    <span style="font-weight:700;color:#333;font-size:.88em">ðŸ—„ï¸ Storage</span>
                                    <span id="cldm-storage-pct-lbl" style="color:#888;font-size:.82em"></span>
                                </div>
                                <div style="background:#e0e0e0;border-radius:20px;height:14px;overflow:hidden">
                                    <div id="cldm-storage-bar" style="height:100%;width:0%;border-radius:20px;transition:width .7s ease;background:linear-gradient(90deg,#43e97b,#38f9d7)"></div>
                                </div>
                            </div>
                            <div>
                                <div style="display:flex;justify-content:space-between;margin-bottom:4px">
                                    <span style="font-weight:700;color:#333;font-size:.88em">ðŸŒ Bandwidth (this month)</span>
                                    <span id="cldm-bw-pct-lbl" style="color:#888;font-size:.82em"></span>
                                </div>
                                <div style="background:#e0e0e0;border-radius:20px;height:14px;overflow:hidden">
                                    <div id="cldm-bw-bar" style="height:100%;width:0%;border-radius:20px;transition:width .7s ease;background:linear-gradient(90deg,#4facfe,#00f2fe)"></div>
                                </div>
                            </div>
                        </div>

                        <!-- History -->
                        <h3 style="color:#6a1b9a;font-size:.95em;margin-bottom:10px">ðŸ“… Saved History (Last 7 Entries)</h3>
                        <div style="overflow-x:auto">
                            <table style="width:100%;border-collapse:collapse;font-size:.83em">
                                <thead>
                                    <tr style="background:linear-gradient(135deg,#c44569,#6a1b9a);color:white">
                                        <th style="padding:9px 12px;text-align:left;border-radius:8px 0 0 0">Date</th>
                                        <th style="padding:9px 12px;text-align:left">Storage</th>
                                        <th style="padding:9px 12px;text-align:left">Bandwidth</th>
                                        <th style="padding:9px 12px;text-align:left">Assets</th>
                                        <th style="padding:9px 12px;text-align:left;border-radius:0 8px 0 0">Action</th>
                                    </tr>
                                </thead>
                                <tbody id="cldm-history-body"></tbody>
                            </table>
                        </div>
                    </div>
                </div><!-- end panel-manual -->

                <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
                <!-- OPTION B â€” LIVE VIA CLOUDFLARE WORKER PROXY     -->
                <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
                <div id="cld-panel-live" style="display:none">

                    <!-- Setup guide -->
                    <div style="background:linear-gradient(135deg,#fff8e1,#f3e8ff);border-radius:12px;padding:16px;margin-bottom:16px;border-left:5px solid #f7971e">
                        <p style="color:#856404;font-weight:700;margin-bottom:10px;font-size:.92em">âš¡ One-time Setup: Create a Free Cloudflare Worker (takes ~10 minutes)</p>
                        <ol style="color:#555;font-size:.84em;margin:0;padding-left:18px;line-height:2.2">
                            <li>Go to <a href="https://dash.cloudflare.com" target="_blank" style="color:#c44569;font-weight:600">dash.cloudflare.com</a> â†’ sign up free â†’ click <strong>Workers &amp; Pages â†’ Create</strong></li>
                            <li>Click <strong>"Hello World"</strong> template â†’ give it a name (e.g. <code style="background:#eee;padding:1px 5px;border-radius:3px">cld-proxy</code>) â†’ click <strong>Deploy</strong></li>
                            <li>Click <strong>"Edit code"</strong> and replace ALL the code with this:</li>
                        </ol>
                        <pre style="background:#1e1e2e;color:#cdd6f4;border-radius:8px;padding:14px;margin:10px 0;font-size:.78em;overflow-x:auto;line-height:1.6"><code>export default {
  async fetch(request) {
    // âœï¸ Fill in YOUR Cloudinary credentials below
    const API_KEY    = "YOUR_API_KEY_HERE";
    const API_SECRET = "YOUR_API_SECRET_HERE";
    const CLOUD_NAME = "YOUR_CLOUD_NAME_HERE";

    const credentials = btoa(`${API_KEY}:${API_SECRET}`);
    const resp = await fetch(
      `https://api.cloudinary.com/v1_1/${CLOUD_NAME}/usage`,
      { headers: { Authorization: `Basic ${credentials}` } }
    );
    const data = await resp.json();

    return new Response(JSON.stringify(data), {
      headers: {
        "Content-Type": "application/json",
        "Access-Control-Allow-Origin": "*"
      }
    });
  }
};</code></pre>
                        <ol start="4" style="color:#555;font-size:.84em;margin:0;padding-left:18px;line-height:2.2">
                            <li>Fill in your <strong>API_KEY</strong>, <strong>API_SECRET</strong>, and <strong>CLOUD_NAME</strong> in the code above (find them at Cloudinary â†’ Settings â†’ Access Keys)</li>
                            <li>Click <strong>Deploy</strong> â€” you'll get a URL like <code style="background:#eee;padding:1px 5px;border-radius:3px">https://cld-proxy.YOUR-NAME.workers.dev</code></li>
                            <li>Paste that URL into the box below and click <strong>Fetch Live Stats</strong></li>
                        </ol>
                    </div>

                    <!-- Worker URL input -->
                    <div style="background:#f9f5ff;border-radius:12px;padding:16px;margin-bottom:16px;border:1px solid #e0d0f0">
                        <p style="color:#6a1b9a;font-weight:700;margin-bottom:10px;font-size:.9em">ðŸ”— Your Cloudflare Worker URL</p>
                        <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
                            <input id="cld-worker-url" type="url" placeholder="https://cld-proxy.your-name.workers.dev"
                                style="flex:1;min-width:250px;padding:9px 14px;border:1.5px solid #e0d0f0;border-radius:8px;font-size:.9em;outline:none">
                            <button class="btn btn-success" onclick="cldLiveFetch()" id="cld-live-btn">âš¡ Fetch Live Stats</button>
                            <button class="btn btn-small" onclick="cldLiveClear()" style="background:#888;color:white">ðŸ—‘ï¸ Clear</button>
                        </div>
                        <p style="color:#aaa;font-size:.76em;margin-top:8px">The URL is saved in your browser for next time.</p>
                    </div>

                    <!-- Progress Bar -->
                    <div id="cld-live-progress-wrap" style="display:none;margin-bottom:14px">
                        <div style="background:#eee;border-radius:20px;height:10px;overflow:hidden">
                            <div id="cld-live-progress-bar" style="background:linear-gradient(90deg,#f7971e,#ffd200);height:100%;width:0%;transition:width .4s ease;border-radius:20px"></div>
                        </div>
                        <p id="cld-live-progress-label" style="color:#888;font-size:.82em;margin-top:4px;text-align:center">Fetchingâ€¦</p>
                    </div>

                    <!-- Alert -->
                    <div id="cld-live-alert" style="display:none;padding:14px 18px;border-radius:10px;margin-bottom:16px;font-weight:600"></div>

                    <!-- Live Results -->
                    <div id="cld-live-results" style="display:none">
                        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:12px;margin-bottom:16px">
                            <div style="background:linear-gradient(135deg,#f7971e,#ffd200);border-radius:12px;padding:14px;color:#333;text-align:center">
                                <div style="font-size:1.6em;font-weight:700" id="cld-storage">â€”</div>
                                <div style="font-size:.75em;opacity:.85">Storage Used</div>
                            </div>
                            <div style="background:linear-gradient(135deg,#11998e,#38ef7d);border-radius:12px;padding:14px;color:white;text-align:center">
                                <div style="font-size:1.6em;font-weight:700" id="cld-storage-limit">â€”</div>
                                <div style="font-size:.75em;opacity:.85">Storage Limit</div>
                            </div>
                            <div style="background:linear-gradient(135deg,#4facfe,#00f2fe);border-radius:12px;padding:14px;color:white;text-align:center">
                                <div style="font-size:1.6em;font-weight:700" id="cld-bandwidth">â€”</div>
                                <div style="font-size:.75em;opacity:.85">Bandwidth Used</div>
                            </div>
                            <div style="background:linear-gradient(135deg,#f093fb,#f5576c);border-radius:12px;padding:14px;color:white;text-align:center">
                                <div style="font-size:1.6em;font-weight:700" id="cld-bandwidth-limit">â€”</div>
                                <div style="font-size:.75em;opacity:.85">Bandwidth Limit</div>
                            </div>
                            <div style="background:linear-gradient(135deg,#667eea,#764ba2);border-radius:12px;padding:14px;color:white;text-align:center">
                                <div style="font-size:1.6em;font-weight:700" id="cld-resources">â€”</div>
                                <div style="font-size:.75em;opacity:.85">Total Assets</div>
                            </div>
                            <div style="background:linear-gradient(135deg,#43e97b,#38f9d7);border-radius:12px;padding:14px;color:white;text-align:center">
                                <div style="font-size:1.6em;font-weight:700" id="cld-plan">â€”</div>
                                <div style="font-size:.75em;opacity:.85">Plan</div>
                            </div>
                        </div>
                        <!-- Usage bars -->
                        <div style="background:#f9f5ff;border-radius:12px;padding:16px">
                            <h3 style="color:#6a1b9a;margin-bottom:14px;font-size:1em">ðŸ“Š Live Usage Overview</h3>
                            <div style="margin-bottom:14px">
                                <div style="display:flex;justify-content:space-between;margin-bottom:4px">
                                    <span style="font-weight:700;color:#333;font-size:.88em">ðŸ—„ï¸ Storage</span>
                                    <span id="cld-storage-pct-label" style="color:#888;font-size:.82em"></span>
                                </div>
                                <div style="background:#e0e0e0;border-radius:20px;height:14px;overflow:hidden">
                                    <div id="cld-storage-bar" style="height:100%;width:0%;border-radius:20px;transition:width .7s ease"></div>
                                </div>
                            </div>
                            <div>
                                <div style="display:flex;justify-content:space-between;margin-bottom:4px">
                                    <span style="font-weight:700;color:#333;font-size:.88em">ðŸŒ Bandwidth (this month)</span>
                                    <span id="cld-bandwidth-pct-label" style="color:#888;font-size:.82em"></span>
                                </div>
                                <div style="background:#e0e0e0;border-radius:20px;height:14px;overflow:hidden">
                                    <div id="cld-bandwidth-bar" style="height:100%;width:0%;border-radius:20px;transition:width .7s ease"></div>
                                </div>
                            </div>
                            <div id="cld-asset-breakdown" style="margin-top:16px;display:grid;grid-template-columns:repeat(auto-fit,minmax(130px,1fr));gap:10px"></div>
                        </div>
                    </div>
                </div><!-- end panel-live -->

            </div>
            <!-- ================================================ -->
            <!-- END CLOUDINARY INSPECTOR PANEL                   -->
            <!-- ================================================ -->

            <!-- ================================================ -->
            <!-- ðŸ”¥ FIREBASE DOWNLOAD LIMIT MONITOR (Super Admin) -->
            <!-- ================================================ -->
            <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
            <!-- MANAGER PERMISSIONS PANEL (Super Admin only)                      -->
            <!-- TO ADD A NEW PERMISSION: copy a toggle row, change id & label,    -->
            <!-- then add matching code in managerPermissions & applyManagerPermissions() -->
            <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
            <div id="managerPermissionsPanel" class="form-section super-admin-only" style="margin-top:20px">
                <h2 style="color:#2196F3;margin-bottom:8px">ðŸ‘” Manager Permissions</h2>
                <p style="color:#555;font-size:13px;margin-bottom:20px;background:#e3f2fd;padding:12px 16px;border-radius:8px;border-left:4px solid #2196F3">
                    Control exactly what the <strong>Manager</strong> login can see and do.<br>
                    Changes saved here persist across page reloads.
                </p>
                <div style="background:white;border-radius:12px;border:2px solid #e0e0e0;overflow:hidden">
                    <div style="background:#2196F3;color:white;padding:12px 20px;display:grid;grid-template-columns:1fr auto;align-items:center">
                        <span style="font-weight:700">Feature / Tab</span>
                        <span style="font-weight:700">Allow Manager?</span>
                    </div>
                    <div style="padding:0 20px">

                        <div style="display:grid;grid-template-columns:1fr auto;align-items:center;padding:16px 0;border-bottom:1px solid #f0f0f0">
                            <div><strong style="color:#333">ðŸ“ Quiz Management</strong>
                            <p style="color:#777;font-size:12px;margin:3px 0 0">Add/edit quiz questions, publish daily quiz</p></div>
                            <input type="checkbox" id="mperm_quizManagement" style="width:20px;height:20px;accent-color:#2196F3;cursor:pointer">
                        </div>

                        <div style="display:grid;grid-template-columns:1fr auto;align-items:center;padding:16px 0;border-bottom:1px solid #f0f0f0">
                            <div><strong style="color:#333">ðŸ—ºï¸ Scavenger Hunt Admin</strong>
                            <p style="color:#777;font-size:12px;margin:3px 0 0">Add/edit tasks, approve/reject student submissions</p></div>
                            <input type="checkbox" id="mperm_scavengerAdmin" style="width:20px;height:20px;accent-color:#2196F3;cursor:pointer">
                        </div>

                        <div style="display:grid;grid-template-columns:1fr auto;align-items:center;padding:16px 0;border-bottom:1px solid #f0f0f0">
                            <div><strong style="color:#333">ðŸ“‹ View Registrations</strong>
                            <p style="color:#777;font-size:12px;margin:3px 0 0">See Master List & By Events tabs (read-only)</p></div>
                            <input type="checkbox" id="mperm_viewRegistrations" style="width:20px;height:20px;accent-color:#2196F3;cursor:pointer">
                        </div>

                        <div style="display:grid;grid-template-columns:1fr auto;align-items:center;padding:16px 0;border-bottom:1px solid #f0f0f0">
                            <div><strong style="color:#333">ðŸ† View Quiz Results</strong>
                            <p style="color:#777;font-size:12px;margin:3px 0 0">See Results tab and quiz submissions</p></div>
                            <input type="checkbox" id="mperm_viewResults" style="width:20px;height:20px;accent-color:#2196F3;cursor:pointer">
                        </div>

                        <div style="display:grid;grid-template-columns:1fr auto;align-items:center;padding:16px 0;border-bottom:1px solid #f0f0f0">
                            <div><strong style="color:#333">ðŸ“² WhatsApp Broadcast Messages</strong>
                            <p style="color:#777;font-size:12px;margin:3px 0 0">Copy ready-made quiz & scavenger hunt messages</p></div>
                            <input type="checkbox" id="mperm_whatsappMessages" style="width:20px;height:20px;accent-color:#2196F3;cursor:pointer">
                        </div>

                        <!-- â”€â”€ ADD NEW PERMISSION ROWS BELOW THIS LINE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
                        <!-- Copy any row above, change id="mperm_yourKey", label & description -->
                        <!-- Then add matching code in managerPermissions object & applyManagerPermissions() -->

                    </div>
                    <div style="padding:20px;background:#f9f9f9;border-top:2px solid #e0e0e0;display:flex;align-items:center;gap:15px;flex-wrap:wrap">
                        <button onclick="saveManagerPermissions()" style="background:#2196F3;color:white;border:none;padding:12px 30px;border-radius:8px;cursor:pointer;font-weight:700;font-size:1em">
                            ðŸ’¾ Save Permissions
                        </button>
                        <span style="color:#777;font-size:12px">Changes persist across page reloads.</span>
                    </div>
                </div>

                <div style="margin-top:30px">
                    <h3 style="color:#25D366;margin-bottom:15px">ðŸ“² WhatsApp Broadcast Messages</h3>
                    <p style="color:#555;font-size:13px;margin-bottom:15px">Preview and copy messages for WhatsApp broadcast:</p>
                    <div style="display:flex;gap:15px;flex-wrap:wrap">
                        <button onclick="copyQuizWhatsAppMsg()" style="background:#25D366;color:white;border:none;padding:12px 24px;border-radius:8px;cursor:pointer;font-weight:700">
                            ðŸ“‹ Copy Quiz WhatsApp Message
                        </button>
                        <button onclick="copyScavengerWhatsAppMsg()" style="background:#128C7E;color:white;border:none;padding:12px 24px;border-radius:8px;cursor:pointer;font-weight:700">
                            ðŸ“‹ Copy Scavenger Hunt WhatsApp Message
                        </button>
                    </div>
                </div>
            </div>
            <!-- END MANAGER PERMISSIONS PANEL -->

            <div id="firebaseDownloadMonitor" class="form-section super-admin-only" style="margin-top:20px">
                <h2 style="color:#c44569;margin-bottom:6px">ðŸ”¥ Firebase Download Monitor</h2>
                <p style="color:#888;margin-bottom:16px;font-size:.9em">Track your Firebase Storage 10 GB/day download limit. Manually log downloads or paste daily stats to visualise usage.</p>

                <!-- Info Box -->
                <div style="background:#fff3cd;border-radius:10px;padding:14px;border-left:5px solid #ffc107;margin-bottom:16px">
                    <p style="color:#856404;font-size:.88em;margin:0"><strong>â„¹ï¸ About the 10 GB Limit:</strong> Firebase Spark (free) plan allows <strong>10 GB of data downloaded per day</strong> from Firebase Storage. If exceeded, downloads are blocked until midnight Pacific Time. Realtime Database reads also count against bandwidth.</p>
                </div>

                <!-- Current Usage Entry -->
                <div style="background:#f9f5ff;border-radius:12px;padding:16px;margin-bottom:16px;border:1px solid #e0d0f0">
                    <p style="color:#6a1b9a;font-weight:700;margin-bottom:12px;font-size:.9em">ðŸ“¥ Log Today's Download Usage</p>
                    <div style="display:grid;grid-template-columns:1fr 1fr auto;gap:10px;align-items:end">
                        <div>
                            <label style="font-size:.8em;color:#888;display:block;margin-bottom:4px">Downloaded Today (GB)</label>
                            <input id="fdm-today-gb" type="number" min="0" max="10" step="0.01" placeholder="e.g. 3.5" style="width:100%;padding:8px 12px;border:1.5px solid #e0d0f0;border-radius:8px;font-size:.9em;outline:none">
                        </div>
                        <div>
                            <label style="font-size:.8em;color:#888;display:block;margin-bottom:4px">Date</label>
                            <input id="fdm-date" type="date" style="width:100%;padding:8px 12px;border:1.5px solid #e0d0f0;border-radius:8px;font-size:.9em;outline:none">
                        </div>
                        <button class="btn btn-success" onclick="fdmLogUsage()" style="height:38px;padding:0 18px;font-size:.88em">âž• Log</button>
                    </div>
                    <p style="color:#aaa;font-size:.76em;margin-top:8px">Get actual numbers from <strong>Firebase Console â†’ Storage â†’ Usage</strong> tab, or check your billing page.</p>
                </div>

                <!-- Live Gauge -->
                <div id="fdm-gauge-wrap" style="background:#f9f5ff;border-radius:12px;padding:20px;margin-bottom:16px">
                    <h3 style="color:#6a1b9a;margin-bottom:14px;font-size:1em">ðŸ“Š Today's Download Usage</h3>
                    <div style="display:flex;align-items:center;gap:16px;flex-wrap:wrap">
                        <div style="flex:1;min-width:200px">
                            <div style="display:flex;justify-content:space-between;margin-bottom:6px">
                                <span style="font-weight:700;color:#333;font-size:.88em">Downloads Used</span>
                                <span id="fdm-gauge-label" style="font-weight:700;color:#c44569;font-size:.88em">0 / 10 GB</span>
                            </div>
                            <div style="background:#e0e0e0;border-radius:20px;height:18px;overflow:hidden;position:relative">
                                <div id="fdm-gauge-bar" style="background:linear-gradient(90deg,#43e97b,#38f9d7);height:100%;width:0%;border-radius:20px;transition:width .7s ease"></div>
                                <!-- Danger zone marker at 80% -->
                                <div style="position:absolute;left:80%;top:0;height:100%;width:2px;background:rgba(255,100,0,.5)"></div>
                                <!-- Critical marker at 95% -->
                                <div style="position:absolute;left:95%;top:0;height:100%;width:2px;background:rgba(220,53,69,.7)"></div>
                            </div>
                            <div style="display:flex;justify-content:space-between;margin-top:4px">
                                <span style="font-size:.72em;color:#888">0 GB</span>
                                <span style="font-size:.72em;color:#e65100">âš ï¸ 8 GB</span>
                                <span style="font-size:.72em;color:#dc3545">ðŸš« 10 GB</span>
                            </div>
                        </div>
                        <div id="fdm-status-badge" style="background:#28a745;color:white;border-radius:50%;width:80px;height:80px;display:flex;flex-direction:column;align-items:center;justify-content:center;font-weight:700;font-size:.78em;text-align:center;flex-shrink:0">
                            <span style="font-size:1.6em">âœ…</span>
                            <span id="fdm-status-text">SAFE</span>
                        </div>
                    </div>
                    <p id="fdm-remaining-label" style="color:#888;font-size:.82em;margin-top:10px;text-align:center">No data logged yet. Use the form above to log usage.</p>
                </div>

                <!-- History Table -->
                <div>
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
                        <h3 style="color:#6a1b9a;font-size:1em;margin:0">ðŸ“… Download History (Last 7 Days)</h3>
                        <button class="btn btn-small" onclick="fdmClearHistory()" style="background:#dc3545;color:white;font-size:.78em">ðŸ—‘ï¸ Clear All</button>
                    </div>
                    <div style="overflow-x:auto">
                        <table style="width:100%;border-collapse:collapse;font-size:.85em">
                            <thead>
                                <tr style="background:linear-gradient(135deg,#c44569,#6a1b9a);color:white">
                                    <th style="padding:9px 12px;text-align:left;border-radius:8px 0 0 0">Date</th>
                                    <th style="padding:9px 12px;text-align:left">Downloaded</th>
                                    <th style="padding:9px 12px;text-align:left">% of Limit</th>
                                    <th style="padding:9px 12px;text-align:left">Status</th>
                                    <th style="padding:9px 12px;text-align:left;border-radius:0 8px 0 0">Action</th>
                                </tr>
                            </thead>
                            <tbody id="fdm-history-body">
                                <tr><td colspan="5" style="padding:16px;text-align:center;color:#aaa">No history yet.</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Tips -->
                <div style="margin-top:16px;background:#e8f4fd;border-radius:10px;padding:14px;border-left:5px solid #4facfe">
                    <p style="color:#0c5460;font-weight:700;margin-bottom:8px;font-size:.88em">ðŸ’¡ Tips to Reduce Downloads</p>
                    <ul style="color:#0c5460;font-size:.82em;margin:0;padding-left:18px;line-height:1.8">
                        <li>Use <strong>Cloudinary</strong> for images instead of Firebase Storage</li>
                        <li>Enable browser caching with proper Cache-Control headers</li>
                        <li>Compress images before uploading (use WebP format)</li>
                        <li>Avoid storing base64 images in Realtime Database (found by DB Inspector above)</li>
                        <li>Upgrade to Firebase Blaze (pay-as-you-go) if you need more than 10 GB/day</li>
                    </ul>
                </div>
            </div>
            <!-- ================================================ -->
            <!-- END FIREBASE DOWNLOAD MONITOR                    -->
            <!-- ================================================ -->

            <div id="leaderboardAdmin" class="form-section super-admin-only" style="margin-top:20px">
                <h2 style="color:#ffd700;margin-bottom:12px;text-shadow:0 2px 8px rgba(0,0,0,0.4)">ðŸ† Leaderboard Management</h2>

                <!-- â”€â”€ WHO / WHAT detail banner â”€â”€ -->
                <div style="background:linear-gradient(135deg,#1a0030 0%,#3d0060 50%,#6a1b9a 100%);border-radius:14px;padding:22px 24px;margin-bottom:18px;border:2px solid rgba(255,215,0,0.35);box-shadow:0 6px 24px rgba(106,27,154,0.35)">
                    <div style="display:flex;align-items:center;gap:12px;margin-bottom:14px">
                        <span style="font-size:2em">ðŸ…</span>
                        <div>
                            <h3 style="color:#ffd700;margin:0;font-size:1.15em;letter-spacing:0.5px">Spurthi Youth Fest 2026 â€” Class of the Year</h3>
                            <p style="color:rgba(255,255,255,0.7);margin:3px 0 0;font-size:12px">Davan Institute of Advanced Management Studies, Davangere</p>
                        </div>
                    </div>
                    <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:10px;margin-bottom:14px">
                        <div style="background:rgba(255,255,255,0.08);border-radius:8px;padding:10px 14px;border-left:3px solid #ffd700">
                            <p style="color:#ffd700;font-size:11px;font-weight:700;margin:0 0 3px;text-transform:uppercase;letter-spacing:1px">Competition</p>
                            <p style="color:#fff;font-size:13px;margin:0">11 Teams competing across 16 Events</p>
                        </div>
                        <div style="background:rgba(255,255,255,0.08);border-radius:8px;padding:10px 14px;border-left:3px solid #c44569">
                            <p style="color:#ff8ab0;font-size:11px;font-weight:700;margin:0 0 3px;text-transform:uppercase;letter-spacing:1px">Event Period</p>
                            <p style="color:#fff;font-size:13px;margin:0">1st to 18th March 2026</p>
                        </div>
                        <div style="background:rgba(255,255,255,0.08);border-radius:8px;padding:10px 14px;border-left:3px solid #4caf50">
                            <p style="color:#a5d6a7;font-size:11px;font-weight:700;margin:0 0 3px;text-transform:uppercase;letter-spacing:1px">Points Sources</p>
                            <p style="color:#fff;font-size:13px;margin:0">YF Reg Â· Quiz Â· Event Results Â· Custom</p>
                        </div>
                        <div style="background:rgba(255,255,255,0.08);border-radius:8px;padding:10px 14px;border-left:3px solid #2196f3">
                            <p style="color:#90caf9;font-size:11px;font-weight:700;margin:0 0 3px;text-transform:uppercase;letter-spacing:1px">Declared By</p>
                            <p style="color:#fff;font-size:13px;margin:0">Super Admin Â· Spurthi Youth Fest Committee</p>
                        </div>
                    </div>
                    <p style="color:rgba(255,255,255,0.6);font-size:12px;margin:0;border-top:1px solid rgba(255,255,255,0.12);padding-top:10px">
                        âš ï¸ The leaderboard is <strong style="color:#ffd700">hidden from students</strong> until you publish it. Use the visibility toggle below to go live when results are final.
                    </p>
                </div>

                <p style="color:#555;margin-bottom:15px;font-size:13px;background:#fff3cd;padding:10px 16px;border-radius:8px;border-left:4px solid #ffc107">
                    âš™ï¸ Control what counts toward <strong style="color:#c44569">Class of the Year 2026</strong>. 
                    Event results are pulled automatically when published. You can also add custom criteria and assign points manually.
                </p>

                <!-- â”€â”€ PUBLISH TOGGLE â”€â”€ -->
                <div style="background:linear-gradient(135deg,#1a0030 0%,#6a1b9a 100%);padding:20px;border-radius:12px;margin-bottom:25px;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:15px">
                    <div>
                        <h3 style="color:#fff;margin:0 0 5px">ðŸ‘ Leaderboard Visibility</h3>
                        <p style="color:rgba(255,255,255,0.75);margin:0;font-size:13px">When hidden, students cannot see the leaderboard at all. Publish only when you are ready.</p>
                    </div>
                    <div style="display:flex;gap:10px;align-items:center">
                        <span id="lbVisibilityStatus" style="color:#ffd700;font-weight:700;font-size:1em">â³ Checkingâ€¦</span>
                        <button id="lbPublishBtn" class="btn btn-success" onclick="toggleLeaderboardPublish()" style="min-width:160px">ðŸ“¢ Publish Leaderboard</button>
                    </div>
                </div>

                <div id="lbAdminMessage" class="message"></div>

                <!-- â”€â”€ SECTION 1: Scoring Config â”€â”€ -->
                <div style="background:#f9f5ff;padding:20px;border-radius:12px;margin-bottom:25px;border:2px solid #e0d0ff">
                    <h3 style="color:#6a1b9a;margin-bottom:15px">âš™ï¸ Base Scoring Configuration</h3>
                    <p style="color:#666;font-size:13px;margin-bottom:15px">These values control how automatic points are calculated. Changes save instantly and affect the public leaderboard.</p>
                    <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:15px">
                        <div class="form-group" style="margin:0">
                            <label>ðŸŽ¤ Youthfest Reg: pts per event enrolled</label>
                            <input type="number" id="lbCfgYfPts" value="10" min="0" max="1000" style="border:2px solid #c44569">
                        </div>
                        <div class="form-group" style="margin:0">
                            <label>ðŸ† Youthfest Winner: pts per event win</label>
                            <input type="number" id="lbCfgWinPts" value="50" min="0" max="1000" style="border:2px solid #ffc107">
                        </div>
                        <div class="form-group" style="margin:0">
                            <label>ðŸ¥ˆ Youthfest Runner-Up: pts per event</label>
                            <input type="number" id="lbCfgRunPts" value="30" min="0" max="1000" style="border:2px solid #6c757d">
                        </div>
                    </div>

                    <!-- Quiz-specific scoring (new) -->
                    <div style="margin-top:18px;padding:15px;background:#e8f5e9;border-radius:10px;border:2px solid #a5d6a7">
                        <h4 style="color:#1b5e20;margin-bottom:12px">ðŸ§  Quiz Competition â€” Points per Daily Quiz Day</h4>
                        <p style="color:#333;font-size:12px;margin-bottom:14px">
                            Quiz points are awarded <strong>per published quiz day only</strong> (Super Admin must publish winner).<br>
                            Three criteria combine for each class on each published day:
                        </p>
                        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px">
                            <div class="form-group" style="margin:0">
                                <label style="color:#1b5e20">ðŸ¥‡ Quiz Daily Winner class gets (pts)</label>
                                <input type="number" id="lbCfgQuizWinPts" value="20" min="0" max="500" style="border:2px solid #4caf50">
                                <small style="color:#333">Flat bonus to the class of the declared daily winner</small>
                            </div>
                            <div class="form-group" style="margin:0">
                                <label style="color:#1b5e20">ðŸ¥ˆ Quiz Daily Runner-Up class gets (pts)</label>
                                <input type="number" id="lbCfgQuizRunPts" value="10" min="0" max="500" style="border:2px solid #81c784">
                                <small style="color:#333">Flat bonus to the class of the declared runner-up</small>
                            </div>
                            <div class="form-group" style="margin:0">
                                <label style="color:#1b5e20">ðŸ“Š Participation Rate bonus: max pts for 100% rate</label>
                                <input type="number" id="lbCfgQuizMaxPts" value="10" min="0" max="100" style="border:2px solid #66bb6a">
                                <small style="color:#333">Fair across class sizes â€” based on % of class that got max score</small>
                            </div>
                        </div>

                        <!-- Class strength setup -->
                        <div style="margin-top:14px;background:white;padding:14px;border-radius:8px;border:1px solid #a5d6a7">
                            <h5 style="color:#1b5e20;margin:0 0 10px">ðŸ« Set Class Strength (for fair participation rate)</h5>
                            <p style="color:#333;font-size:12px;margin-bottom:12px">
                                Enter the total number of students in each class. The participation rate bonus is calculated as:<br>
                                <strong style="color:#1b5e20">(Number of students who got max score in class Ã· Class Strength) Ã— Max Pts</strong><br>
                                This means a class of 35 and a class of 60 are judged equally fairly.
                            </p>
                            <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:8px" id="lbClassStrengthGrid">
                                <p style="color:#aaa;font-size:12px">Loadingâ€¦</p>
                            </div>
                            <div style="display:flex;align-items:center;gap:12px;flex-wrap:wrap;margin-top:10px">
                                <button class="btn btn-small btn-info" onclick="saveLbClassStrengths()">ðŸ’¾ Save Class Strengths</button>
                                <span id="lbStrSaveMsg" style="display:none;background:#d4edda;color:#155724;border:1px solid #c3e6cb;padding:7px 14px;border-radius:6px;font-size:13px;font-weight:600">âœ… Class strengths saved!</span>
                                <span id="lbStrErrMsg"  style="display:none;background:#f8d7da;color:#721c24;border:1px solid #f5c6cb;padding:7px 14px;border-radius:6px;font-size:13px;font-weight:600"></span>
                            </div>
                        </div>

                        <div style="margin-top:12px;background:#f1f8e9;padding:10px;border-radius:8px;border:1px solid #c5e1a5">
                            <p style="margin:0;color:#33691e;font-size:12px">
                                <strong>Example:</strong> Class "2ND BBA" has strength 35. On a quiz day, 7 students score max (2/2).<br>
                                Participation rate = 7/35 = 20%. Bonus = 20% Ã— 10 = <strong>2 pts</strong>.<br>
                                Class "1ST BCA" has strength 60. 12 students score max = 12/60 = 20% â†’ same 2 pts. âœ… Fair!
                            </p>
                        </div>
                    </div>
                    <!-- Scavenger Hunt scoring -->
                    <div style="margin-top:18px;padding:15px;background:#f3e5f5;border-radius:10px;border:2px solid #ce93d8">
                        <h4 style="color:#6a1b9a;margin-bottom:12px">ðŸ—ºï¸ Scavenger Hunt â€” Points</h4>
                        <p style="color:#444;font-size:12px;margin-bottom:14px">
                            Points are awarded automatically from Firebase data when scavenger hunt submissions are approved.<br>
                            Three criteria combine: task completion rate per class, winner class bonus, runner-up class bonus.
                        </p>
                        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px">
                            <div class="form-group" style="margin:0">
                                <label style="color:#6a1b9a">ðŸ¥‡ SH Winner class gets (pts)</label>
                                <input type="number" id="lbCfgShWinPts" value="30" min="0" max="500" style="border:2px solid #9c27b0">
                                <small style="color:#555">Flat bonus to the class of the declared SH winner</small>
                            </div>
                            <div class="form-group" style="margin:0">
                                <label style="color:#6a1b9a">ðŸ¥ˆ SH Runner-Up class gets (pts)</label>
                                <input type="number" id="lbCfgShRunPts" value="15" min="0" max="500" style="border:2px solid #ab47bc">
                                <small style="color:#555">Flat bonus to the class of the declared runner-up</small>
                            </div>
                            <div class="form-group" style="margin:0">
                                <label style="color:#6a1b9a">âœ… Per approved task (pts per task per student)</label>
                                <input type="number" id="lbCfgShTaskPts" value="5" min="0" max="100" style="border:2px solid #ba68c8">
                                <small style="color:#555">Each approved task earns this many pts for the student's class</small>
                            </div>
                            <div class="form-group" style="margin:0">
                                <label style="color:#6a1b9a">ðŸ Full completion bonus (pts per student who finishes all)</label>
                                <input type="number" id="lbCfgShCompletePts" value="20" min="0" max="500" style="border:2px solid #ce93d8">
                                <small style="color:#555">Bonus for each student who gets ALL tasks approved</small>
                            </div>
                        </div>
                        <div style="margin-top:12px;background:#ede7f6;padding:10px;border-radius:8px;border:1px solid #ce93d8">
                            <p style="margin:0;color:#4a148c;font-size:12px">
                                <strong>Example:</strong> 3rd B.Com has 5 students each completing 4 tasks = 5Ã—4Ã—5 = <strong>100 pts</strong>. 
                                2 students finish all 6 tasks = 2Ã—20 = <strong>40 bonus pts</strong>. 
                                If their class wins = +30 pts. Total SH contribution = <strong>170 pts</strong> ðŸŽ‰
                            </p>
                        </div>
                    </div>

                    <!-- Speed Slide Challenge scoring -->
                    <div style="margin-top:18px;padding:15px;background:#e3f2fd;border-radius:10px;border:2px solid #90caf9">
                        <h4 style="color:#0d47a1;margin-bottom:12px">ðŸ§© Speed Slide Challenge â€” Points</h4>
                        <p style="color:#444;font-size:12px;margin-bottom:14px">
                            Points are awarded based on each student's best approved puzzle score (0â€“300 depending on difficulty).<br>
                            Each student's best score contributes directly to their class total â€” no winner/runner-up bonuses, purely performance-based.
                        </p>
                        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px">
                            <div class="form-group" style="margin:0">
                                <label style="color:#0d47a1">ðŸ“ Score contribution factor (leaderboard pts per 10 game pts)</label>
                                <input type="number" id="lbCfgSscScorePts" value="1" min="0" max="20" style="border:2px solid #64b5f6">
                                <small style="color:#555">Each student's best score Ã· 10 Ã— factor = class pts<br>Easy max 100â†’10pts Â· Medium 200â†’20pts Â· Hard 300â†’30pts</small>
                            </div>
                        </div>
                        <div style="margin-top:12px;background:#e1f5fe;padding:10px;border-radius:8px;border:1px solid #81d4fa">
                            <p style="margin:0;color:#01579b;font-size:12px">
                                <strong>Example (Factor = 1):</strong> 1ST BCA has 3 students: one scores 300 (Hard) = 30pts, one 200 (Medium) = 20pts, one 100 (Easy) = 10pts.<br>
                                Class total from SSC = <strong>60 pts</strong>. Every student's score counts â€” harder puzzles earn more! ðŸŽ¯
                            </p>
                        </div>
                    </div>

                    <div style="display:flex;align-items:center;gap:12px;flex-wrap:wrap;margin-top:15px">
                        <button class="btn btn-success" onclick="saveLbConfig()">ðŸ’¾ Save Config</button>
                        <span id="lbCfgSaveMsg" style="display:none;background:#d4edda;color:#155724;border:1px solid #c3e6cb;padding:7px 14px;border-radius:6px;font-size:13px;font-weight:600">âœ… Config saved! Leaderboard updates in â‰¤60s</span>
                        <span id="lbCfgErrMsg"  style="display:none;background:#f8d7da;color:#721c24;border:1px solid #f5c6cb;padding:7px 14px;border-radius:6px;font-size:13px;font-weight:600"></span>
                    </div>
                </div>

                <!-- â”€â”€ SECTION 2: Published Results Impact â”€â”€ -->
                <div style="background:#f0fff4;padding:20px;border-radius:12px;margin-bottom:25px;border:2px solid #b2dfdb">
                    <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:10px;margin-bottom:15px">
                        <h3 style="color:#155724;margin:0">ðŸ“¢ Published Event Results â†’ Points</h3>
                        <button class="btn btn-small btn-info" onclick="loadLbPublishedResults()">ðŸ”„ Refresh</button>
                    </div>
                    <p style="color:#555;font-size:13px;margin-bottom:15px">
                        When you publish results for a Youthfest event, the winning class gets <strong id="lbWinPtsDisplay">50</strong> pts 
                        and runner-up gets <strong id="lbRunPtsDisplay">30</strong> pts automatically on the leaderboard.<br>
                        For the <strong>Quiz Competition</strong>, quiz points (winner class, runner-up class, max-correct bonus) are added 
                        automatically each day you publish a quiz winner.
                    </p>
                    <div id="lbPublishedResultsList">
                        <p style="color:#aaa;font-size:13px">Click Refresh to load published resultsâ€¦</p>
                    </div>
                </div>

                <!-- â”€â”€ SECTION 3: Custom Criteria â”€â”€ -->
                <div style="background:#fff8e1;padding:20px;border-radius:12px;margin-bottom:25px;border:2px solid #ffe082">
                    <h3 style="color:#e65100;margin-bottom:8px">âœ¨ Custom Criteria (Manual Points)</h3>
                    <p style="color:#666;font-size:13px;margin-bottom:15px">
                        Add any extra scoring category (e.g., "Best Dressed Class", "Punctuality", "Attendance") and assign points per class manually.
                    </p>

                    <!-- Add new criterion -->
                    <div style="background:white;padding:15px;border-radius:8px;margin-bottom:15px;border:1px solid #ffe082">
                        <h4 style="color:#856404;margin-bottom:12px">âž• Add New Criterion</h4>
                        <div style="display:grid;grid-template-columns:1fr auto;gap:10px;align-items:end">
                            <div class="form-group" style="margin:0">
                                <label>Criterion Name:</label>
                                <input type="text" id="lbNewCriterionName" placeholder="e.g., Best Decorated Class, Punctualityâ€¦">
                            </div>
                            <button class="btn btn-small" onclick="addLbCriterion()" style="height:46px;white-space:nowrap">+ Add</button>
                        </div>
                    </div>

                    <!-- Existing criteria list -->
                    <div id="lbCriteriaList">
                        <p style="color:#aaa;font-size:13px;text-align:center;padding:20px">Loading custom criteriaâ€¦</p>
                    </div>
                </div>

                <!-- â”€â”€ SECTION 4: Full Points Preview â”€â”€ -->
                <div style="background:linear-gradient(135deg,#1a0030 0%,#3d0060 100%);padding:20px;border-radius:12px;border:2px solid rgba(255,215,0,0.3)">
                    <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:10px;margin-bottom:8px">
                        <h3 style="color:#ffd700;margin:0">ðŸ‘ Live Points Preview (All Sources)</h3>
                        <div style="display:flex;gap:8px;align-items:center">
                            <span id="lbPreviewUpdated" style="color:rgba(255,255,255,0.5);font-size:11px"></span>
                            <button class="btn btn-small btn-info" onclick="loadLbAdminPreview()">ðŸ”„ Refresh</button>
                        </div>
                    </div>
                    <p style="color:rgba(255,255,255,0.6);font-size:12px;margin-bottom:15px">âš ï¸ This is exactly what the public leaderboard will show. Verify before publishing.</p>
                    <div id="lbAdminPreview">
                        <p style="color:rgba(255,255,255,0.4);text-align:center;padding:20px">Loading previewâ€¦</p>
                    </div>
                </div>
            </div>
        </div>
        <!-- â”€â”€ End Leaderboard Admin Panel â”€â”€ -->

        <!-- Jury Section -->
        <div class="jury-only" id="jurySection">
            <button class="btn btn-secondary" onclick="logout()" style="float:right">Logout</button>
            
            <div class="content">
                <h2 style="color:#c44569;margin-bottom:20px" id="juryEventTitle">Jury Evaluation Sheet</h2>
                <p style="margin-bottom:20px;color:#666" id="juryInfo"></p>
                
                <div id="juryMessage" class="message"></div>
                
                <div style="margin-bottom:20px;text-align:center">
                    <button class="btn btn-info" onclick="loadJurySheet()" style="margin-right:10px">ðŸ”„ Reload Sheet</button>
                    <button class="btn btn-secondary" onclick="showEnrollmentDebugProtected()">ðŸ“Š Show Enrollments</button>
                </div>
                
                <div id="jurySheetContainer"></div>
                
                <div style="margin-top:30px;text-align:center">
                    <button class="btn btn-success" onclick="saveMarks()">ðŸ’¾ Save Marks</button>
                    <button class="btn btn-info" onclick="markAsCompleted()" style="margin-left:10px">âœ… Mark as Completed</button>
                </div>
            </div>
        </div>
        
        <!-- ============================================ -->
        <!-- DAILY QUIZ COMPETITION SYSTEM                -->
        <!-- ============================================ -->
        
        <!-- Quiz Student Dashboard -->
        
        <!-- Quiz Admin Dashboard -->
        <!-- Regular Quiz Admin Dashboard REMOVED - Only Super Admin Dashboard is used -->
    </div>

        <!-- ============================================ -->
        <!-- QUIZ & SCAVENGER DASHBOARDS (outside adminSection) -->
        <!-- ============================================ -->
        <div id="quizStudentDashboard" style="display:none">
            <!-- Login success banner -->
            <div style="background:linear-gradient(135deg,#28a745,#20c997);color:white;padding:16px 24px;border-radius:12px;margin-bottom:16px;text-align:center;font-size:1.2em;font-weight:700;box-shadow:0 4px 15px rgba(40,167,69,0.4)">
                âœ… Logged In Successfully â€” Daily Quiz Competition
            </div>
            <!-- Fixed header bar -->
            <div style="background:linear-gradient(135deg,#6a1b9a,#c44569);padding:16px 20px;border-radius:12px;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:10px;margin-bottom:20px;box-shadow:0 4px 15px rgba(0,0,0,0.2)">
                <h2 style="color:#fff;margin:0;font-size:clamp(1em,3vw,1.4em);display:flex;align-items:center;gap:10px;text-shadow:1px 1px 3px rgba(0,0,0,0.5)">
                    ðŸŽ“ <span>Daily Quiz Competition</span>
                    <span id="quizStudentNameBadge" class="badge" style="background:#28a745;color:white;padding:6px 14px;border-radius:20px;font-size:0.75em;white-space:nowrap"></span>
                </h2>
                <button class="btn btn-secondary" onclick="logout()" style="white-space:nowrap;flex-shrink:0">Logout</button>
            </div>
            <div id="quizStudentMessage" class="message"></div>
            
            <div class="content">
                <h3 style="color:#6a1b9a;margin-bottom:8px">Welcome, <span id="quizStudentName"></span>!</h3>
                <p style="margin-bottom:16px"><strong>Email:</strong> <span id="quizStudentEmail"></span> | <strong>Class:</strong> <span id="quizStudentClass"></span></p>

                <!-- Live Date & Time Banner -->
                <div style="background:linear-gradient(135deg,#6a1b9a 0%,#c44569 100%);border-radius:12px;padding:16px 20px;margin-bottom:22px;display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:12px;box-shadow:0 4px 15px rgba(106,27,154,0.3)">
                    <div style="display:flex;align-items:center;gap:12px;flex-wrap:wrap">
                        <div style="text-align:center;background:rgba(255,255,255,0.15);border-radius:10px;padding:10px 16px;min-width:80px">
                            <div style="color:rgba(255,255,255,0.75);font-size:10px;text-transform:uppercase;letter-spacing:1px;margin-bottom:3px">Day</div>
                            <div id="quizLiveDay" style="color:#fff;font-size:1.2em;font-weight:700"></div>
                        </div>
                        <div style="text-align:center;background:rgba(255,255,255,0.15);border-radius:10px;padding:10px 16px;min-width:110px">
                            <div style="color:rgba(255,255,255,0.75);font-size:10px;text-transform:uppercase;letter-spacing:1px;margin-bottom:3px">Date</div>
                            <div id="quizLiveDate" style="color:#ffd700;font-size:1.05em;font-weight:700"></div>
                        </div>
                        <div style="text-align:center;background:rgba(255,255,255,0.15);border-radius:10px;padding:10px 16px;min-width:95px">
                            <div style="color:rgba(255,255,255,0.75);font-size:10px;text-transform:uppercase;letter-spacing:1px;margin-bottom:3px">Time</div>
                            <div id="quizLiveTime" style="color:#a5ffb8;font-size:1.2em;font-weight:700;letter-spacing:1px"></div>
                        </div>
                    </div>
                    <div id="quizLiveAmPm" style="color:rgba(255,255,255,0.85);font-size:0.85em;font-weight:600;text-align:right;line-height:1.6"></div>
                </div>

                <div id="quizStatusSection">
                    <div style="background:#fff3cd;padding:20px;border-radius:12px;margin-bottom:25px;border-left:5px solid #ffc107">
                        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:15px">
                            <h3 style="color:#856404;margin:0">ðŸ“… Today's Quiz Status</h3>
                            <button class="btn btn-info btn-small" onclick="checkQuizTodayStatus()" style="font-size:0.9em">ðŸ”„ Refresh Status</button>
                        </div>
                        <div id="quizStatus"></div>
                    </div>
                    
                    <div id="quizStartSection" style="display:none">
                        <div style="background:linear-gradient(135deg,#ff6b6b 0%,#ee5a6f 100%);color:white;padding:20px;border-radius:10px;margin-bottom:25px">
                            <h3 style="margin-bottom:10px">âš ï¸ Anti-Cheating Rules</h3>
                            <ul style="line-height:1.8;margin-left:20px">
                                <li>Do NOT refresh the page</li>
                                <li>Do NOT press back button</li>
                                <li>Do NOT switch tabs or minimize browser</li>
                                <li>Quiz will AUTO-SUBMIT if rules violated</li>
                                <li>You get ONE attempt per day only</li>
                            </ul>
                        </div>
                        <button class="btn btn-success" onclick="startQuiz()" style="font-size:1.2em;padding:18px">ðŸš€ Start Today's Quiz</button>
                    </div>
                    
                    <div id="quizCompletedSection" style="display:none">
                        <div class="message success show">
                            <strong>âœ… Quiz Completed!</strong> You have successfully submitted today's quiz. Results will be announced soon.
                        </div>
                        <div style="background:#f3e5f5;border:2px solid #9c27b0;border-radius:12px;padding:18px 22px;margin-top:16px">
                            <h4 style="color:#6a1b9a;margin:0 0 12px 0;font-size:1.05em">&#128197; Next Quiz Schedule</h4>
                            <div style="display:flex;flex-wrap:wrap;gap:12px">
                                <div style="background:white;border-radius:8px;padding:10px 18px;flex:1;min-width:150px;border-left:4px solid #4caf50;text-align:center">
                                    <div style="color:#666;font-size:0.78em;text-transform:uppercase;letter-spacing:1px;margin-bottom:4px">Next Quiz Starts At</div>
                                    <div style="color:#2e7d32;font-weight:800;font-size:1.1em" id="nextQuizStartTime">Loading...</div>
                                </div>
                                <div style="background:white;border-radius:8px;padding:10px 18px;flex:1;min-width:150px;border-left:4px solid #f44336;text-align:center">
                                    <div style="color:#666;font-size:0.78em;text-transform:uppercase;letter-spacing:1px;margin-bottom:4px">Next Quiz Ends At</div>
                                    <div style="color:#c62828;font-weight:800;font-size:1.1em" id="nextQuizEndTime">Loading...</div>
                                </div>
                                <div style="background:white;border-radius:8px;padding:10px 18px;flex:1;min-width:150px;border-left:4px solid #9c27b0;text-align:center">
                                    <div style="color:#666;font-size:0.78em;text-transform:uppercase;letter-spacing:1px;margin-bottom:4px">Starts In</div>
                                    <div style="color:#6a1b9a;font-weight:800;font-size:1.1em" id="nextQuizCountdown">--:--:--</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div id="quizResultsSection" style="display:none">
                        <h3 style="color:#667eea;margin-top:20px">ðŸ“Š Your Results</h3>
                        <div id="quizStudentResults"></div>
                    </div>
                </div>
            </div>
        </div>

        <div id="shStudentDashboard" style="display:none">
            <!-- Login success banner -->
            <div style="background:linear-gradient(135deg,#9c27b0,#e91e63);color:white;padding:16px 24px;border-radius:12px;margin-bottom:16px;display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:10px;box-shadow:0 4px 15px rgba(156,39,176,0.4)">
                <span style="font-size:1.2em;font-weight:700">âœ… Logged In Successfully â€” Scavenger Hunt</span>
                <button onclick="shGoBack()" style="background:rgba(255,255,255,0.2);color:white;border:2px solid rgba(255,255,255,0.6);padding:8px 18px;border-radius:20px;cursor:pointer;font-size:0.85em;font-weight:700;display:flex;align-items:center;gap:6px;white-space:nowrap;transition:all 0.2s" onmouseover="this.style.background='rgba(255,255,255,0.35)'" onmouseout="this.style.background='rgba(255,255,255,0.2)'">â¬…ï¸ Go Back</button>
            </div>
            <!-- Header -->
            <div style="background:linear-gradient(135deg,#9c27b0,#e91e63);padding:16px 20px;border-radius:12px;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:10px;margin-bottom:20px;box-shadow:0 4px 15px rgba(0,0,0,0.2)">
                <h2 style="color:#fff;margin:0;font-size:clamp(1em,3vw,1.4em);display:flex;align-items:center;gap:10px;text-shadow:1px 1px 3px rgba(0,0,0,0.5)">
                    ðŸ—ºï¸ <span>Scavenger Hunt</span>
                    <span id="shStudentBadge" class="badge" style="background:#fff;color:#9c27b0;padding:6px 14px;border-radius:20px;font-size:0.75em;white-space:nowrap"></span>
                </h2>
                <button class="btn btn-secondary" onclick="shLogout()" style="white-space:nowrap;flex-shrink:0">Logout</button>
            </div>

            <div class="content">
                <h3 style="color:#6a1b9a;margin-bottom:6px">Welcome, <span id="shStudentName"></span>!</h3>
                <p style="margin-bottom:18px;color:#666"><strong>Class:</strong> <span id="shStudentClass"></span></p>

                <!-- Hunt not active message -->
                <div id="shNotActiveMsg" style="display:none;background:#fff3e0;padding:20px;border-radius:12px;border-left:5px solid #ff9800;margin-bottom:20px">
                    <h4 style="color:#e65100;margin-bottom:6px">â³ Hunt Not Active Yet</h4>
                    <p style="color:#bf360c;margin:0">The Scavenger Hunt has not started yet. Check back soon!</p>
                </div>

                <!-- Progress -->
                <div id="shProgressSection" style="display:none">
                    <div style="background:linear-gradient(135deg,#9c27b0,#e91e63);color:white;border-radius:14px;padding:18px 22px;margin-bottom:20px">
                        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;flex-wrap:wrap;gap:8px">
                            <span style="font-weight:700;font-size:1.1em">ðŸ† Your Progress</span>
                            <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap">
                                <span id="shProgressText" style="font-size:1.3em;font-weight:800"></span>
                                <button onclick="shRefreshStatus()" id="shRefreshBtn" style="background:rgba(255,255,255,0.25);color:white;border:2px solid rgba(255,255,255,0.6);padding:6px 14px;border-radius:20px;cursor:pointer;font-size:0.85em;font-weight:700;display:flex;align-items:center;gap:5px">ðŸ”„ Check Status</button>
                            </div>
                        </div>
                        <div id="shLastRefreshed" style="font-size:0.75em;opacity:0.75;margin-bottom:6px"></div>
                        <div class="sh-progress-bar-wrap" style="background:rgba(255,255,255,0.3)">
                            <div class="sh-progress-bar" id="shProgressBar" style="width:0%;background:white"></div>
                        </div>
                        <div style="display:flex;gap:12px;margin-top:12px;flex-wrap:wrap">
                            <span style="font-size:0.85em;opacity:0.9">âœ… <span id="shCompletedCount">0</span> Completed</span>
                            <span style="font-size:0.85em;opacity:0.9">â³ <span id="shPendingCount">0</span> Pending Review</span>
                            <span style="font-size:0.85em;opacity:0.9">ðŸ”’ <span id="shLockedCount">0</span> Locked</span>
                        </div>
                    </div>

                    <!-- GPS Status -->
                    <div id="shGpsStatus" style="background:#e0f7fa;border:2px solid #00bcd4;border-radius:10px;padding:12px 16px;margin-bottom:18px;display:flex;align-items:center;gap:10px;flex-wrap:wrap">
                        <span class="sh-gps-badge">ðŸ“ GPS</span>
                        <span id="shGpsStatusText" style="color:#006064;font-size:0.9em;flex:1">Requesting location access...</span>
                        <button onclick="shGetLocation(); shRefreshStatus();" style="background:#00bcd4;color:white;border:none;padding:6px 14px;border-radius:20px;cursor:pointer;font-size:0.85em;font-weight:600">ðŸ”„ Refresh</button>
                    </div>

                    <!-- Tasks -->
                    <div id="shTasksList"></div>
                </div>

                <!-- Completed all tasks! -->
                <div id="shAllDoneSection" style="display:none;text-align:center;padding:30px 20px">
                    <div style="font-size:4em;margin-bottom:16px">ðŸŽ‰</div>
                    <h2 style="color:#4caf50;margin-bottom:10px">All Tasks Completed!</h2>
                    <p style="color:#666;font-size:1.1em">Amazing! You have completed all tasks. Wait for the results announcement!</p>
                </div>
            </div>
        </div>

        <div id="quizPage" style="display:none">
            <div class="quiz-timer-box" id="quizTimer">
                â±ï¸ <span id="quizTimerValue">00:00</span>
            </div>
            
            <div class="content">
                <h2 style="color:#c44569;text-align:center;margin-bottom:10px;font-size:2em">ðŸ“ Daily Quiz Competition</h2>
                <p id="quizDateDisplay" style="text-align:center;color:#667eea;font-weight:600;margin-bottom:30px;font-size:1.2em"></p>
                <div id="quizPageMessage" class="message"></div>
                
                <div id="quizQuestionsContainer"></div>
                
                <button class="quiz-submit-btn" onclick="submitQuizAnswers()">
                    âœ… Submit Quiz
                </button>
            </div>
        </div>


        <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
        <!-- SPEED SLIDE CHALLENGE â€” PLAYER DASHBOARD                  -->
        <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
        <div id="sscStudentDashboard" style="display:none">

            <!-- Header bar -->
            <div style="background:linear-gradient(135deg,#1a0030 0%,#4a148c 50%,#c44569 100%);color:white;padding:18px 24px;border-radius:16px;margin-bottom:18px;display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:12px;box-shadow:0 8px 28px rgba(106,27,154,0.5),0 0 0 1px rgba(255,255,255,.08)">
                <div style="display:flex;align-items:center;gap:14px;flex-wrap:wrap">
                    <span style="font-size:1.5em;font-weight:800;letter-spacing:.5px;text-shadow:0 2px 8px rgba(0,0,0,.3)">ðŸ§© Speed Slide Challenge</span>
                    <span id="sscPlayerBadge" style="background:rgba(255,255,255,.15);padding:6px 16px;border-radius:20px;font-size:.83em;font-weight:700;border:1px solid rgba(255,255,255,.2);backdrop-filter:blur(4px)"></span>
                </div>
                <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
                    <button onclick="sscShowSection('play')" id="sscTabPlay" style="background:rgba(255,255,255,.92);color:#4a148c;border:none;padding:9px 20px;border-radius:22px;cursor:pointer;font-weight:800;font-size:.88em;transition:all .2s;box-shadow:0 3px 10px rgba(0,0,0,.2)">ðŸŽ® Play</button>
                    <button onclick="sscShowSection('lb')" id="sscTabLB" style="background:rgba(255,255,255,.15);color:white;border:2px solid rgba(255,255,255,.4);padding:9px 20px;border-radius:22px;cursor:pointer;font-weight:700;font-size:.88em;transition:all .2s">ðŸ† Leaderboard</button>
                    <button onclick="sscGoBack()" style="background:rgba(255,255,255,.1);color:white;border:1px solid rgba(255,255,255,.3);padding:9px 18px;border-radius:22px;cursor:pointer;font-weight:600;font-size:.83em;transition:all .2s">â¬…ï¸ Back</button>
                    <button onclick="logout()" style="background:rgba(0,0,0,.3);color:rgba(255,255,255,.85);border:none;padding:9px 18px;border-radius:22px;cursor:pointer;font-weight:600;font-size:.83em;transition:all .2s">Logout</button>
                </div>
            </div>

            <!-- PLAY SECTION -->
            <div id="sscPlaySection" class="content" style="margin-bottom:20px;background:linear-gradient(160deg,#faf0ff 0%,#fff5fb 100%);border:1px solid rgba(106,27,154,.1);box-shadow:0 8px 32px rgba(106,27,154,.08)">
                <div id="sscSetupCard">
                    <!-- Paused banner -->
                    <div id="sscPausedBanner" style="display:none;background:linear-gradient(135deg,#fff3e0,#ffe0b2);border:2px solid #ff9800;border-radius:12px;padding:18px 22px;margin-bottom:22px;border-left:6px solid #ff6f00">
                        <h4 style="color:#e65100;margin:0 0 6px;font-size:1.05em">â¸ï¸ Game Currently Paused</h4>
                        <p style="color:#bf360c;margin:0;font-size:.9em">The organiser has temporarily paused the Speed Slide Challenge. You can still view the Leaderboard. Check back soon!</p>
                    </div>

                    <!-- Title -->
                    <div style="text-align:center;margin-bottom:28px">
                        <div style="font-size:3em;margin-bottom:6px">ðŸ§©</div>
                        <h2 style="color:#4a148c;margin:0;font-size:1.9em;font-weight:900;letter-spacing:-.5px">New Game</h2>
                        <p style="color:#9c27b0;margin:6px 0 0;font-size:.95em;font-weight:500">Choose your difficulty and upload a photo to begin</p>
                    </div>

                    <!-- Step 1: Difficulty -->
                    <div style="margin-bottom:24px">
                        <div style="display:flex;align-items:center;gap:10px;margin-bottom:16px">
                            <div style="background:linear-gradient(135deg,#6a1b9a,#c44569);color:white;width:30px;height:30px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:800;font-size:.95em;flex-shrink:0">1</div>
                            <h3 style="color:#333;margin:0;font-size:1.05em;font-weight:700">Choose Difficulty</h3>
                        </div>
                        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:14px;margin-bottom:10px">
                            <div id="ssdc-easy" onclick="sscSelectDiff('easy')" class="ssc-diff-card">
                                <div class="diff-emoji">ðŸ˜Š</div>
                                <div style="font-weight:800;color:#333;margin-top:8px;font-size:1.1em">8-Puzzle</div>
                                <div style="font-size:.8em;color:#999;margin-top:4px">3Ã—3 grid Â· 8 tiles</div>
                                <div style="font-size:.75em;color:#888;margin-top:2px">Beginner</div>
                                <span style="display:inline-block;background:linear-gradient(135deg,#43a047,#66bb6a);color:white;padding:5px 16px;border-radius:14px;font-size:.82em;font-weight:800;margin-top:10px;letter-spacing:.3px">100 pts max</span>
                            </div>
                            <div id="ssdc-medium" onclick="sscSelectDiff('medium')" class="ssc-diff-card ssc-selected">
                                <div class="diff-emoji">ðŸ˜„</div>
                                <div style="font-weight:800;color:#333;margin-top:8px;font-size:1.1em">15-Puzzle</div>
                                <div style="font-size:.8em;color:#999;margin-top:4px">4Ã—4 grid Â· 15 tiles</div>
                                <div style="font-size:.75em;color:#9c27b0;margin-top:2px;font-weight:700">â­ Popular</div>
                                <span style="display:inline-block;background:linear-gradient(135deg,#6a1b9a,#c44569);color:white;padding:5px 16px;border-radius:14px;font-size:.82em;font-weight:800;margin-top:10px;letter-spacing:.3px">200 pts max</span>
                            </div>
                            <div id="ssdc-hard" onclick="sscSelectDiff('hard')" class="ssc-diff-card">
                                <div class="diff-emoji">ðŸ”¥</div>
                                <div style="font-weight:800;color:#333;margin-top:8px;font-size:1.1em">24-Puzzle</div>
                                <div style="font-size:.8em;color:#999;margin-top:4px">5Ã—5 grid Â· 24 tiles</div>
                                <div style="font-size:.75em;color:#e65100;margin-top:2px;font-weight:700">ðŸ”¥ Expert</div>
                                <span style="display:inline-block;background:linear-gradient(135deg,#e65100,#ff6f00);color:white;padding:5px 16px;border-radius:14px;font-size:.82em;font-weight:800;margin-top:10px;letter-spacing:.3px">300 pts max</span>
                            </div>
                        </div>
                        <div style="background:rgba(106,27,154,.06);border-radius:10px;padding:10px 14px;border-left:3px solid #9c27b0">
                            <p id="sscDiffNote" style="color:#6a1b9a;font-size:.88em;margin:0;font-weight:600">15-Puzzle (4Ã—4) Â· 200 max points</p>
                        </div>
                    </div>

                    <!-- Step 2: Upload -->
                    <div style="margin-bottom:24px">
                        <div style="display:flex;align-items:center;gap:10px;margin-bottom:14px">
                            <div style="background:linear-gradient(135deg,#6a1b9a,#c44569);color:white;width:30px;height:30px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:800;font-size:.95em;flex-shrink:0">2</div>
                            <h3 style="color:#333;margin:0;font-size:1.05em;font-weight:700">Upload Your Photo</h3>
                        </div>
                        <div id="sscUploadZone" onclick="document.getElementById('sscImgInput').click()" class="ssc-upload-zone">
                            <div style="font-size:2.8em;margin-bottom:6px">ðŸ“¸</div>
                            <p style="color:#6a1b9a;font-weight:700;margin:0 0 4px;font-size:1.05em">Tap to upload a photo</p>
                            <p style="color:#bbb;font-size:.82em;margin:0">JPG / PNG Â· max 5 MB</p>
                            <img id="sscPreviewThumb" style="max-width:100%;max-height:180px;border-radius:12px;margin-top:14px;border:3px solid #4caf50;box-shadow:0 4px 16px rgba(0,0,0,.15);display:none" alt="">
                        </div>
                        <input type="file" id="sscImgInput" accept="image/*" style="display:none" onchange="sscHandleImage(event)">
                    </div>

                    <!-- Start button -->
                    <button id="sscStartBtn" onclick="sscStartGame()" disabled style="width:100%;padding:18px;background:linear-gradient(135deg,#1b5e20,#2e7d32,#43a047);color:white;border:none;border-radius:14px;font-size:1.2em;font-weight:800;cursor:pointer;opacity:.45;transition:all .3s;letter-spacing:.5px;box-shadow:0 6px 20px rgba(67,160,71,.4)">â–¶ &nbsp;Start Puzzle</button>
                </div>

                <!-- Live game area -->
                <div id="sscGameArea" style="display:none">
                    <!-- Top bar: diff label + buttons -->
                    <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:10px;margin-bottom:18px">
                        <div style="display:flex;align-items:center;gap:10px">
                            <span id="sscGameDiffLabel" style="background:linear-gradient(135deg,#6a1b9a,#c44569);color:white;padding:7px 18px;border-radius:20px;font-weight:800;font-size:.9em;letter-spacing:.3px"></span>
                            <span id="sscLiveScore" style="background:linear-gradient(135deg,#ffd700,#ffab00);color:#1a0030;padding:7px 18px;border-radius:20px;font-weight:900;font-size:.9em;display:none">â­ <span id="sscLiveScoreVal">â€”</span></span>
                        </div>
                        <div style="display:flex;gap:8px">
                            <button onclick="sscShowSolution()" style="background:#666;color:white;border:none;padding:8px 16px;border-radius:10px;cursor:pointer;font-weight:600;font-size:.85em;transition:all .2s">ðŸ‘ Give Up</button>
                            <button onclick="sscResetGame()" style="background:linear-gradient(135deg,#e53935,#ff7043);color:white;border:none;padding:8px 16px;border-radius:10px;cursor:pointer;font-weight:700;font-size:.85em;transition:all .2s">ðŸ”„ New Game</button>
                        </div>
                    </div>

                    <!-- Main game layout: board + stats -->
                    <div style="display:grid;grid-template-columns:1fr 140px;gap:16px;align-items:start">
                        <!-- Board -->
                        <div>
                            <div id="sscPuzzleBoard" style="display:grid;gap:5px;touch-action:none;user-select:none"></div>
                        </div>
                        <!-- Stats sidebar -->
                        <div style="display:flex;flex-direction:column;gap:10px">
                            <div class="ssc-stat-box" style="background:linear-gradient(135deg,#fff3e0,#ffe0b2);border:2px solid #ffb300">
                                <div id="sscTimerDisplay" class="ssc-stat-val" style="color:#e65100;font-family:monospace">0:00</div>
                                <div class="ssc-stat-lbl">â± Time</div>
                            </div>
                            <div class="ssc-stat-box" style="background:linear-gradient(135deg,#f3e5f5,#e1bee7);border:2px solid #9c27b0">
                                <div id="sscMovesDisplay" class="ssc-stat-val" style="color:#6a1b9a">0</div>
                                <div class="ssc-stat-lbl">ðŸŽ¯ Moves</div>
                            </div>
                            <div class="ssc-stat-box" style="background:linear-gradient(135deg,#1a0030,#3d0060);border:2px solid rgba(255,215,0,.3)">
                                <div id="sscPtsDisplay" class="ssc-stat-val" style="color:#ffd700">â€”</div>
                                <div class="ssc-stat-lbl" style="color:rgba(255,255,255,.6)">â­ Pts</div>
                            </div>
                            <div style="text-align:center">
                                <p style="font-size:.7em;color:#bbb;margin:0 0 5px;font-weight:600;text-transform:uppercase;letter-spacing:.5px">Preview</p>
                                <img id="sscInGamePreview" style="width:100%;border-radius:10px;border:3px solid rgba(106,27,154,.4);box-shadow:0 4px 12px rgba(0,0,0,.2);display:none" alt="">
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- LEADERBOARD SECTION -->
            <div id="sscLbSection" class="content" style="display:none;margin-bottom:20px">
                <h2 style="color:#c44569;margin-bottom:16px">ðŸ† Leaderboard</h2>
                <div style="display:flex;gap:8px;margin-bottom:14px;flex-wrap:wrap">
                    <button class="tab active" id="ssclbt-easy"   onclick="sscSwitchLB('easy')">ðŸ˜Š 8-Puzzle</button>
                    <button class="tab"        id="ssclbt-medium" onclick="sscSwitchLB('medium')">ðŸ˜„ 15-Puzzle</button>
                    <button class="tab"        id="ssclbt-hard"   onclick="sscSwitchLB('hard')">ðŸ”¥ 24-Puzzle</button>
                    <button class="tab"        id="ssclbt-all"    onclick="sscSwitchLB('all')">ðŸ“Š All</button>
                </div>
                <div id="sscLbContainer"><p style="color:#aaa;text-align:center;padding:30px">Loadingâ€¦</p></div>
            </div>

            <!-- WIN MODAL -->
            <div id="sscWinModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.85);z-index:9999;align-items:center;justify-content:center;backdrop-filter:blur(6px)">
                <div class="ssc-win-inner" style="position:relative;overflow:hidden">
                    <!-- Animated celebration bg -->
                    <div style="position:absolute;inset:0;background:radial-gradient(circle at 30% 20%,rgba(255,215,0,.15) 0%,transparent 55%),radial-gradient(circle at 70% 80%,rgba(196,69,105,.18) 0%,transparent 55%);pointer-events:none"></div>

                    <!-- Floating emoji burst -->
                    <div id="sscWinEmojiBurst" style="position:absolute;inset:0;pointer-events:none;overflow:hidden"></div>

                    <div style="font-size:5em;margin-bottom:4px;animation:sscWinBounce 0.6s cubic-bezier(.36,.07,.19,.97) both">ðŸ†</div>
                    <div style="font-size:2em;margin-bottom:6px;letter-spacing:4px;animation:sscWinPop 0.5s ease both">ðŸŽ‰ðŸŽŠðŸ¥³</div>
                    <h2 style="color:#ffd700;font-size:2em;margin:0 0 2px;font-weight:900;text-shadow:0 2px 16px rgba(255,215,0,.6);animation:sscWinPop 0.4s ease both">Puzzle Solved!</h2>
                    <p style="color:rgba(255,255,255,.75);margin:0 0 20px;font-size:1em;animation:sscWinPop 0.5s .1s ease both">ðŸŒŸ Outstanding! You crushed it! ðŸŒŸ</p>

                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:20px">
                        <div class="ssc-win-stat">
                            <div id="sscWinTime" style="font-size:1.6em;font-weight:900;color:#80deea">â€”</div>
                            <div style="font-size:.75em;color:rgba(255,255,255,.5);margin-top:3px;text-transform:uppercase;letter-spacing:.5px">â± Time</div>
                        </div>
                        <div class="ssc-win-stat">
                            <div id="sscWinMoves" style="font-size:1.6em;font-weight:900;color:#ce93d8">â€”</div>
                            <div style="font-size:.75em;color:rgba(255,255,255,.5);margin-top:3px;text-transform:uppercase;letter-spacing:.5px">ðŸŽ¯ Moves</div>
                        </div>
                        <div class="ssc-win-stat">
                            <div id="sscWinDiff" style="font-size:1.4em;font-weight:900;color:#a5d6a7">â€”</div>
                            <div style="font-size:.75em;color:rgba(255,255,255,.5);margin-top:3px;text-transform:uppercase;letter-spacing:.5px">ðŸŽ® Level</div>
                        </div>
                        <div style="background:linear-gradient(135deg,rgba(255,215,0,.3),rgba(255,171,0,.2));border-radius:12px;padding:14px 8px;border:2px solid rgba(255,215,0,.5);box-shadow:0 0 20px rgba(255,215,0,.2)">
                            <div id="sscWinPts" style="font-size:1.9em;font-weight:900;color:#ffd700;animation:sscScoreCount .6s ease both">â€”</div>
                            <div style="font-size:.75em;color:rgba(255,215,0,.8);margin-top:3px;text-transform:uppercase;letter-spacing:.5px;font-weight:700">â­ Points</div>
                        </div>
                    </div>

                    <p id="sscWinSaveMsg" style="color:#a5d6a7;font-weight:600;margin-bottom:16px;min-height:22px;font-size:.92em"></p>

                    <div style="display:flex;gap:10px;justify-content:center;flex-wrap:wrap">
                        <button onclick="sscSaveScore()" style="background:linear-gradient(135deg,#2e7d32,#43a047);color:white;border:none;padding:14px 28px;border-radius:12px;font-size:1em;font-weight:800;cursor:pointer;box-shadow:0 4px 20px rgba(67,160,71,.5);transition:all .2s;letter-spacing:.3px">ðŸ’¾ Save Score</button>
                        <button onclick="sscResetGame()" style="background:rgba(255,255,255,.12);color:white;border:1px solid rgba(255,255,255,.25);padding:14px 28px;border-radius:12px;font-size:1em;font-weight:700;cursor:pointer;transition:all .2s">ðŸ”„ Play Again</button>
                    </div>
                </div>
            </div>

            <!-- GAME OVER MODAL -->
            <!-- GIVE UP / GAME OVER MODAL -->
            <div id="sscGameOverModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.88);z-index:9999;align-items:center;justify-content:center;backdrop-filter:blur(8px);overflow-y:auto;padding:16px 0">
                <div style="background:linear-gradient(160deg,#12001a 0%,#2d0045 60%,#1a0008 100%);border-radius:24px;padding:0;max-width:540px;width:94%;animation:sscWinPop .45s ease both;box-shadow:0 28px 70px rgba(0,0,0,.7),0 0 0 2px rgba(196,69,105,.25);overflow:hidden;position:relative;margin:auto">

                    <!-- Header band -->
                    <div style="background:linear-gradient(135deg,#b71c1c,#c44569);padding:26px 24px 20px;text-align:center;position:relative">
                        <div id="sscBooEmojiBurst" style="position:absolute;inset:0;pointer-events:none;overflow:hidden"></div>
                        <div style="font-size:3.2em;margin-bottom:6px;animation:sscBooShake 0.4s ease both">ðŸ˜”</div>
                        <div style="font-size:1.6em;margin-bottom:6px;letter-spacing:2px;animation:sscBooShake 0.5s .1s ease both">ðŸ‘ŽðŸ‘ŽðŸ‘Ž</div>
                        <h2 style="color:white;font-size:1.6em;margin:0 0 4px;font-weight:900;letter-spacing:-.3px">You Gave Up!</h2>
                        <p style="color:rgba(255,255,255,.7);margin:0;font-size:.88em">Score not saved Â· Watch how it's solved below</p>
                    </div>

                    <!-- Stats row -->
                    <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:10px;padding:20px 20px 0">
                        <div style="background:rgba(255,255,255,.07);border-radius:12px;padding:14px 8px;text-align:center;border:1px solid rgba(255,255,255,.1)">
                            <div id="sscSolTime" style="font-size:1.4em;font-weight:900;color:#80deea">â€”</div>
                            <div style="font-size:.7em;color:rgba(255,255,255,.45);margin-top:4px;text-transform:uppercase;letter-spacing:.5px">â± Time</div>
                        </div>
                        <div style="background:rgba(255,255,255,.07);border-radius:12px;padding:14px 8px;text-align:center;border:1px solid rgba(255,255,255,.1)">
                            <div id="sscSolMoves" style="font-size:1.4em;font-weight:900;color:#ce93d8">â€”</div>
                            <div style="font-size:.7em;color:rgba(255,255,255,.45);margin-top:4px;text-transform:uppercase;letter-spacing:.5px">ðŸŽ¯ Moves Made</div>
                        </div>
                        <div style="background:rgba(255,255,255,.07);border-radius:12px;padding:14px 8px;text-align:center;border:1px solid rgba(255,255,255,.1)">
                            <div id="sscSolDiff" style="font-size:1.4em;font-weight:900;color:#a5d6a7">â€”</div>
                            <div style="font-size:.7em;color:rgba(255,255,255,.45);margin-top:4px;text-transform:uppercase;letter-spacing:.5px">ðŸŽ® Level</div>
                        </div>
                    </div>

                    <!-- Solution section -->
                    <div style="padding:18px 20px 0">
                        <div style="background:rgba(255,193,7,.08);border:1px solid rgba(255,193,7,.25);border-radius:12px;padding:12px 14px;margin-bottom:16px;display:flex;align-items:flex-start;gap:10px">
                            <span style="font-size:1.3em;flex-shrink:0">ðŸ’¡</span>
                            <div>
                                <div style="color:#ffd54f;font-weight:700;font-size:.9em;margin-bottom:2px">Watch the Solution</div>
                                <div style="color:rgba(255,255,255,.55);font-size:.8em;line-height:1.5">The tiles will animate to show you every move needed to solve the puzzle from where you left off.</div>
                            </div>
                        </div>

                        <!-- Step counter -->
                        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:10px">
                            <div style="color:rgba(255,255,255,.5);font-size:.8em;text-transform:uppercase;letter-spacing:.5px;font-weight:600">Solution Progress</div>
                            <div style="color:#ffd54f;font-size:.85em;font-weight:700" id="sscSolStepCounter">â€”</div>
                        </div>

                        <!-- Mini board replay -->
                        <div style="background:rgba(0,0,0,.35);border-radius:16px;padding:14px;margin-bottom:14px;border:1px solid rgba(255,255,255,.08)">
                            <div id="sscSolBoard" style="display:grid;gap:4px;margin:0 auto;width:fit-content"></div>
                        </div>

                        <!-- Step description -->
                        <div id="sscSolMoveDesc" style="background:rgba(255,255,255,.06);border-radius:10px;padding:12px 14px;text-align:center;margin-bottom:16px;min-height:42px;border:1px solid rgba(255,255,255,.08)">
                            <span style="color:rgba(255,255,255,.6);font-size:.88em">Calculating solutionâ€¦</span>
                        </div>

                        <!-- Replay controls -->
                        <div style="display:flex;gap:8px;justify-content:center;margin-bottom:18px;flex-wrap:wrap">
                            <button id="sscSolPlayBtn" onclick="sscSolPlayPause()" style="background:linear-gradient(135deg,#6a1b9a,#c44569);color:white;border:none;padding:10px 20px;border-radius:10px;font-size:.88em;font-weight:700;cursor:pointer;min-width:90px">â–¶ Play</button>
                            <button onclick="sscSolStepBack()" style="background:rgba(255,255,255,.1);color:white;border:1px solid rgba(255,255,255,.2);padding:10px 16px;border-radius:10px;font-size:.88em;font-weight:600;cursor:pointer">â® Back</button>
                            <button onclick="sscSolStepFwd()" style="background:rgba(255,255,255,.1);color:white;border:1px solid rgba(255,255,255,.2);padding:10px 16px;border-radius:10px;font-size:.88em;font-weight:600;cursor:pointer">Fwd â­</button>
                        </div>
                    </div>

                    <!-- Footer buttons -->
                    <div style="padding:0 20px 24px;display:flex;gap:10px;justify-content:center;flex-wrap:wrap">
                        <button onclick="sscResetGame()" style="background:linear-gradient(135deg,#2e7d32,#43a047);color:white;border:none;padding:13px 26px;border-radius:12px;font-size:.95em;font-weight:800;cursor:pointer;box-shadow:0 4px 16px rgba(67,160,71,.3)">ðŸ”„ Try Again</button>
                        <button onclick="sscShowSection('lb')" style="background:rgba(255,255,255,.1);color:white;border:1px solid rgba(255,255,255,.2);padding:13px 22px;border-radius:12px;font-size:.95em;font-weight:700;cursor:pointer">ðŸ† Leaderboard</button>
                    </div>
                </div>
            </div>

                </div>
        <!-- â•â• END SPEED SLIDE DASHBOARD â•â• -->

    <!-- Firebase Status Indicator -->
    <div class="firebase-status">
        <div class="status-dot status-disconnected" id="statusDot"></div>
        <span id="statusText">Connecting...</span>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirmModal" class="modal">
        <div class="modal-content">
            <div class="modal-icon">âš ï¸</div>
            <div class="modal-header" id="modalMessage"></div>
            <div class="modal-buttons">
                <button class="btn btn-success" onclick="confirmAction()">Yes, Proceed</button>
                <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Edit Enrollment Modal -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">âœï¸ Edit Enrollment</div>
            <div id="editFormContainer"></div>
            <div class="modal-buttons">
                <button class="btn btn-success" onclick="saveEdit()">Save Changes</button>
                <button class="btn btn-secondary" onclick="closeEditModal()">Cancel</button>
            </div>
        </div>
    </div>
    
    <!-- Quiz Date Edit Modal -->
    <div id="quizDateEditModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">ðŸ“… Confirm Date Change</div>
            <p id="dateEditModalMessage" style="text-align:center;margin:20px 0"></p>
            <div class="modal-buttons">
                <button class="btn btn-warning" onclick="confirmDateChange()">âœ… Confirm</button>
                <button class="btn btn-secondary" onclick="closeQuizDateEditModal()">âŒ Cancel</button>
            </div>
        </div>
    </div>

    <script data-cfasync="false" src="/cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script><script>
        // Firebase Configuration - YOUR ACTUAL CONFIG
        const firebaseConfig = {
            apiKey: "AIzaSyCkjglXJOsXEqGrlavYL4vQ635BV_dbMzY",
            authDomain: "spurthi-youthfest-2026.firebaseapp.com",
            databaseURL: "https://spurthi-youthfest-2026-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "spurthi-youthfest-2026",
            storageBucket: "spurthi-youthfest-2026.firebasestorage.app",
            messagingSenderId: "840281252513",
            appId: "1:840281252513:web:13f32d3239b5f5664ec6e0"
        };

        let db, ref;
        try {
            // Guard: only initialize if not already initialized
            if (!firebase.apps.length) {
                firebase.initializeApp(firebaseConfig);
            }
            db = firebase.database();
            window.db = db;  // expose globally so leaderboard script block can use it
            window.storage = firebase.storage();  // expose for Speed Slide image uploads
            ref = db.ref('youthfest-enrollments');
        } catch (e) {
            console.error('Firebase error:', e);
            // Show user-visible warning without breaking the page
            document.addEventListener('DOMContentLoaded', function() {
                const warn = document.createElement('div');
                warn.style.cssText = 'position:fixed;top:0;left:0;right:0;background:#c62828;color:white;text-align:center;padding:10px;font-weight:700;z-index:99999;font-size:14px';
                warn.innerHTML = 'âš ï¸ Database connection error. Please refresh the page. If the problem persists, contact support.';
                document.body.prepend(warn);
            });
        }

        // Global JS error guard â€” catches syntax/runtime errors in any script block
        // and logs them without crashing the whole app
        window.addEventListener('error', function(e) {
            console.error('[Global JS Error]', e.message, 'at', e.filename, 'line', e.lineno);
        });
        window.addEventListener('unhandledrejection', function(e) {
            console.error('[Unhandled Promise]', e.reason);
        });

        // Firebase Connection Status Monitor
        let isConnected = false;
        
        function updateFirebaseStatus(connected) {
            isConnected = connected;
            const statusDot = document.getElementById('statusDot');
            const statusText = document.getElementById('statusText');
            
            statusDot.className = 'status-dot';
            if (connected) {
                statusDot.classList.add('status-connected');
                statusText.textContent = 'ðŸŸ¢ Database Connected';
            } else {
                statusDot.classList.add('status-disconnected');
                statusText.textContent = 'ðŸ”´ Database Offline';
            }
        }
        
        // Check Firebase connection
        if (ref) {
            const connectedRef = db.ref('.info/connected');
            connectedRef.on('value', function(snap) {
                if (snap.val() === true) {
                    updateFirebaseStatus(true);
                } else {
                    updateFirebaseStatus(false);
                }
            });
            
            // Initial check after 2 seconds
            setTimeout(function() {
                ref.once('value').then(function() {
                    updateFirebaseStatus(true);
                }).catch(function() {
                    updateFirebaseStatus(false);
                });
            }, 2000);
        } else {
            setTimeout(function() {
                updateFirebaseStatus(false);
            }, 1000);
        }

        // Global Variables
        const classes = ['1st B.Com','2nd B.Com','3rd B.Com','1ST BCA','2ND BCA A SEC','2ND BCA B SEC','3RD BCA A SEC','3RD BCA B SEC','3RD BCA C SEC','2ND BBA','3RD BBA','Faculty/Principal/Vice-Principal/Staff','Others'];
        // NOTE: Firebase stores '.' as '_' in keys. The summary report's getStrength()
        // normalises both forms so '1st B.Com' and '1st B_Com' both match correctly.
        // DO NOT add '_Com' variants here â€” they are not real classes.
        window._appClasses = classes; // expose to other script blocks
        // individual: true = multiple students per class compete independently;
        //   jury scores each student; leaderboard picks best-per-class for winner/runner-up points.
        //   eligibleClasses is NOT set here â€” you define it per-event in Jury Setup when needed.
        const events = {
            'Pod Casting': {size:'Individual',count:1,role:false,topic:true,topicLabel:'Topic',allow:false,maxPerClass:3,individual:true},
            'Mime': {size:'6 Members',count:6,role:true,topic:true,topicLabel:'Theme',allow:false,maxPerClass:1},
            'Interdisciplinary': {size:'5 Members',count:5,role:true,topic:true,topicLabel:'Topic',allow:false,maxPerClass:1},
            'Ramp Walk': {size:'Individual members',count:0,role:true,topic:true,topicLabel:'Theme',show:true,allow:false,maxPerClass:999,pctMax:30,dynamicCount:true,individual:true},
            'Quiz': {size:'6 Members',count:6,role:true,allow:false,maxPerClass:1},
            'Vlog': {size:'3 Members',count:3,role:true,topic:true,topicLabel:'Topic',allow:true,maxPerClass:3,vlogTopics:['Travel Vlog','Educational Vlog','Event Vlog','Shops Vlog'],multiTeam:true},
            'YouTube Advertisement': {size:'8 Members',count:8,role:true,prod:true,allow:false,maxPerClass:1},
            'Mad Ads': {size:'8 Members',count:8,role:true,topic:true,topicLabel:'Topic',allow:false,maxPerClass:1},
            'Hand Writing': {size:'Individual',count:1,role:false,lang:true,allow:false,maxPerClass:999,pctMax:15,oneAtATime:true,individual:true},
            'Best out of Waste': {size:'2 Members (or Individual)',count:2,role:true,allow:true,maxPerClass:999,pctMax:10,allowIndividual:true},
            'Social Awareness Skit': {size:'8 Members',count:8,role:true,cause:true,allow:false,maxPerClass:1},
            'Talent Hunt': {size:'Individual',count:1,role:false,talent:true,allow:true,maxPerClass:6,oneAtATime:true,individual:true},
            'Group Dance': {size:'5-8 Members',count:5,role:true,allow:false,maxPerClass:1,minCount:5,maxCount:8},
            'Nukkad Natak': {size:'8 to 30% of class',count:8,role:true,cause:true,causeLabel:'Different Cause',allow:false,maxPerClass:1,pctMax:30,dynamicCount:true,minCount:8,camera:true},
            'Case Analysis': {size:'2 Members',count:2,role:true,allow:false,maxPerClass:1}
        };

        let all = [];
        let currentUser = null;
        let studentClass = null;
        let crClass = null;
        let isAdmin = false;
        let isSuperAdmin = false;
        let isManager = false;
        let isCR = false;
        let isJury = false;
        let juryEvent = null;
        let juryNumber = null;
        let selectedEvent = null;
        let adminPassword = 'admin123';
        let superAdminPassword = 'superadmin123';
        let managerPassword = 'manager123'; // Change this to your desired manager password

        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // MANAGER PERMISSIONS â€” Super Admin toggles these in the Manager Permissions
        // panel (inside the Admin section). Each key = one feature.
        // true  = manager CAN access it
        // false = manager CANNOT access it (hidden/blocked)
        //
        // TO ADD A NEW PERMISSION IN FUTURE:
        //   1. Add a new key:value pair here
        //   2. Add a matching toggle row in the Manager Permissions Panel HTML
        //      (search "managerPermissionsPanel" in this file)
        //   3. Use:  if (isManager && !managerPermissions.yourNewKey) return;
        //      OR:   add your tab button with class "manager-controlled" and
        //            data-perm="yourNewKey"
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        let managerPermissions = {
            quizManagement:    true,   // ðŸ“ Quiz Management tab (add/edit questions, publish)
            scavengerAdmin:    true,   // ðŸ—ºï¸ Scavenger Hunt tab (add tasks, approve submissions)
            viewRegistrations: true,   // ðŸ“‹ View Master List & Events tabs (read-only)
            viewResults:       true,   // ðŸ† View Results tab
            whatsappMessages:  true,   // ðŸ“² Copy WhatsApp broadcast messages
            // â”€â”€ Add new permissions below this line â”€â”€
            // featureName:    false,  // description of what this unlocks
        };

        // Load saved permissions from localStorage on page load
        (function loadManagerPermissions() {
            const saved = localStorage.getItem('spurthi_manager_perms');
            if (saved) {
                try {
                    const parsed = JSON.parse(saved);
                    Object.keys(parsed).forEach(k => {
                        if (k in managerPermissions) managerPermissions[k] = parsed[k];
                    });
                } catch(e) {}
            }
        })();
        
        // Quiz Competition Variables
        let quizCurrentUser = null;
        let quizUserRole = null;
        let quizStartTime = null;
        let quizAntiCheatActive = false;
        let quizTimerInterval = null;

        // Speed Slide Challenge globals (declared here so logout() can access them)
        let sscCurrentUser = null;
        let sscTimerRef    = null;

        // Initialize
        window.onload = function() {
            populateClassSelects();
            populateEventSelects();
            loadData();
            
            // Firebase connection status
            const connectedRef = db.ref('.info/connected');
            connectedRef.on('value', (snap) => {
                const dot = document.getElementById('statusDot');
                const text = document.getElementById('statusText');
                if (snap.val() === true) {
                    dot.className = 'status-dot status-connected';
                    text.textContent = 'Connected';
                } else {
                    dot.className = 'status-dot status-disconnected';
                    text.textContent = 'Disconnected';
                }
            });
        };

        function populateClassSelects() {
            const selects = ['studentClass','crClass','filterClass'];
            selects.forEach(id => {
                const sel = document.getElementById(id);
                if (sel) {
                    // For student and CR dropdowns, exclude Faculty and Others
                    const classesToShow = (id === 'studentClass' || id === 'crClass') 
                        ? classes.filter(c => c !== 'Faculty/Principal/Vice-Principal/Staff' && c !== 'Others')
                        : classes;
                    
                    classesToShow.forEach(c => {
                        const opt = document.createElement('option');
                        opt.value = c;
                        opt.textContent = c;
                        sel.appendChild(opt);
                    });
                }
            });
        }

        function populateEventSelects() {
            const selects = ['filterEvent','crFilterEvent','setupEventSelect','resultsEventSelect','juryEvent','liveMonitorEvent'];
            selects.forEach(id => {
                const sel = document.getElementById(id);
                if (sel) {
                    Object.keys(events).forEach(e => {
                        const opt = document.createElement('option');
                        opt.value = e;
                        opt.textContent = e;
                        sel.appendChild(opt);
                    });
                }
            });
        }

        function loadData() {
            ref.on('value', snap => {
                console.log('=== FIREBASE DATA LOADED (listener) ===');
                console.log('Snapshot exists?', snap.exists());
                
                all = [];
                let childCount = 0;
                if (snap.exists()) {
                    snap.forEach(child => {
                        childCount++;
                        const data = {id: child.key, ...child.val()};
                        console.log('Child #' + childCount + ':', child.key, 'â†’', data.classYear, '-', data.event, '-', data.name);
                        all.push(data);
                    });
                }
                
                console.log('Total children loaded:', childCount);
                console.log('All array length:', all.length);
                
                // Show class breakdown
                const classCounts = {};
                all.forEach(e => {
                    if (!classCounts[e.classYear]) classCounts[e.classYear] = 0;
                    classCounts[e.classYear]++;
                });
                console.log('Data by class:', classCounts);
                
                if (isAdmin || isSuperAdmin) {
                    updateStats();
                    updateMaster();
                    updateEvents();
                }
                if (isCR) {
                    updateCRView();
                }
                // Update student view when data changes
                if (studentClass && document.getElementById('studentSection').style.display === 'block') {
                    if (!window._classStrengths) {
                        db.ref('leaderboardConfig/classStrengths').once('value').then(s => {
                            window._classStrengths = s.val() || {};
                            renderEventCards();
                        }).catch(() => renderEventCards());
                    } else {
                        renderEventCards();
                    }
                }
            });
        }

        function handleUserTypeChange() {
            const type = document.getElementById('userType').value;
            document.getElementById('crLogin').style.display = type === 'cr' ? 'block' : 'none';
            document.getElementById('adminLogin').style.display = type === 'admin' ? 'block' : 'none';
            document.getElementById('superAdminLogin').style.display = type === 'superadmin' ? 'block' : 'none';
            document.getElementById('managerLogin').style.display = type === 'manager' ? 'block' : 'none';
            document.getElementById('juryLogin').style.display = type === 'jury' ? 'block' : 'none';

            // Auto-fill saved credentials
            if (type === 'cr' && localStorage.getItem('spurthi_cr_remember') === '1') {
                const savedCls = localStorage.getItem('spurthi_cr_class');
                if (savedCls) {
                    const sel = document.getElementById('crClass');
                    // Wait for options to populate if needed
                    const trySet = () => {
                        if (sel.options.length > 1) { sel.value = savedCls; }
                        else { setTimeout(trySet, 100); }
                    };
                    trySet();
                }
                document.getElementById('crRememberMe').checked = true;
            }
            if (type === 'admin' && localStorage.getItem('spurthi_admin_remember') === '1') {
                const saved = localStorage.getItem('spurthi_admin_pwd');
                if (saved) document.getElementById('adminPassword').value = saved;
                document.getElementById('adminRememberMe').checked = true;
            }
            if (type === 'superadmin' && localStorage.getItem('spurthi_superadmin_remember') === '1') {
                const saved = localStorage.getItem('spurthi_superadmin_pwd');
                if (saved) document.getElementById('superAdminPassword').value = saved;
                document.getElementById('superAdminRememberMe').checked = true;
            }
            if (type === 'manager' && localStorage.getItem('spurthi_manager_remember') === '1') {
                const saved = localStorage.getItem('spurthi_manager_pwd');
                if (saved) document.getElementById('managerPassword').value = saved;
                document.getElementById('managerRememberMe').checked = true;
            }

            // Reset competition dropdown when user type is selected
            if (type) {
                document.getElementById('competitionType').value = '';
                document.getElementById('dailyQuizLogin').style.display = 'none';
            }
        }

        function handleCompetitionChange() {
            const type = document.getElementById('competitionType').value;
            document.getElementById('dailyQuizLogin').style.display     = type === 'dailyquiz'     ? 'block' : 'none';
            document.getElementById('scavengerHuntLogin').style.display = type === 'scavengerhunt' ? 'block' : 'none';
            document.getElementById('speedSlideLogin').style.display    = type === 'speedslide'    ? 'block' : 'none';
            if (type === 'speedslide') {
                if (localStorage.getItem('ssc_remember') === '1') {
                    const ph = localStorage.getItem('ssc_ph');
                    const pw = localStorage.getItem('ssc_pw');
                    if (ph) document.getElementById('sscLoginPhone').value    = ph;
                    if (pw) document.getElementById('sscLoginPassword').value = pw;
                    document.getElementById('sscRememberMe').checked = true;
                }
            }
            
            // Reset user type dropdown and hide credentials when competition is selected
            if (type) {
                document.getElementById('userType').value = '';
                document.getElementById('crLogin').style.display = 'none';
                document.getElementById('adminLogin').style.display = 'none';
                document.getElementById('superAdminLogin').style.display = 'none';
                document.getElementById('juryLogin').style.display = 'none';
            }
            
            if (type === 'dailyquiz') {
                fetchServerTimeOffset(); // pre-fetch server time offset early
                populateQuizClasses();
                checkPublicQuizStatus();
                // Auto-fill remembered quiz credentials
                if (localStorage.getItem('quiz_remember') === '1') {
                    const ph = localStorage.getItem('quiz_ph');
                    const pw = localStorage.getItem('quiz_pw');
                    if (ph) document.getElementById('quizLoginPhone').value    = ph;
                    if (pw) document.getElementById('quizLoginPassword').value = pw;
                    const cb = document.getElementById('quizRememberMe');
                    if (cb) cb.checked = true;
                }
            }
            if (type === 'scavengerhunt') {
                shCheckPublicStatus();
                // Auto-fill saved credentials
                if (localStorage.getItem('spurthi_sh_remember') === '1') {
                    const savedPhone = localStorage.getItem('spurthi_sh_phone');
                    const savedPwd   = localStorage.getItem('spurthi_sh_pwd');
                    if (savedPhone) document.getElementById('shLoginPhone').value    = savedPhone;
                    if (savedPwd)   document.getElementById('shLoginPassword').value = savedPwd;
                    document.getElementById('shRememberMe').checked = true;
                }
            }
        }

        function studentLogin() {
            const cls = document.getElementById('studentClass').value;
            if (!cls) { alert('Please select your class'); return; }
            studentClass = cls;
            currentUser = 'Student';
            
            document.getElementById('userInfo').innerHTML = 'Logged in as: <span class="admin-badge">Student - '+cls+'</span>';
            document.getElementById('loginSection').style.display = 'none';
            document.getElementById('studentSection').style.display = 'block';
            document.getElementById('currentClassName').textContent = cls;
            document.getElementById('classIndicator').classList.add('active');
            
            // Force reload data from Firebase and then render
            console.log('=== STUDENT LOGIN ===');
            console.log('Selected class:', cls);
            console.log('Firebase ref path:', ref.toString());
            
            ref.once('value').then(snap => {
                console.log('Snapshot exists?', snap.exists());
                
                all = [];
                if (snap.exists()) {
                    snap.forEach(child => {
                        const data = {id: child.key, ...child.val()};
                        all.push(data);
                    });
                }
                
                console.log('Total records loaded:', all.length);
                
                // Log first few records
                if (all.length > 0) {
                    console.log('Sample records:');
                    all.slice(0, 3).forEach((rec, i) => {
                        console.log(`  [${i}] Class: "${rec.classYear}" | Event: "${rec.event}" | Name: "${rec.name}"`);
                    });
                }
                
                // Show all unique classes in database
                const uniqueClasses = [...new Set(all.map(e => e.classYear))];
                console.log('Unique classes in database:', uniqueClasses);
                
                // Filter for this class
                const classRecords = all.filter(e => e.classYear === cls);
                console.log(`Records matching "${cls}":`, classRecords.length);
                
                if (classRecords.length > 0) {
                    console.log('Matching records:', classRecords);
                }
                
                // Render cards and view enrollments (load class strengths for pctMax events first)
                if (!window._classStrengths) {
                    db.ref('leaderboardConfig/classStrengths').once('value').then(s => {
                        window._classStrengths = s.val() || {};
                        renderEventCards();
                    }).catch(() => renderEventCards());
                } else {
                    renderEventCards();
                }
                viewStudentClassEnrollments();
                
            }).catch(err => {
                console.error('Firebase read error:', err);
                alert('Error loading data: ' + err.message);
            });
        }

        function crLogin() {
            const cls = document.getElementById('crClass').value;
            if (!cls) { alert('Please select your class'); return; }

            // Save to localStorage if Remember Me checked
            if (document.getElementById('crRememberMe').checked) {
                localStorage.setItem('spurthi_cr_class', cls);
                localStorage.setItem('spurthi_cr_remember', '1');
            } else {
                localStorage.removeItem('spurthi_cr_class');
                localStorage.removeItem('spurthi_cr_remember');
            }
            
            crClass = cls;
            window.currentCRClass = cls;  // expose globally for loadCRQuizStats
            isCR = true;
            currentUser = 'CR';
            document.getElementById('userInfo').innerHTML = 'Logged in as: <span class="admin-badge">CR - '+cls+'</span>';
            document.getElementById('loginSection').style.display = 'none';
            document.getElementById('crSection').style.display = 'block';
            document.getElementById('crClassName').textContent = cls;
            
            // Pre-populate quiz date filter for CR
            populateQsDateFilter().then(() => {
                const d = document.getElementById('crQsDateFilter');
                if (d && !d.value) d.value = getQuizToday();
            });
            
            // Force reload data from Firebase and then render
            console.log('=== CR LOGIN ===');
            console.log('Selected class:', cls);
            console.log('Firebase ref path:', ref.toString());
            
            ref.once('value').then(snap => {
                console.log('Snapshot exists?', snap.exists());
                
                all = [];
                if (snap.exists()) {
                    snap.forEach(child => {
                        const data = {id: child.key, ...child.val()};
                        all.push(data);
                    });
                }
                
                console.log('Total records loaded:', all.length);
                
                // Log first few records
                if (all.length > 0) {
                    console.log('Sample records:');
                    all.slice(0, 3).forEach((rec, i) => {
                        console.log(`  [${i}] Class: "${rec.classYear}" | Event: "${rec.event}" | Name: "${rec.name}"`);
                    });
                }
                
                // Show all unique classes in database
                const uniqueClasses = [...new Set(all.map(e => e.classYear))];
                console.log('Unique classes in database:', uniqueClasses);
                
                // Filter for this class
                const classRecords = all.filter(e => e.classYear === cls);
                console.log(`Records matching "${cls}":`, classRecords.length);
                
                if (classRecords.length > 0) {
                    console.log('Matching records:', classRecords);
                }
                
                if (!window._classStrengths) {
                    db.ref('leaderboardConfig/classStrengths').once('value').then(s => {
                        window._classStrengths = s.val() || {};
                        renderCREventCards();
                    }).catch(() => renderCREventCards());
                } else {
                    renderCREventCards();
                }
                updateCREventFilter();
                updateCRView();
                
            }).catch(err => {
                console.error('Firebase read error:', err);
                alert('Error loading data: ' + err.message);
            });
        }

        function adminLogin() {
            const pwd = document.getElementById('adminPassword').value;
            if (pwd !== adminPassword) { alert('Invalid admin password'); return; }

            // Save to localStorage if Remember Me checked
            if (document.getElementById('adminRememberMe').checked) {
                localStorage.setItem('spurthi_admin_pwd', pwd);
                localStorage.setItem('spurthi_admin_remember', '1');
            } else {
                localStorage.removeItem('spurthi_admin_pwd');
                localStorage.removeItem('spurthi_admin_remember');
            }
            
            isAdmin = true;
            currentUser = 'Admin';
            document.getElementById('userInfo').innerHTML = 'Logged in as: <span class="admin-badge">Admin</span>';
            document.getElementById('loginSection').style.display = 'none';
            document.getElementById('adminSection').style.display = 'block';
            
            // Show only basic tabs for admin
            document.querySelectorAll('.super-admin-only').forEach(el => el.style.display = 'none');
            
            // Check if any results are published and show/hide Results tab
            checkResultsPublished();
            
            // Manually trigger data load from Firebase and update displays
            ref.once('value', snap => {
                all = [];
                if (snap.exists()) {
                    snap.forEach(child => {
                        const data = {id: child.key, ...child.val()};
                        all.push(data);
                    });
                }
                updateStats();
                updateMaster();
                updateEvents();
            });
        }

        function superAdminLogin() {
            const pwd = document.getElementById('superAdminPassword').value;
            if (pwd !== superAdminPassword) { alert('Invalid super admin password'); return; }

            // Save to localStorage if Remember Me checked
            if (document.getElementById('superAdminRememberMe').checked) {
                localStorage.setItem('spurthi_superadmin_pwd', pwd);
                localStorage.setItem('spurthi_superadmin_remember', '1');
            } else {
                localStorage.removeItem('spurthi_superadmin_pwd');
                localStorage.removeItem('spurthi_superadmin_remember');
            }
            
            isAdmin = true;
            isSuperAdmin = true;
            currentUser = 'Super Admin';
            document.getElementById('userInfo').innerHTML = 'Logged in as: <span class="super-admin-badge">Super Admin</span>';
            document.getElementById('loginSection').style.display = 'none';
            document.getElementById('adminSection').style.display = 'block';
            
            // Show all tabs including super admin tabs
            document.querySelectorAll('.super-admin-only:not(.form-section)').forEach(el => el.style.display = 'block');
            
            // Show HWP edit controls for Super Admin
            if (typeof hwpShowAdminControls === 'function') hwpShowAdminControls();
            
            // Super admin always sees Results tab
            document.getElementById('resultsTab').style.display = 'block';
            
            // Manually trigger data load from Firebase and update displays
            ref.once('value', snap => {
                all = [];
                if (snap.exists()) {
                    snap.forEach(child => {
                        const data = {id: child.key, ...child.val()};
                        all.push(data);
                    });
                }
                updateStats();
                updateMaster();
                updateEvents();
            });
        }

        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // MANAGER LOGIN
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function managerLogin() {
            const pwd = document.getElementById('managerPassword').value;
            if (pwd !== managerPassword) { alert('Invalid manager password'); return; }

            if (document.getElementById('managerRememberMe').checked) {
                localStorage.setItem('spurthi_manager_pwd', pwd);
                localStorage.setItem('spurthi_manager_remember', '1');
            } else {
                localStorage.removeItem('spurthi_manager_pwd');
                localStorage.removeItem('spurthi_manager_remember');
            }

            isAdmin   = true;
            isManager = true;
            currentUser = 'Manager';
            document.getElementById('userInfo').innerHTML =
                'Logged in as: <span style="display:inline-block;background:#2196F3;color:white;padding:5px 15px;border-radius:20px;font-size:0.9em;font-weight:bold;margin-left:10px">ðŸ‘” Manager</span>';
            document.getElementById('loginSection').style.display = 'none';
            document.getElementById('adminSection').style.display = 'block';

            // Hide all super-admin-only elements first
            document.querySelectorAll('.super-admin-only').forEach(el => el.style.display = 'none');

            // Apply permissions based on managerPermissions object
            applyManagerPermissions();

            // Load registration data
            ref.once('value', snap => {
                all = [];
                if (snap.exists()) {
                    snap.forEach(child => { all.push({id: child.key, ...child.val()}); });
                }
                updateStats();
                if (managerPermissions.viewRegistrations) { updateMaster(); updateEvents(); }
                if (managerPermissions.viewResults) checkResultsPublished();
            });
        }

        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // applyManagerPermissions()
        // Shows/hides tabs based on managerPermissions object.
        // Called on Manager login AND when Super Admin saves from the panel.
        //
        // TO ADD A NEW PERMISSION IN FUTURE:
        //   Step 1 â†’ Add key in managerPermissions object (top of script)
        //   Step 2 â†’ Add toggle row in Manager Permissions Panel HTML
        //   Step 3 â†’ Add if-block below to show/hide the element
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function applyManagerPermissions() {
            if (!isManager) return;

            const qmTab  = document.getElementById('quizManagementTab');
            if (qmTab)  qmTab.style.display  = managerPermissions.quizManagement  ? 'inline-block' : 'none';

            const shTab  = document.getElementById('scavengerAdminTab');
            if (shTab)  shTab.style.display  = managerPermissions.scavengerAdmin  ? 'inline-block' : 'none';

            const resTab = document.getElementById('resultsTab');
            if (resTab) resTab.style.display = managerPermissions.viewResults      ? 'inline-block' : 'none';

            document.querySelectorAll('.manager-whatsapp-btn').forEach(el => {
                el.style.display = managerPermissions.whatsappMessages ? 'inline-block' : 'none';
            });

            // â”€â”€ ADD NEW PERMISSION CHECKS BELOW THIS LINE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            // const el = document.getElementById('someTabId');
            // if (el) el.style.display = managerPermissions.featureName ? 'inline-block' : 'none';
        }

        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // saveManagerPermissions() â€” called by Super Admin from panel
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function saveManagerPermissions() {
            managerPermissions.quizManagement    = document.getElementById('mperm_quizManagement').checked;
            managerPermissions.scavengerAdmin    = document.getElementById('mperm_scavengerAdmin').checked;
            managerPermissions.viewRegistrations = document.getElementById('mperm_viewRegistrations').checked;
            managerPermissions.viewResults       = document.getElementById('mperm_viewResults').checked;
            managerPermissions.whatsappMessages  = document.getElementById('mperm_whatsappMessages').checked;
            // â”€â”€ Read new permission toggles below this line â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            // managerPermissions.featureName = document.getElementById('mperm_featureName').checked;

            localStorage.setItem('spurthi_manager_perms', JSON.stringify(managerPermissions));
            alert('âœ… Manager permissions saved!\nThese apply the next time Manager logs in.');
        }

        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // WHATSAPP MESSAGE HELPERS
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function copyQuizWhatsAppMsg() {
            const today = (typeof getQuizToday === 'function') ? getQuizToday() : new Date().toISOString().slice(0,10);
            const msg =
                `ðŸ“ *Daily Quiz â€” ${today}*\n\n` +
                `ðŸŽ“ Dear Students,\n` +
                `Today's quiz is now *LIVE!* ðŸ”¥\n\n` +
                `ðŸ‘‰ Visit: https://harshgujjar.github.io/Spurthi-youth-fest-2026/\n` +
                `ðŸ“± Select: *Online Competition â†’ Daily Quiz*\n\n` +
                `â° Answer both questions before time runs out!\n` +
                `ðŸ† Top scorers win prizes!\n\n` +
                `â€” Spurthi Youth Fest 2026 ðŸŽ‰`;
            navigator.clipboard.writeText(msg)
                .then(() => alert('âœ… Quiz WhatsApp message copied!\nPaste it directly into WhatsApp.'))
                .catch(() => prompt('Copy this message manually:', msg));
        }

        function copyScavengerWhatsAppMsg() {
            const msg =
                `ðŸ—ºï¸ *Scavenger Hunt â€” Spurthi Youth Fest 2026*\n\n` +
                `ðŸŽ¯ New tasks are now *LIVE!* ðŸ”¥\n\n` +
                `ðŸ‘‰ Visit: https://harshgujjar.github.io/Spurthi-youth-fest-2026/\n` +
                `ðŸ“± Select: *Online Competition â†’ Scavenger Hunt*\n\n` +
                `ðŸ“¸ Complete tasks, upload proof & earn points!\n` +
                `ðŸ† The fastest team *WINS!*\n\n` +
                `â€” Spurthi Youth Fest 2026 ðŸŽ‰`;
            navigator.clipboard.writeText(msg)
                .then(() => alert('âœ… Scavenger Hunt WhatsApp message copied!\nPaste it directly into WhatsApp.'))
                .catch(() => prompt('Copy this message manually:', msg));
        }

        function juryLogin() {
            const event = document.getElementById('juryEvent').value;
            const pwd = document.getElementById('juryPassword').value;
            const num = document.getElementById('juryNumber').value;
            
            if (!event || !pwd || !num) {
                alert('Please fill all fields');
                return;
            }
            
            // Load jury setup to get password and name
            db.ref('jurySetup/'+event).once('value').then(snap => {
                const setup = snap.val();
                if (!setup) {
                    alert('Event setup not found. Contact super admin.');
                    return;
                }
                
                const juryPassword = setup['jury'+num+'Password'];
                const juryName = setup['jury'+num+'Name'] || 'Jury ' + num;
                
                if (juryPassword === pwd) {
                    isJury = true;
                    juryEvent = event;
                    juryNumber = num;
                    currentUser = 'Jury';
                    
                    document.getElementById('userInfo').innerHTML = 'Logged in as: <span class="jury-badge">'+juryName+' - '+event+'</span>';
                    document.getElementById('loginSection').style.display = 'none';
                    document.getElementById('adminSection').style.display = 'block';
                    // Hide all admin children except jurySection so jury only sees their sheet
                    Array.from(document.getElementById('adminSection').children).forEach(el => {
                        if (el.id !== 'jurySection') el.style.display = 'none';
                    });
                    document.getElementById('jurySection').style.display = 'block';
                    document.getElementById('juryEventTitle').textContent = 'Jury Evaluation - ' + event;
                    document.getElementById('juryInfo').textContent = 'You are ' + juryName + ' for ' + event;
                    
                    loadJurySheet();
                } else {
                    alert('Invalid jury password for this event');
                }
            }).catch(err => {
                alert('Error loading jury setup: ' + err.message);
            });
        }

        function reloadStudentData() {
            console.log('=== RELOADING DATA FROM FIREBASE ===');
            const statusText = document.getElementById('debugStatusText');
            if (statusText) statusText.innerHTML = 'ðŸ”„ Reloading data from Firebase...';
            
            ref.once('value', snap => {
                console.log('Firebase snapshot exists?', snap.exists());
                console.log('Firebase snapshot:', snap.val());
                
                all = [];
                let childCount = 0;
                if (snap.exists()) {
                    snap.forEach(child => {
                        childCount++;
                        const data = {id: child.key, ...child.val()};
                        console.log('Loading child #' + childCount + ':', child.key, data);
                        all.push(data);
                    });
                }
                
                console.log('âœ… Data reloaded!');
                console.log('Total children processed:', childCount);
                console.log('Total records in "all" array:', all.length);
                console.log('All data:', all);
                
                // Show breakdown by class
                const classCounts = {};
                all.forEach(e => {
                    if (!classCounts[e.classYear]) classCounts[e.classYear] = 0;
                    classCounts[e.classYear]++;
                });
                console.log('Records by class:', classCounts);
                
                if (statusText) statusText.innerHTML = 'âœ… Data reloaded! Total records: ' + all.length + ' | Classes: ' + Object.keys(classCounts).length;
                
                // Also update event cards
                renderEventCards();
                
                let msg = 'Data reloaded!\n\n';
                msg += 'Total records: ' + all.length + '\n';
                msg += 'Classes found: ' + Object.keys(classCounts).join(', ') + '\n\n';
                msg += 'Now click "View Enrollments" or "Show All DB Data"';
                alert(msg);
            }).catch(err => {
                console.error('Firebase error:', err);
                alert('Error loading data: ' + err.message);
                if (statusText) statusText.innerHTML = 'âŒ Error: ' + err.message;
            });
        }
        
        function showAllDatabaseData() {
            console.log('=== SHOWING ALL DATABASE DATA ===');
            const cont = document.getElementById('studentEnrollmentResults');
            
            if (all.length === 0) {
                cont.innerHTML = '<div style="background:#ffebee;color:#c62828;padding:15px;border-radius:6px;border:2px solid #c62828;"><strong>âš ï¸ NO DATA IN DATABASE</strong><br>The "all" array is empty. Try clicking "Reload Data" first.</div>';
                return;
            }
            
            // Group by class
            const classCounts = {};
            all.forEach(e => {
                if (!classCounts[e.classYear]) classCounts[e.classYear] = [];
                classCounts[e.classYear].push(e);
            });
            
            let html = '<div style="background:#fff;border-radius:6px;padding:15px;border:2px solid #9c27b0;">';
            html += '<h4 style="color:#9c27b0;margin-bottom:15px;">ðŸ—„ï¸ Complete Database View (Total: ' + all.length + ' records)</h4>';
            
            Object.keys(classCounts).sort().forEach(cls => {
                const enrollments = classCounts[cls];
                const isYourClass = cls === studentClass;
                
                html += '<div style="background:' + (isYourClass ? '#e8f5e9' : '#f5f5f5') + ';padding:12px;border-radius:6px;margin-bottom:10px;border:2px solid ' + (isYourClass ? '#4CAF50' : '#ccc') + ';">';
                html += '<h5 style="color:' + (isYourClass ? '#2e7d32' : '#333') + ';margin-bottom:8px;">';
                html += (isYourClass ? 'ðŸ‘‰ ' : '') + '"' + cls + '" (' + enrollments.length + ' enrollments)' + (isYourClass ? ' â† YOUR CLASS' : '');
                html += '</h5>';
                
                html += '<table style="width:100%;font-size:12px;"><thead><tr><th>Name</th><th>Phone</th><th>Event</th><th>Role</th></tr></thead><tbody>';
                enrollments.forEach(e => {
                    html += '<tr><td>' + e.name + '</td><td>' + e.phone + '</td><td>' + e.event + '</td><td>' + e.role + '</td></tr>';
                });
                html += '</tbody></table></div>';
            });
            
            html += '</div>';
            cont.innerHTML = html;
        }

        function toggleEnrollmentView() {
            const resultsDiv = document.getElementById('studentEnrollmentResults');
            const btn = document.getElementById('toggleEnrollmentBtn');
            
            if (resultsDiv.style.display === 'none') {
                resultsDiv.style.display = 'block';
                btn.textContent = 'Hide Details';
            } else {
                resultsDiv.style.display = 'none';
                btn.textContent = 'Show Details';
            }
        }

        function viewStudentClassEnrollments() {
            console.log('=== Loading class enrollments ===');
            console.log('Student Class:', studentClass);
            console.log('All enrollments count:', all.length);
            
            const cont = document.getElementById('studentEnrollmentResults');
            
            if (!studentClass) { 
                console.error('ERROR: Student class not set!');
                cont.innerHTML = '<div style="background:#ffebee;color:#c62828;padding:15px;border-radius:6px;border:2px solid #c62828;"><strong>Error:</strong> Student class not set. Please log out and log in again.</div>';
                return; 
            }
            
            console.log('Filtering enrollments for class:', studentClass);
            let classEnr = all.filter(e => e.classYear === studentClass);
            console.log('Filtered enrollments count:', classEnr.length);
            
            // Populate event filter dropdown
            const eventFilter = document.getElementById('studentEventFilter');
            const currentFilter = eventFilter.value;
            
            // Get unique events from class enrollments
            const uniqueEvents = [...new Set(classEnr.map(e => e.event))].sort();
            
            // Update dropdown options
            eventFilter.innerHTML = '<option value="">All Events</option>';
            uniqueEvents.forEach(evt => {
                const option = document.createElement('option');
                option.value = evt;
                option.textContent = evt;
                if (evt === currentFilter) option.selected = true;
                eventFilter.appendChild(option);
            });
            
            // Filter by selected event
            if (currentFilter) {
                classEnr = classEnr.filter(e => e.event === currentFilter);
            }
            
            if (classEnr.length === 0) {
                cont.innerHTML = '<div style="background:#fff3cd;color:#856404;padding:15px;border-radius:6px;border:2px solid #ffc107;text-align:center;"><h4 style="margin-bottom:10px;">No Enrollments</h4><p style="margin:0;">' + (currentFilter ? 'No enrollments found for ' + currentFilter : 'Your class has not enrolled in any events yet.') + '</p></div>';
                return; 
            }
            
            // Group by event
            const eventGroups = {};
            classEnr.forEach(e => {
                if (!eventGroups[e.event]) eventGroups[e.event] = [];
                eventGroups[e.event].push(e);
            });
            
            console.log('Event groups:', eventGroups);
            
            let h = '<div style="background:white;border-radius:6px;padding:15px;border:2px solid #4CAF50;">';
            h += '<h4 style="color:#c44569;margin-bottom:15px;">âœ… ' + studentClass + (currentFilter ? ' - ' + currentFilter : '') + ' - Total: ' + classEnr.length + '</h4>';
            
            // Show summary by event (only if showing all events)
            if (!currentFilter) {
                h += '<div style="margin-bottom:20px;">';
                h += '<h5 style="color:#2196F3;margin-bottom:10px;">ðŸ“Š Enrolled Events:</h5>';
                h += '<div style="display:flex;flex-wrap:wrap;gap:10px;">';
                Object.keys(eventGroups).forEach(evt => {
                    h += '<span style="background:#4CAF50;color:white;padding:8px 15px;border-radius:20px;font-size:14px;font-weight:600;">' + evt + ' (' + eventGroups[evt].length + ')</span>';
                });
                h += '</div></div>';
            }
            
            // Show detailed table
            h += '<div class="table-wrapper"><table><thead><tr><th>Sl</th><th>Name</th><th>Phone</th><th>Event</th><th>Role</th><th>Details</th><th>Actions</th></tr></thead><tbody>';
            classEnr.forEach((e,i) => {
                h += '<tr><td>'+(i+1)+'</td><td>'+e.name+'</td><td>'+e.phone+'</td><td>'+e.event+'</td><td>'+e.role+'</td><td>'+getDet(e)+'</td>';
                h += '<td><button class="edit-btn" data-key="'+e.id+'" onclick="editEnrollmentByKey(this.getAttribute(\'data-key\'))">Edit</button>';
                h += '<button class="delete-btn" data-key="'+e.id+'" data-name="'+e.name+'" data-event="'+e.event+'" onclick="deleteEnrollmentByKey(this.getAttribute(\'data-key\'), this.getAttribute(\'data-name\'), this.getAttribute(\'data-event\'))">Delete</button></td></tr>';
            });
            h += '</tbody></table></div></div>';
            cont.innerHTML = h;
            
            console.log('=== Enrollment display complete ===');
        }

        function logout() {
            studentClass = null;
            crClass = null;
            window.currentCRClass = null;
            isAdmin = false;
            // Note: we do NOT clear localStorage here â€” saved credentials persist across logouts
            isSuperAdmin = false;
            isManager = false;
            isCR = false;
            isJury = false;
            juryEvent = null;
            juryNumber = null;
            currentUser = null;
            
            // Quiz logout
            quizCurrentUser = null;
            quizUserRole = null;
            quizAntiCheatActive = false;
            if (quizTimerInterval) clearInterval(quizTimerInterval);
            stopQuizLiveClock();
            
            document.getElementById('userInfo').innerHTML = '';
            document.getElementById('loginSection').style.display = 'block';
            document.getElementById('studentSection').style.display = 'none';
            document.getElementById('crSection').style.display = 'none';
            // Restore any admin children hidden during jury login
            Array.from(document.getElementById('adminSection').children).forEach(el => {
                el.style.display = '';
            });
            document.getElementById('adminSection').style.display = 'none';
            document.getElementById('jurySection').style.display = 'none';
            document.getElementById('quizStudentDashboard').style.display = 'none';
            // quizAdminDashboard removed - no longer used
            document.getElementById('quizPage').style.display = 'none';
            document.getElementById('shStudentDashboard').style.display  = 'none';
            document.getElementById('sscStudentDashboard').style.display = 'none';
            shCurrentUser = null;
            sscCurrentUser = null;
            clearInterval(sscTimerRef);
            if (typeof shAdminStopSubmissionsListener === 'function') shAdminStopSubmissionsListener();
            document.getElementById('userType').value = '';
            document.getElementById('competitionType').value = '';
            handleCompetitionChange();
            handleUserTypeChange();
        }


        // Returns the effective maxPerClass for an event, factoring in pctMax + class strengths
        // classStr = { 'className': strength } from leaderboardConfig/classStrengths (Firebase)
        // We cache it in window._classStrengths
        function getEffectiveMax(cfg, cls) {
            if (!cfg.pctMax) return cfg.maxPerClass;
            const strengths = window._classStrengths || {};
            // Firebase sanitises class name keys (dots/slashes â†’ _)
            const key = cls ? cls.replace(/[.\[\]#$\/]/g, '_') : '';
            const strength = strengths[key] || strengths[cls] || 0;
            if (!strength) return cfg.maxPerClass; // fallback if not set
            const pctVal = Math.floor(strength * cfg.pctMax / 100);
            return Math.max(cfg.minCount || 1, pctVal);
        }

        // Load class strengths once and cache; call renderEventCards after
        function effMaxForSubmit(cfg) {
            // Used during submit when _currentEnrollCount might be stale
            const strengths = window._classStrengths || {};
            if (!cfg.pctMax) return cfg.maxPerClass;
            // Try to find strength from current context
            const cls = window.currentCRClass || studentClass || '';
            const key = cls.replace(/[.[\]#$\/]/g, '_');
            const strength = strengths[key] || strengths[cls] || 0;
            return strength ? Math.max(1, Math.floor(strength * cfg.pctMax / 100)) : 1;
        }

        async function loadClassStrengthsAndRender(renderFn) {
            try {
                const snap = await db.ref('leaderboardConfig/classStrengths').once('value');
                window._classStrengths = snap.val() || {};
            } catch(e) {
                window._classStrengths = {};
            }
            renderFn();
        }

        function renderEventCards() {
            const cont = document.getElementById('eventCardsContainer');
            cont.innerHTML = '';
            Object.keys(events).forEach(ev => {
                const cfg = events[ev];
                const enrolled = all.filter(e => e.event===ev && e.classYear===studentClass).length;
                const effMax = getEffectiveMax(cfg, studentClass);
                const enrolledCount = cfg.allowIndividual || !cfg.count ? enrolled : (cfg.count === 1 ? enrolled : Math.ceil(enrolled / cfg.count));
                const remaining = effMax - enrolledCount;
                const isFull = remaining <= 0;
                const card = document.createElement('div');
                card.className = 'event-card' + (isFull ? ' full' : '');
                const label = cfg.pctMax ? `${enrolledCount}/${effMax} enrolled <span style="font-size:11px;opacity:0.8">(${cfg.pctMax}% of class)</span>` : `${enrolledCount}/${effMax} enrolled`;
                card.innerHTML = '<div class="event-title">'+ev+'</div><div class="event-size">'+cfg.size+'</div><div class="event-status '+(isFull?'status-full':(remaining<=1?'status-limited':'status-available'))+'">'+label+'</div>';
                if (!isFull) card.onclick = () => startEnrollment(ev);
                cont.appendChild(card);
            });
        }

        function renderCREventCards() {
            const cont = document.getElementById('crEventCardsContainer');
            cont.innerHTML = '';
            Object.keys(events).forEach(ev => {
                const cfg = events[ev];
                const enrolled = all.filter(e => e.event===ev && e.classYear===crClass).length;
                const effMax = getEffectiveMax(cfg, crClass);
                const enrolledCount = cfg.allowIndividual || !cfg.count ? enrolled : (cfg.count === 1 ? enrolled : Math.ceil(enrolled / cfg.count));
                const remaining = effMax - enrolledCount;
                const isFull = remaining <= 0;
                const card = document.createElement('div');
                card.className = 'event-card' + (isFull ? ' full' : '');
                const label = cfg.pctMax ? `${enrolledCount}/${effMax} enrolled <span style="font-size:11px;opacity:0.8">(${cfg.pctMax}% of class)</span>` : `${enrolledCount}/${effMax} enrolled`;
                card.innerHTML = '<div class="event-title">'+ev+'</div><div class="event-size">'+cfg.size+'</div><div class="event-status '+(isFull?'status-full':(remaining<=1?'status-limited':'status-available'))+'">'+label+'</div>';
                if (!isFull) card.onclick = () => startCREnrollment(ev);
                cont.appendChild(card);
            });
        }

        async function startEnrollment(ev) {
            selectedEvent = ev;
            const cfg = events[ev];
            const enrolled = all.filter(e => e.event===ev && e.classYear===studentClass).length;
            
            // Calculate how many teams/participants are already enrolled
            const effMax = getEffectiveMax(cfg, studentClass);
            const enrolledCount = cfg.allowIndividual || !cfg.count ? enrolled : (cfg.count === 1 ? enrolled : Math.ceil(enrolled / cfg.count));
            const remaining = effMax - enrolledCount;
            
            if (remaining <= 0) { alert('Event is full for your class'); return; }
            
            const maxLabel = cfg.pctMax ? `${effMax} (${cfg.pctMax}% of class strength)` : effMax;
            let html = '<button class="btn btn-secondary" onclick="cancelEnrollment()" style="margin-bottom:18px;padding:8px 20px">â† Back to Events</button>';
            html += '<h3 style="color:#c44569;margin-bottom:12px">Enroll for: '+ev+'</h3>';
            html += '<p style="margin-bottom:20px;color:#666">'+cfg.size+' | Already Enrolled: '+enrolledCount+' / '+maxLabel+'</p>';
            if (cfg.minCount && cfg.pctMax && cfg.dynamicCount) {
                html += '<div style="background:#e3f2fd;border:1px solid #1565c0;border-radius:8px;padding:12px 16px;margin-bottom:16px;color:#0d47a1"><strong>ðŸ“‹ Team Size Rules:</strong> Minimum <strong>'+cfg.minCount+' members</strong> required. Maximum is <strong>'+cfg.pctMax+'% of your class strength</strong> ('+effMax+' members).</div>';
            }
            
            // For dynamicCount events (like Ramp Walk), use effMax as member count
            const actualCount = cfg.dynamicCount ? effMax : cfg.count;
            window._currentEnrollCount = actualCount; // store for submitEnrollment

            // Generate input fields based on team size
            for (let i = 0; i < actualCount; i++) {
                const roleLabel = cfg.role ? (i === 0 ? 'Captain' : 'Member '+(i+1)) : 'Participant '+(i+1);
                html += '<div class="team-member-box"><div class="member-header">'+roleLabel+'</div>';
                html += '<div class="form-group"><label>Name:</label><input type="text" id="name'+i+'" placeholder="Enter full name"></div>';
                html += '<div class="form-group"><label>Phone Number:</label><input type="tel" id="phone'+i+'" placeholder="10-digit mobile number" maxlength="10"></div>';
                html += '</div>';
            }
            // Dynamic add-member button (e.g. Group Dance: min 5, max 8)
            if (cfg.maxCount && actualCount < cfg.maxCount) {
                window._dynMemberCount = actualCount;
                window._dynMemberMax = cfg.maxCount;
                window._dynMemberRole = cfg.role;
                html += '<div id="dynMemberContainer"></div>';
                html += '<button type="button" id="dynAddMemberBtn" class="btn btn-secondary" style="margin-bottom:18px" onclick="dynAddMember()">âž• Add Member (' + actualCount + '/' + cfg.maxCount + ' max)</button>';
            }
            
            // Event-specific fields
            if (cfg.topic) {
                if (cfg.vlogTopics) {
                    // Fetch already-taken topics from Firebase for this class & event
                    const takenTopics = new Set();
                    try {
                        const snapT = await db.ref('youthfest-enrollments').orderByChild('event').equalTo(ev).once('value');
                        snapT.forEach(c => { const d = c.val(); if (d.classYear === studentClass && d.topic) takenTopics.add(d.topic); });
                    } catch(e) {}
                    let opts = '<option value="">-- Select Topic --</option>';
                    cfg.vlogTopics.forEach(t => {
                        const taken = takenTopics.has(t);
                        opts += `<option value="${t}" ${taken ? 'disabled style="color:#aaa"' : ''}>${t}${taken ? ' (already taken)' : ''}</option>`;
                    });
                    html += '<div class="form-group"><label>ðŸŽ¬ Vlog Topic: <span style="color:red">*</span></label><select id="topic">'+opts+'</select><p style="font-size:12px;color:#856404;margin-top:6px">âš ï¸ Each team must choose a different topic. Greyed-out topics are already taken by your class.</p></div>';
                } else {
                    html += '<div class="form-group"><label>'+cfg.topicLabel+':</label><input type="text" id="topic" placeholder="Enter '+cfg.topicLabel.toLowerCase()+'"></div>';
                }
            }
            if (cfg.prod) {
                html += '<div class="form-group"><label>Product Name:</label><input type="text" id="product" placeholder="What product will you advertise?"></div>';
            }
            if (cfg.cause) {
                html += '<div class="form-group"><label>'+(cfg.causeLabel || 'Cause')+':</label><input type="text" id="cause" placeholder="Enter cause/theme"></div>';
            }
            if (cfg.camera) {
                html += '<div class="team-member-box" style="border-left:4px solid #e67e22;background:#fff8f0"><div class="member-header" style="background:linear-gradient(135deg,#e67e22,#f39c12)">ðŸ“¹ Camera Person</div>';
                html += '<div class="form-group"><label>Name: <span style="color:red">*</span></label><input type="text" id="cameraName" placeholder="Enter camera person full name"></div>';
                html += '<div class="form-group"><label>Phone Number: <span style="color:red">*</span></label><input type="tel" id="cameraPhone" placeholder="10-digit mobile number" maxlength="10"></div>';
                html += '<p style="font-size:12px;color:#856404;margin-top:6px;padding:6px;background:#fff3cd;border-radius:4px">âš ï¸ Camera person is not a performer â€” not counted in the team size.</p>';
                html += '</div>';
            }
            if (cfg.lang) {
                html += '<div class="form-group"><label>Languages:</label><div><label style="display:inline-block;margin-right:15px"><input type="checkbox" id="langEn" checked disabled> English</label><label style="display:inline-block;margin-right:15px"><input type="checkbox" id="langKn"> Kannada</label><label style="display:inline-block"><input type="checkbox" id="langHi"> Hindi</label></div></div>';
            }
            if (cfg.show) {
                html += '<div class="form-group"><label>Showstopper Name:</label><input type="text" id="showstopper" placeholder="Name of showstopper"></div>';
            }
            if (cfg.talent) {
                html += '<div class="form-group"><label>ðŸŽ­ Talent Type: <span style="color:red">*</span></label><select id="talentType"><option value="">-- Select Talent --</option><option>Classical Dance</option><option>Folk Dance</option><option>Western Dance</option><option>Freestyle Dance</option><option>Singing</option><option>Instrumental Music</option><option>Mimicry</option><option>Standup Comedy</option><option>Magic</option><option>Acrobatics / Gymnastics</option><option>Mono Act</option><option>Beatboxing</option><option>Other</option></select></div><div class="form-group" id="talentOtherDiv" style="display:none"><label>Specify Talent:</label><input type="text" id="talentOther" placeholder="Describe your talent"></div>';
            }
            
            // Best out of Waste: individual/team toggle
            if (cfg.allowIndividual) {
                const pctLabel = cfg.pctMax ? ` (${cfg.pctMax}% of class = ${effMax} participants)` : '';
                const toggleHtml = `<div class="form-group" style="background:#f0f4ff;border:2px solid #667eea;border-radius:10px;padding:15px;margin-bottom:18px">
                    <label style="font-weight:700;color:#667eea;font-size:1.05em">â™»ï¸ Participation Type${pctLabel}:</label>
                    <div style="margin-top:10px;display:flex;gap:15px;flex-wrap:wrap">
                        <label style="display:flex;align-items:center;gap:8px;cursor:pointer;background:white;padding:10px 18px;border-radius:8px;border:2px solid #667eea;font-weight:600">
                            <input type="radio" name="bowType" value="team" id="bowTeam" checked onchange="bowToggleMember(2)"> ðŸ‘¥ Team (2 Members)
                        </label>
                        <label style="display:flex;align-items:center;gap:8px;cursor:pointer;background:white;padding:10px 18px;border-radius:8px;border:2px solid #c44569;font-weight:600">
                            <input type="radio" name="bowType" value="individual" id="bowIndividual" onchange="bowToggleMember(1)"> ðŸ§‘ Individual
                        </label>
                    </div>
                    <p style="margin-top:8px;font-size:12px;color:#856404;background:#fff3cd;padding:8px;border-radius:6px">âš ï¸ 10% of your class can participate. Each person (team or individual) counts against this limit.</p>
                </div>`;
                html = html.replace('<div class="team-member-box">', toggleHtml + '<div class="team-member-box" id="bowMember0">');
                let second = false;
                html = html.replace(/<div class="team-member-box">/g, (m) => {
                    if (!second) { second = true; return m; }
                    return '<div class="team-member-box" id="bowMember1">';
                });
            }

            // For oneAtATime, show correct sequential participant number
            if (cfg.oneAtATime) {
                const participantNum = enrolledCount + 1;
                html = html.replace('Participant 1', 'Participant ' + participantNum);
                document.getElementById('enrollBtnsNormal').style.display = 'none';
                document.getElementById('enrollBtnsOneAtATime').style.display = 'block';
            } else if (cfg.multiTeam && remaining > 1) {
                document.getElementById('enrollBtnsNormal').style.display = 'none';
                document.getElementById('enrollBtnsOneAtATime').style.display = 'block';
                const addBtn = document.querySelector('#enrollBtnsOneAtATime button:first-child');
                const finBtn = document.querySelector('#enrollBtnsOneAtATime button:nth-child(2)');
                if (addBtn) addBtn.textContent = 'âœ… Submit Team & Add Next Team';
                if (finBtn) finBtn.textContent = 'âœ” Submit Team & Finish';
                const teamNum = enrolledCount + 1;
                html = '<div style="background:#e8f5e9;border:2px solid #4caf50;border-radius:10px;padding:12px 18px;margin-bottom:18px;text-align:center"><strong style="color:#1b5e20">ðŸ“‹ Adding Team ' + teamNum + ' of ' + effMax + ' (max for your class)</strong></div>' + html;
            } else {
                document.getElementById('enrollBtnsNormal').style.display = 'block';
                document.getElementById('enrollBtnsOneAtATime').style.display = 'none';
                const addBtn = document.querySelector('#enrollBtnsOneAtATime button:first-child');
                const finBtn = document.querySelector('#enrollBtnsOneAtATime button:nth-child(2)');
                if (addBtn) addBtn.textContent = 'âœ… Submit & Add Another';
                if (finBtn) finBtn.textContent = 'âœ” Submit & Finish';
            }

            document.getElementById('enrollmentFormContent').innerHTML = html;
            if (cfg.talent) {
                const ts = document.getElementById('talentType');
                if (ts) ts.addEventListener('change', function(){ document.getElementById('talentOtherDiv').style.display = this.value === 'Other' ? 'block' : 'none'; });
            }
            document.getElementById('eventCardsContainer').style.display = 'none';
            document.getElementById('enrollmentForm').style.display = 'block';
        }

        function bowToggleMember(count) {
            const m1 = document.getElementById('bowMember1');
            if (m1) m1.style.display = count === 2 ? 'block' : 'none';
        }

        function submitEnrollment(addAnother) {
            const cfg = events[selectedEvent];
            const members = [];
            
            // Collect all team members (use dynamic count for Ramp Walk)
            let submitCount = cfg.dynamicCount ? (window._currentEnrollCount || effMaxForSubmit(cfg)) : (cfg.maxCount ? (window._dynMemberCount || cfg.count) : cfg.count);
            if (cfg.allowIndividual) {
                const bowRadio = document.querySelector('input[name="bowType"]:checked');
                submitCount = (bowRadio && bowRadio.value === 'individual') ? 1 : 2;
            }
            for (let i = 0; i < submitCount; i++) {
                const name = document.getElementById('name'+i).value.trim();
                const phone = document.getElementById('phone'+i).value.trim();
                
                if (!name || !phone) { 
                    alert('Please fill all team member fields'); 
                    return; 
                }
                if (!/^\d{10}$/.test(phone)) { 
                    alert('Please enter valid 10-digit phone number for '+name); 
                    return; 
                }
                
                const role = cfg.role ? (i === 0 ? 'Captain' : 'Member') : 'Participant';
                members.push({name: name, phone: phone, role: role});
            }
            
            // Base data for all members
            const baseData = {
                classYear: studentClass,
                event: selectedEvent,
                timestamp: Date.now()
            };
            
            // Add event-specific fields
            if (cfg.topic) {
                const topic = document.getElementById('topic');
                const topicVal = topic ? topic.value.trim() : '';
                if (!topicVal) {
                    alert(cfg.vlogTopics ? 'Please select a Vlog topic' : 'Please enter '+cfg.topicLabel);
                    return;
                }
                // Double-check vlog topic isn't taken (race condition guard)
                if (cfg.vlogTopics) {
                    const alreadyTaken = all.filter(e => e.event === selectedEvent && e.classYear === studentClass && e.topic === topicVal).length > 0;
                    if (alreadyTaken) { alert('âš ï¸ This topic was just taken by another team! Please go back and select a different topic.'); return; }
                }
                baseData.topic = topicVal;
            }
            
            if (cfg.prod) {
                const product = document.getElementById('product');
                if (!product || !product.value.trim()) {
                    alert('Please enter product name');
                    return;
                }
                baseData.product = product.value.trim();
            }
            
            if (cfg.cause) {
                const cause = document.getElementById('cause');
                if (!cause || !cause.value.trim()) {
                    alert('Please enter '+(cfg.causeLabel || 'cause'));
                    return;
                }
                baseData.cause = cause.value.trim();
            }
            if (cfg.camera) {
                const camName = document.getElementById('cameraName');
                const camPhone = document.getElementById('cameraPhone');
                if (!camName || !camName.value.trim()) { alert('Please enter the camera person name'); return; }
                if (!camPhone || !/^\d{10}$/.test(camPhone.value.trim())) { alert('Please enter a valid 10-digit phone number for the camera person'); return; }
                baseData.cameraName = camName.value.trim();
                baseData.cameraPhone = camPhone.value.trim();
            }
            if (cfg.minCount && !cfg.maxCount && members.length < cfg.minCount) {
                alert('Minimum ' + cfg.minCount + ' members required for ' + selectedEvent);
                return;
            }
            
            if (cfg.lang) {
                const langs = ['English'];
                const kn = document.getElementById('langKn');
                const hi = document.getElementById('langHi');
                if (kn && kn.checked) langs.push('Kannada');
                if (hi && hi.checked) langs.push('Hindi');
                baseData.languages = langs.join(', ');
            }
            if (cfg.talent) {
                const talentSel = document.getElementById('talentType');
                const talentVal = talentSel ? talentSel.value.trim() : '';
                if (!talentVal) { alert('Please select a talent type'); return; }
                if (talentVal === 'Other') {
                    const otherVal = document.getElementById('talentOther') ? document.getElementById('talentOther').value.trim() : '';
                    if (!otherVal) { alert('Please specify your talent'); return; }
                    baseData.talentType = otherVal;
                } else {
                    baseData.talentType = talentVal;
                }
            }
            
            if (cfg.show) {
                const show = document.getElementById('showstopper');
                if (!show || !show.value.trim()) {
                    alert('Please enter showstopper name');
                    return;
                }
                baseData.showstopper = show.value.trim();
            }
            
            // Submit all members
            const promises = members.map(m => {
                const data = {...baseData, name: m.name, phone: m.phone, role: m.role};
                return ref.push(data);
            });
            
            // Validate minCount before submitting
            if (cfg.minCount && members.length < cfg.minCount) {
                alert('Minimum ' + cfg.minCount + ' members required for ' + selectedEvent + '. Please add at least ' + cfg.minCount + ' members.');
                return;
            }

            Promise.all(promises).then(() => {
                const eventName = selectedEvent;
                if (addAnother) {
                    showOk('âœ… Participant enrolled! Form ready for next participant.');
                    // Re-open form for same event â€” data reloads from Firebase
                    setTimeout(() => startEnrollment(eventName), 400);
                } else {
                    showOk('Successfully enrolled '+members.length+' member(s) for '+eventName+'!');
                    cancelEnrollment();
                }
            }).catch(err => showErr('Error: '+err.message));
        }

        // Dynamic add-member for variable-size teams (e.g. Group Dance 5-8)
        function dynAddMember() {
            const current = window._dynMemberCount || 0;
            const max = window._dynMemberMax || current;
            if (current >= max) return;
            const idx = current;
            const roleLabel = window._dynMemberRole ? 'Member ' + (idx + 1) : 'Participant ' + (idx + 1);
            const box = document.createElement('div');
            box.className = 'team-member-box';
            box.id = 'dynBox' + idx;
            box.innerHTML = '<div class="member-header">' + roleLabel + '</div>' +
                '<div class="form-group"><label>Name:</label><input type="text" id="name' + idx + '" placeholder="Enter full name"></div>' +
                '<div class="form-group"><label>Phone Number:</label><input type="tel" id="phone' + idx + '" placeholder="10-digit mobile number" maxlength="10"></div>';
            document.getElementById('dynMemberContainer').appendChild(box);
            window._dynMemberCount = idx + 1;
            const btn = document.getElementById('dynAddMemberBtn');
            if (btn) {
                if (window._dynMemberCount >= max) {
                    btn.style.display = 'none';
                } else {
                    btn.textContent = 'âž• Add Member (' + window._dynMemberCount + '/' + max + ' max)';
                }
            }
        }

        function crDynAddMember() {
            const current = window._crDynMemberCount || 0;
            const max = window._crDynMemberMax || current;
            if (current >= max) return;
            const idx = current;
            const roleLabel = window._crDynMemberRole ? 'Member ' + (idx + 1) : 'Participant ' + (idx + 1);
            const box = document.createElement('div');
            box.className = 'team-member-box';
            box.id = 'crDynBox' + idx;
            box.innerHTML = '<div class="member-header">' + roleLabel + '</div>' +
                '<div class="form-group"><label>Name:</label><input type="text" id="crName' + idx + '" placeholder="Enter student full name"></div>' +
                '<div class="form-group"><label>Phone Number:</label><input type="tel" id="crPhone' + idx + '" placeholder="10-digit mobile number" maxlength="10"></div>';
            document.getElementById('crDynMemberContainer').appendChild(box);
            window._crDynMemberCount = idx + 1;
            const btn = document.getElementById('crDynAddMemberBtn');
            if (btn) {
                if (window._crDynMemberCount >= max) {
                    btn.style.display = 'none';
                } else {
                    btn.textContent = 'âž• Add Member (' + window._crDynMemberCount + '/' + max + ' max)';
                }
            }
        }

        function cancelEnrollment() {
            selectedEvent = null;
            document.getElementById('enrollmentForm').style.display = 'none';
            document.getElementById('eventCardsContainer').style.display = 'grid';
            document.getElementById('eventCardsContainer').scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        // CR Functions
        async function startCREnrollment(ev) {
            selectedEvent = ev;
            const cfg = events[ev];
            const enrolled = all.filter(e => e.event===ev && e.classYear===crClass).length;
            
            const effMax = getEffectiveMax(cfg, crClass);
            const enrolledCount = (!cfg.count || cfg.count === 1) ? enrolled : Math.ceil(enrolled / cfg.count);
            const remaining = effMax - enrolledCount;
            
            if (remaining <= 0) { alert('Event is full for your class'); return; }
            
            const maxLabel = cfg.pctMax ? `${effMax} (${cfg.pctMax}% of class strength)` : effMax;
            let html = '<button class="btn btn-secondary" onclick="cancelCREnrollment()" style="margin-bottom:18px;padding:8px 20px">â† Back to Events</button>';
            html += '<h3 style="color:#c44569;margin-bottom:12px">Enroll Students for: '+ev+'</h3>';
            html += '<p style="margin-bottom:20px;color:#666">Class: '+crClass+' | '+cfg.size+' | Enrolled: '+enrolledCount+' / '+maxLabel+'</p>';
            if (cfg.minCount && cfg.pctMax && cfg.dynamicCount) {
                html += '<div style="background:#e3f2fd;border:1px solid #1565c0;border-radius:8px;padding:12px 16px;margin-bottom:16px;color:#0d47a1"><strong>ðŸ“‹ Team Size Rules:</strong> Minimum <strong>'+cfg.minCount+' members</strong> required. Maximum is <strong>'+cfg.pctMax+'% of your class strength</strong> ('+effMax+' members).</div>';
            }
            
            // Generate input fields based on team size
            const crActualCount = cfg.dynamicCount ? effMax : cfg.count;
            window._currentCREnrollCount = crActualCount;
            for (let i = 0; i < crActualCount; i++) {
                const roleLabel = cfg.role ? (i === 0 ? 'Captain' : 'Member '+(i+1)) : 'Participant '+(i+1);
                html += '<div class="team-member-box"><div class="member-header">'+roleLabel+'</div>';
                html += '<div class="form-group"><label>Name:</label><input type="text" id="crName'+i+'" placeholder="Enter student full name"></div>';
                html += '<div class="form-group"><label>Phone Number:</label><input type="tel" id="crPhone'+i+'" placeholder="10-digit mobile number" maxlength="10"></div>';
                html += '</div>';
            }
            // Dynamic add-member button for CR (e.g. Group Dance: min 5, max 8)
            if (cfg.maxCount && crActualCount < cfg.maxCount) {
                window._crDynMemberCount = crActualCount;
                window._crDynMemberMax = cfg.maxCount;
                window._crDynMemberRole = cfg.role;
                html += '<div id="crDynMemberContainer"></div>';
                html += '<button type="button" id="crDynAddMemberBtn" class="btn btn-secondary" style="margin-bottom:18px" onclick="crDynAddMember()">âž• Add Member (' + crActualCount + '/' + cfg.maxCount + ' max)</button>';
            }
            
            // Event-specific fields
            if (cfg.topic) {
                if (cfg.vlogTopics) {
                    const takenTopics = new Set();
                    try {
                        const snapT = await db.ref('youthfest-enrollments').orderByChild('event').equalTo(ev).once('value');
                        snapT.forEach(c => { const d = c.val(); if (d.classYear === crClass && d.topic) takenTopics.add(d.topic); });
                    } catch(e) {}
                    let opts = '<option value="">-- Select Topic --</option>';
                    cfg.vlogTopics.forEach(t => {
                        const taken = takenTopics.has(t);
                        opts += `<option value="${t}" ${taken ? 'disabled style="color:#aaa"' : ''}>${t}${taken ? ' (already taken)' : ''}</option>`;
                    });
                    html += '<div class="form-group"><label>ðŸŽ¬ Vlog Topic: <span style="color:red">*</span></label><select id="crTopic">'+opts+'</select><p style="font-size:12px;color:#856404;margin-top:6px">âš ï¸ Each team must choose a different topic. Greyed-out topics are already taken by your class.</p></div>';
                } else {
                    html += '<div class="form-group"><label>'+cfg.topicLabel+':</label><input type="text" id="crTopic" placeholder="Enter '+cfg.topicLabel.toLowerCase()+'"></div>';
                }
            }
            if (cfg.prod) {
                html += '<div class="form-group"><label>Product Name:</label><input type="text" id="crProduct" placeholder="What product will they advertise?"></div>';
            }
            if (cfg.cause) {
                html += '<div class="form-group"><label>'+(cfg.causeLabel || 'Cause')+':</label><input type="text" id="crCause" placeholder="Enter cause/theme"></div>';
            }
            if (cfg.camera) {
                html += '<div class="team-member-box" style="border-left:4px solid #e67e22;background:#fff8f0"><div class="member-header" style="background:linear-gradient(135deg,#e67e22,#f39c12)">ðŸ“¹ Camera Person</div>';
                html += '<div class="form-group"><label>Name: <span style="color:red">*</span></label><input type="text" id="crCameraName" placeholder="Enter camera person full name"></div>';
                html += '<div class="form-group"><label>Phone Number: <span style="color:red">*</span></label><input type="tel" id="crCameraPhone" placeholder="10-digit mobile number" maxlength="10"></div>';
                html += '<p style="font-size:12px;color:#856404;margin-top:6px;padding:6px;background:#fff3cd;border-radius:4px">âš ï¸ Camera person is not a performer â€” not counted in the team size.</p>';
                html += '</div>';
            }
            if (cfg.lang) {
                html += '<div class="form-group"><label>Languages:</label><div><label style="display:inline-block;margin-right:15px"><input type="checkbox" id="crLangEn" checked disabled> English</label><label style="display:inline-block;margin-right:15px"><input type="checkbox" id="crLangKn"> Kannada</label><label style="display:inline-block"><input type="checkbox" id="crLangHi"> Hindi</label></div></div>';
            }
            if (cfg.show) {
                html += '<div class="form-group"><label>Showstopper Name:</label><input type="text" id="crShowstopper" placeholder="Name of showstopper"></div>';
            }
            if (cfg.talent) {
                html += '<div class="form-group"><label>ðŸŽ­ Talent Type: <span style="color:red">*</span></label><select id="crTalentType"><option value="">-- Select Talent --</option><option>Classical Dance</option><option>Folk Dance</option><option>Western Dance</option><option>Freestyle Dance</option><option>Singing</option><option>Instrumental Music</option><option>Mimicry</option><option>Standup Comedy</option><option>Magic</option><option>Acrobatics / Gymnastics</option><option>Mono Act</option><option>Beatboxing</option><option>Other</option></select></div><div class="form-group" id="crTalentOtherDiv" style="display:none"><label>Specify Talent:</label><input type="text" id="crTalentOther" placeholder="Describe your talent"></div>';
            }
            
            if (cfg.allowIndividual) {
                const pctLabel = cfg.pctMax ? ` (${cfg.pctMax}% of class = ${effMax} participants)` : '';
                const toggleHtml = `<div class="form-group" style="background:#f0f4ff;border:2px solid #667eea;border-radius:10px;padding:15px;margin-bottom:18px">
                    <label style="font-weight:700;color:#667eea;font-size:1.05em">â™»ï¸ Participation Type${pctLabel}:</label>
                    <div style="margin-top:10px;display:flex;gap:15px;flex-wrap:wrap">
                        <label style="display:flex;align-items:center;gap:8px;cursor:pointer;background:white;padding:10px 18px;border-radius:8px;border:2px solid #667eea;font-weight:600">
                            <input type="radio" name="crBowType" value="team" id="crBowTeam" checked onchange="crBowToggleMember(2)"> ðŸ‘¥ Team (2 Members)
                        </label>
                        <label style="display:flex;align-items:center;gap:8px;cursor:pointer;background:white;padding:10px 18px;border-radius:8px;border:2px solid #c44569;font-weight:600">
                            <input type="radio" name="crBowType" value="individual" id="crBowIndividual" onchange="crBowToggleMember(1)"> ðŸ§‘ Individual
                        </label>
                    </div>
                    <p style="margin-top:8px;font-size:12px;color:#856404;background:#fff3cd;padding:8px;border-radius:6px">âš ï¸ 10% of your class can participate. Each person counts against this limit.</p>
                </div>`;
                html = html.replace('<div class="team-member-box">', toggleHtml + '<div class="team-member-box" id="crBowMember0">');
                let second = false;
                html = html.replace(/<div class="team-member-box">/g, (m) => {
                    if (!second) { second = true; return m; }
                    return '<div class="team-member-box" id="crBowMember1">';
                });
            }

            if (cfg.oneAtATime) {
                const participantNum = enrolledCount + 1;
                html = html.replace('Participant 1', 'Participant ' + participantNum);
                document.getElementById('crEnrollBtnsNormal').style.display = 'none';
                document.getElementById('crEnrollBtnsOneAtATime').style.display = 'block';
            } else if (cfg.multiTeam && remaining > 1) {
                document.getElementById('crEnrollBtnsNormal').style.display = 'none';
                document.getElementById('crEnrollBtnsOneAtATime').style.display = 'block';
                const addBtn = document.querySelector('#crEnrollBtnsOneAtATime button:first-child');
                const finBtn = document.querySelector('#crEnrollBtnsOneAtATime button:nth-child(2)');
                if (addBtn) addBtn.textContent = 'âœ… Submit Team & Add Next Team';
                if (finBtn) finBtn.textContent = 'âœ” Submit Team & Finish';
                const teamNum = enrolledCount + 1;
                html = '<div style="background:#e8f5e9;border:2px solid #4caf50;border-radius:10px;padding:12px 18px;margin-bottom:18px;text-align:center"><strong style="color:#1b5e20">ðŸ“‹ Adding Team ' + teamNum + ' of ' + effMax + ' (max for your class)</strong></div>' + html;
            } else {
                document.getElementById('crEnrollBtnsNormal').style.display = 'block';
                document.getElementById('crEnrollBtnsOneAtATime').style.display = 'none';
                const addBtn = document.querySelector('#crEnrollBtnsOneAtATime button:first-child');
                const finBtn = document.querySelector('#crEnrollBtnsOneAtATime button:nth-child(2)');
                if (addBtn) addBtn.textContent = 'âœ… Submit & Add Another';
                if (finBtn) finBtn.textContent = 'âœ” Submit & Finish';
            }

            document.getElementById('crEnrollmentFormContent').innerHTML = html;
            if (cfg.talent) {
                const ts = document.getElementById('crTalentType');
                if (ts) ts.addEventListener('change', function(){ document.getElementById('crTalentOtherDiv').style.display = this.value === 'Other' ? 'block' : 'none'; });
            }
            document.getElementById('crEventCardsContainer').style.display = 'none';
            document.getElementById('crEnrollmentForm').style.display = 'block';
        }

        function crBowToggleMember(count) {
            const m1 = document.getElementById('crBowMember1');
            if (m1) m1.style.display = count === 2 ? 'block' : 'none';
        }

        function submitCREnrollment(addAnother) {
            const cfg = events[selectedEvent];
            const members = [];
            
            // Collect all team members (use dynamic count for Ramp Walk)
            let crSubmitCount = cfg.dynamicCount ? (window._currentCREnrollCount || 1) : (cfg.maxCount ? (window._crDynMemberCount || cfg.count) : cfg.count);
            if (cfg.allowIndividual) {
                const crBowRadio = document.querySelector('input[name="crBowType"]:checked');
                crSubmitCount = (crBowRadio && crBowRadio.value === 'individual') ? 1 : 2;
            }
            for (let i = 0; i < crSubmitCount; i++) {
                const name = document.getElementById('crName'+i).value.trim();
                const phone = document.getElementById('crPhone'+i).value.trim();
                
                if (!name || !phone) { 
                    alert('Please fill all team member fields'); 
                    return; 
                }
                if (!/^\d{10}$/.test(phone)) { 
                    alert('Please enter valid 10-digit phone number for '+name); 
                    return; 
                }
                
                const role = cfg.role ? (i === 0 ? 'Captain' : 'Member') : 'Participant';
                members.push({name: name, phone: phone, role: role});
            }
            
            // Base data for all members
            const baseData = {
                classYear: crClass,
                event: selectedEvent,
                enrolledBy: 'CR',
                timestamp: Date.now()
            };
            
            // Add event-specific fields
            if (cfg.topic) {
                const topic = document.getElementById('crTopic');
                const topicVal = topic ? topic.value.trim() : '';
                if (!topicVal) {
                    alert(cfg.vlogTopics ? 'Please select a Vlog topic' : 'Please enter '+cfg.topicLabel);
                    return;
                }
                if (cfg.vlogTopics) {
                    const alreadyTaken = all.filter(e => e.event === selectedEvent && e.classYear === crClass && e.topic === topicVal).length > 0;
                    if (alreadyTaken) { alert('âš ï¸ This topic was just taken by another team! Please go back and select a different topic.'); return; }
                }
                baseData.topic = topicVal;
            }
            
            if (cfg.prod) {
                const product = document.getElementById('crProduct');
                if (!product || !product.value.trim()) {
                    alert('Please enter product name');
                    return;
                }
                baseData.product = product.value.trim();
            }
            
            if (cfg.cause) {
                const cause = document.getElementById('crCause');
                if (!cause || !cause.value.trim()) {
                    alert('Please enter '+(cfg.causeLabel || 'cause'));
                    return;
                }
                baseData.cause = cause.value.trim();
            }
            if (cfg.camera) {
                const camName = document.getElementById('crCameraName');
                const camPhone = document.getElementById('crCameraPhone');
                if (!camName || !camName.value.trim()) { alert('Please enter the camera person name'); return; }
                if (!camPhone || !/^\d{10}$/.test(camPhone.value.trim())) { alert('Please enter a valid 10-digit phone number for the camera person'); return; }
                baseData.cameraName = camName.value.trim();
                baseData.cameraPhone = camPhone.value.trim();
            }
            if (cfg.minCount && !cfg.maxCount && members.length < cfg.minCount) {
                alert('Minimum ' + cfg.minCount + ' members required for ' + selectedEvent);
                return;
            }
            
            if (cfg.lang) {
                const langs = ['English'];
                const kn = document.getElementById('crLangKn');
                const hi = document.getElementById('crLangHi');
                if (kn && kn.checked) langs.push('Kannada');
                if (hi && hi.checked) langs.push('Hindi');
                baseData.languages = langs.join(', ');
            }
            if (cfg.talent) {
                const talentSel = document.getElementById('crTalentType');
                const talentVal = talentSel ? talentSel.value.trim() : '';
                if (!talentVal) { alert('Please select a talent type'); return; }
                if (talentVal === 'Other') {
                    const otherVal = document.getElementById('crTalentOther') ? document.getElementById('crTalentOther').value.trim() : '';
                    if (!otherVal) { alert('Please specify your talent'); return; }
                    baseData.talentType = otherVal;
                } else {
                    baseData.talentType = talentVal;
                }
            }
            
            if (cfg.show) {
                const show = document.getElementById('crShowstopper');
                if (!show || !show.value.trim()) {
                    alert('Please enter showstopper name');
                    return;
                }
                baseData.showstopper = show.value.trim();
            }
            
            // Submit all members
            const promises = members.map(m => {
                const data = {...baseData, name: m.name, phone: m.phone, role: m.role};
                return ref.push(data);
            });
            
            // Validate minCount before submitting
            if (cfg.minCount && members.length < cfg.minCount) {
                alert('Minimum ' + cfg.minCount + ' members required for ' + selectedEvent + '. Please add at least ' + cfg.minCount + ' members.');
                return;
            }

            Promise.all(promises).then(() => {
                const eventName = selectedEvent;
                if (addAnother) {
                    showCROk('âœ… Participant enrolled! Form ready for next participant.');
                    setTimeout(() => startCREnrollment(eventName), 400);
                } else {
                    showCROk('Successfully enrolled '+members.length+' student(s) for '+eventName+'!');
                    cancelCREnrollment();
                }
            }).catch(err => showCRErr('Error: '+err.message));
        }

        function cancelCREnrollment() {
            selectedEvent = null;
            document.getElementById('crEnrollmentForm').style.display = 'none';
            document.getElementById('crEventCardsContainer').style.display = 'grid';
            document.getElementById('crEventCardsContainer').scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        function showCRTab(tab) {
            document.querySelectorAll('#crSection .tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('#crSection .form-section').forEach(s => s.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById(tab).classList.add('active');
        }

        function updateCREventFilter() {
            const sel = document.getElementById('crFilterEvent');
            sel.innerHTML = '<option value="">All Events</option>';
            const enrolled = [...new Set(all.filter(e => e.classYear === crClass).map(e => e.event))];
            enrolled.forEach(ev => {
                const opt = document.createElement('option');
                opt.value = ev;
                opt.textContent = ev;
                sel.appendChild(opt);
            });
        }

        function updateCRView() {
            console.log('=== updateCRView called ===');
            console.log('crClass:', crClass);
            console.log('all.length:', all.length);
            
            const filterEv = document.getElementById('crFilterEvent').value;
            let filtered = all.filter(e => e.classYear === crClass);
            
            console.log('Filtered by class:', filtered.length);
            
            if (filterEv) {
                filtered = filtered.filter(e => e.event === filterEv);
                console.log('Filtered by event:', filtered.length);
            }
            
            // Summary
            let summary = '<h3 style="color:#2196F3;margin-bottom:10px">Your Class: <strong>'+crClass+'</strong></h3>';
            summary += '<p><strong>Total Students Enrolled:</strong> '+filtered.length+'</p>';
            if (filterEv) summary += '<p><strong>Event:</strong> '+filterEv+'</p>';
            document.getElementById('crSummary').innerHTML = summary;
            
            // Table
            const cont = document.getElementById('crEnrollmentsContainer');
            if (filtered.length === 0) {
                console.log('No enrollments found - showing empty message');
                cont.innerHTML = '<p style="text-align:center;padding:40px;color:#999">No enrollments yet</p>';
            } else {
                console.log('Building table with', filtered.length, 'rows');
                let html = '<div class="table-wrapper"><table><thead><tr><th>Sl</th><th>Name</th><th>Phone</th><th>Event</th><th>Role</th><th>Details</th><th>Actions</th></tr></thead><tbody>';
                filtered.forEach((e,i) => {
                    html += '<tr><td>'+(i+1)+'</td><td>'+e.name+'</td><td>'+e.phone+'</td><td>'+e.event+'</td><td>'+e.role+'</td><td>'+getDet(e)+'</td>';
                    html += '<td><button class="edit-btn" data-key="'+e.id+'" onclick="editEnrollmentByKey(this.getAttribute(\'data-key\'))">Edit</button>';
                    html += '<button class="delete-btn" data-key="'+e.id+'" data-name="'+e.name+'" data-event="'+e.event+'" onclick="deleteEnrollmentByKey(this.getAttribute(\'data-key\'), this.getAttribute(\'data-name\'), this.getAttribute(\'data-event\'))">Delete</button></td></tr>';
                });
                html += '</tbody></table></div>';
                cont.innerHTML = html;
            }
            
            // Update CR event cards to show current enrollment counts
            renderCREventCards();
        }

        function clearCRFilters() {
            document.getElementById('crFilterEvent').value = '';
            updateCRView();
        }

        function downloadCREnrollments() {
            console.log('=== DOWNLOAD CR ENROLLMENTS ===');
            console.log('CR Class:', crClass);
            console.log('Total records in all:', all.length);
            
            if (!crClass) {
                alert('Error: Class not set. Please log out and log in again.');
                return;
            }
            
            // Filter all enrollments for this CR's class
            const classEnrollments = all.filter(e => e.classYear === crClass);
            
            console.log('Filtered enrollments for', crClass, ':', classEnrollments.length);
            
            if (classEnrollments.length === 0) {
                alert('No enrollments to download for ' + crClass);
                return;
            }
            
            // Check if event filter is applied
            const filterEv = document.getElementById('crFilterEvent').value;
            let enrollmentsToDownload = classEnrollments;
            
            if (filterEv) {
                enrollmentsToDownload = classEnrollments.filter(e => e.event === filterEv);
                console.log('Filtered by event', filterEv, ':', enrollmentsToDownload.length);
            }
            
            // Create CSV content
            let csv = 'Sl,Name,Phone,Class,Event,Role,Details\n';
            enrollmentsToDownload.forEach((e, i) => {
                const details = getDet(e).replace(/<br>/g, ' | ').replace(/"/g, '""');
                csv += `${i+1},"${e.name}","${e.phone}","${e.classYear}","${e.event}","${e.role}","${details}"\n`;
            });
            
            // Generate filename
            const filename = filterEv 
                ? `${crClass}_${filterEv}_enrollments.csv`.replace(/\s+/g, '_')
                : `${crClass}_all_enrollments.csv`.replace(/\s+/g, '_');
            
            console.log('Downloading', enrollmentsToDownload.length, 'records as', filename);
            
            // Download
            download(csv, filename);
            
            showCROk(`Downloaded ${enrollmentsToDownload.length} enrollment(s) successfully!`);
        }

        function showCROk(msg) {
            const d = document.getElementById('crMessage');
            d.className = 'message success show';
            d.textContent = 'âœ“ '+msg;
            setTimeout(() => d.classList.remove('show'), 5000);
        }

        function showCRErr(msg) {
            const d = document.getElementById('crMessage');
            d.className = 'message error show';
            d.textContent = 'âœ— '+msg;
            setTimeout(() => d.classList.remove('show'), 5000);
        }

        // Admin Functions
        function showTab(tab) {
            // Clear only top-level admin nav tabs (NOT scavenger inner tabs)
            document.querySelectorAll('#adminSection > div.tabs > .tab').forEach(t => t.classList.remove('active'));
            // Clear only direct-child form-sections of adminContentBox (NOT scavenger inner panels)
            document.querySelectorAll('#adminContentBox > .form-section').forEach(s => s.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById(tab).classList.add('active');

            // Toggle white box for leaderboard
            const adminBox = document.getElementById('adminContentBox');
            if (adminBox) {
                adminBox.classList.toggle('lb-active', tab === 'leaderboardAdmin');
            }

            if (tab === 'results')        loadResultsTab();
            if (tab === 'quizManagement') { loadQuizManagementStats(); showQuizManagementTab('questions'); initializeDateSelector(); }
            if (tab === 'leaderboardAdmin') {
                if (typeof loadLbConfigIntoForm   === 'function') loadLbConfigIntoForm();
                if (typeof loadLbCriteriaList     === 'function') loadLbCriteriaList();
                if (typeof loadLbPublishedResults === 'function') loadLbPublishedResults();
                if (typeof loadLbAdminPreview     === 'function') loadLbAdminPreview();
            }
            if (tab === 'scavengerAdmin') {
                // Show Tasks panel, hide others using inline style (immune to class conflicts)
                ['shAdminTasks','shAdminSubmissions','shAdminLeaderboard','shAdminClasswise','shAdminWinners','shAdminSettings'].forEach(id => {
                    const el = document.getElementById(id);
                    if (el) el.style.display = (id === 'shAdminTasks') ? 'block' : 'none';
                });
                // Reset scavenger sub-tab button active states
                document.querySelectorAll('#scavengerAdmin .tabs .tab').forEach(t => t.classList.remove('active'));
                const firstBtn = document.querySelector('#scavengerAdmin .tabs .tab');
                if (firstBtn) firstBtn.classList.add('active');
                if (typeof shAdminLoadTasks    === 'function') shAdminLoadTasks();
                if (typeof shAdminLoadSettings === 'function') shAdminLoadSettings();
            }
            if (tab === 'speedSlideAdmin') {
                ssaShowTab('sub');
            }
            if (tab === 'dbInspector') {
                // DB Inspector tab â€” ready to scan, nothing auto-loads
            }
            if (tab === 'cloudinaryInspector') {
                // Cloudinary Inspector â€” ready to use, nothing auto-loads
            }
            if (tab === 'firebaseDownloadMonitor') {
                // Firebase Download Monitor â€” render history on open
                if (typeof fdmRenderHistory === 'function') fdmRenderHistory();
            }
            // Sync Manager Permissions panel checkboxes with current state when opened
            if (tab === 'managerPermissionsPanel') {
                document.getElementById('mperm_quizManagement').checked    = managerPermissions.quizManagement;
                document.getElementById('mperm_scavengerAdmin').checked    = managerPermissions.scavengerAdmin;
                document.getElementById('mperm_viewRegistrations').checked = managerPermissions.viewRegistrations;
                document.getElementById('mperm_viewResults').checked       = managerPermissions.viewResults;
                document.getElementById('mperm_whatsappMessages').checked  = managerPermissions.whatsappMessages;
                // â”€â”€ Sync new permission checkboxes below this line â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                // document.getElementById('mperm_featureName').checked = managerPermissions.featureName;
            }
        }

        function updateStats() {
            const uniqueStudents = new Set(all.map(e => e.phone)).size;
            const uniqueClasses = new Set(all.map(e => e.classYear)).size;
            const activeEvents = new Set(all.map(e => e.event)).size;
            
            document.getElementById('totalStudents').textContent = uniqueStudents;
            document.getElementById('totalEvents').textContent = activeEvents;
            document.getElementById('totalClasses').textContent = uniqueClasses;
            document.getElementById('totalEnrollments').textContent = all.length;
        }

        function updateMaster() {
            // Use setTimeout to ensure dropdown has updated
            setTimeout(() => {
                const filterCl = document.getElementById('filterClass') ? document.getElementById('filterClass').value : '';
                const filterEv = document.getElementById('filterEvent') ? document.getElementById('filterEvent').value : '';
                
                let filtered = [...all]; // Create a copy
                
                if (filterCl) {
                    filtered = filtered.filter(e => e.classYear === filterCl);
                }
                
                if (filterEv) {
                    filtered = filtered.filter(e => e.event === filterEv);
                }
                
                updateSummary(filterCl, filterEv);
                
                const cont = document.getElementById('masterContainer');
                if (!cont) {
                    return;
                }
                
                if (filtered.length === 0) {
                    cont.innerHTML = '<p style="text-align:center;padding:40px;color:#999">No data available</p>';
                    return;
                }
                
                let html = '<div class="table-wrapper"><table><thead><tr><th>Sl</th><th>Name</th><th>Phone</th><th>Class</th><th>Event</th><th>Role</th><th>Details</th><th>Actions</th></tr></thead><tbody>';
                filtered.forEach((e,i) => {
                    html += '<tr><td>'+(i+1)+'</td><td>'+e.name+'</td><td>'+e.phone+'</td><td>'+e.classYear+'</td><td>'+e.event+'</td><td>'+e.role+'</td><td>'+getDet(e)+'</td>';
                    html += '<td><button class="edit-btn" data-key="'+e.id+'" onclick="editEnrollmentByKey(this.getAttribute(\'data-key\'))">Edit</button>';
                    html += '<button class="delete-btn" data-key="'+e.id+'" data-name="'+e.name+'" data-event="'+e.event+'" onclick="deleteEnrollmentByKey(this.getAttribute(\'data-key\'), this.getAttribute(\'data-name\'), this.getAttribute(\'data-event\'))">Delete</button></td></tr>';
                });
                html += '</tbody></table></div>';
                cont.innerHTML = html;
            }, 10); // Small delay to ensure dropdown has updated
        }

        function updateSummary(selectedClass, selectedEvent) {
            const summaryContent = document.getElementById('summaryInfo');
            let html = '<h3 style="color:#2196F3;margin-bottom:15px">ðŸ“Š Summary</h3>';
            html += '<p><strong>Total Enrollments:</strong> '+all.length+'</p>';
            
            // When Event is selected (no class) - show class enrollment status
            if (!selectedClass && selectedEvent) {
                const enrolledClasses = [];
                const notEnrolledClasses = [];
                
                classes.forEach(cls => {
                    const hasEnrollment = all.some(e => e.classYear === cls && e.event === selectedEvent);
                    if (hasEnrollment) {
                        const count = all.filter(e => e.classYear === cls && e.event === selectedEvent).length;
                        enrolledClasses.push({name: cls, count: count});
                    } else {
                        notEnrolledClasses.push(cls);
                    }
                });
                
                html += '<div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;">';
                
                // Classes with Enrollments
                html += '<div style="background:#d4edda;padding:15px;border-radius:6px;border:2px solid #28a745;">';
                html += '<h4 style="color:#155724;margin-bottom:10px;">âœ… Classes with Enrollments (' + enrolledClasses.length + ')</h4>';
                if (enrolledClasses.length > 0) {
                    html += '<div style="display:flex;flex-wrap:wrap;gap:8px;">';
                    enrolledClasses.forEach(cls => {
                        html += '<span style="background:#28a745;color:white;padding:6px 12px;border-radius:20px;font-size:14px;font-weight:600;">' + cls.name + ' (' + cls.count + ')</span>';
                    });
                    html += '</div>';
                } else {
                    html += '<p style="color:#666;font-style:italic;margin:0;">No classes enrolled yet</p>';
                }
                html += '</div>';
                
                // Classes NOT Enrolled
                html += '<div style="background:#f8d7da;padding:15px;border-radius:6px;border:2px solid #dc3545;">';
                html += '<h4 style="color:#721c24;margin-bottom:10px;">âŒ Classes NOT Enrolled (' + notEnrolledClasses.length + ')</h4>';
                if (notEnrolledClasses.length > 0) {
                    html += '<div style="display:flex;flex-wrap:wrap;gap:8px;">';
                    notEnrolledClasses.forEach(cls => {
                        html += '<span style="background:#dc3545;color:white;padding:6px 12px;border-radius:20px;font-size:14px;font-weight:600;">' + cls + '</span>';
                    });
                    html += '</div>';
                } else {
                    html += '<p style="color:#666;font-style:italic;margin:0;">All classes have enrolled!</p>';
                }
                html += '</div>';
                html += '</div>';
            }
            
            // When Class is selected - show event enrollment status
            if (selectedClass && !selectedEvent) {
                const enrolledEvents = [];
                const pendingEvents = [];
                
                Object.keys(events).forEach(evt => {
                    const hasEnrollment = all.some(e => e.classYear === selectedClass && e.event === evt);
                    if (hasEnrollment) {
                        const count = all.filter(e => e.classYear === selectedClass && e.event === evt).length;
                        enrolledEvents.push({name: evt, count: count});
                    } else {
                        pendingEvents.push(evt);
                    }
                });
                
                html += '<h3 style="color:#2196F3;margin-bottom:15px;">ðŸ“Š Summary for Class: <strong>' + selectedClass + '</strong></h3>';
                html += '<div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;">';
                
                // Enrolled Events
                html += '<div style="background:white;padding:15px;border-radius:6px;">';
                html += '<h4 style="color:#4CAF50;margin-bottom:10px;">âœ… Enrolled Events (' + enrolledEvents.length + ')</h4>';
                if (enrolledEvents.length > 0) {
                    html += '<ul style="list-style:none;padding:0;margin:0;">';
                    enrolledEvents.forEach(evt => {
                        html += '<li style="padding:5px 0;border-bottom:1px solid #eee;">â€¢ ' + evt.name + ' <span style="color:#666;">(' + evt.count + ' students)</span></li>';
                    });
                    html += '</ul>';
                } else {
                    html += '<p style="color:#999;font-style:italic;">No events enrolled yet</p>';
                }
                html += '</div>';
                
                // Pending Events
                html += '<div style="background:white;padding:15px;border-radius:6px;">';
                html += '<h4 style="color:#FF9800;margin-bottom:10px;">â³ Pending Events (' + pendingEvents.length + ')</h4>';
                if (pendingEvents.length > 0) {
                    html += '<ul style="list-style:none;padding:0;margin:0;">';
                    pendingEvents.forEach(evt => {
                        html += '<li style="padding:5px 0;border-bottom:1px solid #eee;">â€¢ ' + evt + '</li>';
                    });
                    html += '</ul>';
                } else {
                    html += '<p style="color:#999;font-style:italic;">All events completed!</p>';
                }
                html += '</div>';
                html += '</div>';
            }
            
            // When both Class and Event are selected
            if (selectedClass && selectedEvent) {
                const count = all.filter(e => e.classYear === selectedClass && e.event === selectedEvent).length;
                html += '<h3 style="color:#2196F3;margin-bottom:10px;">ðŸ“Š Filtered View</h3>';
                html += '<p style="margin:0;"><strong>Class:</strong> ' + selectedClass + ' | <strong>Event:</strong> ' + selectedEvent + ' | <strong>Total Students:</strong> ' + count + '</p>';
            }
            
            summaryContent.innerHTML = html;
        }

        function updateEvents() {
            const cont = document.getElementById('eventsContainer');
            if (all.length===0) { cont.innerHTML = '<p style="text-align:center;padding:40px">No data</p>'; return; }
            let h = '';
            Object.keys(events).forEach(ev => {
                const evEnr = all.filter(e => e.event===ev);
                if (evEnr.length===0) return;
                h += '<div style="background:#f9f9f9;padding:20px;border-radius:8px;margin-bottom:20px"><h3 style="color:#c44569;margin-bottom:15px">'+ev+' ('+evEnr.length+')</h3>';
                classes.forEach(cl => {
                    const clEnr = evEnr.filter(e => e.classYear===cl);
                    if (clEnr.length===0) return;
                    h += '<div style="background:white;padding:15px;border-radius:6px;margin-bottom:15px"><h4 style="color:#6a1b9a;margin-bottom:10px">'+cl+' ('+clEnr.length+')</h4><div class="table-wrapper"><table><thead><tr><th>Sl</th><th>Name</th><th>Phone</th><th>Role</th><th>Details</th></tr></thead><tbody>';
                    clEnr.forEach((e,i) => h += '<tr><td>'+(i+1)+'</td><td>'+e.name+'</td><td>'+e.phone+'</td><td>'+e.role+'</td><td>'+getDet(e)+'</td></tr>');
                    h += '</tbody></table></div></div>';
                });
                h += '</div>';
            });
            cont.innerHTML = h;
        }

        function clearFilters() {
            document.getElementById('filterClass').value = '';
            document.getElementById('filterEvent').value = '';
            updateMaster();
        }

        function getDet(e) {
            const d = [];
            if (e.topic) d.push('Topic: '+e.topic);
            if (e.product) d.push('Product: '+e.product);
            if (e.cause) d.push('Cause: '+e.cause);
            if (e.languages) d.push('Languages: '+e.languages);
            if (e.showstopper) d.push('Showstopper: '+e.showstopper);
            if (e.talentType) d.push('Talent: '+e.talentType);
            if (e.cameraName) d.push('ðŸ“¹ Camera: '+e.cameraName+(e.cameraPhone ? ' ('+e.cameraPhone+')' : ''));
            return d.length>0 ? d.join('<br>') : '-';
        }

        function downloadMaster() {
            if (all.length===0) { alert('No data'); return; }
            let csv = 'Sl,Name,Phone,Class,Event,Role,Details\n';
            all.forEach((e,i) => csv += (i+1)+',"'+e.name+'","'+e.phone+'","'+e.classYear+'","'+e.event+'","'+e.role+'","'+getDet(e).replace(/<br>/g,' | ')+'"\n');
            download(csv,'youthfest_master.csv');
        }

        function downloadEvents() {
            if (all.length===0) { alert('No data'); return; }
            let csv = '';
            Object.keys(events).forEach(ev => {
                const evEnr = all.filter(e => e.event===ev);
                if (evEnr.length===0) return;
                csv += '\n'+ev+'\n';
                csv += 'Sl,Name,Phone,Class,Role,Details\n';
                let sl = 1;
                evEnr.forEach(e => { csv += sl+',"'+e.name+'","'+e.phone+'","'+e.classYear+'","'+e.role+'","'+getDet(e).replace(/<br>/g,' | ')+'"\n'; sl++; });
            });
            download(csv,'youthfest_events.csv');
        }

        function download(content,filename) {
            const blob = new Blob([content],{type:'text/csv'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            URL.revokeObjectURL(url);
        }

        // Jury Setup Functions (Super Admin Only)
        function loadEventSetup() {
            const event = document.getElementById('setupEventSelect').value;
            if (!event) {
                document.getElementById('eventSetupContainer').style.display = 'none';
                document.getElementById('eventEligibilityBanner').style.display = 'none';
                return;
            }
            
            document.getElementById('eventSetupContainer').style.display = 'block';

            // Show event info banner
            const cfg = events[event] || {};
            const banner = document.getElementById('eventEligibilityBanner');
            const bannerText = document.getElementById('eventEligibilityText');
            bannerText.textContent = cfg.individual ? 'Individual event â€” multiple students per class can compete independently' : 'Team/Class event';
            banner.style.display = 'block';

            // Auto-detect event type from events config
            const autoIndividual = cfg.individual === true;
            const autoMultiteam  = cfg.multiTeam  === true && !cfg.individual;
            
            // Load existing setup
            db.ref('jurySetup/'+event).once('value').then(snap => {
                const data = snap.val() || {};
                
                // Load jury names
                document.getElementById('jury1Name').value = data.jury1Name || '';
                document.getElementById('jury2Name').value = data.jury2Name || '';
                
                // Load jury passwords
                document.getElementById('jury1Password').value = data.jury1Password || '';
                document.getElementById('jury2Password').value = data.jury2Password || '';

                // Load event type â€” use saved value, fall back to auto-detected
                const savedType = data.eventType || (autoIndividual ? 'individual' : autoMultiteam ? 'multiteam' : 'class');
                document.getElementById('eventTypeClass').checked      = savedType === 'class';
                document.getElementById('eventTypeIndividual').checked = savedType === 'individual';
                document.getElementById('eventTypeMultiteam').checked  = savedType === 'multiteam';
                
                // Load criteria
                const criteria = data.criteria || [];
                renderCriteriaInputs(criteria);
            });
        }

        function renderCriteriaInputs(criteria) {
            const container = document.getElementById('criteriaContainer');
            container.innerHTML = '';
            
            if (criteria.length === 0) {
                criteria = ['', '', '', '', ''];  // Default 5 empty criteria
            }
            
            criteria.forEach((crit, index) => {
                const div = document.createElement('div');
                div.className = 'criteria-input-group';
                div.innerHTML = `
                    <label>Criterion ${index + 1}:</label>
                    <input type="text" class="criterion-input" data-index="${index}" value="${crit}" placeholder="e.g., Stage Presence, Creativity, Coordination">
                    ${criteria.length > 5 ? '<button class="remove-criteria-btn" onclick="removeCriterion('+index+')">Remove</button>' : ''}
                `;
                container.appendChild(div);
            });
        }

        function addCriterion() {
            const inputs = document.querySelectorAll('.criterion-input');
            const criteria = Array.from(inputs).map(inp => inp.value.trim());
            criteria.push('');
            renderCriteriaInputs(criteria);
        }

        function removeCriterion(index) {
            const inputs = document.querySelectorAll('.criterion-input');
            const criteria = Array.from(inputs).map(inp => inp.value.trim());
            if (criteria.length <= 5) {
                alert('Minimum 5 criteria required');
                return;
            }
            criteria.splice(index, 1);
            renderCriteriaInputs(criteria);
        }

        function saveEventSetup() {
            const event = document.getElementById('setupEventSelect').value;
            if (!event) return;
            
            const jury1Name = document.getElementById('jury1Name').value.trim();
            const jury2Name = document.getElementById('jury2Name').value.trim();
            const jury1Pwd = document.getElementById('jury1Password').value.trim();
            const jury2Pwd = document.getElementById('jury2Password').value.trim();
            
            if (!jury1Pwd || !jury2Pwd) {
                alert('Please set both jury passwords');
                return;
            }
            
            const inputs = document.querySelectorAll('.criterion-input');
            const criteria = Array.from(inputs).map(inp => inp.value.trim()).filter(c => c);
            
            if (criteria.length < 5) {
                alert('Please add at least 5 criteria');
                return;
            }
            
            // Collect class aliases + order if loaded
            let classAliases = {};
            let classOrder = [];
            try { classAliases = getClassAliasesFromFields(); } catch(e) {}
            try { classOrder = getClassOrderFromFields(); } catch(e) {}

            // Event type: individual vs class-based
            const eventType = document.querySelector('input[name="juryEventType"]:checked')
                ? document.querySelector('input[name="juryEventType"]:checked').value
                : 'class';

            const setupData = {
                jury1Name: jury1Name || 'Jury 1',
                jury2Name: jury2Name || 'Jury 2',
                jury1Password: jury1Pwd,
                jury2Password: jury2Pwd,
                criteria: criteria,
                classAliases: classAliases,
                classOrder: classOrder,
                eventType: eventType,
                resultsPublished: false
            };
            
            db.ref('jurySetup/'+event).set(setupData).then(() => {
                showSetupMessage('Setup saved successfully! Event type: ' + (eventType === 'individual' ? 'ðŸ§‘ Individual' : eventType === 'multiteam' ? 'ðŸ‘¥ Multi-Team' : 'ðŸ« Class-based'), 'success');
            }).catch(err => {
                showSetupMessage('Error: '+err.message, 'error');
            });
        }

        function publishResults() {
            const event = document.getElementById('resultsEventSelect').value;
            if (!event) {
                alert('Please select an event first');
                return;
            }
            
            if (confirm('Publish results to all admins for '+event+'?')) {
                db.ref('jurySetup/'+event+'/resultsPublished').set(true).then(() => {
                    alert('âœ… Results published to admins for ' + event + '!');
                    // Show Results tab for all admins
                    updateResultsTabVisibility();
                });
            }
        }

        function unpublishResults() {
            const event = document.getElementById('resultsEventSelect').value;
            if (!event) {
                alert('Please select an event first');
                return;
            }
            
            if (confirm('Unpublish results for '+event+'?')) {
                db.ref('jurySetup/'+event+'/resultsPublished').set(false).then(() => {
                    alert('Results unpublished for ' + event);
                    // Check if any other results are published, hide tab if none
                    updateResultsTabVisibility();
                });
            }
        }

        function checkResultsPublished() {
            // For super admin, always show Results tab
            if (isSuperAdmin) {
                document.getElementById('resultsTab').style.display = 'block';
                return;
            }
            
            // For regular admin, check if any event has published results
            db.ref('jurySetup').once('value').then(snap => {
                let hasPublished = false;
                if (snap.exists()) {
                    snap.forEach(eventSnap => {
                        if (eventSnap.val().resultsPublished === true) {
                            hasPublished = true;
                        }
                    });
                }
                
                const resultsTab = document.getElementById('resultsTab');
                if (resultsTab) {
                    resultsTab.style.display = hasPublished ? 'block' : 'none';
                }
            });
        }
        
        function updateResultsTabVisibility() {
            // This is called after publish/unpublish to update tab visibility
            checkResultsPublished();
        }

        function showSetupMessage(msg, type) {
            const d = document.getElementById('setupMessage');
            d.className = 'message '+type+' show';
            d.textContent = (type === 'success' ? 'âœ“ ' : 'âœ— ') + msg;
            setTimeout(() => d.classList.remove('show'), 5000);
        }

        // Jury Functions
        function loadJurySheet() {
            console.log('=== LOADING JURY SHEET ===');
            console.log('juryEvent:', juryEvent);
            console.log('Current all array length:', all.length);
            console.log('Firebase ref path:', ref.toString());
            
            // Show loading message
            document.getElementById('jurySheetContainer').innerHTML = '<p style="text-align:center;padding:40px;color:#666;">Loading enrollments...</p>';
            
            // First ensure we have the latest enrollment data
            console.log('Fetching from Firebase...');
            ref.once('value').then(snap => {
                console.log('Firebase snapshot received');
                console.log('Snapshot exists:', snap.exists());
                console.log('Snapshot numChildren:', snap.numChildren());
                
                all = [];
                if (snap.exists()) {
                    let count = 0;
                    snap.forEach(child => {
                        count++;
                        const enrollment = {id: child.key, ...child.val()};
                        all.push(enrollment);
                        if (count <= 5) {
                            console.log('Enrollment ' + count + ':', enrollment);
                        }
                    });
                    console.log('Total enrollments loaded:', count);
                } else {
                    console.log('No enrollments found in Firebase!');
                }
                
                console.log('Loaded enrollments, all array length:', all.length);
                console.log('First 3 enrollments:', all.slice(0, 3));
                
                // Filter for current event
                const eventEnrollments = all.filter(e => {
                    console.log('Checking enrollment:', e.event, '===', juryEvent, '?', e.event === juryEvent);
                    return e.event === juryEvent;
                });
                console.log('Enrollments for event "' + juryEvent + '":', eventEnrollments.length);
                console.log('Event enrollments:', eventEnrollments);
                
                // Now get jury setup
                return db.ref('jurySetup/'+juryEvent).once('value');
            }).then(snap => {
                const setup = snap.val();
                console.log('Jury setup:', setup);
                
                if (!setup || !setup.criteria) {
                    document.getElementById('jurySheetContainer').innerHTML = '<p style="text-align:center;padding:40px;color:#999">Event setup not complete. Contact super admin.</p>';
                    return;
                }
                
                // Get enrolled classes for this event
                const enrolledClasses = [...new Set(all.filter(e => e.event === juryEvent).map(e => e.classYear))];
                
                console.log('Enrolled classes for', juryEvent, ':', enrolledClasses);
                console.log('Total classes found:', enrolledClasses.length);
                
                if (enrolledClasses.length === 0) {
                    let debugInfo = '<p style="text-align:center;padding:40px;">';
                    debugInfo += '<strong style="color:#f44336;">No classes enrolled for this event yet.</strong><br><br>';
                    debugInfo += '<span style="color:#666;">Event: ' + juryEvent + '<br>';
                    debugInfo += 'Total enrollments in database: ' + all.length + '<br>';
                    debugInfo += 'Enrollments for this event: ' + all.filter(e => e.event === juryEvent).length + '</span><br><br>';
                    debugInfo += '<button class="btn btn-info" onclick="showEnrollmentDebug()">ðŸ” Debug Enrollments</button>';
                    debugInfo += '</p>';
                    document.getElementById('jurySheetContainer').innerHTML = debugInfo;
                    return;
                }
                
                // Apply saved class order if available
                let orderedClasses = enrolledClasses.slice();
                if (setup.classOrder && setup.classOrder.length > 0) {
                    const ordered = setup.classOrder.filter(c => enrolledClasses.includes(c));
                    const remaining = enrolledClasses.filter(c => !ordered.includes(c));
                    orderedClasses = ordered.concat(remaining);
                }

                // Pass eventType and full enrollment records so renderJurySheet can handle individual events
                const eventEnrollmentsForRender = all.filter(e => e.event === juryEvent);
                renderJurySheet(orderedClasses, setup.criteria, setup.classAliases || {}, setup.eventType || 'class', eventEnrollmentsForRender);
                loadExistingMarks();
            }).catch(err => {
                console.error('Error loading jury sheet:', err);
                document.getElementById('jurySheetContainer').innerHTML = '<p style="text-align:center;padding:40px;color:red;">Error loading jury sheet: ' + err.message + '</p>';
            });
        }

        function renderJurySheet(enrolledClasses, criteria, aliasMap, eventType, eventEnrollments) {
            aliasMap    = aliasMap    || {};
            eventType   = eventType   || 'class';
            eventEnrollments = eventEnrollments || all.filter(e => e.event === juryEvent);

            let html = '';

            if (eventType === 'individual') {
                // â”€â”€ INDIVIDUAL EVENT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                // One row per enrolled student.
                // jury scores each student; leaderboard picks best per class.

                html += '<div style="background:#e3f2fd;border-left:5px solid #1565c0;padding:10px 16px;border-radius:8px;margin-bottom:14px;font-size:13px;color:#1a237e">';
                html += '<strong>&#x1F9D1; Individual Event Mode</strong> â€” Each student is scored separately. The leaderboard will use the <strong>best-scoring student from each class</strong> to determine class rankings.';
                html += '</div>';

                html += '<div class="table-wrapper"><div class="marks-table"><table><thead><tr>';
                html += '<th>#</th><th>Code Name</th><th>Class</th><th>Details</th>';
                criteria.forEach(crit => {
                    html += '<th>'+crit+'<br><small>(10 marks)</small></th>';
                });
                html += '<th>Total</th></tr></thead><tbody>';

                let seq = 1;
                enrolledClasses.forEach(cls => {
                    const safeKey = cls.replace(/[.\[\]#$\/\s]/g, '_');
                    const classAlias = aliasMap[safeKey] || cls;
                    const studentsInClass = eventEnrollments.filter(e => e.classYear === cls);
                    studentsInClass.forEach((enr, idx) => {
                        const rowKey = safeKey + '__p' + (idx + 1);
                        const displayLabel = classAlias + ' â€” P' + (idx + 1);
                        const detail = getDet(enr) || '-';
                        html += '<tr>';
                        html += '<td>'+seq+'</td>';
                        html += '<td><strong>'+displayLabel+'</strong></td>';
                        html += '<td><small style="color:#666">'+classAlias+'</small></td>';
                        html += '<td><small>'+detail+'</small></td>';
                        criteria.forEach((crit, i) => {
                            html += '<td><input type="number" class="marks-input" data-class="'+rowKey+'" data-origclass="'+cls+'" data-criterion="'+i+'" min="0" max="10" step="0.5" placeholder="0-10"></td>';
                        });
                        html += '<td class="total-marks" id="total-'+rowKey+'">0</td>';
                        html += '</tr>';
                        seq++;
                    });
                });

                html += '</tbody></table></div></div>';

            } else if (eventType === 'multiteam') {
                // â”€â”€ MULTI-TEAM EVENT (e.g. Vlog: up to 3 teams per class) â”€â”€â”€â”€â”€â”€â”€â”€â”€
                // Each team is a group of N members enrolled together under the same class.
                // Enrollment records for the same class are grouped into teams by their
                // sequential team number (stored as participantNum / teamNum on the record,
                // or we group by index order).
                // jury scores each team separately; leaderboard picks best team per class.

                html += '<div style="background:#fff3e0;border-left:5px solid #e65100;padding:10px 16px;border-radius:8px;margin-bottom:14px;font-size:13px;color:#bf360c">';
                html += '<strong>&#x1F465; Multi-Team Event Mode</strong> â€” Each team is scored separately. The leaderboard will use the <strong>best-scoring team from each class</strong> to determine class rankings.';
                html += '</div>';

                html += '<div class="table-wrapper"><div class="marks-table"><table><thead><tr>';
                html += '<th>#</th><th>Code Name</th><th>Class</th><th>Topic/Detail</th>';
                criteria.forEach(crit => {
                    html += '<th>'+crit+'<br><small>(10 marks)</small></th>';
                });
                html += '<th>Total</th></tr></thead><tbody>';

                let seq = 1;
                enrolledClasses.forEach(cls => {
                    const safeKey = cls.replace(/[.\[\]#$\/\s]/g, '_');
                    const classAlias = aliasMap[safeKey] || cls;

                    // Group enrollments into teams.
                    // Each enrollment record = one member. Members of the same team share a teamNum.
                    // We build unique teams: group by teamNum if present, else treat each record as its own team (for individual fallback).
                    const classEnrollments = eventEnrollments.filter(e => e.classYear === cls);

                    // Build teams: key = teamNum (or record index if no teamNum)
                    const teamsMap = {};
                    classEnrollments.forEach((enr, idx) => {
                        const tKey = (enr.teamNum !== undefined && enr.teamNum !== null) ? String(enr.teamNum) : String(idx + 1);
                        if (!teamsMap[tKey]) teamsMap[tKey] = [];
                        teamsMap[tKey].push(enr);
                    });

                    const teamNums = Object.keys(teamsMap).sort((a,b) => Number(a)-Number(b));
                    teamNums.forEach((tNum, tIdx) => {
                        const teamMembers = teamsMap[tNum];
                        const rowKey = safeKey + '__t' + (tIdx + 1);
                        const displayLabel = classAlias + ' â€” Team ' + (tIdx + 1);
                        // Use topic/detail from first member of team
                        const detail = getDet(teamMembers[0]) || '-';
                        html += '<tr>';
                        html += '<td>'+seq+'</td>';
                        html += '<td><strong>'+displayLabel+'</strong></td>';
                        html += '<td><small style="color:#666">'+classAlias+'</small></td>';
                        html += '<td><small>'+detail+'</small></td>';
                        criteria.forEach((crit, i) => {
                            html += '<td><input type="number" class="marks-input" data-class="'+rowKey+'" data-origclass="'+cls+'" data-criterion="'+i+'" min="0" max="10" step="0.5" placeholder="0-10"></td>';
                        });
                        html += '<td class="total-marks" id="total-'+rowKey+'">0</td>';
                        html += '</tr>';
                        seq++;
                    });
                });

                html += '</tbody></table></div></div>';

            } else {
                // â”€â”€ CLASS-BASED EVENT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                // One row per class (original behaviour)
                html += '<div class="table-wrapper"><div class="marks-table"><table><thead><tr>';
                html += '<th>Code Name</th><th>Theme/Topic</th>';
                criteria.forEach(crit => {
                    html += '<th>'+crit+'<br><small>(10 marks)</small></th>';
                });
                html += '<th>Total</th></tr></thead><tbody>';

                enrolledClasses.forEach(cls => {
                    const safeKey = cls.replace(/[.\[\]#$\/\s]/g, '_');
                    const displayName = aliasMap[safeKey] || cls;
                    const classEnrollments = eventEnrollments.filter(e => e.classYear === cls);
                    const theme = classEnrollments.length > 0 ? getDet(classEnrollments[0]) : '-';

                    html += '<tr><td><strong>'+displayName+'</strong></td><td>'+theme+'</td>';
                    criteria.forEach((crit, i) => {
                        html += '<td><input type="number" class="marks-input" data-class="'+cls+'" data-criterion="'+i+'" min="0" max="10" step="0.5" placeholder="0-10"></td>';
                    });
                    html += '<td class="total-marks" id="total-'+cls.replace(/\s+/g, '-')+'">0</td></tr>';
                });

                html += '</tbody></table></div></div>';
            }
            
            document.getElementById('jurySheetContainer').innerHTML = html;
            
            // Add event listeners for auto-calculation
            document.querySelectorAll('.marks-input').forEach(inp => {
                inp.addEventListener('input', function() {
                    calculateTotal(this.dataset.class);
                });
            });
        }

        function loadExistingMarks() {
            const dbPath = 'juryMarks/' + juryEvent + '/jury' + juryNumber;
            console.log('=== LOADING EXISTING MARKS ===');
            console.log('Loading marks from:', dbPath);
            console.log('juryEvent:', juryEvent);
            console.log('juryNumber:', juryNumber);
            
            db.ref(dbPath).once('value').then(snap => {
                const marks = snap.val();
                console.log('Loaded marks data:', JSON.stringify(marks, null, 2));
                
                if (!marks) {
                    console.log('No existing marks found');
                    return;
                }
                
                // Check if this is test data (has 'test' property instead of class data)
                if (marks.test !== undefined) {
                    console.warn('âš ï¸ TEST DATA DETECTED in database!');
                    console.warn('Path contains test data instead of actual marks');
                    console.warn('You should clear this test data from Firebase Console');
                    showJuryMessage('Warning: Test data found in database. Clear it before saving real marks.', 'error');
                    return;
                }
                
                // Check what's in the database
                console.log('Database keys:', Object.keys(marks));
                
                // Check what inputs are available
                const allInputs = document.querySelectorAll('.marks-input');
                console.log('Total inputs found:', allInputs.length);
                allInputs.forEach(inp => {
                    console.log('Input found - class:', inp.dataset.class, 'criterion:', inp.dataset.criterion);
                });
                
                let marksLoaded = 0;
                
                Object.keys(marks).forEach(sanitizedCls => {
                    console.log('Processing class from database:', sanitizedCls);
                    
                    if (marks[sanitizedCls] && marks[sanitizedCls].marks && Array.isArray(marks[sanitizedCls].marks)) {
                        console.log('Marks array for', sanitizedCls, ':', marks[sanitizedCls].marks);
                        
                        // Get the original class name if available, otherwise use the sanitized one
                        const originalCls = marks[sanitizedCls].originalClassName || sanitizedCls;
                        console.log('Original class name:', originalCls);
                        
                        marks[sanitizedCls].marks.forEach((mark, i) => {
                            // Try to find input using original class name first
                            let selector = '.marks-input[data-class="'+originalCls+'"][data-criterion="'+i+'"]';
                            let inp = document.querySelector(selector);
                            
                            // If not found, try sanitized class name
                            if (!inp) {
                                selector = '.marks-input[data-class="'+sanitizedCls+'"][data-criterion="'+i+'"]';
                                inp = document.querySelector(selector);
                            }
                            
                            console.log('Looking for input with selector:', selector);
                            
                            if (inp) {
                                inp.value = mark;
                                marksLoaded++;
                                console.log('âœ“ Set mark for', originalCls, 'criterion', i, ':', mark);
                            } else {
                                console.warn('âœ— Input NOT found for class:', originalCls, '(sanitized:', sanitizedCls, ') criterion:', i);
                            }
                        });
                        calculateTotal(originalCls);
                    } else {
                        console.warn('Invalid marks structure for class:', sanitizedCls, marks[sanitizedCls]);
                    }
                });
                
                if (marksLoaded > 0) {
                    showJuryMessage('Previous marks loaded successfully ('+marksLoaded+' marks)', 'success');
                } else {
                    showJuryMessage('No previous marks found to load', 'error');
                }
            }).catch(err => {
                console.error('Error loading marks:', err);
                showJuryMessage('Error loading marks: ' + err.message, 'error');
            });
        }

        function calculateTotal(cls) {
            const inputs = document.querySelectorAll('.marks-input[data-class="'+cls+'"]');
            let total = 0;
            inputs.forEach(inp => {
                const val = parseFloat(inp.value) || 0;
                total += val;
            });
            const totalCell = document.getElementById('total-'+cls.replace(/\s+/g, '-'));
            if (totalCell) totalCell.textContent = total.toFixed(1);
        }

        function sanitizeKey(key) {
            // Replace characters that Firebase doesn't allow in keys
            // . $ # [ ] / and control characters
            return key.replace(/[.#$\[\]\/]/g, '_');
        }

        function saveMarks() {
            console.log('=== SAVE MARKS STARTED ===');
            console.log('juryEvent:', juryEvent);
            console.log('juryNumber:', juryNumber);
            console.log('Database connected:', isConnected);
            
            if (!juryEvent || !juryNumber) {
                alert('Error: Jury session not initialized. Please log in again.');
                return;
            }
            
            if (!isConnected) {
                alert('Error: Not connected to Firebase database. Please check your internet connection.');
                return;
            }
            
            const marksData = {};
            let inputCount = 0;
            
            // First, organize marks by class
            document.querySelectorAll('.marks-input').forEach(inp => {
                inputCount++;
                const cls = inp.dataset.class;
                const sanitizedCls = sanitizeKey(cls); // Sanitize class name for Firebase
                const critIndex = parseInt(inp.dataset.criterion);
                const val = parseFloat(inp.value) || 0;
                
                if (!marksData[sanitizedCls]) {
                    marksData[sanitizedCls] = { 
                        marks: {}, 
                        completed: false,
                        originalClassName: cls // Store original name
                    };
                }
                marksData[sanitizedCls].marks[critIndex] = val;
            });
            
            // Convert marks object to array to ensure proper structure
            Object.keys(marksData).forEach(cls => {
                const marksObj = marksData[cls].marks;
                const marksArray = [];
                const maxIndex = Math.max(...Object.keys(marksObj).map(k => parseInt(k)));
                
                // Fill array with all marks
                for (let i = 0; i <= maxIndex; i++) {
                    marksArray[i] = marksObj[i] !== undefined ? marksObj[i] : 0;
                }
                
                marksData[cls].marks = marksArray;
            });
            
            console.log('Marks inputs found:', inputCount);
            console.log('Marks data to save:', JSON.stringify(marksData, null, 2));
            
            if (inputCount === 0) {
                alert('No marks data found. Please refresh the page and try again.');
                return;
            }
            
            // Show saving indicator
            showJuryMessage('Saving marks...', 'success');
            
            // Use raw event name (do not encode)
            const dbPath = 'juryMarks/' + juryEvent + '/jury' + juryNumber;
            console.log('Event name:', juryEvent);
            console.log('Saving to Firebase path:', dbPath);
            console.log('Full database URL:', db.ref(dbPath).toString());
            
            // CRITICAL FIX: First check if there's test data and clear it
            db.ref(dbPath).once('value').then(snap => {
                const existingData = snap.val();
                
                // Check if test data exists
                if (existingData && existingData.test !== undefined) {
                    console.warn('âš ï¸ Test data detected! Clearing before save...');
                    showJuryMessage('Clearing test data...', 'success');
                    // First delete the entire node to clear test data
                    return db.ref(dbPath).remove();
                }
                
                return Promise.resolve();
            }).then(() => {
                console.log('Now saving actual marks data...');
                // Now save the actual marks data
                return db.ref(dbPath).set(marksData);
            }).then(() => {
                console.log('âœ“ Firebase .set() resolved successfully');
                
                // Immediately verify the save
                return db.ref(dbPath).once('value');
            }).then(snap => {
                const savedData = snap.val();
                console.log('âœ“ Verification read successful');
                console.log('Data in database:', JSON.stringify(savedData, null, 2));
                
                if (savedData && savedData.test === undefined) {
                    // Check that we have actual class data, not test data
                    const hasRealData = Object.keys(savedData).some(key => 
                        savedData[key] && savedData[key].marks && Array.isArray(savedData[key].marks)
                    );
                    
                    if (hasRealData) {
                        showJuryMessage('Marks saved successfully!', 'success');
                        alert('âœ… SUCCESS!\n\nMarks saved and verified in database.\n\n' + 
                              'Classes saved: ' + Object.keys(savedData).length + '\n\n' +
                              'Path: juryMarks/' + juryEvent + '/jury' + juryNumber);
                    } else {
                        console.error('âœ— VERIFICATION FAILED: Data saved but structure is wrong');
                        showJuryMessage('Warning: Data saved but structure may be incorrect', 'error');
                    }
                } else if (savedData && savedData.test !== undefined) {
                    console.error('âœ— TEST DATA STILL EXISTS after save attempt');
                    showJuryMessage('Error: Test data blocking saves. Please clear manually.', 'error');
                    alert('âš ï¸ TEST DATA PROBLEM!\n\nTest data is still in the database.\n\n' +
                          'Please manually delete from Firebase Console:\n' +
                          'juryMarks > Solo Dance > jury1 > test');
                } else {
                    console.error('âœ— VERIFICATION FAILED: Data is null after save');
                    showJuryMessage('Warning: Save completed but verification failed', 'error');
                    alert('âš ï¸ WARNING!\n\nSave appeared successful but data could not be verified.\n\n' +
                          'Possible issue: Firebase security rules may be blocking reads.\n\n' +
                          'Please check Firebase Console > Realtime Database > Rules');
                }
            }).catch(err => {
                console.error('âœ— FIREBASE ERROR:', err);
                console.error('Error code:', err.code);
                console.error('Error message:', err.message);
                
                let errorMsg = 'âŒ SAVE FAILED!\n\n';
                
                if (err.code === 'PERMISSION_DENIED' || err.message.includes('permission')) {
                    errorMsg += 'ERROR: Permission Denied\n\n';
                    errorMsg += 'Firebase security rules are blocking the save.\n\n';
                    errorMsg += 'SOLUTION:\n';
                    errorMsg += '1. Go to Firebase Console\n';
                    errorMsg += '2. Realtime Database > Rules\n';
                    errorMsg += '3. Set rules to allow writes\n\n';
                    errorMsg += 'See browser console for details.';
                    
                    console.log('%c FIREBASE RULES FIX NEEDED ', 'background: red; color: white; font-size: 16px; font-weight: bold;');
                    console.log('Your current Firebase rules are blocking writes to: ' + dbPath);
                    console.log('\nTo fix this, update your Firebase Realtime Database Rules to:');
                    console.log('{\n  "rules": {\n    ".read": true,\n    ".write": true\n  }\n}');
                    console.log('\nOR for better security:');
                    console.log('{\n  "rules": {\n    "juryMarks": {\n      ".read": true,\n      ".write": true\n    },\n    "jurySetup": {\n      ".read": true,\n      ".write": true\n    },\n    "youthfest-enrollments": {\n      ".read": true,\n      ".write": true\n    }\n  }\n}');
                } else {
                    errorMsg += 'Error: ' + err.message + '\n\n';
                        errorMsg += 'Code: ' + err.code + '\n\n';
                        errorMsg += 'Check browser console for details.';
                    }
                    
                    showJuryMessage('Error: ' + err.message, 'error');
                    alert(errorMsg);
                });
        }

        function markAsCompleted() {
            if (!confirm('Mark evaluation as completed? You can still edit marks later.')) return;
            
            const marksData = {};
            
            // First, organize marks by class
            document.querySelectorAll('.marks-input').forEach(inp => {
                const cls = inp.dataset.class;
                const sanitizedCls = sanitizeKey(cls); // Sanitize class name
                const critIndex = parseInt(inp.dataset.criterion);
                const val = parseFloat(inp.value) || 0;
                
                if (!marksData[sanitizedCls]) {
                    marksData[sanitizedCls] = { 
                        marks: {}, 
                        completed: true,
                        originalClassName: cls
                    };
                }
                marksData[sanitizedCls].marks[critIndex] = val;
            });
            
            // Convert marks object to array to ensure proper structure
            Object.keys(marksData).forEach(cls => {
                const marksObj = marksData[cls].marks;
                const marksArray = [];
                const maxIndex = Math.max(...Object.keys(marksObj).map(k => parseInt(k)));
                
                // Fill array with all marks
                for (let i = 0; i <= maxIndex; i++) {
                    marksArray[i] = marksObj[i] !== undefined ? marksObj[i] : 0;
                }
                
                marksData[cls].marks = marksArray;
            });
            
            const dbPath = 'juryMarks/' + juryEvent + '/jury' + juryNumber;
            
            db.ref(dbPath).set(marksData).then(async () => {
                showJuryMessage('Evaluation marked as completed!', 'success');
                // Reveal real class names and show rankings
                try {
                    const setupSnap = await db.ref('jurySetup/' + juryEvent).once('value');
                    const setup = setupSnap.val() || {};
                    const aliasMap = setup.classAliases || {};
                    // Build reverse: safeKey -> real class
                    const realClasses = {};
                    all.filter(e => e.event === juryEvent).forEach(e => {
                        const sk = e.classYear.replace(/[.\[\]#$\/\s]/g, '_');
                        realClasses[sk] = e.classYear;
                    });
                    // Tally totals from submitted marksData
                    const totals = [];
                    Object.entries(marksData).forEach(([sk, d]) => {
                        const total = (d.marks || []).reduce((s, v) => s + (parseFloat(v)||0), 0);
                        const alias = aliasMap[sk] || sk;
                        const real = realClasses[sk] || sk;
                        totals.push({ sk, alias, real, total });
                    });
                    totals.sort((a, b) => b.total - a.total);
                    let msg = 'Evaluation marked as completed!\n\nRESULTS REVEALED:\n';
                    totals.forEach((t, i) => {
                        const medal = i === 0 ? 'WINNER' : i === 1 ? 'RUNNER-UP' : (i+1)+'.';
                        msg += '\n' + medal + ': ' + t.alias + ' = ' + t.real + ' (' + t.total.toFixed(1) + ' marks)';
                    });
                    alert(msg);
                } catch(e) {
                    alert('Evaluation marked as completed! Your marks are now final.');
                }
            }).catch(err => {
                showJuryMessage('Error: '+err.message, 'error');
                alert('âŒ Error: '+err.message);
            });
        }

        function showJuryMessage(msg, type) {
            const d = document.getElementById('juryMessage');
            d.className = 'message '+type+' show';
            d.textContent = (type === 'success' ? 'âœ“ ' : 'âœ— ') + msg;
            setTimeout(() => d.classList.remove('show'), 5000);
            d.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }

        // Results Functions
        function loadResultsTab() {
            // Populate event select for results
            const sel = document.getElementById('resultsEventSelect');
            sel.innerHTML = '<option value="">-- Select Event --</option>';
            
            db.ref('jurySetup').once('value').then(snap => {
                if (!snap.exists()) return;
                
                snap.forEach(child => {
                    const event = child.key;
                    const setup = child.val();
                    
                    // For super admin, show all events
                    // For admin, show only published events
                    if (isSuperAdmin || setup.resultsPublished) {
                        const opt = document.createElement('option');
                        opt.value = event;
                        opt.textContent = event + (setup.resultsPublished ? ' âœ“' : '');
                        sel.appendChild(opt);
                    }
                });
            });
        }

        function loadEventResults() {
            const event = document.getElementById('resultsEventSelect').value;
            console.log('Loading results for event:', event);
            
            if (!event) {
                document.getElementById('resultsContainer').innerHTML = '';
                return;
            }
            
            // Load jury setup to get names and publication status
            db.ref('jurySetup/'+event).once('value').then(setupSnap => {
                const setup = setupSnap.val() || {};
                console.log('Results published status:', setup.resultsPublished);
                
                if (!isSuperAdmin && !setup.resultsPublished) {
                    document.getElementById('resultsContainer').innerHTML = '<p style="text-align:center;padding:40px;color:#999">Results not yet published by super admin.</p>';
                    return;
                }
                
                const jury1Name = setup.jury1Name || 'Jury 1';
                const jury2Name = setup.jury2Name || 'Jury 2';
                
                // Load marks from both juries using raw event name
                console.log('Loading marks from both juries...');
                Promise.all([
                    db.ref('juryMarks/'+event+'/jury1').once('value'),
                    db.ref('juryMarks/'+event+'/jury2').once('value')
                ]).then(([jury1Snap, jury2Snap]) => {
                    const jury1Marks = jury1Snap.val() || {};
                    const jury2Marks = jury2Snap.val() || {};
                    
                    console.log('Jury 1 Marks:', jury1Marks);
                    console.log('Jury 2 Marks:', jury2Marks);
                    
                    displayResults(event, jury1Marks, jury2Marks, jury1Name, jury2Name);
                });
            });
        }

        function displayResults(event, jury1Marks, jury2Marks, jury1Name, jury2Name) {
            // Default names if not provided
            jury1Name = jury1Name || 'Jury 1';
            jury2Name = jury2Name || 'Jury 2';
            
            console.log('=== DISPLAY RESULTS DEBUG ===');
            console.log('Jury 1 Marks:', jury1Marks);
            console.log('Jury 2 Marks:', jury2Marks);
            
            const allClasses = new Set([...Object.keys(jury1Marks), ...Object.keys(jury2Marks)]);
            
            if (allClasses.size === 0) {
                document.getElementById('resultsContainer').innerHTML = '<p style="text-align:center;padding:40px;color:#999">No marks submitted yet.</p>';
                return;
            }
            
            // Calculate totals and averages
            const results = [];
            allClasses.forEach(sanitizedCls => {
                const j1 = jury1Marks[sanitizedCls];
                const j2 = jury2Marks[sanitizedCls];
                
                console.log('Class:', sanitizedCls);
                console.log('  Jury1 data:', j1);
                console.log('  Jury1 completed?:', j1 && j1.completed);
                console.log('  Jury2 data:', j2);
                console.log('  Jury2 completed?:', j2 && j2.completed);
                
                // Get original class name if available
                const displayCls = (j1 && j1.originalClassName) || 
                                  (j2 && j2.originalClassName) || 
                                  sanitizedCls;
                
                let j1Total = 0;
                let j2Total = 0;
                
                if (j1 && j1.marks) {
                    j1Total = j1.marks.reduce((sum, m) => sum + (m || 0), 0);
                }
                if (j2 && j2.marks) {
                    j2Total = j2.marks.reduce((sum, m) => sum + (m || 0), 0);
                }
                
                const avgTotal = (j1Total + j2Total) / 2;
                
                results.push({
                    class: displayCls,  // Use original name for display
                    jury1Total: j1Total,
                    jury2Total: j2Total,
                    average: avgTotal,
                    jury1Completed: j1 && j1.completed,
                    jury2Completed: j2 && j2.completed
                });
            });
            
            // Sort by average (descending)
            results.sort((a, b) => b.average - a.average);
            
            // Display results
            let html = '<h3 style="color:#c44569;margin-bottom:20px">Results for '+event+'</h3>';
            
            // Show marks detail only for super admin and jury
            if (isSuperAdmin || isJury) {
                html += '<div class="table-wrapper"><table><thead><tr><th>Rank</th><th>Class</th><th>'+jury1Name+' Total</th><th>'+jury2Name+' Total</th><th>Average</th><th>Status</th></tr></thead><tbody>';
                
                results.forEach((r, i) => {
                    const rank = i + 1;
                    const badge = rank === 1 ? '<span class="winner-badge">ðŸ† Winner</span>' : 
                                 rank === 2 ? '<span class="runner-badge">ðŸ¥ˆ Runner Up</span>' : '';
                    
                    html += '<tr class="rank-'+(rank <= 3 ? rank : '')+'">';
                    html += '<td><strong>'+rank+'</strong></td>';
                    html += '<td><strong>'+r.class+'</strong> '+badge+'</td>';
                    html += '<td>'+r.jury1Total.toFixed(1)+(r.jury1Completed ? ' âœ“' : '')+'</td>';
                    html += '<td>'+r.jury2Total.toFixed(1)+(r.jury2Completed ? ' âœ“' : '')+'</td>';
                    html += '<td><strong>'+r.average.toFixed(1)+'</strong></td>';
                    html += '<td>'+(r.jury1Completed && r.jury2Completed ? 'âœ… Complete' : 'â³ In Progress')+'</td>';
                    html += '</tr>';
                });
                
                html += '</tbody></table></div>';
            } else {
                // For regular admins, show only final results (no marks)
                results.forEach((r, i) => {
                    const rank = i + 1;
                    html += '<div class="results-card rank-'+rank+'">';
                    html += '<h3 style="color:#c44569;">Rank '+rank+': '+r.class;
                    if (rank === 1) html += ' <span class="winner-badge">ðŸ† Winner</span>';
                    if (rank === 2) html += ' <span class="runner-badge">ðŸ¥ˆ Runner Up</span>';
                    html += '</h3>';
                    html += '<p style="color:#666;margin-top:10px">Final Score: <strong>'+r.average.toFixed(1)+'</strong></p>';
                    html += '</div>';
                });
            }
            
            document.getElementById('resultsContainer').innerHTML = html;
        }

        function clearTestData() {
            if (!confirm('Clear test data from Firebase?\n\nThis will ONLY delete:\n- juryMarks/TEST/*\n\nYour actual marks will NOT be affected.')) {
                return;
            }
            
            console.log('=== CLEARING TEST DATA ===');
            
            // Only clear the TEST node - DO NOT touch the actual jury path
            db.ref('juryMarks/TEST').remove()
            .then(() => {
                console.log('âœ“ Test data cleared');
                showJuryMessage('Test data cleared successfully! Your actual marks are safe.', 'success');
                alert('âœ… Test data cleared!\n\nYour actual marks are safe and untouched.');
            }).catch(err => {
                console.error('Error clearing test data:', err);
                showJuryMessage('Error clearing test data: ' + err.message, 'error');
            });
        }

        function debugLoadMarks() {
            console.log('=== DEBUG LOAD MARKS ===');
            console.log('juryEvent:', juryEvent);
            console.log('juryNumber:', juryNumber);
            
            const dbPath = 'juryMarks/' + juryEvent + '/jury' + juryNumber;
            console.log('Database path:', dbPath);
            
            // First check what's in the database
            db.ref(dbPath).once('value').then(snap => {
                const data = snap.val();
                console.log('Raw database data:', data);
                console.log('Data as JSON:', JSON.stringify(data, null, 2));
                
                // Check all inputs on the page
                const inputs = document.querySelectorAll('.marks-input');
                console.log('Total inputs on page:', inputs.length);
                
                const inputDetails = [];
                inputs.forEach((inp, idx) => {
                    inputDetails.push({
                        index: idx,
                        class: inp.dataset.class,
                        criterion: inp.dataset.criterion,
                        value: inp.value
                    });
                });
                console.table(inputDetails);
                
                // Show a detailed report
                let report = '=== DEBUG REPORT ===\n\n';
                report += 'Database Path: ' + dbPath + '\n\n';
                report += 'Database Content:\n' + JSON.stringify(data, null, 2) + '\n\n';
                report += 'Total Inputs Found: ' + inputs.length + '\n\n';
                report += 'Input Details:\n';
                inputDetails.forEach(inp => {
                    report += `  [${inp.index}] Class: "${inp.class}", Criterion: ${inp.criterion}, Value: ${inp.value}\n`;
                });
                
                console.log(report);
                alert(report);
                
            }).catch(err => {
                console.error('Debug load error:', err);
                alert('Debug load failed: ' + err.message);
            });
        }

        // ============================================================
        // CLASS ALIAS SYSTEM â€” assigns code names to real class names
        // ============================================================
        async function loadClassAliasFields() {
            const event = document.getElementById('setupEventSelect').value;
            if (!event) { alert('Please select an event first.'); return; }
            const container = document.getElementById('classAliasContainer');
            container.innerHTML = '<p style="color:#aaa;font-size:13px">Loading enrolled classes...</p>';
            try {
                const snap = await db.ref('youthfest-enrollments').once('value');
                const classes = [];
                if (snap.exists()) {
                    snap.forEach(child => {
                        const e = child.val();
                        if (e.event === event && e.classYear && !classes.includes(e.classYear)) {
                            classes.push(e.classYear);
                        }
                    });
                }
                // Load existing setup (aliases + order)
                const setupSnap = await db.ref('jurySetup/' + event).once('value');
                const existingSetup = setupSnap.val() || {};
                const existing = existingSetup.classAliases || {};
                const existingOrder = existingSetup.classOrder || [];

                if (classes.length === 0) {
                    container.innerHTML = '<p style="color:#e53935;font-size:13px">No enrolled classes found for this event.</p>';
                    return;
                }

                // Apply saved order if available, else default order
                let orderedClasses = classes.slice();
                if (existingOrder.length > 0) {
                    const ordered = existingOrder.filter(c => classes.includes(c));
                    const remaining = classes.filter(c => !ordered.includes(c));
                    orderedClasses = ordered.concat(remaining);
                }

                function rebuildTable() {
                    const rows = container.querySelectorAll('tr[data-cls]');
                    const currentOrder = Array.from(rows).map(r => r.dataset.cls);
                    let html = '';
                    currentOrder.forEach((cls, i) => {
                        const safeKey = cls.replace(/[.\[\]#$\/\s]/g, '_');
                        const currentAlias = (container.querySelector('input[data-safekey="' + safeKey + '"]') || {}).value
                            || existing[safeKey] || ('Class ' + String.fromCharCode(65 + i));
                        html += buildRow(cls, safeKey, currentAlias, i, currentOrder.length);
                    });
                    tbody.innerHTML = html;
                    attachDragEvents();
                }

                function buildRow(cls, safeKey, alias, i, total) {
                    return '<tr data-cls="' + cls + '" style="background:' + (i%2===0?'#fff':'#f9f0ff') + ';border-bottom:1px solid #e8d5ff">'
                        + '<td style="padding:8px 6px;cursor:grab;text-align:center;color:#9c27b0;font-size:16px" title="Drag to reorder">&#9776;</td>'
                        + '<td style="padding:8px 10px;color:#6c757d;font-weight:700;font-size:13px">' + (i+1) + '</td>'
                        + '<td style="padding:8px 10px;font-size:13px;font-weight:600;color:#333">' + cls + '</td>'
                        + '<td style="padding:8px 10px">'
                        +   '<input type="text" data-safekey="' + safeKey + '" value="' + alias + '" '
                        +   'style="padding:5px 10px;border:1.5px solid #9c27b0;border-radius:6px;width:160px;font-size:13px" '
                        +   'placeholder="e.g. Class A">'
                        + '</td>'
                        + '<td style="padding:8px 6px;text-align:center">'
                        +   (i > 0 ? '<button onclick="moveClassRow(this,-1)" style="background:#e3d5f7;border:none;border-radius:4px;padding:2px 7px;cursor:pointer;margin-right:2px">&#9650;</button>' : '')
                        +   (i < total-1 ? '<button onclick="moveClassRow(this,1)" style="background:#e3d5f7;border:none;border-radius:4px;padding:2px 7px;cursor:pointer">&#9660;</button>' : '')
                        + '</td>'
                        + '</tr>';
                }

                let tableHTML = '<table style="width:100%;border-collapse:collapse" id="aliasTable">'
                    + '<thead><tr style="background:linear-gradient(135deg,#6a1b9a,#c44569);color:white">'
                    + '<th style="padding:8px 6px;width:30px"></th>'
                    + '<th style="padding:8px 10px;width:40px;text-align:left">#</th>'
                    + '<th style="padding:8px 10px;text-align:left">Real Class Name</th>'
                    + '<th style="padding:8px 10px;text-align:left">Code Name shown to Jury</th>'
                    + '<th style="padding:8px 6px;width:70px">Order</th>'
                    + '</tr></thead>'
                    + '<tbody id="aliasTableBody"></tbody>'
                    + '</table>';

                container.innerHTML = tableHTML;
                container.dataset.classes = JSON.stringify(orderedClasses);
                const tbody = container.querySelector('#aliasTableBody');

                orderedClasses.forEach((cls, i) => {
                    const safeKey = cls.replace(/[.\[\]#$\/\s]/g, '_');
                    const alias = existing[safeKey] || ('Class ' + String.fromCharCode(65 + i));
                    tbody.innerHTML += buildRow(cls, safeKey, alias, i, orderedClasses.length);
                });

                attachDragEvents();

            } catch(e) {
                container.innerHTML = '<p style="color:red;font-size:13px">Error: ' + e.message + '</p>';
            }
        }

        function moveClassRow(btn, dir) {
            const row = btn.closest('tr');
            const tbody = row.parentNode;
            const rows = Array.from(tbody.querySelectorAll('tr[data-cls]'));
            const idx = rows.indexOf(row);
            const newIdx = idx + dir;
            if (newIdx < 0 || newIdx >= rows.length) return;
            if (dir === -1) tbody.insertBefore(row, rows[newIdx]);
            else tbody.insertBefore(rows[newIdx], row);
            // Renumber
            Array.from(tbody.querySelectorAll('tr[data-cls]')).forEach((r, i) => {
                const numCell = r.cells[1];
                if (numCell) numCell.textContent = i + 1;
                r.style.background = i%2===0?'#fff':'#f9f0ff';
            });
        }

        function attachDragEvents() {
            const tbody = document.getElementById('aliasTableBody');
            if (!tbody) return;
            let dragSrc = null;
            tbody.querySelectorAll('tr[data-cls]').forEach(row => {
                row.draggable = true;
                row.addEventListener('dragstart', function() { dragSrc = this; this.style.opacity='0.5'; });
                row.addEventListener('dragend', function() { this.style.opacity='1'; });
                row.addEventListener('dragover', function(e) { e.preventDefault(); });
                row.addEventListener('drop', function(e) {
                    e.preventDefault();
                    if (dragSrc && dragSrc !== this) {
                        const rows = Array.from(tbody.querySelectorAll('tr[data-cls]'));
                        const srcIdx = rows.indexOf(dragSrc);
                        const tgtIdx = rows.indexOf(this);
                        if (srcIdx < tgtIdx) tbody.insertBefore(dragSrc, this.nextSibling);
                        else tbody.insertBefore(dragSrc, this);
                        rows.forEach((r, i) => {
                            r.cells[1].textContent = i + 1;
                            r.style.background = i%2===0?'#fff':'#f9f0ff';
                        });
                    }
                });
            });
        }

        function getClassAliasesFromFields() {
            const tbody = document.getElementById('aliasTableBody');
            if (!tbody) return {};
            const aliases = {};
            tbody.querySelectorAll('tr[data-cls]').forEach(row => {
                const inp = row.querySelector('input[data-safekey]');
                if (inp) aliases[inp.dataset.safekey] = inp.value.trim() || inp.dataset.safekey;
            });
            return aliases;
        }

        function getClassOrderFromFields() {
            const tbody = document.getElementById('aliasTableBody');
            if (!tbody) return [];
            return Array.from(tbody.querySelectorAll('tr[data-cls]')).map(r => r.dataset.cls);
        }

        // ============================================================
        // MODIFIED: saveEventSetup â€” also saves classAliases
        // ============================================================
        const _origSaveEventSetup = window.saveEventSetup;

        // ============================================================
        // RENDER JURY SHEET WITH ALIASES (replace class names with code names)
        // ============================================================
        async function getAliasMap(event) {
            try {
                const snap = await db.ref('jurySetup/' + event + '/classAliases').once('value');
                return snap.val() || {};
            } catch(e) { return {}; }
        }

        function realToAlias(cls, aliasMap) {
            const safeKey = cls.replace(/[.\[\]#$\/\s]/g, '_');
            return aliasMap[safeKey] || cls;
        }
        function aliasToReal(alias, aliasMap) {
            for (const [key, val] of Object.entries(aliasMap)) {
                if (val === alias) return key; // safeKey
            }
            return alias;
        }
        // Build reverse map: safeKey â†’ real class name from enrollment
        window._juryAliasMap = {};
        window._juryRealClasses = {}; // safeKey â†’ real class name

        // ============================================================
        // LIVE JURY MONITOR (Super Admin)
        // ============================================================
        let _liveMonitorListeners = [];

        async function startLiveJuryMonitor() {
            // Stop old listeners
            _liveMonitorListeners.forEach(off => off());
            _liveMonitorListeners = [];

            // Populate event dropdown if needed
            const sel = document.getElementById('liveMonitorEvent');
            if (sel && sel.options.length <= 1) {
                const s = await db.ref('jurySetup').once('value');
                if (s.exists()) s.forEach(child => {
                    const o = document.createElement('option');
                    o.value = child.key; o.textContent = child.key;
                    sel.appendChild(o);
                });
            }

            const event = sel ? sel.value : '';
            const container = document.getElementById('liveJuryMonitorContainer');
            if (!event) {
                container.innerHTML = '<p style="color:#999;text-align:center;padding:30px">Select an event above.</p>';
                return;
            }

            container.innerHTML = '<p style="color:#aaa;text-align:center;padding:20px">â³ Loading...</p>';

            try {
                const [setupSnap, enrollSnap] = await Promise.all([
                    db.ref('jurySetup/' + event).once('value'),
                    db.ref('youthfest-enrollments').once('value')
                ]);
                const setup = setupSnap.val();
                if (!setup || !setup.criteria) {
                    container.innerHTML = '<p style="color:#999;text-align:center;padding:20px">No jury setup found for this event.</p>';
                    return;
                }
                const aliasMap = setup.classAliases || {};
                const criteria = setup.criteria;
                // Get enrolled classes
                const classes = [];
                if (enrollSnap.exists()) {
                    enrollSnap.forEach(c => {
                        const e = c.val();
                        if (e.event === event && e.classYear && !classes.includes(e.classYear)) classes.push(e.classYear);
                    });
                }

                function renderMonitor(j1data, j2data) {
                    const j1Name = setup.jury1Name || 'Jury 1';
                    const j2Name = setup.jury2Name || 'Jury 2';
                    let html = '<div style="margin-bottom:15px;display:flex;gap:10px;align-items:center;flex-wrap:wrap">'
                        + '<span style="background:#e3f2fd;color:#1565c0;padding:4px 12px;border-radius:20px;font-size:13px;font-weight:600">&#x1F535; ' + j1Name + '</span>'
                        + '<span style="background:#fce4ec;color:#880e4f;padding:4px 12px;border-radius:20px;font-size:13px;font-weight:600">&#x1F534; ' + j2Name + '</span>'
                        + '<span style="color:#888;font-size:12px">Live updates every time a jury saves marks</span>'
                        + '</div>';
                    html += '<div style="overflow-x:auto"><table style="width:100%;border-collapse:collapse;font-size:13px">';
                    html += '<thead><tr style="background:linear-gradient(135deg,#6a1b9a,#c44569);color:white">';
                    html += '<th style="padding:10px;text-align:left">Class</th><th style="padding:10px;text-align:left">Code Name</th>';
                    criteria.forEach(function(c) { html += '<th style="padding:10px;text-align:center">' + c + '</th>'; });
                    html += '<th style="padding:10px;text-align:center">J1 Total</th>'
                         + '<th style="padding:10px;text-align:center">J2 Total</th>'
                         + '<th style="padding:10px;text-align:center;background:rgba(255,215,0,0.3)">Combined</th>'
                         + '</tr></thead><tbody>';
                    classes.forEach(function(cls, idx) {
                        const safeKey = cls.replace(/[.\[\]#$\/\s]/g, '_');
                        const alias = aliasMap[safeKey] || cls;
                        const j1cls = j1data ? (j1data[safeKey] || {}) : {};
                        const j2cls = j2data ? (j2data[safeKey] || {}) : {};
                        const j1marks = j1cls.marks || [];
                        const j2marks = j2cls.marks || [];
                        const j1total = j1marks.reduce(function(s,v){ return s+(parseFloat(v)||0); }, 0);
                        const j2total = j2marks.reduce(function(s,v){ return s+(parseFloat(v)||0); }, 0);
                        const combined = j1total + j2total;
                        const bg = idx % 2 === 0 ? '#fff' : '#f9f0ff';
                        html += '<tr style="background:' + bg + ';border-bottom:1px solid #e0e0e0">';
                        html += '<td style="padding:8px 10px;font-weight:600">' + cls + '</td>';
                        html += '<td style="padding:8px 10px;color:#6a1b9a">' + alias + '</td>';
                        criteria.forEach(function(c, i) {
                            const v1 = j1marks[i] !== undefined ? j1marks[i] : '';
                            const v2 = j2marks[i] !== undefined ? j2marks[i] : '';
                            html += '<td style="padding:8px;text-align:center">'
                                + '<div style="font-size:11px;color:#1565c0">J1: <input type="number" value="' + v1 + '" min="0" max="10" step="0.5"'
                                + ' onchange="adminEditMark(\'' + event + '\',1,\'' + safeKey + '\',' + i + ',this.value)"'
                                + ' style="width:45px;padding:2px 4px;border:1.5px solid #90caf9;border-radius:4px;font-size:11px"></div>'
                                + '<div style="font-size:11px;color:#880e4f;margin-top:3px">J2: <input type="number" value="' + v2 + '" min="0" max="10" step="0.5"'
                                + ' onchange="adminEditMark(\'' + event + '\',2,\'' + safeKey + '\',' + i + ',this.value)"'
                                + ' style="width:45px;padding:2px 4px;border:1.5px solid #f48fb1;border-radius:4px;font-size:11px"></div>'
                                + '</td>';
                        });
                        html += '<td style="padding:8px;text-align:center;font-weight:700;color:#1565c0">' + j1total.toFixed(1) + '</td>';
                        html += '<td style="padding:8px;text-align:center;font-weight:700;color:#880e4f">' + j2total.toFixed(1) + '</td>';
                        html += '<td style="padding:8px;text-align:center;font-weight:800;color:#4a148c;background:rgba(255,215,0,0.15)">' + combined.toFixed(1) + '</td>';
                        html += '</tr>';
                    });
                    html += '</tbody></table></div>';
                    container.innerHTML = html;
                }

                // Subscribe to live updates
                let j1data = null, j2data = null;
                const ref1 = db.ref('juryMarks/' + event + '/jury1');
                const ref2 = db.ref('juryMarks/' + event + '/jury2');
                const h1 = ref1.on('value', snap => { j1data = snap.val(); renderMonitor(j1data, j2data); });
                const h2 = ref2.on('value', snap => { j2data = snap.val(); renderMonitor(j1data, j2data); });
                _liveMonitorListeners.push(() => ref1.off('value', h1));
                _liveMonitorListeners.push(() => ref2.off('value', h2));
            } catch(e) {
                container.innerHTML = '<p style="color:red;text-align:center;padding:20px">Error: ' + e.message + '</p>';
            }
        }

        async function adminEditMark(event, juryNum, safeKey, critIndex, value) {
            try {
                await db.ref(`juryMarks/\${event}/jury\${juryNum}/\${safeKey}/marks/\${critIndex}`).set(parseFloat(value) || 0);
            } catch(e) { alert('Save error: ' + e.message); }
        }

        // ============================================================
        // POINT 3: Show Enrollments â€” password protected
        // ============================================================
        function showEnrollmentDebugProtected() {
            const pwd = prompt('Enter admin password to view enrollment data:');
            if (!pwd) return;
            db.ref('jurySetup').once('value').then(snap => {
                // Check any jury password as verification
                let valid = false;
                if (snap.exists()) {
                    snap.forEach(child => {
                        const s = child.val();
                        if (s.jury1Password === pwd || s.jury2Password === pwd) valid = true;
                    });
                }
                // Also allow super admin password
                if (isSuperAdmin) valid = true;
                if (valid) {
                    showEnrollmentDebug();
                } else {
                    alert('âŒ Incorrect password.');
                }
            });
        }

        function showEnrollmentDebug() {
            console.log('=== ENROLLMENT DEBUG ===');
            console.log('Current juryEvent:', juryEvent);
            console.log('All array length:', all.length);
            console.log('All enrollments:', all);
            
            // Filter for current event
            const eventEnrollments = all.filter(e => e.event === juryEvent);
            console.log('Enrollments for', juryEvent, ':', eventEnrollments);
            
            // Get unique classes
            const classes = [...new Set(eventEnrollments.map(e => e.classYear))];
            console.log('Unique classes:', classes);
            
            // Build report
            let report = '=== ENROLLMENT DEBUG REPORT ===\n\n';
            report += 'Event: ' + juryEvent + '\n';
            report += 'Total enrollments in database: ' + all.length + '\n';
            report += 'Enrollments for this event: ' + eventEnrollments.length + '\n';
            report += 'Unique classes: ' + classes.join(', ') + '\n\n';
            
            report += 'Detailed Enrollments:\n';
            eventEnrollments.forEach((e, i) => {
                report += `${i+1}. Class: ${e.classYear}, Name: ${e.name}, Phone: ${e.phone}\n`;
            });
            
            if (eventEnrollments.length === 0) {
                report += '\nâš ï¸ NO ENROLLMENTS FOUND!\n';
                report += 'This means either:\n';
                report += '1. No one has enrolled for this event yet\n';
                report += '2. The enrollments are not being loaded from Firebase\n';
                report += '3. The event name doesn\'t match\n';
            }
            
            console.log(report);
            alert(report);
        }

        function testFirebaseWrite() {
            console.log('=== TESTING FIREBASE WRITE ===');
            console.log('Testing write to: juryMarks/TEST/test');
            
            const testData = {
                timestamp: new Date().toISOString(),
                message: 'This is a test write',
                juryEvent: juryEvent,
                juryNumber: juryNumber
            };
            
            console.log('Test data:', testData);
            
            // Test 1: Try writing to test path
            db.ref('juryMarks/TEST/test').set(testData)
                .then(() => {
                    console.log('âœ“ TEST WRITE SUCCESSFUL');
                    
                    // Verify by reading back
                    return db.ref('juryMarks/TEST/test').once('value');
                })
                .then(snap => {
                    const readData = snap.val();
                    console.log('âœ“ TEST READ SUCCESSFUL');
                    console.log('Data read back:', readData);
                    
                    if (readData) {
                        alert('âœ… FIREBASE TEST PASSED!\n\n' +
                              'Firebase is working correctly.\n' +
                              'Write: SUCCESS\n' +
                              'Read: SUCCESS\n\n' +
                              'Check Firebase Console - you should see:\n' +
                              'juryMarks > TEST > test\n\n' +
                              'The issue must be in the saveMarks function.');
                              
                        // Now test the actual save path
                        console.log('Now testing actual save path...');
                        const actualPath = 'juryMarks/' + juryEvent + '/jury' + juryNumber;
                        console.log('Actual path:', actualPath);
                        
                        return db.ref(actualPath).set({test: 'actual path test'});
                    } else {
                        throw new Error('Read returned null');
                    }
                })
                .then(() => {
                    console.log('âœ“ ACTUAL PATH WRITE SUCCESSFUL');
                    alert('âœ… Both tests passed! Check the console and Firebase database.');
                })
                .catch(err => {
                    console.error('âœ— TEST FAILED:', err);
                    console.error('Error code:', err.code);
                    console.error('Error message:', err.message);
                    
                    alert('âŒ FIREBASE TEST FAILED!\n\n' +
                          'Error: ' + err.message + '\n' +
                          'Code: ' + err.code + '\n\n' +
                          'This means Firebase rules may still be blocking writes.\n' +
                          'Check browser console for details.');
                });
        }

        // Edit and Delete Functions
        let editingKey = null;
        let editingData = null;

        // Wrapper functions to handle calls from data attributes
        function editEnrollmentByKey(key) {
            editEnrollment(key);
        }

        function deleteEnrollmentByKey(key, name, event) {
            deleteEnrollment(key, name, event);
        }

        function editEnrollment(key) {
            console.log('Editing enrollment:', key);
            console.log('All enrollments:', all);
            console.log('Looking for key:', key);
            
            editingKey = key;
            
            // Find the enrollment data - search by id field
            const enrollment = all.find(e => e.id === key);
            
            if (!enrollment) {
                console.error('Enrollment not found!');
                console.log('Available IDs:', all.map(e => e.id));
                alert('Error: Enrollment not found. Please refresh the page and try again.');
                return;
            }
            
            editingData = enrollment;
            console.log('Enrollment data:', enrollment);
            
            // Build edit form based on event type
            const eventConfig = events[enrollment.event];
            const isTeamEvent = eventConfig && eventConfig.count > 1;
            
            let formHtml = '<div class="form-group">';
            formHtml += '<label>Name:</label>';
            formHtml += '<input type="text" id="editName" value="' + enrollment.name + '" required>';
            formHtml += '</div>';
            
            formHtml += '<div class="form-group">';
            formHtml += '<label>Phone:</label>';
            formHtml += '<input type="tel" id="editPhone" value="' + enrollment.phone + '" required>';
            formHtml += '</div>';
            
            formHtml += '<div class="form-group">';
            formHtml += '<label>Class Year:</label>';
            formHtml += '<input type="text" id="editClass" value="' + enrollment.classYear + '" readonly>';
            formHtml += '</div>';
            
            formHtml += '<div class="form-group">';
            formHtml += '<label>Event:</label>';
            formHtml += '<input type="text" value="' + enrollment.event + '" readonly>';
            formHtml += '</div>';
            
            formHtml += '<div class="form-group">';
            formHtml += '<label>Role:</label>';
            formHtml += '<input type="text" value="' + enrollment.role + '" readonly>';
            formHtml += '</div>';
            
            // Add team members if it's a team event
            if (isTeamEvent && enrollment.teamMembers) {
                for (let i = 0; i < enrollment.teamMembers.length; i++) {
                    const member = enrollment.teamMembers[i];
                    formHtml += '<div class="team-member-box">';
                    formHtml += '<div class="member-header">Team Member ' + (i + 1) + '</div>';
                    formHtml += '<div class="form-group">';
                    formHtml += '<label>Name:</label>';
                    formHtml += '<input type="text" id="editTeamName' + i + '" value="' + member.name + '" required>';
                    formHtml += '</div>';
                    formHtml += '<div class="form-group">';
                    formHtml += '<label>Phone:</label>';
                    formHtml += '<input type="tel" id="editTeamPhone' + i + '" value="' + member.phone + '" required>';
                    formHtml += '</div>';
                    formHtml += '</div>';
                }
            }
            
            document.getElementById('editFormContainer').innerHTML = formHtml;
            document.getElementById('editModal').style.display = 'block';
        }

        function closeEditModal() {
            document.getElementById('editModal').style.display = 'none';
            editingKey = null;
            editingData = null;
        }

        function saveEdit() {
            if (!editingKey || !editingData) {
                alert('Error: No enrollment selected');
                return;
            }
            
            // Get updated values
            const updatedName = document.getElementById('editName').value.trim();
            const updatedPhone = document.getElementById('editPhone').value.trim();
            
            if (!updatedName || !updatedPhone) {
                alert('Please fill in all required fields');
                return;
            }
            
            // Validate phone
            if (!/^\d{10}$/.test(updatedPhone)) {
                alert('Please enter a valid 10-digit phone number');
                return;
            }
            
            // Build updated enrollment object
            const updatedEnrollment = {
                ...editingData,
                name: updatedName,
                phone: updatedPhone
            };
            
            // Update team members if applicable
            const eventConfig = events[editingData.event];
            if (eventConfig && eventConfig.count > 1 && editingData.teamMembers) {
                updatedEnrollment.teamMembers = [];
                for (let i = 0; i < editingData.teamMembers.length; i++) {
                    const memberName = document.getElementById('editTeamName' + i).value.trim();
                    const memberPhone = document.getElementById('editTeamPhone' + i).value.trim();
                    
                    if (!memberName || !memberPhone) {
                        alert('Please fill in all team member details');
                        return;
                    }
                    
                    if (!/^\d{10}$/.test(memberPhone)) {
                        alert('Please enter valid 10-digit phone numbers for all team members');
                        return;
                    }
                    
                    updatedEnrollment.teamMembers.push({
                        name: memberName,
                        phone: memberPhone
                    });
                }
            }
            
            // Save to Firebase
            ref.child(editingKey).set(updatedEnrollment)
                .then(() => {
                    showOk('Enrollment updated successfully!');
                    closeEditModal();
                    loadData(); // Reload data
                    
                    // Refresh the appropriate view
                    if (studentClass) {
                        viewStudentClassEnrollments();
                    }
                    if (isCR) {
                        updateCRView();
                    }
                })
                .catch(err => {
                    console.error('Error updating enrollment:', err);
                    showErr('Failed to update enrollment: ' + err.message);
                });
        }

        function deleteEnrollment(key, name, event) {
            // Find the enrollment data - search by id field
            const enrollment = all.find(e => e.id === key);
            if (!enrollment) {
                alert('Error: Enrollment not found');
                return;
            }
            
            if (!confirm('Are you sure you want to delete the enrollment for ' + name + ' in ' + event + '?')) {
                return;
            }
            
            ref.child(key).remove()
                .then(() => {
                    showOk('Enrollment deleted successfully!');
                    loadData(); // Reload data
                    
                    // Refresh the appropriate view
                    if (studentClass) {
                        viewStudentClassEnrollments();
                    }
                    if (isCR) {
                        updateCRView();
                    }
                })
                .catch(err => {
                    console.error('Error deleting enrollment:', err);
                    showErr('Failed to delete enrollment: ' + err.message);
                });
        }

        function showOk(msg) {
            const d = document.getElementById('enrollMessage');
            d.className = 'message success show';
            d.textContent = 'âœ“ '+msg;
            setTimeout(() => d.classList.remove('show'), 5000);
            d.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }

        function showErr(msg) {
            const d = document.getElementById('enrollMessage');
            d.className = 'message error show';
            d.textContent = 'âœ— '+msg;
            setTimeout(() => d.classList.remove('show'), 5000);
            d.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }

        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) event.target.style.display = 'none';
        }
        
        // ==================== QUIZ COMPETITION FUNCTIONS ====================
        
        // Quiz Utility Functions
        // â”€â”€ SERVER-TIME OFFSET (fetched once, reused everywhere) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        let _serverTimeOffsetMs = 0;
        let _serverOffsetFetched = false;

        async function fetchServerTimeOffset() {
            if (_serverOffsetFetched) return;
            try {
                const snap = await db.ref('.info/serverTimeOffset').once('value');
                _serverTimeOffsetMs = snap.val() || 0;
                _serverOffsetFetched = true;
                console.log('[ServerTime] Offset:', _serverTimeOffsetMs, 'ms');
            } catch (e) {
                console.warn('[ServerTime] Could not fetch offset:', e);
                _serverTimeOffsetMs = 0;
                _serverOffsetFetched = true;
            }
        }

        function getServerNow() {
            return new Date(Date.now() + _serverTimeOffsetMs);
        }

        function getQuizToday() {
            const now = getServerNow();
            const year  = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day   = String(now.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        async function getQuizTodayServer() {
            await fetchServerTimeOffset();
            return getQuizToday();
        }
        
        // Check public quiz status (before login)
        async function checkPublicQuizStatus() {
            const today = await getQuizTodayServer();
            const messageDiv = document.getElementById('publicQuizMessage');
            console.log('=== checkPublicQuizStatus START === Today:', today);
            try {
                // Always fetch all published dates first
                const allPublished = await db.ref('quizPublished').once('value');
                let latestPublishedDate = null;
                let latestPublishedData = null;
                if (allPublished.exists()) {
                    const pubData = allPublished.val();
                    const publishedDates = Object.keys(pubData)
                        .filter(d => pubData[d] && pubData[d].published === true)
                        .sort().reverse();
                    if (publishedDates.length > 0) {
                        latestPublishedDate = publishedDates[0];
                        latestPublishedData = pubData[latestPublishedDate];
                    }
                }
                console.log('Latest published date:', latestPublishedDate);

                // If there is a published quiz (any date), show its Q&A
                if (latestPublishedDate) {
                    const pubQSnap = await db.ref(`quizQuestions/${latestPublishedDate}`).once('value');
                    if (pubQSnap.exists()) {
                        const questions = pubQSnap.val();
                        const publishData = latestPublishedData;
                        const publishedDate = new Date(latestPublishedDate + 'T00:00:00').toLocaleDateString('en-IN', {
                            weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'
                        });
                        const publishedTime = new Date(publishData.publishedAt).toLocaleTimeString('en-IN', {
                            hour: '2-digit', minute: '2-digit'
                        });
                        let html = '<div style="background:#e8f5e9;padding:20px;border-radius:10px;border:3px solid #4CAF50;margin-bottom:16px">';
                        html += '<h4 style="color:#2e7d32;margin-top:0">\uD83D\uDCC5 Published Quiz - Questions &amp; Answers</h4>';
                        html += '<p style="color:#2e7d32;margin-bottom:15px;font-size:0.9em">Published: ' + publishedDate + ' at ' + publishedTime + '</p>';
                        html += '<div style="background:white;padding:20px;border-radius:8px;margin-bottom:15px;border-left:5px solid #667eea">';
                        html += '<p style="margin:0 0 10px 0;color:#667eea;font-weight:bold;font-size:1.1em">Question 1:</p>';
                        html += '<p style="margin:0 0 15px 0;color:#333;font-size:1.05em">' + questions.q1.text + '</p>';
                        html += '<div style="background:#4CAF50;color:white;padding:12px;border-radius:6px;font-weight:bold">\u2705 Correct Answer: ' + questions.q1.options[questions.q1.correct] + '</div></div>';
                        html += '<div style="background:white;padding:20px;border-radius:8px;border-left:5px solid #667eea">';
                        html += '<p style="margin:0 0 10px 0;color:#667eea;font-weight:bold;font-size:1.1em">Question 2:</p>';
                        html += '<p style="margin:0 0 15px 0;color:#333;font-size:1.05em">' + questions.q2.text + '</p>';
                        html += '<div style="background:#4CAF50;color:white;padding:12px;border-radius:6px;font-weight:bold">\u2705 Correct Answer: ' + questions.q2.options[questions.q2.correct] + '</div></div>';
                        html += '<p style="color:#2e7d32;margin:15px 0 0 0;font-size:0.9em;text-align:center"><em>Review the questions and answers from the published quiz</em></p></div>';
                        // Also show today participation banner if today has a DIFFERENT (unpublished) quiz
                        if (latestPublishedDate !== today) {
                            const todayQSnap = await db.ref(`quizQuestions/${today}`).once('value');
                            if (todayQSnap.exists()) {
                                const todayDateStr = new Date(today + 'T00:00:00').toLocaleDateString('en-IN', {weekday:'long', day:'2-digit', month:'long', year:'numeric'});
                                html += '<div class="quiz-available-banner"><div class="trophy-icon">\uD83C\uDFC6</div><h3>\u2705 Today\'s Quiz is Available!</h3><p style="margin:0;color:#155724;font-size:1.05em;font-weight:600">\uD83D\uDCC5 ' + todayDateStr + '</p><p style="margin-top:6px;color:#155724;font-size:1.05em">Login below to participate and win exciting prizes!</p><p style="margin-top:8px;color:#28a745;font-weight:600">\u26A1 Be the fastest to answer correctly!</p><div style="margin-top:14px;background:rgba(255,255,255,0.7);border-radius:10px;padding:10px 15px;display:inline-block;border:2px solid #28a745"><span style="color:#856404;font-weight:700;font-size:0.95em">\u23F3 Quiz ends in: </span><span id="publicQuizCountdown" style="color:#c0392b;font-weight:800;font-size:1.15em;letter-spacing:1px">--:--:--</span><span style="color:#666;font-size:0.82em;margin-left:6px">(closes at 11:59 PM today)</span></div></div>';
                            }
                        }
                        messageDiv.innerHTML = html;
                        // Start countdown AFTER innerHTML is set
                        setTimeout(function startQuizCountdownAfterRender() {
                            function tickCountdown() {
                                const el = document.getElementById('publicQuizCountdown');
                                if (!el) return;
                                const now2 = new Date(), end2 = new Date();
                                end2.setHours(23, 59, 59, 0);
                                const diff = end2 - now2;
                                if (diff <= 0) { el.textContent = 'CLOSED'; el.style.color = '#c0392b'; return; }
                                const h = Math.floor(diff/3600000), m = Math.floor((diff%3600000)/60000), s = Math.floor((diff%60000)/1000);
                                el.textContent = String(h).padStart(2,'0')+':'+String(m).padStart(2,'0')+':'+String(s).padStart(2,'0');
                                setTimeout(tickCountdown, 1000);
                            }
                            tickCountdown();
                        }, 0);
                        showPublicQuizWinner(latestPublishedDate);
                        console.log('=== checkPublicQuizStatus END (published) ===');
                        return;
                    }
                }

                // No published quiz â€” check if today has a quiz for participation
                const todayQSnap2 = await db.ref(`quizQuestions/${today}`).once('value');
                if (!todayQSnap2.exists()) {
                    messageDiv.innerHTML = '<p style="margin:0;color:#856404">\u23F3 <strong>No quiz available today.</strong></p>';
                    showPublicQuizWinner(today);
                    return;
                }

                // Today has quiz but not published yet â€” show participation banner with date
                const todayDateStr2 = new Date(today + 'T00:00:00').toLocaleDateString('en-IN', {weekday:'long', day:'2-digit', month:'long', year:'numeric'});
                messageDiv.innerHTML = '<div class="quiz-available-banner"><div class="trophy-icon">\uD83C\uDFC6</div><h3>\u2705 Today\'s Quiz is Available!</h3><p style="margin:0;color:#155724;font-size:1.05em;font-weight:600">\uD83D\uDCC5 ' + todayDateStr2 + '</p><p style="margin-top:6px;color:#155724;font-size:1.05em">Login below to participate and win exciting prizes!</p><p style="margin-top:8px;color:#28a745;font-weight:600">\u26A1 Be the fastest to answer correctly!</p><div style="margin-top:14px;background:rgba(255,255,255,0.7);border-radius:10px;padding:10px 15px;display:inline-block;border:2px solid #28a745"><span style="color:#856404;font-weight:700;font-size:0.95em">\u23F3 Quiz ends in: </span><span id="publicQuizCountdown" style="color:#c0392b;font-weight:800;font-size:1.15em;letter-spacing:1px">--:--:--</span><span style="color:#666;font-size:0.82em;margin-left:6px">(closes at 11:59 PM today)</span></div></div>';
                // Start countdown AFTER innerHTML is set
                setTimeout(function startQuizCountdownAfterRender2() {
                    function tickCountdown2() {
                        const el = document.getElementById('publicQuizCountdown');
                        if (!el) return;
                        const now3 = new Date(), end3 = new Date();
                        end3.setHours(23, 59, 59, 0);
                        const diff = end3 - now3;
                        if (diff <= 0) { el.textContent = 'CLOSED'; el.style.color = '#c0392b'; return; }
                        const h = Math.floor(diff/3600000), m = Math.floor((diff%3600000)/60000), s = Math.floor((diff%60000)/1000);
                        el.textContent = String(h).padStart(2,'0')+':'+String(m).padStart(2,'0')+':'+String(s).padStart(2,'0');
                        setTimeout(tickCountdown2, 1000);
                    }
                    tickCountdown2();
                }, 0);
                showPublicQuizWinner(today);
                console.log('=== checkPublicQuizStatus END (available) ===');
            } catch (err) {
                console.error('Public quiz status check error:', err);
                messageDiv.innerHTML = '<p style="margin:0;color:#721c24">\u274C Error loading quiz status</p>';
            }
        }

        // Show declared winner below the quiz status box
        async function showPublicQuizWinner(date) {
            // Remove any existing winner box first
            const existing = document.getElementById('publicQuizWinnerBox');
            if (existing) existing.remove();

            try {
                const snap = await db.ref(`quizResults/${date}`).once('value');
                const data = snap.val();
                if (!data || !data.winner) return; // no winner declared yet

                const dateFormatted = new Date(date).toLocaleDateString('en-IN', {
                    weekday: 'long', day: '2-digit', month: 'long', year: 'numeric'
                });
                const declaredTime = new Date(data.declaredAt).toLocaleTimeString('en-IN', {
                    hour: '2-digit', minute: '2-digit', hour12: true
                });

                const box = document.createElement('div');
                box.id = 'publicQuizWinnerBox';
                box.style.cssText = 'margin-top:20px;border-radius:16px;overflow:hidden;box-shadow:0 8px 30px rgba(0,0,0,0.15)';
                box.innerHTML = `
                    <div style="background:linear-gradient(135deg,#6a1b9a,#c44569);padding:16px 22px;color:white;display:flex;align-items:center;gap:12px">
                        <span style="font-size:1.8em">ðŸ†</span>
                        <div>
                            <h4 style="margin:0;font-size:1.05em">Today's Quiz Winners</h4>
                            <p style="margin:0;font-size:11px;opacity:0.8">ðŸ“… ${dateFormatted} &nbsp;|&nbsp; Declared at ${declaredTime}</p>
                        </div>
                    </div>
                    <div style="background:white;padding:18px 22px;display:flex;gap:16px;flex-wrap:wrap">
                        <div style="flex:1;min-width:160px;background:linear-gradient(135deg,#fff9c4,#ffd54f);border-radius:12px;padding:16px;text-align:center;border:2px solid #ffd700">
                            <div style="font-size:2em;margin-bottom:4px">ðŸ¥‡</div>
                            <div style="font-weight:800;font-size:1.05em;color:#5d4037">${data.winner.name}</div>
                            <div style="background:#6a1b9a;color:white;border-radius:20px;padding:3px 12px;font-size:12px;font-weight:700;margin:6px auto;display:inline-block">${data.winner.class}</div>
                            <div style="font-size:11px;color:#666;margin-top:4px">Score: ${data.winner.score}/2</div>
                        </div>
                        ${data.runnerUp ? `
                        <div style="flex:1;min-width:160px;background:linear-gradient(135deg,#f5f5f5,#e0e0e0);border-radius:12px;padding:16px;text-align:center;border:2px solid #bdbdbd">
                            <div style="font-size:2em;margin-bottom:4px">ðŸ¥ˆ</div>
                            <div style="font-weight:800;font-size:1.05em;color:#37474f">${data.runnerUp.name}</div>
                            <div style="background:#455a64;color:white;border-radius:20px;padding:3px 12px;font-size:12px;font-weight:700;margin:6px auto;display:inline-block">${data.runnerUp.class}</div>
                            <div style="font-size:11px;color:#666;margin-top:4px">Score: ${data.runnerUp.score}/2</div>
                        </div>` : ''}
                    </div>
                `;

                // Insert after publicQuizMessage div
                const msgDiv = document.getElementById('publicQuizMessage');
                msgDiv.parentNode.insertBefore(box, msgDiv.nextSibling);

            } catch(e) { console.warn('showPublicQuizWinner error:', e); }
        }
        
        // Load result for any past date selected by the user
        async function loadPastQuizResult() {
            const date = document.getElementById('pastResultDate').value;
            const box  = document.getElementById('pastResultBox');
            if (!date) { alert('Please select a date.'); return; }
            box.style.display = 'block';
            box.innerHTML = '<p style="color:#666;margin:0;text-align:center">â³ Loading result...</p>';
            try {
                const snap = await db.ref(`quizResults/${date}`).once('value');
                const data = snap.val();
                const dateFormatted = new Date(date + 'T00:00:00').toLocaleDateString('en-IN', {
                    weekday:'long', day:'2-digit', month:'long', year:'numeric'
                });
                if (!data || !data.winner) {
                    box.innerHTML = `<div style="background:#fff3cd;border-radius:10px;padding:14px 18px;border-left:4px solid #ffc107">
                        <strong style="color:#856404">ðŸ“­ No winner declared for ${dateFormatted}.</strong>
                        <p style="margin:6px 0 0;color:#856404;font-size:13px">Either the quiz didn't take place or the result hasn't been declared yet.</p>
                    </div>`;
                    return;
                }
                const declaredTime = new Date(data.declaredAt).toLocaleTimeString('en-IN',{hour:'2-digit',minute:'2-digit',hour12:true});
                box.innerHTML = `
                    <div style="border-radius:14px;overflow:hidden;box-shadow:0 4px 16px rgba(0,0,0,0.1)">
                        <div style="background:linear-gradient(135deg,#6a1b9a,#c44569);padding:14px 18px;color:white;display:flex;align-items:center;gap:10px">
                            <span style="font-size:1.5em">ðŸ†</span>
                            <div>
                                <strong style="font-size:1em">Quiz Winners</strong>
                                <p style="margin:0;font-size:11px;opacity:0.8">ðŸ“… ${dateFormatted} &nbsp;|&nbsp; Declared at ${declaredTime}</p>
                            </div>
                        </div>
                        <div style="background:white;padding:16px;display:flex;gap:14px;flex-wrap:wrap">
                            <div style="flex:1;min-width:140px;background:linear-gradient(135deg,#fff9c4,#ffd54f);border-radius:10px;padding:14px;text-align:center;border:2px solid #ffd700">
                                <div style="font-size:1.8em;margin-bottom:4px">ðŸ¥‡</div>
                                <div style="font-weight:800;color:#5d4037;font-size:1em">${data.winner.name}</div>
                                <div style="background:#6a1b9a;color:white;border-radius:20px;padding:2px 10px;font-size:12px;font-weight:700;margin:5px auto;display:inline-block">${data.winner.class}</div>
                                <div style="font-size:11px;color:#666;margin-top:3px">Score: ${data.winner.score}/2</div>
                            </div>
                            ${data.runnerUp ? `
                            <div style="flex:1;min-width:140px;background:linear-gradient(135deg,#f5f5f5,#e0e0e0);border-radius:10px;padding:14px;text-align:center;border:2px solid #bdbdbd">
                                <div style="font-size:1.8em;margin-bottom:4px">ðŸ¥ˆ</div>
                                <div style="font-weight:800;color:#37474f;font-size:1em">${data.runnerUp.name}</div>
                                <div style="background:#455a64;color:white;border-radius:20px;padding:2px 10px;font-size:12px;font-weight:700;margin:5px auto;display:inline-block">${data.runnerUp.class}</div>
                                <div style="font-size:11px;color:#666;margin-top:3px">Score: ${data.runnerUp.score}/2</div>
                            </div>` : ''}
                        </div>
                    </div>`;
            } catch(e) {
                box.innerHTML = '<p style="color:red;margin:0">âŒ Error loading result: ' + e.message + '</p>';
            }
        }

        function generateQuizPassword() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789@#$';
            let pwd = '';
            for (let i = 0; i < 10; i++) {
                pwd += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return pwd;
        }
        
        function showQuizMsg(id, msg, type) {
            const el = document.getElementById(id);
            if (!el) return;
            el.className = `message ${type} show`;
            el.textContent = msg;
            // Errors stay visible for 10s on mobile; success fades after 5s
            const delay = type === 'error' ? 10000 : 5000;
            setTimeout(() => el.classList.remove('show'), delay);
        }
        
        function populateQuizClasses() {
            const sel = document.getElementById('quizClass');
            if (!sel) return;
            sel.innerHTML = '<option value="">-- Select Class --</option>';
            const classList = (typeof classes !== "undefined" ? classes : window._appClasses) || [];
            classList.forEach(c => {
                const opt = document.createElement('option');
                opt.value = c;
                opt.textContent = c;
                sel.appendChild(opt);
            });
        }
        
        function showQuizTab(tab) {
            if (tab === 'student') {
                document.getElementById('quizStudentSection').style.display = 'block';
                document.getElementById('quizAdminSection').style.display = 'none';
                document.getElementById('quizStudentTab').classList.add('active');
                document.getElementById('quizAdminTab').classList.remove('active');
                document.getElementById('quizStudentTab').style.background = 'linear-gradient(135deg,#c44569 0%,#6a1b9a 100%)';
                document.getElementById('quizStudentTab').style.color = 'white';
                document.getElementById('quizAdminTab').style.background = 'white';
                document.getElementById('quizAdminTab').style.color = '#333';
            } else {
                document.getElementById('quizAdminSection').style.display = 'block';
                document.getElementById('quizStudentSection').style.display = 'none';
                document.getElementById('quizAdminTab').classList.add('active');
                document.getElementById('quizStudentTab').classList.remove('active');
                document.getElementById('quizAdminTab').style.background = 'linear-gradient(135deg,#c44569 0%,#6a1b9a 100%)';
                document.getElementById('quizAdminTab').style.color = 'white';
                document.getElementById('quizStudentTab').style.background = 'white';
                document.getElementById('quizStudentTab').style.color = '#333';
            }
        }
        
        // Send Email Function - Using EmailJS + Firebase Log
        async function sendQuizEmail(to, subject, body) {
            const debugId = Date.now();
            try {
                console.log('========================================');
                console.log(`ðŸ“§ EMAIL DEBUG #${debugId} START`);
                console.log('========================================');
                console.log(`Timestamp: ${new Date().toISOString()}`);
                console.log(`Recipient: ${to}`);
                console.log(`Subject: ${subject}`);
                console.log('Body preview:', body.substring(0, 150) + '...');
                
                let emailSent = false;
                let emailError = null;
                let emailJSResponse = null;
                
                // Step 1: Check EmailJS library
                console.log('\n--- STEP 1: Checking EmailJS library ---');
                if (typeof emailjs === 'undefined') {
                    console.error('âŒ EmailJS library NOT LOADED!');
                    console.error('Check if script tag is present');
                    emailError = 'EmailJS library not loaded';
                } else {
                    console.log('âœ… EmailJS library is available');
                }
                
                // Step 2: Send email
                if (typeof emailjs !== 'undefined') {
                    console.log('\n--- STEP 2: Checking EmailJS initialization ---');
                    console.log('Public Key: iISS6N2b69VmKwx8Y');
                    
                    console.log('\n--- STEP 3: Preparing template parameters ---');
                    const templateParams = {
                        to_email: to,
                        subject: subject,
                        message: body,
                        reply_to: 'davancollege02@gmail.com'
                    };
                    
                    console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
                    console.log('ðŸ“§ EMAIL PARAMETERS BEING SENT:');
                    console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
                    console.log('Template Parameters:', templateParams);
                    console.log('');
                    console.log('ðŸŽ¯ RECIPIENT (to_email):', templateParams.to_email);
                    console.log('ðŸ“¬ REPLY TO (reply_to):', templateParams.reply_to);
                    console.log('ðŸ“ Subject:', templateParams.subject);
                    console.log('ðŸ“„ Message preview:', templateParams.message.substring(0, 100) + '...');
                    console.log('');
                    console.log('âš™ï¸ Service ID: service_zhy3bnp');
                    console.log('ðŸ“‹ Template ID: template_o2i00b5');
                    console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
                    console.log('');
                    console.log('âš ï¸ IMPORTANT: Check your EmailJS template!');
                    console.log('   The template should use: {{to_email}} for recipient');
                    console.log('   NOT: {{reply_to}} (that\'s for reply address)');
                    console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
                    
                    try {
                        console.log('\n--- STEP 4: Sending email via EmailJS ---');
                        console.log('â³ Please wait...');
                        
                        const startTime = Date.now();
                        emailJSResponse = await emailjs.send(
                            'service_zhy3bnp',
                            'template_o2i00b5',
                            templateParams
                        );
                        const endTime = Date.now();
                        
                        emailSent = true;
                        console.log(`\nâœ…âœ…âœ… EMAIL SENT SUCCESSFULLY! (${endTime - startTime}ms) âœ…âœ…âœ…`);
                        console.log('EmailJS Response:', emailJSResponse);
                        console.log(`âœ… Email delivered to: ${to}`);
                        console.log('âœ… Check inbox in 1-2 minutes (or spam folder)');
                        
                    } catch (emailErr) {
                        emailSent = false;
                        emailError = emailErr.message || emailErr.toString();
                        
                        console.error('\nâŒâŒâŒ EMAIL SEND FAILED! âŒâŒâŒ');
                        console.error('Error Type:', emailErr.name);
                        console.error('Error Message:', emailErr.message);
                        console.error('Full Error:', emailErr);
                        
                        // Specific error analysis
                        if (emailErr.message && emailErr.message.includes('User ID')) {
                            console.error('\nðŸ”‘ ISSUE: Invalid Public Key');
                            console.error('Current Key: iISS6N2b69VmKwx8Y');
                            console.error('â†’ Verify this key in EmailJS Dashboard > Account > API Keys');
                        } else if (emailErr.message && emailErr.message.includes('Service ID')) {
                            console.error('\nâš™ï¸ ISSUE: Invalid Service ID');
                            console.error('Current Service ID: service_zhy3bnp');
                            console.error('â†’ Verify in EmailJS Dashboard > Email Services');
                        } else if (emailErr.message && emailErr.message.includes('Template')) {
                            console.error('\nðŸ“ ISSUE: Invalid Template ID');
                            console.error('Current Template ID: template_o2i00b5');
                            console.error('â†’ Verify in EmailJS Dashboard > Email Templates');
                        } else if (emailErr.message && emailErr.message.includes('quota')) {
                            console.error('\nðŸ“Š ISSUE: Daily Quota Exceeded');
                            console.error('â†’ Check your EmailJS dashboard for quota limits');
                            console.error('â†’ Free plan: 200 emails/month');
                        } else if (emailErr.message && (emailErr.message.includes('network') || emailErr.message.includes('Failed to fetch'))) {
                            console.error('\nðŸŒ ISSUE: Network Error');
                            console.error('â†’ Check internet connection');
                            console.error('â†’ Check if EmailJS servers are accessible');
                        } else {
                            console.error('\nâ“ UNKNOWN ERROR');
                            console.error('â†’ See error details above');
                        }
                    }
                }
                
                
                console.log('\n========================================');
                console.log(`ðŸ“§ EMAIL DEBUG #${debugId} END`);
                console.log(`FINAL STATUS: ${emailSent ? 'âœ… SUCCESS' : 'âŒ FAILED'}`);
                console.log('========================================');
                
                if (emailSent) {
                    console.log('\nðŸ“§ What to do now:');
                    console.log('1. Check your email inbox (may take 1-2 minutes)');
                    console.log('2. Check SPAM/JUNK folder if not in inbox');
                    console.log('3. Whitelist davancollege02@gmail.com in your email');
                } else {
                    console.log('\nðŸ“§ Troubleshooting steps:');
                    console.log('1. Review error details above');
                    console.log('3. Verify EmailJS credentials in dashboard');
                    console.log('4. Check EmailJS service connection status');
                }
                
                return emailSent;
            } catch (err) {
                console.error(`\nâŒ EMAIL FUNCTION CRASHED! #${debugId}`);
                console.error('Fatal Error:', err);
                console.error('Error Message:', err.message);
                return false;
            }
        }
        
        // Register Student
        async function registerQuizStudent() {
            console.log('ðŸ”µ Registration started...');
            const cls = document.getElementById('quizClass').value;
            const email = document.getElementById('quizEmail').value.trim();
            const phone = document.getElementById('quizPhone').value.trim();
            const name = document.getElementById('quizName').value.trim();
            
            console.log('Form values:', {cls, email, phone, name});
            
            if (!cls || !email || !phone || !name) {
                showQuizMsg('quizMessage', 'Please fill all fields!', 'error');
                return;
            }
            
            if (!email.includes('@')) {
                showQuizMsg('quizMessage', 'Invalid email address!', 'error');
                return;
            }
            
            if (phone.length < 10) {
                showQuizMsg('quizMessage', 'Please enter valid 10-digit phone!', 'error');
                return;
            }
            
            console.log('âœ… Validation passed');
            
            try {
                console.log('Checking Firebase connection...');
                if (!db) {
                    throw new Error('Firebase database not initialized!');
                }
                
                console.log('Checking for existing email...');
                const studRef = db.ref('quizStudents');
                const emailSnap = await studRef.orderByChild('email').equalTo(email).once('value');
                
                if (emailSnap.exists()) {
                    alert('âŒ Email Already Registered!\n\nThis email address is already registered.\n\nPlease use the login form below with your existing password.');
                    showQuizMsg('quizMessage', 'âŒ Email already registered! Please login with your existing password.', 'error');
                    return;
                }
                
                console.log('Checking for existing phone number...');
                const phoneSnap = await studRef.orderByChild('phone').equalTo(phone).once('value');
                
                if (phoneSnap.exists()) {
                    alert('âŒ Phone Number Already Registered!\n\nThis phone number is already registered.\n\nPlease use the login form below with your existing password.');
                    showQuizMsg('quizMessage', 'âŒ Phone number already registered! Please login with your existing password.', 'error');
                    return;
                }
                
                console.log('âœ… Email and phone not registered, generating password...');
                const password = generateQuizPassword();
                console.log('Password generated');
                
                console.log('Saving to Firebase...');
                const newStudentRef = studRef.push();
                const studentKey   = newStudentRef.key;
                await newStudentRef.set({
                    email, phone, name, class: cls, password,
                    registeredAt: new Date().toISOString(),
                    status: 'active',
                    emailStatus: 'pending'
                });
                console.log('âœ… Saved to Firebase successfully!');
                
                const emailBody = `Hello ${name},

Welcome to Daily Quiz Competition at Davan Institute!

Your Login Credentials:
Phone Number: ${phone}
Password: ${password}
Class: ${cls}

Please keep this password secure. Login and participate in daily quizzes!

Good luck!
Davan Institute Team`;
                
                console.log('Attempting to send email...');
                // Try to send email â€” record success/failure in Firebase
                try {
                    const emailResult = await sendQuizEmail(email, 'Daily Quiz - Your Password', emailBody);
                    const emailStatusUpdate = emailResult
                        ? { emailStatus: 'sent', emailSentAt: new Date().toISOString() }
                        : { emailStatus: 'failed', emailFailedAt: new Date().toISOString(), emailError: 'send_returned_false' };
                    await studRef.child(studentKey).update(emailStatusUpdate);
                    console.log('âœ… Email status saved:', emailStatusUpdate.emailStatus);
                } catch (emailErr) {
                    await studRef.child(studentKey).update({
                        emailStatus: 'failed',
                        emailFailedAt: new Date().toISOString(),
                        emailError: emailErr.message || 'unknown'
                    });
                    console.warn('âš ï¸ Email send failed but registration successful:', emailErr);
                }
                
                console.log('Showing success alert...');
                
                // Clear any previous messages first
                document.getElementById('quizMessage').innerHTML = '';
                
                // Also show in alert for immediate visibility with password segment
                alert(`âœ… Registration Successful!\n\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nYour Login Credentials:\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\nPhone Number: ${phone}\n\nðŸ”‘ PASSWORD: ${password}\n\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\nIMPORTANT:\nâœ… Password is shown in YELLOW BOX below\nâœ… Password is auto-filled in login form\nâœ… You can copy it from either place\n\nNote: Email sent to ${email}\n(Check inbox or spam folder in 1-2 minutes)`);
                
                // Show password in a dedicated, copyable box
                const passwordBoxHTML = `
                    <div style="background:#d4edda;border:3px solid #28a745;border-radius:12px;padding:25px;margin-bottom:20px;">
                        <h3 style="color:#155724;margin-bottom:15px;text-align:center">âœ… Registration Successful!</h3>
                        <div style="background:white;padding:20px;border-radius:8px;margin-bottom:15px;">
                            <p style="margin-bottom:10px"><strong>Phone Number (Login ID):</strong> ${phone}</p>
                            <p style="margin-bottom:10px"><strong>Class:</strong> ${cls}</p>
                        </div>
                        <div style="background:#fff3cd;border:2px solid #ffc107;border-radius:8px;padding:20px;text-align:center;">
                            <p style="margin-bottom:10px;font-weight:bold;color:#856404">ðŸ”‘ YOUR PASSWORD (Click to select and copy):</p>
                            <div onclick="this.querySelector('span').select(); document.execCommand('copy');" style="cursor:pointer;background:#ffeb3b;padding:15px 25px;border-radius:8px;border:2px dashed #ffc107;display:inline-block;">
                                <span style="font-size:2em;font-weight:bold;color:#000;user-select:all;font-family:monospace;letter-spacing:2px;">${password}</span>
                            </div>
                            <p style="margin-top:15px;font-size:0.9em;color:#856404">ðŸ‘† Click on the password above to copy it</p>
                        </div>
                        <p style="margin-top:15px;text-align:center;color:#155724">
                            âœ… Password has been auto-filled in the login form below<br>
                            âœ… Email sent to: ${email} (check spam if not in inbox)
                        </p>
                    </div>
                `;
                
                document.getElementById('quizMessage').innerHTML = passwordBoxHTML;
                document.getElementById('quizMessage').style.display = 'block';
                document.getElementById('quizMessage').classList.add('show');
                
                // Scroll to the password box
                document.getElementById('quizMessage').scrollIntoView({ behavior: 'smooth', block: 'center' });
                
                console.log('Clearing form...');
                document.getElementById('quizClass').value = '';
                document.getElementById('quizEmail').value = '';
                document.getElementById('quizPhone').value = '';
                document.getElementById('quizName').value = '';
                
                // Auto-fill login form with phone number
                document.getElementById('quizLoginPhone').value = phone;
                document.getElementById('quizLoginPassword').value = password;
                
                console.log('âœ… Registration completed successfully!');
                console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
                console.log(`ðŸ“§ EMAIL DEBUG INFO:`);
                console.log(`   Intended recipient: ${email}`);
                console.log(`   Check if email arrived at: ${email}`);
                console.log(`   Look for "to" field to verify correct email`);
                console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
            } catch (err) {
                console.error('âŒ Registration error:', err);
                console.error('Error details:', err.message, err.stack);
                
                let errorMsg = 'Registration failed. ';
                
                // Check for specific error types
                if (err.message && err.message.includes('permission')) {
                    errorMsg = 'ðŸ”’ FIREBASE PERMISSION DENIED!\n\n';
                    errorMsg += 'Your Firebase Database Rules are blocking writes.\n\n';
                    errorMsg += 'FIX THIS NOW:\n';
                    errorMsg += '1. Go to Firebase Console\n';
                    errorMsg += '2. Open Realtime Database > Rules\n';
                    errorMsg += '3. Set rules to allow writes\n';
                    errorMsg += '4. Click Publish\n\n';
                    errorMsg += 'Check console for database URL.';
                    
                    alert(errorMsg);
                    console.error('ðŸ”¥ FIREBASE RULES ERROR - Update your rules to:');
                    console.error(JSON.stringify({rules: {".read": true, ".write": true}}, null, 2));
                } else if (err.message && err.message.includes('network')) {
                    errorMsg = 'ðŸŒ NETWORK ERROR!\n\nCheck your internet connection.';
                    alert(errorMsg);
                } else if (!db) {
                    errorMsg = 'âš ï¸ FIREBASE NOT CONNECTED!\n\nDatabase initialization failed.';
                    alert(errorMsg);
                } else {
                    errorMsg = `âŒ Registration Error:\n\n${err.message}\n\nCheck browser console for details.`;
                    alert(errorMsg);
                }
                
                showQuizMsg('quizMessage', errorMsg.replace(/\n/g, ' '), 'error');
            }
        }
        
        // Student Login
        async function loginQuizStudent() {
            // Sanitize: strip spaces, dashes, +91 prefix, any non-digit chars
            let rawPhone = document.getElementById('quizLoginPhone').value.trim();
            rawPhone = rawPhone.replace(/[\s\-\(\)]/g, '');        // remove spaces/dashes/brackets
            if (rawPhone.startsWith('+91')) rawPhone = rawPhone.slice(3);
            if (rawPhone.startsWith('91') && rawPhone.length === 12) rawPhone = rawPhone.slice(2);
            const phone = rawPhone.replace(/\D/g, '');              // keep only digits

            const password = document.getElementById('quizLoginPassword').value.trim();
            
            console.log('=== STUDENT LOGIN START ===');
            console.log('Phone (sanitized):', phone);
            console.log('Password length:', password.length);
            
            if (!phone || !password) {
                showQuizMsg('quizMessage', 'Please enter phone number and password!', 'error');
                document.getElementById('quizMessage').scrollIntoView({ behavior: 'smooth', block: 'center' });
                return;
            }
            
            if (phone.length !== 10) {
                showQuizMsg('quizMessage', `Invalid phone number (got ${phone.length} digits, need 10). Please check and try again.`, 'error');
                document.getElementById('quizMessage').scrollIntoView({ behavior: 'smooth', block: 'center' });
                return;
            }
            
            try {
                // Show loading state on button
                const loginBtn = document.querySelector('#dailyQuizLogin .btn-success');
                if (loginBtn) { loginBtn.disabled = true; loginBtn.textContent = 'â³ Logging in...'; }

                const studRef = db.ref('quizStudents');
                const snap = await studRef.orderByChild('phone').equalTo(phone).once('value');
                
                console.log('Student lookup result:', snap.exists());
                
                if (!snap.exists()) {
                    alert('âŒ Phone number not registered!\n\nPhone: ' + phone + '\n\nPlease register first using the registration form above.');
                    showQuizMsg('quizMessage', 'âŒ Phone number not registered! Please register first.', 'error');
                    const qMsg = document.getElementById('quizMessage');
                    if (qMsg) { qMsg.style.display = 'block'; qMsg.scrollIntoView({ behavior: 'smooth', block: 'center' }); }
                    if (loginBtn) { loginBtn.disabled = false; loginBtn.innerHTML = 'ðŸš€ Login to Quiz'; }
                    return;
                }
                
                let studentData = null;
                let studentKey = null;
                snap.forEach(child => {
                    studentData = child.val();
                    studentKey = child.key;
                });
                
                console.log('Student data found:', {
                    key: studentKey,
                    name: studentData.name,
                    email: studentData.email,
                    class: studentData.class
                });
                
                if (studentData.password !== password) {
                    console.log('Password mismatch');
                    alert('âŒ Incorrect password!\n\nPlease check your password and try again.\n\nIf you forgot your password, contact the admin.');
                    showQuizMsg('quizMessage', 'âŒ Incorrect password! Check your password and try again.', 'error');
                    const qMsg = document.getElementById('quizMessage');
                    if (qMsg) { qMsg.style.display = 'block'; qMsg.scrollIntoView({ behavior: 'smooth', block: 'center' }); }
                    if (loginBtn) { loginBtn.disabled = false; loginBtn.innerHTML = 'ðŸš€ Login to Quiz'; }
                    return;
                }
                
                console.log('Password correct - logging in');
                
                quizCurrentUser = {key: studentKey, ...studentData};
                quizUserRole = 'student';
                
                // Remember Me â€” save credentials
                if (document.getElementById('quizRememberMe') && document.getElementById('quizRememberMe').checked) {
                    localStorage.setItem('quiz_remember', '1');
                    localStorage.setItem('quiz_ph', phone);
                    localStorage.setItem('quiz_pw', password);
                } else {
                    localStorage.removeItem('quiz_remember');
                    localStorage.removeItem('quiz_ph');
                    localStorage.removeItem('quiz_pw');
                }
                
                console.log('quizCurrentUser set:', quizCurrentUser);
                console.log('quizUserRole set:', quizUserRole);
                
                // Hide login section
                console.log('Hiding login section');
                const loginSection = document.getElementById('loginSection');
                loginSection.style.display = 'none';
                
                // Show student dashboard
                const dashboard = document.getElementById('quizStudentDashboard');
                dashboard.style.display = 'block';
                
                // Start live date/time clock
                startQuizLiveClock();
                
                // Scroll to quiz dashboard on login
                setTimeout(() => {
                    const dash = document.getElementById('quizStudentDashboard');
                    if (dash) {
                        const y = dash.getBoundingClientRect().top + window.pageYOffset - 20;
                        window.scrollTo({ top: y, behavior: 'smooth' });
                    }
                }, 150);
                
                // Set student info
                document.getElementById('quizStudentName').textContent = studentData.name;
                document.getElementById('quizStudentNameBadge').textContent = studentData.name;
                document.getElementById('quizStudentEmail').textContent = studentData.email;
                document.getElementById('quizStudentClass').textContent = studentData.class;
                
                console.log('Calling checkQuizTodayStatus()');
                await checkQuizTodayStatus();
                
                console.log('=== STUDENT LOGIN END ===');
            } catch (err) {
                console.error('Login error:', err);
                console.error('Error stack:', err.stack);
                const errMsg = 'âŒ Login failed: ' + (err.message || 'Unknown error') + '\n\nPlease check your internet connection and try again.';
                alert(errMsg);
                showQuizMsg('quizMessage', 'âŒ Login failed: ' + (err.message || 'Check your connection'), 'error');
                const qMsg = document.getElementById('quizMessage');
                if (qMsg) { qMsg.style.display = 'block'; qMsg.scrollIntoView({ behavior: 'smooth', block: 'center' }); }
                const loginBtn = document.querySelector('#dailyQuizLogin .btn-success');
                if (loginBtn) { loginBtn.disabled = false; loginBtn.innerHTML = 'ðŸš€ Login to Quiz'; }
            }
        }
        
        // ============================================
        // LIVE DATE / TIME CLOCK FOR STUDENT DASHBOARD
        // ============================================
        let _quizClockInterval = null;

        function startQuizLiveClock() {
            stopQuizLiveClock();
            function tick() {
                const now = new Date();
                const days = ['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'];
                const months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];

                const dayName  = days[now.getDay()];
                const day      = now.getDate();
                const month    = months[now.getMonth()];
                const year     = now.getFullYear();

                let hours   = now.getHours();
                const mins  = String(now.getMinutes()).padStart(2, '0');
                const secs  = String(now.getSeconds()).padStart(2, '0');
                const ampm  = hours >= 12 ? 'PM' : 'AM';
                hours = hours % 12 || 12;
                const hStr  = String(hours).padStart(2, '0');

                const dayEl  = document.getElementById('quizLiveDay');
                const dateEl = document.getElementById('quizLiveDate');
                const timeEl = document.getElementById('quizLiveTime');
                const amEl   = document.getElementById('quizLiveAmPm');

                if (dayEl)  dayEl.textContent  = dayName;
                if (dateEl) dateEl.textContent  = `${day} ${month} ${year}`;
                if (timeEl) timeEl.textContent  = `${hStr}:${mins}:${secs}`;
                if (amEl)   amEl.innerHTML      = `${ampm}<br><span style="font-size:10px;opacity:0.7">IST</span>`;
            }
            tick();
            _quizClockInterval = setInterval(tick, 1000);
        }

        function stopQuizLiveClock() {
            if (_quizClockInterval) { clearInterval(_quizClockInterval); _quizClockInterval = null; }
        }

        // Regular Quiz Admin login removed - Only Super Admin Dashboard is used
        
        // Check Quiz Status
        async function checkQuizTodayStatus() {
            const today = await getQuizTodayServer();
            // Debug logs removed to prevent answer exposure
            
            // Reset all sections first
            document.getElementById('quizStartSection').style.display = 'none';
            document.getElementById('quizCompletedSection').style.display = 'none';
            document.getElementById('quizResultsSection').style.display = 'none';
            
            try {
                // Check if today's quiz questions exist
                const qRef = db.ref(`quizQuestions/${today}`);
                const qSnap = await qRef.once('value');
                
                if (!qSnap.exists()) {
                    document.getElementById('quizStatus').innerHTML = '<div style="background:#fff3cd;padding:15px;border-radius:8px"><p style="margin:0;color:#856404">â³ Today\'s quiz not yet available. Check back later!</p></div>';
                    return;
                }
                
                if (!quizCurrentUser || !quizCurrentUser.email) return;
                
                const subRef = db.ref(`quizSubmissions/${today}`);
                const subSnap = await subRef.orderByChild('studentEmail').equalTo(quizCurrentUser.email).once('value');
                
                let studentAlreadySubmitted = false;
                let studentSubmission = null;
                
                if (subSnap.exists()) {
                    subSnap.forEach(child => {
                        if (child.val().studentKey === quizCurrentUser.key) {
                            studentAlreadySubmitted = true;
                            studentSubmission = child.val();
                        }
                    });
                }
                
                if (studentAlreadySubmitted) {
                    
                    document.getElementById('quizCompletedSection').style.display = 'block';
                    document.getElementById('quizStatus').innerHTML = '<div style="background:#d1ecf1;padding:15px;border-radius:8px"><p style="margin:0;color:#0c5460">âœ… You have completed today\'s quiz!</p></div>';
                    
                    // Start next-quiz countdown when quiz is completed
                    (function startNextQuizCountdown() {
                        if (window._nextQuizCdInterval) clearInterval(window._nextQuizCdInterval);
                        function updateNextQuiz() {
                            const now = new Date();
                            const tomorrow = new Date(now);
                            tomorrow.setDate(tomorrow.getDate() + 1);
                            const dayStr = tomorrow.toLocaleDateString('en-IN', {weekday:'short', day:'numeric', month:'short'});
                            const s = document.getElementById('nextQuizStartTime');
                            const e = document.getElementById('nextQuizEndTime');
                            const c = document.getElementById('nextQuizCountdown');
                            if (s) s.textContent = dayStr + ' Â· 12:00 AM';
                            if (e) e.textContent = dayStr + ' Â· 11:59 PM';
                            const midnight = new Date(now); midnight.setHours(24,0,0,0);
                            const diff = midnight - now;
                            if (diff > 0) {
                                const h = Math.floor(diff/3600000), m = Math.floor((diff%3600000)/60000), sec = Math.floor((diff%60000)/1000);
                                if (c) c.textContent = String(h).padStart(2,'0')+':'+String(m).padStart(2,'0')+':'+String(sec).padStart(2,'0');
                            } else { if (c) c.textContent = 'Now!'; }
                        }
                        updateNextQuiz();
                        window._nextQuizCdInterval = setInterval(updateNextQuiz, 1000);
                    })();
                    const resRef = db.ref(`quizResults/${today}`);
                    const resSnap = await resRef.once('value');
                    
                    if (resSnap.exists()) {
                        const results = resSnap.val();

                        
                        let html = '<div style="background:#f8f9fa;padding:20px;border-radius:10px">';
                        html += `<p><strong>Submitted:</strong> ${new Date(studentSubmission.submittedAt).toLocaleString()}</p>`;
                        
                        if (results.winner && results.winner.email === quizCurrentUser.email) {
                            html += '<div style="background:#d4edda;color:#155724;padding:15px;border-radius:8px;margin-top:15px"><strong>ðŸ† CONGRATULATIONS! You are the WINNER!</strong></div>';
                        } else if (results.runnerUp && results.runnerUp.email === quizCurrentUser.email) {
                            html += '<div style="background:#d1ecf1;color:#0c5460;padding:15px;border-radius:8px;margin-top:15px"><strong>ðŸ¥ˆ CONGRATULATIONS! You are the RUNNER-UP!</strong></div>';
                        } else {
                            html += '<div style="background:#fff3cd;color:#856404;padding:15px;border-radius:8px;margin-top:15px"><strong>ðŸ”’ Score hidden until admin declares winners.</strong></div>';
                        }
                        
                        html += '</div>';
                        document.getElementById('quizStudentResults').innerHTML = html;
                        document.getElementById('quizResultsSection').style.display = 'block';
                    }
                } else {
                    document.getElementById('quizStatus').innerHTML = '<div style="background:#d4edda;padding:15px;border-radius:8px"><p style="margin:0;color:#155724"><strong>âœ… Ready!</strong> Today\'s quiz is available. Click below to start.</p></div>';
                    document.getElementById('quizStartSection').style.display = 'block';
                }
            } catch (err) {
                console.error('Status check error:', err);
                document.getElementById('quizStatus').innerHTML = '<div style="background:#f8d7da;padding:15px;border-radius:8px"><p style="margin:0;color:#721c24">âŒ Error checking quiz status. Please refresh the page.</p></div>';
            }
        }
        
        // Start Quiz
        async function startQuiz() {
            const today = await getQuizTodayServer();
            
            try {
                const qRef = db.ref(`quizQuestions/${today}`);
                const snap = await qRef.once('value');
                const questions = snap.val();
                
                if (!questions || !questions.q1 || !questions.q2) {
                    showQuizMsg('quizStudentMessage', 'Quiz not available!', 'error');
                    return;
                }
                
                // Set the date display
                const dateObj = new Date(today);
                const dateStr = dateObj.toLocaleDateString('en-IN', {
                    weekday: 'long',
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
                document.getElementById('quizDateDisplay').textContent = 'ðŸ“… ' + dateStr;
                
                document.getElementById('quizStudentDashboard').style.display = 'none';
                document.getElementById('quizPage').style.display = 'block';
                
                enableQuizAntiCheat();
                loadQuizQuestions(questions);
                quizStartTime = Date.now();
                startQuizTimer();
            } catch (err) {
                console.error('Start quiz error:', err);
            }
        }
        
        // Load Questions
        function loadQuizQuestions(questions) {
            const cont = document.getElementById('quizQuestionsContainer');
            
            let html = '';
            
            // Question 1
            html += '<div class="quiz-question-card" style="animation-delay: 0.1s">';
            html += '<h4><span style="background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:white;padding:5px 15px;border-radius:20px;font-size:0.9em">Question 1 of 2</span></h4>';
            
            // Add image if present
            if (questions.q1.image) {
                html += `<div style="text-align:center;margin:15px 0">
                    <img src="${questions.q1.image}" style="max-width:100%;max-height:300px;border-radius:12px;box-shadow:0 4px 15px rgba(0,0,0,0.2)">
                </div>`;
            }
            
            // Add audio player if present
            if (questions.q1.audio) {
                html += `<div style="text-align:center;margin:15px 0;background:#f0f0f0;padding:15px;border-radius:10px">
                    <p style="margin:0 0 10px 0;font-weight:600;color:#667eea">ðŸŽµ Listen to the audio</p>
                    <audio controls id="q1Audio" style="width:100%;max-width:400px">
                        <source src="${questions.q1.audio}">
                    </audio>
                </div>`;
            }
            
            html += `<div class="question-text">${questions.q1.text}</div>`;
            html += '<div style="display:grid;gap:15px">';
            ['A','B','C','D'].forEach(opt => {
                html += `<div class="quiz-option" data-question="qq1" data-value="${opt}">
                    <div class="option-circle">${opt}</div>
                    <span style="flex:1">${questions.q1.options[opt]}</span>
                    <input type="radio" name="qq1" value="${opt}" style="display:none">
                </div>`;
            });
            html += '</div></div>';
            
            // Question 2
            html += '<div class="quiz-question-card" style="animation-delay: 0.2s">';
            html += '<h4><span style="background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:white;padding:5px 15px;border-radius:20px;font-size:0.9em">Question 2 of 2</span></h4>';
            
            // Add image if present
            if (questions.q2.image) {
                html += `<div style="text-align:center;margin:15px 0">
                    <img src="${questions.q2.image}" style="max-width:100%;max-height:300px;border-radius:12px;box-shadow:0 4px 15px rgba(0,0,0,0.2)">
                </div>`;
            }
            
            // Add audio player if present
            if (questions.q2.audio) {
                html += `<div style="text-align:center;margin:15px 0;background:#f0f0f0;padding:15px;border-radius:10px">
                    <p style="margin:0 0 10px 0;font-weight:600;color:#667eea">ðŸŽµ Listen to the audio</p>
                    <audio controls id="q2Audio" style="width:100%;max-width:400px">
                        <source src="${questions.q2.audio}">
                    </audio>
                </div>`;
            }
            
            html += `<div class="question-text">${questions.q2.text}</div>`;
            html += '<div style="display:grid;gap:15px">';
            ['A','B','C','D'].forEach(opt => {
                html += `<div class="quiz-option" data-question="qq2" data-value="${opt}">
                    <div class="option-circle">${opt}</div>
                    <span style="flex:1">${questions.q2.options[opt]}</span>
                    <input type="radio" name="qq2" value="${opt}" style="display:none">
                </div>`;
            });
            html += '</div></div>';
            
            cont.innerHTML = html;
            
            // Add click handlers for new styled options
            document.querySelectorAll('.quiz-option').forEach(opt => {
                opt.onclick = function() {
                    const question = this.getAttribute('data-question');
                    const value = this.getAttribute('data-value');
                    
                    // Remove selected class from all options in this question
                    document.querySelectorAll(`.quiz-option[data-question="${question}"]`).forEach(o => {
                        o.classList.remove('selected');
                    });
                    
                    // Add selected class to clicked option
                    this.classList.add('selected');
                    
                    // Update hidden radio button
                    const radio = this.querySelector('input[type="radio"]');
                    radio.checked = true;
                };
            });
        }
        
        // Quiz Timer
        function startQuizTimer() {
            updateQuizTimer();
            quizTimerInterval = setInterval(updateQuizTimer, 1000);
        }
        
        function updateQuizTimer() {
            const elapsed = Math.floor((Date.now() - quizStartTime) / 1000);
            const mins = Math.floor(elapsed / 60);
            const secs = elapsed % 60;
            document.getElementById('quizTimerValue').textContent = `${mins.toString().padStart(2,'0')}:${secs.toString().padStart(2,'0')}`;
            
            if (elapsed > 600) {
                document.getElementById('quizTimer').style.background = '#ff6b6b';
                document.getElementById('quizTimer').style.color = 'white';
            }
        }
        
        // Submit Quiz
        let quizSubmitting = false; // Flag to prevent double submission

        async function submitQuizAnswers() {
            // BLOCK: Prevent double submission
            if (quizSubmitting) {
                return;
            }
            
            const q1 = document.querySelector('input[name="qq1"]:checked');
            const q2 = document.querySelector('input[name="qq2"]:checked');
            
            if (!q1 || !q2) {
                showQuizMsg('quizPageMessage', 'âš ï¸ Please answer all questions!', 'error');
                return;
            }
            
            // Immediately disable submit button and set flag
            quizSubmitting = true;
            const submitBtn = document.querySelector('.quiz-submit-btn');
            if (submitBtn) {
                submitBtn.disabled = true;
                submitBtn.textContent = 'â³ Submitting...';
                submitBtn.style.opacity = '0.6';
                submitBtn.style.cursor = 'not-allowed';
            }
            
            const today = await getQuizTodayServer();
            
            try {
                // BLOCK: Check Firebase if student already submitted today
                const existingSnap = await db.ref(`quizSubmissions/${today}`).once('value');
                if (existingSnap.exists()) {
                    let alreadySubmitted = false;
                    existingSnap.forEach(child => {
                        if (child.val().studentKey === quizCurrentUser.key) {
                            alreadySubmitted = true;
                        }
                    });
                    if (alreadySubmitted) {
                        showQuizMsg('quizPageMessage', 'âš ï¸ You have already submitted today\'s quiz!', 'error');
                        quizSubmitting = false;
                        if (submitBtn) {
                            submitBtn.disabled = true;
                            submitBtn.textContent = 'âœ… Already Submitted';
                        }
                        setTimeout(() => {
                            document.getElementById('quizPage').style.display = 'none';
                            document.getElementById('quizStudentDashboard').style.display = 'block';
                            checkQuizTodayStatus();
                        }, 2000);
                        return;
                    }
                }
                
                const qRef = db.ref(`quizQuestions/${today}`);
                const snap = await qRef.once('value');
                const questions = snap.val();
                
                let score = 0;
                if (q1.value === questions.q1.correct) score++;
                if (q2.value === questions.q2.correct) score++;
                
                await db.ref(`quizSubmissions/${today}`).push({
                    studentKey: quizCurrentUser.key,
                    studentName: quizCurrentUser.name,
                    studentEmail: quizCurrentUser.email,
                    studentClass: quizCurrentUser.class,
                    answers: {q1: q1.value, q2: q2.value},
                    score,
                    submittedAt: new Date().toISOString(),
                    timeTaken: Math.floor((Date.now() - quizStartTime) / 1000)
                });
                
                disableQuizAntiCheat();
                if (quizTimerInterval) clearInterval(quizTimerInterval);
                
                // Show success modal with confetti
                showQuizSuccessModal(score);
                
                setTimeout(() => {
                    quizSubmitting = false;
                    document.getElementById('quizPage').style.display = 'none';
                    document.getElementById('quizStudentDashboard').style.display = 'block';
                    // Scroll to top so student sees the status
                    window.scrollTo({ top: 0, behavior: 'instant' });
                    checkQuizTodayStatus();
                }, 4000);
            } catch (err) {
                console.error('Submit error:', err);
                quizSubmitting = false;
                if (submitBtn) {
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'âœ… Submit Quiz';
                    submitBtn.style.opacity = '1';
                    submitBtn.style.cursor = 'pointer';
                }
                showQuizMsg('quizPageMessage', 'Error submitting. Try again.', 'error');
            }
        }
        
        // Show Success Modal with Confetti
        function showQuizSuccessModal(score) {
            const modal = document.createElement('div');
            modal.className = 'quiz-success-modal';
            modal.innerHTML = `
                <div class="quiz-success-content">
                    <div class="success-icon">ðŸŽ‰</div>
                    <h2>Quiz Submitted!</h2>
                    <p style="font-size:1.1em;color:#28a745;font-weight:bold;margin-top:10px">Your response has been recorded successfully!</p>
                    <p style="margin-top:15px;color:#555">Results will be announced soon. Good luck! ðŸ€</p>
                </div>
            `;
            document.body.appendChild(modal);
            
            // Create confetti
            createConfetti();
            
            // Remove modal after 3.5 seconds
            setTimeout(() => {
                modal.style.opacity = '0';
                setTimeout(() => modal.remove(), 300);
            }, 3500);
        }
        
        // Create Confetti Animation
        function createConfetti() {
            const colors = ['#ff6b6b', '#4ecdc4', '#45b7d1', '#f7b731', '#5f27cd', '#00d2d3', '#ff9ff3', '#54a0ff'];
            const confettiCount = 50;
            
            for (let i = 0; i < confettiCount; i++) {
                const confetti = document.createElement('div');
                confetti.className = 'confetti';
                confetti.style.left = Math.random() * 100 + '%';
                confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                confetti.style.animationDelay = Math.random() * 0.5 + 's';
                confetti.style.animationDuration = (Math.random() * 2 + 2) + 's';
                document.body.appendChild(confetti);
                
                setTimeout(() => confetti.remove(), 3000);
            }
        }
        
        // Anti-Cheat
        function enableQuizAntiCheat() {
            quizAntiCheatActive = true;
            window.onbeforeunload = () => quizAntiCheatActive ? "Quiz in progress!" : null;
            document.addEventListener('visibilitychange', handleQuizVisibility);
        }
        
        function handleQuizVisibility() {
            if (quizAntiCheatActive && document.hidden) {
                alert('âš ï¸ TAB SWITCH! Auto-submitting quiz.');
                autoSubmitQuiz();
            }
        }
        
        async function autoSubmitQuiz() {
            if (!quizAntiCheatActive) return;
            const today = getQuizToday();
            try {
                await db.ref(`quizSubmissions/${today}`).push({
                    studentKey: quizCurrentUser.key,
                    studentName: quizCurrentUser.name,
                    studentEmail: quizCurrentUser.email,
                    studentClass: quizCurrentUser.class,
                    answers: {q1: 'X', q2: 'X'},
                    score: 0,
                    submittedAt: new Date().toISOString(),
                    timeTaken: 0,
                    status: 'auto-submitted'
                });
                disableQuizAntiCheat();
                if (quizTimerInterval) clearInterval(quizTimerInterval);
                document.getElementById('quizPage').style.display = 'none';
                document.getElementById('quizStudentDashboard').style.display = 'block';
                checkQuizTodayStatus();
            } catch (err) {
                console.error('Auto-submit error:', err);
            }
        }
        
        function disableQuizAntiCheat() {
            quizAntiCheatActive = false;
            window.onbeforeunload = null;
            document.removeEventListener('visibilitychange', handleQuizVisibility);
        }
        
        // Admin Functions
        async function loadQuizAdminStats() {
            try {
                const studSnap = await db.ref('quizStudents').once('value');
                document.getElementById('quizTotalStudents').textContent = studSnap.numChildren();
                
                const today = getQuizToday();
                const subSnap = await db.ref(`quizSubmissions/${today}`).once('value');
                document.getElementById('quizTodayParticipants').textContent = subSnap.numChildren();
                
                const qSnap = await db.ref(`quizQuestions/${today}`).once('value');
                document.getElementById('quizQuestionsCount').textContent = qSnap.exists() ? 2 : 0;
            } catch (err) {
                console.error('Stats error:', err);
            }
        }
        
        function showQuizAdminTab(tab) {
            document.querySelectorAll('#quizAdminDashboard .tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('#quizAdminDashboard .form-section').forEach(s => s.classList.remove('active'));
            
            const tabs = ['questions','students','submissions','results'];
            const idx = tabs.indexOf(tab);
            document.querySelectorAll('#quizAdminDashboard .tab')[idx].classList.add('active');
            document.getElementById(`quiz${tab.charAt(0).toUpperCase()+tab.slice(1)}TabContent`).classList.add('active');
            
            if (tab === 'students') loadQuizStudents();
            if (tab === 'submissions') loadQuizSubmissions();
            if (tab === 'results') loadQuizResults();
        }
        
        // Preview Image for Question
        function previewQuestionImage(input, previewId) {
            const preview = document.getElementById(previewId);
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    preview.innerHTML = `
                        <div style="position:relative;display:inline-block">
                            <img src="${e.target.result}" style="max-width:300px;max-height:200px;border-radius:8px;box-shadow:0 4px 10px rgba(0,0,0,0.1)">
                            <button onclick="clearMedia('${input.id}', '${previewId}')" style="position:absolute;top:5px;right:5px;background:red;color:white;border:none;border-radius:50%;width:25px;height:25px;cursor:pointer">Ã—</button>
                        </div>
                    `;
                };
                reader.readAsDataURL(input.files[0]);
            }
        }
        
        // Preview Audio for Question
        function previewQuestionAudio(input, previewId) {
            const preview = document.getElementById(previewId);
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    preview.innerHTML = `
                        <div style="background:#f0f0f0;padding:15px;border-radius:8px;display:inline-block">
                            <audio controls style="max-width:300px">
                                <source src="${e.target.result}">
                            </audio>
                            <button onclick="clearMedia('${input.id}', '${previewId}')" style="margin-left:10px;background:red;color:white;border:none;border-radius:5px;padding:5px 10px;cursor:pointer">Remove</button>
                        </div>
                    `;
                };
                reader.readAsDataURL(input.files[0]);
            }
        }
        
        // Clear Media
        function clearMedia(inputId, previewId) {
            document.getElementById(inputId).value = '';
            document.getElementById(previewId).innerHTML = '';
        }
        
        async function saveQuizQuestions() {
            const q1Text = document.getElementById('q1Text').value.trim();
            const q1OptA = document.getElementById('q1OptA').value.trim();
            const q1OptB = document.getElementById('q1OptB').value.trim();
            const q1OptC = document.getElementById('q1OptC').value.trim();
            const q1OptD = document.getElementById('q1OptD').value.trim();
            const q1Correct = document.getElementById('q1Correct').value;
            
            const q2Text = document.getElementById('q2Text').value.trim();
            const q2OptA = document.getElementById('q2OptA').value.trim();
            const q2OptB = document.getElementById('q2OptB').value.trim();
            const q2OptC = document.getElementById('q2OptC').value.trim();
            const q2OptD = document.getElementById('q2OptD').value.trim();
            const q2Correct = document.getElementById('q2Correct').value;
            
            if (!q1Text || !q1OptA || !q1OptB || !q1OptC || !q1OptD || !q1Correct) {
                showQuizMsg('quizAdminDashMessage', 'âš ï¸ Fill all Question 1 fields!', 'error');
                return;
            }
            
            if (!q2Text || !q2OptA || !q2OptB || !q2OptC || !q2OptD || !q2Correct) {
                showQuizMsg('quizAdminDashMessage', 'âš ï¸ Fill all Question 2 fields!', 'error');
                return;
            }
            
            // Get image and audio files
            const q1ImageFile = document.getElementById('q1Image').files[0];
            const q1AudioFile = document.getElementById('q1Audio').files[0];
            const q2ImageFile = document.getElementById('q2Image').files[0];
            const q2AudioFile = document.getElementById('q2Audio').files[0];
            
            const today = getQuizToday();
            const data = {
                q1: {
                    text: q1Text, 
                    options: {A:q1OptA, B:q1OptB, C:q1OptC, D:q1OptD}, 
                    correct: q1Correct
                },
                q2: {
                    text: q2Text, 
                    options: {A:q2OptA, B:q2OptB, C:q2OptC, D:q2OptD}, 
                    correct: q2Correct
                },
                createdAt: new Date().toISOString(),
                createdBy: quizCurrentUser.email
            };
            
            // Upload images and audio to Cloudinary if present
            try {
                if (q1ImageFile) {
                    data.q1.image = await quizUploadToCloudinary(q1ImageFile, 'q1_image');
                }
                if (q1AudioFile) {
                    data.q1.audio = await quizUploadToCloudinary(q1AudioFile, 'q1_audio');
                }
                if (q2ImageFile) {
                    data.q2.image = await quizUploadToCloudinary(q2ImageFile, 'q2_image');
                }
                if (q2AudioFile) {
                    data.q2.audio = await quizUploadToCloudinary(q2AudioFile, 'q2_audio');
                }
                
                await db.ref(`quizQuestions/${today}`).set(data);
                showQuizMsg('quizAdminDashMessage', 'âœ… Questions saved successfully with media!', 'success');
                
                // Clear form
                ['q1Text','q1OptA','q1OptB','q1OptC','q1OptD','q1Correct','q2Text','q2OptA','q2OptB','q2OptC','q2OptD','q2Correct'].forEach(id => {
                    document.getElementById(id).value = '';
                });
                ['q1Image','q1Audio','q2Image','q2Audio'].forEach(id => {
                    document.getElementById(id).value = '';
                });
                ['q1ImagePreview','q1AudioPreview','q2ImagePreview','q2AudioPreview'].forEach(id => {
                    document.getElementById(id).innerHTML = '';
                });
                
                await loadQuizAdminStats();
            } catch (err) {
                console.error('Save error:', err);
                showQuizMsg('quizAdminDashMessage', 'Error saving questions.', 'error');
            }
        }
        
        // Convert file to base64 (used for PREVIEWS only â€” not saved to DB)
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        // Upload quiz media (image/audio) to Cloudinary, return secure URL
        async function quizUploadToCloudinary(file, label) {
            const isAudio = file.type.startsWith('audio/');
            const resourceType = isAudio ? 'video' : 'image'; // Cloudinary uses 'video' for audio
            const formData = new FormData();
            formData.append('file', file);
            formData.append('upload_preset', 'scavenger_hunt');
            formData.append('folder', 'quiz_media');
            formData.append('public_id', label + '_' + Date.now());
            const res = await fetch(
                `https://api.cloudinary.com/v1_1/dat0khbet/${resourceType}/upload`,
                { method: 'POST', body: formData }
            );
            if (!res.ok) {
                const err = await res.json();
                throw new Error(err.error?.message || 'Cloudinary upload failed');
            }
            const data = await res.json();
            return data.secure_url;
        }
        
        async function viewTodayQuestions() {
            const today = getQuizToday();
            try {
                const snap = await db.ref(`quizQuestions/${today}`).once('value');
                const q = snap.val();
                const view = document.getElementById('todayQuestionsView');
                
                if (!q) {
                    view.innerHTML = '<div style="background:#fff3cd;padding:15px;border-radius:8px;margin-top:20px"><p style="margin:0;color:#856404">No questions for today yet.</p></div>';
                    view.style.display = 'block';
                    return;
                }
                
                let html = '<div style="background:#f8f9fa;padding:20px;border-radius:10px">';
                html += '<h4 style="color:#667eea;margin-bottom:15px">Today\'s Questions Preview</h4>';
                html += `<p><strong>Q1:</strong> ${q.q1.text}</p>`;
                html += `<p style="margin-left:20px">A) ${q.q1.options.A}</p>`;
                html += `<p style="margin-left:20px">B) ${q.q1.options.B}</p>`;
                html += `<p style="margin-left:20px">C) ${q.q1.options.C}</p>`;
                html += `<p style="margin-left:20px">D) ${q.q1.options.D}</p>`;
                html += `<p style="color:green;font-weight:bold;margin-left:20px">Correct: ${q.q1.correct}</p><br>`;
                html += `<p><strong>Q2:</strong> ${q.q2.text}</p>`;
                html += `<p style="margin-left:20px">A) ${q.q2.options.A}</p>`;
                html += `<p style="margin-left:20px">B) ${q.q2.options.B}</p>`;
                html += `<p style="margin-left:20px">C) ${q.q2.options.C}</p>`;
                html += `<p style="margin-left:20px">D) ${q.q2.options.D}</p>`;
                html += `<p style="color:green;font-weight:bold;margin-left:20px">Correct: ${q.q2.correct}</p>`;
                html += '</div>';
                
                view.innerHTML = html;
                view.style.display = 'block';
                
                // Check publish status
                await checkPublishStatusForToday();
            } catch (err) {
                console.error('View error:', err);
            }
        }
        
        async function loadQuizStudents() {
            try {
                const snap = await db.ref('quizStudents').once('value');
                const tbody = document.getElementById('quizStudentsTable');
                tbody.innerHTML = '';
                
                if (!snap.exists()) {
                    tbody.innerHTML = '<tr><td colspan="6" style="text-align:center">No students yet.</td></tr>';
                    return;
                }
                
                let idx = 1;
                snap.forEach(child => {
                    const s = child.val();
                    const row = tbody.insertRow();
                    row.innerHTML = `<td>${idx++}</td><td>${s.name}</td><td>${s.email}</td><td>${s.phone}</td><td>${s.class}</td><td>${new Date(s.registeredAt).toLocaleDateString()}</td>`;
                });
            } catch (err) {
                console.error('Load students error:', err);
            }
        }
        
        async function loadQuizSubmissions() {
            const today = getQuizToday();
            try {
                const snap = await db.ref(`quizSubmissions/${today}`).once('value');
                const tbody = document.getElementById('quizSubmissionsTable');
                tbody.innerHTML = '';
                
                if (!snap.exists()) {
                    tbody.innerHTML = '<tr><td colspan="7" style="text-align:center">No submissions yet today.</td></tr>';
                    return;
                }
                
                let idx = 1;
                snap.forEach(child => {
                    const s = child.val();
                    const row = tbody.insertRow();
                    const timeMins = Math.floor(s.timeTaken / 60);
                    const timeSecs = s.timeTaken % 60;
                    row.innerHTML = `<td>${idx++}</td><td>${s.studentName}</td><td>${s.studentEmail}</td><td>${s.studentClass}</td><td>${new Date(s.submittedAt).toLocaleString()}</td><td><strong>${s.score}/2</strong></td><td>${timeMins}m ${timeSecs}s</td>`;
                });
            } catch (err) {
                console.error('Load submissions error:', err);
            }
        }
        
        async function loadQuizResults() {
            const today = getQuizToday();
            try {
                const snap = await db.ref(`quizSubmissions/${today}`).once('value');
                
                if (!snap.exists()) {
                    document.getElementById('resultTotalPart').textContent = '0';
                    document.getElementById('resultBothCorrect').textContent = '0';
                    document.getElementById('resultEligible').textContent = '0';
                    return;
                }
                
                let total = 0, correct = 0;
                snap.forEach(child => {
                    total++;
                    if (child.val().score === 2) correct++;
                });
                
                document.getElementById('resultTotalPart').textContent = total;
                document.getElementById('resultBothCorrect').textContent = correct;
                document.getElementById('resultEligible').textContent = correct;
                
                const resSnap = await db.ref(`quizResults/${today}`).once('value');
                if (resSnap.exists()) {
                    displayQuizWinners(resSnap.val());
                }
            } catch (err) {
                console.error('Load results error:', err);
            }
        }
        
        async function selectQuizWinners() {
            const today = getQuizToday();
            try {
                const snap = await db.ref(`quizSubmissions/${today}`).once('value');
                const eligible = [];
                snap.forEach(child => {
                    if (child.val().score === 2) eligible.push(child.val());
                });
                
                if (eligible.length === 0) {
                    showQuizMsg('quizAdminDashMessage', 'âš ï¸ No correct answers yet!', 'warning');
                    return;
                }
                
                if (eligible.length === 1) {
                    showQuizMsg('quizAdminDashMessage', 'âš ï¸ Only one correct. Need 2 for winner & runner-up.', 'warning');
                    return;
                }
                
                const shuffled = eligible.sort(() => 0.5 - Math.random());
                const winner = shuffled[0];
                const runnerUp = shuffled[1];
                
                const data = {
                    winner: {name: winner.studentName, email: winner.studentEmail, class: winner.studentClass, score: winner.score},
                    runnerUp: {name: runnerUp.studentName, email: runnerUp.studentEmail, class: runnerUp.studentClass, score: runnerUp.score},
                    declaredAt: new Date().toISOString(),
                    declaredBy: quizCurrentUser.email,
                    totalEligible: eligible.length
                };
                
                await db.ref(`quizResults/${today}`).set(data);
                
                // Try to send emails but don't block winner declaration
                try {
                    await sendQuizEmail(winner.studentEmail, 'ðŸ† You Won Quiz!', `Dear ${winner.studentName},\n\nCongratulations! You are the WINNER!\n\nScore: ${winner.score}/2\nClass: ${winner.studentClass}\n\nDavan Institute`);
                } catch (e) { console.log('Winner email failed:', e); }
                
                try {
                    await sendQuizEmail(runnerUp.studentEmail, 'ðŸ¥ˆ Runner-Up!', `Dear ${runnerUp.studentName},\n\nCongratulations! You are RUNNER-UP!\n\nScore: ${runnerUp.score}/2\nClass: ${runnerUp.studentClass}\n\nDavan Institute`);
                } catch (e) { console.log('Runner-up email failed:', e); }
                
                showQuizMsg('quizAdminDashMessage', 'âœ… Winners selected & emails sent!', 'success');
                displayQuizWinners(data);
            } catch (err) {
                console.error('Select winners error:', err);
                showQuizMsg('quizAdminDashMessage', 'Error selecting winners.', 'error');
            }
        }
        
        function displayQuizWinners(data) {
            const div = document.getElementById('winnersDisplaySection');
            let html = '<div style="background:#f8f9fa;padding:25px;border-radius:12px">';
            html += '<h3 style="color:#667eea;margin-bottom:20px;text-align:center">ðŸŽ‰ Today\'s Winners</h3>';
            html += '<div style="background:linear-gradient(135deg,#ffd700 0%,#ffed4e 100%);padding:20px;border-radius:10px;margin-bottom:15px;color:#333">';
            html += '<h4 style="margin-bottom:10px">ðŸ† WINNER</h4>';
            html += `<p><strong>Name:</strong> ${data.winner.name}</p>`;
            html += `<p><strong>Email:</strong> ${data.winner.email}</p>`;
            html += `<p><strong>Class:</strong> ${data.winner.class}</p>`;
            html += `<p><strong>Score:</strong> ${data.winner.score}/2</p></div>`;
            html += '<div style="background:linear-gradient(135deg,#c0c0c0 0%,#e8e8e8 100%);padding:20px;border-radius:10px;color:#333">';
            html += '<h4 style="margin-bottom:10px">ðŸ¥ˆ RUNNER-UP</h4>';
            html += `<p><strong>Name:</strong> ${data.runnerUp.name}</p>`;
            html += `<p><strong>Email:</strong> ${data.runnerUp.email}</p>`;
            html += `<p><strong>Class:</strong> ${data.runnerUp.class}</p>`;
            html += `<p><strong>Score:</strong> ${data.runnerUp.score}/2</p></div>`;
            html += `<p style="text-align:center;margin-top:20px;color:#666"><small>Declared: ${new Date(data.declaredAt).toLocaleString()}</small></p></div>`;
            div.innerHTML = html;
            div.style.display = 'block';
        }
        
        // ========== INTEGRATED QUIZ MANAGEMENT FUNCTIONS ==========
        
        function showQuizManagementTab(tab, event) {
            document.querySelectorAll('#quizManagement .tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('#quizManagement .form-section').forEach(s => s.classList.remove('active'));
            
            // Only try to add active class to event target if event exists
            if (event && event.target) {
                event.target.classList.add('active');
            } else {
                // Programmatic call - find and activate the correct tab button
                const tabButtons = {
                    'questions': 0,
                    'allquizzes': 1,
                    'students': 2,
                    'submissions': 3,
                    'winners': 4,
                    'editdates': 5
                };
                const tabIndex = tabButtons[tab];
                if (tabIndex !== undefined) {
                    const tabs = document.querySelectorAll('#quizManagement .tab');
                    if (tabs[tabIndex]) {
                        tabs[tabIndex].classList.add('active');
                    }
                }
            }
            
            if (tab === 'questions') {
                document.getElementById('quizQuestionsContent').classList.add('active');
            } else if (tab === 'allquizzes') {
                document.getElementById('quizAllQuizzesContent').classList.add('active');
                loadAllQuizzes();
            } else if (tab === 'students') {
                document.getElementById('quizStudentsContent').classList.add('active');
                loadQuizStudentsAdmin();
            } else if (tab === 'submissions') {
                document.getElementById('quizSubmissionsContent').classList.add('active');
                loadQuizSubmissionsAdmin();
            } else if (tab === 'winners') {
                document.getElementById('quizWinnersContent').classList.add('active');
                // Initialize date selector to today if not set
                const wds = document.getElementById('winnersDateSelector');
                if (wds && !wds.value) wds.value = getQuizToday();
                loadQuizResultsAdmin();
                // Init auto-declaration toggle state
                if (typeof initAutoDeclarScheduler === 'function') initAutoDeclarScheduler();
            } else if (tab === 'editdates') {
                document.getElementById('quizEditDatesContent').classList.add('active');
                loadQuizzesForDateEdit();
            }
        }
        
        // Function to load quiz questions for the selected date
        async function loadQuizForSelectedDate() {
            const selectedDate = document.getElementById('quizDateSelector').value;
            if (!selectedDate) {
                return;
            }
            
            console.log('Loading quiz for date:', selectedDate);
            
            // Update heading
            const dateObj = new Date(selectedDate + 'T00:00:00');
            const dateStr = dateObj.toLocaleDateString('en-IN', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
            document.getElementById('quizQuestionsHeading').textContent = `Create Quiz for ${dateStr} (2 Questions)`;
            
            try {
                const snapshot = await db.ref(`quizQuestions/${selectedDate}`).once('value');
                
                if (snapshot.exists()) {
                    const data = snapshot.val();
                    console.log('Found existing quiz:', data);
                    
                    // Populate form with existing data
                    document.getElementById('quiz_q1Text').value = data.q1.text || '';
                    document.getElementById('quiz_q1OptA').value = data.q1.options.A || '';
                    document.getElementById('quiz_q1OptB').value = data.q1.options.B || '';
                    document.getElementById('quiz_q1OptC').value = data.q1.options.C || '';
                    document.getElementById('quiz_q1OptD').value = data.q1.options.D || '';
                    document.getElementById('quiz_q1Correct').value = data.q1.correct || '';
                    
                    document.getElementById('quiz_q2Text').value = data.q2.text || '';
                    document.getElementById('quiz_q2OptA').value = data.q2.options.A || '';
                    document.getElementById('quiz_q2OptB').value = data.q2.options.B || '';
                    document.getElementById('quiz_q2OptC').value = data.q2.options.C || '';
                    document.getElementById('quiz_q2OptD').value = data.q2.options.D || '';
                    document.getElementById('quiz_q2Correct').value = data.q2.correct || '';
                    
                    showQuizMsg('quizAdminMessage', `âœï¸ Editing existing quiz for ${selectedDate}. Modify and save to update.`, 'success');
                    // Don't show preview on initial load - only after save
                    // displaySavedQuestionsPreview(data);
                } else {
                    console.log('No quiz found for this date, clearing form');
                    
                    // Clear form for new quiz
                    ['quiz_q1Text','quiz_q1OptA','quiz_q1OptB','quiz_q1OptC','quiz_q1OptD','quiz_q1Correct','quiz_q2Text','quiz_q2OptA','quiz_q2OptB','quiz_q2OptC','quiz_q2OptD','quiz_q2Correct'].forEach(id => {
                        const el = document.getElementById(id);
                        if (el) el.value = '';
                    });
                    
                    document.getElementById('todayQuestionsViewAdmin').innerHTML = '';
                    document.getElementById('todayQuestionsViewAdmin').style.display = 'none';
                    
                    showQuizMsg('quizAdminMessage', `ðŸ“ No quiz exists for ${selectedDate}. Create a new one below.`, 'error');
                }
            } catch (err) {
                console.error('Error loading quiz:', err);
                showQuizMsg('quizAdminMessage', 'Error loading quiz: ' + err.message, 'error');
            }
        }
        
        // Initialize date selector with today's date when page loads
        function initializeDateSelector() {
            const dateInput = document.getElementById('quizDateSelector');
            if (dateInput) {
                const today = getQuizToday();
                dateInput.value = today;
                loadQuizForSelectedDate();
            }
        }
        
        async function loadQuizManagementStats() {
            try {
                const studSnap = await db.ref('quizStudents').once('value');
                document.getElementById('quizTotalStudents').textContent = studSnap.numChildren();
                
                const today = getQuizToday();
                const subSnap = await db.ref(`quizSubmissions/${today}`).once('value');
                document.getElementById('quizTodayParticipants').textContent = subSnap.numChildren();
                
                const qSnap = await db.ref(`quizQuestions/${today}`).once('value');
                document.getElementById('quizQuestionsCount').textContent = qSnap.exists() ? 2 : 0;
            } catch (err) {
                console.error('Load quiz stats error:', err);
            }
        }
        
        async function loadAllQuizzes() {
            const container = document.getElementById('allQuizzesContainer');
            container.innerHTML = '<p style="text-align:center;color:#666">Loading all quizzes...</p>';
            
            try {
                const quizzesSnap = await db.ref('quizQuestions').once('value');
                
                if (!quizzesSnap.exists()) {
                    container.innerHTML = '<div style="background:#fff3cd;padding:20px;border-radius:8px;text-align:center"><p style="margin:0;color:#856404">No quizzes found in database.</p></div>';
                    return;
                }
                
                // Get all quiz dates and sort them (newest first)
                const quizzes = [];
                quizzesSnap.forEach(child => {
                    quizzes.push({
                        date: child.key,
                        data: child.val()
                    });
                });
                
                quizzes.sort((a, b) => new Date(b.date) - new Date(a.date));
                
                // Get publish statuses
                const publishedSnap = await db.ref('quizPublished').once('value');
                const publishedData = publishedSnap.val() || {};
                
                let html = '';
                
                for (const quiz of quizzes) {
                    const dateObj = new Date(quiz.date);
                    const dateStr = dateObj.toLocaleDateString('en-IN', {
                        weekday: 'long',
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric'
                    });
                    
                    const isPublished = publishedData[quiz.date] && publishedData[quiz.date].published === true;
                    const publishInfo = publishedData[quiz.date];
                    
                    html += '<div style="background:white;padding:20px;border-radius:10px;margin-bottom:20px;border-left:5px solid ' + (isPublished ? '#4CAF50' : '#667eea') + '">';
                    html += '<div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:15px">';
                    html += '<div>';
                    html += '<h4 style="color:#667eea;margin:0 0 5px 0">ðŸ“… ' + dateStr + '</h4>';
                    html += '<p style="margin:0;font-size:0.9em;color:#666">Date: ' + quiz.date + '</p>';
                    if (publishInfo) {
                        if (isPublished) {
                            html += '<p style="margin:5px 0 0 0;font-size:0.85em;color:#4CAF50;font-weight:600">âœ… PUBLISHED on ' + new Date(publishInfo.publishedAt).toLocaleString() + '</p>';
                        } else {
                            html += '<p style="margin:5px 0 0 0;font-size:0.85em;color:#ff9800;font-weight:600">âš ï¸ UNPUBLISHED</p>';
                        }
                    } else {
                        html += '<p style="margin:5px 0 0 0;font-size:0.85em;color:#999">Not yet published</p>';
                    }
                    html += '</div>';
                    html += '<div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">';
                    html += '<button class="btn btn-info btn-small" onclick="editQuizByDate(\'' + quiz.date + '\')" style="background:#2196F3;font-weight:600">âœï¸ Edit</button>';
                    html += '<button class="btn btn-danger btn-small" onclick="deleteQuizByDate(\'' + quiz.date + '\')" style="font-weight:600">ðŸ—‘ï¸ Delete</button>';
                    if (isPublished) {
                        html += '<button class="btn btn-small" onclick="unpublishQuizByDate(\'' + quiz.date + '\')" style="background:#ff9800;color:white;font-weight:600">âŒ Unpublish</button>';
                    } else {
                        html += '<button class="btn btn-success btn-small" onclick="publishQuizByDate(\'' + quiz.date + '\')" style="font-weight:600">âœ… Publish</button>';
                    }
                    html += '</div>';
                    html += '</div>';
                    
                    html += '<div style="background:#f8f9fa;padding:15px;border-radius:8px">';
                    html += '<p style="margin:0 0 10px 0;font-weight:600">Question 1:</p>';
                    
                    // Show image if present
                    if (quiz.data.q1.image) {
                        html += '<div style="text-align:center;margin:10px 0"><img src="' + quiz.data.q1.image + '" style="max-width:100%;max-height:200px;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,0.1)"></div>';
                    }
                    
                    // Show audio if present
                    if (quiz.data.q1.audio) {
                        html += '<div style="margin:10px 0;background:#e8f5e9;padding:10px;border-radius:6px"><p style="margin:0 0 5px 0;font-size:0.9em;color:#2e7d32">ðŸŽµ Audio attached</p><audio controls style="width:100%;max-width:300px"><source src="' + quiz.data.q1.audio + '"></audio></div>';
                    }
                    
                    html += '<p style="margin:0 0 10px 0">' + quiz.data.q1.text + '</p>';
                    html += '<p style="margin:0;color:#4CAF50;font-weight:600">âœ… Correct: ' + quiz.data.q1.options[quiz.data.q1.correct] + '</p>';
                    html += '</div>';
                    
                    html += '<div style="background:#f8f9fa;padding:15px;border-radius:8px;margin-top:10px">';
                    html += '<p style="margin:0 0 10px 0;font-weight:600">Question 2:</p>';
                    
                    // Show image if present
                    if (quiz.data.q2.image) {
                        html += '<div style="text-align:center;margin:10px 0"><img src="' + quiz.data.q2.image + '" style="max-width:100%;max-height:200px;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,0.1)"></div>';
                    }
                    
                    // Show audio if present
                    if (quiz.data.q2.audio) {
                        html += '<div style="margin:10px 0;background:#e8f5e9;padding:10px;border-radius:6px"><p style="margin:0 0 5px 0;font-size:0.9em;color:#2e7d32">ðŸŽµ Audio attached</p><audio controls style="width:100%;max-width:300px"><source src="' + quiz.data.q2.audio + '"></audio></div>';
                    }
                    
                    html += '<p style="margin:0 0 10px 0">' + quiz.data.q2.text + '</p>';
                    html += '<p style="margin:0;color:#4CAF50;font-weight:600">âœ… Correct: ' + quiz.data.q2.options[quiz.data.q2.correct] + '</p>';
                    html += '</div>';
                    
                    html += '</div>';
                }
                
                container.innerHTML = html;
                
            } catch (err) {
                console.error('Load all quizzes error:', err);
                container.innerHTML = '<div style="background:#f8d7da;padding:20px;border-radius:8px;text-align:center"><p style="margin:0;color:#721c24">Error loading quizzes: ' + err.message + '</p></div>';
            }
        }
        
        async function publishQuizByDate(date) {
            if (!confirm(`Publish quiz for ${date}?\n\nThis will show the questions and answers publicly for educational review.`)) return;
            
            try {
                await db.ref(`quizPublished/${date}`).set({
                    published: true,
                    publishedAt: new Date().toISOString(),
                    publishedBy: 'Super Admin'
                });
                
                alert('âœ… Quiz published successfully!');
                loadAllQuizzes();
            } catch (err) {
                console.error('Publish error:', err);
                alert('âŒ Error publishing quiz: ' + err.message);
            }
        }
        
        async function unpublishQuizByDate(date) {
            if (!confirm(`Unpublish quiz for ${date}?\n\nThis will hide the answers from public view.`)) return;
            
            try {
                await db.ref(`quizPublished/${date}`).set({
                    published: false,
                    unpublishedAt: new Date().toISOString(),
                    unpublishedBy: 'Super Admin'
                });
                
                alert('âœ… Quiz unpublished successfully!');
                loadAllQuizzes();
            } catch (err) {
                console.error('Unpublish error:', err);
                alert('âŒ Error unpublishing quiz: ' + err.message);
            }
        }
        
        function removeExistingMedia(question, type) {
            const previewId = `quiz_${question}${type === 'image' ? 'Image' : 'Audio'}Preview`;
            const confirmMsg = `Remove this ${type} from Question ${question === 'q1' ? '1' : '2'}?`;
            
            if (confirm(confirmMsg)) {
                // Mark for deletion
                if (question === 'q1' && type === 'image') {
                    window.editingQuizData.deleteQ1Image = true;
                } else if (question === 'q1' && type === 'audio') {
                    window.editingQuizData.deleteQ1Audio = true;
                } else if (question === 'q2' && type === 'image') {
                    window.editingQuizData.deleteQ2Image = true;
                } else if (question === 'q2' && type === 'audio') {
                    window.editingQuizData.deleteQ2Audio = true;
                }
                
                // Clear the preview
                document.getElementById(previewId).innerHTML = `<p style="color:#28a745;font-weight:600">âœ“ ${type.charAt(0).toUpperCase() + type.slice(1)} will be removed when you save</p>`;
            }
        }
        
        async function editQuizByDate(date) {
            try {
                // Load the quiz data
                const snap = await db.ref(`quizQuestions/${date}`).once('value');
                const quizData = snap.val();
                
                if (!quizData) {
                    alert('âŒ Quiz not found!');
                    return;
                }
                
                // Switch to Questions tab
                showQuizManagementTab('questions');
                
                // Set the date selector
                document.getElementById('quizDateSelector').value = date;
                
                // Populate the form with existing data
                document.getElementById('quiz_q1Text').value = (quizData.q1 && quizData.q1.text) || '';
                document.getElementById('quiz_q1OptA').value = (quizData.q1 && quizData.q1.options && quizData.q1.options.A) || '';
                document.getElementById('quiz_q1OptB').value = (quizData.q1 && quizData.q1.options && quizData.q1.options.B) || '';
                document.getElementById('quiz_q1OptC').value = (quizData.q1 && quizData.q1.options && quizData.q1.options.C) || '';
                document.getElementById('quiz_q1OptD').value = (quizData.q1 && quizData.q1.options && quizData.q1.options.D) || '';
                document.getElementById('quiz_q1Correct').value = (quizData.q1 && quizData.q1.correct) || '';
                
                document.getElementById('quiz_q2Text').value = (quizData.q2 && quizData.q2.text) || '';
                document.getElementById('quiz_q2OptA').value = (quizData.q2 && quizData.q2.options && quizData.q2.options.A) || '';
                document.getElementById('quiz_q2OptB').value = (quizData.q2 && quizData.q2.options && quizData.q2.options.B) || '';
                document.getElementById('quiz_q2OptC').value = (quizData.q2 && quizData.q2.options && quizData.q2.options.C) || '';
                document.getElementById('quiz_q2OptD').value = (quizData.q2 && quizData.q2.options && quizData.q2.options.D) || '';
                document.getElementById('quiz_q2Correct').value = (quizData.q2 && quizData.q2.correct) || '';
                
                // Clear previous previews
                document.getElementById('quiz_q1ImagePreview').innerHTML = '';
                document.getElementById('quiz_q1AudioPreview').innerHTML = '';
                document.getElementById('quiz_q2ImagePreview').innerHTML = '';
                document.getElementById('quiz_q2AudioPreview').innerHTML = '';
                
                // Store existing media in global variables for deletion tracking
                window.editingQuizData = {
                    q1Image: (quizData.q1 && quizData.q1.image) || null,
                    q1Audio: (quizData.q1 && quizData.q1.audio) || null,
                    q2Image: (quizData.q2 && quizData.q2.image) || null,
                    q2Audio: (quizData.q2 && quizData.q2.audio) || null,
                    deleteQ1Image: false,
                    deleteQ1Audio: false,
                    deleteQ2Image: false,
                    deleteQ2Audio: false
                };
                
                // Show image previews if images exist
                if (quizData.q1 && quizData.q1.image) {
                    document.getElementById('quiz_q1ImagePreview').innerHTML = `
                        <div style="position:relative;display:inline-block">
                            <img src="${quizData.q1.image}" style="max-width:300px;max-height:200px;border-radius:8px;box-shadow:0 4px 10px rgba(0,0,0,0.1)">
                            <p style="margin-top:5px;color:#666;font-size:0.9em">Current image</p>
                            <button type="button" class="btn btn-danger btn-small" onclick="removeExistingMedia('q1', 'image')" style="margin-top:5px">ðŸ—‘ï¸ Remove Image</button>
                            <p style="margin-top:5px;color:#999;font-size:0.85em">Or upload a new one below to replace it</p>
                        </div>
                    `;
                }
                
                if (quizData.q2 && quizData.q2.image) {
                    document.getElementById('quiz_q2ImagePreview').innerHTML = `
                        <div style="position:relative;display:inline-block">
                            <img src="${quizData.q2.image}" style="max-width:300px;max-height:200px;border-radius:8px;box-shadow:0 4px 10px rgba(0,0,0,0.1)">
                            <p style="margin-top:5px;color:#666;font-size:0.9em">Current image</p>
                            <button type="button" class="btn btn-danger btn-small" onclick="removeExistingMedia('q2', 'image')" style="margin-top:5px">ðŸ—‘ï¸ Remove Image</button>
                            <p style="margin-top:5px;color:#999;font-size:0.85em">Or upload a new one below to replace it</p>
                        </div>
                    `;
                }
                
                // Show audio previews if audio exists
                if (quizData.q1 && quizData.q1.audio) {
                    document.getElementById('quiz_q1AudioPreview').innerHTML = `
                        <div style="background:#f0f0f0;padding:15px;border-radius:8px;display:inline-block">
                            <p style="margin:0 0 5px 0;color:#666;font-size:0.9em">Current audio</p>
                            <audio controls style="max-width:300px">
                                <source src="${quizData.q1.audio}">
                            </audio>
                            <div style="margin-top:10px">
                                <button type="button" class="btn btn-danger btn-small" onclick="removeExistingMedia('q1', 'audio')">ðŸ—‘ï¸ Remove Audio</button>
                            </div>
                            <p style="margin-top:5px;color:#999;font-size:0.85em">Or upload a new one below to replace it</p>
                        </div>
                    `;
                }
                
                if (quizData.q2 && quizData.q2.audio) {
                    document.getElementById('quiz_q2AudioPreview').innerHTML = `
                        <div style="background:#f0f0f0;padding:15px;border-radius:8px;display:inline-block">
                            <p style="margin:0 0 5px 0;color:#666;font-size:0.9em">Current audio</p>
                            <audio controls style="max-width:300px">
                                <source src="${quizData.q2.audio}">
                            </audio>
                            <div style="margin-top:10px">
                                <button type="button" class="btn btn-danger btn-small" onclick="removeExistingMedia('q2', 'audio')">ðŸ—‘ï¸ Remove Audio</button>
                            </div>
                            <p style="margin-top:5px;color:#999;font-size:0.85em">Or upload a new one below to replace it</p>
                        </div>
                    `;
                }
                
                // Update the heading
                const dateObj = new Date(date);
                const dateStr = dateObj.toLocaleDateString('en-IN', {
                    weekday: 'long',
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
                document.getElementById('quizQuestionsHeading').textContent = `Edit Quiz for ${dateStr} (2 Questions)`;
                
                // Show success message
                showQuizMsg('quizAdminMessage', `âœï¸ Editing quiz for ${date}. Make your changes and click Save.`, 'success');
                
                // Scroll to quiz editor
                const qHeading = document.getElementById('quizQuestionsHeading');
                if (qHeading) qHeading.scrollIntoView({ behavior: 'smooth', block: 'start' });
                
            } catch (err) {
                console.error('Edit quiz error:', err);
                alert('âŒ Error loading quiz for editing: ' + err.message);
            }
        }
        
        async function deleteQuizByDate(date) {
            if (!confirm(`âš ï¸ DELETE QUIZ FOR ${date}?\n\nThis will permanently delete:\n- Questions\n- All submissions\n- Results\n- Publish status\n\nThis action CANNOT be undone!\n\nAre you sure?`)) return;
            
            // Double confirmation for safety
            if (!confirm(`FINAL CONFIRMATION\n\nYou are about to permanently delete the quiz for ${date}.\n\nType YES in the next prompt to confirm.`)) return;
            
            const confirmation = prompt('Type YES (in capital letters) to confirm deletion:');
            if (confirmation !== 'YES') {
                alert('Deletion cancelled.');
                return;
            }
            
            try {
                // Delete all related data
                await Promise.all([
                    db.ref(`quizQuestions/${date}`).remove(),
                    db.ref(`quizSubmissions/${date}`).remove(),
                    db.ref(`quizResults/${date}`).remove(),
                    db.ref(`quizPublished/${date}`).remove()
                ]);
                
                alert('âœ… Quiz deleted successfully!');
                loadAllQuizzes();
            } catch (err) {
                console.error('Delete error:', err);
                alert('âŒ Error deleting quiz: ' + err.message);
            }
        }
        
        async function saveQuizQuestionsFromAdmin() {
            // Get selected date
            const selectedDate = document.getElementById('quizDateSelector').value;
            if (!selectedDate) {
                alert('âš ï¸ Please select a date first!');
                showQuizMsg('quizAdminMessage', 'âš ï¸ Please select a date first!', 'error');
                return;
            }
            
            const q1Text = document.getElementById('quiz_q1Text').value.trim();
            const q1OptA = document.getElementById('quiz_q1OptA').value.trim();
            const q1OptB = document.getElementById('quiz_q1OptB').value.trim();
            const q1OptC = document.getElementById('quiz_q1OptC').value.trim();
            const q1OptD = document.getElementById('quiz_q1OptD').value.trim();
            const q1Correct = document.getElementById('quiz_q1Correct').value;
            
            const q2Text = document.getElementById('quiz_q2Text').value.trim();
            const q2OptA = document.getElementById('quiz_q2OptA').value.trim();
            const q2OptB = document.getElementById('quiz_q2OptB').value.trim();
            const q2OptC = document.getElementById('quiz_q2OptC').value.trim();
            const q2OptD = document.getElementById('quiz_q2OptD').value.trim();
            const q2Correct = document.getElementById('quiz_q2Correct').value;
            
            console.log('Saving questions for date:', selectedDate, {q1Text, q1Correct, q2Text, q2Correct});
            
            if (!q1Text || !q1OptA || !q1OptB || !q1OptC || !q1OptD || !q1Correct) {
                alert('âš ï¸ Please fill all Question 1 fields!');
                showQuizMsg('quizAdminMessage', 'âš ï¸ Fill all Question 1 fields!', 'error');
                return;
            }
            
            if (!q2Text || !q2OptA || !q2OptB || !q2OptC || !q2OptD || !q2Correct) {
                alert('âš ï¸ Please fill all Question 2 fields!');
                showQuizMsg('quizAdminMessage', 'âš ï¸ Fill all Question 2 fields!', 'error');
                return;
            }
            
            // Get image and audio files
            const q1ImageFile = document.getElementById('quiz_q1Image').files[0];
            const q1AudioFile = document.getElementById('quiz_q1Audio').files[0];
            const q2ImageFile = document.getElementById('quiz_q2Image').files[0];
            const q2AudioFile = document.getElementById('quiz_q2Audio').files[0];
            
            const data = {
                q1: {
                    text: q1Text, 
                    options: {A:q1OptA, B:q1OptB, C:q1OptC, D:q1OptD}, 
                    correct: q1Correct
                },
                q2: {
                    text: q2Text, 
                    options: {A:q2OptA, B:q2OptB, C:q2OptC, D:q2OptD}, 
                    correct: q2Correct
                },
                createdAt: new Date().toISOString(),
                createdBy: 'Super Admin',
                quizDate: selectedDate
            };
            
            try {
                // Check if editing existing quiz (to preserve media if not replaced)
                const existingSnap = await db.ref(`quizQuestions/${selectedDate}`).once('value');
                const existingData = existingSnap.val();
                
                // Check if we're in edit mode with deletion tracking
                const editData = window.editingQuizData || {};
                
                // Convert images and audio to Cloudinary URLs if present, otherwise preserve existing (unless marked for deletion)
                if (q1ImageFile) {
                    data.q1.image = await quizUploadToCloudinary(q1ImageFile, 'q1_image');
                } else if (existingData && existingData.q1 && existingData.q1.image && !editData.deleteQ1Image) {
                    data.q1.image = existingData.q1.image; // Preserve existing image
                }
                // If deleteQ1Image is true, we simply don't add the image property
                
                if (q1AudioFile) {
                    data.q1.audio = await quizUploadToCloudinary(q1AudioFile, 'q1_audio');
                } else if (existingData && existingData.q1 && existingData.q1.audio && !editData.deleteQ1Audio) {
                    data.q1.audio = existingData.q1.audio; // Preserve existing audio
                }
                
                if (q2ImageFile) {
                    data.q2.image = await quizUploadToCloudinary(q2ImageFile, 'q2_image');
                } else if (existingData && existingData.q2 && existingData.q2.image && !editData.deleteQ2Image) {
                    data.q2.image = existingData.q2.image; // Preserve existing image
                }
                
                if (q2AudioFile) {
                    data.q2.audio = await quizUploadToCloudinary(q2AudioFile, 'q2_audio');
                } else if (existingData && existingData.q2 && existingData.q2.audio && !editData.deleteQ2Audio) {
                    data.q2.audio = existingData.q2.audio; // Preserve existing audio
                }
                
                // Clear editing data after save
                window.editingQuizData = null;
                
                console.log('Attempting to save to Firebase...', data);
                await db.ref(`quizQuestions/${selectedDate}`).set(data);
                
                // SUCCESS POPUP!
                alert(`âœ… Questions Saved Successfully for ${selectedDate}!\n\nThe quiz will be automatically available to students on this date.\n\nQuestions preview will be shown below.`);
                
                showQuizMsg('quizAdminMessage', `âœ… Questions saved successfully for ${selectedDate} with media! Preview shown below.`, 'success');
                
                // Automatically show the questions preview
                displaySavedQuestionsPreview(data);
                
                // Clear form
                ['quiz_q1Text','quiz_q1OptA','quiz_q1OptB','quiz_q1OptC','quiz_q1OptD','quiz_q1Correct','quiz_q2Text','quiz_q2OptA','quiz_q2OptB','quiz_q2OptC','quiz_q2OptD','quiz_q2Correct'].forEach(id => {
                    const el = document.getElementById(id);
                    if (el) el.value = '';
                });
                ['quiz_q1Image','quiz_q1Audio','quiz_q2Image','quiz_q2Audio'].forEach(id => {
                    const el = document.getElementById(id);
                    if (el) el.value = '';
                });
                ['quiz_q1ImagePreview','quiz_q1AudioPreview','quiz_q2ImagePreview','quiz_q2AudioPreview'].forEach(id => {
                    const el = document.getElementById(id);
                    if (el) el.innerHTML = '';
                });
                
                await loadQuizManagementStats();
                console.log('Questions saved successfully for date:', selectedDate);
            } catch (err) {
                console.error('Save error:', err);
                alert('âŒ Error saving questions: ' + err.message);
                showQuizMsg('quizAdminMessage', 'Error saving questions: ' + err.message, 'error');
            }
        }
        
        function displaySavedQuestionsPreview(data) {
            const view = document.getElementById('todayQuestionsViewAdmin');
            
            const createdDate = new Date(data.createdAt);
            const dateStr = createdDate.toLocaleDateString('en-IN', { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
            const timeStr = createdDate.toLocaleTimeString('en-IN', { 
                hour: '2-digit', 
                minute: '2-digit',
                second: '2-digit'
            });
            
            let html = '<div style="background:#f8f9fa;padding:25px;border-radius:10px;margin-top:20px;border:3px solid #28a745">';
            html += '<h3 style="color:#28a745;margin-bottom:10px;text-align:center">âœ… Questions Saved Successfully - Preview</h3>';
            html += `<p style="text-align:center;color:#666;font-size:0.95em;margin-bottom:20px">ðŸ“… ${dateStr} | â° ${timeStr}</p>`;
            
            // Question 1
            html += '<div style="background:white;padding:20px;border-radius:8px;margin-bottom:20px;border-left:5px solid #667eea">';
            html += '<h4 style="color:#667eea;margin-bottom:15px">ðŸ“ Question 1</h4>';
            
            // Show image if present
            if (data.q1.image) {
                html += '<div style="text-align:center;margin:15px 0"><img src="' + data.q1.image + '" style="max-width:100%;max-height:250px;border-radius:8px;box-shadow:0 4px 12px rgba(0,0,0,0.15)"></div>';
            }
            
            // Show audio if present
            if (data.q1.audio) {
                html += '<div style="margin:15px 0;background:#e8f5e9;padding:15px;border-radius:8px"><p style="margin:0 0 8px 0;font-weight:600;color:#2e7d32">ðŸŽµ Audio Question</p><audio controls style="width:100%;max-width:400px"><source src="' + data.q1.audio + '"></audio></div>';
            }
            
            html += `<p style="font-size:1.1em;font-weight:600;margin-bottom:15px">${data.q1.text}</p>`;
            html += `<p style="margin-left:20px;padding:8px;background:${data.q1.correct === 'A' ? '#d4edda' : '#f8f9fa'};border-radius:4px">A) ${data.q1.options.A} ${data.q1.correct === 'A' ? 'âœ…' : ''}</p>`;
            html += `<p style="margin-left:20px;padding:8px;background:${data.q1.correct === 'B' ? '#d4edda' : '#f8f9fa'};border-radius:4px">B) ${data.q1.options.B} ${data.q1.correct === 'B' ? 'âœ…' : ''}</p>`;
            html += `<p style="margin-left:20px;padding:8px;background:${data.q1.correct === 'C' ? '#d4edda' : '#f8f9fa'};border-radius:4px">C) ${data.q1.options.C} ${data.q1.correct === 'C' ? 'âœ…' : ''}</p>`;
            html += `<p style="margin-left:20px;padding:8px;background:${data.q1.correct === 'D' ? '#d4edda' : '#f8f9fa'};border-radius:4px">D) ${data.q1.options.D} ${data.q1.correct === 'D' ? 'âœ…' : ''}</p>`;
            html += `<p style="color:#28a745;font-weight:bold;margin-top:15px;font-size:1.1em">âœ“ Correct Answer: ${data.q1.correct}</p>`;
            html += '</div>';
            
            // Question 2
            html += '<div style="background:white;padding:20px;border-radius:8px;border-left:5px solid #667eea">';
            html += '<h4 style="color:#667eea;margin-bottom:15px">ðŸ“ Question 2</h4>';
            
            // Show image if present
            if (data.q2.image) {
                html += '<div style="text-align:center;margin:15px 0"><img src="' + data.q2.image + '" style="max-width:100%;max-height:250px;border-radius:8px;box-shadow:0 4px 12px rgba(0,0,0,0.15)"></div>';
            }
            
            // Show audio if present
            if (data.q2.audio) {
                html += '<div style="margin:15px 0;background:#e8f5e9;padding:15px;border-radius:8px"><p style="margin:0 0 8px 0;font-weight:600;color:#2e7d32">ðŸŽµ Audio Question</p><audio controls style="width:100%;max-width:400px"><source src="' + data.q2.audio + '"></audio></div>';
            }
            
            html += `<p style="font-size:1.1em;font-weight:600;margin-bottom:15px">${data.q2.text}</p>`;
            html += `<p style="margin-left:20px;padding:8px;background:${data.q2.correct === 'A' ? '#d4edda' : '#f8f9fa'};border-radius:4px">A) ${data.q2.options.A} ${data.q2.correct === 'A' ? 'âœ…' : ''}</p>`;
            html += `<p style="margin-left:20px;padding:8px;background:${data.q2.correct === 'B' ? '#d4edda' : '#f8f9fa'};border-radius:4px">B) ${data.q2.options.B} ${data.q2.correct === 'B' ? 'âœ…' : ''}</p>`;
            html += `<p style="margin-left:20px;padding:8px;background:${data.q2.correct === 'C' ? '#d4edda' : '#f8f9fa'};border-radius:4px">C) ${data.q2.options.C} ${data.q2.correct === 'C' ? 'âœ…' : ''}</p>`;
            html += `<p style="margin-left:20px;padding:8px;background:${data.q2.correct === 'D' ? '#d4edda' : '#f8f9fa'};border-radius:4px">D) ${data.q2.options.D} ${data.q2.correct === 'D' ? 'âœ…' : ''}</p>`;
            html += `<p style="color:#28a745;font-weight:bold;margin-top:15px;font-size:1.1em">âœ“ Correct Answer: ${data.q2.correct}</p>`;
            html += '</div>';
            
            html += `<p style="text-align:center;margin-top:20px;color:#666"><small>Created by: ${data.createdBy || 'Super Admin'}</small></p>`;
            html += '</div>';
            
            view.innerHTML = html;
            view.style.display = 'block';
            
            // Removed scroll - no automatic scrolling to preview
        }
        
        async function viewTodayQuestionsAdmin() {
            const today = getQuizToday();
            try {
                const snap = await db.ref(`quizQuestions/${today}`).once('value');
                const q = snap.val();
                const view = document.getElementById('todayQuestionsViewAdmin');
                
                if (!q) {
                    view.innerHTML = '<div style="background:#fff3cd;padding:15px;border-radius:8px"><p style="margin:0;color:#856404">No questions for today yet.</p></div>';
                    view.style.display = 'block';
                    return;
                }
                
                const createdDate = new Date(q.createdAt);
                const dateStr = createdDate.toLocaleDateString('en-IN', { 
                    weekday: 'long', 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric' 
                });
                const timeStr = createdDate.toLocaleTimeString('en-IN', { 
                    hour: '2-digit', 
                    minute: '2-digit',
                    second: '2-digit'
                });
                
                let html = '<div style="background:#f8f9fa;padding:20px;border-radius:10px">';
                html += '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:15px">';
                html += '<h4 style="color:#667eea;margin:0">Today\'s Questions</h4>';
                html += '<button class="btn btn-small" onclick="editTodayQuestions()" style="background:#ff9800;color:white">âœï¸ Edit Questions</button>';
                html += '</div>';
                html += `<p style="color:#666;font-size:0.95em;margin-bottom:15px">ðŸ“… ${dateStr} | â° ${timeStr}</p>`;
                html += `<p><strong>Q1:</strong> ${q.q1.text}</p>`;
                html += `<p style="margin-left:20px">A) ${q.q1.options.A}</p>`;
                html += `<p style="margin-left:20px">B) ${q.q1.options.B}</p>`;
                html += `<p style="margin-left:20px">C) ${q.q1.options.C}</p>`;
                html += `<p style="margin-left:20px">D) ${q.q1.options.D}</p>`;
                html += `<p style="color:green;font-weight:bold;margin-left:20px">âœ“ Correct: ${q.q1.correct}</p><br>`;
                html += `<p><strong>Q2:</strong> ${q.q2.text}</p>`;
                html += `<p style="margin-left:20px">A) ${q.q2.options.A}</p>`;
                html += `<p style="margin-left:20px">B) ${q.q2.options.B}</p>`;
                html += `<p style="margin-left:20px">C) ${q.q2.options.C}</p>`;
                html += `<p style="margin-left:20px">D) ${q.q2.options.D}</p>`;
                html += `<p style="color:green;font-weight:bold;margin-left:20px">âœ“ Correct: ${q.q2.correct}</p>`;
                html += `<p style="text-align:center;margin-top:15px;color:#666"><small>Created by: ${q.createdBy || 'Super Admin'}</small></p>`;
                html += '</div>';
                
                view.innerHTML = html;
                view.style.display = 'block';
                
                // Check and show publish status
                await checkPublishStatusForAdmin();
            } catch (err) {
                console.error('View error:', err);
            }
        }
        
        async function editTodayQuestions() {
            const today = getQuizToday();
            try {
                const snap = await db.ref(`quizQuestions/${today}`).once('value');
                const q = snap.val();
                
                if (!q) {
                    alert('No questions found to edit!');
                    return;
                }
                
                // Populate the form with existing data
                document.getElementById('quiz_q1Text').value = q.q1.text;
                document.getElementById('quiz_q1OptA').value = q.q1.options.A;
                document.getElementById('quiz_q1OptB').value = q.q1.options.B;
                document.getElementById('quiz_q1OptC').value = q.q1.options.C;
                document.getElementById('quiz_q1OptD').value = q.q1.options.D;
                document.getElementById('quiz_q1Correct').value = q.q1.correct;
                
                document.getElementById('quiz_q2Text').value = q.q2.text;
                document.getElementById('quiz_q2OptA').value = q.q2.options.A;
                document.getElementById('quiz_q2OptB').value = q.q2.options.B;
                document.getElementById('quiz_q2OptC').value = q.q2.options.C;
                document.getElementById('quiz_q2OptD').value = q.q2.options.D;
                document.getElementById('quiz_q2Correct').value = q.q2.correct;
                
                // Scroll to quiz editor
                const qHeading2 = document.getElementById('quizQuestionsHeading');
                if (qHeading2) qHeading2.scrollIntoView({ behavior: 'smooth', block: 'start' });
                
                // Show message
                showQuizMsg('quizAdminMessage', 'âœï¸ Questions loaded for editing. Make changes and click Save.', 'success');
                
            } catch (err) {
                console.error('Edit error:', err);
                alert('Error loading questions for editing: ' + err.message);
            }
        }
        
        async function loadQuizStudentsAdmin() {
            try {
                const snap = await db.ref('quizStudents').once('value');
                window._qsAdminAllStudents = [];
                const tbody = document.getElementById('quizStudentsTableAdmin');
                tbody.innerHTML = '';
                if (!snap.exists()) {
                    tbody.innerHTML = '<tr><td colspan="7" style="text-align:center">No students registered yet.</td></tr>';
                    const ce = document.getElementById('qsAdminCount'); if(ce) ce.textContent='';
                    return;
                }
                const classSet = new Set();
                snap.forEach(child => {
                    const s = child.val();
                    window._qsAdminAllStudents.push(s);
                    if (s.class) classSet.add(s.class);
                });
                const classSel = document.getElementById('qsAdminClassFilter');
                if (classSel) {
                    const prev = classSel.value;
                    classSel.innerHTML = '<option value="">â€” All Classes â€”</option>';
                    [...classSet].sort().forEach(c => {
                        const o = document.createElement('option');
                        o.value = c; o.textContent = c;
                        if (c === prev) o.selected = true;
                        classSel.appendChild(o);
                    });
                }
                qsAdminApplyFilters();
            } catch (err) {
                console.error('Load students error:', err);
            }
        }

        function qsAdminApplyFilters() {
            const all    = window._qsAdminAllStudents || [];
            const search = (document.getElementById('qsAdminSearch')||{value:''}).value.toLowerCase().trim();
            const cls    = (document.getElementById('qsAdminClassFilter')||{value:''}).value;
            const tbody  = document.getElementById('quizStudentsTableAdmin');
            const countEl= document.getElementById('qsAdminCount');
            if (!tbody) return;
            const filtered = all.filter(s => {
                if (cls && s.class !== cls) return false;
                if (search) {
                    const hay = ((s.name||'')+(s.phone||'')+(s.email||'')).toLowerCase();
                    if (!hay.includes(search)) return false;
                }
                return true;
            });
            qsAdminRenderRows(filtered, tbody, all.length);
            if (countEl) countEl.textContent = filtered.length + ' of ' + all.length + ' students';
        }

        function qsAdminEmailBadge(s) {
            const st = s.emailStatus || 'unknown';
            if (st === 'sent')    return '<span style="background:#e8f5e9;color:#2e7d32;padding:2px 9px;border-radius:8px;font-size:11px;font-weight:700">âœ… Sent</span>';
            if (st === 'failed')  return `<span style="background:#ffebee;color:#c62828;padding:2px 9px;border-radius:8px;font-size:11px;font-weight:700" title="${s.emailError||''}">âŒ Failed</span>`;
            if (st === 'pending') return '<span style="background:#fff3cd;color:#856404;padding:2px 9px;border-radius:8px;font-size:11px;font-weight:700">â³ Pending</span>';
            return '<span style="background:#f5f5f5;color:#757575;padding:2px 9px;border-radius:8px;font-size:11px">â€” Unknown</span>';
        }

        function qsAdminRenderRows(filtered, tbody, total) {
            tbody.innerHTML = '';
            if (!filtered.length) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;color:#999;padding:16px">No students match the filter.</td></tr>';
                return;
            }
            filtered.forEach((s,i) => {
                const row = tbody.insertRow();
                row.innerHTML = `<td>${i+1}</td>
                    <td><strong>${s.name||''}</strong></td>
                    <td style="font-size:12px">${s.email||''}</td>
                    <td>${s.phone||''}</td>
                    <td style="background:#fff3cd;font-family:monospace;font-weight:bold">${s.password||''}</td>
                    <td><span style="background:#e8f5e9;color:#2e7d32;padding:2px 8px;border-radius:8px;font-size:12px;font-weight:700">${s.class||''}</span></td>
                    <td style="font-size:12px">${s.registeredAt ? new Date(s.registeredAt).toLocaleDateString('en-IN') : 'â€”'}</td>
                    <td>${qsAdminEmailBadge(s)}</td>`;
            });
        }

        function qsAdminShowDuplicates() {
            const all    = window._qsAdminAllStudents || [];
            const tbody  = document.getElementById('quizStudentsTableAdmin');
            const countEl= document.getElementById('qsAdminCount');
            if (!tbody) return;

            // Find duplicate phones
            const phoneMap = {}, emailMap = {};
            all.forEach(s => {
                if (s.phone) { if (!phoneMap[s.phone]) phoneMap[s.phone]=[]; phoneMap[s.phone].push(s); }
                if (s.email) { const em=(s.email||'').toLowerCase(); if (!emailMap[em]) emailMap[em]=[]; emailMap[em].push(s); }
            });
            const dupPhones = Object.entries(phoneMap).filter(([,arr])=>arr.length>1);
            const dupEmails = Object.entries(emailMap).filter(([,arr])=>arr.length>1);

            tbody.innerHTML = '';
            if (!dupPhones.length && !dupEmails.length) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;padding:20px"><span style="background:#e8f5e9;color:#2e7d32;padding:8px 20px;border-radius:10px;font-weight:700">âœ… No duplicate phones or emails found!</span></td></tr>';
                if (countEl) countEl.textContent = '0 duplicates found';
                return;
            }

            let count = 0;
            const rendered = new Set();

            if (dupPhones.length) {
                const hdr = tbody.insertRow();
                hdr.innerHTML = '<td colspan="8" style="background:#fff3e0;color:#e65100;font-weight:800;padding:8px 14px;font-size:0.9em">ðŸ“ž DUPLICATE PHONE NUMBERS</td>';
                dupPhones.forEach(([phone, students]) => {
                    students.forEach((s, si) => {
                        const key = (s.email||'')+s.phone;
                        if (rendered.has(key)) return;
                        rendered.add(key);
                        const row = tbody.insertRow();
                        row.style.background = '#fff8e1';
                        row.innerHTML = `<td style="color:#e65100;font-weight:700">âš ï¸</td>
                            <td><strong>${s.name||''}</strong></td>
                            <td style="font-size:12px">${s.email||''}</td>
                            <td style="background:#ffecb3;font-weight:800;color:#e65100">${s.phone||''} <span style="font-size:10px">(${students.length} accounts)</span></td>
                            <td style="background:#fff3cd;font-family:monospace;font-weight:bold">${s.password||''}</td>
                            <td><span style="background:#e8f5e9;color:#2e7d32;padding:2px 8px;border-radius:8px;font-size:12px">${s.class||''}</span></td>
                            <td style="font-size:12px">${s.registeredAt ? new Date(s.registeredAt).toLocaleDateString('en-IN') : 'â€”'}</td>
                            <td>${qsAdminEmailBadge(s)}</td>`;
                        count++;
                    });
                });
            }

            if (dupEmails.length) {
                const hdr = tbody.insertRow();
                hdr.innerHTML = '<td colspan="8" style="background:#fce4ec;color:#880e4f;font-weight:800;padding:8px 14px;font-size:0.9em">ðŸ“§ DUPLICATE EMAIL ADDRESSES</td>';
                dupEmails.forEach(([email, students]) => {
                    students.forEach((s, si) => {
                        const key = 'em_'+(s.email||'')+s.phone;
                        if (rendered.has(key)) return;
                        rendered.add(key);
                        const row = tbody.insertRow();
                        row.style.background = '#fce4ec';
                        row.innerHTML = `<td style="color:#880e4f;font-weight:700">âš ï¸</td>
                            <td><strong>${s.name||''}</strong></td>
                            <td style="background:#f8bbd0;font-weight:800;color:#880e4f;font-size:12px">${s.email||''} <span style="font-size:10px">(${students.length} accounts)</span></td>
                            <td>${s.phone||''}</td>
                            <td style="background:#fff3cd;font-family:monospace;font-weight:bold">${s.password||''}</td>
                            <td><span style="background:#e8f5e9;color:#2e7d32;padding:2px 8px;border-radius:8px;font-size:12px">${s.class||''}</span></td>
                            <td style="font-size:12px">${s.registeredAt ? new Date(s.registeredAt).toLocaleDateString('en-IN') : 'â€”'}</td>
                            <td>${qsAdminEmailBadge(s)}</td>`;
                        count++;
                    });
                });
            }

            if (countEl) countEl.textContent = `âš ï¸ ${dupPhones.length} dup phone group(s), ${dupEmails.length} dup email group(s)`;
        }

        function qsAdminShowEmailFailed() {
            const all    = window._qsAdminAllStudents || [];
            const tbody  = document.getElementById('quizStudentsTableAdmin');
            const countEl= document.getElementById('qsAdminCount');
            if (!tbody) return;

            const failed = all.filter(s => s.emailStatus === 'failed' || (!s.emailStatus && s.registeredAt));
            const unknown = all.filter(s => !s.emailStatus);

            tbody.innerHTML = '';

            if (failed.length || unknown.length) {
                if (failed.length) {
                    const hdr = tbody.insertRow();
                    hdr.innerHTML = '<td colspan="8" style="background:#ffebee;color:#c62828;font-weight:800;padding:8px 14px;font-size:0.9em">âŒ EMAIL DELIVERY FAILED</td>';
                    failed.forEach((s,i) => {
                        const row = tbody.insertRow();
                        row.style.background = '#fff5f5';
                        row.innerHTML = `<td>${i+1}</td>
                            <td><strong>${s.name||''}</strong></td>
                            <td style="background:#ffebee;font-size:12px">${s.email||''}</td>
                            <td>${s.phone||''}</td>
                            <td style="background:#fff3cd;font-family:monospace;font-weight:bold">${s.password||''}</td>
                            <td><span style="background:#e8f5e9;color:#2e7d32;padding:2px 8px;border-radius:8px;font-size:12px">${s.class||''}</span></td>
                            <td style="font-size:12px">${s.registeredAt ? new Date(s.registeredAt).toLocaleDateString('en-IN') : 'â€”'}</td>
                            <td><span style="background:#ffebee;color:#c62828;padding:2px 9px;border-radius:8px;font-size:11px;font-weight:700" title="${s.emailError||''}">âŒ Failed${s.emailError?'<br><span style=font-size:10px>'+s.emailError+'</span>':''}</span></td>`;
                    });
                }
                if (unknown.length) {
                    const hdr2 = tbody.insertRow();
                    hdr2.innerHTML = '<td colspan="8" style="background:#e3f2fd;color:#1565c0;font-weight:800;padding:8px 14px;font-size:0.9em">âš ï¸ EMAIL STATUS UNKNOWN (registered before tracking was added)</td>';
                    unknown.forEach((s,i) => {
                        const row = tbody.insertRow();
                        row.innerHTML = `<td>${i+1}</td>
                            <td><strong>${s.name||''}</strong></td>
                            <td style="font-size:12px">${s.email||''}</td>
                            <td>${s.phone||''}</td>
                            <td style="background:#fff3cd;font-family:monospace;font-weight:bold">${s.password||''}</td>
                            <td><span style="background:#e8f5e9;color:#2e7d32;padding:2px 8px;border-radius:8px;font-size:12px">${s.class||''}</span></td>
                            <td style="font-size:12px">${s.registeredAt ? new Date(s.registeredAt).toLocaleDateString('en-IN') : 'â€”'}</td>
                            <td><span style="background:#e3f2fd;color:#1565c0;padding:2px 9px;border-radius:8px;font-size:11px">âš ï¸ Unknown</span></td>`;
                    });
                }
            } else {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;padding:20px"><span style="background:#e8f5e9;color:#2e7d32;padding:8px 20px;border-radius:10px;font-weight:700">âœ… All emails delivered successfully!</span></td></tr>';
            }

            if (countEl) countEl.textContent = `${failed.length} failed Â· ${unknown.length} unknown`;
        }

        function qsAdminResetFilters() {
            const si = document.getElementById('qsAdminSearch');
            const ci = document.getElementById('qsAdminClassFilter');
            if (si) si.value = '';
            if (ci) ci.value = '';
            qsAdminApplyFilters();
        }

        async function qsAdminShowSummary() {
            const box        = document.getElementById('qsAdminSummaryBox');
            const contentEl  = document.getElementById('qsAdminSummaryContent');
            const msgBox     = document.getElementById('qsAdminMsgBox');
            if (!box) return;
            box.style.display = 'block';
            contentEl.innerHTML = '<p style="color:#999;text-align:center;padding:12px">&#9203; Loading class strengths&hellip;</p>';
            if (msgBox) msgBox.style.display = 'none';

            try {
                const ss = await db.ref('leaderboardConfig/classStrengths').once('value');
                window._classStrengths = ss.val() || {};
            } catch(e) { window._classStrengths = window._classStrengths || {}; }

            const all       = window._qsAdminAllStudents || [];
            const strengths = window._classStrengths || {};

            function normKey(s) {
                return String(s||'').toLowerCase().replace(/\./g,'_').replace(/\s+/g,' ').trim();
            }
            function getStrength(cls) {
                // Firebase sanitises '.' â†’ '_' in keys, so check both forms
                const sk = cls.replace(/[.\[\]#$\/]/g,'_');
                const nk = normKey(cls);
                return strengths[cls] || strengths[sk] ||
                    ((Object.entries(strengths).find(([k]) => normKey(k)===nk))||[])[1] || 0;
            }

            const regMap = {};
            all.forEach(s => {
                const cls = (s.class||'Unknown').trim();
                if (!regMap[cls]) regMap[cls] = [];
                regMap[cls].push(s);
            });

            // Also show classes that have strength set but 0 registrations
            Object.keys(strengths).forEach(k => {
                const match = Object.keys(regMap).find(c => normKey(c)===normKey(k));
                if (!match && strengths[k] > 0) regMap[k] = regMap[k] || [];
            });

            const sortedClasses = Object.keys(regMap).filter(c=>c!=='Unknown').sort();
            if (regMap['Unknown'] && regMap['Unknown'].length) sortedClasses.push('Unknown');

            let totalReg=0, totalStrength=0, totalMissing=0;
            const classLines = [];

            let tableHTML = `<div style="overflow-x:auto"><table style="width:100%;border-collapse:collapse;font-size:13px">
            <thead><tr style="background:#6a1b9a;color:white">
                <th style="padding:10px 14px;text-align:left">Class</th>
                <th style="padding:10px 14px;text-align:center">Strength</th>
                <th style="padding:10px 14px;text-align:center">Registered</th>
                <th style="padding:10px 14px;text-align:center">Missing</th>
                <th style="padding:10px 14px;text-align:center">Coverage</th>
                <th style="padding:10px 14px;text-align:center">Progress</th>
            </tr></thead><tbody>`;

            sortedClasses.forEach((cls, i) => {
                const students = regMap[cls] || [];
                const reg      = students.length;
                const strength = getStrength(cls);
                const missing  = strength ? Math.max(0, strength - reg) : null;
                const pct      = strength ? Math.round((reg/strength)*100) : null;
                const extra    = strength && reg > strength ? reg - strength : 0;
                totalReg += reg;
                if (strength) { totalStrength += strength; totalMissing += (missing||0); }

                const pctColor  = pct===null?'#9e9e9e':pct>=80?'#2e7d32':pct>=50?'#e65100':'#c62828';
                const barColor  = pct===null?'#bdbdbd':pct>=80?'#4caf50':pct>=50?'#ff9800':'#f44336';
                const rowBg     = i%2===0?'#fafafa':'white';
                const barFill   = pct!=null ? Math.min(100,pct) : 0;
                const barHTML   = `<div style="background:#e0e0e0;border-radius:6px;height:10px;width:90px;display:inline-block;vertical-align:middle"><div style="background:${barColor};height:10px;border-radius:6px;width:${barFill}%"></div></div>`;

                tableHTML += `<tr style="background:${rowBg}">
                    <td style="padding:9px 14px;font-weight:600;color:#3d0060">${cls}</td>
                    <td style="padding:9px 14px;text-align:center;color:#555">${strength||'&mdash;'}</td>
                    <td style="padding:9px 14px;text-align:center">
                        <span style="background:#e8f5e9;color:#2e7d32;padding:3px 10px;border-radius:10px;font-weight:700">${reg}</span>
                        ${extra>0?`<span style="font-size:11px;color:#1565c0;margin-left:4px">+${extra} extra</span>`:''}
                    </td>
                    <td style="padding:9px 14px;text-align:center">
                        ${missing!=null?`<span style="background:${missing>0?'#fff3cd':'#e8f5e9'};color:${missing>0?'#856404':'#2e7d32'};padding:3px 10px;border-radius:10px;font-weight:700">${missing}</span>`:'&mdash;'}
                    </td>
                    <td style="padding:9px 14px;text-align:center;font-weight:800;color:${pctColor}">
                        ${pct!=null?pct+'%':'&mdash;'}
                    </td>
                    <td style="padding:9px 14px;text-align:center">${barHTML}</td>
                </tr>`;

                const coverageStr = pct!=null ? ` (${pct}% of ${strength})` : '';
                const missingStr  = missing>0 ? `, ${missing} yet to register` : (missing===0?' \u2705 full coverage':'');
                classLines.push(`\u2022 ${cls}: ${reg} registered${coverageStr}${missingStr}`);
            });

            const totalPct = totalStrength ? Math.round((totalReg/totalStrength)*100) : null;
            tableHTML += `<tr style="background:#f3e5f5;font-weight:800">
                <td style="padding:10px 14px;color:#6a1b9a">TOTAL</td>
                <td style="padding:10px 14px;text-align:center;color:#6a1b9a">${totalStrength||'&mdash;'}</td>
                <td style="padding:10px 14px;text-align:center"><span style="background:#6a1b9a;color:white;padding:3px 10px;border-radius:10px;font-weight:700">${totalReg}</span></td>
                <td style="padding:10px 14px;text-align:center"><span style="background:#fff3cd;color:#856404;padding:3px 10px;border-radius:10px;font-weight:700">${totalMissing}</span></td>
                <td style="padding:10px 14px;text-align:center;color:#6a1b9a;font-size:1.1em">${totalPct!=null?totalPct+'%':'&mdash;'}</td>
                <td style="padding:10px 14px;text-align:center">
                    <div style="background:#e0e0e0;border-radius:6px;height:10px;width:90px;display:inline-block;vertical-align:middle">
                        <div style="background:#6a1b9a;height:10px;border-radius:6px;width:${Math.min(100,totalPct||0)}%"></div>
                    </div>
                </td>
            </tr></tbody></table></div>`;

            contentEl.innerHTML = tableHTML;

            // Build copyable WhatsApp message
            const now      = new Date();
            const dateStr  = now.toLocaleDateString('en-IN',{weekday:'long',day:'numeric',month:'long',year:'numeric'});
            const timeStr  = now.toLocaleTimeString('en-IN',{hour:'2-digit',minute:'2-digit',hour12:true});
            const coverLine = totalPct!=null
                ? `Overall coverage: ${totalReg}/${totalStrength} students (${totalPct}%)`
                : `Total registered: ${totalReg} students`;
            const alertLine = totalMissing>0
                ? `\u26a0\ufe0f ${totalMissing} student(s) still not registered`
                : `\u2705 All tracked classes have full registration!`;

            const msgText = [
                `\ud83d\udcca *Quiz Registration Summary*`,
                `\ud83d\udcc5 ${dateStr}  \ud83d\udd50 ${timeStr}`,
                ``,
                coverLine,
                alertLine,
                ``,
                `*Class-wise Breakdown:*`,
                ...classLines,
                ``,
                `_Please remind unregistered students to sign up._`
            ].join('\n');

            const msgTextEl = document.getElementById('qsAdminMsgText');
            if (msgTextEl) msgTextEl.value = msgText;
            if (msgBox) msgBox.style.display = 'block';
            box.scrollIntoView({behavior:'smooth', block:'nearest'});
        }

        function qsAdminCopyMsg() {
            const el = document.getElementById('qsAdminMsgText');
            if (!el) return;
            const btn = event.currentTarget || event.target;
            const origText = btn.textContent;
            const origBg   = btn.style.background;
            navigator.clipboard.writeText(el.value).then(() => {
                btn.textContent = '\u2705 Copied!';
                btn.style.background = '#4caf50';
                setTimeout(() => { btn.textContent = origText; btn.style.background = origBg; }, 2200);
            }).catch(() => {
                el.select();
                document.execCommand('copy');
                btn.textContent = '\u2705 Copied!';
                setTimeout(() => { btn.textContent = origText; }, 2000);
            });
        }

        
        async function loadQuizSubmissionsAdmin() {
            const today = getQuizToday();
            try {
                const snap = await db.ref(`quizSubmissions/${today}`).once('value');
                const tbody = document.getElementById('quizSubmissionsTableAdmin');
                tbody.innerHTML = '';

                // Populate class filter dropdown
                const classSet = new Set();
                const allRows = [];
                if (snap.exists()) {
                    snap.forEach(child => {
                        const s = child.val();
                        allRows.push(s);
                        if (s.studentClass) classSet.add(s.studentClass);
                    });
                }
                const classFilter = document.getElementById('qsClassFilter');
                if (classFilter) {
                    const prev = classFilter.value;
                    classFilter.innerHTML = '<option value="">All Classes</option>';
                    [...classSet].sort().forEach(c => {
                        const o = document.createElement('option');
                        o.value = c; o.textContent = c;
                        if (c === prev) o.selected = true;
                        classFilter.appendChild(o);
                    });
                }

                // Store rows globally for client-side filter
                window._qsAllRows = allRows;
                filterSubmissionsTable();

                // Populate date dropdown and auto-load stats for today
                await populateQsDateFilter();
                const dateSel = document.getElementById('qsDateFilter');
                if (dateSel && !dateSel.value) {
                    dateSel.value = today;
                }
                loadClassStats();

            } catch (err) {
                console.error('Load submissions error:', err);
            }
        }

        function filterSubmissionsTable() {
            const tbody = document.getElementById('quizSubmissionsTableAdmin');
            if (!tbody) return;
            const rows = window._qsAllRows || [];
            const classF = (document.getElementById('qsClassFilter') || {}).value || '';
            const scoreF = (document.getElementById('qsScoreFilter') || {}).value;
            tbody.innerHTML = '';

            if (rows.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;color:#999">No submissions yet today.</td></tr>';
                return;
            }
            let idx = 1;
            rows.filter(s => {
                if (classF && s.studentClass !== classF) return false;
                if (scoreF !== '' && scoreF !== undefined && String(s.score) !== scoreF) return false;
                return true;
            }).forEach(s => {
                const row = tbody.insertRow();
                const mins = Math.floor(s.timeTaken / 60);
                const secs = s.timeTaken % 60;
                const scoreBg = s.score === 2 ? '#d4edda' : s.score === 1 ? '#fff3cd' : '#f8d7da';
                const scoreCol = s.score === 2 ? '#155724' : s.score === 1 ? '#856404' : '#721c24';
                row.innerHTML = `<td>${idx++}</td><td>${s.studentName||''}</td><td>${s.studentEmail||''}</td>
                    <td><span style="background:#f3e5ff;color:#4a148c;padding:2px 8px;border-radius:10px;font-size:12px">${s.studentClass||''}</span></td>
                    <td style="font-size:12px">${new Date(s.submittedAt).toLocaleString('en-IN')}</td>
                    <td><span style="background:${scoreBg};color:${scoreCol};padding:3px 10px;border-radius:10px;font-weight:700">${s.score}/2</span></td>
                    <td style="font-size:12px">${mins}m ${secs}s</td>`;
            });
            if (idx === 1) tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;color:#999">No matching submissions.</td></tr>';
        }

        async function populateQsDateFilter() {
            try {
                // Read from BOTH quizQuestions AND quizSubmissions so all dates appear
                const [questSnap, subSnap] = await Promise.all([
                    db.ref('quizQuestions').once('value'),
                    db.ref('quizSubmissions').once('value')
                ]);
                const today = getQuizToday();
                const datesSet = new Set();
                if (questSnap.exists()) questSnap.forEach(d => datesSet.add(d.key));
                // Use Object.keys on the raw value to get ALL child keys from quizSubmissions
                if (subSnap.exists()) {
                    const subVal = subSnap.val();
                    if (subVal && typeof subVal === 'object') {
                        Object.keys(subVal).forEach(k => datesSet.add(k));
                    }
                }
                const dates = Array.from(datesSet);
                // Always include today even if no questions/submissions yet
                if (!dates.includes(today)) dates.push(today);
                dates.sort((a,b) => b.localeCompare(a));
                console.log('[populateQsDateFilter] dates found:', dates);

                function fillSelect(sel) {
                    if (!sel) return;
                    const cur = sel.value;
                    sel.innerHTML = '<option value="">â€” Select Date â€”</option>';
                    dates.forEach(d => {
                        const o = document.createElement('option');
                        o.value = d;
                        const label = new Date(d + 'T00:00:00').toLocaleDateString('en-IN',{weekday:'short',day:'numeric',month:'short',year:'numeric'});
                        o.textContent = d === today ? label + ' (Today)' : label;
                        if (d === cur || (!cur && d === today)) o.selected = true;
                        sel.appendChild(o);
                    });
                }

                // Populate admin submissions date filter (may not exist if CR logged in)
                fillSelect(document.getElementById('qsDateFilter'));
                // Populate CR date filter (may not exist if admin logged in)
                fillSelect(document.getElementById('crQsDateFilter'));

            } catch(e) { console.warn('populateQsDateFilter error:', e); }
        }

        async function loadClassStats() {
            const sel  = document.getElementById('qsDateFilter');
            const date = sel ? sel.value : getQuizToday();
            const container = document.getElementById('qsClassBreakdown');
            const infoBox   = document.getElementById('qsInfoBox');
            const pillTotal  = document.getElementById('qsPillTotal');
            const pillCorrect= document.getElementById('qsPillCorrect');
            const pillClass  = document.getElementById('qsPillClasses');
            if (!date) {
                if (container) container.innerHTML = '<p style="color:#999;font-size:13px;text-align:center;padding:12px">Select a date above</p>';
                return;
            }
            if (container) container.innerHTML = '<p style="color:#aaa;font-size:13px;text-align:center;padding:12px">â³ Loadingâ€¦</p>';
            try {
                const snap = await db.ref(`quizSubmissions/${date}`).once('value');
                const dateStr = new Date(date + 'T00:00:00').toLocaleDateString('en-IN',{weekday:'long',day:'numeric',month:'long',year:'numeric'});

                if (!snap.exists()) {
                    if (container) container.innerHTML = `<p style="color:#999;font-size:13px;text-align:center;padding:12px">No submissions found for ${dateStr}</p>`;
                    if (pillTotal) pillTotal.textContent = 'Total: 0';
                    if (pillCorrect) pillCorrect.textContent = 'Both Correct: 0';
                    if (pillClass) pillClass.textContent = 'Classes: 0';
                    if (infoBox) infoBox.style.display = 'none';
                    return;
                }

                // Aggregate by class
                const classMap = {}; // class â†’ {total, correct, partial, none, students[]}
                let grandTotal = 0, grandCorrect = 0;
                snap.forEach(child => {
                    const s = child.val();
                    const cls = s.studentClass || 'Unknown';
                    if (!classMap[cls]) classMap[cls] = {total:0, correct:0, partial:0, none:0};
                    classMap[cls].total++;
                    grandTotal++;
                    if (s.score === 2) { classMap[cls].correct++; grandCorrect++; }
                    else if (s.score === 1) classMap[cls].partial++;
                    else classMap[cls].none++;
                });

                const classCount = Object.keys(classMap).length;
                if (pillTotal)   pillTotal.textContent   = `Total: ${grandTotal}`;
                if (pillCorrect) pillCorrect.textContent = `Both Correct: ${grandCorrect}`;
                if (pillClass)   pillClass.textContent   = `Classes: ${classCount}`;

                // Build class breakdown table
                const sorted = Object.entries(classMap).sort((a,b) => b[1].total - a[1].total);
                let html = `<div class="table-wrapper" style="margin:0"><table style="font-size:13px">
                    <thead><tr>
                        <th style="background:#3d0060;color:#ffd700">Class</th>
                        <th style="background:#3d0060;color:white">Participated</th>
                        <th style="background:#3d0060;color:#a5d6a7">Both Correct âœ…</th>
                        <th style="background:#3d0060;color:#fff3cd">Partial (1/2) âš ï¸</th>
                        <th style="background:#3d0060;color:#f5c6cb">None (0/2) âŒ</th>
                        <th style="background:#3d0060;color:#80deea">Accuracy</th>
                    </tr></thead><tbody>`;
                sorted.forEach(([cls, d]) => {
                    const acc = d.total > 0 ? Math.round((d.correct/d.total)*100) : 0;
                    const barColor = acc >= 70 ? '#28a745' : acc >= 40 ? '#ffc107' : '#dc3545';
                    html += `<tr>
                        <td><strong>${cls}</strong></td>
                        <td style="text-align:center;font-weight:700">${d.total}</td>
                        <td style="text-align:center;color:#155724;font-weight:600">${d.correct}</td>
                        <td style="text-align:center;color:#856404">${d.partial}</td>
                        <td style="text-align:center;color:#721c24">${d.none}</td>
                        <td style="min-width:90px">
                            <div style="display:flex;align-items:center;gap:6px">
                                <div style="flex:1;background:#eee;border-radius:4px;height:8px;overflow:hidden">
                                    <div style="width:${acc}%;background:${barColor};height:100%;border-radius:4px;transition:width 0.4s"></div>
                                </div>
                                <span style="font-size:11px;font-weight:700;color:${barColor};min-width:30px">${acc}%</span>
                            </div>
                        </td>
                    </tr>`;
                });
                html += '</tbody></table></div>';
                if (container) container.innerHTML = html;

                // Build info text box â€” fetch class strengths from leaderboard config
                const infoDateEl = document.getElementById('qsInfoDate');
                const infoTextEl = document.getElementById('qsInfoText');
                const _qsDisplayTime = new Date().toLocaleTimeString('en-IN',{hour:'2-digit',minute:'2-digit',hour12:true});
                if (!window._classStrengths) {
                    try { const ss = await db.ref('leaderboardConfig/classStrengths').once('value'); window._classStrengths = ss.val() || {}; } catch(e) { window._classStrengths = {}; }
                }
                const _qsStr = window._classStrengths || {};
                function _normCls(s){ return String(s).toLowerCase().replace(/[^a-z0-9]/g,''); }
                function _getStrength(map, cls){ const n=_normCls(cls); const k=Object.keys(map).find(k=>_normCls(k)===n); return k?map[k]:0; }
                if (infoDateEl) infoDateEl.textContent = dateStr;
                if (infoTextEl) {
                    let infoLines = `<span style="color:#888;font-size:12px">ðŸ• Generated at: <strong>${_qsDisplayTime}</strong></span><br><br>`;
                    infoLines += `<strong>${grandTotal}</strong> students participated across <strong>${classCount}</strong> classes.<br>`;
                    infoLines += `<strong>${grandCorrect}</strong> got both questions correct (${grandTotal>0?Math.round((grandCorrect/grandTotal)*100):0}% accuracy).<br><br>`;
                    infoLines += '<strong>Class-wise breakdown:</strong><br>';
                    sorted.forEach(([cls,d]) => {
                        const acc = d.total>0?Math.round((d.correct/d.total)*100):0;
                        const strength = _getStrength(_qsStr, cls);
                        const strengthTag = strength ? `<span style="color:#888;font-size:0.92em">(Class Strength: ${strength})</span> ` : '';
                        infoLines += `â€¢ ${cls}: ${strengthTag}<strong>${d.total}</strong> participated, <strong>${d.correct}</strong> correct (${acc}%)<br>`;
                    });
                    infoTextEl.innerHTML = infoLines;
                }
                if (infoBox) infoBox.style.display = 'block';
                // Save for copy
                const _qsNow = new Date().toLocaleTimeString('en-IN',{hour:'2-digit',minute:'2-digit',hour12:true});
                window._qsLastInfoText = `ðŸ“‹ Quiz Summary â€” ${dateStr}\nðŸ• Generated at: ${_qsNow}\n\n${grandTotal} students participated across ${classCount} classes.\n${grandCorrect} got both questions correct (${grandTotal>0?Math.round((grandCorrect/grandTotal)*100):0}% accuracy).\n\nClass-wise breakdown:\n` +
                    sorted.map(([cls,d]) => {
                        const strength = _getStrength(_qsStr, cls);
                        const strengthTxt = strength ? `[Class Strength: ${strength}] ` : '';
                        return `â€¢ ${cls}: ${strengthTxt}${d.total} participated, ${d.correct} correct (${d.total>0?Math.round((d.correct/d.total)*100):0}%)`;
                    }).join('\n') +
                    `\n\nâ€” Spurthi Youth Fest 2026`;

            } catch(e) {
                if (container) container.innerHTML = `<p style="color:red;font-size:13px;padding:12px">Error: ${e.message}</p>`;
            }
        }

        function copyQsInfo() {
            const txt = window._qsLastInfoText || '';
            if (!txt) return;
            navigator.clipboard.writeText(txt).then(()=>{
                const btn = document.querySelector('[onclick="copyQsInfo()"]');
                if (btn) { const orig=btn.textContent; btn.textContent='âœ… Copied!'; setTimeout(()=>btn.textContent=orig,2000); }
            }).catch(()=>{ /* fallback */ });
        }

        async function loadCRQuizStats() {
            const crClass  = (window.currentCRClass || '').trim() || (document.getElementById('crClassName')||{}).textContent.trim() || '';
            const dateSel  = document.getElementById('crQsDateFilter');
            // Populate dates first
            await populateQsDateFilter();
            const date = dateSel ? dateSel.value || getQuizToday() : getQuizToday();
            if (dateSel && !dateSel.value) dateSel.value = date;

            const dateStr  = new Date(date + 'T00:00:00').toLocaleDateString('en-IN',{weekday:'long',day:'numeric',month:'long',year:'numeric'});
            const infoDate = document.getElementById('crQsInfoDate');
            const infoText = document.getElementById('crQsInfoText');
            const tbody    = document.getElementById('crQsTable');
            const totEl    = document.getElementById('crQsTotal');
            const corrEl   = document.getElementById('crQsCorrect');
            const partEl   = document.getElementById('crQsPartial');
            const rateEl   = document.getElementById('crQsRate');
            if (infoDate) infoDate.textContent = dateStr;
            if (tbody) tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;color:#aaa">â³ Loadingâ€¦</td></tr>';
            if (infoText) infoText.textContent = 'â³ Loadingâ€¦';
            try {
                // Fetch class strength first â€” always re-fetch fresh for accuracy
                try { const ss = await db.ref('leaderboardConfig/classStrengths').once('value'); window._classStrengths = ss.val() || {}; } catch(e) { window._classStrengths = window._classStrengths || {}; }
                const _crSafeKey = crClass ? crClass.replace(/[.\[\]#$\/]/g,'_') : '';
                const crClassStrength = (window._classStrengths[_crSafeKey] || window._classStrengths[crClass] || 0);
                const crStrengthTag = crClassStrength ? ` <span style="color:#888;font-size:0.92em">(Class Strength: ${crClassStrength})</span>` : '';

                const snap = await db.ref(`quizSubmissions/${date}`).once('value');
                if (!snap.exists()) {
                    if (totEl) totEl.textContent = '0';
                    if (corrEl) corrEl.textContent = '0';
                    if (partEl) partEl.textContent = '0';
                    if (rateEl) rateEl.textContent = '0%';
                    if (tbody) tbody.innerHTML = `<tr><td colspan="5" style="text-align:center;color:#999">No quiz submissions on ${dateStr}</td></tr>`;
                    if (infoText) infoText.innerHTML = `<strong>No students</strong> from <strong>${crClass}</strong>${crStrengthTag} participated in the quiz on ${dateStr}.`;
                    return;
                }
                // Filter to CR's class
                const classStudents = [];
                let total=0,correct=0,partial=0;
                snap.forEach(child => {
                    const s = child.val();
                    if (!crClass || s.studentClass === crClass) {
                        classStudents.push(s);
                        total++;
                        if (s.score===2) correct++;
                        else if(s.score===1) partial++;
                    }
                });
                const rate = total>0?Math.round((correct/total)*100):0;

                // Check if results have been declared for this date (to decide whether to show scores)
                const resSnap = await db.ref(`quizResults/${date}`).once('value');
                const resultsPublished = resSnap.exists();
                // Hide only the score column until results are declared
                const hideScores = !resultsPublished;

                if (totEl)  totEl.textContent  = total;
                if (corrEl) corrEl.textContent = hideScores ? 'ðŸ”’' : correct;
                if (partEl) partEl.textContent = hideScores ? 'ðŸ”’' : partial;
                if (rateEl) rateEl.textContent = hideScores ? 'ðŸ”’' : rate+'%';

                // Info text
                if (infoText) {
                    if (total === 0) {
                        infoText.innerHTML = `<strong>No students</strong> from <strong>${crClass}</strong>${crStrengthTag} participated in the quiz on ${dateStr}.`;
                    } else if (hideScores) {
                        infoText.innerHTML = `On <strong>${dateStr}</strong>, <strong>${total}</strong> student(s) from <strong>${crClass}</strong>${crStrengthTag} submitted the quiz.<br>
                            <span style="color:#856404">ðŸ”’ Scores are hidden until the admin declares the winners.</span>`;
                    } else {
                        infoText.innerHTML = `On <strong>${dateStr}</strong>, <strong>${total}</strong> student(s) from <strong>${crClass}</strong>${crStrengthTag} participated in the online quiz.<br>
                            <strong>${correct}</strong> got both questions correct (${rate}% accuracy).<br>
                            <strong>${partial}</strong> got one correct. <strong>${total-correct-partial}</strong> got none correct.<br>
                            ${correct>=2 ? 'âœ… Your class has eligible students for winner selection.' : correct===1 ? 'âš ï¸ Only 1 correct answer â€” need 2+ for winner &amp; runner-up.' : 'âŒ No correct answers from your class today.'}`;
                    }
                }

                // Student table
                if (tbody) {
                    if (classStudents.length === 0) {
                        tbody.innerHTML = `<tr><td colspan="5" style="text-align:center;color:#999">No submissions from ${crClass} on this date.</td></tr>`;
                    } else {
                        classStudents.sort((a,b) => new Date(a.submittedAt) - new Date(b.submittedAt));
                        tbody.innerHTML = '';
                        classStudents.forEach((s,i) => {
                            const row = tbody.insertRow();
                            const mins = Math.floor(s.timeTaken/60), secs = s.timeTaken%60;
                            let scoreCell;
                            if (hideScores) {
                                scoreCell = `<span style="background:#e9ecef;color:#6c757d;padding:3px 10px;border-radius:10px;font-weight:700">ðŸ”’ Hidden</span>`;
                            } else {
                                const scoreBg = s.score===2?'#d4edda':s.score===1?'#fff3cd':'#f8d7da';
                                const scoreCol= s.score===2?'#155724':s.score===1?'#856404':'#721c24';
                                scoreCell = `<span style="background:${scoreBg};color:${scoreCol};padding:3px 10px;border-radius:10px;font-weight:700">${s.score}/2</span>`;
                            }
                            row.innerHTML = `<td>${i+1}</td>
                                <td><strong>${s.studentName||''}</strong></td>
                                <td>${scoreCell}</td>
                                <td>${mins}m ${secs}s</td>
                                <td style="font-size:12px">${new Date(s.submittedAt).toLocaleString('en-IN')}</td>`;
                        });
                    }
                }
            } catch(e) {
                if (infoText) infoText.textContent = 'Error loading data: ' + e.message;
                if (tbody) tbody.innerHTML = `<tr><td colspan="5" style="color:red;text-align:center">Error: ${e.message}</td></tr>`;
            }
        }

        async function loadCRScavengerStats() {
            const crClass = (window.currentCRClass || '').trim() || (document.getElementById('crClassName')||{}).textContent.trim() || '';
            const infoDate = document.getElementById('crShInfoDate');
            const infoText = document.getElementById('crShInfoText');
            const totalEl  = document.getElementById('crShTotal');
            const appEl    = document.getElementById('crShApproved');
            const penEl    = document.getElementById('crShPending');
            const rejEl    = document.getElementById('crShRejected');
            const tbody    = document.getElementById('crShTable');
            if (infoDate) infoDate.textContent = new Date().toLocaleDateString('en-IN',{weekday:'long',day:'numeric',month:'long',year:'numeric'});
            if (infoText) infoText.textContent = 'â³ Loadingâ€¦';
            if (tbody) tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;color:#aaa">â³ Loadingâ€¦</td></tr>';
            try {
                try { const ss = await db.ref('leaderboardConfig/classStrengths').once('value'); window._classStrengths = ss.val() || {}; } catch(e) { window._classStrengths = window._classStrengths || {}; }
                const _shSafeKey = crClass ? crClass.replace(/[.\[\]#$\/]/g,'_') : '';
                const crClassStrengthSH = (window._classStrengths[_shSafeKey] || window._classStrengths[crClass] || 0);
                const crStrengthTagSH = crClassStrengthSH ? ` <span style="color:#888;font-size:0.92em">(Class Strength: ${crClassStrengthSH})</span>` : '';

                const [subSnap, taskSnap] = await Promise.all([
                    db.ref('scavengerHunt/submissions').once('value'),
                    db.ref('scavengerHunt/tasks').once('value')
                ]);
                const allSubs  = subSnap.val()  || {};
                const allTasks = taskSnap.val() || {};
                const totalTasks = Object.keys(allTasks).length;

                // â”€â”€ Store data globally for task filter re-use â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                window._crShAllSubs  = allSubs;
                window._crShAllTasks = allTasks;
                window._crShClass    = crClass;
                window._crShStrengthTag = crStrengthTagSH;

                // â”€â”€ Populate task filter dropdown â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                const taskSel = document.getElementById('crShTaskFilter');
                if (taskSel) {
                    const prevVal = taskSel.value;
                    taskSel.innerHTML = '<option value="">â€” All Tasks â€”</option>';
                    Object.entries(allTasks).forEach(([tid, t]) => {
                        const name = t.name || t.title || tid;
                        const opt = document.createElement('option');
                        opt.value = tid;
                        opt.textContent = name.length > 60 ? name.slice(0,60)+'â€¦' : name;
                        if (tid === prevVal) opt.selected = true;
                        taskSel.appendChild(opt);
                    });
                }

                // â”€â”€ Render based on selected task filter â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                crShRenderView();

            } catch(e) {
                if (infoText) infoText.textContent = 'Error loading data: ' + e.message;
                if (tbody) tbody.innerHTML = `<tr><td colspan="6" style="color:red;text-align:center">Error: ${e.message}</td></tr>`;
            }
        }

        function crShApplyTaskFilter() {
            const sel    = document.getElementById('crShTaskFilter');
            const badge  = document.getElementById('crShTaskBadge');
            const taskId = sel ? sel.value : '';
            const taskName = sel && sel.value ? sel.options[sel.selectedIndex].textContent : '';
            if (badge) {
                if (taskId) { badge.textContent = 'ðŸ“Œ ' + taskName; badge.style.display = 'inline-block'; }
                else        { badge.style.display = 'none'; }
            }
            crShRenderView();
        }

        function crShRenderView() {
            const allSubs   = window._crShAllSubs  || {};
            const allTasks  = window._crShAllTasks || {};
            const crClass   = window._crShClass    || '';
            const crStrengthTagSH = window._crShStrengthTag || '';
            const totalTasks = Object.keys(allTasks).length;
            const taskSel   = document.getElementById('crShTaskFilter');
            const selectedTask = taskSel ? taskSel.value : '';

            const infoText = document.getElementById('crShInfoText');
            const totalEl  = document.getElementById('crShTotal');
            const appEl    = document.getElementById('crShApproved');
            const penEl    = document.getElementById('crShPending');
            const rejEl    = document.getElementById('crShRejected');
            const tbody    = document.getElementById('crShTable');
            const tableHead = document.getElementById('crShTableHead');
            const nowTime   = new Date().toLocaleTimeString('en-IN',{hour:'2-digit',minute:'2-digit',hour12:true});

            if (selectedTask) {
                // â”€â”€ TASK-WISE VIEW â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                const taskDef  = allTasks[selectedTask] || {};
                const taskName = taskDef.name || taskDef.title || selectedTask;

                // Build student rows: submitted + not-submitted
                const submittedRows = [];
                let tApproved=0, tPending=0, tRejected=0;

                Object.entries(allSubs).forEach(([sk, ss]) => {
                    const firstSub = Object.values(ss)[0] || {};
                    if (crClass && firstSub.studentClass !== crClass) return;
                    const name = firstSub.studentName || sk;
                    const sub  = ss[selectedTask];
                    if (sub) {
                        const st = sub.status || 'pending';
                        if (st==='approved') tApproved++;
                        else if (st==='rejected') tRejected++;
                        else tPending++;
                        submittedRows.push({ name, status: st, submittedAt: sub.submittedAt, reviewedBy: sub.reviewedBy });
                    } else {
                        submittedRows.push({ name, status: 'not_submitted' });
                    }
                });

                submittedRows.sort((a,b) => {
                    const order = {approved:0,pending:1,rejected:2,not_submitted:3};
                    return (order[a.status]||3) - (order[b.status]||3);
                });

                const participated = submittedRows.filter(r => r.status !== 'not_submitted').length;
                if (totalEl) totalEl.textContent = participated;
                if (appEl)   appEl.textContent   = tApproved;
                if (penEl)   penEl.textContent   = tPending;
                if (rejEl)   rejEl.textContent   = tRejected;

                if (infoText) infoText.innerHTML =
                    `<span style="color:#888;font-size:12px">ðŸ• Generated at: <strong>${nowTime}</strong></span><br><br>` +
                    `Showing task: <strong style="color:#6a1b9a">${taskName}</strong><br>` +
                    `<strong>${participated}</strong> student(s) submitted Â· <strong>${tApproved}</strong> approved Â· <strong>${tPending}</strong> pending Â· <strong>${tRejected}</strong> rejected`;

                // Update table headers for task view
                if (tableHead) tableHead.innerHTML = `<tr><th>#</th><th>Student Name</th><th>Status</th><th>Submitted At</th><th>Reviewed By</th></tr>`;

                if (tbody) {
                    if (!submittedRows.length) {
                        tbody.innerHTML = `<tr><td colspan="5" style="text-align:center;color:#999">No students from ${crClass} yet.</td></tr>`;
                    } else {
                        tbody.innerHTML = '';
                        submittedRows.forEach((s,i) => {
                            const row = tbody.insertRow();
                            let statusBadge, rowStyle='';
                            if (s.status==='approved')       { statusBadge = '<span style="background:#d4edda;color:#155724;padding:3px 12px;border-radius:10px;font-weight:700">âœ… Approved</span>'; }
                            else if (s.status==='pending')   { statusBadge = '<span style="background:#fff3cd;color:#856404;padding:3px 12px;border-radius:10px;font-weight:700">â³ Pending</span>'; }
                            else if (s.status==='rejected')  { statusBadge = '<span style="background:#f8d7da;color:#721c24;padding:3px 12px;border-radius:10px;font-weight:700">âŒ Rejected</span>'; }
                            else { statusBadge = '<span style="color:#aaa;font-style:italic">â€” Not Submitted</span>'; rowStyle='opacity:0.5'; }
                            const timeStr = s.submittedAt ? new Date(s.submittedAt).toLocaleString('en-IN',{day:'2-digit',month:'short',hour:'2-digit',minute:'2-digit',hour12:true}) : 'â€”';
                            row.setAttribute('style', rowStyle);
                            row.innerHTML = `<td>${i+1}</td><td><strong>${s.name}</strong></td><td>${statusBadge}</td><td style="font-size:12px;color:#555">${timeStr}</td><td style="font-size:12px;color:#777">${s.reviewedBy||'â€”'}</td>`;
                        });
                    }
                }
            } else {
                // â”€â”€ SUMMARY VIEW (All Tasks) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                const classStudents = [];
                let grandApproved=0, grandPending=0, grandRejected=0;

                Object.entries(allSubs).forEach(([sk, ss]) => {
                    const first = Object.values(ss)[0] || {};
                    if (crClass && first.studentClass !== crClass) return;
                    const name = first.studentName || sk;
                    let approved=0, pending=0, rejected=0;
                    Object.values(ss).forEach(sub => {
                        if (sub.status==='approved')       { approved++; grandApproved++; }
                        else if (sub.status==='pending')   { pending++;  grandPending++;  }
                        else if (sub.status==='rejected')  { rejected++; grandRejected++; }
                    });
                    classStudents.push({name, approved, pending, rejected, total: approved+pending+rejected});
                });
                classStudents.sort((a,b)=>b.approved-a.approved||b.total-a.total);
                const participantCount = classStudents.length;

                if (totalEl) totalEl.textContent = participantCount;
                if (appEl)   appEl.textContent   = grandApproved;
                if (penEl)   penEl.textContent   = grandPending;
                if (rejEl)   rejEl.textContent   = grandRejected;

                if (infoText) {
                    if (participantCount === 0) {
                        infoText.innerHTML = `<span style="color:#888;font-size:12px">ðŸ• Generated at: <strong>${nowTime}</strong></span><br><br><strong>No students</strong> from <strong>${crClass}</strong>${crStrengthTagSH} have participated in the Scavenger Hunt yet.`;
                    } else {
                        infoText.innerHTML = `<span style="color:#888;font-size:12px">ðŸ• Generated at: <strong>${nowTime}</strong></span><br><br>`
                            + `<strong>${participantCount}</strong> student(s) from <strong>${crClass}</strong>${crStrengthTagSH} have participated in the Scavenger Hunt.<br>`
                            + `<strong>${grandApproved}</strong> task(s) approved Â· <strong>${grandPending}</strong> pending review Â· <strong>${grandRejected}</strong> rejected.`
                            + (totalTasks ? ` | Total tasks: <strong>${totalTasks}</strong>` : '');
                    }
                }

                // Restore summary headers
                if (tableHead) tableHead.innerHTML = `<tr><th>#</th><th>Student Name</th><th>Tasks Submitted</th><th>Approved</th><th>Pending</th><th>Rejected</th></tr>`;

                if (tbody) {
                    if (!classStudents.length) {
                        tbody.innerHTML = `<tr><td colspan="6" style="text-align:center;color:#999">No scavenger hunt submissions from ${crClass} yet.</td></tr>`;
                    } else {
                        tbody.innerHTML = '';
                        classStudents.forEach((s,i) => {
                            const row = tbody.insertRow();
                            row.innerHTML = `<td>${i+1}</td>
                                <td><strong>${s.name}</strong></td>
                                <td style="text-align:center;font-weight:700">${s.total}${totalTasks?' / '+totalTasks:''}</td>
                                <td style="text-align:center"><span style="background:#d4edda;color:#155724;padding:3px 10px;border-radius:10px;font-weight:700">${s.approved}</span></td>
                                <td style="text-align:center"><span style="background:#fff3cd;color:#856404;padding:3px 10px;border-radius:10px;font-weight:700">${s.pending}</span></td>
                                <td style="text-align:center"><span style="background:#f8d7da;color:#721c24;padding:3px 10px;border-radius:10px;font-weight:700">${s.rejected}</span></td>`;
                        });
                    }
                }
            }
        }
        
        async function loadQuizResultsAdmin() {
            const dateInput = document.getElementById('winnersDateSelector');
            const selectedDate = (dateInput && dateInput.value) ? dateInput.value : getQuizToday();
            // Ensure the date input is set
            if (dateInput && !dateInput.value) dateInput.value = selectedDate;
            try {
                const snap = await db.ref(`quizSubmissions/${selectedDate}`).once('value');
                
                if (!snap.exists()) {
                    document.getElementById('resultTotalPartAdmin').textContent = '0';
                    document.getElementById('resultBothCorrectAdmin').textContent = '0';
                    document.getElementById('resultEligibleAdmin').textContent = '0';
                    const container = document.getElementById('eligibleStudentsListAdmin');
                    if (container) container.innerHTML = '<p style="color:#999;font-style:italic;text-align:center;padding:20px">No submissions found for ' + selectedDate + '</p>';
                    // Check for winner even if no submissions
                    const resSnap2 = await db.ref(`quizResults/${selectedDate}`).once('value');
                    const winnerDiv = document.getElementById('winnersDisplayAdmin');
                    if (resSnap2.exists()) { displayQuizWinnersAdmin(resSnap2.val()); }
                    else { if(winnerDiv) { winnerDiv.innerHTML = '<p style="color:#856404;background:#fff3cd;padding:12px 16px;border-radius:8px;margin-top:10px">ðŸ“­ No winner declared for ' + selectedDate + '</p>'; winnerDiv.style.display='block'; } }
                    return;
                }
                
                let total = 0, correct = 0;
                const eligibleStudents = [];
                
                snap.forEach(child => {
                    total++;
                    const data = child.val();
                    if (data.score === 2) {
                        correct++;
                        eligibleStudents.push({
                            name: data.studentName,
                            class: data.studentClass,
                            email: data.studentEmail,
                            time: data.timeTaken,
                            submittedAt: data.submittedAt
                        });
                    }
                });
                
                document.getElementById('resultTotalPartAdmin').textContent = total;
                document.getElementById('resultBothCorrectAdmin').textContent = correct;
                document.getElementById('resultEligibleAdmin').textContent = correct;
                
                // Display detailed list of eligible students
                displayEligibleStudentsList(eligibleStudents);
                
                // Show winner/runner-up for selected date
                const resSnap = await db.ref(`quizResults/${selectedDate}`).once('value');
                const winnerDiv = document.getElementById('winnersDisplayAdmin');
                if (resSnap.exists()) {
                    displayQuizWinnersAdmin(resSnap.val());
                } else {
                    if (winnerDiv) {
                        winnerDiv.innerHTML = '<p style="color:#856404;background:#fff3cd;padding:12px 16px;border-radius:8px;margin-top:10px">ðŸ“­ No winner declared yet for ' + selectedDate + '. Use the buttons below to declare winners.</p>';
                        winnerDiv.style.display = 'block';
                    }
                }
            } catch (err) {
                console.error('Load results error:', err);
            }
        }
        
        function displayEligibleStudentsList(students) {
            const container = document.getElementById('eligibleStudentsListAdmin');
            if (!container) return;
            // Cache for manual select dropdowns
            _eligibleCache = students;
            if (_manualPanelOpen) populateManualSelects();
            
            if (students.length === 0) {
                container.innerHTML = '<p style="color:#999;font-style:italic;text-align:center;padding:20px">No students with both correct answers yet</p>';
                return;
            }
            
            // Sort by submission time (fastest first)
            students.sort((a, b) => new Date(a.submittedAt) - new Date(b.submittedAt));
            
            let html = '<div style="margin-top:20px">';
            html += '<h4 style="color:#28a745;margin-bottom:15px">âœ… Eligible Students (Both Questions Correct)</h4>';
            html += '<div style="background:white;border-radius:10px;overflow:hidden;box-shadow:0 2px 8px rgba(0,0,0,0.1)">';
            html += '<div style="overflow-x:auto;-webkit-overflow-scrolling:touch;">';
            html += '<table style="width:100%;border-collapse:collapse;min-width:400px">';
            html += '<thead><tr style="background:#28a745;color:white">';
            html += '<th style="padding:10px 8px;text-align:left;white-space:nowrap">#</th>';
            html += '<th style="padding:10px 8px;text-align:left;white-space:nowrap">Name</th>';
            html += '<th style="padding:10px 8px;text-align:left;white-space:nowrap">Class</th>';
            html += '<th style="padding:10px 8px;text-align:left;white-space:nowrap">Time Taken</th>';
            html += '<th style="padding:10px 8px;text-align:left;white-space:nowrap">Submitted At</th>';
            html += '</tr></thead><tbody>';
            
            students.forEach((student, index) => {
                const bgColor = index % 2 === 0 ? '#f8f9fa' : 'white';
                const submittedTime = new Date(student.submittedAt).toLocaleTimeString('en-IN', {
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                });
                const timeTaken = Math.floor(student.time / 60) + 'm ' + (student.time % 60) + 's';
                
                html += `<tr style="background:${bgColor}">`;
                html += `<td style="padding:10px 8px;border-bottom:1px solid #e9ecef;white-space:nowrap">${index + 1}</td>`;
                html += `<td style="padding:10px 8px;border-bottom:1px solid #e9ecef;font-weight:600;word-break:break-word;max-width:140px">${student.name}</td>`;
                html += `<td style="padding:10px 8px;border-bottom:1px solid #e9ecef;white-space:nowrap">${student.class}</td>`;
                html += `<td style="padding:10px 8px;border-bottom:1px solid #e9ecef;white-space:nowrap">${timeTaken}</td>`;
                html += `<td style="padding:10px 8px;border-bottom:1px solid #e9ecef;white-space:nowrap">${submittedTime}</td>`;
                html += '</tr>';
            });
            
            html += '</tbody></table></div></div></div>';
            container.innerHTML = html;
        }
        
        async function selectQuizWinnersFromAdmin() {
            const wds = document.getElementById('winnersDateSelector');
            const today = (wds && wds.value) ? wds.value : getQuizToday();
            try {
                const snap = await db.ref(`quizSubmissions/${today}`).once('value');
                const eligible = [];
                snap.forEach(child => {
                    if (child.val().score === 2) eligible.push(child.val());
                });
                
                if (eligible.length === 0) {
                    showQuizMsg('quizAdminMessage', 'âš ï¸ No correct answers yet!', 'warning');
                    return;
                }
                
                if (eligible.length === 1) {
                    showQuizMsg('quizAdminMessage', 'âš ï¸ Only one correct. Need 2 for winner & runner-up.', 'warning');
                    return;
                }
                
                const shuffled = eligible.sort(() => 0.5 - Math.random());
                const winner = shuffled[0];
                const runnerUp = shuffled[1];
                
                const data = {
                    winner: {name: winner.studentName, email: winner.studentEmail, class: winner.studentClass, score: winner.score},
                    runnerUp: {name: runnerUp.studentName, email: runnerUp.studentEmail, class: runnerUp.studentClass, score: runnerUp.score},
                    declaredAt: new Date().toISOString(),
                    declaredBy: 'Super Admin',
                    totalEligible: eligible.length
                };
                
                await db.ref(`quizResults/${today}`).set(data);
                
                // Try to send emails but don't block winner declaration
                try {
                    await sendQuizEmail(winner.studentEmail, 'ðŸ† You Won Quiz!', `Dear ${winner.studentName},\n\nCongratulations! You are the WINNER of today's Daily Quiz Competition!\n\nScore: ${winner.score}/2\nClass: ${winner.studentClass}\n\nWell done!\n\nDavan Institute`);
                } catch (e) { console.log('Winner email failed:', e); }
                
                try {
                    await sendQuizEmail(runnerUp.studentEmail, 'ðŸ¥ˆ Runner-Up!', `Dear ${runnerUp.studentName},\n\nCongratulations! You are the RUNNER-UP!\n\nScore: ${runnerUp.score}/2\nClass: ${runnerUp.studentClass}\n\nGreat job!\n\nDavan Institute`);
                } catch (e) { console.log('Runner-up email failed:', e); }
                
                showQuizMsg('quizAdminMessage', 'âœ… Winners selected! Check Firebase for email logs.', 'success');
                displayQuizWinnersAdmin(data);
            } catch (err) {
                console.error('Select winners error:', err);
                showQuizMsg('quizAdminMessage', 'Error selecting winners.', 'error');
            }
        }
        
        function displayQuizWinnersAdmin(data) {
            const div = document.getElementById('winnersDisplayAdmin');
            let html = '<div style="background:#f8f9fa;padding:25px;border-radius:12px">';
            html += '<h3 style="color:#667eea;margin-bottom:20px;text-align:center">ðŸŽ‰ Today\'s Winners</h3>';
            html += '<div style="background:linear-gradient(135deg,#ffd700 0%,#ffed4e 100%);padding:20px;border-radius:10px;margin-bottom:15px;color:#333">';
            html += '<h4>ðŸ† WINNER</h4>';
            html += `<p><strong>Name:</strong> ${data.winner.name}</p>`;
            html += `<p><strong>Email:</strong> ${data.winner.email}</p>`;
            html += `<p><strong>Class:</strong> ${data.winner.class}</p>`;
            html += `<p><strong>Score:</strong> ${data.winner.score}/2</p></div>`;
            html += '<div style="background:linear-gradient(135deg,#c0c0c0 0%,#e8e8e8 100%);padding:20px;border-radius:10px;color:#333">';
            html += '<h4>ðŸ¥ˆ RUNNER-UP</h4>';
            html += `<p><strong>Name:</strong> ${data.runnerUp.name}</p>`;
            html += `<p><strong>Email:</strong> ${data.runnerUp.email}</p>`;
            html += `<p><strong>Class:</strong> ${data.runnerUp.class}</p>`;
            html += `<p><strong>Score:</strong> ${data.runnerUp.score}/2</p></div>`;
            const declaredBy = data.declaredBy || 'Admin';
            const modeTag = data.autoSelected
                ? '<span style="background:#6a1b9a;color:#ffd700;padding:2px 10px;border-radius:12px;font-size:12px;margin-left:6px">â° Auto-declared</span>'
                : (data.manualSelected
                    ? '<span style="background:#2196F3;color:white;padding:2px 10px;border-radius:12px;font-size:12px;margin-left:6px">âœ‹ Manual</span>'
                    : '<span style="background:#28a745;color:white;padding:2px 10px;border-radius:12px;font-size:12px;margin-left:6px">ðŸŽ² Random</span>');
            html += `<p style="text-align:center;margin-top:20px;color:#666"><small>Declared: ${new Date(data.declaredAt).toLocaleString()} by ${declaredBy}</small>${modeTag}</p></div>`;
            div.innerHTML = html;
            div.style.display = 'block';
        }

        // ============================================
        // AUTO-DECLARATION SCHEDULER (11:30 PM daily)
        // ============================================
        let _autoDeclarInterval = null;
        let _eligibleCache = []; // populated when winners tab loads

        function saveAutoDeclarSetting() {
            const enabled = document.getElementById('autoDeclarToggle').checked;
            const time    = document.getElementById('autoDeclarTime').value || '23:30';
            try { localStorage.setItem('quizAutoDeclar', enabled ? '1' : '0'); } catch(e){}
            try { localStorage.setItem('quizAutoDeclarTime', time); } catch(e){}
            // Persist to Firebase so it survives page refresh/close
            try { db.ref('quizConfig/autoDeclar').set({ enabled, time, updatedAt: new Date().toISOString() }); } catch(e){}
            // Also save SH auto-declar setting to Firebase
            try { window.db.ref('scavengerHunt/autoDeclar').set({ enabled, time, updatedAt: new Date().toISOString() }); } catch(e){}
            applyAutoDeclarUI(enabled, time);
            if (enabled) {
                startAutoDeclarScheduler();
            } else {
                stopAutoDeclarScheduler();
            }
        }

        function applyAutoDeclarUI(enabled, time) {
            time = time || document.getElementById('autoDeclarTime').value || '23:30';
            // Format time for display e.g. "23:30" â†’ "11:30 PM"
            const [hh, mm] = time.split(':').map(Number);
            const ampm = hh >= 12 ? 'PM' : 'AM';
            const h12  = hh % 12 || 12;
            const timeDisplay = `${h12}:${String(mm).padStart(2,'0')} ${ampm}`;
            const slider = document.getElementById('autoDeclarSlider');
            const thumb  = document.getElementById('autoDeclarThumb');
            const label  = document.getElementById('autoDeclarLabel');
            const status = document.getElementById('autoDeclarStatus');
            const countdown = document.getElementById('autoDeclarCountdown');
            if (!slider) return;
            if (enabled) {
                slider.style.background = '#28a745';
                thumb.style.left = '25px';
                label.textContent = 'ON';
                status.innerHTML = `ðŸŸ¢ Auto-declaration is <strong style="color:#a5ffb8">enabled</strong>. Winners will be auto-selected at <strong style="color:#ffd700">${timeDisplay}</strong> if not declared manually.`;
                countdown.style.display = 'block';
                updateAutoDeclarCountdown();
            } else {
                slider.style.background = '#555';
                thumb.style.left = '3px';
                label.textContent = 'OFF';
                status.innerHTML = 'ðŸ”´ Auto-declaration is <strong style="color:#ff6b6b">disabled</strong>. Toggle ON to enable.';
                countdown.style.display = 'none';
            }
        }

        function updateAutoDeclarCountdown() {
            const el = document.getElementById('autoDeclarCountdown');
            if (!el || !document.getElementById('autoDeclarToggle').checked) return;
            const time = document.getElementById('autoDeclarTime').value || '23:30';
            const [hh, mm] = time.split(':').map(Number);
            const now = new Date();
            const target = new Date();
            target.setHours(hh, mm, 0, 0);
            if (now >= target) {
                const [h12, ampm] = [hh % 12 || 12, hh >= 12 ? 'PM' : 'AM'];
                el.textContent = `â° ${h12}:${String(mm).padStart(2,'0')} ${ampm} has passed for today. Auto-declaration ran (or no eligible students).`;
                return;
            }
            const diff = Math.floor((target - now) / 1000);
            const h = Math.floor(diff / 3600);
            const m = Math.floor((diff % 3600) / 60);
            const s = diff % 60;
            el.textContent = `â³ Auto-declaration in: ${String(h).padStart(2,'0')}h ${String(m).padStart(2,'0')}m ${String(s).padStart(2,'0')}s`;
        }

        function startAutoDeclarScheduler() {
            stopAutoDeclarScheduler();
            _autoDeclarInterval = setInterval(async () => {
                if (!document.getElementById('autoDeclarToggle') || !document.getElementById('autoDeclarToggle').checked) return;
                updateAutoDeclarCountdown();
                const time = document.getElementById('autoDeclarTime').value || '23:30';
                const [hh, mm] = time.split(':').map(Number);
                const now = new Date();
                if (now.getHours() === hh && now.getMinutes() === mm) {
                    await runAutoDeclaration();
                }
            }, 1000);
        }

        function stopAutoDeclarScheduler() {
            if (_autoDeclarInterval) { clearInterval(_autoDeclarInterval); _autoDeclarInterval = null; }
        }

        async function runAutoDeclaration() {
            const today = getQuizToday();
            // Check if results already declared for today
            try {
                const existing = await db.ref(`quizResults/${today}`).once('value');
                if (existing.exists()) {
                    console.log('[AutoDeclar] Results already declared for', today, 'â€” skipping.');
                    return;
                }
                const snap = await db.ref(`quizSubmissions/${today}`).once('value');
                const eligible = [];
                snap.forEach(child => {
                    if (child.val().score === 2) eligible.push(child.val());
                });
                if (eligible.length < 2) {
                    console.log('[AutoDeclar] Not enough eligible students (' + eligible.length + ').');
                    const statusEl = document.getElementById('autoDeclarStatus');
                    if (statusEl) statusEl.innerHTML = 'âš ï¸ Auto-declaration ran at 11:30 PM but <strong>not enough eligible students</strong> (need at least 2).';
                    return;
                }
                const shuffled = eligible.sort(() => 0.5 - Math.random());
                const winner   = shuffled[0];
                const runnerUp = shuffled[1];
                const data = {
                    winner:       { name: winner.studentName,   email: winner.studentEmail,   class: winner.studentClass,   score: winner.score },
                    runnerUp:     { name: runnerUp.studentName, email: runnerUp.studentEmail, class: runnerUp.studentClass, score: runnerUp.score },
                    declaredAt:   new Date().toISOString(),
                    declaredBy:   'System (Auto 11:30 PM)',
                    totalEligible: eligible.length,
                    autoSelected: true
                };
                await db.ref(`quizResults/${today}`).set(data);
                console.log('[AutoDeclar] Winners saved for', today);
                // Send emails silently
                try { await sendQuizEmail(winner.studentEmail,   'ðŸ† You Won Quiz!', `Dear ${winner.studentName},\n\nCongratulations! You are the WINNER of today's Quiz!\n\nDavan Institute`); } catch(e){}
                try { await sendQuizEmail(runnerUp.studentEmail, 'ðŸ¥ˆ Runner-Up!',    `Dear ${runnerUp.studentName},\n\nCongratulations! You are today's RUNNER-UP!\n\nDavan Institute`); } catch(e){}
                // Update UI if winners tab is visible
                displayQuizWinnersAdmin(data);
                const statusEl = document.getElementById('autoDeclarStatus');
                if (statusEl) statusEl.innerHTML = `âœ… Auto-declared at 11:30 PM â€” <strong style="color:#a5ffb8">${winner.studentName}</strong> (Winner) &amp; <strong style="color:#ffd700">${runnerUp.studentName}</strong> (Runner-Up).`;
            } catch(e) {
                console.error('[AutoDeclar] Error:', e);
            }
        }

        async function initAutoDeclarScheduler() {
            let enabled = false;
            let time = '23:30';
            // Try Firebase first (most reliable across sessions)
            try {
                const snap = await db.ref('quizConfig/autoDeclar').once('value');
                if (snap.exists()) { enabled = !!snap.val().enabled; time = snap.val().time || '23:30'; }
                else {
                    enabled = localStorage.getItem('quizAutoDeclar') === '1';
                    time = localStorage.getItem('quizAutoDeclarTime') || '23:30';
                }
            } catch(e) {
                try { enabled = localStorage.getItem('quizAutoDeclar') === '1'; time = localStorage.getItem('quizAutoDeclarTime') || '23:30'; } catch(e2){}
            }
            const toggle   = document.getElementById('autoDeclarToggle');
            const timeInp  = document.getElementById('autoDeclarTime');
            if (toggle) {
                toggle.checked = enabled;
                if (timeInp) timeInp.value = time;
                try { localStorage.setItem('quizAutoDeclar', enabled ? '1' : '0'); } catch(e){}
                try { localStorage.setItem('quizAutoDeclarTime', time); } catch(e){}
                applyAutoDeclarUI(enabled, time);
                if (enabled) {
                    startAutoDeclarScheduler();
                    // Also check: did the set time already pass today without declaration?
                    checkMissedAutoDeclar();
                }
            }
        }

        // Check if today's auto-declaration was missed (set time passed, page was closed)
        async function checkMissedAutoDeclar() {
            const time = document.getElementById('autoDeclarTime').value || '23:30';
            const [hh, mm] = time.split(':').map(Number);
            const now = new Date();
            if (now.getHours() < hh || (now.getHours() === hh && now.getMinutes() < mm)) return;
            const today = getQuizToday();
            try {
                const existing = await db.ref(`quizResults/${today}`).once('value');
                if (!existing.exists()) {
                    // Results not declared yet and 11:30 has passed â€” run now
                    console.log('[AutoDeclar] Missed 11:30 PM trigger â€” running now on page load');
                    const statusEl = document.getElementById('autoDeclarStatus');
                    if (statusEl) statusEl.innerHTML = 'âš ï¸ <strong>11:30 PM was missed</strong> (page was closed). Running auto-declaration nowâ€¦';
                    await runAutoDeclaration();
                }
            } catch(e) { console.warn('[AutoDeclar] checkMissed error:', e); }
        }

        // ============================================
        // MANUAL WINNER SELECTION
        // ============================================
        let _manualPanelOpen = false;

        function toggleManualWinnerUI() {
            _manualPanelOpen = !_manualPanelOpen;
            const panel = document.getElementById('manualWinnerPanel');
            const btn   = document.getElementById('manualSelectToggleBtn');
            if (!panel) return;
            if (_manualPanelOpen) {
                panel.style.display = 'block';
                btn.textContent = 'âœ– Close Manual Select';
                populateManualSelects();
            } else {
                panel.style.display = 'none';
                btn.textContent = 'âœ‹ Manual Select';
            }
        }

        function populateManualSelects() {
            const winSel = document.getElementById('manualWinnerSelect');
            const runSel = document.getElementById('manualRunnerSelect');
            if (!winSel || !runSel) return;
            // Use _eligibleCache built when winners tab loads
            winSel.innerHTML = '<option value="">-- Select Winner --</option>';
            runSel.innerHTML = '<option value="">-- Select Runner-Up --</option>';
            _eligibleCache.forEach((s, i) => {
                const label = `${s.name} (${s.class})`;
                winSel.innerHTML += `<option value="${i}">${label}</option>`;
                runSel.innerHTML += `<option value="${i}">${label}</option>`;
            });
        }

        async function declareManualWinners() {
            const winIdx = parseInt(document.getElementById('manualWinnerSelect').value);
            const runIdx = parseInt(document.getElementById('manualRunnerSelect').value);
            if (isNaN(winIdx) || isNaN(runIdx)) {
                alert('âš ï¸ Please select both winner and runner-up.');
                return;
            }
            if (winIdx === runIdx) {
                alert('âš ï¸ Winner and runner-up must be different students.');
                return;
            }
            const winner   = _eligibleCache[winIdx];
            const runnerUp = _eligibleCache[runIdx];
            if (!winner || !runnerUp) { alert('âš ï¸ Invalid selection.'); return; }
            if (!confirm(`Declare:\nðŸ† Winner: ${winner.name}\nðŸ¥ˆ Runner-Up: ${runnerUp.name}\n\nProceed?`)) return;
            const wds2 = document.getElementById('winnersDateSelector'); const today = (wds2 && wds2.value) ? wds2.value : getQuizToday();
            const data = {
                winner:       { name: winner.name,   email: winner.email,   class: winner.class,   score: 2 },
                runnerUp:     { name: runnerUp.name, email: runnerUp.email, class: runnerUp.class, score: 2 },
                declaredAt:   new Date().toISOString(),
                declaredBy:   'Super Admin (Manual)',
                totalEligible: _eligibleCache.length,
                manualSelected: true
            };
            try {
                await db.ref(`quizResults/${today}`).set(data);
                try { await sendQuizEmail(winner.email,   'ðŸ† You Won Quiz!', `Dear ${winner.name},\n\nCongratulations! You are the WINNER!\n\nDavan Institute`); } catch(e){}
                try { await sendQuizEmail(runnerUp.email, 'ðŸ¥ˆ Runner-Up!',    `Dear ${runnerUp.name},\n\nCongratulations! You are the RUNNER-UP!\n\nDavan Institute`); } catch(e){}
                showQuizMsg('quizAdminMessage', 'âœ… Manual winners declared!', 'success');
                displayQuizWinnersAdmin(data);
                toggleManualWinnerUI(); // close panel
            } catch(e) {
                alert('âŒ Error saving: ' + e.message);
            }
        }
        
        // ============================================
        // NEW PUBLISH/UNPUBLISH FUNCTIONS
        // ============================================
        
        async function checkPublishStatusForToday() {
            const today = getQuizToday();
            console.log('checkPublishStatusForToday called for:', today);
            try {
                const qSnap = await db.ref(`quizQuestions/${today}`).once('value');
                if (!qSnap.exists()) {
                    console.log('No questions exist for today');
                    document.getElementById('publishControlSection').style.display = 'none';
                    return;
                }
                
                const pSnap = await db.ref(`quizPublished/${today}`).once('value');
                const publishData = pSnap.val();
                const isPublished = publishData && publishData.published === true;
                
                console.log('Publish data (Today):', JSON.stringify(publishData));
                console.log('Is published (Today):', isPublished);
                
                const publishControlSection = document.getElementById('publishControlSection');
                const statusDiv = document.getElementById('publishStatusDisplay');
                const btnPub = document.getElementById('btnPublish');
                const btnUnpub = document.getElementById('btnUnpublish');
                
                if (!publishControlSection || !statusDiv || !btnPub || !btnUnpub) {
                    console.error('Could not find required elements (Today tab)');
                    return;
                }
                
                publishControlSection.style.display = 'block';
                
                if (isPublished) {
                    console.log('Showing UNPUBLISH button (Today tab)');
                    statusDiv.innerHTML = '<div style="background:#d4edda;padding:15px;border-radius:8px;border:2px solid #28a745"><p style="margin:0;color:#155724;font-weight:bold">âœ… Quiz is PUBLISHED - Students can see it</p><p style="margin:5px 0 0 0;color:#155724;font-size:13px">Published: ' + new Date(publishData.publishedAt).toLocaleString() + '</p></div>';
                    btnPub.style.display = 'none';
                    btnUnpub.style.display = 'inline-block';
                } else {
                    console.log('Showing PUBLISH button (Today tab)');
                    statusDiv.innerHTML = '<div style="background:#fff3cd;padding:15px;border-radius:8px;border:2px solid #ffc107"><p style="margin:0;color:#856404;font-weight:bold">âš ï¸ Quiz is DRAFT - Not visible to students</p><p style="margin:5px 0 0 0;color:#856404;font-size:13px">Click PUBLISH to make it visible</p></div>';
                    btnPub.style.display = 'inline-block';
                    btnUnpub.style.display = 'none';
                }
            } catch (err) {
                console.error('Check publish error (Today):', err);
            }
        }
        
        async function publishTodayQuiz() {
            const today = getQuizToday();
            if (!confirm('Publish today\'s quiz? Students will be able to see and attempt it.')) return;
            
            console.log('=== PUBLISH STARTED ===');
            console.log('Today:', today);
            console.log('Current user:', quizCurrentUser);
            
            try {
                const qSnap = await db.ref(`quizQuestions/${today}`).once('value');
                if (!qSnap.exists()) {
                    showQuizMsg('quizAdminDashMessage', 'âš ï¸ No questions saved for today!', 'error');
                    return;
                }
                
                // Get the email safely
                const userEmail = quizCurrentUser ? quizCurrentUser.email : 'admin@system';
                console.log('Using email:', userEmail);
                
                // Write to database and wait for completion
                await db.ref(`quizPublished/${today}`).set({
                    published: true,
                    publishedAt: new Date().toISOString(),
                    publishedBy: userEmail
                });
                
                console.log('Firebase write completed');
                
                // Verify the write
                const verifySnap = await db.ref(`quizPublished/${today}`).once('value');
                const publishData = verifySnap.val();
                console.log('Verification read:', JSON.stringify(publishData));
                
                showQuizMsg('quizAdminDashMessage', 'âœ… Quiz published successfully!', 'success');
                
                // Direct DOM manipulation - force the UI to update immediately
                const statusDivAdmin = document.getElementById('publishStatusDisplayAdmin');
                const btnPubAdmin = document.getElementById('btnPublishAdmin');
                const btnUnpubAdmin = document.getElementById('btnUnpublishAdmin');
                
                const statusDiv = document.getElementById('publishStatusDisplay');
                const btnPub = document.getElementById('btnPublish');
                const btnUnpub = document.getElementById('btnUnpublish');
                
                console.log('Found elements:');
                console.log('  statusDivAdmin:', !!statusDivAdmin);
                console.log('  btnPubAdmin:', !!btnPubAdmin);
                console.log('  btnUnpubAdmin:', !!btnUnpubAdmin);
                console.log('  statusDiv:', !!statusDiv);
                console.log('  btnPub:', !!btnPub);
                console.log('  btnUnpub:', !!btnUnpub);
                
                // Update Admin Dashboard
                if (statusDivAdmin && btnPubAdmin && btnUnpubAdmin) {
                    console.log('Updating Admin Dashboard UI directly');
                    statusDivAdmin.innerHTML = '<div style="background:#d4edda;padding:15px;border-radius:8px;border:2px solid #28a745"><p style="margin:0;color:#155724;font-weight:bold">âœ… Quiz is PUBLISHED - Students can see it</p><p style="margin:5px 0 0 0;color:#155724;font-size:13px">Published: ' + new Date(publishData.publishedAt).toLocaleString() + '</p></div>';
                    btnPubAdmin.style.display = 'none';
                    btnUnpubAdmin.style.display = 'inline-block';
                    console.log('Admin buttons updated - Publish:', btnPubAdmin.style.display, 'Unpublish:', btnUnpubAdmin.style.display);
                } else {
                    console.log('Could not update Admin Dashboard - elements missing');
                }
                
                // Update Quiz Management Tab
                if (statusDiv && btnPub && btnUnpub) {
                    console.log('Updating Quiz Management Tab UI directly');
                    statusDiv.innerHTML = '<div style="background:#d4edda;padding:15px;border-radius:8px;border:2px solid #28a745"><p style="margin:0;color:#155724;font-weight:bold">âœ… Quiz is PUBLISHED - Students can see it</p><p style="margin:5px 0 0 0;color:#155724;font-size:13px">Published: ' + new Date(publishData.publishedAt).toLocaleString() + '</p></div>';
                    btnPub.style.display = 'none';
                    btnUnpub.style.display = 'inline-block';
                    console.log('Quiz tab buttons updated - Publish:', btnPub.style.display, 'Unpublish:', btnUnpub.style.display);
                } else {
                    console.log('Could not update Quiz Management Tab - elements missing');
                }
                
                console.log('=== PUBLISH COMPLETED ===');
            } catch (err) {
                console.error('Publish error:', err);
                console.error('Error stack:', err.stack);
                showQuizMsg('quizAdminDashMessage', 'âŒ Error publishing: ' + err.message, 'error');
            }
        }
        
        async function unpublishTodayQuiz() {
            const today = getQuizToday();
            if (!confirm('Unpublish today\'s quiz? Students will no longer see it.')) return;
            
            console.log('=== UNPUBLISH STARTED ===');
            console.log('Today:', today);
            console.log('Current user:', quizCurrentUser);
            
            try {
                // Get the email safely
                const userEmail = quizCurrentUser ? quizCurrentUser.email : 'admin@system';
                console.log('Using email:', userEmail);
                
                // Write to database and wait for completion
                await db.ref(`quizPublished/${today}`).set({
                    published: false,
                    unpublishedAt: new Date().toISOString(),
                    unpublishedBy: userEmail
                });
                
                console.log('Firebase write completed');
                
                // Verify the write
                const verifySnap = await db.ref(`quizPublished/${today}`).once('value');
                console.log('Verification read:', JSON.stringify(verifySnap.val()));
                
                showQuizMsg('quizAdminDashMessage', 'âœ… Quiz unpublished successfully!', 'success');
                
                // Direct DOM manipulation - force the UI to update immediately
                const statusDivAdmin = document.getElementById('publishStatusDisplayAdmin');
                const btnPubAdmin = document.getElementById('btnPublishAdmin');
                const btnUnpubAdmin = document.getElementById('btnUnpublishAdmin');
                
                const statusDiv = document.getElementById('publishStatusDisplay');
                const btnPub = document.getElementById('btnPublish');
                const btnUnpub = document.getElementById('btnUnpublish');
                
                console.log('Found elements:');
                console.log('  statusDivAdmin:', !!statusDivAdmin);
                console.log('  btnPubAdmin:', !!btnPubAdmin);
                console.log('  btnUnpubAdmin:', !!btnUnpubAdmin);
                console.log('  statusDiv:', !!statusDiv);
                console.log('  btnPub:', !!btnPub);
                console.log('  btnUnpub:', !!btnUnpub);
                
                // Update Admin Dashboard
                if (statusDivAdmin && btnPubAdmin && btnUnpubAdmin) {
                    console.log('Updating Admin Dashboard UI directly');
                    statusDivAdmin.innerHTML = '<div style="background:#fff3cd;padding:15px;border-radius:8px;border:2px solid #ffc107"><p style="margin:0;color:#856404;font-weight:bold">âš ï¸ Quiz is DRAFT - Not visible to students</p><p style="margin:5px 0 0 0;color:#856404;font-size:13px">Click PUBLISH to make it visible</p></div>';
                    btnPubAdmin.style.display = 'inline-block';
                    btnUnpubAdmin.style.display = 'none';
                    console.log('Admin buttons updated - Publish:', btnPubAdmin.style.display, 'Unpublish:', btnUnpubAdmin.style.display);
                } else {
                    console.log('Could not update Admin Dashboard - elements missing');
                }
                
                // Update Quiz Management Tab
                if (statusDiv && btnPub && btnUnpub) {
                    console.log('Updating Quiz Management Tab UI directly');
                    statusDiv.innerHTML = '<div style="background:#fff3cd;padding:15px;border-radius:8px;border:2px solid #ffc107"><p style="margin:0;color:#856404;font-weight:bold">âš ï¸ Quiz is DRAFT - Not visible to students</p><p style="margin:5px 0 0 0;color:#856404;font-size:13px">Click PUBLISH to make it visible</p></div>';
                    btnPub.style.display = 'inline-block';
                    btnUnpub.style.display = 'none';
                    console.log('Quiz tab buttons updated - Publish:', btnPub.style.display, 'Unpublish:', btnUnpub.style.display);
                } else {
                    console.log('Could not update Quiz Management Tab - elements missing');
                }
                
                console.log('=== UNPUBLISH COMPLETED ===');
            } catch (err) {
                console.error('Unpublish error:', err);
                console.error('Error stack:', err.stack);
                showQuizMsg('quizAdminDashMessage', 'âŒ Error unpublishing: ' + err.message, 'error');
            }
        }
        
        async function showTodayAnswers() {
            const today = getQuizToday();
            try {
                const snap = await db.ref(`quizQuestions/${today}`).once('value');
                const q = snap.val();
                
                // Determine which section we're in
                const isAdmin = document.getElementById('publishControlSectionAdmin') && 
                               document.getElementById('publishControlSectionAdmin').style.display !== 'none';
                const divId = isAdmin ? 'answersDisplaySectionAdmin' : 'answersDisplaySection';
                const div = document.getElementById(divId);
                
                if (!div) {
                    console.error('Answers display div not found');
                    alert('Error: Unable to display answers. Please contact support.');
                    return;
                }
                
                if (!q || !q.q1 || !q.q2) {
                    div.innerHTML = '<div style="background:#f8d7da;padding:15px;border-radius:8px"><p style="margin:0;color:#721c24">âŒ No questions found for today</p></div>';
                    div.style.display = 'block';
                    return;
                }
                
                let html = '<div style="background:#e8f5e9;padding:25px;border-radius:12px;border:3px solid #4CAF50">';
                html += '<h3 style="color:#2e7d32;margin-bottom:20px;text-align:center">ðŸ” Correct Answers</h3>';
                
                html += '<div style="background:white;padding:20px;border-radius:10px;margin-bottom:15px;border-left:5px solid #4CAF50">';
                html += '<h4 style="color:#667eea;margin-bottom:15px">Question 1</h4>';
                html += `<p style="font-weight:600;margin-bottom:10px">${q.q1.text || 'N/A'}</p>`;
                html += `<p style="margin-left:20px;color:#666">A) ${q.q1.options.A || 'N/A'}</p>`;
                html += `<p style="margin-left:20px;color:#666">B) ${q.q1.options.B || 'N/A'}</p>`;
                html += `<p style="margin-left:20px;color:#666">C) ${q.q1.options.C || 'N/A'}</p>`;
                html += `<p style="margin-left:20px;color:#666">D) ${q.q1.options.D || 'N/A'}</p>`;
                html += `<div style="background:#4CAF50;color:white;padding:12px;border-radius:8px;margin-top:15px;font-weight:bold">âœ… Correct Answer: ${q.q1.correct}) ${q.q1.options[q.q1.correct] || 'N/A'}</div></div>`;
                
                html += '<div style="background:white;padding:20px;border-radius:10px;border-left:5px solid #4CAF50">';
                html += '<h4 style="color:#667eea;margin-bottom:15px">Question 2</h4>';
                html += `<p style="font-weight:600;margin-bottom:10px">${q.q2.text || 'N/A'}</p>`;
                html += `<p style="margin-left:20px;color:#666">A) ${q.q2.options.A || 'N/A'}</p>`;
                html += `<p style="margin-left:20px;color:#666">B) ${q.q2.options.B || 'N/A'}</p>`;
                html += `<p style="margin-left:20px;color:#666">C) ${q.q2.options.C || 'N/A'}</p>`;
                html += `<p style="margin-left:20px;color:#666">D) ${q.q2.options.D || 'N/A'}</p>`;
                html += `<div style="background:#4CAF50;color:white;padding:12px;border-radius:8px;margin-top:15px;font-weight:bold">âœ… Correct Answer: ${q.q2.correct}) ${q.q2.options[q.q2.correct] || 'N/A'}</div></div>`;
                
                html += '<p style="text-align:center;margin-top:20px;color:#666;font-size:14px"><em>Visible to Admin Only</em></p></div>';
                
                div.innerHTML = html;
                div.style.display = 'block';
                
                // Scroll to the answers with a small delay to ensure rendering
                setTimeout(() => {
                    div.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                }, 100);
            } catch (err) {
                console.error('Show answers error:', err);
                const div = document.getElementById('answersDisplaySectionAdmin') || document.getElementById('answersDisplaySection');
                if (div) {
                    div.innerHTML = '<div style="background:#f8d7da;padding:15px;border-radius:8px"><p style="margin:0;color:#721c24">âŒ Error loading answers: ' + err.message + '</p></div>';
                    div.style.display = 'block';
                }
                alert('Error displaying answers. Please check the console for details.');
            }
        }
        
        // Admin Dashboard specific publish check
        async function checkPublishStatusForAdmin() {
            const today = getQuizToday();
            console.log('=== checkPublishStatusForAdmin START ===');
            console.log('Date:', today);
            
            try {
                const qSnap = await db.ref(`quizQuestions/${today}`).once('value');
                if (!qSnap.exists()) {
                    console.log('No questions exist for today');
                    document.getElementById('publishControlSectionAdmin').style.display = 'none';
                    return;
                }
                
                const pSnap = await db.ref(`quizPublished/${today}`).once('value');
                const publishData = pSnap.val();
                const isPublished = publishData && publishData.published === true;
                
                console.log('Publish data:', publishData);
                console.log('Is published:', isPublished);
                
                const publishControlSection = document.getElementById('publishControlSectionAdmin');
                const statusDiv = document.getElementById('publishStatusDisplayAdmin');
                
                if (!publishControlSection || !statusDiv) {
                    console.error('Could not find required elements');
                    return;
                }
                
                publishControlSection.style.display = 'block';
                
                // Recreate buttons HTML to force update
                const buttonsContainer = publishControlSection.querySelector('div[style*="display:flex"]');
                if (buttonsContainer) {
                    if (isPublished) {
                        console.log('Setting UP: UNPUBLISH button visible');
                        statusDiv.innerHTML = '<div style="background:#d4edda;padding:15px;border-radius:8px;border:2px solid #28a745"><p style="margin:0;color:#155724;font-weight:bold">âœ… Quiz is PUBLISHED - Students can see it</p><p style="margin:5px 0 0 0;color:#155724;font-size:13px">Published: ' + new Date(publishData.publishedAt).toLocaleString() + '</p></div>';
                        
                        buttonsContainer.innerHTML = `
                            <button class="btn btn-success" onclick="publishTodayQuiz()" id="btnPublishAdmin" style="display:none">âœ… PUBLISH Quiz (Make Live)</button>
                            <button class="btn btn-danger" onclick="unpublishTodayQuiz()" id="btnUnpublishAdmin" style="display:inline-block">âŒ UNPUBLISH Quiz (Hide)</button>
                        `;
                    } else {
                        console.log('Setting UP: PUBLISH button visible');
                        statusDiv.innerHTML = '<div style="background:#fff3cd;padding:15px;border-radius:8px;border:2px solid #ffc107"><p style="margin:0;color:#856404;font-weight:bold">âš ï¸ Quiz is DRAFT - Not visible to students</p><p style="margin:5px 0 0 0;color:#856404;font-size:13px">Click PUBLISH to make it visible</p></div>';
                        
                        buttonsContainer.innerHTML = `
                            <button class="btn btn-success" onclick="publishTodayQuiz()" id="btnPublishAdmin" style="display:inline-block">âœ… PUBLISH Quiz (Make Live)</button>
                            <button class="btn btn-danger" onclick="unpublishTodayQuiz()" id="btnUnpublishAdmin" style="display:none">âŒ UNPUBLISH Quiz (Hide)</button>
                        `;
                    }
                    console.log('Buttons HTML updated successfully');
                }
                
                console.log('=== checkPublishStatusForAdmin END ===');
            } catch (err) {
                console.error('Check publish error:', err);
            }
        }
        
        // ============================================
        // QUIZ DATE EDIT FUNCTIONS (Super Admin Only)
        // ============================================
        
        let selectedQuizForDateEdit = null;
        
        async function loadQuizzesForDateEdit() {
            try {
                const snapshot = await db.ref('quizQuestions').once('value');
                const quizzes = snapshot.val() || {};
                const quizListContainer = document.getElementById('quizListForDateEdit');
                
                if (Object.keys(quizzes).length === 0) {
                    quizListContainer.innerHTML = '<p style="text-align:center;color:#666;">No quizzes available to edit.</p>';
                    return;
                }
                
                let html = '';
                // Sort by date descending
                Object.entries(quizzes).sort((a, b) => b[0].localeCompare(a[0])).forEach(([date, quiz]) => {
                    const question1Preview = quiz.q1 ? quiz.q1.text.substring(0, 60) : (quiz.question1 ? quiz.question1.text.substring(0, 60) : '');
                    html += `
                        <div class="quiz-list-item" onclick="selectQuizForDateEdit('${date}')" id="quiz-item-${date}">
                            <div>
                                <div class="quiz-date-info">ðŸ“… ${date}</div>
                                <div class="quiz-question-preview">${question1Preview}${question1Preview.length >= 60 ? '...' : ''}</div>
                            </div>
                            <div>
                                <button class="btn btn-small btn-edit-date" onclick="event.stopPropagation(); selectQuizForDateEdit('${date}')">ðŸ“… Edit Date</button>
                            </div>
                        </div>
                    `;
                });
                
                quizListContainer.innerHTML = html;
            } catch (error) {
                console.error('Error loading quizzes for date edit:', error);
                showQuizMsg('dateChangeMessage', 'Error loading quizzes.', 'error');
            }
        }
        
        async function selectQuizForDateEdit(date) {
            try {
                const snapshot = await db.ref('quizQuestions/' + date).once('value');
                const quiz = snapshot.val();
                if (!quiz) return;
                
                selectedQuizForDateEdit = { date, ...quiz };
                
                // Highlight selected quiz
                document.querySelectorAll('.quiz-list-item').forEach(item => {
                    item.classList.remove('selected');
                });
                const selectedItem = document.getElementById('quiz-item-' + date);
                if (selectedItem) {
                    selectedItem.classList.add('selected');
                }
                
                // Show date change form
                document.getElementById('currentQuizDate').textContent = date;
                const questionPreview = quiz.q1 ? quiz.q1.text : (quiz.question1 ? quiz.question1.text : 'No question text');
                document.getElementById('currentQuizPreview').textContent = questionPreview;
                document.getElementById('newQuizDate').value = '';
                document.getElementById('dateChangeForm').style.display = 'block';
            } catch (error) {
                console.error('Error selecting quiz:', error);
                showQuizMsg('dateChangeMessage', 'Error selecting quiz.', 'error');
            }
        }
        
        function cancelDateEdit() {
            selectedQuizForDateEdit = null;
            document.getElementById('dateChangeForm').style.display = 'none';
            document.querySelectorAll('.quiz-list-item').forEach(item => {
                item.classList.remove('selected');
            });
            document.getElementById('dateChangeMessage').classList.remove('show');
        }
        
        async function updateQuizDate() {
            if (!selectedQuizForDateEdit) {
                showQuizMsg('dateChangeMessage', 'Please select a quiz first.', 'error');
                return;
            }
            
            const newDate = document.getElementById('newQuizDate').value;
            if (!newDate) {
                showQuizMsg('dateChangeMessage', 'Please select a new date.', 'error');
                return;
            }
            
            if (newDate === selectedQuizForDateEdit.date) {
                showQuizMsg('dateChangeMessage', 'New date must be different from current date.', 'error');
                return;
            }
            
            // Check if new date already has a quiz
            try {
                const snapshot = await db.ref('quizQuestions/' + newDate).once('value');
                if (snapshot.exists()) {
                    const confirmOverwrite = confirm(`A quiz already exists for ${newDate}. Do you want to overwrite it?`);
                    if (!confirmOverwrite) return;
                }
                
                // Show confirmation modal
                document.getElementById('dateEditModalMessage').innerHTML = `
                    <p>Are you sure you want to change the quiz date?</p>
                    <p style="margin-top:10px;"><strong>From:</strong> <span style="color:#c44569;">${selectedQuizForDateEdit.date}</span></p>
                    <p><strong>To:</strong> <span style="color:#4CAF50;">${newDate}</span></p>
                    <p style="margin-top:15px;font-size:0.9em;color:#666;">This will move the quiz and its publish status to the new date.</p>
                `;
                document.getElementById('quizDateEditModal').style.display = 'block';
            } catch (error) {
                console.error('Error checking new date:', error);
                showQuizMsg('dateChangeMessage', 'Error checking new date.', 'error');
            }
        }
        
        async function confirmDateChange() {
            const oldDate = selectedQuizForDateEdit.date;
            const newDate = document.getElementById('newQuizDate').value;
            const autoPublish = document.getElementById('autoPublishAfterMove').checked;
            
            try {
                // Get all related data
                const quizSnapshot = await db.ref('quizQuestions/' + oldDate).once('value');
                const publishSnapshot = await db.ref('quizPublished/' + oldDate).once('value');
                const submissionsSnapshot = await db.ref('quizSubmissions/' + oldDate).once('value');
                const resultsSnapshot = await db.ref('quizResults/' + oldDate).once('value');
                
                const quizData = quizSnapshot.val();
                const publishData = publishSnapshot.val();
                const submissionsData = submissionsSnapshot.val();
                const resultsData = resultsSnapshot.val();
                
                if (!quizData) {
                    throw new Error('No quiz found at old date');
                }
                
                // Create array of all write operations
                const writeOperations = [];
                
                // Write quiz to new date
                writeOperations.push(db.ref('quizQuestions/' + newDate).set(quizData));
                
                // Handle publish status
                if (autoPublish) {
                    // Auto-publish at new date
                    writeOperations.push(db.ref('quizPublished/' + newDate).set({
                        published: true,
                        publishedAt: Date.now(),
                        publishedBy: 'Super Admin (via date change)'
                    }));
                } else if (publishData) {
                    // Keep existing publish status
                    writeOperations.push(db.ref('quizPublished/' + newDate).set(publishData));
                }
                
                // Move submissions if exist
                if (submissionsData) {
                    writeOperations.push(db.ref('quizSubmissions/' + newDate).set(submissionsData));
                }
                
                // Move results if exist
                if (resultsData) {
                    writeOperations.push(db.ref('quizResults/' + newDate).set(resultsData));
                }
                
                // Wait for ALL writes to complete
                await Promise.all(writeOperations);
                
                // Now delete old entries - create array of delete operations
                const deleteOperations = [];
                deleteOperations.push(db.ref('quizQuestions/' + oldDate).remove());
                
                if (publishData) {
                    deleteOperations.push(db.ref('quizPublished/' + oldDate).remove());
                }
                
                if (submissionsData) {
                    deleteOperations.push(db.ref('quizSubmissions/' + oldDate).remove());
                }
                
                if (resultsData) {
                    deleteOperations.push(db.ref('quizResults/' + oldDate).remove());
                }
                
                // Wait for ALL deletes to complete
                await Promise.all(deleteOperations);
                
                // Show success message
                closeQuizDateEditModal();
                const publishMsg = autoPublish ? ' and published' : '';
                showQuizMsg('dateChangeMessage', `Quiz date successfully changed from ${oldDate} to ${newDate}${publishMsg}!`, 'success');
                
                // Reload quiz list
                setTimeout(() => {
                    cancelDateEdit();
                    loadQuizzesForDateEdit();
                }, 2000);
                
            } catch (error) {
                console.error('Date change error:', error);
                closeQuizDateEditModal();
                showQuizMsg('dateChangeMessage', 'Failed to change quiz date. Please try again.', 'error');
            }
        }
        
        function closeQuizDateEditModal() {
            document.getElementById('quizDateEditModal').style.display = 'none';
        }
        
        function showQuizMsg(elementId, text, type) {
            const message = document.getElementById(elementId);
            if (message) {
                message.textContent = text;
                message.className = `message ${type} show`;
                setTimeout(() => {
                    message.classList.remove('show');
                }, 5000);
            }
        }
    </script>
    
    <!-- ============================================ -->
    <!-- CLASS OF THE YEAR 2026 LEADERBOARD           -->
    <!-- Pulls live data from Firebase automatically  -->
    <!-- ============================================ -->
    <style>
        /* ===== LEADERBOARD STYLES ===== */
        @import url('https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700;900&family=DM+Sans:wght@400;500;600&display=swap');

        @keyframes lbFadeUp {
            from { opacity:0; transform:translateY(40px); }
            to   { opacity:1; transform:translateY(0); }
        }
        @keyframes lbShine {
            0%   { background-position: -200% center; }
            100% { background-position: 200% center; }
        }
        @keyframes lbGlow {
            0%,100% { box-shadow: 0 0 20px rgba(196,69,105,0.3); }
            50%      { box-shadow: 0 0 40px rgba(196,69,105,0.6), 0 0 60px rgba(106,27,154,0.3); }
        }
        @keyframes lbPodiumRise {
            from { transform: scaleY(0); transform-origin: bottom; }
            to   { transform: scaleY(1); transform-origin: bottom; }
        }
        @keyframes lbSparkle {
            0%,100% { transform: scale(1) rotate(0deg); opacity:1; }
            50%      { transform: scale(1.3) rotate(180deg); opacity:0.8; }
        }
        @keyframes lbRowSlide {
            from { opacity:0; transform:translateX(-30px); }
            to   { opacity:1; transform:translateX(0); }
        }
        @keyframes lbCountUp {
            from { opacity:0; transform:scale(0.5); }
            to   { opacity:1; transform:scale(1); }
        }
        @keyframes lbCrownFloat {
            0%,100% { transform: translateY(0px) rotate(-5deg); }
            50%      { transform: translateY(-8px) rotate(5deg); }
        }
        @keyframes lbPulseRing {
            0%   { transform: scale(1); opacity:0.8; }
            100% { transform: scale(1.5); opacity:0; }
        }

        .lb-section {
            margin: 40px 0 30px;
            animation: lbFadeUp 0.8s ease-out;
        }

        /* --- Header --- */
        .lb-header {
            text-align: center;
            padding: 50px 30px 40px;
            background: linear-gradient(135deg, #1a0030 0%, #3d0060 40%, #6a1b9a 70%, #c44569 100%);
            border-radius: 24px 24px 0 0;
            position: relative;
            overflow: hidden;
        }
        .lb-header::before {
            content: '';
            position: absolute; inset: 0;
            background: repeating-linear-gradient(
                45deg,
                transparent, transparent 20px,
                rgba(255,255,255,0.03) 20px, rgba(255,255,255,0.03) 40px
            );
        }
        .lb-header-stars {
            position: absolute; inset: 0; pointer-events: none;
        }
        .lb-star {
            position: absolute;
            color: rgba(255,255,255,0.15);
            font-size: 1.2em;
            animation: lbSparkle 3s ease-in-out infinite;
        }
        .lb-crown {
            font-size: 4em;
            display: block;
            margin-bottom: 10px;
            animation: lbCrownFloat 3s ease-in-out infinite;
            position: relative; z-index:1;
        }
        .lb-title {
            font-family: 'Playfair Display', Georgia, serif;
            font-size: clamp(1.8em, 4vw, 3em);
            font-weight: 900;
            color: #fff;
            letter-spacing: 2px;
            margin-bottom: 6px;
            background: linear-gradient(90deg, #fff 0%, #ffd700 50%, #fff 100%);
            background-size: 200% auto;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            animation: lbShine 3s linear infinite;
            position: relative; z-index:1;
        }
        .lb-subtitle {
            font-family: 'DM Sans', sans-serif;
            color: rgba(255,255,255,0.75);
            font-size: 1em;
            letter-spacing: 4px;
            text-transform: uppercase;
            position: relative; z-index:1;
        }
        .lb-events-pills {
            display: flex;
            justify-content: center;
            gap: 12px;
            margin-top: 20px;
            flex-wrap: wrap;
            position: relative; z-index:1;
        }
        .lb-pill {
            background: rgba(255,255,255,0.12);
            border: 1px solid rgba(255,255,255,0.25);
            color: white;
            padding: 6px 18px;
            border-radius: 30px;
            font-size: 0.85em;
            font-family: 'DM Sans', sans-serif;
            backdrop-filter: blur(8px);
        }

        /* --- Body card --- */
        .lb-body {
            background: white;
            border-radius: 0 0 24px 24px;
            box-shadow: 0 20px 60px rgba(106,27,154,0.15);
            overflow: hidden;
        }

        /* --- Scoring legend --- */
        .lb-legend {
            display: flex;
            gap: 10px;
            padding: 20px 30px;
            background: #faf5ff;
            border-bottom: 2px solid #f0e6ff;
            flex-wrap: wrap;
            align-items: center;
        }
        .lb-legend-title {
            font-family: 'DM Sans', sans-serif;
            font-weight: 600;
            color: #6a1b9a;
            font-size: 0.9em;
            margin-right: 6px;
        }
        .lb-legend-item {
            display: flex;
            align-items: center;
            gap: 6px;
            background: white;
            border: 1px solid #e0d0f0;
            border-radius: 20px;
            padding: 5px 14px;
            font-size: 0.82em;
            font-family: 'DM Sans', sans-serif;
            color: #444;
        }
        .lb-legend-dot {
            width: 10px; height: 10px;
            border-radius: 50%;
        }

        /* --- Top 3 Podium --- */
        .lb-podium-section {
            padding: 40px 30px 20px;
            background: linear-gradient(180deg, #fdf6ff 0%, #ffffff 100%);
        }
        .lb-podium-title {
            text-align: center;
            font-family: 'Playfair Display', serif;
            color: #6a1b9a;
            font-size: 1.4em;
            margin-bottom: 30px;
            font-weight: 700;
        }
        .lb-podium {
            display: flex;
            align-items: flex-end;
            justify-content: center;
            gap: 16px;
            max-width: 600px;
            margin: 0 auto;
        }
        .lb-podium-slot {
            flex: 1;
            text-align: center;
            max-width: 180px;
        }
        .lb-podium-name {
            font-family: 'DM Sans', sans-serif;
            font-weight: 600;
            font-size: 0.85em;
            color: #333;
            margin-bottom: 8px;
            line-height: 1.3;
            word-break: break-word;
        }
        .lb-podium-score {
            font-family: 'Playfair Display', serif;
            font-weight: 700;
            font-size: 1.1em;
            color: #6a1b9a;
            margin-bottom: 8px;
        }
        .lb-podium-block {
            border-radius: 12px 12px 0 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.5em;
            position: relative;
            overflow: hidden;
            animation: lbPodiumRise 0.8s ease-out;
        }
        .lb-podium-block::after {
            content: '';
            position: absolute; inset: 0;
            background: linear-gradient(180deg, rgba(255,255,255,0.2) 0%, transparent 100%);
        }
        .lb-pos-1 .lb-podium-block {
            height: 130px;
            background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
            box-shadow: 0 8px 25px rgba(255,165,0,0.4);
        }
        .lb-pos-2 .lb-podium-block {
            height: 100px;
            background: linear-gradient(135deg, #C0C0C0 0%, #A8A8A8 100%);
            box-shadow: 0 6px 20px rgba(150,150,150,0.3);
        }
        .lb-pos-3 .lb-podium-block {
            height: 75px;
            background: linear-gradient(135deg, #CD7F32 0%, #A0522D 100%);
            box-shadow: 0 5px 15px rgba(160,82,45,0.3);
        }
        .lb-pos-1 .lb-podium-name {
            font-size: 1em;
            color: #4a0080;
        }
        .lb-pos-1 .lb-podium-score {
            font-size: 1.3em;
            color: #c44569;
        }
        .lb-pos-1-ring {
            position: relative;
        }
        .lb-pos-1-ring::before {
            content: '';
            position: absolute;
            inset: -4px;
            border-radius: 50%;
            background: conic-gradient(#FFD700, #FF6B6B, #6A1B9A, #FFD700);
            z-index: -1;
            animation: lbPulseRing 2s ease-out infinite;
            opacity: 0;
        }

        /* --- Full Rankings Table --- */
        .lb-table-section {
            padding: 10px 30px 40px;
        }
        .lb-table-header {
            font-family: 'Playfair Display', serif;
            color: #6a1b9a;
            font-size: 1.2em;
            margin: 24px 0 16px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .lb-table-wrap {
            overflow-x: auto;
            border-radius: 16px;
            border: 2px solid #f0e6ff;
        }
        .lb-table {
            width: 100%;
            border-collapse: collapse;
            min-width: 560px;
            font-family: 'DM Sans', sans-serif;
        }
        .lb-table thead tr {
            background: linear-gradient(135deg, #c44569 0%, #6a1b9a 100%);
        }
        .lb-table thead th {
            color: white;
            padding: 14px 18px;
            font-size: 0.85em;
            font-weight: 600;
            letter-spacing: 0.5px;
            text-align: left;
            white-space: nowrap;
        }
        .lb-table tbody tr {
            border-bottom: 1px solid #f5eeff;
            transition: all 0.25s;
            animation: lbRowSlide 0.4s ease-out both;
        }
        .lb-table tbody tr:hover {
            background: #fdf5ff;
            transform: translateX(4px);
        }
        .lb-table tbody tr:last-child {
            border-bottom: none;
        }
        .lb-table tbody td {
            padding: 14px 18px;
            font-size: 0.92em;
            color: #333;
            white-space: nowrap;
        }
        .lb-rank-badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 34px; height: 34px;
            border-radius: 50%;
            font-weight: 700;
            font-size: 0.95em;
        }
        .lb-rank-1 { background: linear-gradient(135deg,#FFD700,#FFA500); color:#333; box-shadow:0 3px 10px rgba(255,165,0,0.4); }
        .lb-rank-2 { background: linear-gradient(135deg,#C0C0C0,#A8A8A8); color:#333; box-shadow:0 3px 10px rgba(150,150,150,0.3); }
        .lb-rank-3 { background: linear-gradient(135deg,#CD7F32,#A0522D); color:#fff; box-shadow:0 3px 10px rgba(160,82,45,0.3); }
        .lb-rank-other { background: #f0e6ff; color:#6a1b9a; }
        .lb-class-chip {
            background: linear-gradient(135deg, #f3e5ff 0%, #e8d5ff 100%);
            color: #6a1b9a;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.82em;
            font-weight: 600;
            display: inline-block;
        }
        .lb-pts-total {
            font-weight: 700;
            color: #c44569;
            font-size: 1.05em;
        }
        .lb-pts-event {
            font-size: 0.82em;
            color: #888;
        }
        .lb-bar-wrap {
            background: #f5eeff;
            border-radius: 10px;
            height: 8px;
            min-width: 80px;
            overflow: hidden;
        }
        .lb-bar-fill {
            height: 100%;
            border-radius: 10px;
            background: linear-gradient(90deg, #c44569, #6a1b9a);
            transition: width 1.2s ease;
        }
        .lb-loading {
            text-align: center;
            padding: 60px 20px;
            color: #aaa;
            font-family: 'DM Sans', sans-serif;
        }
        .lb-loading-spinner {
            width: 40px; height: 40px;
            border: 4px solid #f0e6ff;
            border-top-color: #c44569;
            border-radius: 50%;
            margin: 0 auto 16px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { to { transform:rotate(360deg); } }

        .lb-empty {
            text-align: center;
            padding: 50px 20px;
            color: #bbb;
            font-family: 'DM Sans', sans-serif;
            font-size: 1.1em;
        }
        .lb-last-updated {
            text-align: center;
            font-family: 'DM Sans', sans-serif;
            font-size: 0.8em;
            color: #bbb;
            padding: 15px;
            border-top: 1px solid #f5eeff;
        }
        .lb-refresh-btn {
            background: linear-gradient(135deg, #c44569 0%, #6a1b9a 100%);
            color: white;
            border: none;
            padding: 8px 20px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.85em;
            font-family: 'DM Sans', sans-serif;
            font-weight: 600;
            margin-left: 10px;
            transition: all 0.3s;
        }
        .lb-refresh-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(196,69,105,0.35);
        }

        /* Scoring breakdown popover */
        .lb-breakdown {
            display: inline-flex;
            gap: 6px;
            flex-wrap: wrap;
        }
        .lb-score-tag {
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.75em;
            font-weight: 600;
        }
        .lb-score-yf   { background:#fff3cd; color:#856404; border:1px solid #ffc107; }
        .lb-score-quiz { background:#d4edda; color:#155724; border:1px solid #28a745; }

        @media (max-width: 600px) {
            .lb-podium { gap: 8px; }
            .lb-table-section, .lb-legend { padding-left: 15px; padding-right: 15px; }
            .lb-pos-1 .lb-podium-block { height: 100px; }
            .lb-pos-2 .lb-podium-block { height: 75px; }
            .lb-pos-3 .lb-podium-block { height: 55px; }
        }
    </style>

    <div class="lb-section" id="leaderboardSection">

        <!-- Header -->
        <div class="lb-header">
            <div class="lb-header-stars" id="lbStars"></div>
            <span class="lb-crown">ðŸ‘‘</span>
            <div class="lb-title">Class of the Year 2026</div>
            <div class="lb-subtitle">Spurthi Youth Fest Â· Overall Rankings</div>
            <div class="lb-events-pills">
                <span class="lb-pill">ðŸŽ¤ Youthfest Registration</span>
                <span class="lb-pill">ðŸ§  Online Quiz Competition</span>
            </div>
        </div>

        <!-- Body -->
        <!-- Hidden-by-default gate; shown only when leaderboard is published -->
        <div id="lbHiddenMsg" style="display:none;border-radius:0 0 24px 24px;overflow:hidden">

            <!-- â”€â”€ COMING SOON BANNER (always shown when hidden) â”€â”€ -->
            <div style="text-align:center;padding:50px 30px 40px;background:linear-gradient(135deg,#1a0030 0%,#3d0060 40%,#6a1b9a 70%,#c44569 100%);position:relative">
                <div style="position:absolute;inset:0;background:repeating-linear-gradient(45deg,transparent,transparent 20px,rgba(255,255,255,0.02) 20px,rgba(255,255,255,0.02) 40px)"></div>
                <div style="position:relative;z-index:1">
                    <div style="font-size:3em;margin-bottom:14px">ðŸ”’</div>
                    <!-- Editable heading -->
                    <div id="hwpHeadingView">
                        <h2 id="hwpHeadingText" style="color:#ffd700;margin-bottom:10px;font-size:1.8em;letter-spacing:1px;text-shadow:0 0 20px rgba(255,215,0,0.4)">Leaderboard Coming Soon!</h2>
                    </div>
                    <div id="hwpHeadingEdit" style="display:none;margin-bottom:10px">
                        <input id="hwpHeadingInput" type="text" style="width:80%;max-width:500px;padding:10px 16px;border-radius:8px;border:2px solid #ffd700;background:rgba(255,255,255,0.1);color:#ffd700;font-size:1.3em;font-weight:700;text-align:center;outline:none">
                    </div>
                    <!-- Editable sub-text -->
                    <div id="hwpSubView">
                        <p id="hwpSubText" style="color:rgba(255,255,255,0.8);font-size:1em;margin:0">Results will be published by the Super Admin once the events are completed.<br>Check back soon!</p>
                    </div>
                    <div id="hwpSubEdit" style="display:none;margin-top:8px">
                        <textarea id="hwpSubInput" rows="2" style="width:80%;max-width:500px;padding:10px 14px;border-radius:8px;border:2px solid rgba(255,255,255,0.4);background:rgba(255,255,255,0.1);color:white;font-size:0.95em;text-align:center;outline:none;resize:vertical"></textarea>
                    </div>
                    <!-- Super Admin edit controls (only shown when SA logged in) -->
                    <div id="hwpBannerEditControls" class="super-admin-only" style="display:none;margin-top:16px;gap:8px;flex-wrap:wrap;justify-content:center">
                        <button onclick="hwpToggleBannerEdit()" id="hwpBannerEditBtn" style="background:rgba(255,215,0,0.2);color:#ffd700;border:1px solid #ffd700;padding:6px 16px;border-radius:6px;cursor:pointer;font-size:13px;font-weight:600">âœï¸ Edit Banner Text</button>
                        <button onclick="hwpSaveBanner()" id="hwpBannerSaveBtn" style="display:none;background:#ffd700;color:#1a0030;border:none;padding:6px 16px;border-radius:6px;cursor:pointer;font-size:13px;font-weight:700">ðŸ’¾ Save</button>
                        <button onclick="hwpCancelBannerEdit()" id="hwpBannerCancelBtn" style="display:none;background:rgba(255,255,255,0.15);color:white;border:1px solid rgba(255,255,255,0.3);padding:6px 16px;border-radius:6px;cursor:pointer;font-size:13px">Cancel</button>
                        <span id="hwpBannerSaveMsg" style="display:none;background:rgba(40,167,69,0.3);color:#a5d6a7;border:1px solid #28a745;padding:5px 12px;border-radius:6px;font-size:12px;font-weight:600">âœ… Saved!</span>
                    </div>
                </div>
            </div>

            <!-- â”€â”€ HOW WE PUBLISH â€” full section (white card below banner) â”€â”€ -->
            <div style="background:white">

                <!-- Section header with SA edit toggle -->
                <div style="background:linear-gradient(135deg,#f3e5ff,#fce4ec);padding:20px 28px;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:10px;border-bottom:2px solid #e8d5f5">
                    <div style="display:flex;align-items:center;gap:10px">
                        <span style="font-size:1.5em">ðŸ“‹</span>
                        <div>
                            <h3 id="hwpSectionTitle" style="color:#3d0060;margin:0;font-size:1.1em;font-weight:800">How We Publish the Leaderboard</h3>
                            <p style="color:#666;margin:3px 0 0;font-size:12px">Transparent process â€” Spurthi Youth Fest 2026</p>
                        </div>
                    </div>
                    <!-- SA edit mode toggle -->
                    <div id="hwpEditModeControls" class="super-admin-only" style="display:none;gap:8px">
                        <button onclick="hwpToggleEditMode()" id="hwpEditModeBtn" style="background:linear-gradient(135deg,#6a1b9a,#c44569);color:white;border:none;padding:7px 16px;border-radius:6px;cursor:pointer;font-size:13px;font-weight:600">âœï¸ Edit This Section</button>
                        <button onclick="hwpSaveAll()" id="hwpSaveAllBtn" style="display:none;background:#28a745;color:white;border:none;padding:7px 16px;border-radius:6px;cursor:pointer;font-size:13px;font-weight:700">ðŸ’¾ Save All Changes</button>
                        <button onclick="hwpCancelEdit()" id="hwpCancelBtn" style="display:none;background:#666;color:white;border:none;padding:7px 16px;border-radius:6px;cursor:pointer;font-size:13px">âœ• Cancel</button>
                        <span id="hwpSaveAllMsg" style="display:none;background:#d4edda;color:#155724;border:1px solid #c3e6cb;padding:5px 12px;border-radius:6px;font-size:12px;font-weight:600">âœ… All changes saved!</span>
                    </div>
                </div>

                <div style="padding:24px 28px">

                    <!-- Overview text â€” editable -->
                    <div id="hwpOverviewView" style="background:linear-gradient(135deg,#f3e5ff,#fce4ec);border-radius:10px;padding:16px 18px;margin-bottom:22px;border-left:4px solid #6a1b9a">
                        <p id="hwpOverviewText" style="margin:0;color:#3d0060;font-size:13.5px;line-height:1.75">The <strong style="color:#c44569">Class of the Year 2026</strong> leaderboard ranks all <strong>11 classes</strong> competing across <strong>16 events</strong> at Spurthi Youth Fest. Rankings are hidden until the Super Admin verifies all results and officially publishes them â€” ensuring every score is accurate before you see it.</p>
                    </div>
                    <div id="hwpOverviewEdit" style="display:none;margin-bottom:22px">
                        <label style="font-size:12px;color:#6a1b9a;font-weight:700;display:block;margin-bottom:6px">Overview paragraph (supports basic HTML like &lt;strong&gt;):</label>
                        <textarea id="hwpOverviewInput" rows="4" style="width:100%;padding:10px 14px;border:2px solid #6a1b9a;border-radius:8px;font-size:13px;line-height:1.6;resize:vertical;outline:none"></textarea>
                    </div>

                    <!-- Points breakdown â€” 4 editable cards -->
                    <h4 style="color:#1a0030;font-size:1em;margin:0 0 12px;display:flex;align-items:center;gap:8px">
                        <span style="background:linear-gradient(135deg,#6a1b9a,#c44569);color:white;border-radius:50%;width:24px;height:24px;display:inline-flex;align-items:center;justify-content:center;font-size:11px;flex-shrink:0;font-weight:700">1</span>
                        How Points Are Calculated
                    </h4>
                    <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px;margin-bottom:24px" id="hwpPointsGrid">

                        <div style="background:#fffde7;border-radius:10px;padding:15px;border-top:4px solid #ffc107" data-hwp-card="0">
                            <div style="display:flex;align-items:center;gap:8px;margin-bottom:7px"><span style="font-size:1.3em">ðŸŽ¤</span><strong id="hwpCard0Title" style="color:#856404;font-size:0.9em">Youthfest Registration</strong></div>
                            <p id="hwpCard0Body" style="margin:0;color:#555;font-size:12.5px;line-height:1.6">Each class earns points for <strong>every event they enrol in</strong>. More participation = more points for your class.</p>
                            <div class="hwpCardEditArea" style="display:none;margin-top:8px">
                                <input type="text" class="hwpCardTitleInput" data-idx="0" placeholder="Card title" style="width:100%;padding:5px 8px;border:1px solid #ffc107;border-radius:4px;font-size:12px;margin-bottom:5px">
                                <textarea class="hwpCardBodyInput" data-idx="0" rows="3" placeholder="Card body text" style="width:100%;padding:5px 8px;border:1px solid #ffc107;border-radius:4px;font-size:12px;resize:vertical"></textarea>
                            </div>
                        </div>

                        <div style="background:#e8f5e9;border-radius:10px;padding:15px;border-top:4px solid #28a745" data-hwp-card="1">
                            <div style="display:flex;align-items:center;gap:8px;margin-bottom:7px"><span style="font-size:1.3em">ðŸ§ </span><strong id="hwpCard1Title" style="color:#155724;font-size:0.9em">Quiz Competition</strong></div>
                            <p id="hwpCard1Body" style="margin:0;color:#555;font-size:12.5px;line-height:1.6">Per published quiz day: <strong>flat bonus</strong> to the winner &amp; runner-up class, plus a <strong>participation rate bonus</strong> â€” fair across all class sizes.</p>
                            <div class="hwpCardEditArea" style="display:none;margin-top:8px">
                                <input type="text" class="hwpCardTitleInput" data-idx="1" placeholder="Card title" style="width:100%;padding:5px 8px;border:1px solid #28a745;border-radius:4px;font-size:12px;margin-bottom:5px">
                                <textarea class="hwpCardBodyInput" data-idx="1" rows="3" placeholder="Card body text" style="width:100%;padding:5px 8px;border:1px solid #28a745;border-radius:4px;font-size:12px;resize:vertical"></textarea>
                            </div>
                        </div>

                        <div style="background:#f3e5ff;border-radius:10px;padding:15px;border-top:4px solid #6a1b9a" data-hwp-card="2">
                            <div style="display:flex;align-items:center;gap:8px;margin-bottom:7px"><span style="font-size:1.3em">ðŸ†</span><strong id="hwpCard2Title" style="color:#4a148c;font-size:0.9em">Event Results</strong></div>
                            <p id="hwpCard2Body" style="margin:0;color:#555;font-size:12.5px;line-height:1.6">When jury results are published, the <strong>1st place class</strong> gets winner pts and <strong>2nd place</strong> gets runner-up pts. For individual &amp; multi-team events, each class is represented by their <strong>best performer or best team</strong>.</p>
                            <div class="hwpCardEditArea" style="display:none;margin-top:8px">
                                <input type="text" class="hwpCardTitleInput" data-idx="2" placeholder="Card title" style="width:100%;padding:5px 8px;border:1px solid #6a1b9a;border-radius:4px;font-size:12px;margin-bottom:5px">
                                <textarea class="hwpCardBodyInput" data-idx="2" rows="3" placeholder="Card body text" style="width:100%;padding:5px 8px;border:1px solid #6a1b9a;border-radius:4px;font-size:12px;resize:vertical"></textarea>
                            </div>
                        </div>

                        <div style="background:#fff3e0;border-radius:10px;padding:15px;border-top:4px solid #e8722a" data-hwp-card="3">
                            <div style="display:flex;align-items:center;gap:8px;margin-bottom:7px"><span style="font-size:1.3em">ðŸ—ºï¸</span><strong id="hwpCard3Title" style="color:#bf360c;font-size:0.9em">Scavenger Hunt</strong></div>
                            <p id="hwpCard3Body" style="margin:0;color:#555;font-size:12.5px;line-height:1.6">Points are awarded for <strong>approved task submissions</strong> in the Scavenger Hunt. The more tasks a student completes and gets approved, the more points their class earns.</p>
                            <div class="hwpCardEditArea" style="display:none;margin-top:8px">
                                <input type="text" class="hwpCardTitleInput" data-idx="3" placeholder="Card title" style="width:100%;padding:5px 8px;border:1px solid #e8722a;border-radius:4px;font-size:12px;margin-bottom:5px">
                                <textarea class="hwpCardBodyInput" data-idx="3" rows="3" placeholder="Card body text" style="width:100%;padding:5px 8px;border:1px solid #e8722a;border-radius:4px;font-size:12px;resize:vertical"></textarea>
                            </div>
                        </div>

                        <div style="background:#e0f7fa;border-radius:10px;padding:15px;border-top:4px solid #17a2b8" data-hwp-card="4">
                            <div style="display:flex;align-items:center;gap:8px;margin-bottom:7px"><span style="font-size:1.3em">âœ¨</span><strong id="hwpCard4Title" style="color:#0c5460;font-size:0.9em">Special / Custom Criteria</strong></div>
                            <p id="hwpCard4Body" style="margin:0;color:#555;font-size:12.5px;line-height:1.6">The Super Admin may add bonus points for criteria like discipline, attendance, best decorated class, or other special achievements.</p>
                            <div class="hwpCardEditArea" style="display:none;margin-top:8px">
                                <input type="text" class="hwpCardTitleInput" data-idx="4" placeholder="Card title" style="width:100%;padding:5px 8px;border:1px solid #17a2b8;border-radius:4px;font-size:12px;margin-bottom:5px">
                                <textarea class="hwpCardBodyInput" data-idx="4" rows="3" placeholder="Card body text" style="width:100%;padding:5px 8px;border:1px solid #17a2b8;border-radius:4px;font-size:12px;resize:vertical"></textarea>
                            </div>
                        </div>

                    </div>

                    <!-- Steps â€” editable -->
                    <h4 style="color:#1a0030;font-size:1em;margin:0 0 12px;display:flex;align-items:center;gap:8px">
                        <span style="background:linear-gradient(135deg,#6a1b9a,#c44569);color:white;border-radius:50%;width:24px;height:24px;display:inline-flex;align-items:center;justify-content:center;font-size:11px;flex-shrink:0;font-weight:700">2</span>
                        How the Super Admin Publishes Results
                    </h4>
                    <div id="hwpStepsGrid" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:10px;margin-bottom:22px">
                        <!-- Steps rendered by JS from Firebase / defaults -->
                    </div>

                    <!-- Important notes â€” editable textarea -->
                    <div style="background:#fff8e1;border-radius:10px;padding:15px 18px;border-left:4px solid #ffc107;margin-bottom:20px">
                        <h5 style="color:#856404;margin:0 0 8px;font-size:0.9em">âš ï¸ Important Notes</h5>
                        <div id="hwpNotesView">
                            <ul id="hwpNotesList" style="margin:0;padding-left:16px;color:#555;font-size:13px;line-height:1.9">
                                <li>Only the <strong>Super Admin</strong> can publish or hide the leaderboard.</li>
                                <li>All point calculations are <strong>fully automatic</strong> â€” no manual tampering.</li>
                                <li>For individual events (e.g. Hand Writing, Pod Casting), each class is represented by their <strong>best-scoring student</strong>. For multi-team events (e.g. Vlog), each class is represented by their <strong>best-scoring team</strong>.</li>
                                <li>The leaderboard refreshes every <strong>60 seconds</strong> once live.</li>
                                <li>Rankings may be updated progressively as more results are published.</li>
                            </ul>
                        </div>
                        <div id="hwpNotesEdit" style="display:none;margin-top:8px">
                            <label style="font-size:11px;color:#856404;font-weight:700;display:block;margin-bottom:5px">One note per line:</label>
                            <textarea id="hwpNotesInput" rows="5" style="width:100%;padding:8px 12px;border:2px solid #ffc107;border-radius:6px;font-size:13px;line-height:1.7;resize:vertical;outline:none"></textarea>
                        </div>
                    </div>

                    <!-- Footer -->
                    <div style="text-align:center;padding-top:14px;border-top:1px solid #f0e6ff">
                        <p style="margin:0;color:#999;font-size:11.5px">
                            ðŸŽ“ <strong style="color:#6a1b9a">Spurthi Youth Fest 2026</strong> Â· Davan Institute of Advanced Management Studies, Davangere<br>
                            <span style="font-size:10.5px">Platform by Harsha Gujjar, Director â€” Davan College</span>
                        </p>
                    </div>

                </div>
            </div>
        </div>
        <div id="lbPublicBody" style="display:none">
        <div class="lb-body">

            <!-- Scoring Legend -->
            <div class="lb-legend">
                <span class="lb-legend-title">ðŸ“Š Scoring:</span>
                <span class="lb-legend-item">
                    <span class="lb-legend-dot" style="background:#ffc107"></span>
                    Youthfest Reg: pts/event enrolled
                </span>
                <span class="lb-legend-item">
                    <span class="lb-legend-dot" style="background:#28a745"></span>
                    Quiz: winner/runner-up bonus + participation rate
                </span>
                <span class="lb-legend-item">
                    <span class="lb-legend-dot" style="background:#6a1b9a"></span>
                    ðŸ† Event Results: winner/runner-up pts
                </span>
                <span class="lb-legend-item">
                    <span class="lb-legend-dot" style="background:#17a2b8"></span>
                    âœ¨ Special criteria pts
                </span>
                <button class="lb-refresh-btn" onclick="loadLeaderboard()">ðŸ”„ Refresh</button>
            </div>

            <!-- Podium Top 3 -->
            <div class="lb-podium-section">
                <div class="lb-podium-title">ðŸ… Top 3 Classes</div>
                <div class="lb-podium" id="lbPodium">
                    <div class="lb-loading">
                        <div class="lb-loading-spinner"></div>
                        Loading rankingsâ€¦
                    </div>
                </div>
            </div>

            <!-- Full Rankings Table -->
            <div class="lb-table-section">
                <div class="lb-table-header">ðŸ“‹ Full Rankings</div>
                <div class="lb-table-wrap">
                    <table class="lb-table">
                        <thead>
                            <tr>
                                <th>Rank</th>
                                <th>Class</th>
                                <th>ðŸŽ¤ YF Reg</th>
                                <th>ðŸ§  Quiz</th>
                                <th>ðŸ† Results</th>
                                <th>ðŸ—ºï¸ Hunt</th>
                                <th>ðŸ§© Slide</th>
                                <th>Total</th>
                                <th>Progress</th>
                            </tr>
                        </thead>
                        <tbody id="lbTableBody">
                            <tr>
                                <td colspan="7" style="text-align:center;padding:40px;color:#bbb">
                                    <div class="lb-loading-spinner" style="margin:0 auto 10px"></div>
                                    Loadingâ€¦
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <div class="lb-last-updated" id="lbLastUpdated">Fetching live dataâ€¦</div>
            </div>


        </div>
        </div><!-- /lbPublicBody -->
    </div><!-- /lb-section -->

    <script>
    // ============================================================
    //  CLASS OF THE YEAR 2026 â€” LEADERBOARD ENGINE
    //  db is resolved via getDb() helper â€” safe across all script blocks

    // â”€â”€ Safe Firebase db getter (works across separate <script> blocks) â”€â”€
    function getDb() {
        if (window.db) return window.db;
        if (typeof db !== 'undefined' && db) return db;
        throw new Error("Firebase not initialised yet. Please wait and try again.");
    }

    //  Points:
    //    Youthfest Registration â†’ 10 pts per event a class enrolled in
    //    Online Quiz            â†’ 5 pts per correct answer per student per day
    // ============================================================

    // Star decoration in header
    (function spawnStars() {
        const container = document.getElementById('lbStars');
        if (!container) return;
        const symbols = ['âœ¦','âœ§','â‹†','â˜…','âœ©'];
        for (let i = 0; i < 18; i++) {
            const s = document.createElement('span');
            s.className = 'lb-star';
            s.textContent = symbols[Math.floor(Math.random() * symbols.length)];
            s.style.top  = Math.random() * 100 + '%';
            s.style.left = Math.random() * 100 + '%';
            s.style.animationDelay = (Math.random() * 3) + 's';
            s.style.fontSize = (0.7 + Math.random() * 1.2) + 'em';
            container.appendChild(s);
        }
    })();
    // ============================================================
    //  LEADERBOARD ENGINE v3 â€” FINAL
    //  Sources:
    //  1. Youthfest Registration  â†’ yfPtsPerEvent per event enrolled
    //  2. Quiz (per PUBLISHED day only):
    //       a) Winner class       â†’ quizWinnerPts (flat)
    //       b) Runner-up class    â†’ quizRunnerUpPts (flat)
    //       c) Participation rate â†’ (studentsWithMaxScore / classStrength) Ã— quizMaxPts
    //          â€” fair across classes of different sizes
    //  3. Youthfest event results â†’ winnerPts / runnerUpPts (jury published)
    //  4. Custom criteria         â†’ manual points from Super Admin
    //  Leaderboard itself hidden until Super Admin publishes it
    //  Config: leaderboardConfig/scoring | classStrengths | published | customCriteria
    // ============================================================

    const LB_CLASSES = [
        '1st B.Com','2nd B.Com','3rd B.Com',
        '1ST BCA','2ND BCA A SEC','2ND BCA B SEC',
        '3RD BCA A SEC','3RD BCA B SEC','3RD BCA C SEC',
        '2ND BBA','3RD BBA'
    ];

    let lbCfg = {
        yfPtsPerEvent: 10, winnerPts: 50, runnerUpPts: 30,
        quizWinnerPts: 20, quizRunnerUpPts: 10, quizMaxPts: 10,
        shWinnerPts: 30, shRunnerUpPts: 15, shTaskPts: 5, shCompletePts: 20
    };
    let lbClassStrengths = {}; // cls â†’ number of students

    async function getLbConfig() {
        try {
            const [cfgSnap, strSnap] = await Promise.all([
                getDb().ref('leaderboardConfig/scoring').once('value'),
                getDb().ref('leaderboardConfig/classStrengths').once('value')
            ]);
            if (cfgSnap.exists()) {
                const d = cfgSnap.val();
                lbCfg = {
                    yfPtsPerEvent:   d.yfPtsPerEvent   || 10,
                    winnerPts:       d.winnerPts        || 50,
                    runnerUpPts:     d.runnerUpPts      || 30,
                    quizWinnerPts:   d.quizWinnerPts    || 20,
                    quizRunnerUpPts: d.quizRunnerUpPts  || 10,
                    quizMaxPts:      d.quizMaxPts       || 10,
                    shWinnerPts:     d.shWinnerPts      || 30,
                    shRunnerUpPts:   d.shRunnerUpPts    || 15,
                    shTaskPts:       d.shTaskPts        || 5,
                    shCompletePts:   d.shCompletePts    || 20
                };
            }
            if (strSnap.exists()) {
                lbClassStrengths = strSnap.val() || {};
            }
        } catch(e) {}
        return lbCfg;
    }

    // â”€â”€ Check publish status and show/hide leaderboard â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function checkLbPublished() {
        try {
            const snap = await getDb().ref('leaderboardConfig/published').once('value');
            const pub = snap.val() === true;
            document.getElementById('lbPublicBody').style.display  = pub ? 'block' : 'none';
            document.getElementById('lbHiddenMsg').style.display   = pub ? 'none'  : 'block';
            return pub;
        } catch(e) {
            document.getElementById('lbHiddenMsg').style.display = 'block';
            return false;
        }
    }

    async function loadLeaderboard() {
        const pub = await checkLbPublished();
        if (!pub) return; // don't fetch data if not published

        try {
            const cfg = await getLbConfig();
            const init = () => { const o = {}; LB_CLASSES.forEach(c => o[c] = 0); return o; };

            const yfPts     = init();
            const quizPts   = init();
            const resultPts = init();
            const customPts = init();

            // â”€â”€ 1. Youthfest Registration â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            const yfSnap = await getDb().ref('youthfest-enrollments').once('value');
            if (yfSnap.exists()) {
                yfSnap.forEach(child => {
                    const d   = child.val();
                    const cls = d.classYear || d.class || '';
                    if (yfPts[cls] !== undefined) yfPts[cls] += cfg.yfPtsPerEvent;
                });
            }

            // â”€â”€ 2. Quiz Points (PUBLISHED DAYS ONLY) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            // Criteria:
            //   a) Flat bonus to winner's class
            //   b) Flat bonus to runner-up's class
            //   c) Participation-rate bonus â€” fair across class sizes:
            //      count how many students in the class scored max (2/2)
            //      divide by class strength â†’ multiply by quizMaxPts
            //      if strength not set, falls back to raw max-correct Ã— pts

            const quizResultsSnap = await getDb().ref('quizResults').once('value');
            const publishedDates    = new Set();
            const quizWinnersByDate = {};

            if (quizResultsSnap.exists()) {
                quizResultsSnap.forEach(dateNode => {
                    const res = dateNode.val();
                    if (res && res.winner && res.runnerUp) {
                        publishedDates.add(dateNode.key);
                        quizWinnersByDate[dateNode.key] = {
                            winnerClass: res.winner.class  || '',
                            runnerClass: res.runnerUp.class || ''
                        };
                    }
                });
            }

            if (publishedDates.size > 0) {
                const quizSubSnap = await getDb().ref('quizSubmissions').once('value');
                if (quizSubSnap.exists()) {
                    quizSubSnap.forEach(dateNode => {
                        const date = dateNode.key;
                        if (!publishedDates.has(date)) return;

                        const w = quizWinnersByDate[date];

                        // a) Winner class bonus
                        if (w.winnerClass && quizPts[w.winnerClass] !== undefined)
                            quizPts[w.winnerClass] += cfg.quizWinnerPts;

                        // b) Runner-up class bonus
                        if (w.runnerClass && quizPts[w.runnerClass] !== undefined)
                            quizPts[w.runnerClass] += cfg.quizRunnerUpPts;

                        // c) Participation-rate bonus per class
                        // Count students who scored the maximum (2/2) per class
                        const classMaxCount  = {}; // how many got max score
                        const classAnyCount  = {}; // how many attempted at all
                        const maxPossible    = 2;  // quiz has 2 questions

                        dateNode.forEach(subNode => {
                            const s  = subNode.val();
                            const cl = s.studentClass || '';
                            if (!LB_CLASSES.includes(cl)) return;
                            classAnyCount[cl]  = (classAnyCount[cl]  || 0) + 1;
                            if ((parseInt(s.score) || 0) >= maxPossible)
                                classMaxCount[cl] = (classMaxCount[cl] || 0) + 1;
                        });

                        LB_CLASSES.forEach(cl => {
                            if (!classAnyCount[cl]) return; // class didn't play
                            const strength = lbClassStrengths[cl.replace(/[.\[\]#$\/]/g,'_')]
                                          || lbClassStrengths[cl]
                                          || 0;
                            const topCount = classMaxCount[cl] || 0;
                            let bonus = 0;
                            if (strength > 0) {
                                // Fair formula: (top scorers / class size) Ã— max pts
                                bonus = Math.round((topCount / strength) * cfg.quizMaxPts * 10) / 10;
                            } else {
                                // Fallback if strength not set: just use topCount Ã— 1
                                bonus = topCount;
                            }
                            if (quizPts[cl] !== undefined) quizPts[cl] += bonus;
                        });
                    });
                }
            }

            // â”€â”€ 3. Published Youthfest Event Results â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            // Class-based events: winner class = highest total â†’ gets winnerPts
            // Individual events:  jury marks rows are CLASS__pN keys; we group by origclass,
            //                     take the best score per class, then rank classes by that best score.
            //                     Winner class + runner-up class get points (same class can get both).
            const setupSnap = await getDb().ref('jurySetup').once('value');
            if (setupSnap.exists()) {
                for (const [evName, setup] of Object.entries(setupSnap.val())) {
                    if (!setup.resultsPublished) continue;
                    const mSnap = await getDb().ref('juryMarks/' + evName).once('value');
                    if (!mSnap.exists()) continue;

                    const isIndividual  = (setup.eventType === 'individual');
                    const isMultiteam   = (setup.eventType === 'multiteam');
                    const j1 = mSnap.val().jury1 || {}, j2 = mSnap.val().jury2 || {};
                    const allK = new Set([...Object.keys(j1), ...Object.keys(j2)]);

                    if (isIndividual || isMultiteam) {
                        // Individual: rows are CLASS__pN  |  Multi-team: rows are CLASS__tN
                        // Both follow the same rule: group rows by their source class,
                        // take the best average score per class, rank classes by that best score.
                        const bestPerClass = {};
                        allK.forEach(sk => {
                            const d1 = j1[sk], d2 = j2[sk];
                            // Resolve original class from stored originalClassName or parse key prefix
                            let cls = (d1 && d1.originalClassName) || (d2 && d2.originalClassName) || '';
                            if (!cls) {
                                // Key format: SANITISED_CLASS__pN  or  SANITISED_CLASS__tN
                                const match = sk.match(/^(.+?)__[pt]\d+$/);
                                if (match) {
                                    const sanitisedPrefix = match[1];
                                    cls = LB_CLASSES.find(c => c.replace(/[.\[\]#$\/\s]/g,'_') === sanitisedPrefix) || sanitisedPrefix;
                                } else {
                                    cls = sk;
                                }
                            }
                            let t1=0, t2=0;
                            if(d1&&d1.marks)(Array.isArray(d1.marks)?d1.marks:Object.values(d1.marks)).forEach(m=>t1+=(m||0));
                            if(d2&&d2.marks)(Array.isArray(d2.marks)?d2.marks:Object.values(d2.marks)).forEach(m=>t2+=(m||0));
                            const avg = (t1 + t2) / 2;
                            if (bestPerClass[cls] === undefined || avg > bestPerClass[cls]) {
                                bestPerClass[cls] = avg;
                            }
                        });
                        // Rank classes by their best performer / best team
                        const evRes = Object.entries(bestPerClass).map(([cls, best]) => ({cls, avg: best}));
                        evRes.sort((a,b) => b.avg - a.avg);
                        if (evRes[0] && resultPts[evRes[0].cls] !== undefined) resultPts[evRes[0].cls] += cfg.winnerPts;
                        if (evRes[1] && resultPts[evRes[1].cls] !== undefined) resultPts[evRes[1].cls] += cfg.runnerUpPts;
                        // Edge case: top 2 both from same class â†’ that class gets both points
                        if (evRes[0] && evRes[1] && evRes[0].cls === evRes[1].cls && resultPts[evRes[0].cls] !== undefined) {
                            resultPts[evRes[0].cls] += cfg.runnerUpPts;
                        }
                    } else {
                        // Class-based: original logic
                        const evRes = [];
                        allK.forEach(sk => {
                            const d1=j1[sk], d2=j2[sk];
                            const cls=(d1&&d1.originalClassName)||(d2&&d2.originalClassName)||sk;
                            let t1=0,t2=0;
                            if(d1&&d1.marks)(Array.isArray(d1.marks)?d1.marks:Object.values(d1.marks)).forEach(m=>t1+=(m||0));
                            if(d2&&d2.marks)(Array.isArray(d2.marks)?d2.marks:Object.values(d2.marks)).forEach(m=>t2+=(m||0));
                            evRes.push({cls,avg:(t1+t2)/2});
                        });
                        evRes.sort((a,b)=>b.avg-a.avg);
                        if(evRes[0]&&resultPts[evRes[0].cls]!==undefined) resultPts[evRes[0].cls]+=cfg.winnerPts;
                        if(evRes[1]&&resultPts[evRes[1].cls]!==undefined) resultPts[evRes[1].cls]+=cfg.runnerUpPts;
                    }
                }
            }

            // â”€â”€ 4. Custom Criteria â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            const customSnap = await getDb().ref('leaderboardConfig/customCriteria').once('value');
            if (customSnap.exists()) {
                customSnap.forEach(critNode => {
                    const crit = critNode.val();
                    if (!crit || !crit.points) return;
                    Object.keys(crit.points).forEach(k => {
                        LB_CLASSES.forEach(cls => {
                            if (cls.replace(/[.\[\]#$\/]/g,'_') === k && customPts[cls] !== undefined)
                                customPts[cls] += (crit.points[k] || 0);
                        });
                    });
                });
            }

            // â”€â”€ 5. Scavenger Hunt Points â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            const shPts = init();
            try {
                const [shSubSnap, shTaskSnap, shWinSnap] = await Promise.all([
                    getDb().ref('scavengerHunt/submissions').once('value'),
                    getDb().ref('scavengerHunt/tasks').once('value'),
                    getDb().ref('scavengerHunt/winner').once('value')
                ]);
                const shSubs  = shSubSnap.val()  || {};
                const shTasks = shTaskSnap.val() || {};
                const totalTasks = Object.keys(shTasks).length;
                const shWinner = shWinSnap.val() || null;

                // Per-student: task pts + completion bonus
                Object.values(shSubs).forEach(ss => {
                    const first = Object.values(ss)[0] || {};
                    const cls = first.studentClass || '';
                    if (shPts[cls] === undefined) return;
                    let approved = 0;
                    Object.values(ss).forEach(sub => { if (sub.status === 'approved') approved++; });
                    shPts[cls] += approved * cfg.shTaskPts;
                    if (totalTasks > 0 && approved >= totalTasks) shPts[cls] += cfg.shCompletePts;
                });

                // Winner / runner-up class bonus
                if (shWinner) {
                    const wCls  = shWinner.winner   ? shWinner.winner.cls   : '';
                    const ruCls = shWinner.runnerUp ? shWinner.runnerUp.cls : '';
                    if (wCls  && shPts[wCls]  !== undefined) shPts[wCls]  += cfg.shWinnerPts;
                    if (ruCls && shPts[ruCls] !== undefined) shPts[ruCls] += cfg.shRunnerUpPts;
                }
            } catch(e) { console.warn('SH points error:', e); }

            // â”€â”€ 6. Speed Slide Challenge Points â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            const sscPts = init();
            try {
                const sscSnap = await getDb().ref('speedSlide/submissions').once('value');
                if (sscSnap.exists()) {
                    // ALL approved submissions add to class total (not just best)
                    sscSnap.forEach(child => {
                        const s = child.val();
                        if (!s || !s.class || s.points === undefined) return;
                        if (s.status !== 'approved') return;
                        if (sscPts[s.class] !== undefined)
                            sscPts[s.class] += Math.floor(s.points / 10) * (cfg.sscScoreFactor || 1);
                    });
                }
            } catch(e) { console.warn('SSC points error:', e); }

            // â”€â”€ 7. Merge, sort, render â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            const ranked = LB_CLASSES.map(cls => {
                const total=(yfPts[cls]||0)+(quizPts[cls]||0)+(resultPts[cls]||0)+(customPts[cls]||0)+(shPts[cls]||0)+(sscPts[cls]||0);
                return {cls,yfPts:yfPts[cls]||0,quizPts:quizPts[cls]||0,resultPts:resultPts[cls]||0,customPts:customPts[cls]||0,shPts:shPts[cls]||0,sscPts:sscPts[cls]||0,total};
            }).sort((a,b)=>b.total-a.total||b.yfPts-a.yfPts||b.quizPts-a.quizPts);

            const maxTotal = ranked[0]?.total || 1;
            renderPodium(ranked.slice(0,3));
            renderTable(ranked, maxTotal);

            const now = new Date();
            document.getElementById('lbLastUpdated').textContent =
                'â± Last updated: ' + now.toLocaleTimeString('en-IN',{hour:'2-digit',minute:'2-digit',second:'2-digit'})
                + ' Â· Quiz: ' + publishedDates.size + ' day' + (publishedDates.size!==1?'s':'')+' counted';

        } catch (err) {
            console.error('Leaderboard error:', err);
            document.getElementById('lbPodium').innerHTML='<div class="lb-empty">âš ï¸ Could not load data. Please refresh.</div>';
            document.getElementById('lbTableBody').innerHTML='<tr><td colspan="9" class="lb-empty">âš ï¸ Could not load data.</td></tr>';
        }
    }

    function medalEmoji(rank) { return ['ðŸ¥‡','ðŸ¥ˆ','ðŸ¥‰'][rank]||''; }
    function podiumEmoji(rank) { return ['1ï¸âƒ£','2ï¸âƒ£','3ï¸âƒ£'][rank]||''; }

    function renderPodium(top3) {
        const podium = document.getElementById('lbPodium');
        if (!top3||top3.length===0||top3[0].total===0) {
            podium.innerHTML='<div class="lb-empty">No scores yet. Scores will appear once events begin! ðŸŽ‰</div>';
            return;
        }
        const order=[top3[1],top3[0],top3[2]].filter(Boolean);
        const posClass=['lb-pos-2','lb-pos-1','lb-pos-3'];
        const actualRank=[2,1,3];
        let html='';
        order.forEach((entry,i)=>{
            const rank=actualRank[i], isFirst=rank===1;
            html+=`<div class="lb-podium-slot ${posClass[i]}">
                <div class="lb-podium-name">${isFirst?'ðŸ‘‘ ':''}${entry.cls}</div>
                <div class="lb-podium-score">${entry.total} pts</div>
                <div class="lb-podium-block">${podiumEmoji(rank-1)}</div>
            </div>`;
        });
        podium.innerHTML=html;
    }

    function renderTable(ranked, maxTotal) {
        const tbody=document.getElementById('lbTableBody');
        if(!ranked||ranked.length===0){tbody.innerHTML='<tr><td colspan="9" class="lb-empty">No data yet!</td></tr>';return;}
        let html='';
        ranked.forEach((entry,i)=>{
            const rank=i+1;
            const rankClass=rank<=3?`lb-rank-${rank}`:'lb-rank-other';
            const rankMedal=rank<=3?medalEmoji(rank-1):rank;
            const barPct=maxTotal>0?Math.round((entry.total/maxTotal)*100):0;
            const delay=(i*0.05).toFixed(2);
            const rowBg=rank===1?'background:linear-gradient(90deg,#fffbea,#fff);':rank===2?'background:linear-gradient(90deg,#f8f8f8,#fff);':rank===3?'background:linear-gradient(90deg,#fff5f0,#fff);':'';
            const resBadge=entry.resultPts>0?`<span class="lb-score-tag" style="background:#d4edda;color:#155724;border:1px solid #28a745">ðŸ† ${entry.resultPts}</span> `:'';
            const custBadge=entry.customPts>0?`<span class="lb-score-tag" style="background:#e8f4fd;color:#0c5460;border:1px solid #17a2b8">âœ¨ ${entry.customPts}</span>`:'';
            const shBadge=entry.shPts>0?`<span class="lb-score-tag" style="background:#f3e5f5;color:#6a1b9a;border:1px solid #ce93d8">ðŸ—ºï¸ ${entry.shPts}</span>`:'<span style="color:#ddd">â€”</span>';
            const sscBadge=entry.sscPts>0?`<span class="lb-score-tag" style="background:#e3f2fd;color:#0d47a1;border:1px solid #90caf9">ðŸ§© ${entry.sscPts}</span>`:'<span style="color:#ddd">â€”</span>';
            html+=`<tr style="${rowBg}animation-delay:${delay}s">
                <td><span class="lb-rank-badge ${rankClass}">${rankMedal}</span></td>
                <td><span class="lb-class-chip">${entry.cls}</span></td>
                <td><span class="lb-score-tag lb-score-yf">ðŸŽ¤ ${entry.yfPts}</span></td>
                <td><span class="lb-score-tag lb-score-quiz">ðŸ§  ${entry.quizPts}</span></td>
                <td>${resBadge}${custBadge}${(entry.resultPts===0&&entry.customPts===0)?'<span style="color:#ddd">â€”</span>':''}</td>
                <td>${shBadge}</td>
                <td>${sscBadge}</td>
                <td><span class="lb-pts-total">${entry.total}</span> <span class="lb-pts-event">pts</span></td>
                <td><div class="lb-bar-wrap"><div class="lb-bar-fill" style="width:${barPct}%"></div></div></td>
            </tr>`;
        });
        tbody.innerHTML=html;
    }

    // ============================================================
    //  ACTIVITY BANNERS ENGINE
    //  Shows live banners for: Quiz (if available today),
    //  Scavenger Hunt (active tasks today), Speed Slide, 
    //  and a "coming soon" banner for Speed Slide.
    //  Renders into #activityBannersContainer on page load.
    // ============================================================

    async function initActivityBanners() {
        const container = document.getElementById('activityBannersContainer');
        if (!container) return;

        // â”€â”€ helper: today string â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        const todayISO = (function() {
            const d = new Date();
            return d.getFullYear() + '-' + String(d.getMonth()+1).padStart(2,'0') + '-' + String(d.getDate()).padStart(2,'0');
        })();
        const todayFmt = new Date(todayISO + 'T00:00:00').toLocaleDateString('en-IN',{weekday:'long',day:'2-digit',month:'long',year:'numeric'});
        const nowMs = Date.now();

        let html = '';

        // â”€â”€ 1. QUIZ BANNER (only if today has questions) â”€â”€â”€â”€â”€â”€â”€â”€â”€
        try {
            const qSnap = await db.ref('quizQuestions/' + todayISO).once('value');
            if (qSnap.exists()) {
                html += `
                <div class="act-banner-wrap" id="actQuizBanner"
                     style="background:linear-gradient(135deg,#1a6b2a 0%,#28a745 55%,#20c997 100%);
                            animation-delay:.05s;margin-bottom:12px;">
                    <div class="act-banner-icon" style="animation-delay:.2s">ðŸ†</div>
                    <div class="act-banner-body">
                        <div class="act-banner-title" style="color:white">
                            <span class="live-dot" style="background:#ffe082;box-shadow:0 0 6px #ffe082"></span>
                            Today's Quiz is Available!
                        </div>
                        <div class="act-banner-sub" style="color:rgba(255,255,255,.92)">
                            ðŸ“… ${todayFmt} &nbsp;Â·&nbsp; âš¡ Be the fastest to answer correctly!
                        </div>
                        <div class="quiz-cdown-chip">
                            â³ Quiz ends in: <span id="actQuizCountdown">--:--:--</span>
                            <span style="opacity:.7;font-size:.82em;font-weight:600">(closes at 11:59 PM today)</span>
                        </div>
                    </div>
                    <button class="act-banner-cta"
                            style="background:#ffe082;color:#1a5e20;"
                            onclick="document.getElementById('competitionType').value='dailyquiz';handleCompetitionChange();document.getElementById('userType').value='';handleUserTypeChange();setTimeout(()=>{const el=document.getElementById('quizLoginPhone');if(el){el.scrollIntoView({behavior:'smooth',block:'center'});el.focus();}},100)">
                        ðŸš€ Play Now
                    </button>
                </div>`;
            }
        } catch(e) { console.warn('actBanner quiz check:', e.message); }

        // â”€â”€ 2. SCAVENGER HUNT BANNER (active tasks today) â”€â”€â”€â”€â”€â”€â”€â”€
        try {
            const shSnap = await db.ref('scavengerHunt/tasks').once('value');
            if (shSnap.exists()) {
                const allTasks = Object.entries(shSnap.val() || {})
                    .map(([k,v]) => ({id:k,...v}))
                    .sort((a,b) => (a.order||0)-(b.order||0));

                // Tasks that are currently active (started, not yet expired)
                const activeTasks = allTasks.filter(t => {
                    const started  = !t.availableFrom || new Date(t.availableFrom).getTime() <= nowMs;
                    const notEnded = !t.deadline      || new Date(t.deadline).getTime()      >  nowMs;
                    return started && notEnded;
                });

                // Tasks unlocking today (announcements)
                const todayTasks = allTasks.filter(t => {
                    if (!t.availableFrom) return false;
                    const d = new Date(t.availableFrom);
                    return d.getFullYear()  === new Date().getFullYear()  &&
                           d.getMonth()     === new Date().getMonth()     &&
                           d.getDate()      === new Date().getDate();
                });

                if (activeTasks.length > 0) {
                    const taskPills = activeTasks.slice(0,4).map(t =>
                        `<span class="sh-task-pill">ðŸŽ¯ Task ${t.order||'?'}: ${t.name.length>28?t.name.slice(0,26)+'â€¦':t.name}</span>`
                    ).join('');

                    const newToday = todayTasks.length > 0
                        ? `<div style="margin-top:6px;font-size:.82em;color:#ffe082;font-weight:700">ðŸ†• ${todayTasks.length} new task${todayTasks.length>1?'s':''} just unlocked today!</div>`
                        : '';

                    html += `
                    <div class="act-banner-wrap" id="actShBanner"
                         style="background:linear-gradient(135deg,#4a148c 0%,#6a1b9a 50%,#c44569 100%);
                                animation-delay:.15s;margin-bottom:12px;animation:glowPurple 3s ease-in-out infinite,slideInUp .45s ease-out both;">
                        <div class="act-banner-icon" style="animation-delay:.4s">ðŸ—ºï¸</div>
                        <div class="act-banner-body">
                            <div class="act-banner-title" style="color:white">
                                <span class="live-dot" style="background:#ff4081;box-shadow:0 0 6px #ff4081"></span>
                                Scavenger Hunt is Live!
                            </div>
                            <div class="act-banner-sub" style="color:rgba(255,255,255,.9)">
                                ${activeTasks.length} active task${activeTasks.length>1?'s':''} waiting for you â€” find, photo &amp; win!
                            </div>
                            <div style="margin-top:7px">${taskPills}</div>
                            ${newToday}
                        </div>
                        <button class="act-banner-cta"
                                style="background:#ffe082;color:#4a148c;"
                                onclick="document.getElementById('competitionType').value='scavengerhunt';handleCompetitionChange();document.getElementById('userType').value='';handleUserTypeChange();setTimeout(()=>{const el=document.getElementById('scavengerHuntLogin');if(el){el.scrollIntoView({behavior:'smooth',block:'center'});}},100)">
                            ðŸŽ¯ Hunt Now!
                        </button>
                    </div>`;
                }
            }
        } catch(e) { console.warn('actBanner SH check:', e.message); }

        // â”€â”€ 3. SPEED SLIDE BANNER (always shown as coming soon / live) â”€â”€
        html += `
        <div class="act-banner-wrap" id="actSsBanner"
             style="background:linear-gradient(135deg,#e65100 0%,#f57c00 45%,#ffa000 100%);
                    animation-delay:.25s;margin-bottom:12px;animation:glowAmber 3s ease-in-out infinite,slideInUp .45s ease-out .25s both;">
            <div class="act-banner-icon" style="animation-delay:.6s">ðŸ§©</div>
            <div class="act-banner-body">
                <div class="act-banner-title" style="color:white">
                    ðŸŽ¯ Speed Slide Challenge â€” Coming Soon!
                </div>
                <div class="act-banner-sub" style="color:rgba(255,255,255,.92)">
                    Race against classmates to reassemble a scrambled photo the fastest.<br>
                    <span style="color:#ffe082;font-weight:700">âš¡ New event at Spurthi Youth Fest 2026 â€” stay tuned!</span>
                </div>
            </div>
            <button class="act-banner-cta"
                    style="background:#ffe082;color:#bf360c;"
                    onclick="document.getElementById('userType').value='speedslide';handleUserTypeChange();window.scrollTo({top:document.getElementById('loginSection')?.offsetTop||0,behavior:'smooth'})">
                ðŸ‘€ Learn More
            </button>
        </div>`;

        container.innerHTML = html;

        // â”€â”€ Start quiz countdown if banner was rendered â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        const cdownEl = document.getElementById('actQuizCountdown');
        if (cdownEl) {
            (function tickCdown() {
                const now2 = new Date(), end2 = new Date();
                end2.setHours(23, 59, 59, 0);
                const diff = end2 - now2;
                if (diff <= 0) { cdownEl.textContent = 'CLOSED'; cdownEl.style.color = '#ffcdd2'; return; }
                const h = Math.floor(diff/3600000), m = Math.floor((diff%3600000)/60000), s = Math.floor((diff%60000)/1000);
                cdownEl.textContent = String(h).padStart(2,'0')+':'+String(m).padStart(2,'0')+':'+String(s).padStart(2,'0');
                setTimeout(tickCdown, 1000);
            })();
        }
    }

    // â”€â”€ Auto-init after Firebase is ready â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    (function waitForDbThenBanners() {
        function tryBanners() {
            if (typeof db !== 'undefined' && db) { initActivityBanners(); }
            else { setTimeout(tryBanners, 600); }
        }
        tryBanners();
    })();

    // â”€â”€ Auto-load â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    (function lbInit() {
        function tryLoad() {
            if (typeof db !== 'undefined' && db) {
                loadLeaderboard();
                setInterval(loadLeaderboard, 60000);
            } else {
                setTimeout(tryLoad, 800);
            }
        }
        tryLoad();
    })();

    // ============================================================
    //  LEADERBOARD ADMIN PANEL FUNCTIONS (Super Admin only)
    // ============================================================

    async function toggleLeaderboardPublish() {
        const btn    = document.getElementById('lbPublishBtn');
        const status = document.getElementById('lbVisibilityStatus');
        try {
            const snap = await getDb().ref('leaderboardConfig/published').once('value');
            const current = snap.val() === true;
            const next = !current;
            await getDb().ref('leaderboardConfig/published').set(next);
            updateLbPublishUI(next);
            showLbAdminMsg(next
                ? 'âœ… Leaderboard is now LIVE â€” students can see it!'
                : 'ðŸ”’ Leaderboard hidden â€” students cannot see it.',
                next ? 'success' : 'error');
        } catch(err) {
            showLbAdminMsg('âŒ Error: ' + err.message, 'error');
        }
    }

    function updateLbPublishUI(isPublished) {
        const btn    = document.getElementById('lbPublishBtn');
        const status = document.getElementById('lbVisibilityStatus');
        if (!btn || !status) return;
        if (isPublished) {
            status.textContent = 'âœ… LIVE â€” Students can see it';
            status.style.color = '#69f0ae';
            btn.textContent    = 'ðŸ”’ Hide Leaderboard';
            btn.className      = 'btn btn-danger';
        } else {
            status.textContent = 'ðŸ”’ Hidden from students';
            status.style.color = '#ffd700';
            btn.textContent    = 'ðŸ“¢ Publish Leaderboard';
            btn.className      = 'btn btn-success';
        }
    }

    async function loadLbPublishStatus() {
        try {
            const snap = await getDb().ref('leaderboardConfig/published').once('value');
            updateLbPublishUI(snap.val() === true);
        } catch(e) {
            updateLbPublishUI(false);
        }
    }

    async function saveLbConfig() {
        const btn = document.querySelector('[onclick="saveLbConfig()"]');
        const okEl  = document.getElementById('lbCfgSaveMsg');
        const errEl = document.getElementById('lbCfgErrMsg');
        if (okEl)  okEl.style.display  = 'none';
        if (errEl) errEl.style.display = 'none';
        if (btn) { btn.disabled = true; btn.textContent = 'â³ Savingâ€¦'; }
        const yfPts   = parseInt(document.getElementById('lbCfgYfPts').value)      || 10;
        const winPts  = parseInt(document.getElementById('lbCfgWinPts').value)     || 50;
        const runPts  = parseInt(document.getElementById('lbCfgRunPts').value)     || 30;
        const qWin    = parseInt(document.getElementById('lbCfgQuizWinPts').value) || 20;
        const qRun    = parseInt(document.getElementById('lbCfgQuizRunPts').value) || 10;
        const qMax    = parseInt(document.getElementById('lbCfgQuizMaxPts').value) || 10;
        const shWin   = parseInt(document.getElementById('lbCfgShWinPts').value)   || 30;
        const shRun   = parseInt(document.getElementById('lbCfgShRunPts').value)   || 15;
        const shTask  = parseInt(document.getElementById('lbCfgShTaskPts').value)  || 5;
        const shComp  = parseInt(document.getElementById('lbCfgShCompletePts').value) || 20;
        const sscScore= parseInt(document.getElementById('lbCfgSscScorePts').value)|| 1;
        try {
            await getDb().ref('leaderboardConfig/scoring').set({
                yfPtsPerEvent: yfPts, winnerPts: winPts, runnerUpPts: runPts,
                quizWinnerPts: qWin, quizRunnerUpPts: qRun, quizMaxPts: qMax,
                shWinnerPts: shWin, shRunnerUpPts: shRun, shTaskPts: shTask, shCompletePts: shComp,
                sscScoreFactor: sscScore,
                updatedAt: new Date().toISOString()
            });
            document.getElementById('lbWinPtsDisplay').textContent = winPts;
            document.getElementById('lbRunPtsDisplay').textContent = runPts;
            if (okEl)  { okEl.style.display  = 'inline-block'; setTimeout(() => okEl.style.display  = 'none', 4000); }
            showLbAdminMsg('âœ… Config saved! Leaderboard refreshes in â‰¤60 s.', 'success');
        } catch(err) {
            if (errEl) { errEl.textContent = 'âŒ Error: ' + err.message; errEl.style.display = 'inline-block'; setTimeout(() => errEl.style.display = 'none', 6000); }
            showLbAdminMsg('âŒ Error: ' + err.message, 'error');
        } finally {
            if (btn) { btn.disabled = false; btn.textContent = 'ðŸ’¾ Save Config'; }
        }
    }

    async function loadLbConfigIntoForm() {
        await loadLbPublishStatus();
        try {
            const [cfgSnap, strSnap] = await Promise.all([
                getDb().ref('leaderboardConfig/scoring').once('value'),
                getDb().ref('leaderboardConfig/classStrengths').once('value')
            ]);
            if (cfgSnap.exists()) {
                const d = cfgSnap.val();
                document.getElementById('lbCfgYfPts').value       = d.yfPtsPerEvent   || 10;
                document.getElementById('lbCfgWinPts').value      = d.winnerPts        || 50;
                document.getElementById('lbCfgRunPts').value      = d.runnerUpPts      || 30;
                document.getElementById('lbCfgQuizWinPts').value  = d.quizWinnerPts    || 20;
                document.getElementById('lbCfgQuizRunPts').value  = d.quizRunnerUpPts  || 10;
                document.getElementById('lbCfgQuizMaxPts').value  = d.quizMaxPts       || 10;
                document.getElementById('lbWinPtsDisplay').textContent = d.winnerPts   || 50;
                document.getElementById('lbRunPtsDisplay').textContent = d.runnerUpPts || 30;
                if (document.getElementById('lbCfgShWinPts'))      document.getElementById('lbCfgShWinPts').value      = d.shWinnerPts   || 30;
                if (document.getElementById('lbCfgShRunPts'))      document.getElementById('lbCfgShRunPts').value      = d.shRunnerUpPts || 15;
                if (document.getElementById('lbCfgShTaskPts'))     document.getElementById('lbCfgShTaskPts').value     = d.shTaskPts     || 5;
                if (document.getElementById('lbCfgShCompletePts')) document.getElementById('lbCfgShCompletePts').value = d.shCompletePts || 20;
                if (document.getElementById('lbCfgSscScorePts'))   document.getElementById('lbCfgSscScorePts').value   = d.sscScoreFactor|| 1;
            }
            // Build class strength grid
            const savedStr = strSnap.exists() ? strSnap.val() : {};
            const grid = document.getElementById('lbClassStrengthGrid');
            if (grid) {
                let html = '';
                LB_CLASSES.forEach(cls => {
                    const safeKey = cls.replace(/[.\[\]#$\/]/g,'_');
                    const val = savedStr[safeKey] || savedStr[cls] || '';
                    const safeId = 'lbStr_' + cls.replace(/[^a-zA-Z0-9]/g,'_');
                    html += `<div style="display:flex;align-items:center;gap:6px;background:#f1f8e9;padding:7px 10px;border-radius:6px;border:1px solid #a5d6a7">
                        <span style="font-size:0.78em;color:#1b5e20;flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap" title="${cls}">${cls}</span>
                        <input type="number" id="${safeId}" value="${val}" min="1" max="200" placeholder="Count"
                            style="width:65px;padding:4px 6px;border:1px solid #a5d6a7;border-radius:4px;text-align:center;font-size:0.85em">
                    </div>`;
                });
                grid.innerHTML = html;
            }
        } catch(e) {
            console.error('loadLbConfigIntoForm error:', e);
            const grid = document.getElementById('lbClassStrengthGrid');
            if (grid) grid.innerHTML = '<p style="color:red;font-size:12px">âŒ Failed to load: ' + e.message + '</p>';
        }
    }

    async function saveLbClassStrengths() {
        const btn = document.querySelector('[onclick="saveLbClassStrengths()"]');
        const okEl  = document.getElementById('lbStrSaveMsg');
        const errEl = document.getElementById('lbStrErrMsg');
        if (okEl)  okEl.style.display  = 'none';
        if (errEl) errEl.style.display = 'none';
        if (btn) { btn.disabled = true; btn.textContent = 'â³ Savingâ€¦'; }
        const obj = {};
        LB_CLASSES.forEach(cls => {
            const safeId  = 'lbStr_' + cls.replace(/[^a-zA-Z0-9]/g,'_');
            const safeKey = cls.replace(/[.\[\]#$\/]/g,'_');
            const inp = document.getElementById(safeId);
            if (inp && inp.value) obj[safeKey] = parseInt(inp.value) || 0;
        });
        try {
            await getDb().ref('leaderboardConfig/classStrengths').set(obj);
            if (okEl)  { okEl.style.display  = 'inline-block'; setTimeout(() => okEl.style.display  = 'none', 4000); }
            showLbAdminMsg('âœ… Class strengths saved! Quiz participation rates updated.', 'success');
        } catch(err) {
            if (errEl) { errEl.textContent = 'âŒ ' + err.message; errEl.style.display = 'inline-block'; setTimeout(() => errEl.style.display = 'none', 6000); }
            showLbAdminMsg('âŒ Error: ' + err.message, 'error');
        } finally {
            if (btn) { btn.disabled = false; btn.textContent = 'ðŸ’¾ Save Class Strengths'; }
        }
    }

    async function loadLbPublishedResults() {
        const container = document.getElementById('lbPublishedResultsList');
        container.innerHTML = '<p style="color:#aaa;font-size:13px">Loadingâ€¦</p>';
        try {
            const cfg = await getLbConfig();
            const snap = await getDb().ref('jurySetup').once('value');
            if (!snap.exists()) {
                container.innerHTML = '<p style="color:#aaa;font-size:13px">No events set up yet.</p>';
                return;
            }
            let html = '<div class="table-wrapper"><table style="min-width:500px"><thead><tr><th>Event</th><th>Status</th><th>Winner Class</th><th>Runner-Up Class</th></tr></thead><tbody>';
            for (const [evName, setup] of Object.entries(snap.val())) {
                const pub = setup.resultsPublished ? 'âœ… Published' : 'â³ Not published';
                let winner='â€”', runnerUp='â€”';
                if (setup.resultsPublished) {
                    const mSnap = await getDb().ref('juryMarks/'+evName).once('value');
                    if (mSnap.exists()) {
                        const j1=mSnap.val().jury1||{}, j2=mSnap.val().jury2||{};
                        const allK=new Set([...Object.keys(j1),...Object.keys(j2)]);
                        const isIndividualOrMulti = (setup.eventType === 'individual' || setup.eventType === 'multiteam');

                        if (isIndividualOrMulti) {
                            // Best score per class
                            const bestPerClass = {};
                            allK.forEach(sk => {
                                const d1=j1[sk], d2=j2[sk];
                                let cls = (d1&&d1.originalClassName)||(d2&&d2.originalClassName)||'';
                                if (!cls) {
                                    const m = sk.match(/^(.+?)__[pt]\d+$/);
                                    if (m) cls = LB_CLASSES.find(c=>c.replace(/[.\[\]#$\/\s]/g,'_')===m[1]) || m[1];
                                    else cls = sk;
                                }
                                let t1=0,t2=0;
                                if(d1&&d1.marks)(Array.isArray(d1.marks)?d1.marks:Object.values(d1.marks)).forEach(m=>t1+=(m||0));
                                if(d2&&d2.marks)(Array.isArray(d2.marks)?d2.marks:Object.values(d2.marks)).forEach(m=>t2+=(m||0));
                                const avg=(t1+t2)/2;
                                if (bestPerClass[cls]===undefined || avg>bestPerClass[cls]) bestPerClass[cls]=avg;
                            });
                            const evR=Object.entries(bestPerClass).map(([c,a])=>({cls:c,avg:a})).sort((a,b)=>b.avg-a.avg);
                            if(evR[0]) winner=`<strong>${evR[0].cls}</strong> <span style="color:#c44569">+${cfg.winnerPts}pts</span>`;
                            if(evR[1]) runnerUp=`<strong>${evR[1].cls}</strong> <span style="color:#666">+${cfg.runnerUpPts}pts</span>`;
                        } else {
                            const evR=[];
                            allK.forEach(sk=>{
                                const d1=j1[sk],d2=j2[sk];
                                const cls=(d1&&d1.originalClassName)||(d2&&d2.originalClassName)||sk;
                                let t1=0,t2=0;
                                if(d1&&d1.marks)(Array.isArray(d1.marks)?d1.marks:Object.values(d1.marks)).forEach(m=>t1+=(m||0));
                                if(d2&&d2.marks)(Array.isArray(d2.marks)?d2.marks:Object.values(d2.marks)).forEach(m=>t2+=(m||0));
                                evR.push({cls,avg:(t1+t2)/2});
                            });
                            evR.sort((a,b)=>b.avg-a.avg);
                            if(evR[0]) winner=`<strong>${evR[0].cls}</strong> <span style="color:#c44569">+${cfg.winnerPts}pts</span>`;
                            if(evR[1]) runnerUp=`<strong>${evR[1].cls}</strong> <span style="color:#666">+${cfg.runnerUpPts}pts</span>`;
                        }
                    }
                }
                const typeLabel = setup.eventType === 'individual' ? ' <span style="font-size:10px;background:#e3f2fd;color:#1565c0;padding:2px 6px;border-radius:4px">Individual</span>' 
                                : setup.eventType === 'multiteam'  ? ' <span style="font-size:10px;background:#fff3e0;color:#e65100;padding:2px 6px;border-radius:4px">Multi-Team</span>' 
                                : '';
                html+=`<tr><td><strong>${evName}</strong>${typeLabel}</td><td style="color:${setup.resultsPublished?'#155724':'#856404'}">${pub}</td><td>${winner}</td><td>${runnerUp}</td></tr>`;
            }
            html+='</tbody></table></div>';
            container.innerHTML=html;
        } catch(err) {
            container.innerHTML='<p style="color:red">Error: '+err.message+'</p>';
        }
    }

    async function addLbCriterion() {
        const name = document.getElementById('lbNewCriterionName').value.trim();
        if (!name) { showLbAdminMsg('Please enter a criterion name.','error'); return; }
        try {
            const key = getDb().ref('leaderboardConfig/customCriteria').push().key;
            await getDb().ref('leaderboardConfig/customCriteria/'+key).set({name,createdAt:new Date().toISOString(),points:{}});
            document.getElementById('lbNewCriterionName').value='';
            showLbAdminMsg('âœ… Criterion "'+name+'" added!','success');
            loadLbCriteriaList();
        } catch(err) { showLbAdminMsg('âŒ Error: '+err.message,'error'); }
    }

    async function loadLbCriteriaList() {
        const container = document.getElementById('lbCriteriaList');
        container.innerHTML='<p style="color:#aaa;text-align:center;padding:20px;font-size:13px">Loadingâ€¦</p>';
        try {
            const snap = await getDb().ref('leaderboardConfig/customCriteria').once('value');
            if (!snap.exists()) {
                container.innerHTML='<p style="color:#aaa;text-align:center;padding:20px;font-size:13px">No custom criteria yet. Add one above!</p>';
                return;
            }
            let html='';
            snap.forEach(critNode=>{
                const key=critNode.key, crit=critNode.val(), pts=crit.points||{};
                html+=`<div style="background:white;border:1px solid #ffe082;border-radius:10px;padding:15px;margin-bottom:15px">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;flex-wrap:wrap;gap:8px">
                        <strong style="color:#e65100;font-size:1em">âœ¨ ${crit.name}</strong>
                        <button class="btn btn-danger btn-small" onclick="deleteLbCriterion('${key}','${crit.name.replace(/'/g,"\\'")}')">ðŸ—‘ Delete</button>
                    </div>
                    <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:8px">`;
                LB_CLASSES.forEach(cls=>{
                    const safeKey=cls.replace(/[.\[\]#$\/]/g,'_');
                    const val=pts[safeKey]||pts[cls]||0;
                    const safeId='lbPts_'+key+'_'+cls.replace(/[^a-zA-Z0-9]/g,'_');
                    html+=`<div style="display:flex;align-items:center;gap:6px;background:#fffdf0;padding:6px 10px;border-radius:6px;border:1px solid #ffe082">
                        <span style="font-size:0.78em;color:#555;flex:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis" title="${cls}">${cls}</span>
                        <input type="number" id="${safeId}" value="${val}" min="0" max="9999"
                            style="width:65px;padding:4px;border:1px solid #ddd;border-radius:4px;text-align:center;font-size:0.85em">
                    </div>`;
                });
                html+=`</div>
                    <button class="btn btn-small btn-success" onclick="saveLbCriterionPoints('${key}')" style="margin-top:12px">ðŸ’¾ Save Points for "${crit.name}"</button>
                </div>`;
            });
            container.innerHTML=html;
        } catch(err) { container.innerHTML='<p style="color:red">Error: '+err.message+'</p>'; }
    }

    async function saveLbCriterionPoints(key) {
        try {
            const snap = await getDb().ref('leaderboardConfig/customCriteria/'+key).once('value');
            const crit = snap.val();
            if (!crit) { showLbAdminMsg('Criterion not found.','error'); return; }
            const pointsObj={};
            LB_CLASSES.forEach(cls=>{
                const safeId='lbPts_'+key+'_'+cls.replace(/[^a-zA-Z0-9]/g,'_');
                const safeKey=cls.replace(/[.\[\]#$\/]/g,'_');
                const inp=document.getElementById(safeId);
                pointsObj[safeKey]=inp?(parseInt(inp.value)||0):0;
            });
            await getDb().ref('leaderboardConfig/customCriteria/'+key+'/points').set(pointsObj);
            showLbAdminMsg('âœ… Points saved for "'+crit.name+'"!','success');
        } catch(err) { showLbAdminMsg('âŒ Error: '+err.message,'error'); }
    }

    async function deleteLbCriterion(key,name) {
        if(!confirm('Delete criterion "'+name+'"?\n\nAll points for this criterion will be removed.')) return;
        try {
            await getDb().ref('leaderboardConfig/customCriteria/'+key).remove();
            showLbAdminMsg('âœ… "'+name+'" deleted.','success');
            loadLbCriteriaList();
        } catch(err) { showLbAdminMsg('âŒ Error: '+err.message,'error'); }
    }

    async function loadLbAdminPreview() {
        const container = document.getElementById('lbAdminPreview');
        const updEl     = document.getElementById('lbPreviewUpdated');
        container.innerHTML = '<p style="color:rgba(255,255,255,0.4);text-align:center;padding:30px">â³ Fetching live data from Firebaseâ€¦</p>';
        try {
            const cfg = await getLbConfig();
            const init = () => { const o={}; LB_CLASSES.forEach(c => o[c]=0); return o; };
            const yfP=init(), quizP=init(), resP=init(), custP=init();

            // â”€â”€ 1. Youthfest Registration â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            const yfSnap = await getDb().ref('youthfest-enrollments').once('value');
            if (yfSnap.exists()) yfSnap.forEach(c => {
                const d=c.val(), cl=d.classYear||d.class||'';
                if (yfP[cl] !== undefined) yfP[cl] += cfg.yfPtsPerEvent;
            });

            // â”€â”€ 2. Quiz Points (published days only) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            const qrSnap = await getDb().ref('quizResults').once('value');
            const pubDates=new Set(); const qWinMap={};
            if (qrSnap.exists()) qrSnap.forEach(dn => {
                const r=dn.val();
                if (r && r.winner && r.runnerUp) {
                    pubDates.add(dn.key);
                    qWinMap[dn.key] = { w: r.winner.class||'', ru: r.runnerUp.class||'' };
                }
            });
            if (pubDates.size > 0) {
                const qsSnap = await getDb().ref('quizSubmissions').once('value');
                if (qsSnap.exists()) qsSnap.forEach(dn => {
                    if (!pubDates.has(dn.key)) return;
                    const w = qWinMap[dn.key];
                    if (w.w  && quizP[w.w]  !== undefined) quizP[w.w]  += cfg.quizWinnerPts;
                    if (w.ru && quizP[w.ru] !== undefined) quizP[w.ru] += cfg.quizRunnerUpPts;
                    const cmx={};
                    dn.forEach(sn => {
                        const s=sn.val(), cl=s.studentClass||'';
                        if (LB_CLASSES.includes(cl)) { if(!cmx[cl]) cmx[cl]=0; if((parseInt(s.score)||0)>=2) cmx[cl]++; }
                    });
                    LB_CLASSES.forEach(cl => {
                        if (!cmx[cl]) return;
                        const str = lbClassStrengths[cl.replace(/[.\[\]#$\/]/g,'_')] || lbClassStrengths[cl] || 0;
                        const b = str>0 ? Math.round((cmx[cl]/str)*cfg.quizMaxPts*10)/10 : cmx[cl];
                        if (quizP[cl] !== undefined) quizP[cl] += b;
                    });
                });
            }

            // â”€â”€ 3. Event Results (published jury results) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            const sSnap = await getDb().ref('jurySetup').once('value');
            if (sSnap.exists()) {
                for (const [ev, setup] of Object.entries(sSnap.val())) {
                    if (!setup.resultsPublished) continue;
                    const mSnap = await getDb().ref('juryMarks/'+ev).once('value');
                    if (!mSnap.exists()) continue;
                    const j1=mSnap.val().jury1||{}, j2=mSnap.val().jury2||{};
                    const allK=new Set([...Object.keys(j1),...Object.keys(j2)]);
                    const isIndividualOrMulti = (setup.eventType === 'individual' || setup.eventType === 'multiteam');

                    if (isIndividualOrMulti) {
                        const bestPerClass = {};
                        allK.forEach(sk => {
                            const d1=j1[sk], d2=j2[sk];
                            let cls=(d1&&d1.originalClassName)||(d2&&d2.originalClassName)||'';
                            if (!cls) {
                                const m=sk.match(/^(.+?)__[pt]\d+$/);
                                if(m) cls=LB_CLASSES.find(c=>c.replace(/[.\[\]#$\/\s]/g,'_')===m[1])||m[1];
                                else cls=sk;
                            }
                            let t1=0,t2=0;
                            if(d1&&d1.marks)(Array.isArray(d1.marks)?d1.marks:Object.values(d1.marks)).forEach(m=>t1+=(m||0));
                            if(d2&&d2.marks)(Array.isArray(d2.marks)?d2.marks:Object.values(d2.marks)).forEach(m=>t2+=(m||0));
                            const avg=(t1+t2)/2;
                            if(bestPerClass[cls]===undefined||avg>bestPerClass[cls]) bestPerClass[cls]=avg;
                        });
                        const evR=Object.entries(bestPerClass).map(([c,a])=>({cls:c,avg:a})).sort((a,b)=>b.avg-a.avg);
                        if(evR[0]&&resP[evR[0].cls]!==undefined) resP[evR[0].cls]+=cfg.winnerPts;
                        if(evR[1]&&resP[evR[1].cls]!==undefined) resP[evR[1].cls]+=cfg.runnerUpPts;
                        if(evR[0]&&evR[1]&&evR[0].cls===evR[1].cls&&resP[evR[0].cls]!==undefined) resP[evR[0].cls]+=cfg.runnerUpPts;
                    } else {
                        const evR=[];
                        allK.forEach(sk => {
                            const d1=j1[sk], d2=j2[sk];
                            const cls=(d1&&d1.originalClassName)||(d2&&d2.originalClassName)||sk;
                            let t1=0,t2=0;
                            if(d1&&d1.marks)(Array.isArray(d1.marks)?d1.marks:Object.values(d1.marks)).forEach(m=>t1+=(m||0));
                            if(d2&&d2.marks)(Array.isArray(d2.marks)?d2.marks:Object.values(d2.marks)).forEach(m=>t2+=(m||0));
                            evR.push({cls, avg:(t1+t2)/2});
                        });
                        evR.sort((a,b) => b.avg-a.avg);
                        if (evR[0] && resP[evR[0].cls] !== undefined) resP[evR[0].cls] += cfg.winnerPts;
                        if (evR[1] && resP[evR[1].cls] !== undefined) resP[evR[1].cls] += cfg.runnerUpPts;
                    }
                }
            }

            // â”€â”€ 4. Custom Criteria â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            const cSnap = await getDb().ref('leaderboardConfig/customCriteria').once('value');
            if (cSnap.exists()) cSnap.forEach(cn => {
                const c=cn.val(); if(!c||!c.points) return;
                Object.keys(c.points).forEach(k => {
                    LB_CLASSES.forEach(cl => {
                        if (cl.replace(/[.\[\]#$\/]/g,'_')===k && custP[cl]!==undefined) custP[cl]+=(c.points[k]||0);
                    });
                });
            });

            // â”€â”€ 5. Scavenger Hunt Points â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            const shP = init();
            try {
                const [shSubSnap, shTaskSnap, shWinSnap] = await Promise.all([
                    getDb().ref('scavengerHunt/submissions').once('value'),
                    getDb().ref('scavengerHunt/tasks').once('value'),
                    getDb().ref('scavengerHunt/winner').once('value')
                ]);
                const shSubs = shSubSnap.val() || {};
                const totalTasks = Object.keys(shTaskSnap.val() || {}).length;
                const shWinner = shWinSnap.val() || null;
                Object.values(shSubs).forEach(ss => {
                    const first = Object.values(ss)[0] || {};
                    const cl = first.studentClass || '';
                    if (shP[cl] === undefined) return;
                    let approved = 0;
                    Object.values(ss).forEach(sub => { if (sub.status === 'approved') approved++; });
                    shP[cl] += approved * cfg.shTaskPts;
                    if (totalTasks > 0 && approved >= totalTasks) shP[cl] += cfg.shCompletePts;
                });
                if (shWinner) {
                    const wCls  = shWinner.winner   ? shWinner.winner.cls   : '';
                    const ruCls = shWinner.runnerUp ? shWinner.runnerUp.cls : '';
                    if (wCls  && shP[wCls]  !== undefined) shP[wCls]  += cfg.shWinnerPts;
                    if (ruCls && shP[ruCls] !== undefined) shP[ruCls] += cfg.shRunnerUpPts;
                }
            } catch(e) { console.warn('SH preview pts error:', e); }

            // â”€â”€ 6. Speed Slide Challenge Points â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            const sscP = init();
            try {
                const sscSnap = await getDb().ref('speedSlide/submissions').once('value');
                if (sscSnap.exists()) {
                    // ALL approved submissions add to class total
                    sscSnap.forEach(child => {
                        const s = child.val();
                        if (!s || !s.class || s.points === undefined) return;
                        if (s.status !== 'approved') return;
                        if (sscP[s.class] !== undefined)
                            sscP[s.class] += Math.floor(s.points / 10) * (cfg.sscScoreFactor || 1);
                    });
                }
            } catch(e) { console.warn('SSC preview pts error:', e); }

            // â”€â”€ Rank & render â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            const ranked = LB_CLASSES.map(cl => ({
                cl, yfP:yfP[cl]||0, quizP:quizP[cl]||0, resP:resP[cl]||0, custP:custP[cl]||0, shP:shP[cl]||0, sscP:sscP[cl]||0,
                total:(yfP[cl]||0)+(quizP[cl]||0)+(resP[cl]||0)+(custP[cl]||0)+(shP[cl]||0)+(sscP[cl]||0)
            })).sort((a,b) => b.total-a.total);

            const medals = ['ðŸ¥‡','ðŸ¥ˆ','ðŸ¥‰'];
            let html = '<div class="table-wrapper"><table style="min-width:780px;background:white;border-radius:8px;overflow:hidden">'
                     + '<thead><tr>'
                     + '<th style="background:#1a0030;color:#ffd700;padding:10px">Rank</th>'
                     + '<th style="background:#1a0030;color:#ffd700">Class</th>'
                     + '<th style="background:#1a0030;color:#ffc107">ðŸŽ¤ YF Reg</th>'
                     + '<th style="background:#1a0030;color:#a5d6a7">ðŸ§  Quiz</th>'
                     + '<th style="background:#1a0030;color:#ce93d8">ðŸ† Results</th>'
                     + '<th style="background:#1a0030;color:#80deea">âœ¨ Custom</th>'
                     + '<th style="background:#1a0030;color:#e1bee7">ðŸ—ºï¸ Hunt</th>'
                     + '<th style="background:#1a0030;color:#90caf9">ðŸ§© Slide</th>'
                     + '<th style="background:#c44569;color:white;font-size:1.05em">TOTAL</th>'
                     + '</tr></thead><tbody>';

            ranked.forEach((e,i) => {
                const rowBg = i===0 ? 'background:#fffde7' : i===1 ? 'background:#f8f8f8' : i===2 ? 'background:#fff3e0' : 'background:white';
                const rankCell = i<3 ? medals[i] : `<strong>${i+1}</strong>`;
                const totalStyle = i===0 ? 'font-weight:900;color:#c44569;font-size:1.2em' : 'font-weight:700;color:#c44569';
                html += `<tr style="${rowBg}">
                    <td style="text-align:center;font-size:1.1em">${rankCell}</td>
                    <td style="font-weight:600">${e.cl}</td>
                    <td style="color:#856404;text-align:center">${e.yfP}</td>
                    <td style="color:#155724;text-align:center">${e.quizP}</td>
                    <td style="color:#6a1b9a;text-align:center">${e.resP}</td>
                    <td style="color:#0c5460;text-align:center">${e.custP}</td>
                    <td style="color:#6a1b9a;font-weight:600;text-align:center">${e.shP || '<span style=\'color:#ccc\'>â€”</span>'}</td>
                    <td style="color:#0d47a1;font-weight:600;text-align:center">${e.sscP || '<span style=\'color:#ccc\'>â€”</span>'}</td>
                    <td style="${totalStyle};text-align:center">${e.total}</td>
                </tr>`;
            });
            html += '</tbody></table></div>';

            // Data source summary
            const now = new Date().toLocaleTimeString('en-IN');
            html += `<div style="margin-top:10px;padding:8px 12px;background:rgba(255,255,255,0.08);border-radius:6px;font-size:11px;color:rgba(255,255,255,0.5)">
                ðŸ“Š YF Reg pts: ${cfg.yfPtsPerEvent}/event &nbsp;|&nbsp;
                ðŸ§  Quiz winner: ${cfg.quizWinnerPts}pts, runner-up: ${cfg.quizRunnerUpPts}pts, participation max: ${cfg.quizMaxPts}pts &nbsp;|&nbsp;
                ðŸ† Event winner: ${cfg.winnerPts}pts, runner-up: ${cfg.runnerUpPts}pts &nbsp;|&nbsp;
                ðŸ—ºï¸ Hunt task: ${cfg.shTaskPts}pts, completion bonus: ${cfg.shCompletePts}pts, winner: ${cfg.shWinnerPts}pts, runner-up: ${cfg.shRunnerUpPts}pts &nbsp;|&nbsp;
                ðŸ§© Slide score factor: ${cfg.sscScoreFactor||1}pt per 10 game pts (Easy 100â†’10, Medium 200â†’20, Hard 300â†’30) &nbsp;|&nbsp;
                Quiz days counted: ${pubDates.size}
            </div>`;

            container.innerHTML = html;
            if (updEl) updEl.textContent = 'Last updated: ' + now;

        } catch(err) {
            container.innerHTML = '<p style="color:#ff6b6b;text-align:center;padding:20px">âŒ Error loading preview: <strong>' + err.message + '</strong></p>';
            if (updEl) updEl.textContent = 'Failed to load';
        }
    }

    function showLbAdminMsg(msg, type) {
        const el = document.getElementById('lbAdminMessage');
        if (!el) return;
        el.className = 'message ' + type + ' show';
        el.textContent = msg;
        setTimeout(() => el.classList.remove('show'), 6000);
    }

    // Leaderboard tab loading is handled inside showTab() in the main script above

    // ============================================================
    //  HOW WE PUBLISH â€” Editable Section Engine
    //  Super Admin can edit all text via Firebase
    //  Path: leaderboardConfig/howWePublish
    // ============================================================

    const HWP_DEFAULTS = {
        heading:  'Leaderboard Coming Soon!',
        subText:  'Results will be published by the Super Admin once the events are completed.\nCheck back soon!',
        overview: 'The <strong style="color:#c44569">Class of the Year 2026</strong> leaderboard ranks all <strong>11 classes</strong> competing across <strong>16 events</strong> at Spurthi Youth Fest. Rankings are hidden until the Super Admin verifies all results and officially publishes them â€” ensuring every score is accurate before you see it.',
        cards: [
            { title: 'Youthfest Registration', body: 'Each class earns points for <strong>every event they enrol in</strong>. More participation = more points for your class.' },
            { title: 'Quiz Competition',        body: 'Per published quiz day: <strong>flat bonus</strong> to the winner &amp; runner-up class, plus a <strong>participation rate bonus</strong> â€” fair across all class sizes.' },
            { title: 'Event Results',           body: 'When jury results are published, the <strong>1st place class</strong> gets winner pts and <strong>2nd place</strong> gets runner-up pts. For individual &amp; multi-team events, each class is represented by their <strong>best performer or best team</strong>.' },
            { title: 'Scavenger Hunt',          body: 'Points are awarded for <strong>approved task submissions</strong> in the Scavenger Hunt. The more tasks a student completes and gets approved, the more points their class earns.' },
            { title: 'Special / Custom Criteria', body: 'The Super Admin may add bonus points for criteria like discipline, attendance, best decorated class, or other special achievements.' }
        ],
        steps: [
            { title: 'Complete Events & Jury Scoring',  body: 'All events conducted. Jury 1 & Jury 2 fill and submit marks for every event.' },
            { title: 'Publish Quiz Results',            body: 'Daily quiz winners & runners-up declared. Only published days count.' },
            { title: 'Verify Scoring Config',           body: 'Points per event, quiz pts, winner/runner-up pts confirmed & saved.' },
            { title: 'Set Class Strengths',             body: 'Total students per class entered to ensure fair participation scoring.' },
            { title: 'Preview & Verify',                body: 'Live preview checked internally before releasing to students.' },
            { title: 'ðŸ“¢ Publish to Students',          body: 'Only after full verification â€” rankings go LIVE for all students to see.', highlight: true }
        ],
        notes: [
            'Only the <strong>Super Admin</strong> can publish or hide the leaderboard.',
            'All point calculations are <strong>fully automatic</strong> â€” no manual tampering.',
            'For individual events (e.g. Hand Writing, Pod Casting), each class is represented by their <strong>best-scoring student</strong>. For multi-team events (e.g. Vlog), each class is represented by their <strong>best-scoring team</strong>.',
            'The leaderboard refreshes every <strong>60 seconds</strong> once live.',
            'Rankings may be updated progressively as more results are published during the fest period.'
        ]
    };

    let hwpData = JSON.parse(JSON.stringify(HWP_DEFAULTS)); // working copy
    let hwpEditMode = false;

    // â”€â”€ Load from Firebase (or use defaults) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function hwpLoad() {
        try {
            const snap = await getDb().ref('leaderboardConfig/howWePublish').once('value');
            if (snap.exists()) {
                const d = snap.val();
                if (d.heading)  hwpData.heading  = d.heading;
                if (d.subText)  hwpData.subText  = d.subText;
                if (d.overview) hwpData.overview = d.overview;
                if (d.cards  && Array.isArray(d.cards))  hwpData.cards  = d.cards;
                if (d.steps  && Array.isArray(d.steps))  hwpData.steps  = d.steps;
                if (d.notes  && Array.isArray(d.notes))  hwpData.notes  = d.notes;
            }
        } catch(e) { console.warn('hwpLoad error (using defaults):', e.message); }
        hwpRender();
        hwpShowAdminControls();
    }

    // â”€â”€ Render all content from hwpData â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function hwpRender() {
        // Banner
        const hEl = document.getElementById('hwpHeadingText');
        const sEl = document.getElementById('hwpSubText');
        if (hEl) hEl.innerHTML = hwpData.heading;
        if (sEl) sEl.innerHTML = hwpData.subText.replace(/\n/g, '<br>');

        // Overview
        const ov = document.getElementById('hwpOverviewText');
        if (ov) ov.innerHTML = hwpData.overview;

        // Cards
        hwpData.cards.forEach((c, i) => {
            const t = document.getElementById('hwpCard'+i+'Title');
            const b = document.getElementById('hwpCard'+i+'Body');
            if (t) t.innerHTML = c.title;
            if (b) b.innerHTML = c.body;
        });

        // Steps
        const grid = document.getElementById('hwpStepsGrid');
        if (grid) {
            grid.innerHTML = hwpData.steps.map((s, i) => {
                const isLast = s.highlight;
                const numBg  = isLast ? '#28a745' : '#c44569';
                const cardBg = isLast ? 'background:linear-gradient(135deg,#e8f5e9,#d4edda);border:2px solid #28a745' : 'background:#fafafa;border:1px solid #eee';
                const titleColor = isLast ? '#155724' : '#333';
                const bodyColor  = isLast ? '#155724' : '#666';
                return `<div style="${cardBg};border-radius:8px;padding:13px;display:flex;gap:11px;align-items:flex-start" data-step="${i}">
                    <span style="background:${numBg};color:white;border-radius:50%;width:23px;height:23px;display:inline-flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;flex-shrink:0;margin-top:1px">${i+1}</span>
                    <div>
                        <strong style="color:${titleColor};font-size:12.5px" id="hwpStep${i}Title">${s.title}</strong>
                        <p style="margin:3px 0 0;color:${bodyColor};font-size:11.5px" id="hwpStep${i}Body">${s.body}</p>
                        <div class="hwpStepEditArea" style="display:none;margin-top:6px">
                            <input type="text" class="hwpStepTitleInput" data-idx="${i}" value="${s.title.replace(/"/g,'&quot;')}" style="width:100%;padding:4px 7px;border:1px solid #ccc;border-radius:4px;font-size:11.5px;margin-bottom:4px">
                            <textarea class="hwpStepBodyInput" data-idx="${i}" rows="2" style="width:100%;padding:4px 7px;border:1px solid #ccc;border-radius:4px;font-size:11.5px;resize:vertical">${s.body}</textarea>
                            <label style="font-size:11px;color:#666;display:flex;align-items:center;gap:5px;margin-top:3px">
                                <input type="checkbox" class="hwpStepHighlight" data-idx="${i}" ${s.highlight?'checked':''} style="width:auto"> Highlight as final step (green)
                            </label>
                        </div>
                    </div>
                </div>`;
            }).join('');
        }

        // Notes
        const nl = document.getElementById('hwpNotesList');
        if (nl) nl.innerHTML = hwpData.notes.map(n => `<li>${n}</li>`).join('');
    }

    // â”€â”€ Show admin controls if Super Admin is logged in â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function hwpShowAdminControls() {
        const isSA = typeof isSuperAdmin !== 'undefined' && isSuperAdmin;
        if (!isSA) return;
        const bannerCtrl  = document.getElementById('hwpBannerEditControls');
        const sectionCtrl = document.getElementById('hwpEditModeControls');
        if (bannerCtrl)  { bannerCtrl.style.display  = 'flex'; }
        if (sectionCtrl) { sectionCtrl.style.display = 'flex'; }
    }

    // â”€â”€ Banner edit â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function hwpToggleBannerEdit() {
        const isEditing = document.getElementById('hwpHeadingEdit').style.display !== 'none';
        if (!isEditing) {
            document.getElementById('hwpHeadingInput').value = hwpData.heading;
            document.getElementById('hwpSubInput').value     = hwpData.subText;
            document.getElementById('hwpHeadingView').style.display = 'none';
            document.getElementById('hwpSubView').style.display     = 'none';
            document.getElementById('hwpHeadingEdit').style.display = 'block';
            document.getElementById('hwpSubEdit').style.display     = 'block';
            document.getElementById('hwpBannerEditBtn').style.display  = 'none';
            document.getElementById('hwpBannerSaveBtn').style.display  = 'inline-block';
            document.getElementById('hwpBannerCancelBtn').style.display= 'inline-block';
        }
    }
    function hwpCancelBannerEdit() {
        document.getElementById('hwpHeadingView').style.display = 'block';
        document.getElementById('hwpSubView').style.display     = 'block';
        document.getElementById('hwpHeadingEdit').style.display = 'none';
        document.getElementById('hwpSubEdit').style.display     = 'none';
        document.getElementById('hwpBannerEditBtn').style.display   = 'inline-block';
        document.getElementById('hwpBannerSaveBtn').style.display   = 'none';
        document.getElementById('hwpBannerCancelBtn').style.display = 'none';
    }
    async function hwpSaveBanner() {
        hwpData.heading = document.getElementById('hwpHeadingInput').value.trim() || hwpData.heading;
        hwpData.subText = document.getElementById('hwpSubInput').value.trim()     || hwpData.subText;
        try {
            await getDb().ref('leaderboardConfig/howWePublish/heading').set(hwpData.heading);
            await getDb().ref('leaderboardConfig/howWePublish/subText').set(hwpData.subText);
            hwpRender();
            hwpCancelBannerEdit();
            const msg = document.getElementById('hwpBannerSaveMsg');
            if (msg) { msg.style.display='inline-block'; setTimeout(()=>msg.style.display='none',3000); }
        } catch(e) { alert('Save error: ' + e.message); }
    }

    // â”€â”€ Section edit mode â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function hwpToggleEditMode() {
        hwpEditMode = true;
        // Overview
        document.getElementById('hwpOverviewView').style.display = 'none';
        document.getElementById('hwpOverviewEdit').style.display = 'block';
        document.getElementById('hwpOverviewInput').value = hwpData.overview;
        // Cards
        document.querySelectorAll('.hwpCardEditArea').forEach((el,i) => {
            el.style.display = 'block';
            const tIn = el.querySelector('.hwpCardTitleInput');
            const bIn = el.querySelector('.hwpCardBodyInput');
            if (tIn) tIn.value = hwpData.cards[i] ? hwpData.cards[i].title : '';
            if (bIn) bIn.value = hwpData.cards[i] ? hwpData.cards[i].body.replace(/<[^>]+>/g,'') : '';
        });
        // Steps
        document.querySelectorAll('.hwpStepEditArea').forEach(el => el.style.display='block');
        // Notes
        document.getElementById('hwpNotesView').style.display = 'none';
        document.getElementById('hwpNotesEdit').style.display = 'block';
        document.getElementById('hwpNotesInput').value = hwpData.notes.map(n=>n.replace(/<[^>]+>/g,'')).join('\n');
        // Buttons
        document.getElementById('hwpEditModeBtn').style.display  = 'none';
        document.getElementById('hwpSaveAllBtn').style.display   = 'inline-block';
        document.getElementById('hwpCancelBtn').style.display    = 'inline-block';
    }
    function hwpCancelEdit() {
        hwpEditMode = false;
        hwpRender();
        document.getElementById('hwpOverviewView').style.display = 'block';
        document.getElementById('hwpOverviewEdit').style.display = 'none';
        document.getElementById('hwpNotesView').style.display    = 'block';
        document.getElementById('hwpNotesEdit').style.display    = 'none';
        document.querySelectorAll('.hwpCardEditArea').forEach(el => el.style.display='none');
        document.getElementById('hwpEditModeBtn').style.display  = 'inline-block';
        document.getElementById('hwpSaveAllBtn').style.display   = 'none';
        document.getElementById('hwpCancelBtn').style.display    = 'none';
    }
    async function hwpSaveAll() {
        // Collect overview
        hwpData.overview = document.getElementById('hwpOverviewInput').value.trim() || hwpData.overview;

        // Collect cards
        document.querySelectorAll('.hwpCardTitleInput').forEach(inp => {
            const i = parseInt(inp.dataset.idx);
            if (!isNaN(i) && hwpData.cards[i]) hwpData.cards[i].title = inp.value.trim();
        });
        document.querySelectorAll('.hwpCardBodyInput').forEach(inp => {
            const i = parseInt(inp.dataset.idx);
            if (!isNaN(i) && hwpData.cards[i]) hwpData.cards[i].body = inp.value.trim();
        });

        // Collect steps
        document.querySelectorAll('.hwpStepTitleInput').forEach(inp => {
            const i = parseInt(inp.dataset.idx);
            if (!isNaN(i) && hwpData.steps[i]) hwpData.steps[i].title = inp.value.trim();
        });
        document.querySelectorAll('.hwpStepBodyInput').forEach(inp => {
            const i = parseInt(inp.dataset.idx);
            if (!isNaN(i) && hwpData.steps[i]) hwpData.steps[i].body = inp.value.trim();
        });
        document.querySelectorAll('.hwpStepHighlight').forEach(inp => {
            const i = parseInt(inp.dataset.idx);
            if (!isNaN(i) && hwpData.steps[i]) hwpData.steps[i].highlight = inp.checked;
        });

        // Collect notes
        const rawNotes = document.getElementById('hwpNotesInput').value.trim();
        if (rawNotes) hwpData.notes = rawNotes.split('\n').map(n=>n.trim()).filter(Boolean);

        const saveBtn = document.getElementById('hwpSaveAllBtn');
        if (saveBtn) { saveBtn.disabled=true; saveBtn.textContent='â³ Savingâ€¦'; }
        try {
            await getDb().ref('leaderboardConfig/howWePublish').set({
                heading:  hwpData.heading,
                subText:  hwpData.subText,
                overview: hwpData.overview,
                cards:    hwpData.cards,
                steps:    hwpData.steps,
                notes:    hwpData.notes,
                updatedAt: new Date().toISOString()
            });
            hwpCancelEdit();
            hwpRender();
            const msg = document.getElementById('hwpSaveAllMsg');
            if (msg) { msg.style.display='inline-block'; setTimeout(()=>msg.style.display='none',4000); }
        } catch(e) {
            alert('âŒ Save error: ' + e.message);
        } finally {
            if (saveBtn) { saveBtn.disabled=false; saveBtn.textContent='ðŸ’¾ Save All Changes'; }
        }
    }


    // ================================================================
    //  SCAVENGER HUNT SYSTEM
    // ================================================================
    let shCurrentUser   = null;
    let shTasks         = [];
    let shSettings      = { active: false, gps: true, radius: 100, autoApprove: false };
    let shUserLat       = null;
    let shUserLng       = null;
    let shGpsWatchId    = null;

    // â”€â”€ Public status banner (before login) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function shCheckPublicStatus() {
        const banner = document.getElementById('shPublicBanner');
        if (!banner) return;
        try {
            const snap = await window.db.ref('scavengerHunt/settings').once('value');
            const s = snap.val() || {};
            if (s.active) {
                banner.innerHTML = '<div style="font-size:2em;margin-bottom:6px">ðŸŸ¢</div><strong style="font-size:1.15em">Hunt is LIVE!</strong><p style="margin:6px 0 0;opacity:0.9;font-size:0.95em">Tasks are waiting. Login to start!</p>';
                banner.style.background = 'linear-gradient(135deg,#2e7d32,#43a047)';
            } else {
                banner.innerHTML = '<div style="font-size:2em;margin-bottom:6px">ðŸ”´</div><strong>Hunt Not Started Yet</strong><p style="margin:6px 0 0;opacity:0.9;font-size:0.9em">Stay tuned â€” the hunt will begin soon!</p>';
                banner.style.background = 'linear-gradient(135deg,#b71c1c,#e53935)';
            }
        } catch(e) { if (banner) banner.innerHTML = '<p style="margin:0">âš ï¸ Could not load status.</p>'; }
    }

    // â”€â”€ Student Login â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function shLogin() {
        const phone = document.getElementById('shLoginPhone').value.trim();
        const pwd   = document.getElementById('shLoginPassword').value;
        const msg   = document.getElementById('shLoginMsg');
        msg.className = 'message'; msg.style.display = 'none';
        if (!phone || !pwd) { shShowMsg(msg,'error','Enter phone and password.'); return; }
        try {
            const snap = await window.db.ref('quizStudents').orderByChild('phone').equalTo(phone).once('value');
            if (!snap.exists()) { alert('âŒ Phone number not registered!\n\nPlease register via the Daily Quiz section first, then try Scavenger Hunt login.'); shShowMsg(msg,'error','âŒ Phone not registered. Register via Daily Quiz first.'); return; }
            let found = null, foundKey = null;
            snap.forEach(c => { if (c.val().password === pwd) { found = c.val(); foundKey = c.key; } });
            if (!found) { alert('âŒ Incorrect password!\n\nPlease check your password and try again.'); shShowMsg(msg,'error','âŒ Incorrect password.'); return; }

            // Save credentials if Remember Me checked
            if (document.getElementById('shRememberMe').checked) {
                localStorage.setItem('spurthi_sh_phone', phone);
                localStorage.setItem('spurthi_sh_pwd', pwd);
                localStorage.setItem('spurthi_sh_remember', '1');
            } else {
                localStorage.removeItem('spurthi_sh_phone');
                localStorage.removeItem('spurthi_sh_pwd');
                localStorage.removeItem('spurthi_sh_remember');
            }

            shCurrentUser = { key: foundKey, ...found };
            document.getElementById('loginSection').style.display        = 'none';
            document.getElementById('quizStudentDashboard').style.display = 'none';
            document.getElementById('shStudentDashboard').style.display   = 'block';
            document.getElementById('shStudentName').textContent   = found.name;
            document.getElementById('shStudentClass').textContent  = found.class || found.classYear || '';
            document.getElementById('shStudentBadge').textContent  = found.name;
            document.getElementById('userInfo').innerHTML = 'Logged in as: <span class="badge" style="background:#9c27b0;color:white;padding:5px 12px;border-radius:20px;font-size:0.85em">' + found.name + ' â€“ Scavenger Hunt</span>';
            setTimeout(() => {
                const shDash = document.getElementById('shStudentDashboard');
                if (shDash) {
                    const y = shDash.getBoundingClientRect().top + window.pageYOffset - 20;
                    window.scrollTo({ top: y, behavior: 'smooth' });
                }
            }, 150);
            await shLoadStudentDashboard();
        } catch(e) { 
            console.error('shLogin error:', e);
            alert('âŒ Login failed: ' + (e.message || 'Unknown error') + '\n\nCheck your internet connection and try again.');
            shShowMsg(msg,'error','âŒ Error: ' + e.message); 
        }
    }

    function shLogout() { logout(); }

    function shGoBack() {
        // Hide dashboard, show login page â€” student stays logged in but goes back to login screen
        document.getElementById('shStudentDashboard').style.display = 'none';
        document.getElementById('loginSection').style.display = 'block';
        document.getElementById('scavengerHuntLogin').style.display = 'block';
        // Make sure competition dropdown reflects scavenger hunt selection
        const compDrop = document.getElementById('competitionType');
        if (compDrop) compDrop.value = 'scavengerhunt';
        shCurrentUser = null;
    }

    // â”€â”€ Student: Refresh Status â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function shRefreshStatus() {
        const btn = document.getElementById('shRefreshBtn');
        const lastEl = document.getElementById('shLastRefreshed');
        if (btn) { btn.disabled = true; btn.textContent = 'â³ Checking...'; }
        await shLoadStudentDashboard();
        if (btn) { btn.disabled = false; btn.innerHTML = 'ðŸ”„ Check Status'; }
        const now = new Date().toLocaleTimeString('en-IN', {hour:'2-digit',minute:'2-digit',second:'2-digit'});
        if (lastEl) lastEl.textContent = 'Last checked: ' + now;
        // Show toast
        const toast = document.createElement('div');
        toast.textContent = 'âœ… Status updated!';
        toast.style.cssText = 'position:fixed;top:20px;left:50%;transform:translateX(-50%);background:#4caf50;color:white;padding:12px 28px;border-radius:30px;font-weight:700;font-size:1em;z-index:9999;box-shadow:0 4px 20px rgba(0,0,0,0.2);transition:opacity 0.5s';
        document.body.appendChild(toast);
        setTimeout(() => { toast.style.opacity = '0'; setTimeout(() => toast.remove(), 500); }, 2000);
    }

    // â”€â”€ Check single task approval (no scroll) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function shCheckTaskApproval(taskId, btn) {
        if (btn) { btn.disabled = true; btn.textContent = 'â³ Checking...'; }
        try {
            const subSnap = await window.db.ref('scavengerHunt/submissions/' + shCurrentUser.key + '/' + taskId).once('value');
            const sub = subSnap.val();

            function showToast(msg, color) {
                const t = document.createElement('div');
                t.textContent = msg;
                t.style.cssText = 'position:fixed;top:20px;left:50%;transform:translateX(-50%);background:'+color+';color:white;padding:12px 28px;border-radius:30px;font-weight:700;font-size:0.95em;z-index:9999;box-shadow:0 4px 20px rgba(0,0,0,0.2);transition:opacity 0.5s';
                document.body.appendChild(t);
                setTimeout(() => { t.style.opacity='0'; setTimeout(()=>t.remove(),500); }, 2500);
            }

            if (sub && sub.status === 'approved') {
                if (btn) { btn.disabled = false; btn.textContent = 'ðŸ”„ Check Approval'; }
                showToast('âœ… Approved by Super Admin!', '#4caf50');
                // Full reload from Firebase â€” do NOT touch DOM before this
                // so task counts are always based on fresh server data
                await shLoadStudentDashboard();

            } else if (sub && sub.status === 'rejected') {
                if (btn) { btn.disabled = false; btn.textContent = 'ðŸ”„ Check Approval'; }
                showToast('âŒ Task was Rejected â€” please reupload!', '#c62828');
                // For rejected, do a silent background reload after short delay so reupload UI appears
                setTimeout(() => shLoadStudentDashboard(), 500);

            } else {
                // Still pending â€” just show toast, no re-render, no scroll
                if (btn) { btn.disabled = false; btn.textContent = 'ðŸ”„ Check Approval'; }
                showToast('â³ Still waiting for super admin approvalâ€¦', '#ff9800');
            }
        } catch(e) {
            if (btn) { btn.disabled = false; btn.textContent = 'ðŸ”„ Check Approval'; }
            alert('Error checking status: ' + e.message);
        }
    }

    // â”€â”€ Student Dashboard â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function shLoadStudentDashboard() {
        // Show loading state â€” keep progressSection visible during reload to avoid flash
        const notActive = document.getElementById('shNotActiveMsg');
        const progSect  = document.getElementById('shProgressSection');
        if (notActive) notActive.style.display = 'none';
        // Only hide progress section if it was never shown yet (first load)
        if (progSect && progSect.style.display === 'none') progSect.style.display = 'none';
        // Hide the All Done banner during reload â€” will be re-evaluated from fresh Firebase data
        const allDoneBanner = document.getElementById('shAllDoneSection');
        if (allDoneBanner) allDoneBanner.style.display = 'none';
        const tasksList = document.getElementById('shTasksList');
        if (tasksList) { tasksList.style.display = ''; tasksList.innerHTML = '<p style="color:#999;text-align:center;padding:20px">â³ Loading tasks...</p>'; }
        let settSnap, taskSnap, subSnap;
        try {
            [settSnap, taskSnap, subSnap] = await Promise.all([
                window.db.ref('scavengerHunt/settings').once('value'),
                window.db.ref('scavengerHunt/tasks').once('value'),
                window.db.ref('scavengerHunt/submissions/' + shCurrentUser.key).once('value')
            ]);
        } catch(e) {
            console.error('shLoadStudentDashboard DB error:', e);
            if (tasksList) tasksList.innerHTML = '<div style="background:#ffebee;padding:15px;border-radius:8px;color:#c62828">âŒ Failed to load: ' + e.message + '<br><button onclick="shLoadStudentDashboard()" class="btn btn-small" style="margin-top:8px">ðŸ”„ Retry</button></div>';
            if (progSect) progSect.style.display = 'block';
            return;
        }
        shSettings = settSnap.val() || { active:false, gps:true, radius:100, autoApprove:false };
        if (!shSettings.active) {
            document.getElementById('shNotActiveMsg').style.display    = 'block';
            document.getElementById('shProgressSection').style.display = 'none';
            return;
        }
        document.getElementById('shNotActiveMsg').style.display    = 'none';
        document.getElementById('shProgressSection').style.display = 'block';
        const tasksRaw = taskSnap.val() || {};
        shTasks = Object.entries(tasksRaw).map(([k,v])=>({id:k,...v})).sort((a,b)=>(a.order||0)-(b.order||0));
        const subs = subSnap.val() || {};
        let completed=0, pendingReview=0, locked=0, active=0, rejected=0;
        const nowMs = Date.now();
        // Pre-compute: all tasks require ALL previous tasks (by order) to be approved (strict chain)
        // Tasks are sorted by order. We count how many consecutive tasks from the start are approved.
        // IMPORTANT: we use task.order (not array index) so that if an earlier task is deleted
        // from the task list, later tasks (with higher order numbers) are NOT accidentally treated
        // as "first" and unlocked without prerequisite approval.
        const minOrder = shTasks.length > 0 ? (shTasks[0].order || 1) : 1;
        let approvedChainCount = 0; // how many consecutive tasks from the start are fully approved
        for (let i = 0; i < shTasks.length; i++) {
            const s = subs[shTasks[i].id];
            // Only count as approved if it has a real submission (submittedAt present)
            if (s && s.status === 'approved' && s.submittedAt) {
                approvedChainCount++;
            } else {
                break; // chain breaks â€” no task beyond this is unlocked
            }
        }

        shTasks.forEach((t, idx) => {
            const sub = subs[t.id];
            // A task is accessible only if ALL tasks before it (by sorted order) are approved.
            // Task at idx=0 is accessible only if its order equals minOrder (i.e. it IS the first
            // task by design). If a task has order > minOrder and is at idx=0 because earlier
            // order tasks were deleted, it is NOT automatically unlocked â€” it requires prior approval.
            const taskOrder = t.order || (idx + 1);
            // idx===0 = first task in sorted list = always accessible, regardless of order number value
            const allPrevApproved = (idx === 0) || approvedChainCount >= idx;
            // Check time availability
            const notYet = t.availableFrom && !isNaN(new Date(t.availableFrom).getTime()) && new Date(t.availableFrom).getTime() > nowMs;
            const expired = t.deadline && !isNaN(new Date(t.deadline).getTime()) && new Date(t.deadline).getTime() < nowMs;

            // Gate 1: ALL previous tasks must be approved â€” if not, lock immediately
            if (!allPrevApproved) {
                t._state = 'locked'; locked++;
            } else if (sub && sub.status === 'approved' && sub.submittedAt) {
                // For multi-part tasks: only fully completed when ALL parts are approved
                if (t.parts && t.parts.length > 0) {
                    const subParts = sub.parts || [];
                    const totalParts = t.parts.length;
                    const allApproved = subParts.length === totalParts && subParts.every(p => p && p.status === 'approved');
                    const anyPending  = subParts.some(p => p && p.status === 'pending');
                    if (allApproved) {
                        t._state = 'completed'; completed++;
                    } else if (anyPending) {
                        t._state = 'pending'; pendingReview++;
                    } else {
                        // Part 1 approved but later parts not yet submitted
                        t._state = 'active'; active++;
                    }
                } else {
                    t._state = 'completed'; completed++;
                }
            } else if (sub && sub.status === 'pending' && sub.submittedAt) {
                t._state = 'pending'; pendingReview++;
            } else if (sub && sub.status === 'rejected' && sub.submittedAt) {
                t._state = 'rejected'; rejected++;
            } else if (notYet) {
                t._state = 'locked'; t._lockReason = 'not_yet'; locked++;
            } else if (expired) {
                t._state = 'locked'; t._lockReason = 'expired'; locked++;
            } else {
                t._state = 'active'; active++;
            }
            t._sub = sub || null;
        });
        const total = shTasks.length;
        const pct   = total ? Math.round(completed/total*100) : 0;
        document.getElementById('shProgressText').textContent   = completed+'/'+total+' ('+pct+'%)';
        document.getElementById('shProgressBar').style.width    = pct+'%';
        document.getElementById('shCompletedCount').textContent = completed;
        document.getElementById('shPendingCount').textContent   = pendingReview;
        document.getElementById('shLockedCount').textContent    = locked;
        // Only show "All Done" when every task is truly approved (zero pending/rejected/locked/active)
        if (completed===total && total>0 && pendingReview===0 && locked===0 && active===0 && rejected===0) {
            const _sy = window.scrollY;
            document.getElementById('shTasksList').innerHTML = '';
            document.getElementById('shAllDoneSection').style.display = 'block';
            requestAnimationFrame(() => window.scrollTo({ top: _sy, behavior: 'instant' }));
        } else {
            const _sy2 = window.scrollY;
            document.getElementById('shAllDoneSection').style.display = 'none';
            shRenderTasks(shTasks, subs);
            requestAnimationFrame(() => window.scrollTo({ top: _sy2, behavior: 'instant' }));
        }
        if (shSettings.gps) shGetLocation();
    }

    function shRenderTasks(tasks, subs) {
        const el = document.getElementById('shTasksList');
        if (!tasks.length) { el.innerHTML = '<p style="color:#999">No tasks available yet.</p>'; return; }

        const nowMs  = Date.now();
        const todayStr = new Date().toLocaleDateString('en-IN',{weekday:'long',day:'2-digit',month:'long',year:'numeric'});

        // â”€â”€ Summary banner â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        let summaryHtml = '<div style="background:linear-gradient(135deg,#1a0030,#6a1b9a);color:white;border-radius:12px;padding:16px 20px;margin-bottom:16px">';
        summaryHtml += '<div style="font-size:0.8em;opacity:0.75;margin-bottom:4px">ðŸ“… Today</div>';
        summaryHtml += '<div style="font-size:1.05em;font-weight:700;margin-bottom:12px">'+todayStr+'</div>';

        // Check each task for history
        tasks.forEach((t, idx) => {
            const sub  = subs[t.id] || null;
            const isToday = t.availableFrom && new Date(t.availableFrom).toDateString() === new Date().toDateString();
            const isPast  = t.availableFrom && new Date(t.availableFrom).getTime() < nowMs;
            const taskLabel = 'Task '+(idx+1);
            const statusIcon = sub ? (sub.status==='approved'?'âœ…':sub.status==='rejected'?'âŒ':'â³') : (isPast?'ðŸ“­':'ðŸ”’');
            const statusText = sub ? (sub.status==='approved'?'Approved':sub.status==='rejected'?'Rejected â€” Reupload':'Under Review') : (isPast?'Not submitted':'Upcoming');
            const statusColor = sub ? (sub.status==='approved'?'#a5d6a7':sub.status==='rejected'?'#ef9a9a':'#ffe082') : (isPast?'#ef9a9a':'rgba(255,255,255,.5)');
            const taskDay = t.availableFrom ? new Date(t.availableFrom).toLocaleDateString('en-IN',{weekday:'short',day:'2-digit',month:'short'}) : 'â€”';
            summaryHtml += '<div style="display:flex;align-items:center;gap:10px;background:rgba(255,255,255,.1);border-radius:8px;padding:8px 12px;margin-bottom:6px">';
            summaryHtml += '<span style="font-size:1.3em">'+statusIcon+'</span>';
            summaryHtml += '<div style="flex:1"><div style="font-weight:700;font-size:.9em">'+taskLabel+'</div><div style="font-size:.75em;opacity:.8">'+taskDay+'</div></div>';
            summaryHtml += '<span style="font-size:.8em;font-weight:700;color:'+statusColor+'">'+statusText+'</span>';
            summaryHtml += '</div>';
        });

        // Next upcoming task info
        const nextTask = tasks.find(t => t.availableFrom && new Date(t.availableFrom).getTime() > nowMs && !subs[t.id]);
        if (nextTask) {
            const nextTime = new Date(nextTask.availableFrom).toLocaleString('en-IN',{weekday:'short',day:'2-digit',month:'short',hour:'2-digit',minute:'2-digit',hour12:true});
            summaryHtml += '<div style="background:rgba(255,255,255,.15);border-radius:8px;padding:8px 12px;font-size:.85em;margin-top:4px">ðŸš€ <strong>Next hunt:</strong> Task '+(tasks.indexOf(nextTask)+1)+' opens on <strong>'+nextTime+'</strong></div>';
        }
        summaryHtml += '</div>';

        let html = summaryHtml;
        tasks.forEach((t,idx) => {
            const state = t._state;
            const sub   = t._sub;
            const stateLabel = {
                completed: '<span class="sh-badge sh-badge-done">âœ… Completed</span>',
                pending:   '<span class="sh-badge sh-badge-pending">â³ Under Review</span>',
                rejected:  '<span class="sh-badge sh-badge-rejected">âŒ Rejected â€“ Reupload</span>',
                active:    '<span class="sh-badge sh-badge-active">ðŸ“ Active</span>',
                locked:    '<span class="sh-badge" style="background:#eee;color:#999;border:1px solid #ccc">ðŸ”’ Locked</span>'
            }[state] || '';
            const cardClass = state==='completed' ? 'sh-task-card completed' : state==='pending' ? 'sh-task-card pending' : state==='locked' ? 'sh-task-card locked' : state==='rejected' ? 'sh-task-card rejected' : 'sh-task-card';
            const fmtDT = iso => new Date(iso).toLocaleString('en-IN',{weekday:'short',day:'2-digit',month:'short',year:'numeric',hour:'2-digit',minute:'2-digit',hour12:true});
            const fmtDate = iso => new Date(iso).toLocaleDateString('en-IN',{weekday:'long',day:'2-digit',month:'long',year:'numeric'});
            html += '<div class="' + cardClass + '" id="shTask_' + t.id + '">';

            // â”€â”€ Task header banner â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            const headerBg = state==='completed'?'linear-gradient(135deg,#2e7d32,#43a047)':state==='pending'?'linear-gradient(135deg,#e65100,#ff9800)':state==='rejected'?'linear-gradient(135deg,#b71c1c,#f44336)':state==='locked'?'linear-gradient(135deg,#546e7a,#78909c)':'linear-gradient(135deg,#6a1b9a,#9c27b0)';
            html += '<div style="background:'+headerBg+';color:white;border-radius:10px 10px 0 0;padding:12px 16px;margin:-1px -1px 14px;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:8px">';
            html += '<div><span style="font-size:0.75em;opacity:0.85;text-transform:uppercase;letter-spacing:1px">Task '+( idx+1)+' of '+shTasks.length+'</span><h4 style="margin:4px 0 0;font-size:1em;font-weight:700">'+shEsc(t.name)+'</h4></div>';
            html += stateLabel;
            html += '</div>';

            // â”€â”€ Date/Time info panel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            html += '<div style="background:#f8f0ff;border-radius:8px;padding:10px 14px;margin-bottom:12px;font-size:0.85em">';
            if (t.availableFrom) {
                const fromDate = fmtDate(t.availableFrom);
                const fromTime = new Date(t.availableFrom).toLocaleTimeString('en-IN',{hour:'2-digit',minute:'2-digit',hour12:true});
                html += '<div style="display:flex;align-items:center;gap:8px;margin-bottom:4px"><span style="font-size:1.1em">ðŸ—“ï¸</span><span style="color:#6a1b9a;font-weight:700">Task Day:</span> <span style="color:#333">'+fromDate+'</span></div>';
                html += '<div style="display:flex;align-items:center;gap:8px;margin-bottom:4px"><span style="font-size:1.1em">â°</span><span style="color:#388e3c;font-weight:700">Starts:</span> <span style="color:#333">'+fmtDT(t.availableFrom)+'</span></div>';
            }
            if (t.deadline) {
                html += '<div style="display:flex;align-items:center;gap:8px;margin-bottom:4px"><span style="font-size:1.1em">ðŸ”š</span><span style="color:#f44336;font-weight:700">Deadline:</span> <span style="color:#333">'+fmtDT(t.deadline)+'</span></div>';
            }
            if (t.createdAt) {
                html += '<div style="display:flex;align-items:center;gap:8px"><span style="font-size:1.1em">ðŸ“‹</span><span style="color:#888;font-weight:600">Created:</span> <span style="color:#aaa">'+fmtDT(t.createdAt)+'</span></div>';
            }
            html += '</div>';

            if (t.hint) html += '<p style="color:#795548;font-size:0.9em;margin-bottom:10px;background:#fff8e1;padding:8px 12px;border-radius:6px;border-left:4px solid #ffb300">ðŸ’¡ <strong>Hint:</strong> ' + shEsc(t.hint) + '</p>';
            if (t.image) html += '<div style="margin-bottom:12px;text-align:center"><img src="'+t.image+'" style="max-width:100%;max-height:260px;border-radius:10px;border:2px solid #ce93d8;box-shadow:0 3px 12px rgba(106,27,154,0.15);cursor:pointer" onclick="shViewPhoto(this.src)" title="Click to enlarge" alt="Task reference image"><div style="font-size:0.78em;color:#9c27b0;margin-top:4px;opacity:0.8">ðŸ–¼ï¸ Reference image â€” click to enlarge</div></div>';

            // Lock/expiry reason
            if (t._lockReason==='not_yet')  html += '<div style="background:#e3f2fd;padding:10px 14px;border-radius:6px;font-size:0.88em;color:#1565c0;margin-bottom:10px;border-left:4px solid #2196f3">â³ <strong>Not open yet.</strong> This task unlocks on '+fmtDT(t.availableFrom)+'</div>';
            if (t._lockReason==='expired')  html += '<div style="background:#ffebee;padding:10px 14px;border-radius:6px;font-size:0.88em;color:#c62828;margin-bottom:10px;border-left:4px solid #f44336">â›” <strong>Deadline passed.</strong> This task is no longer available.</div>';
            if (state==='locked' && !t._lockReason) html += '<div style="background:#f5f5f5;padding:10px 14px;border-radius:6px;font-size:0.88em;color:#546e7a;margin-bottom:10px;border-left:4px solid #78909c">ðŸ”’ <strong>Locked.</strong> Complete and get the previous task approved first.</div>';

            if (shSettings.gps && t.lat && t.lng) html += '<span class="sh-gps-badge" style="margin-bottom:10px;display:inline-flex">ðŸ“ GPS Verified Location</span>';
            // Show submission date/time and review info
            if (sub) {
                const submittedTime = sub.submittedAt ? new Date(sub.submittedAt).toLocaleString('en-IN',{day:'2-digit',month:'short',year:'numeric',hour:'2-digit',minute:'2-digit',hour12:true}) : '';
                const reviewedTime  = sub.reviewedAt  ? new Date(sub.reviewedAt).toLocaleString('en-IN',{day:'2-digit',month:'short',year:'numeric',hour:'2-digit',minute:'2-digit',hour12:true}) : '';
                if (submittedTime) html += '<div style="font-size:0.82em;color:#888;margin-bottom:6px">ðŸ“… Submitted: <strong style="color:#555">' + submittedTime + '</strong></div>';
                if (state === 'completed' && reviewedTime) {
                    html += '<div style="background:#e8f5e9;border:2px solid #4caf50;border-radius:8px;padding:10px 14px;margin-bottom:8px;display:flex;align-items:center;gap:8px">';
                    html += '<span style="font-size:1.3em">âœ…</span><div><strong style="color:#2e7d32;font-size:0.95em">APPROVED by Admin</strong><br><span style="font-size:0.78em;color:#666">Reviewed on: ' + reviewedTime + '</span></div></div>';
                } else if (state === 'rejected') {
                    const rejReason = sub.rejectionReason ? sub.rejectionReason : '';
                    html += '<div style="background:#ffebee;border:2px solid #f44336;border-radius:8px;padding:12px 14px;margin-bottom:8px">';
                    html += '<div style="display:flex;align-items:flex-start;gap:10px">';
                    html += '<span style="font-size:1.4em;line-height:1">âŒ</span>';
                    html += '<div style="flex:1"><strong style="color:#c62828;font-size:0.95em">REJECTED â€” Please reupload</strong>';
                    if (reviewedTime) html += '<br><span style="font-size:0.78em;color:#666">Reviewed on: ' + reviewedTime + '</span>';
                    if (rejReason) html += '<div style="margin-top:8px;background:#fff0f0;border-left:3px solid #f44336;padding:8px 12px;border-radius:0 6px 6px 0;font-size:0.88em;color:#b71c1c"><strong>ðŸ“ Reason:</strong> ' + shEsc(rejReason) + '</div>';
                    html += '</div></div></div>';
                } else if (state === 'pending') {
                    html += '<div data-pending-box style="background:#fff3e0;border:2px solid #ff9800;border-radius:8px;padding:10px 14px;margin-bottom:8px;display:flex;align-items:center;justify-content:space-between;gap:8px;flex-wrap:wrap">';
                    html += '<div style="display:flex;align-items:center;gap:8px"><span style="font-size:1.3em">â³</span><div><strong style="color:#e65100;font-size:0.95em">Under Review</strong><br><span style="font-size:0.78em;color:#666">Waiting for super admin approval</span><br><span style="font-size:0.8em;color:#c0392b;font-weight:700">âš ï¸ You can proceed to the next task only after this is approved.</span></div></div>';
                    html += '<button id="shCheckBtn_' + t.id + '" onclick="shCheckTaskApproval(\'' + t.id + '\', this)" style="background:#ff9800;color:white;border:none;padding:7px 14px;border-radius:18px;cursor:pointer;font-size:0.82em;font-weight:700;display:flex;align-items:center;gap:5px;white-space:nowrap">ðŸ”„ Check Approval</button></div>';
                }
            }
            if (sub && sub.photoUrl) html += '<div style="margin:10px 0"><img src="' + sub.photoUrl + '" class="sh-preview-img" onclick="shViewPhoto(this.src)" title="Click to enlarge"></div>';

            // â”€â”€ MULTI-PART TASK LOGIC â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            const taskParts = t.parts && t.parts.length ? t.parts : null;
            if (taskParts) {
                // Show overview bar of all parts
                const subParts = (sub && sub.parts) ? sub.parts : [];
                html += '<div style="background:#f3e5f5;border-left:4px solid #9c27b0;border-radius:8px;padding:10px 14px;margin-bottom:14px;font-size:0.88em">';
                html += '<strong style="color:#6a1b9a">ðŸ“‹ This task has ' + taskParts.length + ' parts</strong> â€” each part needs admin approval before the next unlocks.<br>';
                html += '<div style="display:flex;flex-wrap:wrap;gap:6px;margin-top:8px">';
                taskParts.forEach((pName, pi) => {
                    const ps = subParts[pi];
                    const icon = !ps ? 'â¬œ' : ps.status === 'approved' ? 'âœ…' : ps.status === 'rejected' ? 'âŒ' : 'â³';
                    html += '<span style="background:white;border:1px solid #ce93d8;border-radius:6px;padding:3px 8px;font-size:0.82em">' + icon + ' Part ' + (pi+1) + '</span>';
                });
                html += '</div></div>';

                if (state === 'active' || state === 'rejected') {
                    // Find the first part that needs action (not approved yet)
                    let activePartIdx = 0;
                    for (let pi = 0; pi < taskParts.length; pi++) {
                        const ps = subParts[pi];
                        if (ps && ps.status === 'approved') { activePartIdx = pi + 1; continue; }
                        if (ps && ps.status === 'pending') {
                            // This part is under review â€” show waiting
                            html += '<div style="background:#fff3e0;border:2px solid #ff9800;border-radius:8px;padding:12px 14px;margin-bottom:10px">';
                            html += '<strong style="color:#e65100">â³ Part ' + (pi+1) + ' Under Review</strong><br>';
                            html += '<span style="font-size:0.85em;color:#666">Part ' + (pi+2) + ' will unlock after Part ' + (pi+1) + ' is approved.</span></div>';
                        } else {
                            // This part needs to be submitted (new or rejected)
                            if (ps && ps.status === 'rejected') {
                                html += '<div style="background:#ffebee;border:2px solid #f44336;border-radius:8px;padding:10px 14px;margin-bottom:10px">';
                                html += '<strong style="color:#c62828">âŒ Part ' + (pi+1) + ' Rejected â€” Please reupload</strong>';
                                if (ps.rejectionReason) html += '<div style="margin-top:6px;font-size:0.85em;background:#fff0f0;border-left:3px solid #f44336;padding:7px 10px;border-radius:0 6px 6px 0"><strong>ðŸ“ Reason:</strong> ' + shEsc(ps.rejectionReason) + '</div>';
                                html += '</div>';
                            }
                            if (ps && ps.photoUrl) html += '<div style="margin:8px 0;font-size:0.82em;color:#6a1b9a;font-weight:700">ðŸ“¸ Part ' + (pi+1) + ' previous photo:</div><div style="margin:6px 0"><img src="' + ps.photoUrl + '" class="sh-preview-img" onclick="shViewPhoto(this.src)"></div>';
                            html += '<div style="font-weight:700;color:#6a1b9a;margin-bottom:6px">ðŸ“¸ Part ' + (pi+1) + ': ' + shEsc(taskParts[pi]) + '</div>';
                            const fpid = 'shPartFile_' + t.id + '_' + pi;
                            html += '<div class="sh-upload-zone" id="shPartZone_' + t.id + '_' + pi + '" onclick="document.getElementById(\'' + fpid + '\').click()">';
                            html += '<div style="font-size:2em;margin-bottom:8px">ðŸ“¸</div>';
                            html += '<p style="color:#9c27b0;font-weight:600;margin:0">Tap to take / upload Part ' + (pi+1) + ' photo</p>';
                            html += '<p style="color:#999;font-size:0.85em;margin:4px 0 0">JPG/PNG, max 5MB</p>';
                            html += '<input type="file" id="' + fpid + '" accept="image/*" capture="environment" style="display:none" onchange="shPartFileSelected(\'' + t.id + '\',' + pi + ',this)">';
                            html += '<img id="shPartThumb_' + t.id + '_' + pi + '" class="sh-preview-img" style="display:none"></div>';
                            html += '<div style="margin-top:12px">';
                            html += '<label style="display:block;font-weight:700;color:#6a1b9a;margin-bottom:6px;font-size:.95em">ðŸ’¬ Comment for Part ' + (pi+1) + ' <span style="color:#f44336">*</span></label>';
                            html += '<textarea id="shPartComment_' + t.id + '_' + pi + '" rows="2" placeholder="Describe what you did for this part..." style="width:100%;padding:10px 14px;border:2px solid #9c27b0;border-radius:8px;font-size:.95em;resize:vertical;font-family:inherit;box-sizing:border-box"></textarea>';
                            html += '</div>';
                            html += '<button class="btn btn-success" style="margin-top:10px;width:100%" onclick="shUploadPart(\'' + t.id + '\',' + pi + ',' + taskParts.length + ')">ðŸ“¤ Submit Part ' + (pi+1) + ' Photo</button>';
                            html += '<div id="shPartUploadMsg_' + t.id + '_' + pi + '" style="margin-top:8px;font-size:0.9em;display:none"></div>';
                        }
                        break; // Only show one part at a time
                    }
                    // If all parts done (approved), nothing more to show
                    if (activePartIdx >= taskParts.length) {
                        html += '<div style="background:#e8f5e9;border:2px solid #4caf50;border-radius:8px;padding:12px;text-align:center;font-weight:700;color:#2e7d32">ðŸŽ‰ All parts submitted and approved!</div>';
                    }
                } else if (state === 'pending') {
                    // Find which part is pending
                    for (let pi = 0; pi < taskParts.length; pi++) {
                        const ps = subParts[pi];
                        if (ps && ps.status === 'pending') {
                            html += '<div style="background:#fff3e0;border:2px solid #ff9800;border-radius:8px;padding:10px 14px;margin-bottom:8px;display:flex;align-items:center;gap:8px">';
                            html += '<span style="font-size:1.3em">â³</span><div><strong style="color:#e65100">Part ' + (pi+1) + ' Under Review</strong><br>';
                            html += '<span style="font-size:0.78em;color:#666">Waiting for admin approval</span></div></div>';
                        }
                    }
                }
            } else {
                // â”€â”€ SINGLE-PHOTO TASK (original flow) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                if (state==='active' || state==='rejected') {
                    const fid = 'shFileInput_' + t.id;
                    html += '<div class="sh-upload-zone" id="shZone_' + t.id + '" onclick="document.getElementById(\'' + fid + '\').click()">';
                    html += '<div style="font-size:2em;margin-bottom:8px">ðŸ“¸</div>';
                    html += '<p style="color:#9c27b0;font-weight:600;margin:0">Tap to take / upload photo proof</p>';
                    html += '<p style="color:#999;font-size:0.85em;margin:4px 0 0">JPG/PNG, max 5MB</p>';
                    html += '<input type="file" id="' + fid + '" accept="image/*" capture="environment" style="display:none" onchange="shFileSelected(\'' + t.id + '\',this)">';
                    html += '<img id="shThumb_' + t.id + '" class="sh-preview-img" style="display:none"></div>';
                    if (shSettings.gps && t.lat && t.lng) html += '<div id="shDistInfo_' + t.id + '" style="margin-top:8px;font-size:0.88em;color:#1565c0">ðŸ“¡ Checking distance...</div>';
                    html += '<div style="margin-top:14px">';
                    html += '<label style="display:block;font-weight:700;color:#6a1b9a;margin-bottom:6px;font-size:.95em">ðŸ’¬ Your Comment <span style="color:#f44336">*</span> <span style="font-weight:normal;color:#888;font-size:.85em">(required)</span></label>';
                    html += '<textarea id="shComment_' + t.id + '" rows="3" placeholder="Describe what you did, who you met, or anything interesting about completing this task..." style="width:100%;padding:10px 14px;border:2px solid #9c27b0;border-radius:8px;font-size:.95em;resize:vertical;font-family:inherit;box-sizing:border-box" oninput="shCommentChanged(\'' + t.id + '\')"></textarea>';
                    html += '<p style="color:#f44336;font-size:.82em;margin:4px 0 0;display:none" id="shCommentErr_' + t.id + '">âš ï¸ Please write a comment before submitting.</p>';
                    html += '</div>';
                    html += '<button class="btn btn-success" style="margin-top:12px;width:100%" onclick="shUploadPhoto(\'' + t.id + '\')">ðŸ“¤ Submit Photo + Comment</button>';
                    html += '<div id="shUploadMsg_' + t.id + '" style="margin-top:8px;font-size:0.9em;display:none"></div>';
                }
            }
            html += '</div>';
        });
        el.innerHTML = html;
        if (shUserLat !== null) shUpdateDistances();
    }

    // â”€â”€ N-Parts: dynamic part input helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // â”€â”€ Task image preview helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function shPreviewNewTaskImage(input) {
        const file = input.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = e => {
            document.getElementById('shNewTaskImagePreviewImg').src = e.target.result;
            document.getElementById('shNewTaskImagePreview').style.display = 'block';
        };
        reader.readAsDataURL(file);
    }
    function shClearNewTaskImage() {
        document.getElementById('shNewTaskImageFile').value = '';
        document.getElementById('shNewTaskImagePreview').style.display = 'none';
        document.getElementById('shNewTaskImageMsg').textContent = 'Image will upload automatically when you save the task.';
        document.getElementById('shNewTaskImageMsg').style.color = '#888';
    }
    function shPreviewEditTaskImage(input) {
        const file = input.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = e => {
            document.getElementById('shEditImagePreviewImg').src = e.target.result;
            document.getElementById('shEditImagePreview').style.display = 'block';
        };
        reader.readAsDataURL(file);
    }
    function shClearEditTaskImage() {
        document.getElementById('shEditImageFile').value = '';
        document.getElementById('shEditImagePreview').style.display = 'none';
    }
    function shRemoveEditCurrentImage() {
        document.getElementById('shEditCurrentImageUrl').value = '';
        document.getElementById('shEditImageCurrentBox').innerHTML = '<span style="font-size:0.82em;color:#aaa">Image removed. Save to confirm.</span>';
    }

    function shAddNewTaskPart(value) {
        const box = document.getElementById('shNewTaskPartsBox');
        const idx = box.children.length;
        const row = document.createElement('div');
        row.style.cssText = 'display:flex;gap:6px;align-items:center';
        row.innerHTML = '<span style="font-size:0.82em;font-weight:700;color:#9c27b0;min-width:52px">Part '+(idx+1)+':</span>'
            +'<input type="text" class="sh-part-input" value="'+(value||'')+'" placeholder="Describe what to photo for this part" style="flex:1;padding:7px 10px;border:1.5px solid #ce93d8;border-radius:7px;font-size:0.92em">'
            +'<button type="button" onclick="this.parentElement.remove();shRenumberParts(\'shNewTaskPartsBox\')" style="background:#ffebee;color:#c62828;border:1px solid #ef9a9a;border-radius:6px;padding:4px 8px;cursor:pointer;font-size:0.82em">âœ•</button>';
        box.appendChild(row);
    }

    function shAddEditPart(value, num) {
        const box = document.getElementById('shEditPartsBox');
        const idx = num !== undefined ? num - 1 : box.children.length;
        const row = document.createElement('div');
        row.style.cssText = 'display:flex;gap:6px;align-items:center';
        row.innerHTML = '<span style="font-size:0.82em;font-weight:700;color:#9c27b0;min-width:52px">Part '+(idx+1)+':</span>'
            +'<input type="text" class="sh-part-input" value="'+(value||'')+'" placeholder="Describe what to photo for this part" style="flex:1;padding:7px 10px;border:1.5px solid #ce93d8;border-radius:7px;font-size:0.92em">'
            +'<button type="button" onclick="this.parentElement.remove();shRenumberParts(\'shEditPartsBox\')" style="background:#ffebee;color:#c62828;border:1px solid #ef9a9a;border-radius:6px;padding:4px 8px;cursor:pointer;font-size:0.82em">âœ•</button>';
        box.appendChild(row);
    }

    function shRenumberParts(boxId) {
        const box = document.getElementById(boxId);
        if (!box) return;
        Array.from(box.children).forEach((row, i) => {
            const lbl = row.querySelector('span');
            if (lbl) lbl.textContent = 'Part ' + (i+1) + ':';
        });
    }

    // â”€â”€ N-Parts: student part file selection & upload â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function shPartFileSelected(taskId, partIdx, input) {
        if (!input.files || !input.files[0]) return;
        const reader = new FileReader();
        reader.onload = e => {
            const thumb = document.getElementById('shPartThumb_' + taskId + '_' + partIdx);
            const zone  = document.getElementById('shPartZone_'  + taskId + '_' + partIdx);
            if (thumb) { thumb.src = e.target.result; thumb.style.display = 'block'; }
            if (zone)  zone.classList.add('has-file');
        };
        reader.readAsDataURL(input.files[0]);
    }

    async function shUploadPart(taskId, partIdx, totalParts) {
        const input   = document.getElementById('shPartFile_'       + taskId + '_' + partIdx);
        const msgEl   = document.getElementById('shPartUploadMsg_'  + taskId + '_' + partIdx);
        const comment = (document.getElementById('shPartComment_'   + taskId + '_' + partIdx)?.value || '').trim();
        if (!input || !input.files || !input.files[0]) { shShowInlineMsg(msgEl,'error','ðŸ“¸ Select a photo first.'); return; }
        if (!comment) { shShowInlineMsg(msgEl,'error','âš ï¸ Please write a comment.'); return; }
        if (input.files[0].size > 5*1024*1024) { shShowInlineMsg(msgEl,'error','âŒ File too large. Max 5MB.'); return; }

        // Server-side guard: verify previous parts are approved
        const existingSnap = await window.db.ref('scavengerHunt/submissions/'+shCurrentUser.key+'/'+taskId).once('value');
        const existing = existingSnap.val() || {};
        const subParts = existing.parts || [];
        if (partIdx > 0) {
            const prevPart = subParts[partIdx - 1];
            if (!prevPart || prevPart.status !== 'approved') {
                shShowInlineMsg(msgEl,'error','ðŸ”’ Part ' + partIdx + ' must be approved before submitting Part ' + (partIdx+1) + '.'); return;
            }
        }

        shShowInlineMsg(msgEl,'info','â³ Uploading Part ' + (partIdx+1) + ' to storage...');
        try {
            const photoUrl = await shUploadToStorage(input.files[0], shCurrentUser.key, taskId, 'part' + partIdx);
            const newParts = [...subParts];
            newParts[partIdx] = { photoUrl, status: 'pending', comment, submittedAt: new Date().toISOString() };

            // If this is Part 1 (first ever submission), create the main sub record too
            if (partIdx === 0) {
                await window.db.ref('scavengerHunt/submissions/'+shCurrentUser.key+'/'+taskId).set({
                    taskId, taskName: shTasks.find(t=>t.id===taskId)?.name || '',
                    status: 'pending', submittedAt: new Date().toISOString(),
                    parts: newParts
                });
            } else {
                await window.db.ref('scavengerHunt/submissions/'+shCurrentUser.key+'/'+taskId+'/parts/'+partIdx).set(newParts[partIdx]);
            }
            shShowInlineMsg(msgEl,'success','âœ… Part ' + (partIdx+1) + ' submitted! Waiting for admin review.');
            setTimeout(() => shLoadStudentDashboard(), 1500);
        } catch(e) {
            shShowInlineMsg(msgEl,'error','âŒ Upload failed: '+e.message);
        }
    }

    // â”€â”€ GPS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function shGetLocation() {
        const statusEl = document.getElementById('shGpsStatusText');
        if (!navigator.geolocation) { if(statusEl) statusEl.textContent='âš ï¸ GPS not available.'; return; }
        if (statusEl) statusEl.textContent = 'ðŸ”„ Getting location...';
        if (shGpsWatchId) navigator.geolocation.clearWatch(shGpsWatchId);
        shGpsWatchId = navigator.geolocation.watchPosition(
            pos => {
                shUserLat = pos.coords.latitude; shUserLng = pos.coords.longitude;
                if (statusEl) statusEl.textContent = 'âœ… Location found (Â±' + Math.round(pos.coords.accuracy) + 'm)';
                shUpdateDistances();
            },
            err => { if(statusEl) statusEl.textContent = 'âŒ ' + (err.message||'Location denied'); },
            { enableHighAccuracy:true, maximumAge:10000, timeout:15000 }
        );
    }

    function shUpdateDistances() {
        shTasks.forEach(t => {
            if (!t.lat || !t.lng) return;
            const el = document.getElementById('shDistInfo_' + t.id);
            if (!el) return;
            const dist = Math.round(shHaversine(shUserLat, shUserLng, t.lat, t.lng));
            const radius = shSettings.radius || 100;
            el.innerHTML = dist <= radius
                ? '<span style="color:#2e7d32;font-weight:700">âœ… You are ' + dist + 'm away â€” within range!</span>'
                : '<span style="color:#c62828">â— You are ' + dist + 'm away. Move closer (need ' + radius + 'm).</span>';
        });
    }

    function shHaversine(lat1,lon1,lat2,lon2) {
        const R=6371000, dLat=(lat2-lat1)*Math.PI/180, dLon=(lon2-lon1)*Math.PI/180;
        const a=Math.sin(dLat/2)*Math.sin(dLat/2)+Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)*Math.sin(dLon/2);
        return R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
    }

    // â”€â”€ File preview â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function shFileSelected(taskId, input) {
        if (!input.files || !input.files[0]) return;
        const reader = new FileReader();
        reader.onload = e => {
            const thumb = document.getElementById('shThumb_' + taskId);
            const zone  = document.getElementById('shZone_' + taskId);
            if (thumb) { thumb.src = e.target.result; thumb.style.display = 'block'; }
            if (zone)  zone.classList.add('has-file');
        };
        reader.readAsDataURL(input.files[0]);
    }

    // â”€â”€ Upload photo â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function shUploadPhoto(taskId) {
        const task    = shTasks.find(t => t.id === taskId);
        const input   = document.getElementById('shFileInput_' + taskId);
        const msgEl   = document.getElementById('shUploadMsg_' + taskId);
        const btnEl   = document.querySelector('#shTask_' + taskId + ' .btn-success');
        const comment = (document.getElementById('shComment_' + taskId)?.value || '').trim();
        const commentErr = document.getElementById('shCommentErr_' + taskId);

        // Validate photo
        if (!input || !input.files || !input.files[0]) { shShowInlineMsg(msgEl,'error','ðŸ“¸ Select a photo first.'); return; }

        // Validate comment â€” REQUIRED
        if (!comment) {
            if (commentErr) { commentErr.style.display = 'block'; }
            document.getElementById('shComment_' + taskId)?.focus();
            shShowInlineMsg(msgEl,'error','ðŸ’¬ Please write a comment before submitting.');
            return;
        }
        if (commentErr) commentErr.style.display = 'none';
        if (shSettings.gps && task.lat && task.lng) {
            if (shUserLat===null) { shShowInlineMsg(msgEl,'error','âŒ GPS not ready. Wait and retry.'); return; }
            const dist = shHaversine(shUserLat,shUserLng,task.lat,task.lng);
            if (dist > (shSettings.radius||100)) { shShowInlineMsg(msgEl,'error','âŒ Too far! '+Math.round(dist)+'m away. Need '+( shSettings.radius||100)+'m.'); return; }
        }
        // â”€â”€ Server-side chain guard (re-verify before writing) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // Re-fetch the full task list and submissions from Firebase right now
        // to enforce the sequential chain even if the UI state is stale or
        // a previous task was deleted and caused an incorrect index offset.
        try {
            const [liveTaskSnap, liveSubSnap] = await Promise.all([
                window.db.ref('scavengerHunt/tasks').once('value'),
                window.db.ref('scavengerHunt/submissions/'+shCurrentUser.key).once('value')
            ]);
            const liveTasksRaw  = liveTaskSnap.val() || {};
            const liveTasks     = Object.entries(liveTasksRaw)
                                    .map(([k,v])=>({id:k,...v}))
                                    .sort((a,b)=>(a.order||0)-(b.order||0));
            const liveSubs      = liveSubSnap.val() || {};
            // Find where this task sits in the live sorted list
            const liveTaskIdx   = liveTasks.findIndex(t => t.id === taskId);
            const liveMinOrder  = liveTasks.length > 0 ? (liveTasks[0].order || 1) : 1;
            const liveTaskOrder = liveTaskIdx >= 0 ? (liveTasks[liveTaskIdx].order || (liveTaskIdx+1)) : 999;
            // Count consecutive approved tasks from the beginning of the live list
            let liveApprovedCount = 0;
            for (let i = 0; i < liveTasks.length; i++) {
                const s = liveSubs[liveTasks[i].id];
                if (s && s.status === 'approved' && s.submittedAt) { liveApprovedCount++; }
                else { break; }
            }
            // Gate: task at liveTaskIdx=0 only if it genuinely has the minimum order;
            // otherwise require all prior tasks to be approved
            // liveTaskIdx===0 = first task in sorted list = always allow submission
            const liveAllPrevOk = (liveTaskIdx === 0) || liveApprovedCount >= liveTaskIdx;
            if (!liveAllPrevOk) {
                shShowInlineMsg(msgEl,'error','ðŸ”’ Cannot submit: previous task(s) must be approved first.');
                return;
            }
        } catch(chainErr) {
            console.error('Chain guard error:', chainErr);
            shShowInlineMsg(msgEl,'error','âŒ Could not verify task chain. Please retry.');
            return;
        }
        // â”€â”€ End chain guard â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        if (btnEl) { btnEl.disabled=true; btnEl.textContent='â³ Uploading...'; }
        shShowInlineMsg(msgEl,'info','â³ Uploading photo to storage...');
        try {
            const file = input.files[0];
            if (file.size > 5*1024*1024) { shShowInlineMsg(msgEl,'error','âŒ File too large. Max 5MB.'); if(btnEl){btnEl.disabled=false;btnEl.textContent='ðŸ“¤ Submit Photo Proof';} return; }
            const photoUrl = await shUploadToStorage(file, shCurrentUser.key, taskId, 'p1');
            const subData = {
                taskId, taskName:task.name,
                studentKey:shCurrentUser.key, studentName:shCurrentUser.name,
                studentEmail:shCurrentUser.email, studentClass:shCurrentUser.class||shCurrentUser.classYear||'',
                photoUrl,
                comment: comment,
                status: shSettings.autoApprove && (!shSettings.gps||!task.lat) ? 'approved' : 'pending',
                submittedAt:new Date().toISOString(), lat:shUserLat, lng:shUserLng
            };
            await window.db.ref('scavengerHunt/submissions/'+shCurrentUser.key+'/'+taskId).set(subData);
            shShowInlineMsg(msgEl,'success','âœ… Submitted! '+(subData.status==='approved'?'Auto-approved!':'Waiting for admin review.'));
            if(btnEl){btnEl.disabled=false;btnEl.textContent='ðŸ“¤ Submit Photo Proof';}
            setTimeout(() => shLoadStudentDashboard(), 1500);
        } catch(e) {
            shShowInlineMsg(msgEl,'error','âŒ Upload failed: '+e.message);
            if(btnEl){btnEl.disabled=false;btnEl.textContent='ðŸ“¤ Submit Photo Proof';}
        }
    }

    function shResetSubmissionFilters() {
        const sf = document.getElementById('shSubmissionFilter');
        const df = document.getElementById('shSubmissionDateFilter');
        const tf = document.getElementById('shSubmissionTaskFilter');
        if (sf) sf.value = 'all';
        if (df) df.value = 'all';
        if (tf) tf.value = 'all';
        shAdminLoadSubmissions();
    }

    function shCommentChanged(taskId) {
        const val = (document.getElementById('shComment_' + taskId)?.value || '').trim();
        const err = document.getElementById('shCommentErr_' + taskId);
        if (err) err.style.display = val ? 'none' : 'block';
    }

    // â”€â”€ Upload photo to Cloudinary, return secure URL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // Cloud: dat0khbet | Preset: scavenger_hunt (unsigned)
    async function shUploadToStorage(file, studentKey, taskId, partLabel) {
        const formData = new FormData();
        formData.append('file', file);
        formData.append('upload_preset', 'scavenger_hunt');
        formData.append('folder', 'scavenger_hunt/' + studentKey);
        formData.append('public_id', taskId + '_' + partLabel + '_' + Date.now());
        const res = await fetch('https://api.cloudinary.com/v1_1/dat0khbet/image/upload', {
            method: 'POST',
            body: formData
        });
        if (!res.ok) {
            const err = await res.json();
            throw new Error(err.error?.message || 'Cloudinary upload failed');
        }
        const data = await res.json();
        return data.secure_url;
    }

    // Keep shFileToBase64 only for thumbnail previews (not used for storage anymore)
    function shFileToBase64(file) {
        return new Promise((res,rej) => { const r=new FileReader(); r.onload=()=>res(r.result); r.onerror=rej; r.readAsDataURL(file); });
    }

    // â”€â”€ Photo lightbox â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function shViewPhoto(src) {
        const d = document.createElement('div');
        d.className = 'sh-photo-modal';
        d.onclick = () => document.body.removeChild(d);
        d.innerHTML = '<img src="' + src + '" alt="proof"><br><span style="color:white;font-size:0.85em;margin-top:10px;display:block;text-align:center">Click anywhere to close</span>';
        document.body.appendChild(d);
    }

    // â”€â”€ Admin Tab switching â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function shAdminTab(id, btn) {
        ['shAdminTasks','shAdminSubmissions','shAdminLeaderboard','shAdminClasswise','shAdminWinners','shAdminSettings'].forEach(pid => {
            const el = document.getElementById(pid);
            if (el) el.style.display = (pid===id) ? 'block' : 'none';
        });
        document.querySelectorAll('#scavengerAdmin .tabs .tab').forEach(t => t.classList.remove('active'));
        if (btn) btn.classList.add('active');
        if (id==='shAdminTasks')       shAdminLoadTasks();
        if (id==='shAdminSubmissions') shAdminLoadSubmissions();
        if (id==='shAdminLeaderboard') shAdminLoadLeaderboard();
        if (id==='shAdminClasswise')   shAdminLoadClasswise();
        if (id==='shAdminWinners')     { shLoadWinnersTab(); shInitAutoDeclarScheduler(); }
        if (id==='shAdminSettings')    { shAdminLoadSettings(); shPopulateAfsTaskDropdown(); }
    }

    // â”€â”€ Admin: Create task â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function shAdminCreateTask() {
        const name     = document.getElementById('shNewTaskName').value.trim();
        const hint     = document.getElementById('shNewTaskHint').value.trim();
        const order    = parseInt(document.getElementById('shNewTaskOrder').value)||1;
        const lat      = parseFloat(document.getElementById('shNewTaskLat').value)||null;
        const lng      = parseFloat(document.getElementById('shNewTaskLng').value)||null;
        if (!name) { alert('Task name is required'); return; }
        const availFrom = document.getElementById('shNewTaskDate').value;
        const deadline  = document.getElementById('shNewTaskDeadline').value;
        // Collect parts from dynamic fields
        const partInputs = document.querySelectorAll('#shNewTaskPartsBox .sh-part-input');
        const parts = [];
        partInputs.forEach(inp => { const v = inp.value.trim(); if (v) parts.push(v); });

        // Upload image if selected
        const imgFile = document.getElementById('shNewTaskImageFile').files[0];
        let imageUrl = null;
        if (imgFile) {
            const msgEl = document.getElementById('shNewTaskImageMsg');
            msgEl.textContent = 'â³ Uploading imageâ€¦';
            msgEl.style.color = '#1565c0';
            try {
                const fd = new FormData();
                fd.append('file', imgFile);
                fd.append('upload_preset', 'scavenger_hunt');
                fd.append('folder', 'scavenger_hunt/task_images');
                fd.append('public_id', 'task_img_' + Date.now());
                const res = await fetch('https://api.cloudinary.com/v1_1/dat0khbet/image/upload', { method:'POST', body:fd });
                if (!res.ok) throw new Error((await res.json()).error?.message || 'Upload failed');
                imageUrl = (await res.json()).secure_url;
                msgEl.textContent = 'âœ… Image uploaded!';
                msgEl.style.color = '#2e7d32';
            } catch(e) {
                alert('Image upload failed: ' + e.message + '\nTask not saved. Please try again.');
                document.getElementById('shNewTaskImageMsg').textContent = 'âŒ Upload failed â€” try again';
                document.getElementById('shNewTaskImageMsg').style.color = '#c62828';
                return;
            }
        }

        const task = { name, order, createdAt:new Date().toISOString() };
        if (hint)          task.hint  = hint;
        if (imageUrl)      task.image = imageUrl;
        if (parts.length)  task.parts = parts;
        if (lat && lng) { task.lat=lat; task.lng=lng; }
        if (availFrom)  task.availableFrom = new Date(availFrom).toISOString();
        if (deadline)   task.deadline      = new Date(deadline).toISOString();
        await window.db.ref('scavengerHunt/tasks').push(task);

        // Show brief success badge
        const msgEl = document.getElementById('shCreateTaskMsg');
        msgEl.style.display = 'inline-block';
        setTimeout(()=>{ msgEl.style.display='none'; }, 3000);

        // Reset form
        document.getElementById('shNewTaskName').value     = '';
        document.getElementById('shNewTaskHint').value     = '';
        document.getElementById('shNewTaskPartsBox').innerHTML = '';
        document.getElementById('shNewTaskOrder').value    = order + 1;
        document.getElementById('shNewTaskLat').value      = '';
        document.getElementById('shNewTaskLng').value      = '';
        document.getElementById('shNewTaskDate').value     = '';
        document.getElementById('shNewTaskDeadline').value = '';
        document.getElementById('shNewTaskImageFile').value = '';
        document.getElementById('shNewTaskImagePreview').style.display = 'none';
        document.getElementById('shNewTaskImageMsg').textContent = 'Image will upload automatically when you save the task.';
        document.getElementById('shNewTaskImageMsg').style.color = '#888';
        // Reload tasks list â€” this also rebuilds the WhatsApp message for ALL tasks
        shAdminLoadTasks();
    }

    function shCopyWaMsg() {
        const ta = document.getElementById('shWaText');
        ta.select();
        try {
            navigator.clipboard.writeText(ta.value).then(() => {
                const btn = document.getElementById('shWaCopyBtn');
                const orig = btn.textContent;
                btn.textContent = 'âœ… Copied!';
                btn.style.background = '#28a745';
                setTimeout(() => { btn.textContent = orig; btn.style.background = ''; }, 2500);
            });
        } catch(e) {
            document.execCommand('copy');
            document.getElementById('shWaCopyBtn').textContent = 'âœ… Copied!';
            setTimeout(() => { document.getElementById('shWaCopyBtn').textContent = 'ðŸ“‹ Copy Message'; }, 2500);
        }
    }

    // â”€â”€ Build WhatsApp message for ALL tasks â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function shBuildWaMsg(tasks) {
        const fmtDT = iso => iso ? new Date(iso).toLocaleString('en-IN',{
            weekday:'short', day:'2-digit', month:'short', year:'numeric',
            hour:'2-digit', minute:'2-digit', hour12:true
        }) : null;

        if (!tasks || !tasks.length) {
            document.getElementById('shWaText').value = '(No tasks yet â€” create a task above to generate the announcement message)';
            return;
        }

        const lines = [
            `ðŸ—ºï¸ *SCAVENGER HUNT â€” SPURTHI YOUTH FEST 2026*`,
            `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”`,
            ``
        ];

        tasks.forEach((t, i) => {
            const num      = t.order || (i + 1);
            const fromFmt  = t.availableFrom ? fmtDT(t.availableFrom) : null;
            const tillFmt  = t.deadline      ? fmtDT(t.deadline)      : null;
            const hasGPS   = t.lat && t.lng;

            // Task header
            lines.push(`ðŸ“Œ *Task ${num}*`);
            lines.push(`â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”`);

            // Task description (full name â€” may be long, show as-is)
            lines.push(`${t.name}`);
            lines.push(``);

            // Hint
            if (t.hint) lines.push(`ðŸ’¡ *Hint:* ${t.hint}`);

            // Timing
            lines.push(fromFmt  ? `â° *Starts :* ${fromFmt}`   : `â° *Starts :* Immediately`);
            lines.push(tillFmt  ? `ðŸ”š *Deadline :* ${tillFmt}` : `ðŸ”š *Deadline :* No deadline`);

            // GPS
            if (hasGPS) lines.push(`ðŸ“ *Location:* GPS-verified task`);

            // Separator between tasks
            if (i < tasks.length - 1) lines.push(``);
        });

        lines.push(``);
        lines.push(`â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”`);
        lines.push(`ðŸ“¸ *How to participate:*`);
        lines.push(`1ï¸âƒ£ Go to: https://davandegree.github.io/spurthi/`);
        lines.push(`2ï¸âƒ£ Select Online Competition â†’ Scavenger Hunt`);
        lines.push(`3ï¸âƒ£ Login with your registered number`);
        lines.push(`4ï¸âƒ£ Complete the task & upload your photo`);
        lines.push(``);
        lines.push(`âš¡ *Be quick â€” points awarded on approval!*`);
        lines.push(``);
        lines.push(`ðŸŽ‰ _Spurthi Youth Fest 2026 â€” Davan Institute_`);

        document.getElementById('shWaText').value = lines.join('\n');
    }

    async function shAdminLoadTasks() {
        const el = document.getElementById('shAdminTasksList');
        if(!el) return;
        el.innerHTML = '<p style="color:#999">Loading...</p>';
        try {
            const snap  = await window.db.ref('scavengerHunt/tasks').once('value');
            window._shTasksCache = snap.val() || {};
            const tasks = Object.entries(window._shTasksCache).map(([k,v])=>({id:k,...v})).sort((a,b)=>(a.order||0)-(b.order||0));
            // Always refresh WhatsApp message with current task list
            shBuildWaMsg(tasks);
            if (!tasks.length) { el.innerHTML='<p style="color:#999">No tasks yet. Create one above.</p>'; return; }

            let html = '';

            // â”€â”€ Inline Edit Panel (hidden by default) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            html += '<div id="shEditPanel" style="display:none;background:#f3e5f5;border:2px solid #9c27b0;border-radius:10px;padding:18px;margin-bottom:18px">';
            html += '<h4 style="color:#6a1b9a;margin:0 0 14px">âœï¸ Edit Task</h4>';
            html += '<div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:14px">';
            html += '<div class="form-group" style="margin:0"><label style="font-size:12px;font-weight:700;color:#6a1b9a">Task Name:</label><input id="shEditName" type="text" style="width:100%"></div>';
            html += '<div class="form-group" style="margin:0"><label style="font-size:12px;font-weight:700;color:#6a1b9a">Hint / Clue:</label><input id="shEditHint" type="text" style="width:100%"></div>';
            html += '<div class="form-group" style="margin:0"><label style="font-size:12px;font-weight:700;color:#6a1b9a">Task Order / Number:</label><input id="shEditOrder" type="number" min="1" style="width:100px"></div>';
            html += '<div class="form-group" style="grid-column:1/-1;margin:0"><label style="font-size:12px;font-weight:700;color:#6a1b9a">ðŸ–¼ï¸ Task Image (optional):</label>';
            html += '<div id="shEditImageCurrentBox" style="margin-bottom:8px"></div>';
            html += '<input type="file" id="shEditImageFile" accept="image/*" onchange="shPreviewEditTaskImage(this)" style="display:block;margin-bottom:6px">';
            html += '<div id="shEditImagePreview" style="display:none;margin-bottom:6px"><img id="shEditImagePreviewImg" style="max-width:200px;max-height:140px;border-radius:8px;border:2px solid #ce93d8" alt="preview"><button type="button" onclick="shClearEditTaskImage()" style="display:block;margin-top:4px;background:#ffebee;color:#c62828;border:1px solid #ef9a9a;border-radius:6px;padding:3px 10px;cursor:pointer;font-size:0.82em">âœ• Remove new image</button></div>';
            html += '<span id="shEditImageMsg" style="font-size:0.82em;color:#888">Upload a new image to replace, or leave empty to keep existing.</span></div>';
            html += '<div class="form-group" style="grid-column:1/-1;margin:0"><label style="font-size:12px;font-weight:700;color:#9c27b0">ðŸ“¸ Task Parts (multi-photo, optional):</label>';
            html += '<div id="shEditPartsBox" style="display:flex;flex-direction:column;gap:6px;margin-bottom:6px"></div>';
            html += '<button type="button" onclick="shAddEditPart()" style="background:#e8f5e9;color:#2e7d32;border:2px dashed #4caf50;border-radius:8px;padding:5px 12px;cursor:pointer;font-size:0.85em;font-weight:700">âž• Add Part</button>';
            html += '<span style="font-size:0.78em;color:#888;display:block;margin-top:3px">Each part = one photo. Leave empty = single-photo task.</span></div>';
            html += '<div class="form-group" style="margin:0"><label style="font-size:12px;font-weight:700;color:#6a1b9a">ðŸ“… Available From:</label><input id="shEditFrom" type="datetime-local" style="padding:7px 10px;border:2px solid #9c27b0;border-radius:8px;font-size:0.93em"></div>';
            html += '<div class="form-group" style="margin:0"><label style="font-size:12px;font-weight:700;color:#6a1b9a">â° Available Until:</label><input id="shEditTill" type="datetime-local" style="padding:7px 10px;border:2px solid #e91e63;border-radius:8px;font-size:0.93em"></div>';
            html += '<div class="form-group" style="margin:0"><label style="font-size:12px;font-weight:700;color:#1565c0">ðŸ“ GPS Lat / Lng (optional):</label>';
            html += '<div style="display:flex;gap:8px"><input id="shEditLat" type="number" step="0.000001" placeholder="Latitude" style="width:130px"><input id="shEditLng" type="number" step="0.000001" placeholder="Longitude" style="width:130px"></div></div>';
            html += '</div>';
            html += '<input type="hidden" id="shEditId">';
            html += '<input type="hidden" id="shEditCurrentImageUrl">';
            html += '<div style="display:flex;gap:8px;align-items:center">';
            html += '<button class="btn btn-success" onclick="shAdminSaveTask()">ðŸ’¾ Save Changes</button>';
            html += '<button class="btn btn-secondary" onclick="shAdminCancelEditTask()">âœ– Cancel</button>';
            html += '<span id="shEditMsg" style="font-size:13px;color:#4caf50;display:none;font-weight:600">âœ… Saved!</span>';
            html += '</div></div>';

            // â”€â”€ Tasks Table â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            html += '<div class="table-wrapper"><table><thead><tr><th>#</th><th>Task</th><th>Image</th><th>Hint</th><th>From</th><th>Until</th><th>GPS</th><th style="min-width:70px">Edit</th><th>Delete</th></tr></thead><tbody>';
            tasks.forEach(t => {
                const gps     = t.lat ? '<span class="sh-gps-badge" style="font-size:0.75em">ðŸ“ Set</span>' : '<span style="color:#999">â€”</span>';
                const fromStr = t.availableFrom ? new Date(t.availableFrom).toLocaleString('en-IN',{day:'2-digit',month:'short',hour:'2-digit',minute:'2-digit',hour12:true}) : 'â€”';
                const tillStr = t.deadline      ? new Date(t.deadline).toLocaleString('en-IN',{day:'2-digit',month:'short',hour:'2-digit',minute:'2-digit',hour12:true}) : 'â€”';
                const imgCell = t.image ? '<img src="'+t.image+'" style="width:48px;height:36px;object-fit:cover;border-radius:5px;border:1px solid #ce93d8;cursor:pointer" onclick="shViewPhoto(\''+t.image+'\')" title="Click to view">' : '<span style="color:#ccc;font-size:0.82em">â€”</span>';
                html += '<tr id="shTaskRow_'+t.id+'">';
                html += '<td><strong>'+(t.order||'-')+'</strong></td>';
                html += '<td>'+shEsc(t.name)+'</td>';
                html += '<td>'+imgCell+'</td>';
                html += '<td style="color:#795548;font-size:0.9em">'+shEsc(t.hint||'â€”')+'</td>';
                html += '<td style="font-size:0.82em;color:#1565c0;white-space:nowrap">'+fromStr+'</td>';
                html += '<td style="font-size:0.82em;color:#c62828;white-space:nowrap">'+tillStr+'</td>';
                html += '<td>'+gps+'</td>';
                html += '<td><button class="btn btn-info btn-small" onclick="shAdminEditTask(\''+t.id+'\')">âœï¸ Edit</button></td>';
                html += '<td><button class="delete-btn" onclick="shAdminDeleteTask(\''+t.id+'\')">ðŸ—‘ï¸</button></td>';
                html += '</tr>';
            });
            html += '</tbody></table></div>';
            el.innerHTML = html;
        } catch(e) { el.innerHTML='<p style="color:red">Error: '+e.message+'</p>'; }
    }

    function shAdminEditTask(id) {
        const t = window._shTasksCache && window._shTasksCache[id];
        if (!t) { alert('Task not found â€” please refresh.'); return; }

        // Populate the edit panel
        document.getElementById('shEditId').value    = id;
        document.getElementById('shEditName').value  = t.name  || '';
        document.getElementById('shEditHint').value  = t.hint  || '';
        document.getElementById('shEditOrder').value = t.order || 1;
        // Populate existing image
        document.getElementById('shEditCurrentImageUrl').value = t.image || '';
        document.getElementById('shEditImageFile').value = '';
        document.getElementById('shEditImagePreview').style.display = 'none';
        const curBox = document.getElementById('shEditImageCurrentBox');
        if (t.image) {
            curBox.innerHTML = '<div style="margin-bottom:6px"><span style="font-size:0.82em;color:#6a1b9a;font-weight:700">Current image:</span><br>'
                + '<img src="'+t.image+'" style="max-width:180px;max-height:120px;border-radius:8px;border:2px solid #ce93d8;margin-top:4px" alt="current">'
                + '<button type="button" onclick="shRemoveEditCurrentImage()" style="display:block;margin-top:4px;background:#ffebee;color:#c62828;border:1px solid #ef9a9a;border-radius:6px;padding:3px 10px;cursor:pointer;font-size:0.82em">ðŸ—‘ï¸ Remove current image</button></div>';
        } else {
            curBox.innerHTML = '<span style="font-size:0.82em;color:#aaa">No image set.</span>';
        }
        // Populate parts
        const editBox = document.getElementById('shEditPartsBox');
        editBox.innerHTML = '';
        (t.parts || []).forEach((p, i) => shAddEditPart(p, i+1));
        document.getElementById('shEditLat').value   = t.lat   || '';
        document.getElementById('shEditLng').value   = t.lng   || '';
        document.getElementById('shEditFrom').value  = t.availableFrom ? new Date(t.availableFrom).toISOString().slice(0,16) : '';
        document.getElementById('shEditTill').value  = t.deadline      ? new Date(t.deadline).toISOString().slice(0,16) : '';
        document.getElementById('shEditMsg').style.display = 'none';

        // Show panel and scroll to it
        const panel = document.getElementById('shEditPanel');
        panel.style.display = 'block';
        panel.scrollIntoView({behavior:'smooth', block:'start'});

        // Highlight the row being edited
        document.querySelectorAll('#shAdminTasksList tr').forEach(r => r.style.background = '');
        const row = document.getElementById('shTaskRow_'+id);
        if (row) row.style.background = '#fce4ec';
    }

    function shAdminCancelEditTask() {
        document.getElementById('shEditPanel').style.display = 'none';
        document.querySelectorAll('#shAdminTasksList tr').forEach(r => r.style.background = '');
    }

    async function shAdminSaveTask() {
        const id    = document.getElementById('shEditId').value;
        const name  = document.getElementById('shEditName').value.trim();
        const hint  = document.getElementById('shEditHint').value.trim();
        const order = parseInt(document.getElementById('shEditOrder').value) || 1;
        const fromV = document.getElementById('shEditFrom').value;
        const tillV = document.getElementById('shEditTill').value;
        const latV  = parseFloat(document.getElementById('shEditLat').value) || null;
        const lngV  = parseFloat(document.getElementById('shEditLng').value) || null;
        if (!name) { alert('Task name is required'); return; }

        // Collect parts from edit panel
        const editPartInputs = document.querySelectorAll('#shEditPartsBox .sh-part-input');
        const editParts = [];
        editPartInputs.forEach(inp => { const v = inp.value.trim(); if (v) editParts.push(v); });

        // Handle image: new file > existing URL > null
        let imageUrl = document.getElementById('shEditCurrentImageUrl').value || null;
        const newImgFile = document.getElementById('shEditImageFile').files[0];
        if (newImgFile) {
            const msgEl = document.getElementById('shEditImageMsg');
            msgEl.textContent = 'â³ Uploading imageâ€¦';
            msgEl.style.color = '#1565c0';
            try {
                const fd = new FormData();
                fd.append('file', newImgFile);
                fd.append('upload_preset', 'scavenger_hunt');
                fd.append('folder', 'scavenger_hunt/task_images');
                fd.append('public_id', 'task_img_' + id + '_' + Date.now());
                const res = await fetch('https://api.cloudinary.com/v1_1/dat0khbet/image/upload', { method:'POST', body:fd });
                if (!res.ok) throw new Error((await res.json()).error?.message || 'Upload failed');
                imageUrl = (await res.json()).secure_url;
                msgEl.textContent = 'âœ… Image uploaded!';
                msgEl.style.color = '#2e7d32';
            } catch(e) {
                alert('Image upload failed: ' + e.message);
                document.getElementById('shEditImageMsg').textContent = 'âŒ Upload failed';
                document.getElementById('shEditImageMsg').style.color = '#c62828';
                return;
            }
        }

        const update = {
            name,
            order,
            hint:          hint || null,
            image:         imageUrl || null,
            parts:         editParts.length ? editParts : null,
            availableFrom: fromV ? new Date(fromV).toISOString() : null,
            deadline:      tillV ? new Date(tillV).toISOString() : null,
            lat:           latV,
            lng:           lngV
        };

        // Firebase doesn't accept null â€” use set on the whole node with cleaned data
        const cleaned = {};
        Object.entries(update).forEach(([k,v]) => { if (v !== null) cleaned[k] = v; });
        // Preserve createdAt
        if (window._shTasksCache && window._shTasksCache[id] && window._shTasksCache[id].createdAt) {
            cleaned.createdAt = window._shTasksCache[id].createdAt;
        }

        try {
            await window.db.ref('scavengerHunt/tasks/'+id).set(cleaned);
            const msg = document.getElementById('shEditMsg');
            if (msg) { msg.style.display = 'inline-block'; }
            setTimeout(() => {
                shAdminCancelEditTask();
                shAdminLoadTasks();
            }, 1200);
        } catch(e) { alert('Save failed: ' + e.message); }
    }

    async function shAdminDeleteTask(id) {
        if (!confirm('Delete this task?')) return;
        await window.db.ref('scavengerHunt/tasks/'+id).remove();
        shAdminLoadTasks();
    }

    async function shAdminDeleteAllTasks() {
        if (!confirm('Delete ALL tasks?')) return;
        await window.db.ref('scavengerHunt/tasks').remove();
        shAdminLoadTasks();
    }

    async function shAdminResetAll() {
        if (!confirm('Reset ALL submissions?')) return;
        await window.db.ref('scavengerHunt/submissions').remove();
        alert('All submissions reset.');
    }

    function shAdminGetLocation() {
        const msgEl = document.getElementById('shAdminLocMsg');
        msgEl.textContent = 'ðŸ”„ Getting location...';
        if (!navigator.geolocation) { msgEl.textContent='âš ï¸ Not available'; return; }
        navigator.geolocation.getCurrentPosition(
            pos => {
                document.getElementById('shNewTaskLat').value = pos.coords.latitude.toFixed(6);
                document.getElementById('shNewTaskLng').value = pos.coords.longitude.toFixed(6);
                msgEl.textContent = 'âœ… Location set! (Â±'+Math.round(pos.coords.accuracy)+'m)';
            },
            err => { msgEl.textContent='âŒ '+err.message; },
            {enableHighAccuracy:true}
        );
    }

    // â”€â”€ Admin: Submissions â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // Realtime listener handle for submissions
    let _shSubmissionsListener = null;

    function shAdminStopSubmissionsListener() {
        if (_shSubmissionsListener) {
            getDb().ref('scavengerHunt/submissions').off('value', _shSubmissionsListener);
            _shSubmissionsListener = null;
        }
    }

    function shAdminStartSubmissionsListener() {
        shAdminStopSubmissionsListener();
        const el = document.getElementById('shAdminSubmissionsList');
        if(!el) return;
        el.innerHTML = '<p style="color:#999">ðŸ”„ Loading live submissions...</p>';
        _shSubmissionsListener = getDb().ref('scavengerHunt/submissions').on('value', snap => {
            shAdminRenderSubmissions(snap);
        }, err => {
            if(el) el.innerHTML = '<p style="color:red">Error: ' + err.message + '</p>';
        });
    }

    async function shAdminLoadSubmissions() {
        // Start realtime listener for live updates
        shAdminStartSubmissionsListener();
    }

    function shAdminRenderSubmissions(snap) {
        const el         = document.getElementById('shAdminSubmissionsList');
        const filter     = (document.getElementById('shSubmissionFilter')||{}).value||'all';
        const dateFilter = (document.getElementById('shSubmissionDateFilter')||{}).value||'all';
        const taskFilter = (document.getElementById('shSubmissionTaskFilter')||{}).value||'all';
        if(!el) return;
        try {
            const allSubs = snap.val() || {};
            let rows = [];
            Object.entries(allSubs).forEach(([sk,ss]) => {
                Object.entries(ss).forEach(([tid,sub]) => {
                    rows.push({studentKey:sk, taskId:tid, ...sub});
                });
            });

            // Populate date dropdown dynamically
            const dateSet = new Set(rows.map(r => r.submittedAt ? r.submittedAt.slice(0,10) : 'unknown').filter(Boolean));
            const dateSel = document.getElementById('shSubmissionDateFilter');
            const prevDate = dateSel ? dateSel.value : 'all';
            if (dateSel) {
                const sortedDates = [...dateSet].sort().reverse();
                dateSel.innerHTML = '<option value="all">ðŸ“… All Dates</option>' +
                    sortedDates.map(d => `<option value="${d}" ${d===prevDate?'selected':''}>${new Date(d+'T00:00:00').toLocaleDateString('en-IN',{weekday:'short',day:'2-digit',month:'short',year:'numeric'})}</option>`).join('');
            }

            // Populate task dropdown dynamically
            const taskMap = {};
            rows.forEach(r => { if (r.taskId && r.taskName) taskMap[r.taskId] = r.taskName; });
            const taskSel = document.getElementById('shSubmissionTaskFilter');
            const prevTask = taskSel ? taskSel.value : 'all';
            if (taskSel) {
                taskSel.innerHTML = '<option value="all">ðŸ“Œ All Tasks</option>' +
                    Object.entries(taskMap).map(([id,name]) => `<option value="${id}" ${id===prevTask?'selected':''}>${name.length>40?name.slice(0,40)+'â€¦':name}</option>`).join('');
            }

            // Apply all filters
            rows = rows.filter(r => {
                const rowDate = r.submittedAt ? r.submittedAt.slice(0,10) : 'unknown';
                if (filter!=='all'     && r.status!==filter)     return false;
                if (dateFilter!=='all' && rowDate!==dateFilter)   return false;
                if (taskFilter!=='all' && r.taskId!==taskFilter)  return false;
                return true;
            });
            if (!rows.length) { el.innerHTML='<p style="color:#999">No submissions for filter: '+filter+'</p>'; return; }
            rows.sort((a,b)=>new Date(b.submittedAt)-new Date(a.submittedAt));
            let html = '';
            // Show warning if any phantom submissions exist
            const phantoms = rows.filter(r => !r.submittedAt);
            if (phantoms.length) {
                html += '<div style="background:#fff3e0;border:2px solid #ff9800;border-radius:10px;padding:12px 16px;margin-bottom:16px">';
                html += '<strong style="color:#e65100">âš ï¸ '+phantoms.length+' phantom submission(s) found</strong> â€” these have no photo/timestamp (possibly created by accident). ';
                html += '<button onclick="shDeleteAllPhantoms()" style="background:#e65100;color:white;border:none;padding:4px 12px;border-radius:6px;cursor:pointer;font-size:12px;font-weight:700;margin-left:8px">ðŸ—‘ï¸ Delete All Phantoms</button>';
                html += '</div>';
            }

            rows.forEach(r => {
                // Phantom = admin-created status with no real submission
                if (!r.submittedAt) {
                    html += '<div style="background:#fff8e1;border:2px dashed #ff9800;border-radius:12px;padding:14px 18px;margin-bottom:14px;opacity:0.85">';
                    html += '<div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:8px">';
                    html += '<div><strong style="color:#e65100">âš ï¸ PHANTOM</strong> â€” <strong style="color:#6a1b9a">'+shEsc(r.studentName||r.studentKey)+'</strong> <span style="color:#666;font-size:0.85em">('+shEsc(r.studentClass||'')+')</span><br>';
                    html += '<span style="color:#555;font-size:0.9em">Task: <strong>'+shEsc(r.taskName||r.taskId)+'</strong></span> &nbsp; <span style="font-size:0.8em;color:#e65100">No photo or timestamp â€” student never actually submitted this task</span></div>';
                    html += '<button class="btn btn-danger btn-small" onclick="shAdminDeleteSubmission(\'' + r.studentKey + '\',\'' + r.taskId + '\')">ðŸ—‘ï¸ Delete Phantom</button>';
                    html += '</div></div>';
                    return;
                }
                const bg  = r.status==='approved'?'#d4edda':r.status==='rejected'?'#ffebee':'#fff3cd';
                const brd = r.status==='approved'?'#4caf50':r.status==='rejected'?'#f44336':'#ff9800';
                html += '<div style="background:'+bg+';border:2px solid '+brd+';border-radius:12px;padding:16px 18px;margin-bottom:14px">';
                html += '<div style="display:flex;justify-content:space-between;flex-wrap:wrap;gap:8px;margin-bottom:10px">';
                html += '<div><strong style="color:#6a1b9a">'+shEsc(r.studentName||r.studentKey)+'</strong> <span style="color:#666;font-size:0.85em">('+shEsc(r.studentClass||'')+')</span><br>';
                html += '<span style="color:#555;font-size:0.9em">Task: <strong>'+shEsc(r.taskName||r.taskId)+'</strong></span></div>';
                html += '<div style="text-align:right"><span style="font-size:0.8em;color:#777">'+new Date(r.submittedAt).toLocaleString('en-IN')+'</span></div></div>';
                if (r.photoUrl) html += '<div style="margin:6px 0 2px"><span style="font-size:0.78em;font-weight:700;color:#6a1b9a">ðŸ“¸ Part 1 Photo:</span></div><img src="'+r.photoUrl+'" class="sh-admin-photo" onclick="shViewPhoto(this.src)" title="Click to enlarge"><br>';
                if (r.lat && r.lng) html += '<a href="https://maps.google.com/?q='+r.lat+','+r.lng+'" target="_blank" style="font-size:0.85em;color:#1565c0">ðŸ“ View on Maps</a><br>';
                if (r.comment) html += '<div style="margin:10px 0;background:white;border-left:4px solid #9c27b0;border-radius:0 8px 8px 0;padding:10px 14px"><span style="font-size:0.8em;font-weight:700;color:#6a1b9a;display:block;margin-bottom:4px">ðŸ’¬ Student Comment:</span><span style="color:#333;font-size:0.93em">'+shEsc(r.comment)+'</span></div>';
                else html += '<div style="margin:8px 0;font-size:0.82em;color:#f44336;font-style:italic">ðŸ’¬ No comment provided</div>';

                // â”€â”€ Multi-part submissions â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                // Check if this task has parts stored in Firebase tasks
                const taskDef = window._shTasksCache && window._shTasksCache[r.taskId];
                const taskParts = taskDef && taskDef.parts && taskDef.parts.length ? taskDef.parts : null;
                const subParts  = r.parts || [];

                if (taskParts) {
                    // Show each part with approve/reject
                    taskParts.forEach((pName, pi) => {
                        const ps = subParts[pi];
                        if (!ps || !ps.photoUrl) {
                            // Part not yet submitted by student
                            const prevApproved = pi === 0 || (subParts[pi-1] && subParts[pi-1].status === 'approved');
                            if (prevApproved) {
                                html += '<div style="margin-top:10px;background:#f3e5f5;border-left:4px solid #9c27b0;border-radius:6px;padding:8px 12px;font-size:0.85em;color:#6a1b9a">â³ Waiting for student to submit <strong>Part '+(pi+1)+': '+shEsc(pName)+'</strong></div>';
                            }
                            return;
                        }
                        const pbg  = ps.status==='approved'?'#e8f5e9':ps.status==='rejected'?'#ffebee':'#fff3cd';
                        const pbrd = ps.status==='approved'?'#4caf50':ps.status==='rejected'?'#f44336':'#ff9800';
                        html += '<div style="margin-top:12px;border-top:2px dashed #ce93d8;padding-top:12px">';
                        html += '<div style="font-weight:700;color:#6a1b9a;margin-bottom:6px">ðŸ“¸ Part '+(pi+1)+': '+shEsc(pName)+'</div>';
                        html += '<img src="'+ps.photoUrl+'" class="sh-admin-photo" onclick="shViewPhoto(this.src)" title="Click to enlarge"><br>';
                        if (ps.submittedAt) html += '<div style="font-size:0.78em;color:#888;margin:3px 0">Submitted: '+new Date(ps.submittedAt).toLocaleString('en-IN')+'</div>';
                        if (ps.comment) html += '<div style="background:white;border-left:3px solid #9c27b0;padding:6px 10px;border-radius:0 6px 6px 0;font-size:0.85em;margin:4px 0"><strong>ðŸ’¬</strong> '+shEsc(ps.comment)+'</div>';
                        if (!ps.status || ps.status === 'pending') {
                            html += '<div style="display:flex;gap:8px;margin-top:8px;flex-wrap:wrap">';
                            html += '<button class="btn btn-success btn-small" onclick="shAdminVerifyPart(\''+r.studentKey+'\',\''+r.taskId+'\','+pi+',\'approved\')">âœ… Approve Part '+(pi+1)+'</button>';
                            html += '<button class="btn btn-danger btn-small" onclick="shAdminVerifyPart(\''+r.studentKey+'\',\''+r.taskId+'\','+pi+',\'rejected\')">âŒ Reject Part '+(pi+1)+'</button>';
                            html += '</div>';
                        } else {
                            const picon = ps.status==='approved'?'âœ…':'âŒ';
                            html += '<div style="margin-top:6px;display:flex;align-items:center;gap:8px;flex-wrap:wrap"><strong>'+picon+' Part '+(pi+1)+' '+ps.status.toUpperCase()+'</strong>';
                            if (ps.status !== 'approved') html += '<button class="btn btn-success btn-small" onclick="shAdminVerifyPart(\''+r.studentKey+'\',\''+r.taskId+'\','+pi+',\'approved\')">âœ… Approve Part '+(pi+1)+'</button>';
                            html += '</div>';
                        }
                        html += '</div>';
                    });
                    // Overall task reset/delete
                    html += '<div style="display:flex;gap:8px;margin-top:12px;flex-wrap:wrap">';
                    html += '<button class="btn btn-secondary btn-small" onclick="shAdminVerify(\''+r.studentKey+'\',\''+r.taskId+'\',\'pending\',\'\')">â†©ï¸ Reset All</button>';
                    html += '<button class="btn btn-danger btn-small" onclick="shAdminDeleteSubmission(\''+r.studentKey+'\',\''+r.taskId+'\')">ðŸ—‘ï¸ Delete All</button>';
                    html += '</div>';
                } else {
                    // â”€â”€ Single-photo task approve/reject (original flow) â”€â”€â”€
                if (r.status==='pending') {
                    const rejectBoxId  = 'shRejectBox_' + r.studentKey + '_' + r.taskId;
                    const replyBoxId   = 'shReplyBox_'  + r.studentKey + '_' + r.taskId;
                    html += '<div style="margin-top:10px">';
                    // â”€â”€ Admin reply/note box â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                    html += '<div style="background:#e8f5e9;border:2px solid #4caf50;border-radius:10px;padding:12px 14px;margin-bottom:10px">';
                    html += '<label style="font-size:0.85em;color:#2e7d32;font-weight:700;display:block;margin-bottom:5px">ðŸ’¬ Reply / Note to Student <span style="color:#888;font-weight:400">(optional â€” shown to student on approval or rejection)</span></label>';
                    html += '<textarea id="' + replyBoxId + '" placeholder="e.g. Great work! Well done. / Please resubmit with clearer photoâ€¦" rows="2" style="width:100%;padding:8px;border:1.5px solid #4caf50;border-radius:6px;font-size:13px;box-sizing:border-box;resize:vertical;outline:none"></textarea>';
                    html += '</div>';
                    // â”€â”€ Action buttons â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                    html += '<div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px">';
                    html += '<button class="btn btn-success btn-small" onclick="shAdminVerifyWithNote(\'' + r.studentKey + '\',\'' + r.taskId + '\',\'approved\',\'' + replyBoxId + '\')">âœ… Approve</button>';
                    html += '<button class="btn btn-danger btn-small" onclick="shAdminToggleRejectBox(\'' + rejectBoxId + '\')">âŒ Reject</button>';
                    html += '</div>';
                    html += '<div id="' + rejectBoxId + '" style="display:none;background:#fff0f0;border:2px solid #f44336;border-radius:10px;padding:14px;margin-top:4px">';
                    html += '<label style="font-size:0.88em;color:#c62828;font-weight:700;display:block;margin-bottom:6px">ðŸ“ Reason for rejection (will be shown to student):</label>';
                    html += '<div style="display:flex;flex-wrap:wrap;gap:6px;margin-bottom:10px">';
                    ['Wrong location','Blurry/unclear photo','Wrong task photo','Not at required spot','Photo not original'].forEach(p => {
                        html += '<button onclick="shSetRejectReason(\'' + rejectBoxId + '\',this)" data-reason="' + p + '" style="background:#ffebee;color:#c62828;border:1px solid #f44336;border-radius:6px;padding:5px 10px;cursor:pointer;font-size:12px">' + p + '</button>';
                    });
                    html += '</div>';
                    html += '<textarea id="' + rejectBoxId + '_txt" placeholder="Or type a custom reasonâ€¦" rows="2" style="width:100%;padding:8px;border:1px solid #f44336;border-radius:6px;font-size:13px;box-sizing:border-box;margin-bottom:10px;resize:vertical"></textarea>';
                    html += '<div style="display:flex;gap:8px">';
                    html += '<button class="btn btn-danger btn-small" onclick="shAdminVerifyWithReason(\'' + r.studentKey + '\',\'' + r.taskId + '\',\'' + replyBoxId + '\',\'' + rejectBoxId + '\')">âŒ Confirm Reject</button>';
                    html += '<button class="btn btn-secondary btn-small" onclick="shAdminToggleRejectBox(\'' + rejectBoxId + '\')">Cancel</button>';
                    html += '</div></div></div>';
                } else {
                    const statusIcon = r.status==='approved' ? 'âœ…' : 'âŒ';
                    const reviewedTime2 = r.reviewedAt ? new Date(r.reviewedAt).toLocaleString('en-IN',{day:'2-digit',month:'short',hour:'2-digit',minute:'2-digit',hour12:true}) : '';
                    const reviewerHtml = r.reviewedBy ? ' <span style="font-size:0.78em;color:#888">by ' + shEsc(r.reviewedBy) + '</span>' : '';
                    html += '<div style="margin-top:8px">';
                    html += '<div style="display:flex;align-items:center;gap:6px;flex-wrap:wrap">';
                    html += '<strong>' + statusIcon + ' ' + r.status.toUpperCase() + '</strong>' + reviewerHtml;
                    if (reviewedTime2) html += '<span style="font-size:0.78em;color:#888">Â· ' + reviewedTime2 + '</span>';
                    html += '</div>';
                    if (r.rejectionReason) html += '<div style="margin-top:6px;background:#fff0f0;border-left:3px solid #f44336;padding:7px 10px;border-radius:0 6px 6px 0;font-size:0.85em;color:#b71c1c"><strong>ðŸ“ Rejection Reason:</strong> ' + shEsc(r.rejectionReason) + '</div>';
                    if (r.adminNote) html += '<div style="margin-top:6px;background:#e8f5e9;border-left:3px solid #4caf50;padding:7px 10px;border-radius:0 6px 6px 0;font-size:0.85em;color:#2e7d32"><strong>ðŸ’¬ Admin Note:</strong> ' + shEsc(r.adminNote) + '</div>';
                    html += '<div style="display:flex;gap:8px;margin-top:8px;flex-wrap:wrap">';
                    html += '<button class="btn btn-secondary btn-small" onclick="shAdminVerify(\'' + r.studentKey + '\',\'' + r.taskId + '\',\'pending\',\'\')">â†©ï¸ Reset</button>';
                    html += '<button class="btn btn-danger btn-small" onclick="shAdminDeleteSubmission(\'' + r.studentKey + '\',\'' + r.taskId + '\')">ðŸ—‘ï¸ Delete</button>';
                    html += '</div></div>';
                }
                } // end single-photo else
                                html += '</div>';
            });
            el.innerHTML = html;
        } catch(e) { el.innerHTML='<p style="color:red">Error: '+e.message+'</p>'; }
    }

    async function shAdminVerify(studentKey, taskId, status, reason, adminNote) {
        const existing = await getDb().ref('scavengerHunt/submissions/'+studentKey+'/'+taskId).once('value');
        if (!existing.exists() || !existing.val().submittedAt) {
            alert('âš ï¸ No real submission found for this student/task. Cannot update.');
            return;
        }
        const update = {
            status,
            reviewedAt: new Date().toISOString(),
            reviewedBy: (window.currentUser && window.currentUser.name) ? window.currentUser.name : 'Admin',
            rejectionReason: (status === 'rejected' && reason) ? reason : null,
            adminNote: (adminNote && adminNote.trim()) ? adminNote.trim() : null
        };
        await getDb().ref('scavengerHunt/submissions/'+studentKey+'/'+taskId).update(update);
        shAdminLoadSubmissions();
    }

    async function shAdminVerifyPart(studentKey, taskId, partIdx, status) {
        try {
            await getDb().ref('scavengerHunt/submissions/'+studentKey+'/'+taskId+'/parts/'+partIdx).update({
                status,
                reviewedAt: new Date().toISOString(),
                reviewedBy: (window.currentUser && window.currentUser.name) ? window.currentUser.name : 'Admin'
            });
            // If ALL parts are now approved, also set the top-level status to 'approved'
            const snap = await getDb().ref('scavengerHunt/submissions/'+studentKey+'/'+taskId).once('value');
            const sub  = snap.val();
            const taskDef = window._shTasksCache && window._shTasksCache[taskId];
            const totalParts = taskDef && taskDef.parts ? taskDef.parts.length : 0;
            const subParts   = sub && sub.parts ? sub.parts : [];
            const allApproved = totalParts > 0 && subParts.length >= totalParts && subParts.every(p => p && p.status === 'approved');
            if (allApproved) {
                await getDb().ref('scavengerHunt/submissions/'+studentKey+'/'+taskId).update({
                    status: 'approved', reviewedAt: new Date().toISOString(),
                    reviewedBy: (window.currentUser && window.currentUser.name) ? window.currentUser.name : 'Admin'
                });
            }
            shAdminLoadSubmissions();
        } catch(e) { alert('Error: ' + e.message); }
    }

    async function shDeleteAllPhantoms() {
        if (!confirm('Delete ALL phantom submissions (entries with no photo/timestamp)? This cannot be undone.')) return;
        try {
            const snap = await getDb().ref('scavengerHunt/submissions').once('value');
            const allSubs = snap.val() || {};
            const deletes = [];
            Object.entries(allSubs).forEach(([sk, ss]) => {
                Object.entries(ss).forEach(([tid, sub]) => {
                    if (!sub.submittedAt) {
                        deletes.push(getDb().ref('scavengerHunt/submissions/'+sk+'/'+tid).remove());
                    }
                });
            });
            await Promise.all(deletes);
            alert('âœ… Deleted '+deletes.length+' phantom submission(s).');
            shAdminLoadSubmissions();
        } catch(e) { alert('Error: '+e.message); }
    }

    function shAdminToggleRejectBox(boxId) {
        const box = document.getElementById(boxId);
        if (box) box.style.display = box.style.display === 'none' ? 'block' : 'none';
    }

    function shSetRejectReason(boxId, btn) {
        const txt = document.getElementById(boxId + '_txt');
        if (txt) txt.value = btn.dataset.reason;
        // Highlight selected preset
        const box = document.getElementById(boxId);
        if (box) box.querySelectorAll('[data-reason]').forEach(b => b.style.background = '#ffebee');
        btn.style.background = '#f44336';
        btn.style.color = 'white';
    }

    async function shAdminVerifyWithReason(studentKey, taskId, replyBoxId, boxId) {
        const txt    = document.getElementById(boxId + '_txt');
        const reply  = document.getElementById(replyBoxId);
        const reason = (txt ? txt.value.trim() : '') || 'Rejected by admin';
        const adminNote = reply ? reply.value.trim() : '';
        await shAdminVerify(studentKey, taskId, 'rejected', reason, adminNote);
    }

    async function shAdminVerifyWithNote(studentKey, taskId, status, replyBoxId) {
        const reply = document.getElementById(replyBoxId);
        const adminNote = reply ? reply.value.trim() : '';
        await shAdminVerify(studentKey, taskId, status, '', adminNote);
    }

    async function shAdminDeleteSubmission(studentKey, taskId) {
        if (!confirm("Delete this submission permanently? This cannot be undone.")) return;
        try {
            await window.db.ref("scavengerHunt/submissions/"+studentKey+"/"+taskId).remove();
            const toast = document.createElement("div");
            toast.textContent = "ðŸ—‘ï¸ Submission deleted!";
            toast.style.cssText = "position:fixed;top:20px;left:50%;transform:translateX(-50%);background:#c62828;color:white;padding:12px 28px;border-radius:30px;font-weight:700;font-size:1em;z-index:9999;box-shadow:0 4px 20px rgba(0,0,0,0.2);transition:opacity 0.5s";
            document.body.appendChild(toast);
            setTimeout(() => { toast.style.opacity = "0"; setTimeout(() => toast.remove(), 500); }, 2000);
            shAdminLoadSubmissions();
        } catch(e) {
            alert("Failed to delete: " + e.message);
        }
    }

    // â”€â”€ Admin: Leaderboard â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // â”€â”€ Leaderboard cache â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    let _shLbSubsCache = null;
    let _shLbTasksCache = null;

    async function shAdminLoadLeaderboard() {
        const el = document.getElementById('shAdminLeaderboardList');
        if(!el) return;
        el.innerHTML = '<p style="color:#999">Loading...</p>';
        try {
            const _db = getDb();
            const [subSnap, taskSnap] = await Promise.all([
                _db.ref('scavengerHunt/submissions').once('value'),
                _db.ref('scavengerHunt/tasks').once('value')
            ]);
            _shLbSubsCache  = subSnap.val()  || {};
            _shLbTasksCache = taskSnap.val() || {};

            // Populate Task filter
            const taskSel = document.getElementById('shLbTaskFilter');
            if (taskSel) {
                const curTask = taskSel.value;
                taskSel.innerHTML = '<option value="all">ðŸ“Œ All Tasks</option>';
                Object.entries(_shLbTasksCache)
                    .sort((a,b)=>(a[1].order||0)-(b[1].order||0))
                    .forEach(([tid,t]) => {
                        const o = document.createElement('option');
                        o.value = tid;
                        o.textContent = 'ðŸ“ ' + (t.name||tid);
                        if (tid===curTask) o.selected=true;
                        taskSel.appendChild(o);
                    });
            }

            // Populate Class filter
            const classSel = document.getElementById('shLbClassFilter');
            if (classSel) {
                const curCls = classSel.value;
                const classSet = new Set();
                Object.values(_shLbSubsCache).forEach(ss => {
                    const first = Object.values(ss)[0]||{};
                    if (first.studentClass) classSet.add(first.studentClass);
                });
                classSel.innerHTML = '<option value="all">ðŸ« All Classes</option>';
                [...classSet].sort().forEach(c => {
                    const o = document.createElement('option');
                    o.value = c; o.textContent = c;
                    if (c===curCls) o.selected=true;
                    classSel.appendChild(o);
                });
            }

            shAdminRenderLeaderboard();
        } catch(e) { el.innerHTML='<p style="color:red">Error: '+e.message+'</p>'; }
    }

    function shAdminRenderLeaderboard() {
        const el = document.getElementById('shAdminLeaderboardList');
        if (!el || !_shLbSubsCache || !_shLbTasksCache) return;

        const taskF  = (document.getElementById('shLbTaskFilter')||{}).value||'all';
        const classF = (document.getElementById('shLbClassFilter')||{}).value||'all';

        // Sorted task list for display
        const allTasksSorted = Object.entries(_shLbTasksCache)
            .sort((a,b)=>(a[1].order||0)-(b[1].order||0));

        // Determine which tasks count toward "total" based on filter
        const taskIds = taskF === 'all'
            ? allTasksSorted.map(([tid])=>tid)
            : [taskF];
        const totalTasks = taskIds.length;

        let rows = [];
        Object.entries(_shLbSubsCache).forEach(([sk,ss]) => {
            const first = Object.values(ss)[0]||{};
            const cls = first.studentClass||'';
            if (classF !== 'all' && cls !== classF) return;

            let approved=0, submitted=0, lastTime=null;
            // Per-task status for inline display
            const taskStatuses = [];
            taskIds.forEach(tid => {
                const sub = ss[tid];
                const tName = (_shLbTasksCache[tid]||{}).name || ('Task '+(allTasksSorted.findIndex(([id])=>id===tid)+1));
                const tNum  = 'Task '+(allTasksSorted.findIndex(([id])=>id===tid)+1);
                if (sub) {
                    submitted++;
                    if (sub.status==='approved') {
                        approved++;
                        if (!lastTime || (sub.reviewedAt||'') > lastTime) lastTime = sub.reviewedAt||'';
                        taskStatuses.push({tNum, tName, status:'approved'});
                    } else if (sub.status==='pending') {
                        taskStatuses.push({tNum, tName, status:'pending'});
                    } else {
                        taskStatuses.push({tNum, tName, status:'rejected'});
                    }
                }
                // If no submission, don't add to taskStatuses (not submitted yet)
            });

            // When a specific task is filtered: only include students who have submitted that task
            // When "All Tasks": include everyone who has submitted at least one task
            if (taskF !== 'all' && submitted === 0) return;
            if (taskF === 'all' && submitted === 0) return;

            rows.push({name:first.studentName||sk, cls, approved, submitted, lastTime:lastTime||'', totalTasks, taskStatuses});
        });

        rows.sort((a,b)=>b.approved-a.approved||(a.lastTime||'zzz').localeCompare(b.lastTime||'zzz'));

        // Active filter label
        let filterLabel = '';
        if (taskF !== 'all') {
            const tName = (_shLbTasksCache[taskF]||{}).name || taskF;
            filterLabel += `<span style="background:#e8f5e9;color:#2e7d32;padding:3px 10px;border-radius:12px;font-size:0.8em;font-weight:700;margin-right:6px">ðŸ“ ${shEsc(tName)}</span>`;
        }
        if (classF !== 'all') {
            filterLabel += `<span style="background:#e3f2fd;color:#1565c0;padding:3px 10px;border-radius:12px;font-size:0.8em;font-weight:700">ðŸ« ${shEsc(classF)}</span>`;
        }

        if (!rows.length) {
            el.innerHTML = (filterLabel ? `<div style="margin-bottom:10px">${filterLabel}</div>` : '') + '<p style="color:#999">No participants have submitted for the selected filter.</p>';
            return;
        }

        const medals=['ðŸ¥‡','ðŸ¥ˆ','ðŸ¥‰'];
        let html = filterLabel ? `<div style="margin-bottom:12px">${filterLabel} <span style="color:#888;font-size:0.82em">(${rows.length} participant${rows.length!==1?'s':''} shown)</span></div>` : '';
        rows.forEach((r,i) => {
            const pct = totalTasks ? Math.round(r.approved/totalTasks*100) : 0;

            // Build inline task chips
            let taskChipsInline = '';
            if (r.taskStatuses && r.taskStatuses.length) {
                r.taskStatuses.forEach(ts => {
                    const chipBg  = ts.status==='approved'?'#e8f5e9':ts.status==='pending'?'#fff3e0':'#ffebee';
                    const chipCol = ts.status==='approved'?'#2e7d32':ts.status==='pending'?'#e65100':'#c62828';
                    const chipIcon = ts.status==='approved'?'âœ…':ts.status==='pending'?'â³':'âŒ';
                    taskChipsInline += `<span style="background:${chipBg};color:${chipCol};padding:2px 8px;border-radius:10px;font-size:0.75em;font-weight:700;white-space:nowrap">${chipIcon} ${shEsc(ts.tNum)}</span>`;
                });
            }

            html += '<div class="sh-leaderboard-row">';
            html += '<div class="sh-rank">'+(medals[i]||(i+1))+'</div>';
            html += '<div style="flex:1">';
            html += '<div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap;margin-bottom:4px">';
            html += '<strong style="color:#6a1b9a">'+shEsc(r.name)+'</strong>';
            html += '<span style="color:#999;font-size:0.85em">('+shEsc(r.cls)+')</span>';
            if (taskChipsInline) html += taskChipsInline;
            html += '</div>';
            html += '<div class="sh-progress-bar-wrap" style="height:8px;margin-top:2px"><div class="sh-progress-bar" style="width:'+pct+'%"></div></div>';
            html += '<span style="font-size:0.82em;color:#666">'+r.approved+'/'+r.totalTasks+' task'+(r.totalTasks!==1?'s':'')+' ('+pct+'%)</span></div></div>';
        });
        el.innerHTML = html;
    }

    // â”€â”€ Admin: Class-wise Participation â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    let _shAllSubsCache = null;
    let _shAllTasksCache = null;

    async function shAdminLoadClasswise() {
        const el = document.getElementById('shAdminClasswiseList');
        if (el) el.innerHTML = '<p style="color:#aaa;text-align:center;padding:12px">â³ Loadingâ€¦</p>';
        try {
            const _db = getDb();
            const [subSnap, taskSnap] = await Promise.all([
                _db.ref('scavengerHunt/submissions').once('value'),
                _db.ref('scavengerHunt/tasks').once('value')
            ]);
            _shAllSubsCache  = subSnap.val()  || {};
            _shAllTasksCache = taskSnap.val() || {};
            const totalTasks = Object.keys(_shAllTasksCache).length;

            // Populate Task filter for Summary
            const cwTaskSel = document.getElementById('shCwTaskFilter');
            if (cwTaskSel) {
                const curCwTask = cwTaskSel.value;
                cwTaskSel.innerHTML = '<option value="all">ðŸ“Œ All Tasks</option>';
                Object.entries(_shAllTasksCache)
                    .sort((a,b)=>(a[1].order||0)-(b[1].order||0))
                    .forEach(([tid,t]) => {
                        const o = document.createElement('option');
                        o.value = tid;
                        o.textContent = 'ðŸ“ ' + (t.name||tid);
                        if (tid===curCwTask) o.selected=true;
                        cwTaskSel.appendChild(o);
                    });
            }

            // Populate Date filter for Summary
            const cwDateSel = document.getElementById('shCwDateFilter');
            if (cwDateSel) {
                const curCwDate = cwDateSel.value;
                const dateSet = new Set();
                Object.values(_shAllSubsCache).forEach(ss => {
                    Object.values(ss).forEach(sub => {
                        if (sub.submittedAt) dateSet.add(sub.submittedAt.slice(0,10));
                    });
                });
                cwDateSel.innerHTML = '<option value="all">ðŸ“… All Dates</option>';
                [...dateSet].sort().reverse().forEach(d => {
                    const o = document.createElement('option');
                    o.value = d;
                    o.textContent = new Date(d+'T00:00:00').toLocaleDateString('en-IN',{weekday:'short',day:'2-digit',month:'short',year:'numeric'});
                    if (d===curCwDate) o.selected=true;
                    cwDateSel.appendChild(o);
                });
            }

            // Build class map
            const classMap = {}; // class â†’ {total, approved, pending, rejected, students[]}
            let grandTotal=0, grandApproved=0, grandPending=0;
            const allStudents = [];

            Object.entries(_shAllSubsCache).forEach(([sk, ss]) => {
                const first = Object.values(ss)[0] || {};
                const cls = first.studentClass || 'Unknown';
                const name = first.studentName || sk;
                let studentApproved=0;
                Object.entries(ss).forEach(([tid, sub]) => {
                    if (!classMap[cls]) classMap[cls] = {total:0, approved:0, pending:0, rejected:0};
                    classMap[cls].total++;
                    grandTotal++;
                    if (sub.status==='approved')  { classMap[cls].approved++; grandApproved++; studentApproved++; }
                    else if (sub.status==='pending')  { classMap[cls].pending++;  grandPending++; }
                    else if (sub.status==='rejected') classMap[cls].rejected++;
                });
                allStudents.push({key:sk, name, cls, approved:studentApproved, total:totalTasks});
            });

            // Pills
            const pt=document.getElementById('shCwPillTotal');
            const pa=document.getElementById('shCwPillApproved');
            const pp=document.getElementById('shCwPillPending');
            const pc=document.getElementById('shCwPillClasses');
            if(pt) pt.textContent='Total Submissions: '+grandTotal;
            if(pa) pa.textContent='Approved: '+grandApproved;
            if(pp) pp.textContent='Pending: '+grandPending;
            if(pc) pc.textContent='Classes: '+Object.keys(classMap).length;

            // Build class breakdown table
            const sorted = Object.entries(classMap).sort((a,b)=>b[1].approved-a[1].approved||b[1].total-a[1].total);
            let html = '<div class="table-wrapper" style="margin:0"><table style="font-size:13px;width:100%"><thead><tr>';
            html += '<th style="background:#3d0060;color:#ffd700">Class</th>';
            html += '<th style="background:#3d0060;color:white">Submissions</th>';
            html += '<th style="background:#3d0060;color:#a5d6a7">âœ… Approved</th>';
            html += '<th style="background:#3d0060;color:#fff3cd">â³ Pending</th>';
            html += '<th style="background:#3d0060;color:#f5c6cb">âŒ Rejected</th>';
            html += '<th style="background:#3d0060;color:#80deea">Approval %</th>';
            html += '</tr></thead><tbody>';
            sorted.forEach(([cls, d]) => {
                const acc = d.total > 0 ? Math.round((d.approved/d.total)*100) : 0;
                const barColor = acc>=70?'#28a745':acc>=40?'#ffc107':'#dc3545';
                html += '<tr>';
                html += '<td><strong>'+shEsc(cls)+'</strong></td>';
                html += '<td style="text-align:center;font-weight:700">'+d.total+'</td>';
                html += '<td style="text-align:center;color:#155724;font-weight:600">'+d.approved+'</td>';
                html += '<td style="text-align:center;color:#e65100;font-weight:600">'+d.pending+'</td>';
                html += '<td style="text-align:center;color:#c62828;font-weight:600">'+d.rejected+'</td>';
                html += '<td style="min-width:100px"><div style="background:#eee;border-radius:6px;height:8px;margin-bottom:3px"><div style="background:'+barColor+';width:'+acc+'%;height:8px;border-radius:6px"></div></div><span style="font-size:11px;color:#555">'+acc+'%</span></td>';
                html += '</tr>';
            });
            if (!sorted.length) html += '<tr><td colspan="6" style="text-align:center;color:#999;padding:16px">No submissions yet.</td></tr>';
            html += '</tbody></table></div>';
            if(el) el.innerHTML = html;

            // Populate class filter dropdown
            const classFilter = document.getElementById('shCwClassFilter');
            if (classFilter) {
                const curVal = classFilter.value;
                classFilter.innerHTML = '<option value="">All Classes</option>';
                Object.keys(classMap).sort().forEach(c => {
                    const o = document.createElement('option');
                    o.value = c; o.textContent = c;
                    if (c===curVal) o.selected=true;
                    classFilter.appendChild(o);
                });
            }

            // Build summary message box â€” fetch class strengths from leaderboard config
            const summaryBox  = document.getElementById('shCwSummaryBox');
            const summaryDate = document.getElementById('shCwSummaryDate');
            const summaryText = document.getElementById('shCwSummaryText');
            const nowTime = new Date().toLocaleTimeString('en-IN',{hour:'2-digit',minute:'2-digit',hour12:true});
            if (!window._classStrengths) {
                try { const ss = await getDb().ref('leaderboardConfig/classStrengths').once('value'); window._classStrengths = ss.val() || {}; } catch(e) { window._classStrengths = {}; }
            }
            const _shStr = window._classStrengths || {};
            function _normCls2(s){ return String(s).toLowerCase().replace(/[^a-z0-9]/g,''); }
            function _getStrength2(map,cls){ const n=_normCls2(cls); const k=Object.keys(map).find(k=>_normCls2(k)===n); return k?map[k]:0; }
            if (summaryDate) summaryDate.textContent = new Date().toLocaleDateString('en-IN',{weekday:'long',day:'numeric',month:'long',year:'numeric'});
            const studentCount = Object.keys(_shAllSubsCache||{}).length || grandTotal;
            if (summaryText) {
                let lines = `<span style="color:#888;font-size:12px">ðŸ• Generated at: <strong>${nowTime}</strong></span><br><br>`;
                lines += `<strong>${studentCount}</strong> students across <strong>${Object.keys(classMap).length}</strong> classes.<br>`;
                lines += `<strong>${grandApproved}</strong> approved, <strong>${grandPending}</strong> pending review.<br><br>`;
                lines += '<strong>Class-wise breakdown:</strong><br>';
                sorted.forEach(([cls,d]) => {
                    const acc = d.total>0?Math.round((d.approved/d.total)*100):0;
                    const strength = _getStrength2(_shStr, cls);
                    const strengthTag = strength ? `<span style="color:#888;font-size:0.92em">(Class Strength: ${strength})</span> ` : '';
                    lines += `â€¢ ${shEsc(cls)}: ${strengthTag}<strong>${d.total}</strong> submitted, <strong>${d.approved}</strong> approved (${acc}%)<br>`;
                });
                summaryText.innerHTML = lines;
            }
            if (summaryBox) summaryBox.style.display = 'block';
            // Store plain text for copy
            window._shLastSummaryText = `ðŸ—ºï¸ Scavenger Hunt Summary\nðŸ• Generated at: ${nowTime}\n\n` +
                `${studentCount} students across ${Object.keys(classMap).length} classes.\n` +
                `${grandApproved} approved, ${grandPending} pending review.\n\nClass-wise breakdown:\n` +
                sorted.map(([cls,d]) => {
                    const strength = _getStrength2(_shStr, cls);
                    const strengthTxt = strength ? `[Class Strength: ${strength}] ` : '';
                    return `â€¢ ${cls}: ${strengthTxt}${d.total} submitted, ${d.approved} approved (${d.total>0?Math.round((d.approved/d.total)*100):0}%)`;
                }).join('\n') +
                `\n\nâ€” Spurthi Youth Fest 2026`;

            shAdminLoadClasswiseDetail();
        } catch(e) {
            const el=document.getElementById('shAdminClasswiseList');
            if(el) el.innerHTML='<p style="color:red">Error: '+e.message+'</p>';
        }
    }

    // â”€â”€ Apply task/date filters to the summary box + detail table â”€â”€â”€â”€
    function shAdminApplyClasswiseFilters() {
        if (!_shAllSubsCache || !_shAllTasksCache) return;
        const taskF = (document.getElementById('shCwTaskFilter')||{}).value||'all';
        const dateF = (document.getElementById('shCwDateFilter')||{}).value||'all';

        // Build filtered class map
        const classMap = {};
        let grandTotal=0, grandApproved=0, grandPending=0;
        Object.entries(_shAllSubsCache).forEach(([sk, ss]) => {
            const first = Object.values(ss)[0] || {};
            const cls = first.studentClass || 'Unknown';
            Object.entries(ss).forEach(([tid, sub]) => {
                if (taskF !== 'all' && tid !== taskF) return;
                if (dateF !== 'all' && (!sub.submittedAt || !sub.submittedAt.startsWith(dateF))) return;
                if (!classMap[cls]) classMap[cls] = {total:0, approved:0, pending:0, rejected:0};
                classMap[cls].total++;
                grandTotal++;
                if (sub.status==='approved')  { classMap[cls].approved++; grandApproved++; }
                else if (sub.status==='pending')  { classMap[cls].pending++;  grandPending++; }
                else if (sub.status==='rejected') classMap[cls].rejected++;
            });
        });

        // Update pills
        const pt=document.getElementById('shCwPillTotal');
        const pa=document.getElementById('shCwPillApproved');
        const pp=document.getElementById('shCwPillPending');
        const pc=document.getElementById('shCwPillClasses');
        if(pt) pt.textContent='Total Submissions: '+grandTotal;
        if(pa) pa.textContent='Approved: '+grandApproved;
        if(pp) pp.textContent='Pending: '+grandPending;
        if(pc) pc.textContent='Classes: '+Object.keys(classMap).length;

        // Build filter label for summary
        let filterLine = '';
        if (taskF !== 'all') {
            const tName = (_shAllTasksCache[taskF]||{}).name || taskF;
            filterLine += `ðŸ“ Task: <strong>${tName}</strong>  `;
        }
        if (dateF !== 'all') {
            const dLabel = new Date(dateF+'T00:00:00').toLocaleDateString('en-IN',{weekday:'long',day:'numeric',month:'long',year:'numeric'});
            filterLine += `ðŸ“… Date: <strong>${dLabel}</strong>`;
        }

        // Rebuild summary box
        const sorted = Object.entries(classMap).sort((a,b)=>b[1].approved-a[1].approved||b[1].total-a[1].total);
        if (!window._classStrengths) window._classStrengths = {};
        const _shStr = window._classStrengths || {};
        function _normC(s){ return String(s).toLowerCase().replace(/[^a-z0-9]/g,''); }
        function _getStr(map,cls){ const n=_normC(cls); const k=Object.keys(map).find(k=>_normC(k)===n); return k?map[k]:0; }
        const nowTime = new Date().toLocaleTimeString('en-IN',{hour:'2-digit',minute:'2-digit',hour12:true});
        const studentCount = Object.keys(_shAllSubsCache||{}).filter(sk => {
            const ss = _shAllSubsCache[sk];
            return Object.entries(ss).some(([tid,sub]) => {
                if (taskF!=='all' && tid!==taskF) return false;
                if (dateF!=='all' && (!sub.submittedAt||!sub.submittedAt.startsWith(dateF))) return false;
                return true;
            });
        }).length;

        const summaryDate = document.getElementById('shCwSummaryDate');
        const summaryText = document.getElementById('shCwSummaryText');
        const summaryBox  = document.getElementById('shCwSummaryBox');
        if (summaryDate) {
            summaryDate.textContent = dateF !== 'all'
                ? new Date(dateF+'T00:00:00').toLocaleDateString('en-IN',{weekday:'long',day:'numeric',month:'long',year:'numeric'})
                : new Date().toLocaleDateString('en-IN',{weekday:'long',day:'numeric',month:'long',year:'numeric'});
        }
        if (summaryText) {
            let lines = `<span style="color:#888;font-size:12px">ðŸ• Generated at: <strong>${nowTime}</strong></span>`;
            if (filterLine) lines += ` &nbsp;Â·&nbsp; <span style="color:#c44569;font-size:12px">${filterLine}</span>`;
            lines += `<br><br><strong>${studentCount}</strong> students across <strong>${Object.keys(classMap).length}</strong> classes.<br>`;
            lines += `<strong>${grandApproved}</strong> approved, <strong>${grandPending}</strong> pending review.<br><br>`;
            lines += '<strong>Class-wise breakdown:</strong><br>';
            if (!sorted.length) {
                lines += '<span style="color:#999">No submissions match the selected filters.</span>';
            } else {
                sorted.forEach(([cls,d]) => {
                    const acc = d.total>0?Math.round((d.approved/d.total)*100):0;
                    const strength = _getStr(_shStr, cls);
                    const strengthTag = strength ? `<span style="color:#888;font-size:0.92em">(Class Strength: ${strength})</span> ` : '';
                    lines += `â€¢ ${shEsc(cls)}: ${strengthTag}<strong>${d.total}</strong> submitted, <strong>${d.approved}</strong> approved (${acc}%)<br>`;
                });
            }
            summaryText.innerHTML = lines;
        }
        if (summaryBox) summaryBox.style.display = 'block';

        // Build plain text for copy
        const taskLabel = taskF!=='all' ? `\nðŸ“ Task: ${(_shAllTasksCache[taskF]||{}).name||taskF}` : '';
        const dateLabel = dateF!=='all' ? `\nðŸ“… Date: ${new Date(dateF+'T00:00:00').toLocaleDateString('en-IN',{weekday:'long',day:'numeric',month:'long',year:'numeric'})}` : '';
        window._shLastSummaryText = `ðŸ—ºï¸ Scavenger Hunt Summary\nðŸ• Generated at: ${nowTime}${taskLabel}${dateLabel}\n\n` +
            `${studentCount} students across ${Object.keys(classMap).length} classes.\n` +
            `${grandApproved} approved, ${grandPending} pending review.\n\nClass-wise breakdown:\n` +
            sorted.map(([cls,d]) => {
                const strength = _getStr(_shStr, cls);
                const strengthTxt = strength ? `[Class Strength: ${strength}] ` : '';
                return `â€¢ ${cls}: ${strengthTxt}${d.total} submitted, ${d.approved} approved (${d.total>0?Math.round((d.approved/d.total)*100):0}%)`;
            }).join('\n') +
            `\n\nâ€” Spurthi Youth Fest 2026`;

        // Also update detail table
        shAdminLoadClasswiseDetail();
    }

    function shAdminLoadClasswiseDetail() {
        const tbody = document.getElementById('shCwDetailTable');
        if(!tbody || !_shAllSubsCache || !_shAllTasksCache) return;
        const classF  = (document.getElementById('shCwClassFilter')||{}).value||'';
        const statusF = (document.getElementById('shCwStatusFilter')||{}).value||'';
        let rows = [];
        Object.entries(_shAllSubsCache).forEach(([sk,ss]) => {
            Object.entries(ss).forEach(([tid,sub]) => {
                const taskName = (_shAllTasksCache[tid]||{}).name || tid;
                if (classF  && sub.studentClass!==classF) return;
                if (statusF && sub.status!==statusF) return;
                rows.push({name:sub.studentName||sk, cls:sub.studentClass||'', task:taskName, submittedAt:sub.submittedAt, status:sub.status});
            });
        });
        rows.sort((a,b)=>new Date(b.submittedAt)-new Date(a.submittedAt));
        if(!rows.length){ tbody.innerHTML='<tr><td colspan="6" style="text-align:center;color:#999;padding:16px">No matching submissions.</td></tr>'; return; }
        tbody.innerHTML='';
        rows.forEach((r,i) => {
            const statusBg  = r.status==='approved'?'#d4edda':r.status==='rejected'?'#f8d7da':'#fff3cd';
            const statusCol = r.status==='approved'?'#155724':r.status==='rejected'?'#721c24':'#856404';
            const statusLabel = r.status==='approved'?'âœ… Approved':r.status==='rejected'?'âŒ Rejected':'â³ Pending';
            const row = tbody.insertRow();
            row.innerHTML = '<td>'+(i+1)+'</td>'
                +'<td><strong>'+shEsc(r.name)+'</strong></td>'
                +'<td><span style="background:#f3e5ff;color:#4a148c;padding:2px 8px;border-radius:10px;font-size:12px">'+shEsc(r.cls)+'</span></td>'
                +'<td>'+shEsc(r.task)+'</td>'
                +'<td style="font-size:12px">'+new Date(r.submittedAt).toLocaleString('en-IN')+'</td>'
                +'<td><span style="background:'+statusBg+';color:'+statusCol+';padding:3px 10px;border-radius:10px;font-weight:700;font-size:12px">'+statusLabel+'</span></td>';
        });
    }

    function shCopySummary() {
        const txt = window._shLastSummaryText || '';
        if (!txt) { alert('Load class-wise data first by clicking Refresh.'); return; }
        navigator.clipboard.writeText(txt).then(() => {
            const btn = document.querySelector('[onclick="shCopySummary()"]');
            if (btn) { const orig=btn.textContent; btn.textContent='âœ… Copied!'; setTimeout(()=>btn.textContent=orig,2000); }
        }).catch(() => {
            // Fallback for older browsers
            const ta = document.createElement('textarea');
            ta.value = txt; ta.style.position='fixed'; ta.style.opacity='0';
            document.body.appendChild(ta); ta.select();
            document.execCommand('copy'); document.body.removeChild(ta);
            const btn = document.querySelector('[onclick="shCopySummary()"]');
            if (btn) { const orig=btn.textContent; btn.textContent='âœ… Copied!'; setTimeout(()=>btn.textContent=orig,2000); }
        });
    }

    // â”€â”€ Admin: Winners â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    let _shWinnersParticipants = [];

    async function shLoadWinnersTab() {
        const listEl = document.getElementById('shWinnersEligibleList');
        if(listEl) listEl.innerHTML='<p style="color:#aaa;text-align:center;padding:12px">â³ Loading participantsâ€¦</p>';
        try {
            const [subSnap, taskSnap] = await Promise.all([
                window.db.ref('scavengerHunt/submissions').once('value'),
                window.db.ref('scavengerHunt/tasks').once('value')
            ]);
            const allSubs  = subSnap.val()  || {};
            const allTasks = taskSnap.val() || {};
            const totalTasks = Object.keys(allTasks).length;
            _shWinnersParticipants = [];

            Object.entries(allSubs).forEach(([sk,ss]) => {
                const first = Object.values(ss)[0] || {};
                let approved=0, lastTime=null;
                Object.values(ss).forEach(sub => {
                    if(sub.status==='approved'){ approved++; if(!lastTime||sub.reviewedAt>lastTime) lastTime=sub.reviewedAt; }
                });
                _shWinnersParticipants.push({key:sk, name:first.studentName||sk, cls:first.studentClass||'', approved, totalTasks, lastTime:lastTime||''});
            });
            _shWinnersParticipants.sort((a,b)=>b.approved-a.approved||(a.lastTime||'zzz').localeCompare(b.lastTime||'zzz'));

            // Populate manual select dropdowns
            const winSel = document.getElementById('shManualWinnerSelect');
            const runSel = document.getElementById('shManualRunnerSelect');
            if(winSel){ winSel.innerHTML='<option value="">-- Select Winner --</option>'; }
            if(runSel){ runSel.innerHTML='<option value="">-- Select Runner-up --</option>'; }
            _shWinnersParticipants.forEach(p => {
                const label = p.name + ' ('+p.cls+') â€“ '+p.approved+'/'+p.totalTasks+' tasks';
                if(winSel){ const o=document.createElement('option'); o.value=p.key; o.textContent=label; winSel.appendChild(o); }
                if(runSel){ const o=document.createElement('option'); o.value=p.key; o.textContent=label; runSel.appendChild(o); }
            });

            // Render eligible participants table
            const medals=['ðŸ¥‡','ðŸ¥ˆ','ðŸ¥‰'];
            let html='<div class="table-wrapper"><table style="font-size:13px;width:100%"><thead><tr>';
            html+='<th style="background:#3d0060;color:#ffd700">Rank</th>';
            html+='<th style="background:#3d0060;color:white">Student</th>';
            html+='<th style="background:#3d0060;color:#ce93d8">Class</th>';
            html+='<th style="background:#3d0060;color:#a5d6a7">Tasks Done</th>';
            html+='<th style="background:#3d0060;color:#80deea">Progress</th>';
            html+='</tr></thead><tbody>';
            if(!_shWinnersParticipants.length){
                html+='<tr><td colspan="5" style="text-align:center;color:#999;padding:16px">No participants yet.</td></tr>';
            } else {
                _shWinnersParticipants.forEach((p,i) => {
                    const pct = p.totalTasks ? Math.round(p.approved/p.totalTasks*100) : 0;
                    const rowBg = i===0?'#fffde7':i===1?'#f5f5f5':i===2?'#fff8f0':'white';
                    html+='<tr style="background:'+rowBg+'">';
                    html+='<td style="text-align:center;font-size:1.3em">'+(medals[i]||(i+1))+'</td>';
                    html+='<td><strong style="color:#6a1b9a">'+shEsc(p.name)+'</strong></td>';
                    html+='<td><span style="background:#f3e5ff;color:#4a148c;padding:2px 8px;border-radius:10px;font-size:12px">'+shEsc(p.cls)+'</span></td>';
                    html+='<td style="text-align:center;font-weight:700;color:'+(p.approved===p.totalTasks?'#2e7d32':'#555')+'">'+p.approved+'/'+p.totalTasks+'</td>';
                    html+='<td style="min-width:120px"><div style="background:#eee;border-radius:6px;height:8px;margin-bottom:3px"><div style="background:'+(pct>=100?'#4caf50':'#9c27b0')+';width:'+pct+'%;height:8px;border-radius:6px"></div></div><span style="font-size:11px;color:#555">'+pct+'%</span></td>';
                    html+='</tr>';
                });
            }
            html+='</tbody></table></div>';
            if(listEl) listEl.innerHTML=html;

            // Load currently declared winner
            shLoadDeclaredWinner();
        } catch(e) {
            if(listEl) listEl.innerHTML='<p style="color:red">Error: '+e.message+'</p>';
        }
    }

    async function shLoadDeclaredWinner() {
        const box = document.getElementById('shWinnersDeclaredBox');
        if(!box) return;
        try {
            const snap = await window.db.ref('scavengerHunt/winner').once('value');
            const w = snap.val();
            if(!w){ box.style.display='none'; return; }
            box.style.display='block';
            const dateStr   = w.declaredFor ? new Date(w.declaredFor).toLocaleDateString('en-IN',{day:'2-digit',month:'short',year:'numeric'}) : '';
            const taskStr   = w.taskLabel   || 'All tasks';
            const declaredStr = new Date(w.declaredAt).toLocaleString('en-IN',{day:'2-digit',month:'short',year:'numeric',hour:'2-digit',minute:'2-digit',hour12:true});
            box.innerHTML = '<div style="background:linear-gradient(135deg,#ffd700,#ff9800);border-radius:14px;padding:22px;margin-top:10px;color:#3d0060">'
                +'<h4 style="margin:0 0 6px;font-size:1.1em">ðŸŽ–ï¸ Currently Declared Winner</h4>'
                +'<div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:14px">'
                +(dateStr?'<span style="background:rgba(255,255,255,0.6);padding:3px 10px;border-radius:12px;font-size:12px;font-weight:700">ðŸ“… '+dateStr+'</span>':'')
                +'<span style="background:rgba(255,255,255,0.6);padding:3px 10px;border-radius:12px;font-size:12px;font-weight:700">ðŸ—ºï¸ '+shEsc(taskStr)+'</span>'
                +'</div>'
                +'<div style="display:flex;gap:20px;flex-wrap:wrap">'
                +(w.winner?'<div style="background:rgba(255,255,255,0.7);border-radius:10px;padding:14px 20px;min-width:180px">'
                    +'<div style="font-size:1.8em;margin-bottom:4px">ðŸ¥‡</div>'
                    +'<strong style="font-size:1em;color:#1a237e">'+shEsc(w.winner.name)+'</strong>'
                    +'<br><span style="font-size:0.85em;color:#4a148c">'+shEsc(w.winner.cls)+'</span>'
                    +'<br><span style="font-size:0.8em;color:#555">'+w.winner.approved+'/'+w.winner.totalTasks+' tasks</span></div>':'')
                +(w.runnerUp?'<div style="background:rgba(255,255,255,0.5);border-radius:10px;padding:14px 20px;min-width:180px">'
                    +'<div style="font-size:1.8em;margin-bottom:4px">ðŸ¥ˆ</div>'
                    +'<strong style="font-size:1em;color:#1a237e">'+shEsc(w.runnerUp.name)+'</strong>'
                    +'<br><span style="font-size:0.85em;color:#4a148c">'+shEsc(w.runnerUp.cls)+'</span>'
                    +'<br><span style="font-size:0.8em;color:#555">'+w.runnerUp.approved+'/'+w.runnerUp.totalTasks+' tasks</span></div>':'')
                +'</div>'
                +'<div style="margin-top:12px;font-size:0.8em;opacity:0.75">Declared at: '+declaredStr+'</div>'
                +'<button onclick="shClearWinner()" class="btn btn-danger btn-small" style="margin-top:10px">ðŸ—‘ï¸ Clear Winner</button>'
                +'</div>';
        } catch(e) { console.warn('shLoadDeclaredWinner:', e); }
    }

    async function shSelectWinnersAuto() {
        if(!_shWinnersParticipants.length){ alert('Load participants first by clicking Refresh.'); return; }
        const top = _shWinnersParticipants[0];
        const maxApproved = top.approved;
        const eligible = _shWinnersParticipants.filter(p=>p.approved===maxApproved);
        if(eligible.length===0){ alert('No participants with approved tasks yet.'); return; }
        const winner = eligible[Math.floor(Math.random()*eligible.length)];
        const rest   = _shWinnersParticipants.filter(p=>p.key!==winner.key);
        const runnerUp = rest.length ? rest[0] : null;
        if(!confirm(`Auto-select:\nðŸ¥‡ Winner: ${winner.name} (${winner.cls})\n${runnerUp ? 'ðŸ¥ˆ Runner-up: '+runnerUp.name+' ('+runnerUp.cls+')' : ''}\n\nDeclare these winners?`)) return;
        await shSaveWinner(winner, runnerUp);
    }

    // â”€â”€ Scavenger Hunt Auto-Declaration Scheduler â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    let _shAutoDeclarInterval = null;

    function shToggleAutoDeclar() {
        const enabled = document.getElementById('shAutoDeclarToggle').checked;
        shApplyAutoDeclarUI(enabled);
        // Save to Firebase
        const time   = document.getElementById('shAutoDeclarTime').value || '23:30';
        const date   = document.getElementById('shAutoDeclarDate').value || '';
        const taskId = document.getElementById('shAutoDeclarTask').value || 'all';
        window.db.ref('scavengerHunt/autoDeclarConfig').set({ enabled, time, date, taskId, updatedAt: new Date().toISOString() });
        if (enabled) shStartAutoDeclarScheduler(); else shStopAutoDeclarScheduler();
    }

    function shApplyAutoDeclarUI(enabled) {
        const slider  = document.getElementById('shAutoDeclarSlider');
        const thumb   = document.getElementById('shAutoDeclarThumb');
        const badge   = document.getElementById('shAutoDeclarBadge');
        const status  = document.getElementById('shAutoDeclarStatusMsg');
        const countdown = document.getElementById('shAutoDeclarCountdownDisplay');
        if (!slider) return;
        const time = document.getElementById('shAutoDeclarTime')?.value || '23:30';
        const [hh, mm] = time.split(':').map(Number);
        const ampm = hh >= 12 ? 'PM' : 'AM';
        const h12  = hh % 12 || 12;
        const timeStr = `${h12}:${String(mm).padStart(2,'0')} ${ampm}`;
        if (enabled) {
            slider.style.background = '#28a745'; thumb.style.left = '25px';
            badge.textContent = 'ON';
            status.innerHTML = `ðŸŸ¢ Auto-declaration <strong style="color:#a5ffb8">enabled</strong>. Winners will be declared at <strong style="color:#ffd700">${timeStr}</strong> on the set date.`;
            countdown.style.display = 'block';
            shUpdateCountdown();
        } else {
            slider.style.background = '#555'; thumb.style.left = '3px';
            badge.textContent = 'OFF';
            status.innerHTML = 'ðŸ”´ Auto-declaration is <strong style="color:#ff6b6b">disabled</strong>. Toggle ON and save config to enable.';
            countdown.style.display = 'none';
        }
    }

    function shUpdateCountdown() {
        const el = document.getElementById('shAutoDeclarCountdownDisplay');
        if (!el) return;
        const time = document.getElementById('shAutoDeclarTime')?.value || '23:30';
        const date = document.getElementById('shAutoDeclarDate')?.value || '';
        const [hh, mm] = time.split(':').map(Number);
        const now = new Date();
        let target;
        if (date) {
            target = new Date(`${date}T${String(hh).padStart(2,'0')}:${String(mm).padStart(2,'0')}:00`);
        } else {
            target = new Date(); target.setHours(hh, mm, 0, 0);
            if (now >= target) target.setDate(target.getDate() + 1);
        }
        if (now >= target) {
            el.textContent = 'â° Scheduled time has passed.'; return;
        }
        const diff = Math.floor((target - now) / 1000);
        const h = Math.floor(diff / 3600), m = Math.floor((diff % 3600) / 60), s = diff % 60;
        el.textContent = `â³ Auto-declaration in: ${String(h).padStart(2,'0')}h ${String(m).padStart(2,'0')}m ${String(s).padStart(2,'0')}s`;
    }

    function shStartAutoDeclarScheduler() {
        shStopAutoDeclarScheduler();
        _shAutoDeclarInterval = setInterval(async () => {
            const toggle = document.getElementById('shAutoDeclarToggle');
            if (!toggle || !toggle.checked) return;
            shUpdateCountdown();
            const time = document.getElementById('shAutoDeclarTime')?.value || '23:30';
            const date = document.getElementById('shAutoDeclarDate')?.value || '';
            const [hh, mm] = time.split(':').map(Number);
            const now = new Date();
            const todayStr = now.toISOString().slice(0, 10);
            // Fire only if date matches (or no date set) AND time matches current minute
            const dateMatch = !date || date === todayStr;
            if (dateMatch && now.getHours() === hh && now.getMinutes() === mm) {
                await shRunAutoDeclaration();
            }
        }, 1000);
    }

    function shStopAutoDeclarScheduler() {
        if (_shAutoDeclarInterval) { clearInterval(_shAutoDeclarInterval); _shAutoDeclarInterval = null; }
    }

    async function shRunAutoDeclaration() {
        shStopAutoDeclarScheduler();
        try {
            const cfgSnap    = await window.db.ref('scavengerHunt/autoDeclarConfig').once('value');
            const cfg        = cfgSnap.val() || {};
            const filterTaskId = cfg.taskId || 'all';
            const targetDate   = cfg.date   || null;

            // Skip if date set and doesn't match today
            if (targetDate && targetDate !== new Date().toISOString().slice(0, 10)) {
                console.log('[SH-AutoDeclar] Date mismatch â€” skipping.'); return;
            }
            // Skip if already declared today
            const winSnap = await window.db.ref('scavengerHunt/winner').once('value');
            const existing = winSnap.val();
            if (existing?.declaredAt?.slice(0, 10) === new Date().toISOString().slice(0, 10)) {
                console.log('[SH-AutoDeclar] Already declared today â€” skipping.'); return;
            }

            const [taskSnap, subSnap] = await Promise.all([
                window.db.ref('scavengerHunt/tasks').once('value'),
                window.db.ref('scavengerHunt/submissions').once('value')
            ]);
            const allTasks   = taskSnap.val() || {};
            const totalTasks = Object.keys(allTasks).length;
            const allSubs    = subSnap.val() || {};

            const participants = [];
            Object.entries(allSubs).forEach(([sk, ss]) => {
                const first = Object.values(ss)[0] || {};
                let approved = 0, lastTime = null;
                if (filterTaskId === 'all') {
                    Object.values(ss).forEach(sub => { if (sub.status === 'approved') { approved++; if (!lastTime || sub.reviewedAt > lastTime) lastTime = sub.reviewedAt; } });
                } else {
                    const sub = ss[filterTaskId];
                    if (sub?.status === 'approved') { approved = 1; lastTime = sub.reviewedAt || ''; }
                }
                participants.push({ key: sk, name: first.studentName || sk, cls: first.studentClass || '', approved, totalTasks, lastTime: lastTime || '' });
            });
            participants.sort((a, b) => b.approved - a.approved || (a.lastTime || 'zzz').localeCompare(b.lastTime || 'zzz'));

            if (!participants.length || participants[0].approved === 0) {
                const s = document.getElementById('shAutoDeclarStatusMsg');
                if (s) s.innerHTML = 'âš ï¸ Auto-declaration ran but <strong>no approved submissions</strong> found for the selected task.';
                return;
            }

            const maxApproved = participants[0].approved;
            const eligible    = participants.filter(p => p.approved === maxApproved);
            const winner      = eligible[Math.floor(Math.random() * eligible.length)];
            const rest        = participants.filter(p => p.key !== winner.key);
            const runnerUp    = rest.length ? rest[0] : null;
            const taskLabel   = filterTaskId === 'all' ? 'All tasks' : (allTasks[filterTaskId]?.name || filterTaskId);

            await shSaveWinner(winner, runnerUp, taskLabel, targetDate);
            const s = document.getElementById('shAutoDeclarStatusMsg');
            if (s) s.innerHTML = `âœ… Declared! ðŸ¥‡ ${winner.name} (${winner.cls})${runnerUp ? ' | ðŸ¥ˆ ' + runnerUp.name + ' (' + runnerUp.cls + ')' : ''}`;
            console.log(`[SH-AutoDeclar] âœ… Winner: ${winner.name}`);
        } catch(e) {
            console.error('[SH-AutoDeclar] Error:', e);
        } finally {
            shStartAutoDeclarScheduler();
        }
    }

    async function shInitAutoDeclarScheduler() {
        try {
            // Load tasks into dropdown
            const taskSnap = await window.db.ref('scavengerHunt/tasks').once('value');
            const tasks = Object.entries(taskSnap.val() || {}).map(([k,v])=>({id:k,...v})).sort((a,b)=>(a.order||0)-(b.order||0));
            const taskSel = document.getElementById('shAutoDeclarTask');
            if (taskSel) {
                taskSel.innerHTML = '<option value="all">â­ All tasks</option>';
                tasks.forEach(t => {
                    const o = document.createElement('option');
                    o.value = t.id;
                    o.textContent = `Task ${t.order||'?'}: ${t.name.length > 45 ? t.name.slice(0,45)+'â€¦' : t.name}`;
                    taskSel.appendChild(o);
                });
            }
            // Restore saved config
            const cfgSnap = await window.db.ref('scavengerHunt/autoDeclarConfig').once('value');
            const cfg = cfgSnap.val() || {};
            if (cfg.date   && document.getElementById('shAutoDeclarDate')) document.getElementById('shAutoDeclarDate').value = cfg.date;
            if (cfg.time   && document.getElementById('shAutoDeclarTime')) document.getElementById('shAutoDeclarTime').value = cfg.time;
            if (cfg.taskId && taskSel) taskSel.value = cfg.taskId;
            const enabled = !!cfg.enabled;
            const toggle  = document.getElementById('shAutoDeclarToggle');
            if (toggle) toggle.checked = enabled;
            shApplyAutoDeclarUI(enabled);
            if (enabled) shStartAutoDeclarScheduler();
        } catch(e) { console.warn('[SH-AutoDeclar] Init error:', e); }
    }

    async function shSaveAutoDeclarConfig(btn) {
        const date   = document.getElementById('shAutoDeclarDate').value;
        const time   = document.getElementById('shAutoDeclarTime').value || '23:30';
        const taskId = document.getElementById('shAutoDeclarTask').value;
        const enabled = document.getElementById('shAutoDeclarToggle').checked;
        if (!date) { alert('Please select a date.'); return; }
        try {
            await window.db.ref('scavengerHunt/autoDeclarConfig').set({ enabled, date, time, taskId, updatedAt: new Date().toISOString() });
            shApplyAutoDeclarUI(enabled);
            if (enabled) shStartAutoDeclarScheduler();
            const orig = btn.textContent;
            btn.textContent = 'âœ… Saved!'; btn.style.background = '#4caf50'; btn.style.color = 'white';
            setTimeout(() => { btn.textContent = orig; btn.style.background = '#ffd700'; btn.style.color = '#1a0030'; }, 2000);
        } catch(e) { alert('Save failed: ' + e.message); }
    }

    function shSyncAutoDeclarPanel() {} // no-op, kept for compatibility

    function shToggleManualWinner() {
        const p = document.getElementById('shManualWinnerPanel');
        if(p) p.style.display = p.style.display==='none' ? 'block' : 'none';
    }

    async function shDeclareManualWinners() {
        const wKey = document.getElementById('shManualWinnerSelect').value;
        const rKey = document.getElementById('shManualRunnerSelect').value;
        if(!wKey){ alert('Please select a winner.'); return; }
        if(wKey===rKey){ alert('Winner and Runner-up cannot be the same person.'); return; }
        const winner   = _shWinnersParticipants.find(p=>p.key===wKey);
        const runnerUp = rKey ? _shWinnersParticipants.find(p=>p.key===rKey) : null;
        if(!confirm(`Declare:
ðŸ¥‡ Winner: ${winner.name} (${winner.cls})
${runnerUp ? 'ðŸ¥ˆ Runner-up: '+runnerUp.name+' ('+runnerUp.cls+')' : ''}

Proceed?`)) return;
        await shSaveWinner(winner, runnerUp);
        shToggleManualWinner();
    }

    async function shSaveWinner(winner, runnerUp, taskLabel, declaredDate) {
        try {
            const data = {
                winner:   {key:winner.key,   name:winner.name,   cls:winner.cls,   approved:winner.approved,   totalTasks:winner.totalTasks},
                runnerUp: runnerUp ? {key:runnerUp.key, name:runnerUp.name, cls:runnerUp.cls, approved:runnerUp.approved, totalTasks:runnerUp.totalTasks} : null,
                declaredAt:   new Date().toISOString(),
                declaredFor:  declaredDate || new Date().toISOString().slice(0,10),
                taskLabel:    taskLabel || 'All tasks',
                autoSelected: true
            };
            await window.db.ref('scavengerHunt/winner').set(data);
            const toast = document.createElement('div');
            toast.textContent = 'ðŸŽ–ï¸ Winners declared successfully!';
            toast.style.cssText = 'position:fixed;top:20px;left:50%;transform:translateX(-50%);background:#4caf50;color:white;padding:12px 28px;border-radius:30px;font-weight:700;font-size:1em;z-index:9999;box-shadow:0 4px 20px rgba(0,0,0,0.2);transition:opacity 0.5s';
            document.body.appendChild(toast);
            setTimeout(()=>{ toast.style.opacity='0'; setTimeout(()=>toast.remove(),500); }, 2500);
            shLoadDeclaredWinner();
        } catch(e) { alert('Failed to save winner: '+e.message); }
    }

    async function shClearWinner() {
        if(!confirm('Clear the declared winner? This cannot be undone.')) return;
        await window.db.ref('scavengerHunt/winner').remove();
        const box = document.getElementById('shWinnersDeclaredBox');
        if(box) box.style.display='none';
    }

    // â”€â”€ Admin: Settings â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // â”€â”€ Remove All Deadlines from all tasks â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function shRemoveAllDeadlines(){
        var el=document.getElementById('shChainFixResult');
        el.style.display='block';
        el.textContent='Removing deadlines from all tasks...\n';
        try{
            var snap=await window.db.ref('scavengerHunt/tasks').once('value');
            var raw=snap.val()||{};
            var tasks=Object.entries(raw).map(function(e){return Object.assign({id:e[0]},e[1]);});
            if(!tasks.length){el.textContent='No tasks found.';return;}
            var updates={};
            for(var i=0;i<tasks.length;i++){
                updates['scavengerHunt/tasks/'+tasks[i].id+'/deadline']=null;
                updates['scavengerHunt/tasks/'+tasks[i].id+'/availableFrom']=null;
                el.textContent+='Removing deadline from: "'+tasks[i].name.substring(0,50)+'...\n';
            }
            await window.db.ref().update(updates);
            el.textContent+='Done! All deadlines removed from '+tasks.length+' task(s). Students can now submit. Tell them to refresh.';
        }catch(e){el.textContent+='Error: '+e.message;}
    }

    // â”€â”€ Cloudinary Test â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function shTestCloudinary() {
        var fileInput=document.getElementById('shCloudTestFile');
        var resultEl=document.getElementById('shCloudTestResult');
        resultEl.innerHTML='Testing...'; resultEl.style.color='#555';
        var file=fileInput&&fileInput.files&&fileInput.files[0];
        if(!file){
            var b64='iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNk+M9QDwADhgGAWjR9awAAAABJRU5ErkJggg==';
            var bs=atob(b64),ab=new ArrayBuffer(bs.length),ia=new Uint8Array(ab);
            for(var i=0;i<bs.length;i++){ia[i]=bs.charCodeAt(i);}
            file=new Blob([ab],{type:'image/png'});
        }
        try{
            var fd=new FormData();
            fd.append('file',file);
            fd.append('upload_preset','scavenger_hunt');
            fd.append('folder','scavenger_hunt/_test_');
            fd.append('public_id','test_'+Date.now());
            var res=await fetch('https://api.cloudinary.com/v1_1/dat0khbet/image/upload',{method:'POST',body:fd});
            var data=await res.json();
            if(data.secure_url){
                resultEl.style.color='#2e7d32';
                resultEl.innerHTML='<strong>Cloudinary WORKING!</strong><br>URL: <a href="'+data.secure_url+'" target="_blank" style="word-break:break-all;color:#1565c0">'+data.secure_url+'</a><br><small>Size: '+data.bytes+' bytes</small>';
            } else {
                resultEl.style.color='red';
                resultEl.innerHTML='Failed: '+((data.error&&data.error.message)||JSON.stringify(data));
            }
        }catch(e){resultEl.style.color='red';resultEl.innerHTML='Error: '+e.message;}
    }

    // â”€â”€ Fix Chain Order â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function shFixChainOrder(doWrite){
        var el=document.getElementById('shChainFixResult');
        el.style.display='block';
        el.textContent='Loading tasks...\n';
        try{
            var snap=await window.db.ref('scavengerHunt/tasks').once('value');
            var raw=snap.val()||{};
            var tasks=Object.entries(raw).map(function(e){return Object.assign({id:e[0]},e[1]);}).sort(function(a,b){return (a.order||0)-(b.order||0);});
            for(var i=0;i<tasks.length;i++){
                el.textContent+=(i+1)+'. "'+tasks[i].name+'" current order: '+tasks[i].order+'\n';
            }
            if(!doWrite){
                el.textContent+='\nTap Fix Order Numbers to renumber 1,2,3...';
                return;
            }
            var updates={};
            for(var j=0;j<tasks.length;j++){
                updates['scavengerHunt/tasks/'+tasks[j].id+'/order']=j+1;
            }
            await window.db.ref().update(updates);
            el.textContent+='\nFixed! Task 1 = order 1, Task 2 = order 2.\nTell students to refresh â€” they can now submit Task 1.';
        }catch(e){el.textContent+='\nError: '+e.message;}
    }

    // â”€â”€ Admin Force Submit â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function shAdminForceSubmit(){
        var studentKey=(document.getElementById('afsStudentKey')?document.getElementById('afsStudentKey').value:'').trim();
        var taskId=(document.getElementById('afsTaskId')?document.getElementById('afsTaskId').value:'').trim();
        var photoUrl=(document.getElementById('afsPhotoUrl')?document.getElementById('afsPhotoUrl').value:'').trim();
        var comment=(document.getElementById('afsComment')?document.getElementById('afsComment').value:'').trim();
        var resultEl=document.getElementById('afsResult');
        if(!studentKey||!taskId){resultEl.innerHTML='<span style="color:red">Enter student key and select task.</span>';return;}
        if(!photoUrl){resultEl.innerHTML='<span style="color:red">Enter the Cloudinary photo URL.</span>';return;}
        try{
            var tSnap=await window.db.ref('scavengerHunt/tasks/'+taskId).once('value');
            var sSnap=await window.db.ref('students/'+studentKey).once('value');
            var task=tSnap.val()||{};
            var stu=sSnap.val()||{};
            await window.db.ref('scavengerHunt/submissions/'+studentKey+'/'+taskId).set({
                taskId:taskId, taskName:task.name||taskId,
                studentKey:studentKey, studentName:stu.name||studentKey,
                studentEmail:stu.email||'', studentClass:stu.class||stu.classYear||'',
                photoUrl:photoUrl, comment:comment||'Admin force-submitted',
                status:'pending', submittedAt:new Date().toISOString(),
                lat:null, lng:null, adminForced:true
            });
            resultEl.innerHTML='<span style="color:#2e7d32">Done! '+studentKey+' Task is now Pending Review.</span>';
        }catch(e){resultEl.innerHTML='<span style="color:red">Error: '+e.message+'</span>';}
    }

    async function shPopulateAfsTaskDropdown(){
        var sel=document.getElementById('afsTaskId');
        if(!sel){return;}
        try{
            var snap=await window.db.ref('scavengerHunt/tasks').once('value');
            var raw=snap.val()||{};
            var tasks=Object.entries(raw).map(function(e){return Object.assign({id:e[0]},e[1]);}).sort(function(a,b){return (a.order||0)-(b.order||0);});
            sel.innerHTML='<option value="">â€” Select Task â€”</option>';
            for(var i=0;i<tasks.length;i++){
                var o=document.createElement('option');
                o.value=tasks[i].id;
                o.textContent=(tasks[i].order||'?')+'. '+(tasks[i].name||tasks[i].id).substring(0,60);
                sel.appendChild(o);
            }
        }catch(e){}
    }

    // â”€â”€ Student Submission Debugger â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function shDebugStudentSubs(){
        var key=(document.getElementById('shDebugStudentKey')?document.getElementById('shDebugStudentKey').value:'').trim();
        var resultEl=document.getElementById('shDebugResult');
        if(!key){alert('Enter a student key');return;}
        resultEl.style.display='block';
        resultEl.textContent='Loading...\n';
        try{
            var subSnap=await window.db.ref('scavengerHunt/submissions/'+key).once('value');
            var taskSnap=await window.db.ref('scavengerHunt/tasks').once('value');
            var subs=subSnap.val();
            var tasks=taskSnap.val();
            var out='=== TASKS ===\n';
            if(tasks){
                var arr=Object.entries(tasks).map(function(e){return Object.assign({id:e[0]},e[1]);}).sort(function(a,b){return (a.order||0)-(b.order||0);});
                for(var i=0;i<arr.length;i++){
                    var t=arr[i];
                    var sub=subs&&subs[t.id];
                    out+='\nTask '+(i+1)+': "'+t.name.substring(0,50)+'" (order:'+t.order+')\n';
                    if(sub){
                        out+='  status:      '+sub.status+'\n';
                        out+='  submittedAt: '+(sub.submittedAt||'MISSING - causes Locked!')+'\n';
                        out+='  photoUrl:    '+(sub.photoUrl?'present':'MISSING')+'\n';
                    }else{
                        out+='  No submission found\n';
                    }
                }
            }
            out+='\n=== RAW ===\n'+(subs?JSON.stringify(subs,null,2):'empty - no submissions for: '+key);
            resultEl.textContent=out;
        }catch(e){resultEl.textContent='Error: '+e.message;}
    }

    async function shAdminLoadSettings() {
        try {
            const snap = await window.db.ref('scavengerHunt/settings').once('value');
            const s = snap.val() || {};
            document.getElementById('shSettingActive').checked      = !!s.active;
            document.getElementById('shSettingGPS').checked         = s.gps!==false;
            document.getElementById('shSettingRadius').value        = s.radius||100;
            document.getElementById('shSettingAutoApprove').checked = !!s.autoApprove;
        } catch(e) { console.error('shAdminLoadSettings:',e); }
    }

    async function shAdminSaveSettings() {
        const settings = {
            active:      document.getElementById('shSettingActive').checked,
            gps:         document.getElementById('shSettingGPS').checked,
            radius:      parseInt(document.getElementById('shSettingRadius').value)||100,
            autoApprove: document.getElementById('shSettingAutoApprove').checked,
            updatedAt:   new Date().toISOString()
        };
        await window.db.ref('scavengerHunt/settings').set(settings);
        const msg = document.getElementById('shSettingsSaveMsg');
        msg.style.display='inline-block';
        setTimeout(()=>msg.style.display='none', 3000);
    }

    // â”€â”€ Speed Slide Admin â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    let ssaAllSubs = [];
    let ssaLbDiff  = 'easy';

    function ssaShowTab(t) {
        ['sub','lb','cfg'].forEach(x => {
            document.getElementById('ssa-'+x).style.display = x===t ? 'block' : 'none';
            document.getElementById('ssa-tab-'+x).classList.toggle('active', x===t);
        });
        if (t==='sub') ssaLoadSubs();
        if (t==='lb')  ssaLoadLB();
        if (t==='cfg') ssaLoadCfg();
    }

    async function ssaLoadSubs() {
        document.getElementById('ssaSubList').innerHTML = '<p style="color:#aaa;padding:20px;text-align:center">Loadingâ€¦</p>';
        const diff   = document.getElementById('ssaSubFilter').value;
        const status = document.getElementById('ssaSubStatus').value;
        try {
            const snap = await window.db.ref('speedSlide/submissions').once('value');
            ssaAllSubs = [];
            snap.forEach(c => ssaAllSubs.push({ key: c.key, ...c.val() }));
            ssaAllSubs.sort((a,b) => b.solvedAt > a.solvedAt ? 1 : -1);
            let rows = ssaAllSubs.filter(r =>
                (!diff   || r.difficulty === diff) &&
                (!status || r.status     === status)
            );
            if (!rows.length) {
                document.getElementById('ssaSubList').innerHTML = '<p style="color:#aaa;text-align:center;padding:30px">No submissions found.</p>';
                return;
            }
            const diffLabel = {easy:'ðŸ˜Š 8-Puzzle', medium:'ðŸ˜… 15-Puzzle', hard:'ðŸ”¥ 24-Puzzle'};
            const statusColor = {approved:'#2e7d32', rejected:'#c62828', pending:'#e65100'};
            const statusBg    = {approved:'#e8f5e9', rejected:'#ffebee', pending:'#fff3e0'};
            document.getElementById('ssaSubList').innerHTML = rows.map(r => `
                <div style="background:white;border-radius:12px;padding:16px;margin-bottom:12px;box-shadow:0 2px 10px rgba(0,0,0,.08);display:flex;align-items:center;gap:16px;flex-wrap:wrap;border-left:5px solid ${r.status==='approved'?'#4caf50':r.status==='rejected'?'#f44336':'#ff9800'}">
                    ${r.imageUrl
                        ? `<img src="${r.imageUrl}" onclick="document.getElementById('ssaLightbox').style.display='flex';document.getElementById('ssaLightboxImg').src='${r.imageUrl}'" style="width:90px;height:90px;object-fit:cover;border-radius:8px;border:2px solid #9c27b0;cursor:zoom-in" alt="">`
                        : `<div style="width:90px;height:90px;background:#f0e6ff;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:2em;color:#9c27b0">ðŸ“·</div>`
                    }
                    <div style="flex:1;min-width:160px">
                        <div style="font-weight:700;font-size:1em;color:#333">${ssaEsc(r.name)}</div>
                        <div style="color:#888;font-size:.85em;margin:3px 0">${ssaEsc(r.class||'')} Â· ${ssaEsc(r.phone||'')}</div>
                        <div style="font-size:.88em;color:#6a1b9a;margin:3px 0">
                            ${diffLabel[r.difficulty]||r.difficulty} Â· â± ${ssaFmtTime(r.timeSec)} Â· ðŸŽ¯ ${r.moves} moves Â· â­ ${r.points} pts
                        </div>
                        <div style="font-size:.8em;color:#aaa">${r.date||''} at ${(r.solvedAt||'').slice(11,19)}</div>
                        <span style="display:inline-block;padding:3px 10px;border-radius:10px;font-size:.78em;font-weight:700;background:${statusBg[r.status]||statusBg.pending};color:${statusColor[r.status]||statusColor.pending};margin-top:5px">${r.status||'pending'}</span>
                    </div>
                    <div style="display:flex;flex-direction:column;gap:7px">
                        <button onclick="ssaApprove('${r.key}')" style="background:#4caf50;color:white;border:none;padding:8px 16px;border-radius:7px;cursor:pointer;font-weight:600;font-size:.88em">âœ… Approve</button>
                        <button onclick="ssaReject('${r.key}')"  style="background:#f44336;color:white;border:none;padding:8px 16px;border-radius:7px;cursor:pointer;font-weight:600;font-size:.88em">âŒ Reject</button>
                        <button onclick="ssaDelete('${r.key}')"  style="background:#888;   color:white;border:none;padding:8px 16px;border-radius:7px;cursor:pointer;font-weight:600;font-size:.88em">ðŸ—‘ Delete</button>
                    </div>
                </div>`).join('');
        } catch(e) {
            document.getElementById('ssaSubList').innerHTML = '<p style="color:red;padding:20px">Error: '+e.message+'</p>';
        }
    }

    async function ssaApprove(key) {
        await window.db.ref('speedSlide/submissions/'+key+'/status').set('approved');
        ssaLoadSubs();
    }
    async function ssaReject(key) {
        await window.db.ref('speedSlide/submissions/'+key+'/status').set('rejected');
        ssaLoadSubs();
    }
    async function ssaDelete(key) {
        if (!confirm('Delete this submission permanently?')) return;
        await window.db.ref('speedSlide/submissions/'+key).remove();
        ssaLoadSubs();
    }

    async function ssaLoadLB() {
        document.getElementById('ssaLbContainer').innerHTML = '<p style="color:#aaa;padding:20px;text-align:center">Loadingâ€¦</p>';
        try {
            const snap = await window.db.ref('speedSlide/submissions').once('value');
            let data = [];
            snap.forEach(c => { const v=c.val(); if(v.status==='approved') data.push(v); });
            data.sort((a,b) => {
                if (b.points !== a.points) return b.points - a.points;
                if (a.timeSec !== b.timeSec) return a.timeSec - b.timeSec;
                return a.moves - b.moves;
            });
            const diff = ssaLbDiff;
            let rows = diff==='all' ? data : data.filter(r => r.difficulty===diff);
            const seen = new Set();
            rows = rows.filter(r => {
                const k = (r.uid||r.phone)+'|'+r.difficulty;
                if (seen.has(k)) return false;
                seen.add(k); return true;
            });
            const medals = ['ðŸ¥‡','ðŸ¥ˆ','ðŸ¥‰'];
            const diffLabel = {easy:'ðŸ˜Š 8-Puzzle', medium:'ðŸ˜… 15-Puzzle', hard:'ðŸ”¥ 24-Puzzle'};
            document.getElementById('ssaLbContainer').innerHTML = rows.length
                ? rows.map((r,i) => `
                    <div style="display:grid;grid-template-columns:44px 1fr auto auto;gap:10px;align-items:center;padding:12px 16px;border-radius:10px;background:white;margin-bottom:8px;box-shadow:0 2px 8px rgba(0,0,0,.07)">
                        <div style="font-size:1.5em;text-align:center">${medals[i]||'#'+(i+1)}</div>
                        <div>
                            <div style="font-weight:700">${ssaEsc(r.name)}</div>
                            <div style="color:#888;font-size:.82em">${ssaEsc(r.class||'')} Â· ${r.date||''} Â· ${diffLabel[r.difficulty]||r.difficulty}</div>
                        </div>
                        <div style="color:#e65100;font-weight:700;font-size:.9em">â± ${ssaFmtTime(r.timeSec)} Â· ðŸŽ¯ ${r.moves}</div>
                        <div style="color:#6a1b9a;font-weight:800;font-size:1.1em;text-align:right">â­${r.points}</div>
                    </div>`).join('')
                : '<p style="color:#aaa;text-align:center;padding:30px">No approved scores yet.</p>';
        } catch(e) {
            document.getElementById('ssaLbContainer').innerHTML = '<p style="color:red">'+e.message+'</p>';
        }
    }

    function ssaSwitchLB(d) {
        ssaLbDiff = d;
        ['easy','medium','hard','all'].forEach(x =>
            document.getElementById('ssalbt-'+x)?.classList.toggle('active', x===d)
        );
        ssaLoadLB();
    }

    async function ssaLoadCfg() {
        try {
            const snap = await window.db.ref('speedSlide/config').once('value');
            const cfg  = snap.val() || {};
            document.getElementById('ssaCfgActive').value    = cfg.active    !== false ? '1' : '0';
            document.getElementById('ssaCfgLbVisible').value = cfg.lbVisible !== false ? '1' : '0';
            document.getElementById('ssaCfgMaxSubs').value   = cfg.maxSubs  || 3;
        } catch(e) { console.error('ssaLoadCfg:', e); }
    }

    async function ssaSaveCfg() {
        const cfg = {
            active    : document.getElementById('ssaCfgActive').value    === '1',
            lbVisible : document.getElementById('ssaCfgLbVisible').value === '1',
            maxSubs   : parseInt(document.getElementById('ssaCfgMaxSubs').value) || 3
        };
        await window.db.ref('speedSlide/config').set(cfg);
        const msg = document.getElementById('ssaCfgMsg');
        msg.style.display = 'inline-block';
        msg.style.color   = '#2e7d32';
        msg.textContent   = 'âœ… Settings saved!';
        setTimeout(() => msg.style.display='none', 3000);
    }

    async function ssaClearAllScores() {
        if (!confirm('âš ï¸ Delete ALL Speed Slide scores? This cannot be undone.')) return;
        await window.db.ref('speedSlide/submissions').remove();
        alert('All scores cleared.');
        ssaLoadSubs();
    }

    function ssaClearAllImages() {
        alert('To clear uploaded images, go to Firebase Console â†’ Storage â†’ speedSlide/ folder and delete files from there.');
    }

    function ssaDownloadCSV() {
        const rows = [['Name','Class','Phone','Difficulty','Time(sec)','Moves','Points','Status','Date','SolvedAt']];
        ssaAllSubs.forEach(r => rows.push([r.name,r.class,r.phone,r.difficulty,r.timeSec,r.moves,r.points,r.status,r.date,r.solvedAt]));
        const csv = rows.map(r => r.map(v => '"'+(v||'')+'"').join(',')).join('\n');
        const a = document.createElement('a');
        a.href = 'data:text/csv;charset=utf-8,' + encodeURIComponent(csv);
        a.download = 'speed_slide_results.csv';
        a.click();
    }

    function ssaFmtTime(sec) {
        if (!sec && sec !== 0) return 'â€”';
        const m = Math.floor(sec/60);
        const s = (sec%60).toString().padStart(2,'0');
        return m+':'+s;
    }
    function ssaEsc(s) {
        if (!s) return '';
        return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
    }

    // â”€â”€ Speed Slide Admin Access â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function openSpeedSlideAdmin() {
        showTab('speedSlideAdmin');
        // Load submissions automatically
        ssaShowTab('sub');
    }

    // â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function shEsc(str) {
        if (!str) return '';
        return String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
    }
    function shShowMsg(el,type,text) {
        el.className='message '+(type==='error'?'error':'success')+' show';
        el.textContent=text; el.style.display='block';
    }
    function shShowInlineMsg(el,type,text) {
        if(!el) return;
        el.style.display='block';
        el.style.color=type==='error'?'#c62828':type==='success'?'#2e7d32':'#1565c0';
        el.style.background=type==='error'?'#ffebee':type==='success'?'#e8f5e9':'#e3f2fd';
        el.style.padding='8px 12px'; el.style.borderRadius='6px';
        el.textContent=text;
    }

    // showTab scavenger logic handled directly inside showTab() in main script


    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // SPEED SLIDE CHALLENGE â€” Full game logic (runs inside index.html)
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    const SSC_DIFF = {
        easy  : { size:3, maxPts:100,  label:'8-Puzzle (3Ã—3)'  },
        medium: { size:4, maxPts:200,  label:'15-Puzzle (4Ã—4)' },
        hard  : { size:5, maxPts:300,  label:'24-Puzzle (5Ã—5)' }
    };

    sscCurrentUser = null;
    let sscDiff        = 'medium';
    let sscSize        = 4;
    let sscTiles       = [];
    let sscEmpty       = 0;
    let sscMoves       = 0;
    let sscSeconds     = 0;
    sscTimerRef    = null;
    let sscSolDisabled = false;
    let sscSolved      = false;
    let sscImageData   = null;
    let sscLbDiff      = 'easy';

    // â•â• SSC SOUND ENGINE (Web Audio API) â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    const sscAudioCtx = (function() {
        try { return new (window.AudioContext || window.webkitAudioContext)(); } catch(e) { return null; }
    })();

    function sscPlaySound(type) {
        if (!sscAudioCtx) return;
        try {
            const ctx = sscAudioCtx;
            if (ctx.state === 'suspended') ctx.resume();
            const o = ctx.createOscillator();
            const g = ctx.createGain();
            o.connect(g); g.connect(ctx.destination);
            const t = ctx.currentTime;
            if (type === 'move') {
                // Soft click: short blip
                o.type = 'sine';
                o.frequency.setValueAtTime(520, t);
                o.frequency.exponentialRampToValueAtTime(420, t + 0.06);
                g.gain.setValueAtTime(0.18, t);
                g.gain.exponentialRampToValueAtTime(0.001, t + 0.08);
                o.start(t); o.stop(t + 0.08);
            } else if (type === 'invalid') {
                // Dull thud for invalid move
                o.type = 'square';
                o.frequency.setValueAtTime(120, t);
                g.gain.setValueAtTime(0.12, t);
                g.gain.exponentialRampToValueAtTime(0.001, t + 0.1);
                o.start(t); o.stop(t + 0.1);
            } else if (type === 'select') {
                // UI selection pop
                o.type = 'sine';
                o.frequency.setValueAtTime(700, t);
                o.frequency.exponentialRampToValueAtTime(900, t + 0.07);
                g.gain.setValueAtTime(0.12, t);
                g.gain.exponentialRampToValueAtTime(0.001, t + 0.1);
                o.start(t); o.stop(t + 0.1);
            } else if (type === 'win') {
                // ðŸŽ‰ VICTORY FANFARE â€” rising chords + triumphant finish
                const winNotes = [
                    {f:523,d:0,dur:0.25},{f:659,d:0.18,dur:0.25},{f:784,d:0.36,dur:0.25},
                    {f:1047,d:0.55,dur:0.5},{f:988,d:0.6,dur:0.4},{f:1047,d:0.75,dur:0.6}
                ];
                winNotes.forEach(({f,d,dur}) => {
                    const o2=ctx.createOscillator(), g2=ctx.createGain();
                    o2.connect(g2); g2.connect(ctx.destination);
                    o2.type='triangle';
                    o2.frequency.setValueAtTime(f, t+d);
                    g2.gain.setValueAtTime(0.28, t+d);
                    g2.gain.exponentialRampToValueAtTime(0.001, t+d+dur);
                    o2.start(t+d); o2.stop(t+d+dur+0.05);
                });
                // Crowd cheer â€” layered noise bursts
                for(let w=0;w<3;w++){
                    const buf=ctx.createBuffer(1,ctx.sampleRate*0.6,ctx.sampleRate);
                    const data=buf.getChannelData(0);
                    for(let i=0;i<data.length;i++) data[i]=(Math.random()*2-1)*0.35;
                    const src=ctx.createBufferSource(), gn=ctx.createGain();
                    const fil=ctx.createBiquadFilter(); fil.type='bandpass';
                    fil.frequency.value=1200+w*400; fil.Q.value=0.8;
                    src.buffer=buf; src.connect(fil); fil.connect(gn); gn.connect(ctx.destination);
                    gn.gain.setValueAtTime(0, t+w*0.25);
                    gn.gain.linearRampToValueAtTime(0.18, t+w*0.25+0.1);
                    gn.gain.exponentialRampToValueAtTime(0.001, t+w*0.25+0.55);
                    src.start(t+w*0.25); src.stop(t+w*0.25+0.6);
                }
                // Clapping rhythm â€” sharp percussive hits
                [0.05,0.25,0.45,0.65,0.85,1.05,1.15,1.25].forEach(d => {
                    const buf=ctx.createBuffer(1,ctx.sampleRate*0.08,ctx.sampleRate);
                    const data=buf.getChannelData(0);
                    for(let i=0;i<data.length;i++) data[i]=(Math.random()*2-1)*Math.exp(-i/(ctx.sampleRate*0.025));
                    const src=ctx.createBufferSource(), gn=ctx.createGain();
                    const fil=ctx.createBiquadFilter(); fil.type='highpass'; fil.frequency.value=800;
                    src.buffer=buf; src.connect(fil); fil.connect(gn); gn.connect(ctx.destination);
                    gn.gain.setValueAtTime(0.4, t+d);
                    gn.gain.exponentialRampToValueAtTime(0.001, t+d+0.07);
                    src.start(t+d); src.stop(t+d+0.08);
                });
                return;
            } else if (type === 'gameover') {
                // ðŸ˜¤ BOO BOO â€” descending sad trombone + crowd boo
                const booNotes = [
                    {f:466,d:0,dur:0.3},{f:415,d:0.25,dur:0.3},{f:370,d:0.5,dur:0.3},{f:311,d:0.75,dur:0.55}
                ];
                booNotes.forEach(({f,d,dur}) => {
                    const o2=ctx.createOscillator(), g2=ctx.createGain();
                    o2.connect(g2); g2.connect(ctx.destination);
                    o2.type='sawtooth';
                    o2.frequency.setValueAtTime(f, t+d);
                    o2.frequency.exponentialRampToValueAtTime(f*0.88, t+d+dur);
                    g2.gain.setValueAtTime(0.2, t+d);
                    g2.gain.exponentialRampToValueAtTime(0.001, t+d+dur);
                    o2.start(t+d); o2.stop(t+d+dur+0.05);
                });
                // Crowd boo noise â€” low rumble
                for(let w=0;w<2;w++){
                    const buf=ctx.createBuffer(1,ctx.sampleRate*0.9,ctx.sampleRate);
                    const data=buf.getChannelData(0);
                    for(let i=0;i<data.length;i++) data[i]=(Math.random()*2-1)*0.25;
                    const src=ctx.createBufferSource(), gn=ctx.createGain();
                    const fil=ctx.createBiquadFilter(); fil.type='bandpass';
                    fil.frequency.value=300+w*120; fil.Q.value=1.2;
                    src.buffer=buf; src.connect(fil); fil.connect(gn); gn.connect(ctx.destination);
                    gn.gain.setValueAtTime(0, t+w*0.15);
                    gn.gain.linearRampToValueAtTime(0.15, t+w*0.15+0.2);
                    gn.gain.exponentialRampToValueAtTime(0.001, t+w*0.15+0.85);
                    src.start(t+w*0.15); src.stop(t+w*0.15+0.9);
                }
                return;
            }
        } catch(e) { /* ignore audio errors */ }
    }

    function sscUpdateLiveScore() {
        const base = SSC_DIFF[sscDiff] ? SSC_DIFF[sscDiff].maxPts : 0;
        const minMoves = sscSize * sscSize * 2;
        const live = Math.max(10, base - Math.floor(sscSeconds*0.5) - Math.max(0, sscMoves-minMoves));
        const el = document.getElementById('sscPtsDisplay');
        if (el) {
            el.textContent = live;
            el.classList.remove('ssc-score-drop');
            void el.offsetWidth; // reflow
            el.classList.add('ssc-score-drop');
        }
    }

    // â”€â”€ LOGIN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function sscLogin() {
        const phone = (document.getElementById('sscLoginPhone').value||'').trim();
        const pass  = (document.getElementById('sscLoginPassword').value||'').trim();
        const msg   = document.getElementById('sscLoginMsg');
        msg.className = 'message'; msg.style.display = 'none';
        if (!phone || !pass) { msg.className='message error show'; msg.textContent='Enter phone and password.'; return; }
        try {
            // Check if game is active before allowing login
            const cfgSnap = await window.db.ref('speedSlide/config').once('value');
            const cfg = cfgSnap.val() || {};
            if (cfg.active === false) {
                msg.className = 'message error show';
                msg.style.display = 'block';
                msg.innerHTML = 'â¸ï¸ <strong>Speed Slide Challenge is currently paused.</strong><br>The organiser has temporarily disabled the game. Please check back later!';
                return;
            }
            const snap = await window.db.ref('quizStudents').orderByChild('phone').equalTo(phone).once('value');
            if (!snap.exists()) { msg.className='message error show'; msg.textContent='Phone not registered. Register via Daily Quiz first.'; return; }
            let found = null, foundKey = null;
            snap.forEach(c => { if (c.val().password === pass) { found = c.val(); foundKey = c.key; } });
            if (!found) { msg.className='message error show'; msg.textContent='Incorrect password.'; return; }
            if (document.getElementById('sscRememberMe').checked) {
                localStorage.setItem('ssc_remember', '1');
                localStorage.setItem('ssc_ph', phone);
                localStorage.setItem('ssc_pw', pass);
            } else {
                localStorage.removeItem('ssc_remember');
                localStorage.removeItem('ssc_ph');
                localStorage.removeItem('ssc_pw');
            }
            sscCurrentUser = { key: foundKey, ...found };
            document.getElementById('loginSection').style.display    = 'none';
            document.getElementById('sscStudentDashboard').style.display = 'block';
            document.getElementById('sscPlayerBadge').textContent    = (found.name||'') + ' Â· ' + (found.class||found.classYear||'');
            document.getElementById('userInfo').innerHTML = 'Logged in as: <span class="admin-badge" style="background:#6a1b9a;color:white">ðŸ§© ' + (found.name||'') + ' â€“ Speed Slide</span>';
            sscShowSection('play');
            sscSelectDiff('medium');
            setTimeout(() => {
                const dash = document.getElementById('sscStudentDashboard');
                if (dash) dash.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }, 80);
        } catch(e) {
            msg.className='message error show'; msg.textContent='Error: ' + e.message;
        }
    }

    function sscGoBack() {
        document.getElementById('sscStudentDashboard').style.display = 'none';
        document.getElementById('loginSection').style.display        = 'block';
        sscResetGame();
    }

    // â”€â”€ SECTIONS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function sscShowSection(s) {
        document.getElementById('sscPlaySection').style.display = s==='play' ? 'block' : 'none';
        document.getElementById('sscLbSection').style.display   = s==='lb'   ? 'block' : 'none';
        // Show/hide paused banner when switching to play
        if (s === 'play') sscCheckPausedBanner();
        const tabPlay = document.getElementById('sscTabPlay');
        const tabLB   = document.getElementById('sscTabLB');
        if (tabPlay) {
            tabPlay.style.background = s==='play' ? 'rgba(255,255,255,.9)' : 'rgba(255,255,255,.2)';
            tabPlay.style.color      = s==='play' ? '#6a1b9a' : 'white';
            tabPlay.style.border     = s==='play' ? 'none' : '2px solid rgba(255,255,255,.5)';
        }
        if (tabLB) {
            tabLB.style.background = s==='lb' ? 'rgba(255,255,255,.9)' : 'rgba(255,255,255,.2)';
            tabLB.style.color      = s==='lb' ? '#6a1b9a' : 'white';
        }
        if (s==='lb') sscLoadLB();
    }

    // â”€â”€ PAUSED BANNER CHECK â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function sscCheckPausedBanner() {
        try {
            const cfgSnap = await window.db.ref('speedSlide/config').once('value');
            const cfg = cfgSnap.val() || {};
            const paused = cfg.active === false;
            const banner  = document.getElementById('sscPausedBanner');
            const startBtn = document.getElementById('sscStartBtn');
            if (banner)   banner.style.display   = paused ? 'block' : 'none';
            if (startBtn) {
                startBtn.disabled = paused || !sscImageData;
                startBtn.style.opacity = (paused || !sscImageData) ? '.5' : '1';
                startBtn.title = paused ? 'Game is paused by organiser' : '';
            }
        } catch(e) { /* ignore */ }
    }

    // â”€â”€ DIFFICULTY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function sscSelectDiff(d) {
        sscDiff = d; sscSize = SSC_DIFF[d].size;
        ['easy','medium','hard'].forEach(x => {
            const el = document.getElementById('ssdc-'+x);
            if (!el) return;
            el.className = 'ssc-diff-card' + (x===d ? ' ssc-selected' : '');
        });
        const note = document.getElementById('sscDiffNote');
        if (note) note.textContent = SSC_DIFF[d].label + ' Â· ' + SSC_DIFF[d].maxPts + ' max points';
        // Play selection sound
        sscPlaySound('select');
        sscCheckReady();
    }

    // â”€â”€ IMAGE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function sscHandleImage(e) {
        const file = e.target.files[0];
        if (!file) return;
        if (file.size > 5*1024*1024) { alert('Image must be < 5 MB'); return; }
        const reader = new FileReader();
        reader.onload = ev => {
            sscImageData = ev.target.result;
            const thumb = document.getElementById('sscPreviewThumb');
            thumb.src = sscImageData; thumb.style.display = 'block';
            const zone = document.getElementById('sscUploadZone');
            zone.className = 'ssc-upload-zone has-image';
            sscPlaySound('select');
            sscCheckReady();
        };
        reader.readAsDataURL(file);
    }

    function sscCheckReady() {
        const btn = document.getElementById('sscStartBtn');
        if (!btn) return;
        const ready = !!(sscDiff && sscImageData);
        btn.disabled = !ready;
        btn.style.opacity = ready ? '1' : '.5';
        btn.style.cursor  = ready ? 'pointer' : 'not-allowed';
    }

    // â”€â”€ START GAME â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function sscStartGame() {
        // Re-check game active status in case admin paused after login
        try {
            const cfgSnap = await window.db.ref('speedSlide/config').once('value');
            const cfg = cfgSnap.val() || {};
            if (cfg.active === false) {
                alert('â¸ï¸ Speed Slide Challenge has been paused by the organiser. Please try again later.');
                sscGoBack();
                return;
            }
        } catch(e) { /* allow if config unreadable */ }
        document.getElementById('sscSetupCard').style.display = 'none';
        document.getElementById('sscGameArea').style.display  = 'block';
        document.getElementById('sscGameDiffLabel').textContent = ({easy:'ðŸ˜Š Easy',medium:'ðŸ˜„ Medium',hard:'ðŸ”¥ Hard'})[sscDiff] || SSC_DIFF[sscDiff].label;
        document.getElementById('sscPtsDisplay').textContent    = SSC_DIFF[sscDiff].maxPts;
        sscSolDisabled = false; sscSolved = false;
        sscPlaySound('select');
        sscInitPuzzle();
    }

    function sscInitPuzzle() {
        sscMoves = 0; sscSeconds = 0;
        clearInterval(sscTimerRef);
        document.getElementById('sscTimerDisplay').textContent  = '0:00';
        document.getElementById('sscMovesDisplay').textContent  = '0';
        const n = sscSize * sscSize;
        // Goal: [1,2,...,nÂ²-1, 0] â€” blank at bottom-right
        sscTiles = Array.from({length:n}, (_,i) => i===n-1 ? 0 : i+1);
        do { sscShuffleTiles(); } while (!sscIsSolvable());
        sscBuildBoard();
        const prev = document.getElementById('sscInGamePreview');
        prev.src = sscImageData; prev.style.display = 'block';
        sscTimerRef = setInterval(() => {
            sscSeconds++;
            document.getElementById('sscTimerDisplay').textContent = sscFmtTime(sscSeconds);
            if (sscSeconds % 2 === 0) sscUpdateLiveScore(); // refresh score every 2s
        }, 1000);
        sscUpdateLiveScore(); // init immediately
    }

    function sscShuffleTiles() {
        const n = sscTiles.length;
        for (let i=n-1; i>0; i--) {
            const j = Math.floor(Math.random()*(i+1));
            [sscTiles[i], sscTiles[j]] = [sscTiles[j], sscTiles[i]];
        }
    }

    function sscIsSolvable() {
        const n = sscSize, t = sscTiles;
        let inv = 0;
        for (let i=0; i<t.length-1; i++)
            for (let j=i+1; j<t.length; j++)
                if (t[i] && t[j] && t[i]>t[j]) inv++;
        const blankRow = Math.floor(t.indexOf(0)/n);
        if (n%2===1) return inv%2===0;
        const rowFromBottom = n - blankRow;
        return rowFromBottom%2===0 ? inv%2===1 : inv%2===0;
    }

    function sscBuildBoard(movedIdx) {
        const board = document.getElementById('sscPuzzleBoard');
        board.style.gridTemplateColumns = 'repeat('+sscSize+',1fr)';
        board.innerHTML = '';
        const tileSize = Math.min(440, (board.parentElement.clientWidth||440) - 16);
        const sz = Math.floor(tileSize / sscSize);
        sscTiles.forEach((val, idx) => {
            const tile = document.createElement('div');
            tile.className = 'ssc-tile' + (val===0 ? ' ssc-empty' : '') + (idx===movedIdx ? ' ssc-moved' : '');
            tile.style.width = sz+'px'; tile.style.height = sz+'px';
            if (val !== 0) {
                // val is 1-based tile number; map to 0-based grid position
                const zeroVal = val - 1;  // 0-based index in the image grid
                const col = zeroVal % sscSize;
                const row = Math.floor(zeroVal / sscSize);
                // Use pixel-based positioning: backgroundSize = full image scaled to board,
                // backgroundPosition = negative offset of this tile's position
                tile.style.backgroundImage    = 'url('+sscImageData+')';
                tile.style.backgroundSize     = (sz * sscSize) + 'px ' + (sz * sscSize) + 'px';
                tile.style.backgroundPosition = (-col * sz) + 'px ' + (-row * sz) + 'px';
            }
            tile.addEventListener('click', () => sscTryMove(idx));
            board.appendChild(tile);
        });
    }

    function sscTryMove(clickedIdx) {
        if (sscSolved) return;
        const emptyIdx = sscTiles.indexOf(0);
        const eR = Math.floor(emptyIdx/sscSize), eC = emptyIdx%sscSize;
        const cR = Math.floor(clickedIdx/sscSize), cC = clickedIdx%sscSize;
        const valid = (Math.abs(eR-cR)===1 && eC===cC)||(Math.abs(eC-cC)===1 && eR===cR);
        if (!valid) {
            // Shake the board briefly for invalid move
            sscPlaySound('invalid');
            const board = document.getElementById('sscPuzzleBoard');
            board.classList.remove('ssc-board-shake');
            void board.offsetWidth;
            board.classList.add('ssc-board-shake');
            setTimeout(() => board.classList.remove('ssc-board-shake'), 400);
            return;
        }
        [sscTiles[emptyIdx], sscTiles[clickedIdx]] = [sscTiles[clickedIdx], sscTiles[emptyIdx]];
        sscMoves++;
        document.getElementById('sscMovesDisplay').textContent = sscMoves;
        sscPlaySound('move');
        sscBuildBoard(clickedIdx); // pass moved tile index for animation
        sscUpdateLiveScore();
        sscCheckWin();
    }

    function sscCheckWin() {
        // Goal: tiles [1,2,3,...,nÂ²-1, 0] â€” blank at last position (bottom-right)
        const n2 = sscTiles.length;
        for (let i=0; i<n2-1; i++) if (sscTiles[i] !== i+1) return;
        if (sscTiles[n2-1] !== 0) return;
        sscSolved = true;
        clearInterval(sscTimerRef);
        const pts = sscCalcPoints();
        sscPlaySound('win');
        sscLaunchConfetti();
        setTimeout(() => {
            document.getElementById('sscWinTime').textContent  = sscFmtTime(sscSeconds);
            document.getElementById('sscWinMoves').textContent = sscMoves;
            document.getElementById('sscWinDiff').textContent  = ({easy:'ðŸ˜Š Easy',medium:'ðŸ˜„ Medium',hard:'ðŸ”¥ Hard'})[sscDiff];
            document.getElementById('sscWinPts').textContent   = pts;
            document.getElementById('sscWinSaveMsg').textContent = '';
            const m = document.getElementById('sscWinModal');
            m.style.display = 'flex';
        }, 400);
    }

    function sscCalcPoints() {
        const base = SSC_DIFF[sscDiff].maxPts;
        const minMoves = sscSize * sscSize * 2;
        return Math.max(10, base - Math.floor(sscSeconds*0.5) - Math.max(0, sscMoves-minMoves));
    }

    // â”€â”€ SAVE SCORE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function sscSaveScore() {
        if (sscSolDisabled) { alert('Score disabled â€” solution was viewed.'); return; }
        if (!sscCurrentUser) { alert('Not logged in.'); return; }
        const pts = sscCalcPoints();
        document.getElementById('sscWinSaveMsg').textContent = 'â³ Checking daily limitâ€¦';
        try {
            // â”€â”€ Enforce max submissions per day â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            const cfgSnap = await window.db.ref('speedSlide/config').once('value');
            const maxSubs = (cfgSnap.val() || {}).maxSubs || 3;
            const today   = new Date().toISOString().slice(0, 10);
            const allSnap = await window.db.ref('speedSlide/submissions')
                .orderByChild('phone').equalTo(sscCurrentUser.phone).once('value');
            let todayCount = 0;
            allSnap.forEach(c => { if ((c.val().date || '') === today) todayCount++; });
            if (todayCount >= maxSubs) {
                document.getElementById('sscWinSaveMsg').textContent =
                    `âŒ Daily limit reached! You can submit a maximum of ${maxSubs} times per day. Come back tomorrow!`;
                return;
            }
            // â”€â”€ Save score â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            document.getElementById('sscWinSaveMsg').textContent = 'â³ Uploading image & saving scoreâ€¦';
            const imgRef = window.storage.ref('speedSlide/'+sscCurrentUser.key+'_'+Date.now()+'.jpg');
            const snap   = await imgRef.putString(sscImageData, 'data_url');
            const imgUrl = await snap.ref.getDownloadURL();
            const entry = {
                uid: sscCurrentUser.key, name: sscCurrentUser.name,
                phone: sscCurrentUser.phone,
                class: sscCurrentUser.class || sscCurrentUser.classYear || '',
                difficulty: sscDiff, size: sscSize,
                timeSec: sscSeconds, moves: sscMoves, points: pts,
                imageUrl: imgUrl, solvedAt: new Date().toISOString(),
                date: today, status: 'pending'
            };
            await window.db.ref('speedSlide/submissions').push(entry);
            const remaining = maxSubs - todayCount - 1;
            document.getElementById('sscWinSaveMsg').textContent =
                `âœ… Score saved! Pending admin review. (${remaining} submission${remaining !== 1 ? 's' : ''} left today)`;
        } catch(e) {
            document.getElementById('sscWinSaveMsg').textContent = 'âŒ Save failed: ' + e.message;
        }
    }

    // â”€â”€ GIVE UP / SOLUTION ENGINE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    let sscSolSteps     = [];
    let sscSolStepIdx   = 0;
    let sscSolAutoRef   = null;
    let sscSolPlaying   = false;

    function sscShowSolution() {
        if (!confirm('Give up? The solution will be shown step-by-step and the game will end. Continue?')) return;
        clearInterval(sscTimerRef);
        sscSolDisabled = true; sscSolved = true;
        sscPlaySound('gameover');

        document.getElementById('sscSolTime').textContent  = sscFmtTime(sscSeconds);
        document.getElementById('sscSolMoves').textContent = sscMoves;
        document.getElementById('sscSolDiff').textContent  = ({easy:'8-Puzzle',medium:'15-Puzzle',hard:'24-Puzzle'})[sscDiff] || sscDiff;

        const m = document.getElementById('sscGameOverModal');
        m.style.display = 'flex';
        setTimeout(() => sscLaunchBoo(), 150);

        sscSolSteps = []; sscSolStepIdx = 0; sscSolPlaying = false;
        clearInterval(sscSolAutoRef);
        document.getElementById('sscSolPlayBtn').textContent = 'â–¶ Play';
        document.getElementById('sscSolMoveDesc').innerHTML =
            '<span style="color:rgba(255,255,255,.6);font-size:.88em">ðŸ” Computing solutionâ€¦</span>';
        document.getElementById('sscSolStepCounter').textContent = 'â€¦';

        // Run A* solver in chunked async slices â€” no blocking, no loops
        setTimeout(() => sscRunSolverAsync([...sscTiles], sscSize), 100);
    }

    // â”€â”€ CHUNKED A* SOLVER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // A* with Manhattan heuristic + visited set = optimal short path, no loops.
    // Runs in time-sliced chunks so the browser never freezes.
    function sscRunSolverAsync(startTiles, n) {
        // Goal: [1,2,...,nÂ²-1, 0] â€” blank at bottom-right
        const goalArr = Array.from({length:n*n}, (_,i) => i===n*n-1 ? 0 : i+1);
        const goalStr = goalArr.join(',');
        const startStr = startTiles.join(',');

        if (startStr === goalStr) {
            sscSolSteps = [startTiles]; sscSolStepIdx = 0;
            sscRenderSolStep(0); return;
        }

        const dirs = [[-1,0],[1,0],[0,-1],[0,1]];

        function mh(t) {
            let h=0;
            for(let i=0;i<t.length;i++){
                const v=t[i]; if(!v) continue;
                h+=Math.abs(Math.floor(v/n)-Math.floor(i/n))+Math.abs(v%n-i%n);
            }
            return h;
        }

        // Simple min-heap for A*
        class Heap {
            constructor(){ this.d=[]; }
            push(item){ this.d.push(item); this._up(this.d.length-1); }
            pop(){ const t=this.d[0]; const b=this.d.pop(); if(this.d.length){this.d[0]=b;this._down(0);} return t; }
            get size(){ return this.d.length; }
            _up(i){ while(i>0){const p=(i-1)>>1; if(this.d[p][0]<=this.d[i][0])break; [this.d[p],this.d[i]]=[this.d[i],this.d[p]]; i=p;} }
            _down(i){ const n=this.d.length; while(true){ let s=i,l=2*i+1,r=2*i+2; if(l<n&&this.d[l][0]<this.d[s][0])s=l; if(r<n&&this.d[r][0]<this.d[s][0])s=r; if(s===i)break; [this.d[s],this.d[i]]=[this.d[i],this.d[s]]; i=s; } }
        }

        // State: [f, g, tiles, parentKey]
        // We store parent pointers in a map to reconstruct path
        const cameFrom = new Map(); // key -> {tiles, parentKey}
        const gScore   = new Map();
        const heap     = new Heap();

        const sh = mh(startTiles);
        heap.push([sh, 0, startTiles]);
        gScore.set(startStr, 0);
        cameFrom.set(startStr, {tiles: startTiles.slice(), parent: null});

        const CHUNK = 200; // nodes per time slice
        const MAX_NODES = 150000; // safety cap
        let totalNodes = 0;

        function reconstruct(endKey) {
            const path = [];
            let k = endKey;
            while(k !== null) {
                const entry = cameFrom.get(k);
                if(!entry) break;
                path.unshift(entry.tiles);
                k = entry.parent;
            }
            return path;
        }

        function processChunk() {
            let c = 0;
            while(heap.size > 0 && c < CHUNK && totalNodes < MAX_NODES) {
                const [f, g, cur] = heap.pop();
                const curKey = cur.join(',');
                totalNodes++;

                // Skip stale entries
                if(gScore.has(curKey) && gScore.get(curKey) < g) continue;

                if(curKey === goalStr) {
                    sscSolSteps   = reconstruct(curKey);
                    sscSolStepIdx = 0;
                    sscRenderSolStep(0);
                    setTimeout(()=>sscSolStartPlay(), 500);
                    return;
                }

                const ei=cur.indexOf(0), er=Math.floor(ei/n), ec=ei%n;
                for(const [dr,dc] of dirs){
                    const nr=er+dr, nc=ec+dc;
                    if(nr<0||nr>=n||nc<0||nc>=n) continue;
                    const ni=nr*n+nc;
                    const next=cur.slice(); [next[ei],next[ni]]=[next[ni],next[ei]];
                    const nextKey=next.join(',');
                    const ng = g+1;
                    if(!gScore.has(nextKey) || ng < gScore.get(nextKey)){
                        gScore.set(nextKey, ng);
                        cameFrom.set(nextKey, {tiles: next.slice(), parent: curKey});
                        heap.push([ng + mh(next), ng, next]);
                    }
                }
                c++;
            }

            if(heap.size === 0 || totalNodes >= MAX_NODES) {
                sscRenderSolBoard(goalArr, n, -1);
                document.getElementById('sscSolMoveDesc').innerHTML =
                    '<span style="color:#ef9a9a;font-size:.85em">âš ï¸ Too complex to auto-solve â€” showing the goal state.</span>';
                document.getElementById('sscSolStepCounter').textContent = 'N/A';
                return;
            }

            // Yield to browser then continue
            setTimeout(processChunk, 0);
        }

        processChunk();
    }

    // â”€â”€ RENDER SOL BOARD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function sscRenderSolBoard(tiles, n, highlightIdx) {
        const board = document.getElementById('sscSolBoard');
        const maxW = Math.min(260, (window.innerWidth * 0.80) - 40);
        const sz = Math.floor(maxW / n);
        board.style.gridTemplateColumns = 'repeat('+n+',1fr)';
        board.innerHTML = '';
        tiles.forEach((val, idx) => {
            const tile = document.createElement('div');
            const isEmpty = val === 0;
            const isHL = idx === highlightIdx;
            tile.style.width  = sz+'px';
            tile.style.height = sz+'px';
            tile.style.borderRadius = '5px';
            tile.style.transition = 'all .3s ease';
            if (isEmpty) {
                tile.style.background = 'rgba(196,69,105,.2)';
                tile.style.border = '2px dashed rgba(196,69,105,.4)';
            } else {
                tile.style.border = isHL
                    ? '3px solid #ffd54f'
                    : '1.5px solid rgba(255,255,255,.12)';
                if (isHL) tile.style.boxShadow = '0 0 14px rgba(255,213,79,.7)';
                const zv=val-1, col=zv%n, row=Math.floor(zv/n);
                tile.style.backgroundImage = 'url('+sscImageData+')';
                tile.style.backgroundSize = (sz*n)+'px '+(sz*n)+'px';
                tile.style.backgroundPosition = (-col*sz)+'px '+(-row*sz)+'px';
            }
            board.appendChild(tile);
        });
    }

    function sscRenderSolStep(idx) {
        if (!sscSolSteps.length) return;
        const tiles = sscSolSteps[idx];
        const n = sscSize;
        const total = sscSolSteps.length - 1;

        let movedTileIdx = -1;
        if (idx > 0) movedTileIdx = sscSolSteps[idx-1].indexOf(0);

        sscRenderSolBoard(tiles, n, movedTileIdx);

        // Counter
        document.getElementById('sscSolStepCounter').textContent =
            idx === 0 ? 'Start position' : ('Move '+idx+' / '+total);

        // Description
        let desc = '';
        if (idx === 0) {
            desc = `<span style="color:rgba(255,255,255,.75);font-size:.87em">ðŸ“ <strong style="color:#ffd54f">Starting position</strong> â€” ${total} moves needed to solve</span>`;
        } else if (idx >= total) {
            desc = `<span style="color:#a5d6a7;font-size:.87em">âœ… <strong>That's how it's done!</strong> Only ${total} moves needed â€” try again and beat it!</span>`;
        } else {
            const prev = sscSolSteps[idx-1], cur = sscSolSteps[idx];
            const prevEi = prev.indexOf(0), curEi = cur.indexOf(0);
            const dr = Math.floor(curEi/n) - Math.floor(prevEi/n);
            const dc = curEi%n - prevEi%n;
            const dirMap = {'-10':'slide tile â†“ Down','10':'slide tile â†‘ Up','0-1':'slide tile â†’ Right','01':'slide tile â† Left'};
            const dirStr = dirMap[''+dr+dc] || 'slide tile';
            const tileVal = cur[prevEi];
            desc = `<span style="color:rgba(255,255,255,.8);font-size:.87em">Move <strong style="color:#ffd54f">${idx}</strong> of ${total} â€” <strong style="color:#ce93d8">${dirStr}</strong></span>`;
        }
        document.getElementById('sscSolMoveDesc').innerHTML = desc;
    }

    function sscSolPlayPause() {
        if (sscSolPlaying) {
            sscSolPlaying = false;
            clearInterval(sscSolAutoRef);
            document.getElementById('sscSolPlayBtn').textContent = 'â–¶ Play';
        } else {
            if (sscSolStepIdx >= sscSolSteps.length - 1) sscSolStepIdx = 0;
            sscSolStartPlay();
        }
    }

    function sscSolStartPlay() {
        if (!sscSolSteps.length) return;
        sscSolPlaying = true;
        document.getElementById('sscSolPlayBtn').textContent = 'â¸ Pause';
        clearInterval(sscSolAutoRef);
        const delay = sscSize <= 3 ? 650 : (sscSize <= 4 ? 480 : 320);
        sscSolAutoRef = setInterval(() => {
            if (sscSolStepIdx < sscSolSteps.length - 1) {
                sscSolStepIdx++;
                sscRenderSolStep(sscSolStepIdx);
            } else {
                clearInterval(sscSolAutoRef);
                sscSolPlaying = false;
                document.getElementById('sscSolPlayBtn').textContent = 'â†º Replay';
            }
        }, delay);
    }

    function sscSolStepBack() {
        clearInterval(sscSolAutoRef); sscSolPlaying = false;
        document.getElementById('sscSolPlayBtn').textContent = 'â–¶ Play';
        if (sscSolStepIdx > 0) { sscSolStepIdx--; sscRenderSolStep(sscSolStepIdx); }
    }

    function sscSolStepFwd() {
        clearInterval(sscSolAutoRef); sscSolPlaying = false;
        document.getElementById('sscSolPlayBtn').textContent = 'â–¶ Play';
        if (sscSolStepIdx < sscSolSteps.length - 1) { sscSolStepIdx++; sscRenderSolStep(sscSolStepIdx); }
    }

    // â”€â”€ RESET â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function sscResetGame() {
        clearInterval(sscTimerRef);
        clearInterval(sscSolAutoRef);
        sscSolPlaying = false;
        sscSolSteps = [];
        sscSolStepIdx = 0;
        sscSolved = false; sscSolDisabled = false; sscImageData = null;
        document.getElementById('sscWinModal').style.display     = 'none';
        document.getElementById('sscGameOverModal').style.display = 'none';
        document.getElementById('sscGameArea').style.display  = 'none';
        document.getElementById('sscSetupCard').style.display = 'block';
        document.getElementById('sscPreviewThumb').style.display = 'none';
        document.getElementById('sscUploadZone').style.background  = '#faf0ff';
        document.getElementById('sscUploadZone').style.borderColor = '#9c27b0';
        document.getElementById('sscImgInput').value = '';
        sscCheckReady();
    }

    // â”€â”€ LEADERBOARD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function sscLoadLB() {
        document.getElementById('sscLbContainer').innerHTML = '<p style="color:#aaa;text-align:center;padding:30px">Loadingâ€¦</p>';
        try {
            const snap = await window.db.ref('speedSlide/submissions').once('value');
            let data = [];
            snap.forEach(c => { const v=c.val(); if(v.status==='approved') data.push(v); });
            data.sort((a,b) => {
                if (b.points!==a.points) return b.points-a.points;
                if (a.timeSec!==b.timeSec) return a.timeSec-b.timeSec;
                return a.moves-b.moves;
            });
            const diff = sscLbDiff;
            let rows = diff==='all' ? data : data.filter(r=>r.difficulty===diff);
            const seen = new Set();
            rows = rows.filter(r => {
                const k=(r.uid||r.phone)+'|'+r.difficulty;
                if(seen.has(k)) return false; seen.add(k); return true;
            });
            if (!rows.length) {
                document.getElementById('sscLbContainer').innerHTML = '<p style="color:#aaa;text-align:center;padding:30px">No approved scores yet for this category.</p>';
                return;
            }
            const medals = ['ðŸ¥‡','ðŸ¥ˆ','ðŸ¥‰'];
            const dLabel = {easy:'ðŸ˜Š 8-Puzzle',medium:'ðŸ˜… 15-Puzzle',hard:'ðŸ”¥ 24-Puzzle'};
            document.getElementById('sscLbContainer').innerHTML = rows.map((r,i) => `
                <div style="display:grid;grid-template-columns:44px 1fr auto auto;gap:10px;align-items:center;padding:12px 16px;border-radius:10px;background:white;margin-bottom:8px;box-shadow:0 2px 8px rgba(0,0,0,.07)">
                    <div style="font-size:1.4em;text-align:center">${medals[i]||'#'+(i+1)}</div>
                    <div>
                        <div style="font-weight:700">${sscEsc(r.name)}</div>
                        <div style="color:#888;font-size:.82em">${sscEsc(r.class||'')} Â· ${r.date||''} Â· ${dLabel[r.difficulty]||r.difficulty}</div>
                    </div>
                    <div style="color:#e65100;font-weight:700;font-size:.88em">â± ${sscFmtTime(r.timeSec)} Â· ðŸŽ¯ ${r.moves}</div>
                    <div style="color:#6a1b9a;font-weight:800;font-size:1.05em">â­${r.points}</div>
                </div>`).join('');
        } catch(e) {
            document.getElementById('sscLbContainer').innerHTML = '<p style="color:red">Error: '+e.message+'</p>';
        }
    }

    function sscSwitchLB(d) {
        sscLbDiff = d;
        ['easy','medium','hard','all'].forEach(x => {
            const el = document.getElementById('ssclbt-'+x);
            if (el) el.classList.toggle('active', x===d);
        });
        sscLoadLB();
    }

    // â”€â”€ CONFETTI â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function sscLaunchConfetti() {
        const colors = ['#c44569','#6a1b9a','#ffd700','#28a745','#ff9800','#2196F3','#e91e63','#00bcd4'];
        // Big confetti shower
        for (let i=0; i<100; i++) {
            const el = document.createElement('div');
            el.style.cssText = 'position:fixed;z-index:99999;border-radius:2px;pointer-events:none';
            el.style.left    = Math.random()*100+'vw';
            el.style.top     = '-20px';
            el.style.background = colors[Math.floor(Math.random()*colors.length)];
            el.style.width   = (6+Math.random()*10)+'px';
            el.style.height  = (6+Math.random()*10)+'px';
            el.style.animation = `confetti ${2+Math.random()}s ease-out forwards`;
            el.style.animationDelay = Math.random()*1.8+'s';
            document.body.appendChild(el);
            setTimeout(()=>el.remove(), 4500);
        }
        // Floating emoji burst inside the modal
        const burst = document.getElementById('sscWinEmojiBurst');
        if (burst) {
            const emojis = ['ðŸŽ‰','ðŸŽŠ','â­','ðŸ†','âœ¨','ðŸ¥³','ðŸŽˆ','ðŸ’«','ðŸŒŸ','ðŸ‘'];
            for(let i=0;i<18;i++){
                const e=document.createElement('span');
                e.textContent = emojis[Math.floor(Math.random()*emojis.length)];
                e.style.cssText = `position:absolute;font-size:${1.2+Math.random()*1.4}em;
                    left:${5+Math.random()*90}%;bottom:10%;
                    animation:sscEmojiFloat ${1.2+Math.random()*1}s ease-out ${Math.random()*0.8}s both;
                    pointer-events:none;`;
                burst.appendChild(e);
                setTimeout(()=>e.remove(), 3000);
            }
        }
    }

    function sscLaunchBoo() {
        const burst = document.getElementById('sscBooEmojiBurst');
        if (!burst) return;
        const emojis = ['ðŸ‘Ž','ðŸ˜¤','ðŸ’€','ðŸ˜¬','ðŸ™ˆ','ðŸ˜©','ðŸ‘Ž','ðŸ’”','ðŸ˜¤','ðŸ¤¦'];
        for(let i=0;i<14;i++){
            const e=document.createElement('span');
            e.textContent = emojis[Math.floor(Math.random()*emojis.length)];
            e.style.cssText = `position:absolute;font-size:${1+Math.random()*1.2}em;
                left:${5+Math.random()*90}%;top:5%;
                animation:sscBooDrop ${0.9+Math.random()*0.8}s ease-in ${Math.random()*0.6}s both;
                pointer-events:none;`;
            burst.appendChild(e);
            setTimeout(()=>e.remove(), 2500);
        }
    }

    // â”€â”€ HELPERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function sscFmtTime(sec) {
        if (!sec && sec!==0) return 'â€”';
        return Math.floor(sec/60)+':'+(sec%60).toString().padStart(2,'0');
    }
    function sscEsc(s) {
        if (!s) return '';
        return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
    }

    // window.storage is initialized alongside window.db in the main script block above

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // ðŸ” DATABASE INSPECTOR â€” Super Admin Tool
    // Scans entire Firebase Realtime Database for base64 data & large fields
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    let dbiReportData = [];

    async function dbiRunScan() {
        const btn = document.getElementById('dbi-scan-btn');
        btn.disabled = true;
        btn.textContent = 'â³ Scanningâ€¦';
        dbiReportData = [];

        // Reset UI
        document.getElementById('dbi-alert').style.display = 'none';
        document.getElementById('dbi-results').style.display = 'none';
        document.getElementById('dbi-dl-btn').style.display = 'none';
        document.getElementById('dbi-table-body').innerHTML = '';
        document.getElementById('dbi-node-tree').innerHTML = '<p style="color:#888">Loadingâ€¦</p>';
        document.getElementById('dbi-total-nodes').textContent = 'â€¦';
        document.getElementById('dbi-b64-count').textContent = 'â€¦';
        document.getElementById('dbi-total-size').textContent = 'â€¦';
        document.getElementById('dbi-b64-size').textContent = 'â€¦';

        // Show progress
        const pw = document.getElementById('dbi-progress-wrap');
        const pb = document.getElementById('dbi-progress-bar');
        const pl = document.getElementById('dbi-progress-label');
        pw.style.display = 'block';
        pb.style.width = '10%';
        pl.textContent = 'Fetching database rootâ€¦';

        try {
            const db = getDb();
            const snapshot = await db.ref('/').once('value');
            pb.style.width = '50%';
            pl.textContent = 'Analyzing dataâ€¦';

            const root = snapshot.val();
            if (!root) {
                dbiShowAlert('âš ï¸ Database is empty or could not be read.', '#ffc107', '#856404');
                btn.disabled = false;
                btn.textContent = 'ðŸ” Scan Database Now';
                pw.style.display = 'none';
                return;
            }

            const fullJson = JSON.stringify(root);
            const totalSizeBytes = new Blob([fullJson]).size;

            // Walk the tree
            let totalNodes = 0;
            let b64Entries = [];
            let b64TotalBytes = 0;
            let nodeTree = {}; // top-level node â†’ size in bytes

            function walkNode(obj, path) {
                if (obj === null || obj === undefined) return;
                if (typeof obj !== 'object') {
                    totalNodes++;
                    const strVal = String(obj);
                    const sizeBytes = new Blob([strVal]).size;

                    // Detect base64 patterns
                    const b64Regex = /^data:[a-z]+\/[a-z+.-]+;base64,/i;
                    const rawB64Regex = /^[A-Za-z0-9+/]{100,}={0,2}$/;
                    let type = null;
                    if (b64Regex.test(strVal)) {
                        // Extract MIME type
                        const mime = strVal.match(/data:([^;]+);base64,/);
                        type = mime ? mime[1] : 'base64 (with header)';
                    } else if (rawB64Regex.test(strVal) && sizeBytes > 1000) {
                        type = 'raw base64 (no header)';
                    }

                    if (type) {
                        b64TotalBytes += sizeBytes;
                        const pathParts = path.split('/');
                        const fieldKey = pathParts[pathParts.length - 1];
                        const parentPath = pathParts.slice(0, -1).join('/') || '/';
                        b64Entries.push({
                            path: parentPath,
                            key: fieldKey,
                            type: type,
                            sizeBytes: sizeBytes,
                            preview: strVal.substring(0, 60) + 'â€¦'
                        });
                    }
                    return;
                }
                Object.keys(obj).forEach(key => {
                    walkNode(obj[key], path ? path + '/' + key : key);
                });
            }

            // Count top-level node sizes
            Object.keys(root).forEach(topKey => {
                const nodeJson = JSON.stringify(root[topKey]);
                nodeTree[topKey] = new Blob([nodeJson]).size;
            });

            pb.style.width = '75%';
            pl.textContent = 'Walking nodesâ€¦';

            walkNode(root, '');

            // Count total nodes (including objects)
            function countAllNodes(obj) {
                if (obj === null || typeof obj !== 'object') return 1;
                return 1 + Object.keys(obj).reduce((s, k) => s + countAllNodes(obj[k]), 0);
            }
            totalNodes = countAllNodes(root);

            pb.style.width = '100%';
            pl.textContent = 'Done!';

            // Update summary cards
            document.getElementById('dbi-total-nodes').textContent = totalNodes.toLocaleString();
            document.getElementById('dbi-b64-count').textContent = b64Entries.length;
            document.getElementById('dbi-total-size').textContent = dbiFormatSize(totalSizeBytes);
            document.getElementById('dbi-b64-size').textContent = dbiFormatSize(b64TotalBytes);

            // Alert
            if (b64Entries.length === 0) {
                dbiShowAlert('âœ… Great news! No base64 data found in your Firebase database. Your DB is clean.', '#d4edda', '#155724');
            } else {
                dbiShowAlert(`ðŸš¨ Found ${b64Entries.length} base64 field(s) using ${dbiFormatSize(b64TotalBytes)} of storage. Consider moving images to Firebase Storage instead.`, '#f8d7da', '#721c24');
            }

            // Fill results table
            if (b64Entries.length > 0) {
                dbiReportData = b64Entries;
                const tbody = document.getElementById('dbi-table-body');
                tbody.innerHTML = b64Entries.map((e, i) => `
                    <tr style="background:${i%2===0?'#fff':'#fdf5ff'};border-bottom:1px solid #eee">
                        <td style="padding:8px 12px;color:#999;font-size:.8em">${i+1}</td>
                        <td style="padding:8px 12px;font-family:monospace;font-size:.78em;color:#6a1b9a;word-break:break-all">${dbiEsc(e.path)}</td>
                        <td style="padding:8px 12px;font-family:monospace;font-size:.82em;font-weight:700;color:#c44569">${dbiEsc(e.key)}</td>
                        <td style="padding:8px 12px"><span style="background:#fff3cd;color:#856404;padding:2px 8px;border-radius:12px;font-size:.78em;font-weight:600">${dbiEsc(e.type)}</span></td>
                        <td style="padding:8px 12px;font-weight:700;color:${e.sizeBytes>100000?'#dc3545':'#e65100'}">${dbiFormatSize(e.sizeBytes)}</td>
                        <td style="padding:8px 12px;font-family:monospace;font-size:.72em;color:#555;word-break:break-all;max-width:200px">${dbiEsc(e.preview)}</td>
                    </tr>
                `).join('');
                document.getElementById('dbi-results-note').textContent = `Showing all ${b64Entries.length} base64 field(s) found in the database.`;
                document.getElementById('dbi-results').style.display = 'block';
                document.getElementById('dbi-dl-btn').style.display = 'inline-block';
            }

            // Node tree
            const sortedNodes = Object.entries(nodeTree).sort((a, b) => b[1] - a[1]);
            const maxSize = sortedNodes[0]?.[1] || 1;
            document.getElementById('dbi-node-tree').innerHTML = sortedNodes.map(([key, size]) => {
                const pct = Math.max(2, Math.round((size / maxSize) * 100));
                const color = size > 500000 ? '#f5576c' : size > 100000 ? '#f093fb' : size > 10000 ? '#667eea' : '#43e97b';
                return `
                <div style="margin-bottom:10px">
                    <div style="display:flex;justify-content:space-between;margin-bottom:3px">
                        <span style="font-family:monospace;font-weight:700;color:#333">/${dbiEsc(key)}</span>
                        <span style="color:#888;font-size:.82em">${dbiFormatSize(size)}</span>
                    </div>
                    <div style="background:#e0e0e0;border-radius:20px;height:8px;overflow:hidden">
                        <div style="background:${color};height:100%;width:${pct}%;border-radius:20px;transition:width .5s ease"></div>
                    </div>
                </div>`;
            }).join('') || '<p style="color:#888">No top-level nodes found.</p>';

            setTimeout(() => { pw.style.display = 'none'; }, 800);

        } catch(err) {
            dbiShowAlert('âŒ Error scanning database: ' + err.message + '. Check your Firebase rules allow Super Admin reads.', '#f8d7da', '#721c24');
            pw.style.display = 'none';
        }

        btn.disabled = false;
        btn.textContent = 'ðŸ” Scan Database Now';
    }

    function dbiShowAlert(msg, bg, color) {
        const el = document.getElementById('dbi-alert');
        el.style.display = 'block';
        el.style.background = bg;
        el.style.color = color;
        el.style.border = '1.5px solid ' + color;
        el.textContent = msg;
    }

    function dbiClearResults() {
        document.getElementById('dbi-alert').style.display = 'none';
        document.getElementById('dbi-results').style.display = 'none';
        document.getElementById('dbi-dl-btn').style.display = 'none';
        document.getElementById('dbi-table-body').innerHTML = '';
        document.getElementById('dbi-node-tree').innerHTML = 'Run a scan to see node sizes.';
        document.getElementById('dbi-total-nodes').textContent = 'â€”';
        document.getElementById('dbi-b64-count').textContent = 'â€”';
        document.getElementById('dbi-total-size').textContent = 'â€”';
        document.getElementById('dbi-b64-size').textContent = 'â€”';
        dbiReportData = [];
    }

    function dbiDownloadReport() {
        if (!dbiReportData.length) return;
        const rows = [['#','Path','Field Key','Type','Size (bytes)','Preview']];
        dbiReportData.forEach((e,i) => {
            rows.push([i+1, e.path, e.key, e.type, e.sizeBytes, e.preview.replace(/,/g,'')]);
        });
        const csv = rows.map(r => r.map(c => '"'+String(c).replace(/"/g,'""')+'"').join(',')).join('\n');
        const blob = new Blob([csv], {type:'text/csv'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'spurthi_db_inspector_' + new Date().toISOString().slice(0,10) + '.csv';
        a.click();
        URL.revokeObjectURL(url);
    }

    function dbiFormatSize(bytes) {
        if (bytes < 1024) return bytes + ' B';
        if (bytes < 1048576) return (bytes/1024).toFixed(1) + ' KB';
        return (bytes/1048576).toFixed(2) + ' MB';
    }

    function dbiEsc(s) {
        if (!s) return '';
        return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
    }
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // END DB INSPECTOR
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // â˜ï¸ CLOUDINARY INSPECTOR â€” Dual Mode (Manual Logger + Live Proxy)
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    const CLD_HISTORY_KEY  = 'spurthi_cld_history';
    const CLD_WORKER_KEY   = 'spurthi_cld_worker_url';

    // â”€â”€ Mode switcher â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function cldSwitchMode(mode) {
        const isManual = (mode === 'manual');
        document.getElementById('cld-panel-manual').style.display = isManual ? 'block' : 'none';
        document.getElementById('cld-panel-live').style.display   = isManual ? 'none'  : 'block';
        document.getElementById('cld-mode-manual-btn').style.background = isManual
            ? 'linear-gradient(135deg,#6a1b9a,#c44569)' : '#f3e8ff';
        document.getElementById('cld-mode-manual-btn').style.color = isManual ? 'white' : '#6a1b9a';
        document.getElementById('cld-mode-live-btn').style.background = isManual
            ? '#f3e8ff' : 'linear-gradient(135deg,#f7971e,#ffd200)';
        document.getElementById('cld-mode-live-btn').style.color = isManual ? '#6a1b9a' : '#333';
    }

    // â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function cldFmtMB(mb) {
        if (!mb && mb !== 0) return 'â€”';
        if (mb >= 1024) return (mb / 1024).toFixed(2) + ' GB';
        return mb.toFixed(1) + ' MB';
    }
    function cldFmtBytes(bytes) {
        if (!bytes || bytes === 0) return '0 B';
        const gb = bytes / 1073741824;
        if (gb >= 1) return gb.toFixed(2) + ' GB';
        const mb = bytes / 1048576;
        if (mb >= 1) return mb.toFixed(1) + ' MB';
        return (bytes / 1024).toFixed(0) + ' KB';
    }
    function cldBarColor(pct) {
        return pct > 90 ? 'linear-gradient(90deg,#f5576c,#c44569)'
             : pct > 70 ? 'linear-gradient(90deg,#f7971e,#ffd200)'
             :             'linear-gradient(90deg,#43e97b,#38f9d7)';
    }
    function cldAlert(id, msg, bg, color) {
        const el = document.getElementById(id);
        el.style.display = 'block'; el.style.background = bg;
        el.style.color = color; el.style.border = '1.5px solid ' + color;
        el.textContent = msg;
    }

    // â•â• OPTION A â€” MANUAL LOGGER â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    function cldmLoadHistory() {
        try { return JSON.parse(localStorage.getItem(CLD_HISTORY_KEY) || '[]'); }
        catch(e) { return []; }
    }
    function cldmSaveHistory(h) { localStorage.setItem(CLD_HISTORY_KEY, JSON.stringify(h)); }

    function cldmSave() {
        const sUsed  = parseFloat(document.getElementById('cldm-storage-used').value);
        const sLimit = parseFloat(document.getElementById('cldm-storage-limit').value);
        const bUsed  = parseFloat(document.getElementById('cldm-bw-used').value);
        const bLimit = parseFloat(document.getElementById('cldm-bw-limit').value);
        const assets = parseInt(document.getElementById('cldm-assets').value) || 0;
        const date   = document.getElementById('cldm-date').value || new Date().toISOString().slice(0,10);

        if (isNaN(sUsed) || isNaN(sLimit) || isNaN(bUsed) || isNaN(bLimit)) {
            cldAlert('cldm-alert', 'âš ï¸ Please fill in all storage and bandwidth fields.', '#fff3cd', '#856404');
            return;
        }

        const entry = { date, sUsed, sLimit, bUsed, bLimit, assets };
        const history = cldmLoadHistory();
        const idx = history.findIndex(e => e.date === date);
        if (idx >= 0) history[idx] = entry; else history.push(entry);
        cldmSaveHistory(history);
        cldmRender(entry);

        // Clear inputs
        ['cldm-storage-used','cldm-storage-limit','cldm-bw-used','cldm-bw-limit','cldm-assets'].forEach(id => {
            document.getElementById(id).value = '';
        });
        document.getElementById('cldm-date').value = new Date().toISOString().slice(0,10);
    }

    function cldmRender(entry) {
        if (!entry) return;
        const sPct = entry.sLimit > 0 ? Math.min(100, Math.round((entry.sUsed / entry.sLimit) * 100)) : 0;
        const bPct = entry.bLimit > 0 ? Math.min(100, Math.round((entry.bUsed / entry.bLimit) * 100)) : 0;

        document.getElementById('cldm-card-storage-used').textContent  = cldFmtMB(entry.sUsed);
        document.getElementById('cldm-card-storage-limit').textContent = cldFmtMB(entry.sLimit);
        document.getElementById('cldm-card-bw-used').textContent       = cldFmtMB(entry.bUsed);
        document.getElementById('cldm-card-bw-limit').textContent      = cldFmtMB(entry.bLimit);
        document.getElementById('cldm-card-assets').textContent        = entry.assets.toLocaleString();
        document.getElementById('cldm-card-date').textContent          = entry.date;

        const sBar = document.getElementById('cldm-storage-bar');
        sBar.style.width = sPct + '%'; sBar.style.background = cldBarColor(sPct);
        document.getElementById('cldm-storage-pct-lbl').textContent = `${sPct}% of ${cldFmtMB(entry.sLimit)} used`;

        const bBar = document.getElementById('cldm-bw-bar');
        bBar.style.width = bPct + '%'; bBar.style.background = cldBarColor(bPct);
        document.getElementById('cldm-bw-pct-lbl').textContent = `${bPct}% of ${cldFmtMB(entry.bLimit)} used`;

        document.getElementById('cldm-cards').style.display = 'block';

        if (sPct > 90 || bPct > 90) {
            cldAlert('cldm-alert', `ðŸš¨ Warning: ${sPct > 90 ? 'Storage' : 'Bandwidth'} is over 90% of limit!`, '#f8d7da', '#721c24');
        } else {
            cldAlert('cldm-alert', `âœ… Data saved! Storage: ${sPct}% used | Bandwidth: ${bPct}% used`, '#d4edda', '#155724');
        }

        cldmRenderHistory();
    }

    function cldmRenderHistory() {
        const history = cldmLoadHistory().sort((a,b) => b.date.localeCompare(a.date)).slice(0, 7);
        const tbody = document.getElementById('cldm-history-body');
        if (!history.length) {
            tbody.innerHTML = '<tr><td colspan="5" style="padding:14px;text-align:center;color:#aaa">No entries yet.</td></tr>';
            return;
        }
        tbody.innerHTML = history.map((e, i) => {
            const sPct = e.sLimit > 0 ? Math.min(100,(e.sUsed/e.sLimit*100)).toFixed(1) : 'â€”';
            const bPct = e.bLimit > 0 ? Math.min(100,(e.bUsed/e.bLimit*100)).toFixed(1) : 'â€”';
            return `<tr style="background:${i%2===0?'#fff':'#fdf5ff'};border-bottom:1px solid #eee">
                <td style="padding:8px 12px;font-weight:600;color:#333">${e.date}</td>
                <td style="padding:8px 12px;color:#f7971e;font-weight:700">${cldFmtMB(e.sUsed)} <span style="color:#aaa;font-size:.8em">/ ${cldFmtMB(e.sLimit)} (${sPct}%)</span></td>
                <td style="padding:8px 12px;color:#4facfe;font-weight:700">${cldFmtMB(e.bUsed)} <span style="color:#aaa;font-size:.8em">/ ${cldFmtMB(e.bLimit)} (${bPct}%)</span></td>
                <td style="padding:8px 12px;color:#667eea;font-weight:700">${e.assets.toLocaleString()}</td>
                <td style="padding:8px 12px"><button onclick="cldmDelete('${e.date}')" style="background:#f8d7da;color:#721c24;border:none;border-radius:6px;padding:3px 10px;cursor:pointer;font-size:.78em">ðŸ—‘ï¸</button></td>
            </tr>`;
        }).join('');
    }

    function cldmDelete(date) {
        if (!confirm('Delete entry for ' + date + '?')) return;
        cldmSaveHistory(cldmLoadHistory().filter(e => e.date !== date));
        cldmRenderHistory();
    }

    function cldmClearAll() {
        if (!confirm('Clear all Cloudinary history?')) return;
        cldmSaveHistory([]);
        document.getElementById('cldm-cards').style.display = 'none';
        document.getElementById('cldm-alert').style.display = 'none';
        cldmRenderHistory();
    }

    // â•â• OPTION B â€” LIVE CLOUDFLARE WORKER PROXY â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    function cldLiveClear() {
        document.getElementById('cld-live-results').style.display = 'none';
        document.getElementById('cld-live-alert').style.display = 'none';
        ['cld-storage','cld-storage-limit','cld-bandwidth','cld-bandwidth-limit','cld-resources','cld-plan'].forEach(id => {
            const el = document.getElementById(id); if (el) el.textContent = 'â€”';
        });
    }

    async function cldLiveFetch() {
        const workerUrl = document.getElementById('cld-worker-url').value.trim();
        if (!workerUrl) {
            cldAlert('cld-live-alert', 'âš ï¸ Please enter your Cloudflare Worker URL.', '#fff3cd', '#856404');
            return;
        }
        // Save worker URL for convenience
        localStorage.setItem(CLD_WORKER_KEY, workerUrl);

        const btn = document.getElementById('cld-live-btn');
        btn.disabled = true; btn.textContent = 'â³ Fetchingâ€¦';
        document.getElementById('cld-live-alert').style.display = 'none';

        const pw = document.getElementById('cld-live-progress-wrap');
        const pb = document.getElementById('cld-live-progress-bar');
        const pl = document.getElementById('cld-live-progress-label');
        pw.style.display = 'block'; pb.style.width = '20%'; pl.textContent = 'Connectingâ€¦';

        try {
            pb.style.width = '50%'; pl.textContent = 'Fetching from Cloudinary via Workerâ€¦';
            const resp = await fetch(workerUrl);
            pb.style.width = '85%'; pl.textContent = 'Processingâ€¦';

            if (!resp.ok) throw new Error(`Worker returned HTTP ${resp.status}. Check your Worker URL and deployment.`);
            const data = await resp.json();

            pb.style.width = '100%'; pl.textContent = 'Done!';
            setTimeout(() => { pw.style.display = 'none'; }, 700);

            const storageUsed  = data.storage?.usage  || 0;
            const storageLimit = data.storage?.limit  || 0;
            const bwUsed       = data.bandwidth?.usage || 0;
            const bwLimit      = data.bandwidth?.limit || 0;
            const resources    = data.resources        || 0;
            const plan         = data.plan             || 'Unknown';

            document.getElementById('cld-storage').textContent         = cldFmtBytes(storageUsed);
            document.getElementById('cld-storage-limit').textContent   = cldFmtBytes(storageLimit);
            document.getElementById('cld-bandwidth').textContent       = cldFmtBytes(bwUsed);
            document.getElementById('cld-bandwidth-limit').textContent = cldFmtBytes(bwLimit);
            document.getElementById('cld-resources').textContent       = resources.toLocaleString();
            document.getElementById('cld-plan').textContent            = plan.charAt(0).toUpperCase() + plan.slice(1);

            const sPct = storageLimit > 0 ? Math.min(100, Math.round(storageUsed / storageLimit * 100)) : 0;
            const bPct = bwLimit > 0      ? Math.min(100, Math.round(bwUsed / bwLimit * 100)) : 0;

            const sBar = document.getElementById('cld-storage-bar');
            sBar.style.width = sPct + '%'; sBar.style.background = cldBarColor(sPct);
            document.getElementById('cld-storage-pct-label').textContent = `${sPct}% used`;

            const bBar = document.getElementById('cld-bandwidth-bar');
            bBar.style.width = bPct + '%'; bBar.style.background = cldBarColor(bPct);
            document.getElementById('cld-bandwidth-pct-label').textContent = `${bPct}% used`;

            // Asset breakdown
            const cats = [
                { label: 'ðŸ–¼ï¸ Images',    count: data.derived_resources || 0, color: '#667eea' },
                { label: 'ðŸŽ¬ Videos',    count: data.video?.usage || 0,      color: '#f093fb' },
                { label: 'ðŸ“¦ Raw Files', count: data.raw?.usage   || 0,      color: '#43e97b' },
                { label: 'ðŸ”„ Derived',   count: data.derived?.usage || 0,    color: '#4facfe' },
            ];
            document.getElementById('cld-asset-breakdown').innerHTML = cats.map(c =>
                `<div style="background:white;border-radius:8px;padding:10px 14px;text-align:center;border:1px solid #e0d0f0">
                    <div style="font-size:1.3em;font-weight:700;color:${c.color}">${c.count.toLocaleString()}</div>
                    <div style="font-size:.75em;color:#888">${c.label}</div>
                </div>`).join('');

            document.getElementById('cld-live-results').style.display = 'block';

            if (sPct > 90 || bPct > 90) {
                cldAlert('cld-live-alert', `ðŸš¨ Warning: ${sPct > 90 ? 'Storage' : 'Bandwidth'} is over 90% of limit!`, '#f8d7da', '#721c24');
            } else {
                cldAlert('cld-live-alert', `âœ… Live stats loaded! Storage: ${sPct}% | Bandwidth: ${bPct}%`, '#d4edda', '#155724');
            }

        } catch(err) {
            pw.style.display = 'none';
            let msg = err.message;
            if (msg.toLowerCase().includes('failed to fetch') || msg.toLowerCase().includes('network') || msg.toLowerCase().includes('cors')) {
                msg = 'âŒ Could not reach your Worker URL. Make sure: (1) you deployed the Worker, (2) the URL is correct, (3) your Worker code has Access-Control-Allow-Origin: *.';
            } else {
                msg = 'âŒ ' + msg;
            }
            cldAlert('cld-live-alert', msg, '#f8d7da', '#721c24');
        }

        btn.disabled = false; btn.textContent = 'âš¡ Fetch Live Stats';
    }

    // â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    (function cldInit() {
        // Restore saved worker URL
        const savedUrl = localStorage.getItem(CLD_WORKER_KEY);
        const urlEl = document.getElementById('cld-worker-url');
        if (savedUrl && urlEl) urlEl.value = savedUrl;

        // Set today's date in manual form
        const dateEl = document.getElementById('cldm-date');
        if (dateEl) dateEl.value = new Date().toISOString().slice(0,10);

        // Load latest manual entry if exists
        const history = cldmLoadHistory().sort((a,b) => b.date.localeCompare(a.date));
        if (history.length > 0) cldmRender(history[0]);
        cldmRenderHistory();
    })();

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // ðŸ”¥ FIREBASE DOWNLOAD MONITOR
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    const FDM_LIMIT_GB = 10;
    const FDM_STORAGE_KEY = 'spurthi_fdm_history';

    function fdmLoadHistory() {
        try {
            return JSON.parse(localStorage.getItem(FDM_STORAGE_KEY) || '[]');
        } catch(e) { return []; }
    }

    function fdmSaveHistory(history) {
        localStorage.setItem(FDM_STORAGE_KEY, JSON.stringify(history));
    }

    function fdmGetToday() {
        return new Date().toISOString().slice(0, 10);
    }

    function fdmStatusInfo(gb) {
        const pct = (gb / FDM_LIMIT_GB) * 100;
        if (pct >= 100) return { label: 'BLOCKED', color: '#dc3545', icon: 'ðŸš«', barColor: 'linear-gradient(90deg,#dc3545,#c0392b)' };
        if (pct >= 90)  return { label: 'CRITICAL', color: '#dc3545', icon: 'ðŸ”´', barColor: 'linear-gradient(90deg,#f5576c,#c44569)' };
        if (pct >= 75)  return { label: 'WARNING', color: '#e65100', icon: 'âš ï¸', barColor: 'linear-gradient(90deg,#f7971e,#ffd200)' };
        return { label: 'SAFE', color: '#28a745', icon: 'âœ…', barColor: 'linear-gradient(90deg,#43e97b,#38f9d7)' };
    }

    function fdmRenderGauge(todayGb) {
        const pct = Math.min(100, (todayGb / FDM_LIMIT_GB) * 100);
        const status = fdmStatusInfo(todayGb);
        const remaining = Math.max(0, FDM_LIMIT_GB - todayGb);

        document.getElementById('fdm-gauge-bar').style.width = pct + '%';
        document.getElementById('fdm-gauge-bar').style.background = status.barColor;
        document.getElementById('fdm-gauge-label').textContent = `${todayGb.toFixed(2)} / ${FDM_LIMIT_GB} GB`;
        document.getElementById('fdm-gauge-label').style.color = status.color;

        const badge = document.getElementById('fdm-status-badge');
        badge.style.background = status.color;
        badge.querySelector('span:first-child').textContent = status.icon;
        document.getElementById('fdm-status-text').textContent = status.label;

        document.getElementById('fdm-remaining-label').textContent =
            todayGb === 0
                ? 'No data logged yet. Use the form above to log usage.'
                : `${remaining.toFixed(2)} GB remaining today (${(100 - pct).toFixed(1)}% left) â€” Resets at midnight Pacific Time`;
        document.getElementById('fdm-remaining-label').style.color = status.color;
    }

    function fdmRenderHistory() {
        const history = fdmLoadHistory();
        const tbody = document.getElementById('fdm-history-body');

        if (history.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" style="padding:16px;text-align:center;color:#aaa">No history yet.</td></tr>';
            return;
        }

        // Sort newest first, show last 7
        const sorted = [...history].sort((a, b) => b.date.localeCompare(a.date)).slice(0, 7);
        const todayStr = fdmGetToday();

        tbody.innerHTML = sorted.map((entry, i) => {
            const pct = Math.min(100, (entry.gb / FDM_LIMIT_GB) * 100).toFixed(1);
            const status = fdmStatusInfo(entry.gb);
            const isToday = entry.date === todayStr;
            return `<tr style="background:${i % 2 === 0 ? '#fff' : '#fdf5ff'};border-bottom:1px solid #eee">
                <td style="padding:8px 12px;font-weight:${isToday ? '700' : '400'};color:${isToday ? '#c44569' : '#333'}">${entry.date}${isToday ? ' ðŸ“' : ''}</td>
                <td style="padding:8px 12px;font-weight:700;color:${status.color}">${entry.gb.toFixed(2)} GB</td>
                <td style="padding:8px 12px">
                    <div style="display:flex;align-items:center;gap:8px">
                        <div style="flex:1;background:#e0e0e0;border-radius:10px;height:7px;min-width:80px;overflow:hidden">
                            <div style="background:${status.barColor};height:100%;width:${pct}%;border-radius:10px"></div>
                        </div>
                        <span style="font-size:.8em;color:${status.color};font-weight:600">${pct}%</span>
                    </div>
                </td>
                <td style="padding:8px 12px"><span style="background:${status.color};color:white;padding:2px 10px;border-radius:12px;font-size:.76em;font-weight:600">${status.icon} ${status.label}</span></td>
                <td style="padding:8px 12px">
                    <button onclick="fdmDeleteEntry('${entry.date}')" style="background:#f8d7da;color:#721c24;border:none;border-radius:6px;padding:3px 10px;cursor:pointer;font-size:.78em">ðŸ—‘ï¸ Delete</button>
                </td>
            </tr>`;
        }).join('');

        // Update today's gauge
        const todayEntry = history.find(e => e.date === todayStr);
        fdmRenderGauge(todayEntry ? todayEntry.gb : 0);
    }

    function fdmLogUsage() {
        const gbInput = parseFloat(document.getElementById('fdm-today-gb').value);
        const dateInput = document.getElementById('fdm-date').value || fdmGetToday();

        if (isNaN(gbInput) || gbInput < 0) {
            alert('Please enter a valid download amount (GB).');
            return;
        }
        if (gbInput > 100) {
            alert('Value seems too high. Please enter GB, not MB or bytes.');
            return;
        }

        const history = fdmLoadHistory();
        const existingIdx = history.findIndex(e => e.date === dateInput);
        if (existingIdx >= 0) {
            history[existingIdx].gb = gbInput;
        } else {
            history.push({ date: dateInput, gb: gbInput });
        }

        fdmSaveHistory(history);
        fdmRenderHistory();

        document.getElementById('fdm-today-gb').value = '';
        document.getElementById('fdm-date').value = '';
    }

    function fdmDeleteEntry(date) {
        if (!confirm('Delete entry for ' + date + '?')) return;
        const history = fdmLoadHistory().filter(e => e.date !== date);
        fdmSaveHistory(history);
        fdmRenderHistory();
    }

    function fdmClearHistory() {
        if (!confirm('Clear all download history? This cannot be undone.')) return;
        fdmSaveHistory([]);
        fdmRenderHistory();
    }

    // Init: set today's date in the input, render history
    (function fdmInit() {
        const dateEl = document.getElementById('fdm-date');
        if (dateEl) dateEl.value = fdmGetToday();
        fdmRenderHistory();
    })();

    // â”€â”€ Auto-init when db is ready â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    (function hwpInit() {
        function tryInit() {
            try {
                getDb(); // will throw if not ready
                hwpLoad();
            } catch(e) { setTimeout(tryInit, 600); }
        }
        tryInit();
    })();

    </script>

    <!-- ============================================ -->
    <!-- RULES AND REGULATIONS SECTION                -->
    <!-- TO EDIT: Just change the text below          -->
    <!-- TO ADD PDF: Replace "rules.pdf" with your    -->
    <!-- PDF file name and upload it to same folder   -->
    <!-- ============================================ -->
    <div class="content" style="margin-bottom:30px;margin-top:40px;padding:40px 30px;">
        <div style="text-align:center;margin-bottom:30px;">
            <h2 style="color:#c44569;margin-bottom:20px;">ðŸ“‹ General Rules and Regulations</h2>
            
            <!-- ============================================ -->
            <!-- TO ADD/REMOVE PDF LINK:                      -->
            <!-- Delete the entire line below to remove link  -->
            <!-- Or change "rules.pdf" to your PDF filename   -->
            <!-- ============================================ -->
            <a href="rules.pdf" target="_blank" style="display:inline-block;background:linear-gradient(135deg, #c44569 0%, #6a1b9a 100%);color:white;padding:12px 30px;border-radius:8px;text-decoration:none;font-weight:600;margin-bottom:20px;">
                ðŸ“„ Download Complete Rules & Regulations PDF (Coming Soon)
            </a>
        </div>

        <!-- ============================================ -->
        <!-- TO EDIT COORDINATOR NAMES:                   -->
        <!-- Change the names below                       -->
        <!-- ============================================ -->
        <div style="background:#fff3cd;padding:20px;border-radius:8px;border-left:5px solid #ffc107;margin-bottom:20px;">
            <p style="margin:0;color:#856404;font-weight:600;">Event Coordinators: Lalitha S K & Priyanka V</p>
        </div>

        <!-- ============================================ -->
        <!-- TO EDIT RULES: Change the text below         -->
        <!-- Keep the HTML tags as they are               -->
        <!-- ============================================ -->
        <div style="background:white;padding:25px;border-radius:8px;border:2px solid #e0e0e0;">
            <ol style="line-height:1.8;color:#333;">
                <!-- Rule 1 -->
                <li style="margin-bottom:15px;">
                    <strong>Last date for registration</strong> with one time Refundable amount 
                    <span style="color:#c44569;font-weight:bold;">â‚¹1,500/-</span> 
                    on or before 
                    <span style="color:#c44569;font-weight:bold;">23rd February, Monday within 3:30 PM</span>.
                </li>
                
                <!-- Rule 2 -->
                <li style="margin-bottom:15px;">
                    <strong>Last date for submission of Music and Work Organising batch</strong> 
                    on or before 
                    <span style="color:#c44569;font-weight:bold;">7th March, Saturday</span>.
                </li>
                
                <!-- Rule 3 -->
                <li style="margin-bottom:15px;">
                    Students arriving late (Event and for the Class registration on the date of event) 
                    or absent for the event will be fined 
                    <span style="color:#c44569;font-weight:bold;">â‚¹500/- per day</span>.
                </li>
                
                <!-- Rule 4 -->
                <li style="margin-bottom:15px;">
                    Teams not submitting Music, or any other assignments with respect to the event, 
                    on date and time, will lead into 
                    <span style="color:#c44569;font-weight:bold;">non-refund of deposit â‚¹1,500/-</span>.
                </li>
            </ol>
        </div>
    </div>
    <!-- ============================================ -->
    <!-- END OF RULES SECTION                         -->
    <!-- ============================================ -->
    
    <!-- Footer -->
    <footer style="background: white; border-radius: 12px; padding: 25px; margin-top: 30px; box-shadow: 0 4px 20px rgba(0,0,0,0.1);">
        <div style="text-align: center;">
            
            <!-- ================================================== -->
            <!-- CIRCULAR LOGO (Top)                                -->
            <!-- Replace "davan_logo_2026.gif" with your image file -->
            <!-- ================================================== -->
            <div style="margin-bottom: 0px;">
                <img src="davan_logo_2026.gif" alt="Spurthi Davan Logo" style="height: 200px; width: auto; display: inline-block;">
            </div>
            
            <p style="color: #6a1b9a; font-size: 0.9em; margin-bottom: 8px;">
                Â© 2026 Davan Institute of Advanced Management Studies
            </p>
            
            <!-- ============================================ -->
            <!-- SUPER ADMIN: UPDATE VERSION AND DATE HERE    -->
            <!-- ============================================ -->
            <p style="color: #666; font-size: 0.85em; margin-bottom: 8px;">
                <strong>Version:</strong> 3.7 Speed Slide Challenge updated   | <strong>Last Updated:</strong> February 21, 2026 01.19pm
            </p>
            <!-- ============================================ -->
            
            <p style="color: #c44569; font-size: 0.85em; font-weight: 600; margin-bottom: 8px;">
                Built by Harsha Gujjar, Director - Davan College
            </p>
            
            <!-- ================================================== -->
            <!-- TEXT LOGO (Below "Built by" line)                  -->
            <!-- Replace 